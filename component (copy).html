<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="css/right-click-menu.css" media="all">
  <link rel="stylesheet" href="css/buttons-and-menus.css" media="all">
  <link rel="stylesheet" href="css/panels.css" media="all">
  <link rel="icon" type="image/png" href="favicon.png">


</head>

<body class="body">
  <aside class="aside">
    <div class="panel top">
      <button disabled class="b-1" id="last-action-time"
        style="color: black;z-index:1; position: absolute;top: 50%;left: 50%; transform: translate(-50%, -50%);">‚è≥</button>
    </div>

    <div class="panel left" style="overflow-y: auto; height: 100vh;">
      <div id="nav-buttons" hidden>
        <a href="https://webdev983.github.io/templatesv3/"><button class="b-1">üìÇ</button></a>
      </div>
      <div style="margin-top: 3px;">
        <button class="b-1 b-select" id="log-open">ü™µ</button>
        <button class="b-1 " id="execute-commands" onclick="toggleExecution(event)">üå¥</button>
        <button class="b-1 " id="toggle-component-tree" onclick="toggleComponentTree()">üß©</button>
        <button class="b-1 " id="toggle-code-tree" onclick="toggleCodeTree()">üè∑Ô∏è</button>
        <button class="b-1 " id="toggle-head" onclick="toggleHead()">üóø</button>
        <button class="b-1 " id="toggle-generated-page" onclick="toggleGeneratedPage()">üëÅÔ∏è</button>
        <button hidden id="refresh-page" class="b-1" onclick="reloadPage(event)">üîÑ</button>
        <button hidden id="remove-duplicate-actions" onclick="removeActions(event)" class="b-1">üßπ</button>


        <input hidden id="search-actions" type="text" placeholder="üîé Search actions" style="  padding: 5px; 
        border: 2px solid #4A90E2;   
        border-radius: 5px;   
        font-size: 18px; margin-bottom: 7px; margin-top: 10px;  margin-left: 5px; min-width: 315px; "
          oninput="searchLogs(event)">

      </div>
      <div id="logs-menu">
      </div>
      <table id="code-log" class="table-1"
        style="margin-left: auto; margin-right: auto; margin-bottom: 450px; width: 98%;" hidden>
        <style>
          .action-data-tooltip {
            display: none;
            position: absolute;
            background-color: #333;
            /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            color: #fff;
            /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            /* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ tooltip –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞–¥ –¥—Ä—É–≥–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
            max-height: 400px;
            /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
            overflow-y: auto;
            /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ */
            width: 555px;
            /* –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —à–∏—Ä–∏–Ω—É */
            top: calc(100% + 0px);
            /* –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –ø–æ–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–º –Ω–∞ 3px –Ω–∏–∂–µ */
            left: 0px;
            /* –°–º–µ—Å—Ç–∏—Ç—å –≤–ø—Ä–∞–≤–æ –Ω–∞ 50px –æ—Ç –Ω–∞—á–∞–ª–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
          }


          #code-log-element:hover .action-data-tooltip {
            display: block;
          }




          td {
            position: relative;
            /* –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è tooltip */
          }

          .action-error {
            background-color: #ff7a7a;
          }

          .action-frozen {
            background-color: #5f96fc;
          }
        </style>
        <tbody id="code-log-body">
          <!--NUMBERS!! 1Ô∏è‚É£ 2Ô∏è‚É£ 3Ô∏è‚É£ 4Ô∏è‚É£-->
          <tr hidden id="code-log-element">
            <td style="position: relative; padding: 4px;" data-type-code-log="action-time">
              <span data-move-actions hidden>
                <button class="b-5" data-move-after>‚¨áÔ∏è</button>
                <button class="b-5" data-move-before style="margin-left: -7px; margin-right: -10px;">‚¨ÜÔ∏è</button>
              </span>
              <span class="l-4" id="code-log-action-time" style="margin-left: 10px;">1703707728031</span>
              <div class="action-data-tooltip">
                <div style="margin-right: 15px;" data-action-error hidden>
                  <span class="l-4">‚ö†Ô∏è</span>
                  <span class="l-4" data-error-message>missing target</span>
                </div>
                <div data-action-buttons="" style="position: relative;">
                  <button class="b-3" id="move-button">‚ÜïÔ∏è</button>
                  <button id="change-target" class="b-3">üéØ</button>
                  <button id="freeze" class="b-3">ü•∂</button>
                  <button style="position: absolute; right: 3px;" onclick="deleteAction(event)"
                    class="b-3">&#128465;</button>

                  <div data-action-button-menu data-menu>

                  </div>
                </div>
                <hr style="border-bottom: 1px solid #ffcc81;">
                <div data-action-data>


                </div>


              </div>
            </td>
            <td data-type-code-log="action-name"><span class="l-4" id="code-log-action">append child</span>
            </td>
            <td hidden><button data-type-code-log="action-remove" onclick="deleteAction(event)"
                class="b-5">&#128465;</button>

          </tr>
        </tbody>



        <!-- action buttons menus-->
        <div hidden action-buttons-menus-storage>
          <button hidden id="change-self-use" class="b-3" class="b-3">ü™û</button>
          <button hidden id="change-component" class="b-3" class="b-3">üß©</button>
          <div hidden id="change-adding-component" style="margin-top: 5px;">
            <label>
              <span class="l-4">üîó</span><span class="l-4"> attach by: </span>
              <select class="select-1" style="display: inline-block; margin-bottom: 2px;" id="change_link_type">
                <option id="byId">üÜî id</option>
                <option id="absolute">‚ú≥Ô∏è absolute</option>
                <option id="relative">#Ô∏è‚É£ relative</option>
                <option id="content">üí≤content folder</option>
              </select>
              <input id="new-component-input" type="text" class="input-actions" style="margin-top:5px;">
              <button id="save-new-component" class="b-4" style="margin-left: -1px;">üíæ Save</button>
              <button onclick="cancel2(event)" class="b-4" style="margin-left: -3px;">‚ùå Cancel</button>
            </label>
          </div>


          <div id="change-target-id-menu" style="margin-top: 5px;">
            <label><span class="l-4">üéØ</span><span class="l-4"> Change target id: </span>
              <input hidden id="save-new-target-input" type="text" class="input-actions" style="margin-top:5px;">
              <button hidden id="save-new-target" class="b-4" style="margin-left: -1px;">üíæ Save</button>
              <button onclick="cancel2(event)" class="b-4" style="margin-left: -3px;">‚ùå Cancel</button>
            </label>
          </div>
        </div>
        <!-- actions menus-->

        <div hidden id="actions-containers">
          <div id="replace-action">
            <label class="action-label"><span class="action-icon">üîÑ Replace</span></label>
            <div class="action-data-group" data-target>
              <label class="action-group-label"><span class="action-icon">üéØ Target</span></label>
              <label class="action-label"><span class="action-icon">üß©</span><span
                  id="replaced-component-name-value">product-name</span></label>
              <label class="action-label"> <span class="action-icon">üÜî</span><span
                  id="replaced-component-id-value">61453686-ff1b-4a8b-bc37-66f63857f621</span></label>
              <label class="action-label"> <span class="action-icon" style="background-color: white;">üë£</span><span
                  id="replaced-component-path-value">site.com/path/blablabla/blablabla</span></label>
            </div>

            <div class="action-data-group" id="replace-action-folder">
              <label class="action-group-label"><span class="action-icon">üÜï</span><span>replace folder</span></label>
              <label class="action-label"> <span class="action-icon">üìÇ</span><span
                  id="replace-action-folder-value">site.com/path/blablabla/blablabla</span></label>
              <label class="action-label"><span class="action-icon"
                  style="user-select: none; background-color: white;">‚ûï</span><span
                  id="replace-action-folder-link-value">$../blabla/blabla/blabla</span></label>
            </div>


            <ol id="new-replace-components-list">
              <label class="action-group-list-label"><span class="action-icon">üÜï Files</span></label>
              <li id="new-replace-component">
                <label class="action-label"><span class="action-icon">üß©</span><span
                    id="new-replace-component-name-value">product-name</span></label>
                <label class="action-label"><span class="action-icon">üÜî</span><span
                    id="new-replace-component-id-value">61453686-ff1b-4a8b-bc37-66f63857f621</span></label>
                <label class="action-label"><span class="action-icon" style="background-color: white">üë£</span><span
                    id="new-replace-component-path-value">site.com/path/blablabla/blablabla</span></label>
              </li>
            </ol>
          </div>



          <label class="action-single-label" id="class-action"><span class="action-icon">üé®</span><span
              id="class-action-value">class="cool class2"</span></label>
          <label class="action-single-label" id="attriute-action"><span data-action-data-part-key
              class="action-icon">üîë</span><span id="attriute-action-value">data-user-icon</span></label>
          <label class="action-single-label" id="tc-action"><span class="action-icon">üìÑ insert text
              content</span></label>
          <label class="action-single-label" id="innerhtml-textcontent-action-content"><span
              class="action-icon">ü™£</span><span
              id="innerhtml-textcontent-action-content-value">dasdsadkj124kj21djkasdkj daokjdsakjdsajk dajkdskjsadjk
              ddsakjdsakjsdakjd dsadasdsad</span> </label>
          <label class="action-single-label" id="innerhtml-action"><span class="action-icon">‚ñ∂Ô∏è</span><span>insert inner
              html</span></label>


          <div id="component-action-add">
            <label class="action-single-label"><span class="action-icon">üß©</span><span
                id="action-add-component-name">Hub</span></label>
            <label class="action-single-label"> <span class="action-icon">üÜî</span><span
                id="action-add-component-id">61453686-ff1b-4a8b-bc37-66f63857f621</span>
            </label>
            <label class="action-single-label" id="action-component-link"><span class="action-icon"
                style=" background-color: white;">üë£</span><span
                id="action-add-component-path">site.com/path/blablabla/blablabla</span>
              <button id="action-component-redirect">‚ÜóÔ∏è</button>

            </label>

            <label class="action-single-label"> <span class="action-icon"
                style="user-select: none; background-color: white; margin-top: 3px;">‚ûï</span><span
                id="action-add-component-link-type">$../blabla/blabla</span></label>
          </div>

          <div class="action-data-group" id="action-target">
            <label class="action-group-label"><span class="action-icon">üéØ Target</span></label>
            <label class="action-label" id="action-target-tag-name"><span class="action-icon">üè∑Ô∏è</span><span
                id="action-target-tag-name-value">body</span></label>
            <label class="action-label" id="action-target-tag-id"><span class="action-icon">üÜî</span><span
                id="action-target-tag-id-value">ff1b-4a8b-bc37-66f63857f621dy-61453686</span></label>
          </div>



          <label id="change-tag-action" class="action-single-label"><span class="action-icon">üÜï</span><span
              id="change-tag-action-value">div</span></label>
          <div class="action-data-group" id="tag-action">
            <label class="action-group-label" id="tag-action-created" hidden><span class="action-icon">üÜï
                created</span></label>
            <label class="action-group-label" id="tag-action-moved"><span class="action-icon">‚û°Ô∏è moved</span></label>
            <div class="action-data-group-lvl2" id="moved-tag">
              <label class="action-label"> <span class="action-icon">üè∑Ô∏è</span><span
                  id="tag-action-tag-name">div</span></label>
              <label class="action-label"> <span class="action-icon">üÜî</span><span
                  id="tag-action-tag-id">61453686-ff1b-4a8b-bc37-66f63857f621</span></label>
            </div>
          </div>



          <label id="copy-tag-action" class="action-single-label"><span class="action-icon">‚ßâ copyid </span><span
              id="copy-id-value">414112-4141412412-41412412-4124124124-412412421</span></label>



          <div class="action-data-group" id="action-options" original>
            <label class="action-group-label"> <span class="action-icon" style="background: white;"
                id="action-options-amount">üõ†Ô∏è</span><span>options</span></label>
            <label class="action-label"></label>
            <label hidden class="action-label" id="action-option-free"><span
                class="action-icon">ü•∂</span><span>freeze</span></label>
            <label class="action-label" id="action-dub-target"><span class="action-icon">‚ßâ</span><span>dub
                target</span></label>
            <label class="action-label" id="action-apply-target-copies"><span class="action-icon">‚ßâ</span><span>apply to
                target copies</span></label>
            <label class="action-label" id="action-apply-moving-copies"><span class="action-icon">‚ßâ</span><span>apply to
                moving copies</span></label>
            <label class="action-label" id="action-append-position"><span class="action-icon">üìç append position:
              </span><span id="action-append-position-value">1</span></label>
            <label class="action-label" id="action-reuse-id"><span class="action-icon">‚ôªÔ∏è reuse id: </span><span
                id="action-reuse-id-value">AC</span></label>
            <label class="action-label" id="action-self-use-component"><span class="action-icon">ü™û</span><span>self
                use</span></label>
            <label class="action-label" id="action-in-replace"><span class="action-icon">üîÑ</span><span>in
                replace</span></label>
            <label class="action-label" id="action-fork-id"><span class="action-icon">üç¥ fork
              </span><span id="action-fork-id-value"></span></label>



          </div>

        </div>




        <!-- actions menus-->









        <tbody id="code-log-search-body">
          <!--NUMBERS!! 1Ô∏è‚É£ 2Ô∏è‚É£ 3Ô∏è‚É£ 4Ô∏è‚É£-->
          <tr hidden id="code-log-element">
            <td style="position: relative;" data-type-code-log="action-time">
              <span data-move-actions>
                <button hidden class="b-5">‚¨áÔ∏è</button>
                <button hidden class="b-5" style="margin-left: -7px; margin-right: -10px;">‚¨ÜÔ∏è</button>
              </span>
              <span id="code-log-action-time" style="margin-left: 10px;">1703707728031</span>
              <div class="action-data-tooltip">
                <div data-action-data="">
                  empty
                </div>
              </div>
            </td>
            <td data-type-code-log="action-name"><span id="code-log-action">append child</span>
            </td>
            <td><button data-type-code-log="action-remove" onclick="deleteAction(event)" class="b-5">&#128465;</button>
            </td>
          </tr>
        </tbody>
      </table>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
    </div>

    <div class="panel bottom" style="position: fixed; bottom: 0; left: 0;">
      <button id="bottom-buttons" style="margin-left: 3px;" class="b-1" onclick="removeTokenAndReload()">üì¥</button>
      <script>function removeTokenAndReload() {
          // –£–¥–∞–ª—è–µ–º 'token' –∏–∑ localStorage
          localStorage.removeItem('token');
          localStorage.removeItem('ownerid');
          localStorage.removeItem('helperid');

          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
          window.location.href = '/templatesv3/';
        }
      </script>
    </div>

  </aside>
  <main class="main" style="position: relative;">

    <div class="panel horizontal-menu">
      <button id="path_select" onclick="loadRoot()" class='b-1'
        style="user-select: none; margin-right: 7px;">üë£</button>

      <label id="page-path" onclick="labelClick(event)" class="l-2 b-dark-blue"
        style="cursor: pointer;  font:700;">~</label>

      <a href="" target="_blank" style="text-decoration: none; color: #000000;" hidden id="published-label"
        class="l-3">üåê</a>
      <a href="" target="_blank" style="text-decoration: none; color: #000000;" hidden id="published-site-label"
        class="l-3">üåé</a>

    </div>






    <div id="web-page-menu" hidden class="panel-2 horizontal-menu" style="position: relative">
      <button id="path-icon" class='b-1' onclick="publish(event)"
        style="user-select: none; margin-right: 7px;">üì∞</button>
      <button hidden class="b-1" id="published-invalidate" onclick="invalidate(event)"
        style="margin-right: 5px;">üîÑ</button>
      <button onclick="removeAndInvalidate(event)" hidden id="published-remove" class="b-1"
        style="margin-right: 5px;">üóëÔ∏èÔ∏è</button>

      <button id="published-update-content" class="b-1" style="margin-right: 5px; position: absolute; right: 20px;"
        onclick="publish(event,true)">üóûÔ∏è</button>

    </div>



    </div>

    <div id="components-tree-menu" class="panel horizontal-menu">
      <label class="l-1" style="margin-right: 10px; user-select: none;">üß©</label>
      <button class="b-1" style="margin-right: 5px;" onclick="addComponent(event)">‚ûï</button>
    </div>

    <div id="components-tree" class="horizontal-area" style="position: relative;">
    </div>

    <div id="code-tree-menu" class="panel horizontal-menu">
      <label class="l-1" style="margin-right: 10px; user-select: none;">üè∑Ô∏è</label>
      <button class="b-1" onclick="addTreeElement(event)">‚ûï</button>
      <button class="b-1" onclick="showClasses(event)">üé®</button>
      <button class="b-1" onclick="showAttributes(event)">üîë</button>




    </div>
    <div id="code-tree" class="horizontal-area" style="position: relative;">
      <fieldset id="head-tree" data-element="code-tree-tag" class="tree-element">
        <legend class="l-p b-dark-blue"></legend>
        <input id="selectedCheckbox" hidden="" type="checkbox" onchange="handleCheckboxChange(event)">
        <button class="b-3 arrow" data-element="code-tree-show-hide-button" onclick="toggleSubFields(event)">‚Üí</button>
        <button class="b-3 t" data-element="code-tree-tag-name-button"
          onclick="loader(event, handleTreeClick)">üè∑Ô∏èhead</button>
        <button hidden class="b-3 t" data-element="code-tree-inner-html-button" onclick="openInnerHtmlContent(event)">
          ‚ñ∂Ô∏è</button>
        <button class="b-3 t" hidden data-element="code-tree-attributes-button"
          onclick="openAttributeContent(event)">üîë</button>
        <button class="b-3 t" hidden data-element="code-tree-text-content-button"
          onclick="openTextContent(event)">üìÑ</button>
        <span data-element="comment" hidden class="l-3 t b-dark-blue">üí¨</span>
        <span data-element="class" hidden class="l-3 t b-dark-green">üé®</span>
        <div data-open-menu></div>
      </fieldset>

      <fieldset id="body-tree" data-element="code-tree-tag" class="tree-element">
        <legend class="l-p b-dark-blue"></legend>
        <input id="selectedCheckbox" hidden="" type="checkbox" onchange="handleCheckboxChange(event)">
        <button class="b-3 arrow" data-element="code-tree-show-hide-button" onclick="toggleSubFields(event)">‚Üí</button>
        <button class="b-3 t" data-element="code-tree-tag-name-button"
          onclick="loader(event, handleTreeClick)">üè∑Ô∏èbody</button>
        <button class="b-3 t " hidden data-element="code-tree-inner-html-button" onclick="openInnerHtmlContent(event)">
          ‚ñ∂Ô∏è</button>
        <button class="b-3 t" hidden data-element="code-tree-attributes-button"
          onclick="openAttributeContent(event)">üîë</button>
        <button class="b-3 t b-dark-blue" data-element="code-tree-text-content-button" hidden
          onclick="openTextContent(event)">üìÑ</button>
        <span data-element="comment" hidden class="l-3 t b-dark-blue">üí¨</span>
        <span data-element="class" hidden class="l-3 t b-dark-green">üé®</span>
        <div data-open-menu></div>
      </fieldset>

    </div>


    <div id="head-menu" class="panel horizontal-menu">
      <label class="l-1" style="margin-right: 10px; user-select: none;">üóø</label>
      <button hidden class="b-1 b-selected" style="margin-right: 5px;">‚≠ê</button>

    </div>
    <div id="head-1" class="horizontal-area">



      <details style="margin-bottom: 7px;" hidden data-file-name-show="Hub">
        <summary class="summary-L-3">
          <span class="l-3 b-dark-blue" id="menus_load_status">üî¥</span>
          <span class="l-3 b-dark-blue">Menus üß±</span>
        </summary>
        <label hidden class="l-3" style="margin-left: 30px;"><input id="menu_toggle_saved_in_head" type="checkbox">save
          in
          local headüóø</label>

        <table class="table-1" id="menu_toggle" style="margin-left: 30px;">
          <tr id="scripts_menu_toggle">
            <td>
              <label id="menu_toggle_status" class="l-3">üî¥</label>
              <label class="l-3" style="margin: 10px;">scripts menu</label>
            </td>
            <td hidden>
              <span class="l-3">üïê</span>
              <span class="l-3" id="menu_toggle_last_update_time">never</span>
            </td>
          </tr>
          <tr id="lists_tasks_toggle">
            <td>
              <label id="menu_toggle_status" class="l-3">üî¥</label>
              <label class="l-3" style="margin: 10px;">lists task</label>
            </td>
            <td hidden>
              <span class="l-3">üïê</span>
              <span class="l-3" id="menu_toggle_last_update_time">never</span>
            </td>
          </tr>


          <tr id="chatgpt_logs_toggle">
            <td>
              <label id="menu_toggle_status" class="l-3">üî¥</label>
              <label class="l-3" style="margin: 10px;">ChatGPT logs</label>
            </td>
            <td hidden>
              <span class="l-3">üïê</span>
              <span class="l-3" id="menu_toggle_last_update_time">never</span>
            </td>
          </tr>


          <tr id="chatgpt_task_toggle">
            <td>
              <label id="menu_toggle_status" class="l-3">üî¥</label>
              <label class="l-3" style="margin: 10px;">ChatGPT task</label>
            </td>
            <td hidden>
              <span class="l-3">üïê</span>
              <span class="l-3" id="menu_toggle_last_update_time">never</span>
            </td>
          </tr>

          <tr id="sku_menu_toggle">
            <td>
              <label id="menu_toggle_status" class="l-3">üî¥</label>
              <label class="l-3" style="margin: 10px;">Sku menu</label>
            </td>
            <td hidden>
              <span class="l-3">üïê</span>
              <span class="l-3" id="menu_toggle_last_update_time">never</span>
            </td>
          </tr>
          <tr id="import_menu_toggle">
            <td>
              <label id="menu_toggle_status" class="l-3">üî¥</label>
              <label class="l-3" style="margin: 10px;">import</label>
            </td>
            <td hidden>
              <span class="l-3">üïê</span>
              <span class="l-3" id="menu_toggle_last_update_time">never</span>
            </td>
          </tr>
          <tr id="list_menu_toggle" hidden>
            <td>
              <label id="menu_toggle_status" class="l-3">üî¥</label>
              <label id="list-name" class="l-3" style="margin: 10px;"></label>
              <label class="l-3">üìã</label>
            </td>
            <td hidden>
              <span class="l-3">üïê</span>
              <span class="l-3" id="menu_toggle_last_update_time"></span>
            </td>
          </tr>


        </table>
      </details>







      <div id="head-menus">
        <details style="margin-bottom: 7px;" hidden id="scripts-list">
          <summary class="summary-L-3">
            <span class="l-3 b-dark-blue" id="scripts_menu_load_status">üî¥</span>
            <span class="l-3 b-dark-blue">Scripts ü¶æ</span>
          </summary>
          <label hidden class="l-3" style="margin-left: 30px;"><input id="scripts-menu-save-head" type="checkbox">save
            in local
            headüóø</label>


          <table class="table-1" style="margin-left: 30px;">
            <tbody id="on_open_body">
              <tr id="scripts_on_open">
                <td colspan="7" style="text-align: center;">
                  <span class="l-2 b-dark-blue">on open üö™</span>
                  <button class="b-2" onclick="addScript(event,'onOpen')">‚ûï</button>
                  <button class="b-2" style="margin-left:3px;"
                    onclick="removeScriptStatus(event,'onOpen')">üóëÔ∏èÔ∏è</button>
                </td>
              </tr>




            </tbody>
            <tbody id="on_load_body">

              <tr id="scripts_on_load">

                <td colspan="7" style="text-align: center;">
                  <span class="l-2 b-dark-blue">on load ‚åõ</span>
                  <button class="b-2" onclick="addScript(event,'onLoad')">‚ûï</button>
                </td>
              </tr>

            </tbody>
            <tbody id="on_publish_body">
              <tr id="scripts_on_publish">
                <td colspan="7" style="text-align: center;">
                  <span class="l-2 b-dark-blue">on publish üì∞</span>
                  <button class="b-2" onclick="addScript(event,'onPublish')">‚ûï</button>
                </td>
              </tr>
            </tbody>
            <tbody id="on_click_body">
              <tr id="scripts_on_click">

                <td colspan="7" style="text-align: center;">
                  <span class="l-2 b-dark-blue">on click üê≠</span>
                  <button class="b-2" onclick="addScript(event,'onClick')">‚ûï</button>

                </td>
              </tr>






            </tbody>
            <tbody id="not_active_body">






              <tr id="scripts_not_active">
                <td colspan="7" style="text-align: center;">
                  <span class="l-2 b-dark-blue">not active üö´</span>
                  <button class="b-2" onclick="addScript(event,'notActive')">‚ûï</button>
                </td>

              </tr>

              <tr id="script_head_transfer">
                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">head transfer ‚úâÔ∏è</label>
                </td>
                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container">
                    <span class="l-3">üîÄ </span>
                    <span class="l-3  queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>

                <td>
                </td>
                <td>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>
                </td>

              </tr>



              <tr id="script_head_placeholders_transfer">
                <td>

                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">head placeholders transfer ‚úâÔ∏è</label>
                </td>
                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container">
                    <span class="l-3">üîÄ </span>
                    <span class="l-3  queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>

                <td>
                </td>
                <td>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>
                </td>

              </tr>







              <tr id="scrip_eval">
                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">eval</label>
                </td>
                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>

                </td>
                <td>
                  <span id="queue_number_container">
                    <span class="l-3">üîÄ </span>
                    <span class="l-3  queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>

                <td>
                </td>

                <td>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>
                </td>

              </tr>

              <tr id="script_import_product_buttons_pictures">
                <!-- 
                data-product
                price
                sku-variables
                -->
                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">import product buttons pictures</label>
                </td>
                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container">
                    <span class="l-3">üîÄ </span>
                    <span class="l-3  queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_on_red_checkbox" />üü•</label>
                </td>
                <td>
                  <label class="l-3"><input type="checkbox" id="execute_requires_reload" />üîÉ</label>
                </td>
                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>
                </td>
              </tr>


              <tr id="script_import_product_pictures">
                <!-- 
                data-product
                price
                sku-variables
                -->
                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">import product pictures</label>
                </td>
                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container">
                    <span class="l-3">üîÄ </span>
                    <span class="l-3  queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_on_red_checkbox" />üü•</label>
                </td>
                <td>
                  <label class="l-3"><input type="checkbox" id="execute_requires_reload" />üîÉ</label>
                </td>
                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>
                </td>
              </tr>


              <tr id="script_sku_data_to_html">
                <!-- 
                data-product
                price
                sku-variables
                -->
                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">sku data to html</label>
                </td>
                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container">
                    <span class="l-3">üîÄ </span>
                    <span class="l-3  queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_on_red_checkbox" />üü•</label>
                </td>
                <td>
                  <label class="l-3"><input type="checkbox" id="execute_requires_reload" />üîÉ</label>
                </td>
                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>
                </td>
              </tr>


              <tr id="script_breadcrumb_generation">
                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">breadCrumb generation</label>
                </td>
                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container">
                    <span class="l-3">üîÄ </span>
                    <span class="l-3  queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_on_red_checkbox" />üü•</label>
                </td>
                <td>
                  <label class="l-3"><input type="checkbox" id="execute_requires_reload" />üîÉ</label>
                </td>
                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>
                </td>
              </tr>
              <tr id="script_transfer">
                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">transfer ‚úâÔ∏è</label>
                </td>
                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container">
                    <span class="l-3">üîÄ </span>
                    <span class="l-3 queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>

                <td>
                </td>

                <td>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>

                </td>

              </tr>

              <tr id="script_product_spec_table">
                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">product specification table üì¶</label>
                </td>

                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container" hidden>
                    <span class="l-3">üîÄ </span>
                    <span class="l-3 queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_on_red_checkbox" />üü•</label>
                </td>

                <td>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>

                </td>

              </tr>

              <tr id="script_article_table_of_contents">
                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">article table of contents üìú</label>
                </td>
                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container" hidden>
                    <span class="l-3">üîÄ </span>
                    <span class="l-3 queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_on_red_checkbox" />üü•</label>
                </td>
                <td>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>

                </td>

              </tr>
              <tr id="script_cleaner">
                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">cleaner </label>
                </td>
                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container">
                    <span class="l-3">üîÄ </span>
                    <span class="l-3 queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_on_red_checkbox" />üü•</label>
                </td>
                <td>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>

                </td>

              </tr>

              <tr id="script_generate_product_json">
                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">product json üì¶</label>
                </td>

                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container">
                    <span class="l-3">üîÄ </span>
                    <span class="l-3 queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>
                <td>
                  <label class="l-3"><input type="checkbox" id="execute_on_red_checkbox" />üü•</label>
                </td>
                <td>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>

                </td>

              </tr>



              <tr id="script_generate_article_anchor">
                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">self anchor ‚öìÔ∏è</label>
                </td>
                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container" hidden>
                    <span class="l-3">üîÄ </span>
                    <span class="l-3 queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_on_red_checkbox" />üü•</label>
                </td>
                <td>
                </td>


                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>

                </td>

              </tr>

              <tr id="script_refresh_catalog">


                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label class="l-3" style="margin: 10px;">refresh catalog ‚ú®</label>
                </td>
                <td>
                  <span class="l-3">ü¶æ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container">
                    <span class="l-3">üîÄ </span>
                    <span class="l-3  queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>
                <td>
                </td>
                <td>
                </td>
                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>
                </td>
              </tr>


              <tr id="script_chatgpt_">
                <td>
                  <input type="checkbox" id="script_execute_select" hidden>
                  <label id="script_status" class="l-3">üî¥</label>
                  <label id="gpt-name" class="l-3" style="margin: 10px;">{sampel} </label>
                </td>
                <td>
                  <span class="l-3">ü§ñ</span>
                  <span class="l-3" id="last_script_execute_time">never</span>
                </td>
                <td>
                  <span id="queue_number_container" hidden>
                    <span class="l-3">üîÄ </span>
                    <span class="l-3 queue" contenteditable id="queue_number">~</span>
                  </span>
                </td>

                <td>
                  <label class="l-3"><input checked type="checkbox" id="execute_on_red_checkbox" />üü•</label>
                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_requires_reload" />üîÉ</label>

                </td>

                <td>
                  <label class="l-3"><input type="checkbox" id="execute_in_template" />üöß</label>

                </td>

              </tr>
            </tbody>

          </table>




        </details>

        <details style="margin-bottom: 7px; " id="article-table-of-content-menu" hidden>
          <summary class="summary-L-3"><span class="l-3">üìë Table of contents üî¥</span></summary>
          <div style="margin-left: 30px;">
            <button class="b-3" id="generate-table-button"> Generate</button>
          </div>
        </details>


        <details hidden id="product-table-specification" style="margin-bottom: 7px;">
          <summary class="summary-L-3"><span class="l-3 b-dark-blue" id='spec-status'>üóÇÔ∏è Table spec üî¥</span>
          </summary>
          <button class="b-3" onclick="generateTableSpecApi(event)"> Generate</button>
        </details>


        <details hidden id="breadCrumb-menu" style="margin-bottom: 7px;">
          <summary class="summary-L-3"><span class="l-3 b-dark-blue" id='breadcrumb-status'>ü•ñ BreadCrumb Menu üî¥</span>
          </summary>
          <button class="b-3" onclick="generateBreadCrumbApi(event)"> Generate</button>
        </details>


        <details hidden style="margin-bottom: 7px; " id="ai-logs">
          <summary class="summary-L-3"><span class="l-3">ü™µ AI logs</span></summary>
          <textarea class="text1"></textarea>
        </details>

        <details hidden style="margin-bottom: 7px;" id="chatgpt-task-json">
          <summary class="summary-L-3"><span class="l-3 b-dark-blue">‚öôÔ∏è ChatGPT</span></summary>
          <textarea id="gpt-input" class="text1" style="width: 50vw" placeholder=" ü§ñ AI tasks"></textarea>
          <button onclick="saveGpt(event)" data-save class="b-4">üíæ Save</button>
        </details>

        <details hidden style="margin-bottom: 7px;" id="chatgpt-task-json">
          <summary class="summary-L-3"><span class="l-3 b-dark-blue">‚öôÔ∏è ChatGPT</span></summary>
          <textarea id="gpt-input" class="text1" style="width: 50vw" placeholder=" ü§ñ AI tasks"></textarea>
          <button onclick="saveGpt(event)" data-save class="b-4">üíæ Save</button>
        </details>



        <details id="lists-task-json" hidden style="margin-bottom: 7px;">
          <summary class="summary-L-3"><span class="l-3 b-dark-blue">‚öôÔ∏è List</span></summary>
          <textarea id="list-input" class="text1" style="width: 50vw" placeholder=" üìç List tasks"></textarea>
          <button onclick="saveList(event)" data-save class="b-4">üíæ Save</button>
        </details>



      </div>



      <!-- undefinied menus-->
      <details style="margin-bottom: 7px;" data-list hidden>
        <summary class="summary-L-3"><span class="l-3" data-list-emoji>üì£</span><span> </span><span
            class="l-3 b-dark-blue" data-list-name> Meta</span></summary>
        <table class="table-1" style="margin-left: 30px;">
          <tr data-lists-element>
            <td class="l-3"><label class="l-3" style="margin-right: 5px;" data-lists-element-status>üî¥</label>
              <label class="l-3" data-lists-element-key></label>
            </td>
            <td class="l-3">
              <span data-lists-element-value contenteditable></span>
            </td>
            <td class="l-3">
              <select class="select-1" data-list-element-selection>
                <option value="none">‚¨áÔ∏è Select</option>
                <option data-list-element-selection-value>‚û°Ô∏è</option>
              </select>
            </td>
            <td><label data-list-element-benefit-label class="l-3"><input data-list-element-benefit
                  type="checkbox">Benefit</label></td>
        </table>
        <details style="margin-left: 25px;">
          <summary class="summary-L-3" style="margin-top: 5px; "><span class="l-3">‚ûï add new positions to
              list</span><span></summary>
          <textarea id="import-list-input" class="text1" style="width: 50vw; "
            placeholder=" use : separator for key values"></textarea>
          <br>
          <button class="b-4" onclick="saveToList(event)">üíæ Save</button>

        </details>
      </details>
      <details hidden style="margin-bottom: 7px;" data-ai>
        <summary class="summary-L-3"><span class="l-3 b-dark-blue">ü§ñ AI</span></summary>
        <table class="table-1" data-head="meta" style="margin-left: 30px;">
          <tr data-ai-row>
            <td class="l-3"><label data-ai-status class="l-3">üî¥</label><label data-ai-label class="l-3"
                style="margin: 10px;"></label>
            </td>
            <td class="l-3"> <button class="b-3" data-ai-send>ü§ñ</button></td>
          </tr>
        </table>
      </details>

      <details id="import-menu-2" hidden style="margin-bottom: 7px;">
        <summary class="summary-L-3"><span class="l-3 b-dark-blue">üöÄ Import Menu2</span></summary>
        <button class="b-2" style="margin-left: 30px; margin-top: 10px;" onclick="add_import_row(event)">‚ûï</button>
        <table class="table-1" style="margin-left: 30px; margin-top: 10px;">
          <tr id="import2-row" hidden>
            <td>
              <span class="l-3 b-dark-blue" id="import_toggle">üî¥</span>
            </td>
            <td>
              <span id="import-name"></span>

            </td>
            <td>
              <span id="import-component"></span>


            </td>
            <td>
              <details id="import-menu-2" style="margin-bottom: 7px;">
                <summary class="summary-L-3"><span class="l-3 b-dark-blue">üöÄ</span></summary>
                <textarea id="saveImportText"></textarea>
                <br>
                <button class="b-4" id="saveImportButton">üíæ Save</button>
              </details>
            </td>


          <tr>
        </table>

      </details>


      <details id="import-menu" hidden style="margin-bottom: 7px;">
        <summary class="summary-L-3"><span class="l-3 b-dark-blue">üöÄ Import Menu</span></summary>
        <button style="margin-left: 10px;" class="b-4" id="import-name"><span>üî° </span><span
            id="import-name-span">Article</span></button>

        <div id="import-data" hidden data-menu style="margin-bottom: 30px; ">
          <button onclick="cancel(event)" class="b-4" style="margin-bottom: 5px; margin-top: 10px;">‚ùå</button>
          <br>
          <div hidden id="variation-amount-field"><span class="l-3">üßÆ Variations: </span><span id="variation-amount"
              class="l-3">10</span></div>
          <div hidden id="variation-site-field"><span class="l-3">üåê Site: </span><span id="variant-site"
              class="l-3">accbuddy.com</span></div>

          <span class="l-3"></span>
          <button data-save class="b-4">üíæ Save</button>
          <button hidden id='previous-html' class="b-4"> Prev. ‚óÄÔ∏è</button>
          <button hidden id="next-html" class="b-4">‚ñ∂Ô∏è Next</button>
          <button hidden id="remove-html" class="b-4">üóëÔ∏èRemove</button>
          <button hidden id="update-html" class="b-4">üîÑ Update</button>
          <div hidden id="approve-menu">
            <button class="b-4"> ‚úÖ Approve</button>
            <button class="b-4"> ‚ùå Cancel</button>
          </div>
          <br>
          <textarea id="import-input" class="text1" style="width: 50vw" placeholder=" üöÄ Enter Import Text"></textarea>
          <br>
          <button data-save class="b-4">üíæ Save</button>
        </div>
      </details>

      <details id="sku-menu" hidden style="margin-bottom: 7px;">
        <summary class="summary-L-3"><span class="l-3 b-dark-blue">üì¶ SKU</span></summary>
        <input type="text" class="b-3" id="input-sku" placeholder="enter sku">
        <button class="b-3" id="create-sku" onclick="addSku(event)">‚ñ∂Ô∏è</button>
        <div id="sku-list" hidden>
        </div>

        <label id="checkbox-label" hidden data-type="dependant" class="l-3"><input type="checkbox">Color</label>
        <fieldset hidden id="dependee-menu-item" data-type="dependee">
          <legend>
            <label class="l-2">üéöÔ∏è</label>
            <label data-type="dependee-value" class="l-2 b-dark-blue">Price</label>
          </legend>

          <div>
            <button class="b-3" id="generate-dependees" onclick="generateDependees(event)">Generate</button>
          </div>
        </fieldset>



        <div hidden id=sku-item-1>
          <label class="l-3 b-dark-blue"></label><label style="margin-left: 30px;" class="l-2" id="sku-value"></label>
          <button hidden class="b-3" id="toggleSkuAttributeList" onclick='toggleSkuAttributeList(event)'>üëÄ</button>
          <button class="b-3" id="toggleDependencyMenu1" onclick='toggleDependencyMenu1(event)'>üõ†Ô∏è</button>


          <button class="b-3" id="remove-sku" onclick="openRemoveSku(event)">üóëÔ∏èÔ∏è</button>

          <fieldset style="display: none;" id="remove-sku-menu" class="menu">
            <legend><button class="b-6" onclick="cancel(event)" style="font-size: 0.9em;">‚ùå</button></legend>
            <label class="l-3">Are you sure want to remove this SKU?</label>
            <br>
            <button onclick="removeSku(event)" class="b-3">üóëÔ∏èÔ∏è Remove</button>
          </fieldset>


          <ul class="list-1" id="sku-attribute-list">
            <div id='sku-item'>
              <li id="sku-attribute">
                <span class="l-4">üîñ</span><span class="l-4" id="sku-attribute-value">none</span>
                <span style="margin-left: 10px;" class="l-4">üì¶</span>
                <span class="l-4" id="sku-qty">~</span>
                <del class="l-4" style="margin-left: 10px; margin-right: 10px;" contenteditable
                  data-price_old_value>~</del>
                <ins class="l-4" contenteditable data-price_value>~</ins>
              </li>
            </div>
          </ul>

          <div id="dependee-menu" hidden>
            <fieldset data-type="dependee">
              <legend>
                <label class="l-2">üéöÔ∏è</label>
                <label data-type="dependee-value" class="l-2 b-dark-blue">Price</label>
              </legend>
              <label data-type="dependant" class="l-3"><input type="checkbox">Color</label>
              <div>
                <button class="b-3" id="generate-dependees">Generate</button>
              </div>
            </fieldset>
          </div>
        </div>

      </details>

      <details id="sku-menu2" style="margin-bottom: 7px;">
        <summary class="summary-L-3"><span class="l-3 b-dark-blue">üì¶ SKU</span></summary>
        <div hidden id="warehouse_select2" style="margin-left: 25px;">
          <fieldset class="menu" style="display: inline-block;">
            <legend> <label class="l-2 b-dark-blue"><input type="checkbox">color</label></legend>
            <label class="l-3"> <input name="color" type="radio"/>blue</label>
            <label class="l-3"> <input name="color"  type="radio"/>white</label>
          </fieldset>

          <fieldset class="menu" style="display: inline-block;">
            <legend> <label class="l-2 b-dark-blue"><input type="checkbox">color</label></legend>

            <label class="l-3"> <input name="size" type="radio"/>blue</label>
            <label class="l-3"> <input  name="size" type="radio"/>white</label>
            <br>
            <label class="l-3"><input type="checkbox" >assign to specification</label>
            <br>
            <label class="l-3"><input type="checkbox" >assign to import</label>

            <br>
          </fieldset>

        </div>

        <div>
          <br>
          <button class="b-3">text</button>
          <br>
          <label><input type="checkbox">include key</label>
          <button class="b-3">color</button>
          <button class="b-3">size</button>
          <br>
          <textarea value="">{blablabla}</textarea>

        </div>
          <div>
            <span>color:</span>
            <label><input type="checkbox">include key</label>
            <label><input type="checkbox">activate paramtr</label>
          </div>
          <div>
            <span>size:</span>
            <label><input type="checkbox">include key</label>
            <label><input type="checkbox">activate paramtr</label>
          </div>

      </details>

      <!--
      <details id="sku-menu2" style="margin-bottom: 7px;">
        <summary class="summary-L-3"><span class="l-3 b-dark-blue">üì¶ SKU</span></summary>
        <div id="sku-empty2">
          <input type="text" class="b-3" id="input-sku2" placeholder="enter sku">
          <button class="b-3" id="create-sku2" onclick="addSku2(event)">‚ñ∂Ô∏è</button>
        </div>

        <div id="sku_filled">
          <label style="margin-left: 30px;" class="l-2" id="sku-value2"></label>

          <button class="b-3" id="remove-sku" onclick="openRemoveSku(event)">üóëÔ∏è</button>

          <fieldset style="display: none;" id="remove-sku-menu" class="menu">
            <legend><button class="b-6" onclick="cancel3(event)" style="font-size: 0.9em;">‚ùå</button></legend>
            <label class="l-3">Are you sure want to remove this SKU?</label>
            <br>
            <button onclick="removeSku2(event)" class="b-3">üóëÔ∏è Remove</button>
          </fieldset>
          <div id="warehouse_select2" style="margin-left: 25px;">
            <label class="l-3" id="warehouse_select_label" hidden><input type="radio" name="warehouse_select"
                id="warehouse-zd" /><span>üè¨</span><span id="warehouse_value-zd"></span></label>
          </div>
      
          <select id="warehouse_select" class="select-1"
            style="display: inline-block; margin-bottom: 7px; margin-left: 30px;">
            <option>‚¨áÔ∏è Select</option>
            <option hidden id="warehouse_select_option">
              üè¨

            </option>
          </select>
          
          <select id="destionation-select" class="select-1"
            style="display: inline-block; margin-bottom: 7px; margin-left: 30px;">
            <option>‚¨áÔ∏è Select</option>
            <option hidden id="destination_select_option"><span>üè¨</span><span id="destionation-value"></span></option>
          </select>
       

          <div id="warehouse_data">
            <table id="sku-table" class="table-sku" style="margin-left: 30px; margin-top: 10px;">
                <tr>
                  <th rowspan="2">
                    <span class="l-2 b-dark-blue" >sku variables</span>
                  </th>
                  <th rowspan="2">
                    <span class="l-2 b-dark-blue">condition</span>
                  </th>
                  <td hidden id="sku-variable-condition">
                    <span>
                    <span class="l-3">üì¶</span>
                    <span class="l-3" id="sku-variable-condition-value"></span>
                  </span>
                  </td>
                  
                </tr>
                <tr>
                  <td id="all-td" hidden>
                    <span onBlur="setAllQty(event)" id="all-quantity" style="float: left;" class="l-3"
                      contenteditable>setAll</span>

                  </td>
                </tr>
                <tr id="sku-variable-row" hidden>
                  <th>
                    <span id="sku-variable-xz">
                      <span id="sku-attribute-key-xz" class="l-3 sku-attribute"></span>
                      <span class="l-3">:</span>
                      <span id="sku-attribute-value-xz" class="l-3"></span>
                      <span class="l-3">;</span>
                    </span>
                  </th>
                  <th>
                    <span id="sku-attribute-condition">new</span>
                  </th>
                  <td id="sku-variable-td" hidden>
                    <span onBlur="setQty(event)" id="sku-variable-quantity" style="float: left;" class="l-3"
                      contenteditable>0</span>
                  </td>
                </tr>
            </table>
            <div id="condition-price-table" hidden>
              <hr style="border-bottom: 2px solid #ffcc81; margin-top: 20px; margin-bottom: 20px;">
              <table class="table-sku" style="margin-left: 30px; margin-top: 10px;" id="site_sku_table">
                <caption>
                  <strong class="l-1 b-dark-blue">üì¶</strong>
                  <strong class="l-1 b-dark-blue" id="condition-table-caption-value">new</strong>
                </caption>
                <tbody>
                  <tr>
                    <th>
                      <span class="l-3 b-dark-blue">sku variables</span>
                    </th>
                    <td id="sku-condition-warehouse-name">
                      <span class="l-3">üè¨</span>
                      <span id="sku-condition-warehouse-name-value" class="l-3">warehouse</span>
                    </td>

                    <td id="sku-condition-site-name">
                      <span class="l-3">üåê</span>
                      <span class="l-3" id="sku-condition-site-name-value">mogobuy.com</span>
                    </td>
                  </tr>
                </tbody>

                <tbody>
                  <tr id="sku-variable-row-all">
                    <th class="">
                      <span>
                        <span class="l-3 sku-attribute">ALL</span>
                      </span>
                      <span>
                    </th>
                    <td id="sku-variable-price-warehouse-all">
                      <strong id="sku-variable-price-warehouse-value-all" class="price-normal" contenteditable
                        onBlur="setPriceWareHouseAll(event)">0</strong>
                    </td>
                    <td id="sku-variable-price-all">
                      <del onBlur="setPriceSiteOldAll(event)" id="sku-variable-price-all-old" class="price-old"
                        contenteditable>0</del>
                      <strong onBlur="setPriceSiteAll(event)" id="sku-variable-price-all-current" class="price-normal"
                        contenteditable>0</strong>
                    </td>
                  </tr>

                  <tr id="sku-variable-row" hidden>
                    <th>
                      <span id="sku-variable-xz" hidden>
                        <span id="sku-attribute-key-xz" class="l-3 sku-attribute">color</span>
                        <span class="l-3">:</span>
                        <span id="sku-attribute-value-xz" class="l-3">white</span>
                        <span class="l-3">;</span>
                      </span>
                    </th>
                    <td id="sku-variable-price-warehouse">
                      <strong onBlur="setPriceWareHouse(event)" id="sku-variable-price-warehouse-value"
                        class="price-normal" contenteditable>0</strong>
                    </td>
                    <td id="sku-variable-price-site">
                      <del onBlur="setPriceSiteOld(event)" id="sku-variable-price-site-old" class="price-old"
                        contenteditable>0</del>
                      <strong onBlur="setPriceSite(event)" id="sku-variable-price-site-current" class="price-normal"
                        contenteditable>0</strong>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <hr style="border-bottom: 2px solid #ffcc81; margin-top: 20px; margin-bottom: 20px;">
         
          <div id="destionation-select" style="margin-left: 25px;">
            <label class="l-3"><input type="radio" name="destionation-select" id="destination" />üè¥</label>
          </div>


            <table class="shipping-table" style="margin-left: 30px; margin-top: 10px;">
              <tbody>
                <tr>

                  <th>
                    <span class="l-3 b-dark-blue">ship method</span>
                  </th>
                </tr>
              </tbody>

              <tbody>
                <tr>
                  <th>
                    <span>
                      <span class="l-3 sku-attribute">ship method1</span>
                    </span>
                    <span>
                  </th>
                  <td>
                    <table id="ship-method-destination-table" class="table-1"
                      style="margin-left: 30px; margin-top: 10px;">
                      <tr>
                        <td>
                          <span class="b-dark-blue">üè¥to</span>
                        </td>
                      </tr>
                      <tr>
                      <tr id="ship-method-destination-row">
                        <td>
                          <span id="ship-method-destination-value" contenteditable>usa</span>
                        </td>
                      </tr>

                    </table>
                  </td>

                  <td>
                    <button id="ship-method-add-destination-row" class="b-3">‚ûï</button>
                  </td>


                </tr>
              </tbody>
            </table>
          </div>
          <hr style="border-bottom: 2px solid #ffcc81; margin-top: 20px; margin-bottom: 20px;">


          <details style="margin-left: 25px; margin-top: 10px;">
            <summary class="summary-L-3" style="margin-top: 5px; "><span class="l-3">‚ûï push new sku
                variables</span><span></summary>
            <textarea id="push_new_sku_variables" class="text1" style="width: 50vw; "
              placeholder=" use : separator for key values"></textarea>
            <br>
            <button class="b-4" onclick="pushSkuVariables(event)">üíæ Save</button>
          </details>
          <details style="margin-left: 25px; margin-top: 10px;">
            <summary class="summary-L-3" style="margin-top: 5px; "><span class="l-3">‚ûï select warehouse</span><span>
            </summary>
            <button class="b-4" onclick="addWareHouse(event)">add</button>

            <table id="warehouse-table" class="table-sku" style="margin-left: 30px; margin-top: 10px;">
              <tbody>
                <tr>
                  <th>
                    <span class="l-3">+</span>
                  </th>

                  <td>
                    <span class="l-3">üè¨</span>
                    <span class="l-3 b-dark-blue"> warehosue name</span>
                  </td>

                  <td>
                    <span class="l-3">‚è≥</span>
                    <span class="l-3 b-dark-blue"> min processing</span>
                  </td>
                  <td>
                    <span class="l-3">‚åõ</span>

                    <span class="l-3 b-dark-blue"> max processing</span>
                  </td>

                </tr>
                <tr hidden id="warehouse-row">
                  <th>
                    <span class="l-3 enable-warehouse" id="enableWareHouse"> üî¥</span>
                  </th>

                  <td>
                    <span class="l-3 warehouse-name" onblur="setSkuItemValue(event)" id="wareHouseInput"
                      contenteditable>warehouse1</span>
                  </td>
                  <td>
                    <span id="warehouse-min-processing" class="l-3" contenteditable>0</span>
                  </td>
                  <td>
                    <span id="warehouse-max-processing" class="l-3" contenteditable>0</span>
                  </td>
                  <td>
                    <label class="l-3">default<input type="checkbox" name="default-ship-mathod"></label>
                  </td>

                  <td>
                    <button class="b-3 warehouse-rename" onclick="removeSkuParam(event)">üóë</button>
                  </td>

                </tr>
              </tbody>


            </table>

          </details>
         
          <details style="margin-left: 25px; margin-top: 10px;">
            <summary class="summary-L-3" style="margin-top: 5px; "><span class="l-3">‚ûï select destination</span><span>
            </summary>
            <button class="b-4" onclick="addDestination(event)">add</button>

            <table id="destination-table" class="table-1" style="margin-left: 30px; margin-top: 10px;">
              <tbody>
                <tr id="destination-row" hidden>
                  <td>
                    <span class="l-3 enable-destination" id="enableDestination">üî¥</span>
                  </td>
                  <td>
                    <span class="l-3 destination-name" onblur="setSkuItemValue(event)" id="destinationInput"
                      contenteditable>destination</span>
                  </td>
                  <td>
                    <button class="b-3 destination-rename" onclick="removeSkuParam(event)">üóë</button>
                  </td>
                </tr>
              </tbody>


            </table>
          </details>
        

          <details style="margin-left: 25px; margin-top: 10px;">
            <summary class="summary-L-3" style="margin-top: 5px; "><span class="l-3">‚ûï select ship method</span><span>
            </summary>
            <button class="b-4" onclick="addShippingMethode(event)">add</button>

            <table id="ship-table" class="table-1" style="margin-left: 30px; margin-top: 10px;">
              <tbody>
                <tr id="ship-row" hidden>
                  <td>
                    <span class="l-3 enable-ship">üî¥</span>
                  </td>
                  <td>
                    <span class="l-3 ship-name" onblur="setSkuItemValue(event)" id="shipInput" contenteditable>ship
                      method</span>
                  </td>
                  <td>
                    <table id="ship-from-to-table" class="table-1" style="margin-left: 30px; margin-top: 10px;">
                      <tr>
                        <td>
                          <span class="b-dark-blue">üè¥from</span>
                        </td>
                        <td>
                          <span class="b-dark-blue">üè¥to</span>
                        </td>
                        <td>
                          <span class="b-dark-blue">‚è≥min</span>
                        </td>
                        <td>
                          <span class="b-dark-blue">‚åõmax</span>
                        </td>
                      </tr>
                      <tr id="ship-from-to-row">
                        <td>
                          <span id="ship-from-value" contenteditable="">~</span>
                        </td>
                        <td>
                          <span id="ship-to-value" contenteditable>~</span>
                        </td>
                        <td>
                          <span id="ship-min-time" contenteditable>~</span>
                        </td>
                        <td>
                          <span id="ship-max-time" contenteditable>~</span>
                        </td>
                      </tr>

                    </table>
                  </td>

                  <td>
                    <button id="ship-method-add-from-to" class="b-3">‚ûï</button>
                  </td>



                  <td>
                    <button class="b-3 ship-rename" onclick="removeSkuParam(event)">üóë</button>
                  </td>

                </tr>
              </tbody>
            </table>
          </details>
          <details style="margin-left: 25px; margin-top: 10px;">
            <summary class="summary-L-3" style="margin-top: 5px; "><span class="l-3">‚ûï select condition</span><span>
            </summary>
            <button class="b-4" onclick="addCondition(event)">add</button>

            <table id="condition-table" class="table-1" style="margin-left: 30px; margin-top: 10px;">
              <tbody>
                <tr id="condition-row" hidden>
                  <td>
                    <span class="l-3 enable-condition" id="enableCondition">üî¥</span>
                  </td>
                  <td>
                    <span class="l-3 condition-name" onblur="setSkuItemValue(event)" id="conditionInput"
                      contenteditable>condition</span>
                  </td>
                  <td>
                    <button class="b-3 condition-rename" onclick="removeSkuParam(event)">üóë</button>
                  </td>
                </tr>
              </tbody>


            </table>
          </details>
        </div>


      </details>
  -->
    </div>


    <!-- undefinied menus-->









    <div id="generated-page-menu" class="panel horizontal-menu">
      <label class="l-1" style="margin-right: 10px; user-select: none;">üëÅÔ∏è</label>
      <button id='transform' class="b-1" onclick="transformToVisual(event)">‚úçÔ∏è</button>
    </div>



    <!--
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
  IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME

  -->
    <div id="iframe-container">
      <iframe id="generated-page-iframe" src="./iframe.html"
        style="width:100%; height:2000px; border:none; margin-bottom: 200px;" allowfullscreen="true" allow="
      
      display-capture;
      geolocation; 
      microphone; " class="horizontal-area">
      </iframe>
    </div>
    <!--
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
  IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME

  -->

  </main>

  <!-- MENUS-->


  <div hidden>


    <fieldset style="display: none;" id="remove-menu" class="menu">
      <legend><button class="b-6" onclick="cancel3(event)" style="font-size: 0.9em;">‚ùå</button></legend>
      <label class="l-3">Are you sure want to remove this item?</label>
      <br>
      <button class="b-3">üóëÔ∏è Remove</button>
    </fieldset>




    <div id="stock-menu" data-menu style="margin-bottom: 30px;">
      <button style="margin-right:5px; margin-top: 5px; margin-bottom: 5px;" class="b-3"
        onclick="cancel(event)">‚ùå</button>
      <br>
      <label class="l-3"><input type="radio" id="digital-good" name="choose-goods-type" checked value="digital" />üìü
        Digital</label>
      <label class="l-3"><input type="radio" name="choose-goods-type" id="real-good" value="real" />üì¶ Real</label>
      <div id="digital-menu" style="margin-top: 10px;">
        <button add-stock class="b-3">‚ûï Add</button>
        <button stock-qty class="b-3">üî¢ Qty</button>
        <button view-stock class="b-3">üîé View</button>
        <button stock-label class="b-3">üè∑Ô∏è Label</button>
      </div>
      <div hidden id="real-goods-menu">
        <button stock-qty class="b-3"> üî¢ Qty</button>
      </div>
    </div>

    <div id="view-stock" data-menu style="margin-bottom: 30px; ">
      <button class="b-3" onclick="cancel(event)" style="margin-top: 10px; margin-bottom: 5px;">‚ùå</button>

      <table class="table-2 table-row-number-2">
        <tbody id="stock-table-body">
          <tr id="stock-item" hidden stockItem>
            <td><span class="l-4" style="user-select: none;">üîë</span><span class="l-4" id="stock-item-value"></span>
            </td>
            <td><span class="l-4" style="user-select: none;">üë®</span><span class="l-4" id="stock-item-status"><span>
            </td>
            </td>
          </tr>
        </tbody>
      </table>
    </div>


    <div id="stock-label" data-menu style="margin-bottom: 30px; ">
      <button onclick="cancel(event)" class="b-4" style="margin-bottom: 5px;">‚ùå</button>
      <br>
      <button class="b-4" id="update-label">üíæ Update</button>
      <input type="text" placeholder="üè∑Ô∏è Stock label" class="input-1" style=" width: 50px;" id="stock-label-input">
    </div>


    <div id="stock-qty" data-menu style="margin-bottom: 30px; ">
      <button onclick="cancel(event)" class="b-4" style="margin-top:5px; margin-bottom: 5px;">‚ùå</button>
      <br>
      <button id="update-qty" class="b-4">üíæ Update</button>
      <input type="number" placeholder="‚öñÔ∏è Qty" class="input-2" value="0" style=" width: 50px;">
    </div>


    <div id="add-stock-menu" data-menu style="margin-bottom: 30px; ">
      <br>
      <button class="b-3" onclick="cancel(event)" style="margin-bottom:7px; margin-right: 5px;">‚ùå</button>
      <br>
      <button save-stock class="b-3" style="margin-bottom:7px; margin-right: 5px;">üíæ Save</button>
      <br>
      <textarea id="add-stock-input" class="text1" placeholder=" üì¶ insert digital goods 1 per line"></textarea>
      <br>
      <button save-stock class="b-3" style="margin-top:5px;">üíæ save</button>
    </div>

    <fieldset class="menu" id="gallery-menu-wrapper" data-menu>
      <legend><button class="b-3" id="remove-galeryMenu">‚ùå</button></legend>
      <div style="font-size: 30px; height: 100px;">
        <input type="file" id="image-input" accept="image/*" hidden />
        <label for="image-input" id="select-file-button" class="file-upload-button b-1">‚ûï Add new</label>
        <button id="upload-button" class="upload-button b-1" hidden>üì§</button>
        <span id="file-name" hidden>No file chosen</span>
      </div>
      <table style=" border-collapse: collapse;" class="table-1">
        <thead>
          <tr>
            <th>meta</th>
            <th>picture</th>
            <th>sku variable buttons</th>
            <th>gallery options</th>

          </tr>
        </thead>
        <tr hidden id="gallery-item" style="border-bottom: 2px dashed #3d3d3d;">
          <td style="padding-top: 9px; padding-bottom: 9px;">

            <div data-picture-meta>
              <br>
              <label class="l-3">Created: </label>
              <time data-picture-time class="l-3 b-dark-blue">24.02.23 15:39</time>
              <br>
              <div data-picture-attached>
                <label class="l-3">Attached: </label><label class="l-3 b-dark-blue" data-picture-attached-label>
                  üìéYes</label>
                <label class="attached">üìé</label>
              </div>
              <div>
                <button class="b-3" data-select-image>‚úÖ Attach</button>
                <button class="b-3" data-remove-image>üóëÔ∏è DeleteÔ∏è</button>
              </div>
            </div>


          </td>
          <td style="padding-top: 9px; padding-bottom: 9px;">
            <div class="gallery-image">

              <img style="width: 200px; height: auto;" src="https://via.placeholder.com/500/0000FF/FFFFFF?text=image">

            </div>
          </td>
          <td id="item-sku-variable">
            <details style="margin-bottom: 7px;" id="item-sku-variable-details" hidden>
              <summary class="summary-L-3"><span class="l-3 b-dark-blue">color</span></summary>
              <select class="select-1" style="display: block; margin-bottom: 7px; margin-left: 18px;" multiple="">
                <option id='none'> none</option>
              </select>
            </details>
          </td>
          <td id="item-gallery-options">
            <div data-file-name-show="Product-Content">
              <label class="l-3">
                <input data-picture-main-checkbox type="checkbox">‚≠ê Main
              </label>
              <br>
              <label class="l-3">
                <input data-picture-secondary-checkbox type="checkbox">‚ú® Secondary
              </label>
            </div>

            <details style="margin-bottom: 7px;" id="item-gallery-details" hidden>
              <summary class="summary-L-3"><span class="l-3 b-dark-blue">color</span></summary>
              <select class="select-1" style="display: block; margin-bottom: 7px; margin-left: 18px;" multiple="">
                <option id='none'> none</option>
              </select>
            </details>

          </td>

        </tr>
        <tbody id="gallery-body">




        </tbody>
      </table>
      <!--
      <fieldset style="display: none;" id="menu-1" class="menu">
        <legend><button class="b-3" onclick="cancelGalleryMenu(event)">‚ùå</button>
          <button class="b-3">‚¨ÖÔ∏è</button>
        </legend>

        <img src="https://via.placeholder.com/1000/0000FF/FFFFFF?text=image">

      </fieldset>
      -->

    </fieldset>



    <div id="code-tree-comment-form" data-menu style="margin-bottom: 30px; ">
      <button onclick="cancel(event)" class="b-4" style="margin-top:5px; margin-bottom: 5px;">‚ùå</button>
      <br>
      <label><input type="checkbox" id="applyToCopies"><span class="l-3" style="margin-bottom: 5px;">‚ßâ Apply to
          Copies</span></label>
      <br>

      <button class="b-4" onclick="removeComment(event)">üóëÔ∏èÔ∏è Remove</button>
      <button class="b-4" onclick="saveComment(event)">üíæ Save</button>
      <br>
      <input id="comment-content" type="text" placeholder="üí¨ Comment" class="input-1" style="margin-top: 7px;">
    </div>



    <fieldset id="update-href-menu" class="menu" data-menu>
      <button class="b-3" onclick="cancel(event)">‚ùåCancel</button>
      <input id="editHrefInput" style="width: 500px" placeholder="üîó edit href" type="text">
      <button id="editHrefButton">üíæ</button>
    </fieldset>
    <!--
          <fieldset id="component-element" data-element="code-tree-tag" class="tree-element" style="margin-left: 50px;">

-->

    <div id="component-element" data-element="code-tree-tag" class="tree-element tree-element-1">

      <legend></legend>
      <input hidden type="checkbox" onchange="handleCheckboxChange(event)">
      <button class="b-3 arrow" data-element="code-tree-show-hide-button"
        onclick="toggleSubFields(event)">&#8594;</button>
      <button class="b-3 t" data-element="code-tree-tag-name-button"
        onclick="loader(event, handleComponentClick)">üè∑Ô∏ècomponent</button>
      <button hidden class="b-3 t" data-element="code-tree-attributes-button"
        onclick="openAttributeContent(event)">üîë</button>
      <button hidden class="b-3 t" data-element="optional-script" onclick="replaceComponent(event,true)">üîÑ10</button>
      <span hidden class="b-3 t" data-element="content_type">‚≠ê</span>
      <span hidden class="b-3 t" data-element="set_anchor">‚öìÔ∏è</span>
      <span hidden class="b-3 t" data-element="catalog">‚ú®</span>

      <span data-open-menu></span>
    </div>

    <fieldset id="tree-element" data-element="code-tree-tag" class="tree-element" style="margin-left: 50px;">
      <legend></legend>
      <input id="selectedCheckbox" hidden type="checkbox" onchange="handleCheckboxChange(event)">
      <button class="b-3 arrow" data-element="code-tree-show-hide-button"
        onclick="toggleSubFields(event)">&#8594;</button>
      <button class="b-3 t" data-element="code-tree-tag-name-button"
        onclick="loader(event, handleTreeClick)">üè∑Ô∏ècomponent</button>
      <button class="b-3 t" data-element="code-tree-inner-html-button" hidden onclick="openInnerHtmlContent(event)">
        ‚ñ∂Ô∏è</button>
      <button class="b-3 t" data-element="code-tree-attributes-button" hidden
        onclick="openAttributeContent(event)">üîë</button>
      <button class="b-3 t" data-element="code-tree-text-content-button" hidden
        onclick="openTextContent(event)">üìÑ</button>
      <button class="b-3 t" hidden data-element="redirect-to-component">‚ÜóÔ∏è</button>

      <span data-element="comment" hidden class="l-3 t b-dark-blue">üí¨</span>
      <span data-element="class" hidden class="l-3 t b-dark-green">üé®</span>
      <span data-element="attributes" hidden class="l-3 t b-dark-green">üé®</span>
      <span data-open-menu></button>
    </fieldset>






    <!--menu click component-->
    <div id="code-tree-click-component" data-menu style="margin-bottom: 30px;">
      <button class="b-3" onclick="cancel(event)" style="margin-right:5px; margin-top: 5px;">‚ùå</button>
      <br>
      <button class="b-3" style="margin-right: 5px; margin-top: 5px;" onclick="replaceComponent(event)">‚ûï
        choose</button>
      <label><input checked type="radio" id="replace" name="choose_component_type"><span class="l-3">üîÑ
          replace</span></label>
      <label><input type="radio" id="single_replace" name="choose_component_type"><span class="l-3">1Ô∏è‚É£ single
          replace</span></label>
      <label><input type="radio" id="choose_catalog" name="choose_component_type"><span class="l-3">‚ú® choose
          catalog</span></label>
      <label><input type="radio" id="choose_article" name="choose_component_type"><span class="l-3">‚≠ê choose
          article</span></label>


      <div hidden id="content-type">
        <label class="b-3" hidden><input type="radio" name="main-content-type" data-content-type="none" checked
            value="none" />üóÖ None</label>

        <label class="b-3" hidden><input type="radio" name="main-content-type" data-content-type="article"
            value="article" />‚≠ê
          Article</label>

        <label class="b-3" hidden><input type="radio" name="main-content-type" data-content-type="catalog"
            value="catalog" />‚ú®
          Catalog</label>
        <div hidden id="catalog-folder">
          <button class="b-4">üíæ Update</button>
          <input type="text" placeholder="üìÇ Catalog folder" class="input-1" style=" width: 50px;">
        </div>
        <div hidden id="catalog-weight">
          <button class="b-4">üíæ Update</button>
          <input type="number" placeholder="üèãÔ∏è‚Äç‚ôÇÔ∏è Catalog Weight" class="input-1" style=" width: 50px;">
        </div>
      </div>
      <br>
      <label style="margin-top: 10px;"><input type="checkbox" id="set_anchor_checkbox" onclick="setAnchor(event)"><span
          class="l-3">‚öìÔ∏è Set
          anchor</span></label>

    </div>


    <!--menu click tag-->
    <div id="code-tree-click-tag" data-menu style="margin-bottom: 30px; ">
      <button style="margin-right:5px; margin-top: 5px;" class="b-3" onclick="cancel(event)">‚ùå</button>
      <br>


      <label><input type="checkbox" id="applyToCopies"><span class="l-3">‚ßâ Apply to Copies</span></label>
      <label><input type="checkbox" id="actionInReplace"><span class="l-3">üîÑ action in replace</span></label>

      <br>

      <button style="margin-right: 5px;" class="b-3" id="code-tree-click-tag-change-tag" onclick="changeTag(event)">‚úèÔ∏è
        Change tag</button>

      <button style="margin-right: 5px;" class="b-3" id="code-tree-click-tag-remove-tag" onclick="removeTag(event)">üóëÔ∏èÔ∏è
        Remove
        element</button>

      <br>


      <button class="b-3 t" data-element="code-tree-attributes-button" onclick="openAttributeContent(event)">üîë
        Attributes</button>

      <button style="margin-right:5px; margin-top: 5px;" data-element="code-tree-comment-button" class="b-3"
        onclick="openComment(event)">üí¨ Comment</button>
      <button class="b-3 t" data-element="code-tree-inner-html-button" onclick="openInnerHtmlContent(event)"> ‚ñ∂Ô∏è
        InnerHtml</button>
      <button class="b-3 t" data-element="code-tree-text-content-button" onclick="openTextContent(event)">üìÑ
        TextContent</button>
      <br>
      <button style="margin:5px; margin-left: 0px; background-color: #f0f0f0;" class="b-3"
        id="code-tree-click-tag-append-child" onclick="append(event)">üë∂ Append</button>
      <button style="margin:5px; margin-left: 0px; background-color: #f0f0f0;" onclick="addParent(event)"
        class="b-3">üë®‚Äçüë¶Ô∏è Add Parent</button>

      <button style="margin:5px; margin-left: 0px; background-color: #f0f0f0;" class="b-3"
        id="code-tree-click-tag-insert-before" onclick="insertB(event)">‚¨ÖÔ∏è insertBefore</button>
      <button style="margin:5px; margin-left: 0px; background-color: #f0f0f0;" class="b-3"
        id="code-tree-click-tag-insert-before" onclick="insertA(event)"> insertAfter ‚û°Ô∏è</button>

      <button style="margin:5px; margin-left: 0px; background-color: #f0f0f0;" class="b-3"
        id="code-tree-click-tag-insert-before">history üß©</button>

      <br>






      <!--
      <button style="margin-right:5px; margin-top: 5px;" class="b-3" id="code-tree-click-tag-change-tag"
        onclick="changeTagForCopies(event)">‚úèÔ∏è ChangeCopies</button>



<button  class="b-2" id="code-tree-click-tag-inner-html" onclick="insertHtml(event)">üìÑ inner HTML</button>
        <button class="b-2" id="code-tree-click-tag-dublicate-tag" onclick="duplicateTag(event)"> ‚ßâ Duplicate Element</button>
        -->
    </div>

    <!--menu add element-->
    <div id="code-tree-add-tag-step-1" style="padding: 7px; margin-bottom: 30px; " data-menu>
      <button style="margin-bottom: 5px;" class="b-4" onclick="cancel(event)">‚ùå</button>
      <br>
      <button class="b-4" id="code-tree-add-tag-choose-new" onclick="addNew(event)"> ‚ûï New</button>
      <button class="b-4" id="code-tree-add-tag-choose-existed" onclick="addExisting(event)"> ‚úîÔ∏è Existed</button>
      <button class="b-4" id="code-tree-add-tag-choose-component" onclick="addComponent(event,true)">
        üß©Component</button>
    </div>


    <!-- menu confirm selected append/insert tags-->
    <fieldset id="code-tree-append-or-insert-approv-menu" data-menu class="menu"
      style="border: 0; padding: 0; margin-bottom: 30px; user-select: none; display: block; width: 100%;">
      <button onclick="cancel(event)" class="b-4" style="margin-top: 5px; margin-bottom: 5px;">‚ùå</button>
      <br>
      <span id="code-tree-amount-selected-for-append-or-insert" style="font-size: 24px;">0</span>
      <button class="b-4" id="code-tree-click-tag-approve" onclick="approve(event)"> ‚úÖ Approve</button>
      <br>

      <label><input type="checkbox" id="actionInReplaceExisting"><span class="l-3">üîÑ action in replace</span></label>
      <br>
      <label><input type="checkbox" id="fork"><span class="l-3">üç¥ fork</span></label>
      <label><input type="checkbox" id="transfer-inner-html"><span class="l-3">transfer inner html</span></label>

      <br>
      <label class="l-3" hidden><input type="checkbox" onchange="switchPosition(event)" id="position-checkbox">üéØ
        Position</label>
      <label class="l-3" hidden><input type="number" value="1" id="position-number"></label>
      <label class="l-3" hidden><input type="radio" checked name="position-start-end-existed"
          id="position-start-checkbox">start</label>
      <label class="l-3" hidden><input type="radio" name="position-start-end-existed"
          id="position-end-checkbox">end</label>

      <br>
      <label><input type="checkbox" id="code-tree-menu-copies-too"><span class="l-3">üöÇ‚ßâ Insert Copies
          too</span></label>
      <br>
      <label hidden class="l-3"><input name="duplicate-or-not-target-for-copies"
          id="code-tree-menu-dublicate-with-parent-option" id="code-tree-menu-dublicate-with-parent-option-1"
          id="code-tree-menu-dublicate-with-parent-option-2" type="checkbox">üéØ‚ßâ Duplicate Target for Copies</label>

    </fieldset>


    <!-- history menu -->
    <div id="component_history_menu" data-menu style="margin-bottom: 30px; ">
      <button id="code-tree-tag-attributes-form-action-back" class="b-3" onclick="cancel(event)"
        style="margin-bottom:7px; margin-right: 5px;">‚ùå</button>
      <table class="table-1" id="components_history_table" style="margin-left: 30px;">
        <tr id="component_history">
          <td>
            <span class="l-3"></span>
            <span class="l-3" id="component-history-value">cool-component</span>
          </td>
          <td>
            <a href="" class="l-3" id="component-history-anchor">‚ÜóÔ∏è</span>
          </td>
        </tr>
      </table>
    </div>

    <!-- menu to receive text area html -->
    <div id="code-tree-tag-text-content-form" data-menu style="margin-bottom: 30px; ">
      <button id="code-tree-tag-attributes-form-action-back" class="b-3" onclick="cancel(event)"
        style="margin-bottom:7px; margin-right: 5px;">‚ùå</button>

      <br>
      <label><input type="checkbox"><span class="l-3">‚ßâ Apply to Copies</span></label>
      <br>
      <label><input type="checkbox"><span class="l-3">üîÑ action in replace</span></label>
      <br>

      <button id="code-tree-tag-text-content-action-save" onclick="saveText(event)" class="b-3"
        style="margin-bottom:7px; margin-top: 7px; margin-right: 5px;">üíæ Save</button>
      <br>
      <textarea class="text1" placeholder=" üìÑ Text content" id="code-tree-tag-text-content"></textarea>
      <br>
      <button id="code-tree-tag-text-content-action-save" onclick="saveText(event)" class="b-3"
        style="margin-top: 5px;">üíæ save</button>
    </div>
    <!-- menu to receive inner html -->
    <div id="code-tree-tag-html-content-form" data-menu style="margin-bottom: 30px; ">
      <br>
      <button id="code-tree-tag-attributes-form-action-back" class="b-3" onclick="cancel(event)"
        style="margin-bottom:7px; margin-right: 5px;">‚ùå</button>
      <br>
      <label><input type="checkbox" id="applyToCopies"><span class="l-3">‚ßâ Apply to Copies</span></label>
      <br>

      <label><input type="checkbox"><span class="l-3">üîÑ action in replace</span></label>
      <br>


      <button id="code-tree-tag-text-content-action-save" onclick="saveInnerHtml(event)" class="b-3"
        style="margin-bottom:7px; margin-right: 5px;">üíæ
        Save</button>
      <br>
      <textarea class="text1" placeholder=" ‚ñ∂Ô∏è HTML content" id="code-tree-tag-html-content"></textarea>
      <br>
      <button id="code-tree-tag-text-content-action-save" onclick="saveInnerHtml(event)" class="b-3"
        style="margin-top:5px;">üíæ
        save</button>
    </div>



    <!--menu to view and edit attributes-->
    <div class="menu-1" id="code-tree-tag-attributes-form-1" data-menu style="margin-bottom: 30px; ">
      <button id="code-tree-tag-attributes-form-action-back" class="b-3" onclick="cancel(event)"
        style="margin-top: 10px; margin-bottom: 5px;">‚ùå</button>


      <table class="table-2 table-row-number-2" id="code-tree-tag-attributes-list">
        <tbody>
          <tr id="code-tree-tag-attributes-list-item">
            <td><span class="l-4" style="user-select: none;">üîë</span><span class="l-4"
                id="code-tree-tag-attribute-key"></span></td>
            <td><span class="l-4" style="user-select: none;">üìÑ</span><span style="color:white">=</span><span
                style="color:white">"</span><span class="l-4" id="code-tree-tag-attribute-value"></span><span
                style="color:white">"</span></td>
            <td>
              <button id="code-tree-tag-attribute-remove-button" class="b-4"
                onclick="removeAttribute1(event)">üóëÔ∏èÔ∏è</button>
            </td>
          </tr>
        </tbody>
      </table>
      <div style="margin-bottom: 10px;">
        <br>
        <label><input type="checkbox" id="applyToCopies"><span class="l-3">‚ßâ Apply to Copies</span></label>
        <br>

        <label><input type="checkbox"><span class="l-3">üîÑ action in replace</span></label>
        <br>

        <button class="b-3" onclick="saveAttribute(event)" style="margin-bottom: 5px; margin-top: 5px;">üíæ Save</button>
        <br>
        <textarea id="code-tree-tag-attribute-input-text" class="text1" placeholder=" üîë Add Attributes"></textarea>
        <br>
        <button class="b-3" onclick="saveAttribute(event)" style="margin-bottom: 5px; margin-top: 5px;">üíæ Save</button>
      </div>
    </div>

    <fieldset id="tag-table" style="border-width: 0px; margin-bottom: 30px; " data-menu>
      <button onclick="cancel(event)" class="b-3" style="margin-top: 5px; margin-bottom: 5px;">‚ùå</button></legend>
      <br>
      <label class="l-3"><input type="checkbox" id="position-checkbox" onchange="switchPosition(event)">üéØ
        Position</label>
      <label class="l-3" hidden><input type="number" value="1" id="position-number"></label>
      <label class="l-3" hidden><input type="radio" name="position-start-end-new" id="position-start-checkbox"
          checked>start</label>
      <label class="l-3" hidden><input type="radio" name="position-start-end-new" id="position-end-checkbox">end</label>


      <br>

      <label class="l-3">
        <input type="checkbox" id="applyForCopies2">
        ‚ßâ InsertToCopies+
      </label>
      <br>
      <label class="l-3">
        <input type="checkbox" id="actionInReplace2">
        üîÑ action in replace
      </label>




      <table id="tagsTable" class="tagsTable-style">
        <thead>
          <tr>
            <th><input type="text" id="searchTagName" placeholder="Search by Tag Name" onkeyup="filterTable(0)">
            </th>
            <th><input type="text" id="searchTagValue" placeholder="Search by Tag Value" onkeyup="filterTable(1)">
            </th>
            <th><input type="text" id="searchTagType" placeholder="Search by Tag Type" onkeyup="filterTable(2)">
            </th>
            <th><input type="text" id="searchTagComment" placeholder="Search by Tag Comment" onkeyup="filterTable(3)">
            </th>
          </tr>
          <tr>
            <th>Tag Name</th>
            <th>Tag Value</th>
            <th>Tag Type</th>
            <th>Tag Comment</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </fieldset>


    <!--files menus-->

    <!-- missing target -->

    <div id="target_element_missing">

      <span class="l-1">‚ö†Ô∏è</span><span class="l-2">Target element missing</span>
      <br>
      <div id="error_action_info"></div>
      <button id='fix-in-component' class="b-2">üß© fix in component</button>
      <button id='set-new-target' class="b-2">üÜï new target</button>
      <button id='remove-command' class="b-2">üóë remove</button>
    </div>

    <!-- file path-->
    <li data-element="file-path" id="item">
      <label hidden class="l-3" style="margin-right: 3px;" id="Pushpin">üìå</label>
      <label data-value="file-path" class="l-3">universal/blablabla/blablabla/coolcss</label>
      <label data-value="file-emoji" style="user-select: none; margin-left: 5px;" class="l-3">üß©</label>
      <div hidden data-value="file-id">for javascript</div>
      <button hidden data-action="remove-file-confirmation">for javascript</button>
    </li>


    <ol data-element="file-path-list" id="selectedFilePathList" class="list-1"
      style="margin-left: -10px; margin-bottom: 30px; " data-menu>
      <button style="margin-bottom: 8px; margin-left: -10px;" class="b-4" onclick="cancelReplace(event)">‚ùå</button>
      <br>
      <button style="margin-bottom: 8px; margin-left: 4px;" class="b-4" onclick="approveReplace(event)">‚úÖ
        Approve</button>
      <button style="margin-bottom: 8px; margin-left: 4px;" class="b-4" data-action="moveBack">‚§¥Ô∏è Up</button>
      <label class="l-3"><input onchange="switchFolder(event)" id="attach-folder" type="checkbox">üìÇFolder</label>
      <label class="l-3" id="relative-label" hidden><input type="radio" name="relative-absolute-choose"
          id="relative-input">üóÇÔ∏èRelative</label>
      <label class="l-3" id="absolute-label" hidden><input type="radio" name="relative-absolute-choose"
          id="absolute-input">üìÇAbsolute</label>
      <label class="l-3" id="content-label" hidden><input type="radio" name="relative-absolute-choose"
          id="content-input"></label>

    </ol>


    <ol id="filePathList" class="list-1" style="margin-left: -10px;">
    </ol>


    <div hidden id="file-list-attach-component-options" style="padding: 5px; margin-left: 10px; margin-bottom: 30px; "
      data-menu>
      <label class="l-3"><input checked type="radio" id="root" name="start_path" checked />ü´öroot</label>
      <label class="l-3"><input type="radio" id="previous-component" name="start_path" checked />‚èÆÔ∏èprevious</label>
      <label class="l-3"><input type="radio" id="current-component" name="start_path" checked />üß©component</label>
      <br>



      <button class="b-3" id="file-list-link-by-path" style="margin-top: 5px;"
        onclick="switchSelected(event)">üìÇAbsolute</button>
      <button class="b-3" id="file-list-link-by-name" style="margin-top: 5px;"
        onclick="switchSelected(event)">üóÇÔ∏èRelative</button>

      <button class="b-3" id="file-list-link-by-content-name" style="margin-top: 5px;"
        onclick="switchSelected(event)">üîóFolder-Content</button>
      <label class="l-3"><input id="selfuse" type="checkbox">Self use</label>
      <label class="l-3"><input id="reusable" type="checkbox">Re-usable</label>

      <br>

      <button style="margin-top: 5px;" class="b-4" onclick="cancelAddComponent(event)">‚ùåCancel</button>
      <button style="margin-top: 5px;" class="b-4" onclick="approveAddComponent(event)">‚úÖ Approve</button>
      <button style="margin-top: 5px;" class="b-4" data-action="moveBack">‚§¥Ô∏è Up</button>

    </div>
  </div>


  <div id="loading">

    <span hidden style="font-size: 1; color: white;"></span>
    <div hidden id="timer" style="font-size: 2em; color: white;">1.12</div>
    <button hidden style="font-size: 30px;" id="remove-loading">‚ùå</button>
  </div>


  <!--
  <div id="loading"
    style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 2;">

    <span style="font-size: 10.2em; color: white;">‚è≥</span>
    <div id="timer" style="font-size: 2em; color: white;">1.12</div>
    <button style="font-size: 30px;" id="remove-loading">‚ùå</button>
  </div>

  -->
  <script>
    var log1 = (t) => { }
    const showAttributes = (event) => {
      const target = event.target
      if (target.classList.contains('b-selected')) {
        //hide*
        target.classList.remove('b-selected')
        document.querySelectorAll('[data-element="attributes"]').forEach(element => {
          element.setAttribute('hidden', '')
        })
      }
      else {
        //show
        target.classList.add('b-selected')
        document.querySelectorAll('[data-element="attributes"]').forEach(element => {
          const id = element.parentNode.id
          const generated = getElementById1(removeLastOccurrence(id, '-tree'))

          const attributes = generated.getAttributeNames().filter(attr => !['id', 'class'].includes(attr));
          if (attributes.length) {
            element.removeAttribute('hidden')
            element.textContent = attributes.map(att => {
              const value = generated.getAttribute(att)
              return value ? att + '=' + value : att
            }).join(' ')
          }
        })
      }
    }
    const showClasses = (event) => {
      const target = event.target
      if (target.classList.contains('b-selected')) {
        //hide*
        target.classList.remove('b-selected')
        document.querySelectorAll('[data-element="class"]').forEach(element => {
          element.setAttribute('hidden', '')
        })
      }
      else {
        //show
        target.classList.add('b-selected')
        document.querySelectorAll('[data-element="class"]').forEach(element => {
          const id = element.parentNode.id
          const generated = getElementById1(removeLastOccurrence(id, '-tree'))
          const class1 = generated?.getAttribute('class')
          if (class1) {
            element.removeAttribute('hidden')
            element.textContent = 'üé®' + class1
          }
        })
      }
    }

    var convertToOldPath = (path) => {
      const splited = path.split('|')
      const fileName = splited.pop()
      return splited[0] + '/' + fileName
    }
    var convertToNewPath = (path) => {
      const splited = path.split('/')
      const fileName = splited.pop()
      return splited.join('/') + '|' + fileName
    }
    const switchPosition = (event) => {
      const fieldset = event.target.closest('fieldset')
      const checked = event.target.checked
      const number = fieldset.querySelector('#position-number')
      const start = fieldset.querySelector('#position-start-checkbox')
      const end = fieldset.querySelector('#position-end-checkbox')
      if (checked) {
        [number, start, end].forEach(e => e.parentNode.removeAttribute('hidden'))
      }
      else {
        [number, start, end].forEach(e => e.parentNode.setAttribute('hidden', ''))
      }
    }

    //label click scripts
    function loadRoot() {

      path = ''
      localStorage.setItem('storedPath', path)

      // Update the text content of the label

      window.location.href = 'index.html';
    }
    function labelClick(event) {
      // Extract the clicked part of the text based on the click position
      const clickedText = getClickedText(event, event.target.textContent);
      if (clickedText === pathItemPath.split(';')[0]) {
        return
      }
      const p = clickedText
      path = p + '/'
      localStorage.setItem('storedPath', path)
      log1(path)
      window.location.href = 'index.html';
      // Update the text content of the label

    }

    function getClickedText(event, labelText) {
      const clickX = event.clientX;
      const labelRect = event.target.getBoundingClientRect();
      const relativeClickX = clickX - labelRect.left;

      // Split the label text into parts based on the '/' separator
      const parts = labelText.split('/');

      // Find the part that corresponds to the clicked position
      let accumulatedWidth = 0;
      for (const part of parts) {
        const partWidth = getTextWidth(part + '/', event.target);
        accumulatedWidth += partWidth;
        if (accumulatedWidth >= relativeClickX) {
          const parts1 = parts.slice(0, parts.indexOf(part) + 1)
          return parts1.join('/')
        }
      }

      // Default: return the entire label text
      return labelText;
    }

    function getTextWidth(text, element) {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      const computedStyle = window.getComputedStyle(element);
      context.font = computedStyle.font;

      // Measure the width of the text
      const width = context.measureText(text).width;

      // Cleanup
      canvas.remove();

      return width;
    }

  </script>
  <script>
    var postToDb = (item) => fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(
        item
      ),
    });
    //gallery scripts 
    var cancelGalleryMenu = (event) => {
      event.target.closest('#menu-1').style.display = 'none';
    }
    var handleMainChange = async (e, item) => {
      const checked = e.target.checked
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(
          { ...item, main: checked }
        ),
      });
    }
    function preSelectOptions(selectElement, selectedValues) {
      const options = selectElement.querySelectorAll('option');
      options.forEach(option => {
        if (selectedValues?.includes(option.id)) {
          option.selected = true;
        } else {
          option.selected = false;
        }
      });
    }

    var handleSecondaryChange = async (e, item) => {
      const checked = e.target.checked
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(
          { ...item, secondary: checked }
        ),
      });
    }
    var loadImages = async (clonedFieldset, src) => {

      clonedFieldset.querySelector('#remove-galeryMenu').onclick = (e) => {
        e.target.closest('fieldset').remove()
      }
      clonedFieldset.querySelector('#upload-button').onclick = (e) => handleUpload1(e, src)
      //const id = pathItemSku || pathItem.id
      let mergedItems = []
      const ids = [...Object.keys(cache)]
      if (pathItemSku) {
        ids.push(pathItemSku)
        ids.push('sku:' + pathItemSku)
      }
      else {
        ids.push(pathItem.id)
      }
      const res = await Promise.all(ids.map(e => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${e}&sk=pics&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json().then(({ items }) => {
        mergedItems.push(...items)
      }))
      ))

      let items = mergedItems
      items.sort((a, b) => b.sk.localeCompare(a.sk))
      log1('items' + JSON.stringify(items))
      const table = clonedFieldset.querySelector('#gallery-body');
      const templateRow = clonedFieldset.querySelector('#gallery-item');
      table.innerHTML = ""
      let skuMap
      if (pathItemSku) {
        const skuVariables = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=sku:${pathItemSku}&sk=sku-variables;&startsWith=true`)
          .then(response => response.json()).then(res => res.items)

        const obj = {}
        for (const item of skuVariables) {
          const splited = item.sk.split(';')
          for (let i = 1; i < splited.length - 1; i++) {
            const splited2 = splited[i].split(':')
            obj[splited2[0]] ? (!obj[splited2[0]].includes(splited2[1])
              && obj[splited2[0]].push(splited2[1]))
              : (obj[splited2[0]] = [splited2[1]])
          }
        }
        skuMap = obj

      }
      // Loop through each image item
      items.forEach((item) => {
        // Clone the template row
        const clonedRow = templateRow.cloneNode(true);
        clonedRow.querySelector('[data-picture-time]').textContent = item.date || ''
        const mainCheckbox = clonedRow.querySelector('[data-picture-main-checkbox]')
        mainCheckbox.checked = !!item.main
        mainCheckbox.onchange = (e) => handleMainChange(e, item)
        const secondaryCheckbox = clonedRow.querySelector('[data-picture-secondary-checkbox]')
        secondaryCheckbox.checked = !!item.secondary
        secondaryCheckbox.onchange = e => handleSecondaryChange(e, item)
        clonedRow.removeAttribute('hidden'); // Show the cloned row
        clonedRow.querySelector('[data-select-image]').onclick = selectImage
        //clonedRow.querySelector('[data-show-menu]').onclick = showMenu
        clonedRow.querySelector('[data-remove-image]').onclick = (e) => removeImage(e, src)
        // Update the image source based on the item's sk
        const imageSrc = `https://s3.amazonaws.com/checkout-admin-panel/${item.sk}`;
        const imgEl = clonedRow.querySelector('.gallery-image img')
        imgEl.src = imageSrc;
        const uuid = item.sk.split('.')[0].replace('pics', '')
        imgEl.setAttribute('uuid', uuid)
        imgEl.setAttribute('cid', item.id)
        if (src !== uuid) {

          const attachedLabel = clonedRow.querySelector('[data-picture-attached-label]');
          if (attachedLabel) {
            attachedLabel.textContent = 'NO'
          }
        }
        if (skuMap) {
          const skuVRow = clonedRow.querySelector('#item-sku-variable-details')
          const optionsRow = clonedRow.querySelector('#item-gallery-details')
          if (!item.gallery_variables_sku_variables) {
            item.gallery_variables_sku_variables = {}
          }
          if (!item.picture_buttons_sku_variables) {
            item.picture_buttons_sku_variables = {}
          }
          for (const key of Object.keys(skuMap)) {
            const cloned = skuVRow.cloneNode(true)
            const cloned2 = optionsRow.cloneNode(true)
            cloned.removeAttribute('hidden')
            cloned2.removeAttribute('hidden')
            cloned.querySelector('summary span').textContent = key
            cloned2.querySelector('summary span').textContent = key
            cloned.querySelector('select').onchange = (e) => {
              const selectedValues = Array.from(e.target.selectedOptions).map(option => option.id);
              if (selectedValues.includes('none')) {
                item.picture_buttons_sku_variables[key] = []
              }
              else {
                item.picture_buttons_sku_variables[key] = selectedValues
              }

              postToDb(item)
            }
            cloned2.querySelector('select').onchange = (e) => {
              const selectedValues = Array.from(e.target.selectedOptions).map(option => option.id);
              if (selectedValues.includes('none')) {
                item.gallery_variables_sku_variables[key] = []
              }
              else {
                item.gallery_variables_sku_variables[key] = selectedValues
              }
              postToDb(item)
            }
            for (const value of skuMap[key]) {
              const option = document.createElement('option')
              option.id = value
              option.textContent = value
              cloned.querySelector('select').append(option)

              const option2 = document.createElement('option')
              option2.id = value
              option2.textContent = value
              cloned2.querySelector('select').append(option2)
            }
            preSelectOptions(cloned.querySelector('select'), item.picture_buttons_sku_variables[key]);

            // Pre-select options for cloned2 select element
            preSelectOptions(cloned2.querySelector('select'), item.gallery_variables_sku_variables[key]);
            skuVRow.parentNode.append(cloned)
            optionsRow.parentNode.append(cloned2)
          }

        }


        // Set a unique id for the cloned row (assuming you have a property named id in the item)
        clonedRow.id = `image-body-${item.sk}`;

        // Append the cloned row to the table
        table.appendChild(clonedRow);
      });
      // Select all gallery images
      const images = clonedFieldset.querySelectorAll('.gallery-image');

      images.forEach(image => {
        const actions = image.querySelector('img');

        // When you hover over an image
        image.addEventListener('mouseenter', () => {
          // Set the z-index of the picture actions to 10
          actions.style.zIndex = '10';
        });

        // When the mouse leaves the image
        image.addEventListener('mouseleave', () => {
          // Reset the z-index of the picture actions to -10
          actions.style.zIndex = '-10';
        });
      });
    }
    function showMenu(event) {
      const galleryImage = event.target.closest('.gallery-image');
      const imageSrc = galleryImage.querySelector('img').src;

      // Set the image source in the menu
      const menuImage = getElementById1('menu-1').querySelector('img');
      menuImage.src = imageSrc;

      // Display the menu
      const menu = getElementById1('menu-1');
      menu.style.display = 'block';
    }
    async function removeImage(event, src) {
      const img = event.target.closest('tr').querySelector('img')
      const id = img.getAttribute('cid')
      const imageSrc = img.src;
      log1('Removing Image Src:', imageSrc);
      const sk = imageSrc.replace('https://s3.amazonaws.com/checkout-admin-panel/', "")
      const imgId = event.target.closest('[data-menu]').id.replace('gallery-menu-wrapper;', '')
      try {
        await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${id}:${sk}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            // Add any additional headers if needed
          },
        });
      }
      catch (e) {
        log1('error ' + JSON.stringify(e))
      }
      try {
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/upload?id=' + sk, {
          method: 'DELETE',
        });
      }
      catch (e) {
        log1(JSON.stringify(e))
      }
      //to cont
      //setImg('https://via.placeholder.com/300/0000FF/FFFFFF?text=Article-Image', imgId)
      loadImages(event.target.closest('[data-menu]', src))

    }
    const setImg = async (path, imgId) => {

      const payload2 = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'src',
        value: path,
        check_b: true

      }
      pushAction(payload2)
    }
    const upload = async (fileName, fileContent) => {
      const body = {
        fileName
      }
      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/upload', {
        method: 'POST',
        body: JSON.stringify(body),
      });

      if (!response.ok) {
        return
      }
      const { url, fields, path } = await response.json()
      const formData = new FormData();
      Object.entries(fields).forEach(([field, value]) => {
        formData.append(field, value);
      });
      formData.append('file', fileContent);

      // Use Fetch API to send a POST request with the FormData to the presigned URL
      const uploadResponse = await fetch(url, {
        method: 'POST',
        body: formData,
      })
      if (!uploadResponse.ok) {
        const er = await uploadResponse.text()
        log1('error ' + er)
        return
      }
      return path
    }
    const getFormatedDate = () => {
      const currentDate = new Date();
      const day = String(currentDate.getDate()).padStart(2, '0');
      const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // Months are zero based
      const year = String(currentDate.getFullYear()).slice(-2);
      const hours = String(currentDate.getHours()).padStart(2, '0');
      const minutes = String(currentDate.getMinutes()).padStart(2, '0');

      const formattedDate = `${day}:${month}:${year} ${hours}:${minutes}`;
      return formattedDate
    }
    async function handleUpload1(event, src) {

      const id = pathItemSku ? ('sku:' + pathItemSku) : pathItem.id
      const fileContent = await file
      const fileName = fileContent.name

      try {

        const path = await upload(fileName, fileContent)
        log1(path)
        //push to db image
        // Send a POST request using fetch
        const payload = {
          id,
          sk: path,
          date: getFormatedDate()
        }
        const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });
        loadImages(event.target.closest('[data-menu]'), src)


      } catch (error) {
      }
    }

    function generateRandomString(length) {
      const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; // Letters and numbers
      let randomString = '';

      for (let i = 0; i < length; i++) {
        const randomIndex = Math.floor(Math.random() * charset.length); // Generate a random index
        randomString += charset.charAt(randomIndex); // Append the random character to the string
      }

      return randomString;
    }

    async function selectImage(event) {
      const dataMenu = event.target.closest('[data-menu]')
      const imgId = dataMenu.id.replace('gallery-menu-wrapper;', '')
      const image = event.target.closest('tr').querySelector('img')

      const imageSrc = image.src;
      const imageUUID = image.getAttribute('uuid')
      const imageElement = getElementById1(removeLastOccurrence(imgId, '-tree'))
      const name = imageElement.getAttribute('data-builder-image-name')
      const defaultRes = imageElement.getAttribute('data-builder-image-default')

      const site = pathItemPath.split('/')[0]
      let randomString = generateRandomString(3)
      let url1 = 'https://' + site + '/pics/' + randomString + '_' + name
      function checkSrcStartsWithUrl1() {
        const elements = document.querySelectorAll('[src^="' + url1 + '"]');
        return elements.length > 0;
      }
      while (checkSrcStartsWithUrl1()) {
        randomString = generateRandomString(3);
        url1 = 'https://' + site.toLowerCase() + '/pics/' + randomString + '_' + name;
      }
      const splited = pathItemPath.split('/')
      splited.pop()
      splited.shift()
      const index = splited.indexOf('Content');
      if (index !== -1) {
        splited.splice(index);
      }
      // resize
      const body = {
        site,

        name: randomString + '_' + name,
        imageSrc,
        defaultRes,
        pagePath: splited.join('/')
      }
      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/resize', {
        method: 'POST',
        body: JSON.stringify(body),
      });
      const { src, data_src } = await response.json()
      const selectedLabels = dataMenu.querySelectorAll('[data-picture-attached-label]');
      selectedLabels.forEach(label => label.textContent = "NO");
      event.target.closest('tr').querySelector('[data-picture-attached-label]').textContent = 'YES'


      const payload = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'data-builder-image-source',
        value: imageUUID,

      }
      await pushAction(payload)

      const payload3 = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'src',
        value: src,
        check_b: true

      }
      await pushAction(payload3)
      const payload4 = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'data-src',
        value: data_src,

      }
      await pushAction(payload4)
      await setSrcSet(imageElement)
      dataMenu.remove()



    }




  </script>

  <script>
    const urlSearchParams = new URLSearchParams(window.location.search);
    var page_id = urlSearchParams.get('id');

    const loaded = true;
    var removeMenus = () => document.querySelector("#code-tree").querySelectorAll('[data-menu]').forEach(menu => menu.remove())
    var getElementById1 = (id) => {
      const el = document.getElementById(id)
      if (el) {
        return el
      }
      var iframe = document.getElementById("generated-page-iframe");

      // Access the content of the iframe
      var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;

      // Modify the content of the generated-page div within the iframe
      var el2 = iframeDocument.getElementById(id);
      if (el2) {
        return el2
      }
      log1('not found id1' + id)
      return undefined
    }
    var querySelectorAll1 = (selector, head) => {

      const els1 = document.querySelectorAll(selector)

      var iframe = getElementById1("generated-page-iframe");

      // Access the content of the iframe
      var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
      head && (selector = '[data-lists-element-value]' + selector)

      var els2 = iframeDocument.querySelectorAll(selector);

      log1('not found all' + selector)
      const res = [...els1, ...els2]
      log1("r11" + JSON.stringify(Array.from(els1).map(e => e.id)) + selector)
      log1("r12" + JSON.stringify(Array.from(els2).map(e => e.id)) + selector)
      log1("r13" + JSON.stringify(Array.from(res).map(e => e.id)) + selector)
      return res
    }
    getElementById1('remove-loading').addEventListener('click', function () {
      getElementById1('loading').remove();
    });

  </script>
  <script>
    const removeAndInvalidate = async (e) => {
      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/removeandinvalidate/' + pathItem.id + ':' + pathItem.sk, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      });
      const el2 = getElementById1("path-icon")
      el2.classList.remove('b-green');
      el2.classList.remove('b-selected');
      const el3 = getElementById1("published-label")
      const el4 = getElementById1("published-invalidate")
      const el5 = getElementById1("published-remove")
      const pSiteLabel = getElementById1("published-site-label")
      el3.setAttribute('hidden', '')
      el4.setAttribute('hidden', '')
      el5.setAttribute('hidden', '')
      pSiteLabel.setAttribute('hidden', '')
      el3.removeAttribute('href')
      pSiteLabel.removeAttribute('href')
    }
    const invalidate = async (e) => {
      const site = pathItemPath.split('/')[0]
      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/invalidate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ site }),
      });
    }
    function capitalizeAndReplaceHyphens(str) {
      // Replace hyphens with spaces and split the string into words
      const capitalizedWords = str.replace(/-/g, ' ').split(' ');

      // Capitalize the first letter of each word

      const firstLetter = capitalizedWords[0].charAt(0).toUpperCase();
      // Concatenate the first letter with the rest of the word
      capitalizedWords[0] = firstLetter + capitalizedWords[0].slice(1);


      // Join the words back together to form the modified string
      const capitalizedString = capitalizedWords.join(' ');

      return capitalizedString;
    }
    const getConditionsAndWareHouse = (items) => {
      const sks = items.map(i => i.sk)
      const list = sks.map(sk => {
        const splited = sk.split(';')
        return { condition: splited.shift().split(':')[1], wareHouse: splited.pop().split(':')[1], combination: splited }
      })
      const conditions = removeDuplicates(list.map(e => e.condition))
      const warehouses = removeDuplicates(list.map(e => e.wareHouse))
      const combinations = list.map(e => e.combination)
      return { conditions, warehouses, combinations }
    }

    const setAttAction = async (target_element, key, value) => {
      const payload2 = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element,
        key,
        value,

      }
      await pushAction(payload2)
    }
    const setTextAction = async (target_element, value) => {
      const el = {
        time: (new Date()).getTime(),
        action: 'textContent',
        target_element,
        value,

      }
      await pushAction(el)
    }
    const skuToHtml = async (sku) => {
      //const spec = document.getElementById('spec-status')
      //spec.textContent = 'üóÇÔ∏è Table spec üü†'
      const qitems = await fetch(`${backend_url}?id=sku:${sku}&sk=warehouse_price_qty:&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json()).then(({ items }) => items)
      const pitems = await fetch(`${backend_url}?id=sku:${sku}&sk=site_price:&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json()).then(({ items }) => items)
      if (qitems.length < 2) return
      const article = querySelectorAll1('.product_article')[0]
      const { conditions, warehouses, combinations } = getConditionsAndWareHouse(qitems)


      //price

      const p = article.querySelector('.price')
      let last1 = p.id + '-tree'
      for (let i = 0; i < pitems.length; i++) {
        const item = pitems[i]
        let id
        if (i !== 0) {
          id = duplicateId(p.id).id
          const actionObject = {
            time: (new Date()).getTime(),
            action: 'InsertAfter',
            target_element: last1,
            inserted_element: { originalId: p.id + '-tree', id },
          };
          await pushAction(actionObject)
          id = id.replace('-tree', '')
        }
        else {
          id = p.id
        }
        const p1 = getElementById1(id)
        const splited = item.sk.split(';')
        splited.shift()
        const condition = splited.shift()
        setAttAction(p1.id + '-tree', 'data-id', `${sku}:${condition}:${splited.join(';')}`)
        last1 = id + '-tree'
        if (item.oldPrice) {
          const dEl = p1.querySelector('.price_discount')
          const oEl = p1.querySelector('.price_old')
          const dV = dEl.querySelector('.price_value')
          const oV = oEl.querySelector('.price_value')
          await setTextAction(dV.id + '-tree', item.price?.toString() || 0)
          await setTextAction(oV.id + '-tree', item.priceOld?.toString() || 0)
        }
        else {
          const dEl = p1.querySelector('.price_normal')
          const nV = dEl.querySelector('.price_value')
          await setTextAction(nV.id + '-tree', item.price?.toString() || 0)
        }
      }

      const keyValues = {}
      for (const combination of combinations) {
        for (const el of combination) {
          const [key, value] = el.split(':')
          if (keyValues[key] && !keyValues[key].includes(value)) {
            keyValues[key].push(value)
          }
          if (!keyValues[key]) {
            keyValues[key] = [value]
          }
        }
      }
      if (conditions.length > 1) {

        keyValues.condition = conditions
      }
      await setAttAction(article.id + '-tree', 'data-product', `${sku};${warehouses.join(',')};${conditions.join(',')}`)
      const fieldset = article.querySelector('.product_attributes_fieldset')
      let last = fieldset.id + '-tree'
      const keys = Object.keys(keyValues)
      const legend = fieldset.querySelector('.product_attributes_legend')
      const input = fieldset.querySelector('.product_attribute_radio')
      const label = fieldset.querySelector('.product_attribute_label')
      const span = label.querySelector('.product_attribute_value')
      //first 
      await setTextAction(legend.id + '-tree', keys[0])
      const first = keyValues[keys[0]].shift()
      await setTextAction(span.id + '-tree', first)
      await setAttAction(label.id + '-tree', 'for', 'sku;' + keys[0] + ':' + first)
      await setAttAction(input.id + '-tree', 'data-id', 'sku;' + keys[0] + ':' + first)
      for (const value of keyValues[keys[0]]) {
        const dupLabelId = duplicateId(label.id).id
        const actionObject = {
          time: (new Date()).getTime(),
          action: 'Append',
          target_element: fieldset.id + '-tree',
          inserted_element: { originalId: label.id + '-tree', id: dupLabelId },
        };
        await pushAction(actionObject);
        const dupInputId = duplicateId(input.id).id
        const actionObject1 = {
          time: (new Date()).getTime(),
          action: 'Append',
          target_element: fieldset.id + '-tree',
          inserted_element: { originalId: input.id + '-tree', id: dupInputId },
        };
        await pushAction(actionObject1);
        await setAttAction(label.id + '-tree', 'for', 'sku;' + keys[0] + ':' + value)
        await setAttAction(dupInputId, 'data-id', 'sku;' + keys[0] + ':' + value)
        const labelEl = getElementById1(dupLabelId.replace('-tree', ''))
        const spanEl = labelEl.querySelector('.product_attribute_value')
        await setTextAction(spanEl.id + '-tree', value)
      }
      for (let i = 1; i < keys.length; i++) {
        const id = duplicateId(fieldset.id).id
        actionObject = {
          time: (new Date()).getTime(),
          action: 'InsertAfter',
          target_element: last,
          inserted_element: { originalId: fieldset.id + '-tree', id },
        };
        await pushAction(actionObject)
        last = id
        const fieldset = article.querySelector('#' + id.replace('-tree', ''))

        const legend = fieldset.querySelector('.product_attributes_legend')
        const input = fieldset.querySelector('.product_attribute_radio')
        const label = fieldset.querySelector('.product_attribute_label')
        const span = label.querySelector('.product_attribute_value')
        //first 
        await setTextAction(legend.id + '-tree', keys[i])
        const first = keyValues[keys[i]].shift()
        await setTextAction(span.id + '-tree', first)
        await setAttAction(label.id + '-tree', 'for', 'sku;' + keys[i] + ':' + first)
        if (key === 'condition') {
          const res = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=sku:${sku}&sk=${first}&startsWith=true`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          }).then(e => e.json())
          await setAttAction(input.id + '-tree', 'data-id', 'sku;' + keys[i] + ':' + res.items[0].value)
        }
        else {
          await setAttAction(input.id + '-tree', 'data-id', 'sku;' + keys[i] + ':' + first)
        }

        for (const value of keyValues[keys[i]]) {
          const dupLabelId = duplicateId(label.id).id
          const actionObject = {
            time: (new Date()).getTime(),
            action: 'Append',
            target_element: fieldset.id + '-tree',
            inserted_element: { originalId: label.id + '-tree', id: dupLabelId },
          };
          await pushAction(actionObject);
          const dupInputId = duplicateId(input.id).id
          const actionObject1 = {
            time: (new Date()).getTime(),
            action: 'Append',
            target_element: fieldset.id + '-tree',
            inserted_element: { originalId: input.id + '-tree', id: dupInputId },
          };
          await pushAction(actionObject1);
          await setAttAction(label.id + '-tree', 'for', 'sku;' + keys[i] + ':' + value)
          await setAttAction(dupInputId, 'data-id', 'sku;' + keys[i] + ':' + value)
          const labelEl = getElementById1(dupLabelId.replace('-tree', ''))
          const spanEl = labelEl.querySelector('.product_attribute_value')
          if (key === 'condition') {
            const res = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=sku:${sku}&sk=${value}&startsWith=true`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(e => e.json())
            await setAttAction(input.id + '-tree', 'data-id', 'sku;' + keys[i] + ':' + res.items[0].value)
          }
          else {
            await setTextAction(spanEl.id + '-tree', value)
          }

        }
      }



    }
    const skuToHtmlApi = async () => {
      //const spec = document.getElementById('spec-status')
      //spec.textContent = 'üóÇÔ∏è Table spec üü†'
      const tableLsi = pathItem.lsi1.split('|')[0] + '/Content/Main|Product-Content '
      url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${tableLsi}`;
      const { items } = await fetch(url).then(e => e.json())

      const eventData1 = { url: `https://webdev983.github.io/templatesv3/component.html?id=${items[0].id}&clean=1&ownerid=${localStorage.getItem('ownerid')}` };
      console.log('event ' + eventData1.url)
      // Fetch options
      const options0 = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(eventData1)
      };
      await fetch(pup_url, options0);


      const eventData = { url: `https://webdev983.github.io/templatesv3/component.html?id=${items[0].id}&generateHtmlFromSku=${pathItemSku}&ownerid=${localStorage.getItem('ownerid')}` };

      // Fetch options
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(eventData)
      };
      console.log(eventData.url)
      const response = await fetch(pup_url, options);

    }

    const generateTableSpecApi = async () => {
      //const spec = document.getElementById('spec-status')
      //spec.textContent = 'üóÇÔ∏è Table spec üü†'
      const tableLsi = pathItem.lsi1.split('|')[0] + '/Content/Main|Product-Specification-Table-Content'
      log1(tableLsi)
      url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${tableLsi}`;
      const { items } = await fetch(url).then(e => e.json())
      const specid = generateUUID()
      const data = getFromProductSpecs().filter(i => !i.value.includes('{'))
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);

      // Convert the date to ISO 8601 format (required by DynamoDB)
      const ttl = Math.floor(tomorrow.getTime() / 1000)
      const d = await fetch(`${backend_url}?id=${items[0].id}&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json())
      log1('all ' + JSON.stringify(d.items))
      const promises = d.items.map(async item => {
        if (item.action && item.action !== 'Add_Component') {
          const deleteUrl = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item.id}:${item.sk}`;
          log1('delete' + deleteUrl)
          await fetch(deleteUrl, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              // Add any additional headers if needed
            },
            // You can include a request body if necessary
            // body: JSON.stringify({ action: actionName }),
          });
        }
      })
      await Promise.all(promises)
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        body: JSON.stringify({ id: specid, sk: 'specs', data, ttl }),
      });
      const eventData = { url: `https://webdev983.github.io/templatesv3/component.html?id=${items[0].id}&generatespec=${specid}&ownerid=${localStorage.getItem('ownerid')}` };
      log1(eventData.url)
      // Fetch options
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(eventData)
      };
      const response = await fetch(pup_url, options);
      /*
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        body: JSON.stringify({ id: headContentItem.id, sk: 'generated-tablespec' }),
      });
      spec.textContent = 'üóÇÔ∏è Table spec üü¢'
      */
    }
    const generateTableSpec = async (specid) => {

      const { data } = await fetch(`${backend_url}/${specid}:specs`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json())
      const original = querySelectorAll1('[data-builder-specification-row]')[0]
      let last = original.id + '-tree'
      const th = original.querySelector('th')
      const td = original.querySelector('td')
      const el1 = {
        time: (new Date()).getTime(),
        action: 'textContent',
        target_element: th.id + '-tree',
        value: data[0].key.replaceAll('_', ' '),

      }
      await pushAction(el1)
      const el2 = {
        time: (new Date()).getTime(),
        action: 'textContent',
        target_element: td.id + '-tree',
        value: data[0].value,

      }
      await pushAction(el2)
      for (let i = 1; i < data.length; i++) {
        const id = duplicateId(original.id).id
        actionObject = {
          time: (new Date()).getTime(),
          action: 'InsertAfter',
          target_element: last,
          inserted_element: { originalId: original.id + '-tree', id },
        };
        await pushAction(actionObject)
        const clonedT = getElementById1(removeLastOccurrence(id, '-tree'))
        const th = clonedT.querySelector('th')
        const td = clonedT.querySelector('td')
        const el1 = {
          time: (new Date()).getTime(),
          action: 'textContent',
          target_element: th.id + '-tree',
          value: data[i].key.replaceAll('_', ' '),

        }
        await pushAction(el1)
        const el2 = {
          time: (new Date()).getTime(),
          action: 'textContent',
          target_element: td.id + '-tree',
          value: data[i].value,

        }
        await pushAction(el2)
        last = id
      }

    }
    const generateBreadCrumbApi = async () => {

      const tableLsi = pathItem.lsi1.split('|')[0] + '/Content/Page|BreadCrumb-Content'
      log1(tableLsi)
      url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${tableLsi}`;
      const { items } = await fetch(url).then(e => e.json())
      const eventData = { url: `https://webdev983.github.io/templatesv3/component.html?id=${items[0].id}&generatebreadcrumb=true&ownerid=${localStorage.getItem('ownerid')}` };

      // Fetch options
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(eventData)
      };
      console.log(eventData.url)
      const response = await fetch(pup_url, options);
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        body: JSON.stringify({ id: headContentItem.id, sk: 'generated-breadcrumb' }),
      });

    }
    const refreshCatalogue = async () => {
      if (!pathItemPath.endsWith('/Home/Hub')) {
        alert('not home  page')
        return
      }
      const { catalogue_component, article_page } = pathItem.hub_items
      const cid = document.getElementById(catalogue_component + '-tree').getAttribute('cid')
      const splited = article_page.split('*')
      const sLsi = pathItemPath.split('/')[0] + splited[1]
      const url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${sLsi}`;
      const { items } = await fetch(url).then(e => e.json())
      const filtered = items.filter(element => element.lsi1.endsWith(splited[2]))

      const arr = filtered.map(element => {
        const newId = generateUUID()
        return {

          componentId: element.id, id: generateUUID(), path: element.lsi1.split(';')[0]
        }
      })
      //load actions
      const res = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${cid}&startsWith=true`).then(re => re.json())
      const replace = res.items.find(e => e.action === 'Replace_Component')
      let { target_element } = replace
      const target = target_element[0]
      target_element = [target, ...arr]
      replace.target_element = target_element
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        body: JSON.stringify(replace),
      });

    }
    const generateAnchorApi = async () => {
      const absolutes = pathItem.hub_items.anchor.map(e => getAbsolutePath(pathItemPath, e))
      const { pLink } = getLinks()
      const promise = absolutes.map(async absolute => {
        url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${absolute}`;
        const { items } = await fetch(url).then(e => e.json())

        const eventData = { url: `https://webdev983.github.io/templatesv3/component.html?id=${items[0].id}&generateanchor=${encodeURIComponent(pLink)}&ownerid=${localStorage.getItem('ownerid')}` };

        // Fetch options
        const options = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(eventData)
        };
        console.log(eventData.url)
        const response = await fetch(pup_url, options);
      })
      await Promise.all(promise)

    }
    var generateBreadCrumb = async (event) => {
      let arr = pathItemPath.split(';')[0].split('/')
      const site = arr[0]
      arr.shift()

      const index = arr.indexOf('Content');
      if (index !== -1) {
        arr.splice(index);
      }
      const index2 = arr.indexOf('Home');
      if (index2 !== -1) {
        arr.splice(index2, 1);
      }
      const active = arr.pop()
      log1('active is ' + active)
      const breadCA = querySelectorAll1('[data-builder-breadcrumb-active]')
      const breadC = querySelectorAll1('[data-builder-breadCrumb]')
      const a = breadC[0].querySelector('[data-builder-breadCrumb-value]')



      const el2 = {
        time: (new Date()).getTime(),
        action: 'setAttribute',
        target_element: a.id + '-tree',
        key: 'href',
        value: 'https://{site}/',

      }
      await pushAction(el2)

      if (active) {
        const a = breadCA[0].querySelector('[data-builder-breadCrumb-value]')
        const el = {
          time: (new Date()).getTime(),
          action: 'textContent',
          target_element: a.id + '-tree',
          value: capitalizeAndReplaceHyphens(active),

        }

        await pushAction(el)
      }
      else {
        const el =
        {
          time: (new Date()).getTime(),
          action: 'removeTag',
          target_element: breadCA[0].id + '-tree',

        }
        pushAction(el)
      }

      let last = breadC[0].id + '-tree'

      for (let i = 0; i < arr.length; i++) {
        const id = duplicateId(breadC[0].id).id
        actionObject = {
          time: (new Date()).getTime(),
          action: 'InsertAfter',
          target_element: last,
          inserted_element: { originalId: breadC[0].id + '-tree', id },
        };
        await pushAction(actionObject)
        last = id
        const a = getElementById1(removeLastOccurrence(id, '-tree')).querySelector('[data-builder-breadCrumb-value]')

        let link = 'https://{site}/'
        const el = {
          time: (new Date()).getTime(),
          action: 'textContent',
          target_element: a.id + '-tree',
          value: capitalizeAndReplaceHyphens(arr[i]),

        }
        await pushAction(el)
        for (let j = 0; j <= i; j++) {
          link = link + arr[j].toLowerCase() + '/'
        }

        const el2 = {
          time: (new Date()).getTime(),
          action: 'setAttribute',
          target_element: a.id + '-tree',
          key: 'href',
          value: link,

        }
        await pushAction(el2)

      }
      const schema = querySelectorAll1('script[data-transfer-receiver="schema-breadcrumb"]')[0]
      log1(schema.textContent)
      let json = JSON.parse(schema.textContent)


      json.itemListElement[0].item["@id"] = 'https://' + site.toLowerCase()
      let link1 = 'https://{site}/';
      active && arr.push(active)
      for (let i = 0; i < arr.length; i++) {
        const newEl = deepCopy(json.itemListElement[0])
        link1 = link1 + arr[i] + '/'
        newEl.item["@id"] = link1.toLowerCase()
        newEl.item.name = capitalizeAndReplaceHyphens(arr[i].toLowerCase())
        newEl.position = i + 2
        json.itemListElement.push(newEl)
      }
      log1('newJSON' + json)
      const el = {
        time: (new Date()).getTime(),
        action: 'innerHtml',
        target_element: schema.id + '-tree',
        insertedCode: JSON.stringify(json, null, 2),

      }
      await pushAction(el)
    }
    const switchSelected = (event) => {
      const activated = event.target.classList.contains('b-selected')
      if (activated) {
        event.target.classList.remove('b-selected')
      }
      else {
        event.target.classList.add('b-selected')
      }
    }
    //toggle menu button scripts
    const removeDuplicatedActions = (event) => {
      const groupedItems = actions.reduce((acc, item) => {
        if (!acc[item.target_element]) {
          acc[item.target_element] = [];
        }
        acc[item.target_element].push(item);
        return acc;
      }, {});

      // Convert the grouped object to an array of arrays
      const listOfLists = Object.values(groupedItems);
      log1(JSON.stringify(listOfLists))
      listOfLists.map(list => {
        const innerHtmlActions = list.filter(e => e.action === 'innerHtml')
        const textActions = list.filter(e => e.action === 'textContent')
        const setAttributeActions = list.filter(e => e.action === 'setAttribute')
        const commentActions = list.filter(e => e.action === 'Add_Comment')
      })
    }
    const removeActions = async (event) => {
      const filteredActions = actions.filter(action => action.action !== 'Add_Component')
      const ps = filteredActions.map(
        action =>
          fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${action.id}:${action.sk}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              // Add any additional headers if needed
            },
          })
      );

      await Promise.all(ps)
      location.reload()
    }
    const toggleGeneratedPage = () => {
      const s = localStorage.getItem('generatedPageToggle')
      if (!s) {

        getElementById1("sku-list").removeAttribute('hidden')
        getElementById1('generated-page-iframe').removeAttribute('hidden')
        getElementById1('generated-page-menu').removeAttribute('hidden')
        getElementById1('toggle-generated-page').classList.add('b-selected')
        localStorage.setItem('generatedPageToggle', 'true')
      }
      else {
        getElementById1("sku-list").setAttribute('hidden', '')
        getElementById1('generated-page-iframe').setAttribute('hidden', '')
        getElementById1('generated-page-menu').setAttribute('hidden', '')
        getElementById1('toggle-generated-page').classList.remove('b-selected')
        localStorage.removeItem('generatedPageToggle')
      }
    }
    const generateDependeeMenu = (node) => {
      const sku = node.querySelector('#sku-value').textContent
      log1(sku)
      const item = getElementById1('dependee-menu-item')
      const dependeeMenu = node.querySelector('#dependee-menu')
      const forms = querySelectorAll1('[data-product-attribute-form]');
      const dependees = querySelectorAll1('[data-builder-dependee]');
      const selects = []
      for (let i = 0; i < forms.length; i++) {
        const form = forms[i]
        selects.push(form.querySelector('[data-product-attribute-legend]'))
      }
      const dependees1 = removeDuplicates(Array.from(dependees).map(el => el.getAttribute('data-builder-dependee')))
      dependeeMenu.innerHTML = ''
      const checkbox = getElementById1('checkbox-label')
      for (const dependee of dependees1) {
        log1('in')
        const cloned = item.cloneNode(true)
        cloned.removeAttribute('hidden')
        cloned.querySelector('[data-type="dependee-value"]').textContent = dependee

        for (const select of selects) {
          const clonedCheckbox = checkbox.cloneNode(true)
          clonedCheckbox.removeAttribute('hidden')
          clonedCheckbox.setAttribute('formId', select.parentNode.id)
          clonedCheckbox.innerHTML = clonedCheckbox.innerHTML.replace('Color', select.textContent)
          cloned.insertBefore(clonedCheckbox, cloned.children[cloned.children.length - 1])
        }
        dependeeMenu.appendChild(cloned)

      }
    }
    var getChecked = (resultList) => {
      const checked1 = []
      for (const el1 of resultList) {
        const selected = el1.form.querySelectorAll('[type="radio"]').forEach(el => {
          if (el.checked) {
            const selectedValue = el.parentNode.querySelector('[data-product-attribute-value]').textContent
            checked1.push(el1.legend + ':' + selectedValue)
          }
        })


      }
      return checked1
    }
    const generateDependees = async (event) => {
      const parentFieldSet = event.target.closest('fieldset')
      const checkboxes = parentFieldSet.querySelectorAll('[data-type="dependant"')
      const skuValue = parentFieldSet.parentNode.parentNode.querySelector('#sku-value').textContent
      const resultList = []
      for (const item of checkboxes) {
        const checkbox = item.firstChild
        if (checkbox.checked) {
          log1('checkbox ' + checkbox.id)
          const formId = item.getAttribute('formId')
          const form = getElementById1(formId)
          const legendElement = form.querySelector('[data-product-attribute-legend]');
          const legend = legendElement && legendElement.textContent;

          const attributeElements = form.querySelectorAll('[data-product-attribute]');
          const attributes = Array.from(attributeElements).map(element => element.textContent);

          resultList.push({
            form,
            legend: legend,
            items: attributes
          });
        }

      }
      const combinations = generateCombinations(resultList)
      log1(JSON.stringify(combinations))
      const dependencyName = parentFieldSet.querySelector('[data-type="dependee-value"]').textContent
      let dependeeItems = querySelectorAll1(`[data-builder-dependee="${dependencyName}"]`)
      const allIds = Array.from(dependeeItems).map(e => e.id)
      const ids = []
      const toRemove = []
      for (const id of allIds) {
        if (id.endsWith('-tree')) {
          continue
        }
        const splited = id.split(':')
        if (!ids.find(el => el.startsWith(splited[0] + ':'))) {
          ids.push(id)

        }
        else {
          toRemove.push(id)
        }
      }
      log1('tr555 ' + JSON.stringify(toRemove))
      log1('tr555 ' + JSON.stringify(ids))
      for (const id of toRemove) {
        await pushAction({
          time: (new Date()).getTime(),
          action: 'removeTag',
          target_element: id + '-tree',
        })
      }
      for (const id of ids) {
        for (let i = 0; i < combinations.length; i++) {
          let currentId = id + '-tree'

          if (i !== 0) {
            const res = duplicateId(id)
            let actionObject = {
              time: (new Date()).getTime(),
              action: 'InsertBefore',
              target_element: id + '-tree',
              inserted_element: { originalId: id + '-tree', id: res.id },
            };
            await pushAction(actionObject)
            currentId = res.id
          }
          const el = {
            time: (new Date()).getTime(),
            action: 'setAttribute',
            target_element: currentId,
            key: 'data-product-info',
            value: `${skuValue};${combinations[i]}`,

          }
          await pushAction(el)

        }
      }
      //get selected combination
      const checked1 = getChecked(resultList)
      log1(JSON.stringify(checked1))
      dependeeItems = querySelectorAll1(`[data-builder-dependee="${dependencyName}"]`)
      for (const item of dependeeItems) {
        const attr = item.getAttribute('data-product-info')
        const splited = attr.split(';')
        splited.shift()
        const f = splited.find(el => !checked1.includes(el))
        if (f) {
          item.style.display = 'none'
        }
        else {
          item.style.display = 'block'
        }
      }
      handleDependency()

    }
    const toggleDependencyMenu1 = (event) => {
      const menus = event.target.parentNode.querySelectorAll('#dependee-menu')

      const button = event.target
      if (!button.classList.contains('b-selected')) {
        log1('setting');

        // Set the item in local storage


        // Remove the 'hidden' attribute to show the menu
        menus.forEach(menu => menu.removeAttribute('hidden'))

        // Add the class 'b-selected' to the toggle button
        button.classList.add('b-selected');
        generateDependeeMenu(event.target.parentNode)
      } else {
        // If the item is set in local storage

        // Remove the item from local storage


        // Remove the class 'b-selected' from the toggle button
        button.classList.remove('b-selected');

        // Set the 'hidden' attribute to hide the menu
        menus.forEach(menu => menu.setAttribute('hidden', ''))
      }
    }
    const toggleSkuAttributeList = (event) => {
      const el = event.target
      const list = el.parentNode.querySelector('#sku-attribute-list')
      if (el.classList.contains('b-selected')) {
        el.classList.remove('b-selected')
        list.setAttribute('hidden', 'true')
      }
      else {
        el.classList.add('b-selected')

        list.removeAttribute('hidden')
      }
    }
    const toggleHead = () => {
      const s = localStorage.getItem('headToggle')
      if (!s) {

        getElementById1('head-1').removeAttribute('hidden')
        getElementById1('head-menu').removeAttribute('hidden', '')
        getElementById1('toggle-head').classList.add('b-selected')
        localStorage.setItem('headToggle', 'true')
      }
      else {
        getElementById1('head-1').setAttribute('hidden', '')
        getElementById1('head-menu').setAttribute('hidden', '')
        getElementById1('toggle-head').classList.remove('b-selected')
        localStorage.removeItem('headToggle')
      }
    }
    const toggleCodeTree = () => {
      const s = localStorage.getItem('codeTreeToggle')
      if (!s) {

        getElementById1('code-tree').removeAttribute('hidden')
        getElementById1('code-tree-menu').removeAttribute('hidden', '')
        getElementById1('toggle-code-tree').classList.add('b-selected')
        localStorage.setItem('codeTreeToggle', 'true')
      }
      else {
        getElementById1('code-tree').setAttribute('hidden', '')
        getElementById1('code-tree-menu').setAttribute('hidden', '')
        getElementById1('toggle-code-tree').classList.remove('b-selected')
        localStorage.removeItem('codeTreeToggle')
      }
    }
    const toggleExecution = (e) => {
      const s = localStorage.getItem('executionToggle')
      if (!s) {


        e.target.classList.add('b-selected')

        localStorage.setItem('executionToggle', 'true')
      }
      else {

        e.target.classList.remove('b-selected')
        localStorage.removeItem('executionToggle')
      }
    }
    const toggleComponentTree = () => {
      const s = localStorage.getItem('componentTreeToggle')
      if (!s) {

        getElementById1('components-tree').removeAttribute('hidden')
        getElementById1('components-tree-menu').removeAttribute('hidden', '')
        getElementById1('toggle-component-tree').classList.add('b-selected')

        localStorage.setItem('componentTreeToggle', 'true')
      }
      else {
        getElementById1('components-tree').setAttribute('hidden', '')
        getElementById1('components-tree-menu').setAttribute('hidden', '')
        getElementById1('toggle-component-tree').classList.remove('b-selected')
        localStorage.removeItem('componentTreeToggle')
      }
    }
    document.addEventListener('DOMContentLoaded', function () {
      const iframe = document.getElementById("generated-page-iframe");

      // Function to execute when the iframe and DOM content are loaded
      function handleContentLoaded() {
        const s1 = localStorage.getItem('codeTreeToggle');
        if (s1) {
          getElementById1('toggle-code-tree').classList.add('b-selected');
        } else {
          getElementById1('code-tree-menu').setAttribute('hidden', '');
          getElementById1('code-tree').setAttribute('hidden', '');
        }
        const s2 = localStorage.getItem('componentTreeToggle');
        if (s2) {
          getElementById1('toggle-component-tree').classList.add('b-selected');
        } else {
          getElementById1('components-tree').setAttribute('hidden', '');
          getElementById1('components-tree-menu').setAttribute('hidden', '');
        }
        const s3 = localStorage.getItem('headToggle');
        if (s3) {
          getElementById1('toggle-head').classList.add('b-selected');
        } else {
          getElementById1('head-menu').setAttribute('hidden', '');
          getElementById1('head-1').setAttribute('hidden', '');
        }
        const s4 = localStorage.getItem('generatedPageToggle');
        if (s4) {
          getElementById1('toggle-generated-page').classList.add('b-selected');
        } else {
          getElementById1('generated-page-menu').setAttribute('hidden', '');
          getElementById1('generated-page-iframe').setAttribute('hidden', '');
        }
        const s5 = localStorage.getItem('executionToggle');
        if (s5) {
          getElementById1('execute-commands').classList.add('b-selected');
        }
      }

      // Check if the iframe is already loaded
      if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
        // If the iframe is already loaded, execute the function immediately
        handleContentLoaded();
      } else {
        // If the iframe is not yet loaded, wait for the load event
        iframe.onload = function () {
          // Execute the function when the iframe is loaded
          handleContentLoaded();
        };
      }
    });

  </script>
  <script>
    function sendGptRequest(token, prompt, model) {


      const data = {
        model: model || 'gpt-4',
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.7
      };

      return fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .catch(error => console.error('Error:', error));
    }
  </script>
  <script>
    var backend_url = 'https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2'
    var pathItem
    var pathItemPath
    var positionItem
    var site1
    var pathItemSku
    var headContentItem
    var selectedSku
    var dependencyItem
    var skuCreated
    var ownerid
    var republish
    var imagesIds = []
    var actions = []
    var replaceIds = []
    var lastCompPath
    var reload
    loadFirst()
    var getAbsolutePath = (currentPath, relativePath) => {
      // Split current path and relative path into arrays of directories and filename
      const currentPathParts = currentPath.split('/');
      const relativePathParts = relativePath.split('/');

      // Extract filename from the relative path
      const relativeFilename = relativePathParts.pop();
      currentPathParts.pop()

      // Handle "./" in relative path
      if (relativePathParts[0] === '.') {
        relativePathParts.shift(); // Remove the first element (".")
      }
      // Handle "../" in relative path
      while (relativePathParts[0] === '..') {
        currentPathParts.pop(); // Remove the last element from the current path
        relativePathParts.shift(); // Remove the first element ("..")
      }


      // Combine current path and relative path parts
      const combinedPath = currentPathParts.concat(relativePathParts).join('/');

      // Append the relative filename
      const absolutePath = combinedPath + '|' + relativeFilename;

      return absolutePath;
    }
    var replacePlaceHolders = (html) => {
      const iframe = document.getElementById("generated-page-iframe");

      // Access the content of the iframe
      const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
      const all = document.querySelectorAll('[data-list]:not([hidden])')
      const checked = {}
      for (const el of all) {
        const rows = el.querySelectorAll('[data-lists-element]')
        for (const row of rows) {
          const key = row.querySelector('[data-lists-element-key]').textContent
          const value = row.querySelector('[data-list-element-selection]')?.value || row.querySelector('[data-lists-element-value]').textContent || ''

          html ? (html = html.replaceAll('{' + key + '}', value)) : iframeDocument.documentElement.innerHTML = iframeDocument.documentElement.innerHTML.replaceAll('{' + key + '}', value)
          const checkboxs = row.querySelectorAll('[data-list-element-benefit]')
          for (const checkbox of checkboxs) {
            if (checkbox.checked) {
              const name = checkbox.getAttribute('varname').replace('varlist_', '')
              if (checked[name]) {
                checked[name].push(key + ': ' + value)
              }
              else {
                checked[name] = [key + ': ' + value]
              }
            }
          }
        }
      }
      for (const key of Object.keys(checked)) {
        if (html) {
          html = html.replaceAll('{' + key + '}', checked[key].join(','))
        }
        else {
          iframeDocument.documentElement.innerHTML = iframeDocument.documentElement.innerHTML.replaceAll('{' + key + '}', checked[key].join(','))
        }

      }
      return html
    }
    var cache = {};

    var getRes = async (id, main, firstLoad) => {
      // Check if the response is already in the cache

      if (cache[id]) {
        return deepCopy(cache[id])
      }
      !firstLoad && (updateComponentsMap = true)

      try {
        // Make a GET request to the API with the 'id' query parameter
        const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${id}&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        // Ensure the request was successful (status code 2xx)
        if (!response.ok) {
          throw new Error(`Failed to load data from the database. Status: ${response.status}`);
        }

        // Parse and log the response or handle it as needed
        const responseData = await response.json();

        // Store the response in the cache for future use
        !main && (cache[id] = deepCopy(responseData));

        return responseData;
      } catch (error) {
        console.error(`Error fetching data for id: ${id}`, error);
        throw error; // Re-throw the error to let the caller handle it
      }
    };
    //document.addEventListener('DOMContentLoaded', loadFirst);
    var saveGpt = async (event) => {
      const { value } = event.target.parentNode.querySelector('#gpt-input')
      if (!pathItem.hub_items) {
        pathItem.hub_items = {}
      }
      pathItem.hub_items.gpt = value
      fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        body: JSON.stringify(pathItem),
      });
      event.target.parentNode.removeAttribute('open')
      await showai(value)
    }
    var saveList = async (event) => {
      const { value } = event.target.parentNode.querySelector('#list-input')
      if (!pathItem.hub_items) {
        pathItem.hub_items = {}
      }
      pathItem.hub_items.list = value
      fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        body: JSON.stringify(pathItem),
      });
      event.target.parentNode.removeAttribute('open')
      showListMenus(value)
      //await showList(value)
    }

    var showListMenus = (lists, storageId1, hubItems) => {
      let parsedLists
      try {
        parsedLists = JSON.parse(lists)
      }
      catch (e) {
        const input = document.getElementById('list-input')
        input.value = 'INCORRECT LIST JSON \n============================\n' + input.value
        return
      }
      const list2 = document.querySelector('#list_menu_toggle[hidden]')

      for (const list of parsedLists['data-lists']) {
        const id = list.name
        const cloned2 = list2.cloneNode(true)
        cloned2.setAttribute('data-list-menu', list.name)
        cloned2.id = list.name
        log1('list ' + list.name)
        cloned2.querySelector('#list-name').textContent = list.name
        cloned2.removeAttribute('hidden')
        list2.parentNode.append(cloned2)
        const status = cloned2.querySelector('#menu_toggle_status')
        if (pathItem.hub_items?.menus?.[id]) {

          status.textContent = 'üü¢'
        }
        status.onclick = async () => {
          pathItem.hub_items.menus[id] = pathItem.hub_items.menus[id] ? false : new Date().getTime()

          const listName = list.name
          /*
          if (listName) {
            const listItem = document.getElementById(listName)
            pathItem.hub_items[id] ? listItem.removeAttribute('hidden') : listItem.setAttribute('hidden')
          }*/
          await updatePathItem()
          if (pathItem.hub_items.menus[id]) {
            showList(JSON.stringify({ "data-lists": [list] }), storageId1, hubItems)
            status.textContent = 'üü¢'

          }
          else {
            status.textContent = 'üî¥'
            document.querySelector(`[data-list="${listName}"]`).remove()
          }
        }
      }
    }
    var saveToList = async (event) => {
      const target = event.target
      const input1 = target.parentNode.querySelector('#import-list-input').value
      console.log('input ' + input1)
      const details = target.closest('[data-list]')
      const listName = details.getAttribute('data-list')
      const storageId = details.getAttribute('storageId')
      const splited = input1.split('\n')
      const listOriginalElement = details.querySelector('[data-lists-element]')
      for (const input of splited) {
        const [key, value] = input.trim().split(':')
        const storageSk = `list:${listName}:${key}`
        const v = {
          id: storageId,
          sk: storageSk,
          value
        }
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          body: JSON.stringify(v),
        });
        console.log(JSON.stringify(v))

        const clonedListElement = listOriginalElement.cloneNode(true)
        clonedListElement.querySelector('[data-lists-element-key]').textContent = key
        const span = clonedListElement.querySelector('[data-lists-element-value]')
        span.textContent = `{${key.replaceAll('_', ' ')}}`
        const statusEl = clonedListElement.querySelector('[data-lists-element-status]')
        statusEl.textContent = 'üü¢'
        span.textContent = value
        span.addEventListener('blur', handleSave);
        span.addEventListener('keydown', function (event) {
          if (event.key === 'Enter') {
            event.preventDefault(); // Prevent default behavior of Enter key (like new line)
            handleSave(); // Call handleSave function
          }
        });

        // Function to handle save logic
        async function handleSave() {
          const value = span.textContent.trim(); // Trim whitespace

          if (value === '{' + key + '}') {
            return; // Return early if value matches specific condition
          } else if (value === '') {
            fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${v.id}:${v.sk}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
                // Add any additional headers if needed
              },
            });
            clonedListElement.remove(); // Remove clonedListElement if value is empty
            return;
          }

          const exisitingValue = {
            ...v,
            value
          };

          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            body: JSON.stringify(exisitingValue),
          });

          // Add any additional logic after save, if needed
        }
        listOriginalElement.parentNode.append(clonedListElement)
        target.closest('details').removeAttribute('open')
        target.parentNode.querySelector('#import-list-input').value = ''
      }
    }
    var showList = async (lists, storageId1, hubItems) => {
      let parsedLists
      try {
        parsedLists = JSON.parse(lists)
      }
      catch (e) {
        const input = document.getElementById('list-input')
        input.value = 'INCORRECT LIST JSON \n============================\n' + input.value
        return
      }

      const list1 = document.querySelector('[data-list][hidden]')

      !storageId1 && document.querySelectorAll('[data-list]:not([hidden])').forEach(e => e.remove())

      for (const list of parsedLists['data-lists']) {
        if (!hubItems || !hubItems.menus[list.name]) {
          continue
        }
        const cloned = list1.cloneNode(true)


        cloned.setAttribute('data-list', list.name)

        cloned.setAttribute('data-list', list.name)



        cloned.removeAttribute('hidden')




        const storage = list.data_storage
        let storageId = storageId1 ?? ((storage === 'sku') ? (pathItemSku || selectedSku) : headContentItem.id)
        cloned.setAttribute('storageId', storageId)
        cloned.querySelector('[data-list-emoji]').textContent = list.emoji
        cloned.querySelector('[data-list-name]').textContent = list.name
        const listOriginalElement = cloned.querySelector('[data-lists-element]')
        const label = cloned.querySelector('[data-list-element-benefit-label]')
        const keys = Object.keys(list)
        const filteredKeys = keys.filter(e => e.startsWith('varlist_'))
        if (!filteredKeys.length) {
          label.remove()

        }
        else {
          const first = filteredKeys[0].replace('varlist_', '')
          label.innerHTML = label.innerHTML.replace('Benefit', first)
          label.parentNode.querySelector('input').setAttribute('varname', filteredKeys[0])
          for (let i = 1; i < filteredKeys.length; i++) {
            const originalTd = label.parentNode
            const cloned = originalTd.cloneNode(true)
            const clonedLabel = cloned.querySelector('[data-list-element-benefit-label]')
            const clonedInput = cloned.querySelector('input')
            clonedInput.setAttribute('varname', filteredKeys[i])
            clonedLabel.innerHTML = clonedLabel.innerHTML.replace(first, filteredKeys[i].replace('varlist_', ''))
            originalTd.parentNode.append(cloned)

          }
        }
        //fetch all sks
        let listValues = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${storageId}&sk=list:&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(el => el.json()).then(e => e.items)

        for (const option of list.options) {
          const clonedListElement = listOriginalElement.cloneNode(true)
          listOriginalElement.parentNode.append(clonedListElement)
          const storageSk = `list:${list.name}:${option.name}`


          let exisitingValue = listValues.find(e => e.sk === storageSk)
          listValues = listValues.filter(e => e.sk !== storageSk)
          const statusEl = clonedListElement.querySelector('[data-lists-element-status]')
          log1('existing ' + JSON.stringify(exisitingValue))
          if (exisitingValue) {
            exisitingValue.id = storageId
            statusEl.textContent = 'üü¢'
          }
          else {
            exisitingValue = {
              id: storageId,
              sk: storageSk,
            }
          }
          clonedListElement.querySelector('[data-lists-element-key]').textContent = option.name
          const span = clonedListElement.querySelector('[data-lists-element-value]')
          span.textContent = `{${option.name.replaceAll('_', ' ')}}`

          const select = clonedListElement.querySelector('[data-list-element-selection]')
          span.addEventListener('blur', handleSave);
          span.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
              event.preventDefault();
              handleSave();
            }
          });

          async function handleSave() {
            const value = span.textContent.trim(); // Trim whitespace

            if (value === '{' + option.name + '}') {
              return;
            } else if (value === '') {
              fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${exisitingValue.id}:${exisitingValue.sk}`, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  // Add any additional headers if needed
                },
              });
              return;
            }

            exisitingValue = {
              ...exisitingValue,
              value
            };

            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              body: JSON.stringify(exisitingValue),
            });

            select.value = "none"; // Reset select element, assuming `select` is defined somewhere
            statusEl.textContent = 'üü¢'; // Update status element
          }
          if (option.transfer) {
            span.setAttribute('data-transfer-sender', option.transfer)
          }

          if (option.values) {
            const originalValue = clonedListElement.querySelector('[data-list-element-selection-value]')
            for (const value of option.values) {
              const clonedValue = originalValue.cloneNode(true)
              clonedValue.textContent = value
              clonedValue.value = value
              originalValue.parentNode.append(clonedValue)
            }
            exisitingValue.value && (select.value = exisitingValue.value)
            select.addEventListener('change', async function () {
              log1('select ' + select.value)
              log1('option ' + '{' + option.name + '}')
              if (select.value === '{' + option.name + '}' || select.value === '') {
                return
              }
              exisitingValue = {
                ...exisitingValue,
                value: select.value
              }
              await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                body: JSON.stringify(exisitingValue),
              });
              span.textContent = `{${option.name.replaceAll('_', ' ')}}`
              statusEl.textContent = 'üü¢'

            });
            originalValue.remove()
          }
          else {
            exisitingValue.value && (span.textContent = exisitingValue.value)
            select.remove()
          }
          if (filteredKeys.length) {
            const inputs = clonedListElement.querySelectorAll('[data-list-element-benefit]')
            for (const input of inputs) {
              const varname = input.getAttribute('varname')
              if (exisitingValue[varname]) {

                input.checked = true
              }
              //exisitingValue.varlist===true ? (input.checked = true) : (input.checked = !!option.varlist)
              input.addEventListener('change', async function () {
                if (input.checked) {
                  exisitingValue = {
                    ...exisitingValue,
                    [varname]: true,
                  }
                }
                else {
                  delete exisitingValue[varname]
                }

                log1(JSON.stringify(exisitingValue))
                await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                  method: 'POST',
                  body: JSON.stringify(exisitingValue),
                });
                statusEl.textContent = 'üü¢'

              });
            }

          }


        }
        for (const el of listValues) {
          const clonedListElement = listOriginalElement.cloneNode(true)
          const storageSk = listValues.sk


          let exisitingValue = el
          const statusEl = clonedListElement.querySelector('[data-lists-element-status]')
          log1('existing ' + JSON.stringify(exisitingValue))

          statusEl.textContent = 'üü¢'


          clonedListElement.querySelector('[data-lists-element-key]').textContent = exisitingValue.sk.split(':')[2]
          const span = clonedListElement.querySelector('[data-lists-element-value]')
          span.textContent = `{${exisitingValue.sk.split(':')[2].replaceAll('_', ' ')}}`

          const select = clonedListElement.querySelector('[data-list-element-selection]')
          span.addEventListener('blur', handleSave);
          span.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
              event.preventDefault();
              handleSave();
            }
          });

          async function handleSave() {
            const value = span.textContent.trim(); // Trim whitespace

            if (value === '{' + exisitingValue.sk.split(':')[2] + '}') {
              return;
            } else if (value === '') {
              fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${exisitingValue.id}:${exisitingValue.sk}`, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  // Add any additional headers if needed
                },
              });
              clonedListElement.remove();
              return;
            }

            exisitingValue = {
              ...exisitingValue,
              value
            };

            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              body: JSON.stringify(exisitingValue),
            });

            statusEl.textContent = 'üü¢';
          }



          exisitingValue.value && (span.textContent = exisitingValue.value)

          select.remove()
          if (filteredKeys.length) {
            const inputs = clonedListElement.querySelectorAll('[data-list-element-benefit]')
            for (const input of inputs) {
              const varname = input.getAttribute('varname')
              if (exisitingValue[varname]) {

                input.checked = true
              }
              else {
                input.checked = false
              }
              //exisitingValue.varlist===true ? (input.checked = true) : (input.checked = !!option.varlist)
              input.addEventListener('change', async function () {
                if (input.checked) {
                  exisitingValue = {
                    ...exisitingValue,
                    [varname]: true,
                  }
                }
                else {
                  delete exisitingValue[varname]
                }

                log1(JSON.stringify(exisitingValue))
                await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                  method: 'POST',
                  body: JSON.stringify(exisitingValue),
                });
                statusEl.textContent = 'üü¢'

              });
            }

          }
          listOriginalElement.parentNode.append(clonedListElement)

        }

        listOriginalElement.remove()
        list1.parentNode.append(cloned)
      }

    }
    const getReplacementValue = (name) => {
      const res1 = querySelectorAll1(`[data-builder-varlist="${name}"]`)
      const res2 = querySelectorAll1(`[data-builder-variable="${name}"]`)
      let res = ''
      res1.forEach(el => res = res + el.textContent + ' ')
      res2.forEach(el => res = res + el.textContent + ' ')
      return res
    }
    const replaceVars = (string) => {
      const regex = /{([^}]+)}/g;

      // Use match() to find all placeholders
      const matches = string.match(regex);

      // Replace each placeholder with its corresponding value
      if (matches) {
        matches.forEach(match => {
          const placeholder = match.substring(1, match.length - 1); // Remove {}
          const replacement = getReplacementValue(placeholder); // Replace this with your replacement logic
          string = string.replace(match, replacement);
        });
      }
      return string
    }
    const pup_url = 'https://b3dutg6xlx4zfz52xgrf4staza0dgeff.lambda-url.us-east-1.on.aws/';
    var showai = async (list) => {
      const sk = 'chatgpt_token'
      const item = await fetch(`${backend_url}/${ownerid}:${sk}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json())
      const gptToken = item.token
      let parsed
      try {
        parsed = JSON.parse(list);
      }
      catch (e) {
        log1('wrong json')
        return
      }
      /*
      const ai = document.querySelector('[data-ai]');
      ai.removeAttribute('hidden');
      const originalRow = ai.querySelector('[data-ai-row]');
      */
      const originalRow = document.querySelector('#script_chatgpt_');
      for (const element of parsed['chatgpt-tasks']) {
        const cloned = originalRow.cloneNode(true);
        cloned.id = element.name
        cloned.querySelector('#gpt-name').textContent = element.name;


        const runF = async () => {
          if (status.textContent === 'üü†') { return }
          let task = element.task
          status.textContent = 'üü†'
          task = replacePlaceHolders(task)
          task = replaceVars(task)
          log1('chat gpt task: \n' + task)
          const res = await sendGptRequest(gptToken, task, element.model)
          log1(JSON.stringify(res))
          const content = JSON.parse(res.choices[0].message.content.replace(/\\"/g, '"').replace(/\\n/g, '\\n'))
          log1('content ' + JSON.stringify(content))
          const currentDate = new Date();

          // Add one day to the current date
          const tomorrow = new Date();
          tomorrow.setDate(currentDate.getDate() + 1);

          // Convert the date to ISO 8601 format (required by DynamoDB)
          const ttl = Math.floor(tomorrow.getTime() / 1000);
          const aiPayload = {
            id: pathItem.id,
            sk: `ai-logs:${new Date().getTime()}`,
            task,
            content,
            gptResponse: res,
            ttl
          }
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(aiPayload),
          });

          const element0 = document.getElementById('ai-logs')
          //element0.removeAttribute('hidden')
          element0.querySelector('textarea').value = [element0.querySelector('textarea').value, JSON.stringify(res, null, 2) + JSON.stringify(task) + '\n\n' + JSON.stringify(content)].join('\n\n=============================================\n\n')
          for (const toImport of element.import_data) {
            const { import_page, import_name } = toImport

            const compid = document.querySelector(`[name="${import_page}"]`).parentNode.getAttribute('cid')
            const data = content[import_name]

            //clean
            let f = pathItem.hub_items?.import_items && pathItem.hub_items?.import_items.find(e => e.name === import_name && e.component === import_page)
            if (!f) {
              f = await add_import_row(undefined, undefined, import_name, import_page)
            }
            const eventData1 = { url: `https://webdev983.github.io/templatesv3/component.html?id=${compid}&cleanAttr=${import_name}&ownerid=${localStorage.getItem('ownerid')}` };
            console.log('event ' + eventData1.url)
            // Fetch options
            const options0 = {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(eventData1)
            };
            await fetch(pup_url, options0);
            const currentDate = new Date();

            // Add one day to the current date
            const tomorrow = new Date(currentDate);
            tomorrow.setDate(currentDate.getDate() + 1);

            // Convert the date to ISO 8601 format (required by DynamoDB)
            const ttl = Math.floor(tomorrow.getTime() / 1000);
            const db = {
              id: generateUUID(),
              sk: 'import',
              ttl,
              data,
            }

            tomorrow.setDate(currentDate.getDate() + 6);

            // Convert the date to ISO 8601 format (required by DynamoDB)
            const ttl2 = Math.floor(tomorrow.getTime() / 1000);
            const body = {
              id: headContentItem.id,
              sk: `import:${f.id}`,
              value: data,
              ttl: ttl2

            }
            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              body: JSON.stringify(body),
            });
            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(db),
            });

            const eventData = { url: `https://webdev983.github.io/templatesv3/component.html?id=${compid}&attr=${import_name}&val=${db.id}&ownerid=${localStorage.getItem('ownerid')}` };
            console.log('event ' + eventData.url)
            // Fetch options
            const options = {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(eventData)
            };
            const response = await fetch(pup_url, options);


            if (!response.ok) {
              log1('error pup')
            }


            // get component id with name
          }
          const payload = {
            id: headContentItem.id,
            sk: `ai:${element.name}:${new Date().getTime()}`
          }
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          });
          status.textContent = 'üü¢'

        }
        //status.addEventListener('click',runF )
        funcDictionary[element.name] = runF
        originalRow.parentNode.append(cloned);
      }
      originalRow.remove();

    }
    var updatePathItem = () => {
      log1(JSON.stringify(pathItem))

      return fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(pathItem),
      });
    }
    var updateHeadContentItem = () => {
      log1(JSON.stringify(headContentItem))

      return fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(headContentItem),
      });
    }

    const switchOptionalScript = (updateDb) => {
      const el = getElementById1('optional-script')
      if (!updateDb) {
        el.classList.add('b-selected');
        return
      }
      if (pathItem.optionalScript) {
        pathItem.optionalScript = false
        el.classList.remove('b-selected');
      }
      else {
        pathItem.optionalScript = true
        el.classList.add('b-selected');
      }
      updatePathItem()


    }
    const switchLinkBP = (updateDb) => {
      const el = getElementById1('link-by-path')
      if (!updateDb) {
        el.classList.add('b-selected');
        return
      }
      if (pathItem.LinkBP) {
        pathItem.LinkBP = false
        el.classList.remove('b-selected');
      }
      else {
        pathItem.LinkBP = true
        el.classList.add('b-selected');
      }
      updatePathItem()
    }
    const switchTest = (updateDb) => {
      const el = getElementById1('test-component')
      if (!updateDb) {
        el.classList.add('b-selected');
        return
      }
      if (pathItem.testPage) {
        pathItem.testPage = false
        el.classList.remove('b-selected');

      }
      else {
        pathItem.testPage = true
        el.classList.add('b-selected');
      }
      updatePathItem()
    }
    //not used
    const addComponent1 = async (id, selfuse, reusable, pId) => {
      //getElementById1('file-list-attach-component-options;').remove()
      const actionObject = {
        time: (new Date()).getTime(),
        action: 'Add_Component',
        target_element: page_id + '-tree',
        inserted_component: { componentId: id, id: generateUUID() },

      };
      actionObject.options = { selfuse, reusable, attachId: pId }

      await pushAction(actionObject);
    }
    var loadUsingPath2 = (path1, filePathList, optionList) => {
      return fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true&lsi1=' + path1)
        .then(response => response.json())
        .then(data => {
          // Replace existing file paths with dynamic content

          filePathList.innerHTML = '';
          let i = 0
          let folders = []
          const elements = []
          log1(JSON.stringify(data))
          const items = data.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(path1, '').split(';')[0] } })
          log1(JSON.stringify(items))
          for (const item of items) {
            const splited = item.name.split(';')[0].split('/')
            if (splited.length > 1) {
              folders.push(splited[0])
            }
            else {
              elements.push({ name: splited[0], ...item })
            }
          }
          folders = removeDuplicates(folders)
          log1(JSON.stringify(folders))
          log1(JSON.stringify(elements))

          folders.forEach(item => {


            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item;

              // Set file path and emoji
              const file_path = clonedItem.querySelector('[data-value="file-path"]')
              file_path.textContent = item;
              clonedItem.onclick = setPath
              let icon = 'üìÇ';

              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item;

              // Set up onclick for file-open button
              function setPath() {
                path1 = path1 + item + '/'
                loadUsingPath2(path1, filePathList, optionList)
              };

              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }

          });
          elements && elements.forEach(item => {


            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item.id;

              // Set file path and emoji
              const item_path = clonedItem.querySelector('[data-value="file-path"]')
              item_path.textContent = item.name;
              clonedItem.onclick = function (event) {
                event.stopPropagation()
                fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/' + item.id + ':' + item.sk)
                  .then(response => response.json())
                  .then(data => {
                    if (data.LinkBP || optionList.querySelector('#file-list-link-by-path').classList.contains('b-selected')) {
                      const p = data.lsi1.split('/')
                      p.shift()
                      addComponent1("*/" + p.join('/'))
                    }
                    else if (optionList.querySelector('#file-list-link-by-name').classList.contains('b-selected')) {
                      const p = data.lsi1.split('/')

                      addComponent1("#" + p.pop())
                    }
                    else {
                      addComponent1(item.id)
                    }

                    filePathList.remove()
                  })

              };
              let icon = 'üß©';
              if (item.lsi1.startsWith('css')) {
                icon = 'üé®';
              } else if (item.lsi1.startsWith('javascript')) {
                icon = 'üíª';
              }
              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

              clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                event.stopPropagation()
                remove(event, item.id);
              };
              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }

          });



        })
        .catch(error => console.error('Error:', error));
    }
    var loadFileList2 = (filePathList, optionList) => {
      // Fetch GET request

      fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true')
        .then(response => response.json())
        .then(data => {
          // Replace existing file paths with dynamic content
          filePathList.innerHTML = '';
          let i = 0;
          let folders = []
          const elements = []
          log1(JSON.stringify(data))
          const items = data.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.split(';')[0] } })
          log1('ites' + JSON.stringify(items))
          for (const item of items) {
            const splited = item.name.split(';')[0].split('/')
            if (splited.length > 1) {
              folders.push(splited[0])
            }
            else {
              elements.push({ name: splited[0], ...item })
            }
          }
          folders = removeDuplicates(folders)
          log1(JSON.stringify(elements))
          folders.forEach(item => {


            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item;

              // Set file path and emoji
              const file_path = clonedItem.querySelector('[data-value="file-path"]')
              file_path.textContent = item;
              clonedItem.onclick = setPath
              let icon = 'üìÇ';

              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item;

              // Set up onclick for file-open button
              function setPath() {
                const path1 = item + '/'


                loadUsingPath2(path1, filePathList, optionList)
              };

              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }

          });
          elements && elements.forEach(item => {


            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item.id;

              // Set file path and emoji
              const item_path = clonedItem.querySelector('[data-value="file-path"]')
              item_path.textContent = item.name;
              clonedItem.onclick = function (event) {
                event.stopPropagation()
                fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/' + item.id + ':' + item.sk)
                  .then(response => response.json())
                  .then(data => {

                    if (data.LinkBP || optionList.querySelector('#file-list-link-by-path').classList.contains('b-selected')) {
                      const p = data.lsi1.split('/')
                      p.shift()
                      addComponent1("*/" + p.join('/'))
                    }
                    else if (optionList.querySelector('#file-list-link-by-name').classList.contains('b-selected')) {
                      const p = data.lsi1.split('/')

                      addComponent1("#" + p.pop())
                    }
                    else {
                      addComponent1(item.id)
                    }

                    filePathList.remove()
                  })

              };
              let icon = 'üß©';
              if (item.lsi1.startsWith('css')) {
                icon = 'üé®';
              } else if (item.lsi1.startsWith('javascript')) {
                icon = 'üíª';
              }
              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

              // Set up onclick for file-open button

              clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                event.stopPropagation()
                remove(event, item.id);
              };
              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }

          });



          // Show the cloned fieldsets
          querySelectorAll1('#filePathList fieldset').forEach(fieldset => {
            fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
          });




        })
        .catch(error => console.error('Error:', error));

    }
    //end not used
    var addComponent = (e, isTree) => {
      let pId = ''
      if (isTree) {
        pId = e.target.closest('fieldset').id.replace('code-tree-add-tag-step-1;', '')
      }

      let selected = []
      let path1 = ''


      var addSelected = (itemId, path) => {
        const clonedFieldset2 = getElementById1('selectedFilePathList;' + pId)
        /*
        if (Array.from(clonedFieldset2.children).find(el => el.id === itemId)) {
          return
        }*/
        var clonedItem = getElementById1('item').cloneNode(true);
        selected.push(itemId)
        clonedItem.id = itemId;
        const file_path = clonedItem.querySelector('[data-value="file-path"]')
        file_path.textContent = path;
        clonedItem.querySelector('#Pushpin').removeAttribute('hidden')
        clonedItem.onclick = (e) => {
          e.target.closest('li').remove();
          selected.filter(el => {
            if (el === itemId) {
              // Return false to exclude the element from the filtered array
              // after the first occurrence has been removed
              itemId = null;
              return false;
            }
            return true;
          })
        }
        var firstChild = clonedFieldset2.firstChild;

        // Insert clonedItem before the first child
        //clonedFieldset2.insertBefore(clonedItem, firstChild);
        clonedFieldset2.append(clonedItem)
        log1(JSON.stringify(selected))

      }




      var loadUsingPath1 = async (path) => {
        try {
          //get files
          let url
          const helperid = localStorage.getItem('helperid')

          var filePathList = getElementById1('filePathList;' + pId);
          filePathList.innerHTML = '';
          let lvls = [];
          let i = 0;
          let folders = [];

          //get files
          const spath = path.slice(0, -1) + '|';

          if (helperid) {
            url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${spath}&token=${localStorage.getItem('token')}`;
          }
          else {
            url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${spath}&token=${localStorage.getItem('token')}`;
          }
          let data1 = fetch(url).then(e => e.json())
          //get folders
          if (path.split('/').length > 3) {
            //normal
            if (localStorage.getItem('helperid')) {
              url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`;
            }
            else {
              url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`;
            }
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            let data = await response.json();
            log1(JSON.stringify(data));
            const items = data.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(path, '').split(';')[0] } });
            log1(JSON.stringify(items));
            for (const item of items) {
              const splited = item.name.split(';')[0].split('/');
              if (splited.length > 1) {
                folders.push(splited[0]);
              }
              else {
                folders.push(splited[0].split('|')[0])
              }
            }
          }
          else {
            //use folders
            const sk = `folder:${helperid ? helperid : ownerid}:lvl${path.split('/').length}:${path}`
            log1(sk)
            let url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            let data = await response.json();
            folders = data.items.map(item => item.sk.replace(sk, ''))
          }


          // Replace existing file paths with dynamic content

          log1('folders' + JSON.stringify(folders))
          folders = removeDuplicates(folders);
          folders.sort();
          folders.forEach(item => {


            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item;

              // Set file path and emoji
              const file_path = clonedItem.querySelector('[data-value="file-path"]')
              file_path.textContent = item;
              clonedItem.onclick = setPath
              let icon = 'üìÇ';

              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item;

              // Set up onclick for file-open button
              function setPath() {
                path1 = path1 + item + '/'
                loadUsingPath1(path1)
              };

              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }

          });


          //elements



          data1 = await data1
          let elements = data1.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(spath, '').split(';')[0] } });
          elements.sort((a, b) => a.name.localeCompare(b.name));
          const promise = elements.map(el1 => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${el1.id}:${el1.sk}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          }).then(el => el.json()).then(el2 => { return { ...el2, ...el1 } }))
          const elements1 = await Promise.all(elements)
          for (const item of elements1) {

            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item.id;

              // Set file path and emoji
              const item_path = clonedItem.querySelector('[data-value="file-path"]')
              item_path.textContent = item.name;
              clonedItem.onclick = function (event) {

                addSelected(item.id, item.lsi1);
              };
              let icon = 'üß©';
              if (item.lsi1.startsWith('css')) {
                icon = 'üé®';
              } else if (item.lsi1.startsWith('javascript')) {
                icon = 'üíª';
              }
              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

              clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                event.stopPropagation()
                remove(event, item.id);
              };
              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }
          }

        } catch (error) {
          console.error('Error:', error);
        }

      }
      var loadFileList1 = async () => {
        // Fetch GET request

        log1('loading filelist')
        // Fetch GET request
        const helperid = localStorage.getItem('helperid')
        const sk = `folder:${helperid ? helperid : ownerid}:lvl1:`
        let url
        log1(url)


        var filePathList = document.getElementById('filePathList;' + pId);
        filePathList.innerHTML = '';

        if (helperid) {
          url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=|&token=${localStorage.getItem('token')}`;
        }
        else {
          url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=|&token=${localStorage.getItem('token')}`;
        }
        let data1 = fetch(url).then(e => e.json())
        url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`
        return fetch(url)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            // Parse response as JSON
            return response.json();
          })
          .then(async data => {
            log1(JSON.stringify(data))
            // Replace existing file paths with dynamic content

            let i = 0;
            let folders = data.items.map(item => item.sk.replace(sk, ''))

            log1(JSON.stringify(data))


            folders = removeDuplicates(folders)
            log1(JSON.stringify(folders))
            folders.sort()
            folders.forEach(item => {


              if (i < 1000) {
                i++
                // Clone the fieldset
                var clonedItem = getElementById1('item').cloneNode(true);

                // Set unique ID for the cloned item
                clonedItem.id = item;

                // Set file path and emoji
                const file_path = clonedItem.querySelector('[data-value="file-path"]')
                file_path.textContent = item;
                clonedItem.onclick = setPath
                let icon = 'üìÇ';

                clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

                // Set file ID
                clonedItem.querySelector('[data-value="file-id"]').textContent = item;

                // Set up onclick for file-open button
                function setPath() {
                  path1 = item + '/'


                  loadUsingPath1(path1)
                };

                // Append the cloned item to the filePathList
                filePathList.appendChild(clonedItem);
              }

            });

            // Show the cloned fieldsets
            document.querySelectorAll('#filePathList fieldset').forEach(fieldset => {
              fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
            });




            data1 = await data1
            let elements = data1.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace('|', '').split(';')[0] } });
            elements.sort((a, b) => a.name.localeCompare(b.name));
            const promise = elements.map(el1 => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${el1.id}:${el1.sk}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(el => el.json()).then(el2 => { return { ...el2, ...el1 } }))
            const elements1 = await Promise.all(elements)
            for (const item of elements1) {
              if (i < 1000) {
                i++
                // Clone the fieldset
                var clonedItem = getElementById1('item').cloneNode(true);

                // Set unique ID for the cloned item
                clonedItem.id = item.id;

                // Set file path and emoji
                const item_path = clonedItem.querySelector('[data-value="file-path"]')
                item_path.textContent = item.name;
                clonedItem.onclick = function (event) {
                  event.stopPropagation()
                  addSelected(item.id, item.lsi1);
                };
                let icon = 'üß©';
                if (item.lsi1.startsWith('css')) {
                  icon = 'üé®';
                } else if (item.lsi1.startsWith('javascript')) {
                  icon = 'üíª';
                }
                clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

                // Set file ID
                clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

                // Set up onclick for file-open button

                clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                  event.stopPropagation()
                  remove(event, item.id);
                };
                // Append the cloned item to the filePathList
                filePathList.appendChild(clonedItem);
              }
            }
            // Update select options
            /*
            var pathSelector = document.getElementById('pathSelector');
            pathSelector.innerHTML = '<option value="select">‚¨áÔ∏è select</option><option value="back">‚¨ÖÔ∏è back</option>';
            lvls.forEach((lvl, index) => {
              pathSelector.innerHTML += `<option value="${lvl}">‚û°Ô∏è ${lvl}</option>`;
            });*/
            querySelectorAll1('#filePathList fieldset').forEach(fieldset => {
              fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
            });
          }).catch(e => log1(e))

















      }

      const fieldset = getElementById1('filePathList');
      const fieldset2 = getElementById1('selectedFilePathList');
      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('filePathList')) {
        const clonedFieldset = fieldset.cloneNode(true);
        const clonedFieldset2 = fieldset.cloneNode(true);
        const clonedFieldset3 = getElementById1('file-list-attach-component-options').cloneNode(true);
        clonedFieldset3.removeAttribute('hidden')

        clonedFieldset3.id = 'file-list-attach-component-options;' + pId

        clonedFieldset.id = clonedFieldset.id + ';' + pId;
        clonedFieldset2.id = 'selectedFilePathList;' + pId;
        clonedFieldset.setAttribute('action', 'Add_Component')
        const loadRoot = (e) => {
          if (path1 === '') {
            return
          }
          else {
            path1 === ""
            loadFileList1()

          }
          localStorage.setItem('add-type', 'root')
        }
        clonedFieldset3.querySelector('#root').onclick = loadRoot
        const loadPrev = (e) => {
          if (lastCompPath) {
            log1(lastCompPath)
            s = lastCompPath.split('/')
            s.pop()
            path1 = s.join('/') + '/'
            loadUsingPath1(path1)
            localStorage.setItem('add-type', 'prev')
          }
        }
        clonedFieldset3.querySelector('#previous-component').onclick = loadPrev
        const loadCurrent = (e) => {
          const s = pathItemPath.split('/')
          s.pop()
          path1 = s.join('/') + '/'
          loadUsingPath1(path1)
          localStorage.setItem('add-type', 'current')

        }
        clonedFieldset3.querySelector('#current-component').onclick = loadCurrent
        clonedFieldset3.querySelector('[data-action="moveBack"]').onclick = (e) => {
          const splited = path1.split('/')
          if (path1 === '') {
            return
          }
          else if (splited.length === 2) {
            path1 === ""
            loadFileList1()

          }
          else {
            splited.pop()
            splited.pop()
            path1 = splited.join('/') + '/'
            loadUsingPath1(path1)

          }
        }
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset2);
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset3);
        const add_type = localStorage.getItem('add-type')
        if (!add_type || add_type === 'root') {
          loadFileList1()
          clonedFieldset3.querySelector('#root').checked = true
        }
        else if (add_type === "current") {
          loadCurrent()
          clonedFieldset3.querySelector('#current-component').checked = true
        }
        else {
          loadPrev()
          clonedFieldset3.querySelector('#previous-component').checked = true
        }

        if (isTree) {
          e.target.parentNode.remove()
        }

      }

    }
    var addTreeElement = (e) => {
      const fieldset = getElementById1('tag-table');
      log1('clicked')
      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('tag-table')) {
        const clonedFieldset = fieldset.cloneNode(true);

        const clonedRows = clonedFieldset.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        for (let i = 0; i < clonedRows.length; i++) {
          const index = i; // Capture the current value of 'i' in a closure
          clonedRows[i].onclick = function (event) {
            chooseTag(index, event);
          };
        }
        clonedFieldset.id = clonedFieldset.id + ';' + page_id + '-tree';
        clonedFieldset.setAttribute('action', 'Insert_First')
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
      }

    }

    function getRelativePath(currentLsi, lsi3) {
      // Split paths into arrays of directories and filenames
      const currentLsiParts = currentLsi.split('/');
      const lsi3Parts = lsi3.split('/');

      // Extract filenames from paths
      const currentFilename = currentLsiParts.pop();
      const lsi3Filename = lsi3Parts.pop();

      // Find the index at which paths diverge
      let divergeIndex = 0;
      while (divergeIndex < Math.min(currentLsiParts.length, lsi3Parts.length) && currentLsiParts[divergeIndex] === lsi3Parts[divergeIndex]) {
        log1('adding')
        divergeIndex++;
      }
      log1(currentLsiParts[divergeIndex])
      log1(lsi3Parts[divergeIndex])
      // Calculate the number of levels to go up from currentLsi to the common directory
      const levelsUp = currentLsiParts.length - divergeIndex;

      // Build the relative path to lsi3
      let relativePath = (levelsUp === 0 ? './' : Array(levelsUp).fill('..').join('/') + '/');
      if (lsi3Parts.length > 0) {
        relativePath += lsi3Parts.slice(divergeIndex).join('/');
      }
      // Append the filename to the relative path
      if (relativePath.endsWith('/')) {
        relativePath += lsi3Filename;
      }


      else {
        relativePath += '/' + lsi3Filename;
      }


      return relativePath;
    }
    function getNextCounter(counter) {
      let prefix = counter.substring(0, counter.length - 1);
      let lastChar = counter[counter.length - 1];

      if (lastChar === 'Z') {
        if (prefix === 'A') {
          return 'A0';
        } else {
          let prefixCharCode = prefix.charCodeAt(0);
          let nextPrefix = String.fromCharCode(prefixCharCode + 1);
          return nextPrefix + 'A';
        }
      } else if (/\d/.test(lastChar)) {
        let num = parseInt(lastChar);
        if (num < 9) {
          return prefix + (num + 1);
        } else {
          let prefixCharCode = prefix.charCodeAt(0);
          let nextPrefix = String.fromCharCode(prefixCharCode + 1);
          return nextPrefix + 'A';
        }
      } else {
        let nextChar = String.fromCharCode(lastChar.charCodeAt(0) + 1);
        return prefix + nextChar;
      }
    }
    const getLastReusableId = async () => {
      let newCounter = 'AA'
      const data = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/re_use_counter:counter')
        .then(response => response.json())

      if (data) {
        const prevCounter = data.value
        newCounter = prevCounter

      }
      return newCounter
    }
    const updateCounter = async (newCounter) => {
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(
          { id: 're_use_counter', sk: 'counter', value: newCounter }
        ),
      });
    }
    var approveAddComponent = async (e) => {
      const m1 = e.target.parentNode.nextElementSibling


      const ids = Array.from(m1.children).map(e => e.id)
      const optionList = e.target.parentNode
      const pId = optionList.id.replace('file-list-attach-component-options;', '')
      let flag
      const selfuse = optionList.querySelector('#selfuse').checked
      const reusableC = optionList.querySelector('#reusable').checked
      let newCounter
      if (reusableC) {
        newCounter = await getLastReusableId()
      }





      for (const id of ids) {
        const data = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/' + id + ':path')
          .then(response => response.json())
        newCounter && (newCounter = getNextCounter(newCounter))
        if (data.LinkBP || optionList.querySelector('#file-list-link-by-path').classList.contains('b-selected')) {

          const p = convertToOldPath(data.lsi1.split(';')[0]).split('/')
          p.shift()
          const fileName = p.pop()
          let r = ''
          if (p.length) {
            r = '/' + p.join('/')
          }
          addComponent1("*" + r + '|' + fileName, selfuse, newCounter, pId)
        }
        else if (optionList.querySelector('#file-list-link-by-name').classList.contains('b-selected') || optionList.querySelector('#file-list-link-by-content-name').classList.contains('b-selected')) {
          const currentLsi = pathItemPath.replace(';publish:published', "")
          const relativePath = getRelativePath(currentLsi, convertToOldPath(data.lsi1.replace(';publish:published', "")));
          let prefix = optionList.querySelector('#file-list-link-by-content-name').classList.contains('b-selected') ? '$' : '#'
          await addComponent1(prefix + relativePath, selfuse, newCounter, pId).catch(e => log1(e))
          flag = true
        }

        else {
          addComponent1(id, selfuse, newCounter, pId)
        }

      }
      if (newCounter) {
        await updateCounter(newCounter)
      }
      flag && location.reload()
      getElementById1('file-list-attach-component-options;' + pId).remove()
      getElementById1('filePathList;' + pId).remove()
      getElementById1('selectedFilePathList;' + pId).remove()
    }
    var approveReplace = async (e) => {
      const m = Array.from(e.target.parentNode.children).filter(i => i.id)
      const m1 = m.filter(e => e.hasAttribute('component'))
      const m2 = m.filter(e => e.hasAttribute('folder'))
      const single = e.target.parentNode.hasAttribute('single')
      const article = e.target.parentNode.hasAttribute('article')
      const catalogue = e.target.parentNode.hasAttribute('catalogue')
      const menu = e.target.parentNode.closest('[data-open-menu]')
      const container = menu.parentNode
      const parentId = e.target.parentNode.id
      const catIcon = container.querySelector('[data-element="catalog"]')
      if (article) {
        if (!m.length) {
          delete pathItem.hub_items.article_page
          delete pathItem.hub_items.catalogue_component
          await updatePathItem()
          Array.from(menu.children).forEach(child => {
            child.remove();
          });
          catIcon.setAttribute('hidden', '')
          return

        }
        const id = m1[0]?.id

        if (!id) {
          Array.from(menu.children).forEach(child => {
            child.remove();
          });
          return
        }
        const element = getElementById1(id);
        const path = element.querySelector('[data-value="file-path"]').textContent
        const splited = path.split('/')
        if (splited[2] === "Home") {
          alert('home folder')
        }
        splited[2] = '*'
        splited[0] = '*'
        pathItem.hub_items.article_page = splited.join('/')
        pathItem.hub_items.catalogue_component = parentId.replace('selectedFilePathList;', '').replace('-tree', '')
        await updatePathItem()


        catIcon.removeAttribute('hidden')
        Array.from(menu.children).forEach(child => {
          child.remove();
        });
        return
      }
      //const folderChecked = e.target.parentNode.querySelector('#attach-folder').checked

      if (!parentId) {
        alert('no target id')
        return
      }
      const parentEl = getElementById1(parentId)
      const replacedString = parentEl.getAttribute('replaced')
      const replaced = replacedString ? JSON.parse(replacedString) : []

      const arr = m1.map(el => {
        const element = getElementById1(el.id);
        return {

          componentId: el.id, id: el.newId || generateUUID(), path: element.querySelector('[data-value="file-path"]').textContent, already: element.getAttribute('alreadyReplaced')
        }
      })
      const el = {
        time: (new Date()).getTime(),
        action: 'Replace_Component',
        target_element: [parentId.replace('selectedFilePathList;', ''), ...arr],
        options: { single }
      };
      if (m2.length) {
        el.folders = m2.map(e => e.id)
      }
      await pushAction(el)
      location.reload()
    }
    var setAnchor = async (event) => {
      const path = event.target.parentNode.parentNode.getAttribute('path')
      const checked = event.target.checked
      const currentLsi = pathItemPath.replace(';publish:published', "")
      const relativePath = getRelativePath(currentLsi, convertToOldPath(path.replace(';publish:published', "")));
      console.log(relativePath)
      const icon = event.target.closest('[data-element="code-tree-tag"]').querySelector('[data-element="set_anchor"]')
      if (checked) {
        if (pathItem.hub_items.anchor) {
          pathItem.hub_items.anchor.push(relativePath)
        }
        else {
          pathItem.hub_items.anchor = [relativePath]
        }
        icon.removeAttribute('hidden')
      }
      else {
        pathItem.hub_items.anchor = pathItem.hub_items.anchor.filter(e => e !== relativePath)
        console.log(pathItem.hub_items.anchor)
        icon.setAttribute('hidden', '')
      }

      await updatePathItem()
    }
    //file list scripts
    var replaceComponent = (e, flag) => {
      const single = e.target.parentNode.querySelector('#single_replace')?.checked
      const article = e.target.parentNode.querySelector('#choose_article')?.checked
      const catalogue = e.target.parentNode.querySelector('#choose_catalog')?.checked
      let selected = []
      let path1 = ''
      var addSelected = (id, itemId, path) => {
        const clonedFieldset2 = getElementById1('selectedFilePathList;' + id)
        if (Array.from(clonedFieldset2.children).find(el => el.id === itemId)) {
          return
        }
        var clonedItem = getElementById1('item').cloneNode(true);
        selected.push(itemId)
        clonedItem.id = itemId;
        clonedItem.setAttribute('component', true)
        const file_path = clonedItem.querySelector('[data-value="file-path"]')
        file_path.textContent = path;
        clonedItem.querySelector('#Pushpin').removeAttribute('hidden')
        clonedItem.onclick = (e) => { e.target.closest('li').remove(); selected.filter(el => el !== itemId) }
        clonedFieldset2.appendChild(clonedItem)
        log1(JSON.stringify(selected))

      }

      var setFolder = (path, id) => {
        const relative = getElementById1('relative-input')
        const absolute = getElementById1('absolute-input')

        if (relative.checked) {
          const currentLsi = pathItemPath.split(';')[0]
          const relativePath = getRelativePath(currentLsi, path);
          path = '#' + relativePath
        }
        else if (absolute.checked) {
          const p = path.split('/')
          p.shift()
          let r = ''
          if (p.length) {
            r = '/' + p.join('/')
          }
          path = "*" + r
        }
        const clonedFieldset2 = getElementById1('selectedFilePathList;' + id)
        if (Array.from(clonedFieldset2.children).find(el => el.id === path)) {
          return
        }
        var clonedItem = getElementById1('item').cloneNode(true);
        selected.push(path)
        clonedItem.id = path;
        clonedItem.setAttribute('folder', true)
        const file_path = clonedItem.querySelector('[data-value="file-path"]')
        clonedItem.querySelector('[data-value="file-emoji"]').textContent = 'üìÇ'
        file_path.textContent = path;
        clonedItem.querySelector('#Pushpin').removeAttribute('hidden')
        clonedItem.onclick = (e) => { e.target.closest('li').remove(); selected.filter(el => el !== path) }
        clonedFieldset2.appendChild(clonedItem)
        log1(JSON.stringify(selected))

      }




      var loadUsingPath1 = async (id, path) => {
        try {
          //get files
          let url
          const helperid = localStorage.getItem('helperid')

          var filePathList = getElementById1('filePathList;' + id);
          filePathList.innerHTML = '';
          let lvls = [];
          let i = 0;
          let folders = [];

          //get files
          const spath = path.slice(0, -1) + '|';

          if (helperid) {
            url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${spath}&token=${localStorage.getItem('token')}`;
          }
          else {
            url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${spath}&token=${localStorage.getItem('token')}`;
          }
          let data1 = fetch(url).then(e => e.json())
          //get folders
          if (path.split('/').length > 3) {
            //normal
            if (localStorage.getItem('helperid')) {
              url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`;
            }
            else {
              url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`;
            }
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            let data = await response.json();
            log1(JSON.stringify(data));
            const items = data.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(path, '').split(';')[0] } });
            log1(JSON.stringify(items));
            for (const item of items) {
              const splited = item.name.split(';')[0].split('/');
              if (splited.length > 1) {
                folders.push(splited[0]);
              }
              else {
                folders.push(splited[0].split('|')[0])
              }
            }
          }
          else {
            //use folders
            const sk = `folder:${helperid ? helperid : ownerid}:lvl${path.split('/').length}:${path}`
            log1(sk)
            let url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            let data = await response.json();
            folders = data.items.map(item => item.sk.replace(sk, ''))
          }


          // Replace existing file paths with dynamic content

          log1('folders' + JSON.stringify(folders))
          folders = removeDuplicates(folders);
          folders.sort();
          folders.forEach(item => {


            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item;

              // Set file path and emoji
              const file_path = clonedItem.querySelector('[data-value="file-path"]')
              file_path.textContent = item;
              clonedItem.onclick = (e) => {
                const folderChecked = getElementById1('selectedFilePathList;' + id).querySelector('#attach-folder').checked
                folderChecked ? setFolder(path1 + item, id) : setPath()
              }
              let icon = 'üìÇ';

              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item;

              // Set up onclick for file-open button
              function setPath() {
                path1 = path1 + item + '/'
                loadUsingPath1(id, path1)
              };

              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }

          });


          //elements



          data1 = await data1
          let elements = data1.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(spath, '').split(';')[0] } });
          elements.sort((a, b) => a.name.localeCompare(b.name));
          const promise = elements.map(el1 => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${el1.id}:${el1.sk}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          }).then(el => el.json()).then(el2 => { return { ...el2, ...el1 } }))
          const elements1 = await Promise.all(elements)
          for (const item of elements1) {

            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item.id;

              // Set file path and emoji
              const item_path = clonedItem.querySelector('[data-value="file-path"]')
              item_path.textContent = item.name;
              clonedItem.onclick = function (event) {

                addSelected(id, item.id, item.lsi1);
              };
              let icon = 'üß©';
              if (item.lsi1.startsWith('css')) {
                icon = 'üé®';
              } else if (item.lsi1.startsWith('javascript')) {
                icon = 'üíª';
              }
              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

              clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                event.stopPropagation()
                remove(event, item.id);
              };
              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }
          }

        } catch (error) {
          console.error('Error:', error);
        }


      }
      var loadFileList1 = async (id) => {
        // Fetch GET request

        log1('loading filelist')
        // Fetch GET request
        const helperid = localStorage.getItem('helperid')
        const sk = `folder:${helperid ? helperid : ownerid}:lvl1:`
        let url
        log1(url)


        var filePathList = getElementById1('filePathList;' + id);
        filePathList.innerHTML = '';

        if (helperid) {
          url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=|&token=${localStorage.getItem('token')}`;
        }
        else {
          url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=|&token=${localStorage.getItem('token')}`;
        }
        let data1 = fetch(url).then(e => e.json())
        url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`
        return fetch(url)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            // Parse response as JSON
            return response.json();
          })
          .then(async data => {
            log1(JSON.stringify(data))
            // Replace existing file paths with dynamic content

            let i = 0;
            let folders = data.items.map(item => item.sk.replace(sk, ''))

            log1(JSON.stringify(data))


            folders = removeDuplicates(folders)
            log1(JSON.stringify(folders))
            folders.sort()
            folders.forEach(item => {


              if (i < 1000) {
                i++
                // Clone the fieldset
                var clonedItem = getElementById1('item').cloneNode(true);

                // Set unique ID for the cloned item
                clonedItem.id = item;

                // Set file path and emoji
                const file_path = clonedItem.querySelector('[data-value="file-path"]')
                file_path.textContent = item;
                clonedItem.onclick = (e) => {
                  const folderChecked = getElementById1('selectedFilePathList;' + id).querySelector('#attach-folder').checked
                  folderChecked ? setFolder(item, id) : setPath()
                }
                let icon = 'üìÇ';

                clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

                // Set file ID
                clonedItem.querySelector('[data-value="file-id"]').textContent = item;

                // Set up onclick for file-open button
                function setPath() {
                  path1 = item + '/'


                  loadUsingPath1(id, path1)
                };

                // Append the cloned item to the filePathList
                filePathList.appendChild(clonedItem);
              }

            });

            // Show the cloned fieldsets
            document.querySelectorAll('#filePathList fieldset').forEach(fieldset => {
              fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
            });




            data1 = await data1
            let elements = data1.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace('|', '').split(';')[0] } });
            elements.sort((a, b) => a.name.localeCompare(b.name));
            const promise = elements.map(el1 => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${el1.id}:${el1.sk}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(el => el.json()).then(el2 => { return { ...el2, ...el1 } }))
            const elements1 = await Promise.all(elements)
            for (const item of elements1) {
              if (i < 1000) {
                i++
                // Clone the fieldset
                var clonedItem = getElementById1('item').cloneNode(true);

                // Set unique ID for the cloned item
                clonedItem.id = item.id;

                // Set file path and emoji
                const item_path = clonedItem.querySelector('[data-value="file-path"]')
                item_path.textContent = item.name;
                clonedItem.onclick = function (event) {
                  event.stopPropagation()
                  addSelected(id, item.id, item.lsi1);
                };
                let icon = 'üß©';
                if (item.lsi1.startsWith('css')) {
                  icon = 'üé®';
                } else if (item.lsi1.startsWith('javascript')) {
                  icon = 'üíª';
                }
                clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

                // Set file ID
                clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

                // Set up onclick for file-open button

                clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                  event.stopPropagation()
                  remove(event, item.id);
                };
                // Append the cloned item to the filePathList
                filePathList.appendChild(clonedItem);
              }
            }
            // Update select options
            /*
            var pathSelector = document.getElementById('pathSelector');
            pathSelector.innerHTML = '<option value="select">‚¨áÔ∏è select</option><option value="back">‚¨ÖÔ∏è back</option>';
            lvls.forEach((lvl, index) => {
              pathSelector.innerHTML += `<option value="${lvl}">‚û°Ô∏è ${lvl}</option>`;
            });*/
            querySelectorAll1('#filePathList fieldset').forEach(fieldset => {
              fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
            });
          }).catch(e => log1(e))






      }
      const splited = e.target.parentNode.id.split(';')
      const path = e.target.parentNode.getAttribute('path')
      const replacedString = e.target.parentNode.getAttribute('replaced')
      const replaced = replacedString ? JSON.parse(replacedString) : undefined
      const replacedFoldersString = e.target.parentNode.getAttribute('replacedFolders')
      const replacedFolders = replacedFoldersString ? JSON.parse(replacedFoldersString) : undefined
      const [toRemove, ...rest] = splited
      const parentId = splited.length === 1 ? e.target.parentNode.id : rest.join(';')
      const fieldset = getElementById1('filePathList');
      const fieldset2 = getElementById1('selectedFilePathList');
      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('filePathList')) {
        const clonedFieldset = fieldset.cloneNode(true);
        const clonedFieldset2 = fieldset2.cloneNode(true);
        if (single) {
          clonedFieldset2.setAttribute('single', '');
        } else if (article) {
          clonedFieldset2.setAttribute('article', '');
        } else if (catalogue) {
          clonedFieldset2.setAttribute('catalogue', '');
        }
        else {
          clonedFieldset2.querySelector('#relative-label').removeAttribute('hidden')
          clonedFieldset2.querySelector('#absolute-label').removeAttribute('hidden')
        }
        clonedFieldset2.id = clonedFieldset2.id + ';' + parentId;
        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', 'Replace')
        clonedFieldset2.setAttribute('action', 'Replace')
        clonedFieldset2.querySelector('[data-action="moveBack"]').onclick = (e) => {
          const splited = path1.split('/')
          if (path1 === '') {
            return
          }
          else if (splited.length === 2) {
            path1 === ""
            loadFileList1(parentId)

          }
          else {
            splited.pop()
            splited.pop()
            path1 = splited.join('/') + '/'
            loadUsingPath1(parentId, path1)

          }
        }
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset2);
        !flag && e.target.parentNode.remove()
        if (article) {
          if (pathItem.hub_items.article_page) {
            const clonedItem = getElementById1('item').cloneNode(true);
            clonedItem.setAttribute('article_page', true)
            clonedItem.id = pathItem.hub_items.article_page;
            selected.push(pathItem.hub_items.article_page)
            const file_path = clonedItem.querySelector('[data-value="file-path"]')
            file_path.textContent = pathItem.hub_items.article_page;
            clonedItem.querySelector('#Pushpin').removeAttribute('hidden')
            clonedFieldset2.appendChild(clonedItem)
            clonedItem.onclick = (e) => { e.target.closest('li').remove(); selected.filter(el => el !== pathItem.hub_items.article_page) }

          }
        }
        else if (!replaced && !replacedFolders) {
          var clonedItem = getElementById1('item').cloneNode(true);
          clonedItem.setAttribute('alreadyReplaced', true)
          clonedItem.id = parentId;
          clonedItem.setAttribute('component', true)
          selected.push(parentId)
          const file_path = clonedItem.querySelector('[data-value="file-path"]')
          file_path.textContent = path;
          clonedItem.querySelector('#Pushpin').removeAttribute('hidden')
          clonedFieldset2.appendChild(clonedItem)
          clonedItem.onclick = (e) => { e.target.closest('li').remove(); selected.filter(el => el !== parentId) }
        }
        else {
          for (const el of replacedFolders) {
            var clonedItem = getElementById1('item').cloneNode(true);
            clonedItem.setAttribute('alreadyReplaced', true)
            clonedItem.id = el;
            selected.push(el)
            const file_path = clonedItem.querySelector('[data-value="file-path"]')
            clonedItem.querySelector('[data-value="file-emoji"]').textContent = 'üìÇ'
            file_path.textContent = el;
            clonedItem.querySelector('#Pushpin').removeAttribute('hidden')
            clonedFieldset2.appendChild(clonedItem)
            clonedItem.onclick = (e) => { e.target.closest('li').remove(); selected.filter(el => el !== el.id) }
          }
          for (const el of replaced) {
            var clonedItem = getElementById1('item').cloneNode(true);
            clonedItem.setAttribute('alreadyReplaced', true)
            clonedItem.id = el.componentId;
            clonedItem.setAttribute('newId', el.id)
            selected.push(el.id)
            const file_path = clonedItem.querySelector('[data-value="file-path"]')
            file_path.textContent = el.path;
            clonedItem.querySelector('#Pushpin').removeAttribute('hidden')
            clonedFieldset2.appendChild(clonedItem)
            clonedItem.onclick = (e) => { e.target.closest('li').remove(); selected.filter(el => el !== el.id) }
          }


        }

        loadFileList1(parentId)
      }
    }

    let path = ''
    let lvls = []

    var removeLastOccurrence = (inputString, substringToRemove) => {
      const lastIndexOfSubstring = inputString.lastIndexOf(substringToRemove);

      if (lastIndexOfSubstring !== -1) {
        // If the substring is found, remove it and return the modified string
        const res = inputString.slice(0, lastIndexOfSubstring) + inputString.slice(lastIndexOfSubstring + substringToRemove.length);
        log1('OUTPUT ' + res)
        return res
      } else {
        // If the substring is not found, return the original string
        return inputString;
      }
    }

    async function removeAttribute1(event) {
      const saveButton = event.target;
      const checked = saveButton.closest('[data-open-menu]').querySelector('#applyToCopies').checked
      const tr = saveButton.closest('#code-tree-tag-attributes-list-item');

      if (!tr) {
        console.error('Could not find parent tr element');
        return;
      }

      const keyElement = tr.querySelector('#code-tree-tag-attribute-key');
      const key = keyElement.textContent.replace('üîë', '');

      const parentMenu = event.target.closest('.menu-1');

      if (!parentMenu) {
        console.error('Could not find parent menu element');
        return;
      }

      const { id } = parentMenu;
      const action = 'removeAttribute';
      log1('Action: ' + action);

      const splited = id.split(';');
      const [toRemove, ...rest] = splited;

      const el = {
        time: (new Date()).getTime(),
        action,
        target_element: rest.join(';'),
        key,
      };
      if (checked) {
        el.options = { apply_to_copies: true }
        el.target_element = el.target_element.split(':')[0].replace('-tree', '') + '-tree'
      }
      tr.remove();
      log1(JSON.stringify(el));
      await pushAction(el);

      log1(JSON.stringify(actionLog));
    }
    let visualOn = false
    function duplicateId(originalId,) {
      const splited = originalId.split(';');
      const lastId = splited[splited.length - 1]
      let newLastUUID
      const splited2 = lastId.split(':')
      const copyId = generateUUID()
      newLastUUID = splited2[0] + ':' + copyId
      splited.pop()
      return { id: [...splited, newLastUUID].join(';') + '-tree', copyId }

    }

    function transformToVisual(event) {

      localStorage.setItem('visualOn', 'true')
      if (visualOn) {
        localStorage.removeItem('visualOn')
        location.reload()
        return;
      }

      event.target.classList.add('b-selected');
      visualOn = true
      log1('transforming');
      var generatedPage = getElementById1("generated-page");

      // Process each child element
      var children = generatedPage.children;
      for (var i = 0; i < children.length; i++) {
        processElement(children[i]);
      }

      // Define the function to be removed
      function handleMouseOver(event) {
        if (event.target.hasAttribute('data-visual-element')) {
          event.target.style.backgroundColor = 'pink';
        }
      }

      // Add the event listener
      var iframe = getElementById1("generated-page-iframe");
      var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
      iframeDocument.addEventListener('mouseover', handleMouseOver);


      iframeDocument.addEventListener('mouseout', function (event) {
        if (event.target.hasAttribute('data-visual-element')) {
          event.target.style.backgroundColor = '';

          if (!event.target.getAttribute('style')) {
            event.target.removeAttribute('style');
          }
        }
      });



      function clickRemoveButton(clickEvent) {
        // Check if the clicked element or its ancestor is a button
        const isButton = clickEvent.target.closest('.receive-target');

        // Check if the clicked element or its ancestor has the class 'menu-option'
        const isMenuOption = clickEvent.target.closest('.menu-option');

        if (!isButton && !isMenuOption) {
          // If the clicked element is not a button and not inside an element with class 'menu-option', remove the buttons
          removeButtons();
        }
      }
      const showEditHrefMenu = (target) => {
        const editHref = getElementById1('update-href-menu')
        const cloned = editHref.cloneNode(true)
        cloned.id = cloned.id + ';' + target.id
        cloned.querySelector('#editHrefButton').onclick = async (e) => {
          const inputValue = e.target.parentNode.querySelector('#editHrefInput').value
          const el = {
            time: (new Date()).getTime(),
            action: 'setAttribute',
            target_element: target.id + '-tree',
            key: 'href',
            value: inputValue,

          }
          await pushAction(el)
          e.target.parentNode.remove()

        }
        target.appendChild(cloned)

      }
      function handleContextMenu(e) {
        if (e.target.hasAttribute('data-visual-element')) {
          e.preventDefault(); // Prevent the default context menu from opening
          log1('in11');
          const parentMenu = getElementById1('right-click-menu'); // Use # for ID selector
          const menu = parentMenu.querySelector('#options')
          menu.innerHTML = '';
          let siblingsWithDuplicate
          let fieldsetSiblings
          let parentWithAppendChild
          let siblingWithInsertBefore
          log1('tag ' + e.target.tagName)
          const redirectToImgPage = (imgId, src) => {
            const treeElement = getElementById1(imgId);
            log1(imgId)
            if (treeElement) {


              const existingClonedFieldset = treeElement.parentNode.querySelector('[id^="gallery-menu-wrapper"]');

              if (!existingClonedFieldset) {
                log1('cloning fieldset')
                // Clone the fieldset node
                const fieldset = getElementById1('gallery-menu-wrapper');
                const clonedFieldset = fieldset.cloneNode(true);

                // Assign a unique id to the cloned fieldset
                clonedFieldset.id = 'gallery-menu-wrapper;' + imgId + '-tree';

                // image input change 
                clonedFieldset.querySelector('#image-input').addEventListener('change', async function (event) {
                  log1('changing')
                  var fileNameSpan = clonedFieldset.querySelector('#file-name');

                  var uploadButton = clonedFieldset.querySelector('#upload-button');

                  // Check if a file is selected
                  if (this.files && this.files.length > 0) {
                    // If a file is chosen, show the file name and make the upload button visible
                    var fileName = this.files[0].name; // Get the name of the file
                    fileNameSpan.textContent = fileName; // Set the text content to the file name
                    fileNameSpan.removeAttribute('hidden'); // Make the file name span visible

                    uploadButton.removeAttribute('hidden'); // Make the upload button visible

                    file = event.target.files[0]
                  } else {
                    // If no file is chosen, hide the file name span and the upload button
                    fileNameSpan.hidden = true;
                    uploadButton.hidden = true;
                  }
                })




                loadImages(clonedFieldset, src)
                // Insert the cloned fieldset after the specified element
                treeElement.insertAdjacentElement('afterend', clonedFieldset);


              }

            }
          }
          const editAlt = (target) => {
            const alt = target.getAttribute('alt')

            const altElement = parentMenu.querySelector('#add_alt')
            altElement.removeAttribute('hidden')
            menu.setAttribute('hidden', '')
            const saveButton = altElement.querySelector("#editHrefButton")
            const input = altElement.querySelector('#editHrefInput')
            input.value = alt
            saveButton.onclick = (e) => {

              const el = {
                time: (new Date()).getTime(),
                action: 'setAttribute',
                target_element: target.id + '-tree',
                key: 'alt',
                value: input.value,

              }
              pushAction(el)

            }
          }
          if (e.target.tagName.toLowerCase() === 'img') {
            addMenuEntry(menu, `üñºÔ∏è Edit image`, () => {
              redirectToImgPage(e.target.id, e.target.getAttribute('data-builder-image-source'))
            });
            addMenuEntry(menu, `üñºÔ∏è Edit Alt`, () => {
              editAlt(e.target)
            }, true);
          }
          if (e.target.hasAttribute('data-visual-href')) {
            addMenuEntry(menu, `üîó Edit href`, () => {
              showEditHrefMenu(e.target)
            });
          }
          if (
            e.target.parentElement.id === e.target.id + '-fieldset') {
            // Check for data-visual-duplicate siblings
            log1('case1')
            siblingsWithDuplicate = Array.from(e.target.parentElement.parentElement.children).filter(
              sibling => sibling.hasAttribute('data-visual-dublicate')
            );

            // Check for fieldset siblings containing data-visual-duplicate elements
            fieldsetSiblings = Array.from(e.target.parentElement.parentElement.children).filter(
              sibling => sibling.tagName === 'FIELDSET' &&
                Array.from(sibling.querySelectorAll('[data-visual-dublicate]')).length > 0
            );
            // Check if parent has data-visual-appendChild
            parentWithAppendChild = e.target.parentElement.parentElement.hasAttribute('data-visual-appendchild') && e.target.parentElement.parentElement;

            // Check sibling for data-visual-insertBefore
            siblingWithInsertBefore = e.target.parentElement.parentElement && Array.from(e.target.parentElement.parentElement.children).filter(
              child => child.hasAttribute('data-visual-insertbefore') || (child.id.endsWith('-fieldset') && child.children[1].hasAttribute('data-visual-insertbefore'))
            );
          }
          else {
            log1('case2')
            // Check for data-visual-duplicate siblings
            let ids = []
            siblingsWithDuplicate = Array.from(e.target.parentElement.children).filter(

              sibling => {

                if (sibling.hasAttribute('data-visual-dublicate')) {

                  const id = sibling.id
                  const splited = id.split(';')
                  const last = splited[splited.length - 1]
                  const splited2 = last.replace('-tree', '').split(':')
                  const lastId = splited2[0]
                  splited.pop()
                  const toCheck = [...splited, lastId].join(';')
                  if (ids.includes(toCheck)) {
                    return false
                  }
                  ids.push(toCheck)
                  return true
                }
                return false
              }
            );

            // Check for fieldset siblings containing data-visual-duplicate elements
            ids = []
            fieldsetSiblings = Array.from(e.target.parentElement.children).filter(
              sibling => {
                if (sibling.tagName === 'FIELDSET' &&
                  Array.from(sibling.querySelectorAll('[data-visual-dublicate]')).length > 0) {
                  const id = sibling.id
                  const splited = id.split(';')
                  const last = splited[splited.length - 1]
                  const splited2 = last.replace('-tree', '').split(':')
                  const lastId = splited2[0]
                  splited.pop()
                  const toCheck = [...splited, lastId].join(';')
                  if (ids.includes(toCheck)) {
                    return false
                  }
                  ids.push(toCheck)
                  return true
                }
                return false
              }
            );
            // Check if parent has data-visual-appendChild
            parentWithAppendChild = e.target.parentElement.hasAttribute('data-visual-appendchild') && e.target.parentElement;

            // Check sibling for data-visual-insertBefore
            siblingWithInsertBefore = e.target.parentElement && Array.from(e.target.parentElement.children).filter(
              child => child.hasAttribute('data-visual-insertbefore')
            );

          }



          log1(JSON.stringify([...fieldsetSiblings, ...siblingsWithDuplicate]));



          // Add entries for data-visual-duplicate siblings
          const existingIds = []
          for (const sibling of siblingsWithDuplicate) {
            log1('taag' + sibling.tagName)
            let name = `‚ûï ${sibling.tagName.toLowerCase()}`
            if (sibling.hasAttribute('data-visual-title')) {
              name = `‚ûï ${sibling.getAttribute('data-visual-title')}`
            }
            const splited = sibling.id.split(':')
            splited.length > 1 && splited.pop()

            if (!existingIds.includes(splited.join(':'))) {
              existingIds.push(splited.join(':'))
              addMenuEntry(menu, name, () => {

                handleMenuEntryClick(e.target.id, sibling.id, siblingWithInsertBefore, parentWithAppendChild);


              });
            }
          }

          // Add entries for fieldset siblings
          for (const fieldsetSibling of fieldsetSiblings) {
            let name = `‚ûï ${fieldsetSibling.children[0].textContent.toLowerCase()}`
            if (fieldsetSibling.hasAttribute('data-visual-title')) {
              name = `‚ûï ${fieldsetSibling.getAttribute('data-visual-title')}`
            }
            const splited = fieldsetSibling.id.split(':')
            splited.length > 1 && splited.pop()

            if (!existingIds.includes(splited.join(':').replace('-fieldset', ''))) {
              existingIds.push(splited.join(':').replace('-fieldset', ''))
              addMenuEntry(menu, name, () => {

                handleMenuEntryClick(e.target.id, fieldsetSibling.children[1].id, siblingWithInsertBefore, parentWithAppendChild, true);
              });
            }

          }
          log1('existing ' + JSON.stringify(existingIds))

          // Adjust the position relative to the viewport
          const offsetX = e.pageX;
          const offsetY = e.pageY;

          parentMenu.style.display = 'block';
          parentMenu.style.left = `${offsetX}px`;
          parentMenu.style.top = `${offsetY}px`;
          const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
          iframeDocument.addEventListener('click', function () {
            parentMenu.style.display = 'none';
            parentMenu.querySelector('#options').removeAttribute('hidden')
            parentMenu.querySelector('#add_alt').setAttribute('hidden', "")
            parentMenu.querySelector('#editHrefInput').value = ""
          });
          // Hide the menu when clicking the left mouse button

          addMenuEntry(menu, `üóëÔ∏èÔ∏è Remove element`, async () => {
            if (findRelatedElements(e.target.id) > 1) {
              await pushAction({
                time: (new Date()).getTime(),
                action: 'removeTag',
                target_element: e.target.id + '-tree',

              })
              const el = getElementById1(e.target.id + '-fieldset')
              if (el) {
                el.remove()
              }
            }
            else {
              log1('iiid ' + e.target.id)
              const attr = e.target.getAttribute('data-visual-defaultTextNode')
              log1('attr' + attr)
              e.target.textContent = attr
            }

          }
          );
        }
      }

      function handleMenuEntryClick(sourceId, targetId, siblingWithInsertBefore, parentWithAppendChild, flag) {
        log1('t');
        log1(parentWithAppendChild);
        log1(siblingWithInsertBefore);
        removeButtons()
        const original = getElementById1(sourceId);
        const originalRect = original.getBoundingClientRect();
        var iframe = getElementById1("generated-page-iframe");
        var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
        // Check if siblingWithInsertBefore is present
        if (siblingWithInsertBefore.length > 0) {
          // Insert <button class="receive-target">‚ûï</button> before each siblingWithInsertBefore
          siblingWithInsertBefore.forEach(sibling => {
            const addButton = document.createElement('button');
            addButton.className = 'receive-target';
            addButton.innerHTML = '‚ûï';
            addButton.onclick = function () {
              insertBefore(sibling.id, targetId, flag);
              iframeDocument.removeEventListener('click', clickRemoveButton);
              iframeDocument.addEventListener('mouseover', handleMouseOver);
            };
            iframeDocument.addEventListener('mouseover', handleMouseOver1);
            iframeDocument.addEventListener('mouseout', handleMouseOut1);
            sibling.parentNode.insertBefore(addButton, sibling);
          });
        }

        // Check if parentWithAppendChild is present
        if (parentWithAppendChild) {
          // Append <button class="receive-target">‚ûï</button> to parentWithAppendChild
          const addButton = document.createElement('button');
          addButton.className = 'receive-target';
          addButton.innerHTML = '‚ûï';
          addButton.onclick = function () {
            const children = getElementById1(parentWithAppendChild.id).children;

            let lastFieldsetTreeId = null;

            for (let i = children.length - 1; i >= 0; i--) {
              const child = children[i];
              log1(child.id)

              if (!child.classList.contains('receive-target')) {
                lastFieldsetTreeId = child.id;
                break; // Found the last matching element, exit the loop
              }
            }

            if (lastFieldsetTreeId !== null) {
              log1('Last fieldset with id ending in -tree:', lastFieldsetTreeId);
            } else {
              log1('No matching fieldset with id ending in -tree found.');
            }
            log1(lastFieldsetTreeId)

            insertAfter(lastFieldsetTreeId, targetId, flag);
            iframeDocument.removeEventListener('click', clickRemoveButton);
            iframeDocument.addEventListener('mouseover', handleMouseOver);
          };
          addButton.addEventListener('mouseover', handleMouseOver1);
          addButton.addEventListener('mouseout', handleMouseOut1);
          parentWithAppendChild.appendChild(addButton);
        }
        iframeDocument.removeEventListener('mouseover', handleMouseOver);
        iframeDocument.addEventListener('click', clickRemoveButton);
        const newElement = getElementById1(sourceId);
        const newRect = newElement.getBoundingClientRect();
        window.scrollTo({
          top: newRect.top - originalRect.top + window.scrollY,
          behavior: 'auto' // You can use 'auto' or 'smooth' for smooth scrolling
        });
        // You can perform additional actions here if needed
      }

      function handleMouseOver1(e) {
        e.target.classList.add('drag-over'); // Add a class to apply hover effect
      }

      function handleMouseOut1(e) {
        e.target.classList.remove('drag-over'); // Remove the class to stop hover effect
      }



      // Example function, adjust as needed
      async function insertBefore(nextElementId, selectedElementId, flag) {
        const actionObject = {
          time: (new Date()).getTime(),
          action: 'InsertBefore',
          target_element: nextElementId.replace('-fieldset', '') + '-tree',
          inserted_element: { originalId: selectedElementId + '-tree', id: duplicateId(selectedElementId).id },
        };
        await pushAction(actionObject, false, flag);
        removeReceiveButtons();
      }

      // Example function, adjust as needed
      async function insertAfter(nextElementId, selectedElementId, flag) {
        const actionObject = {
          time: (new Date()).getTime(),
          action: 'InsertAfter',
          target_element: nextElementId.replace('-fieldset', '') + '-tree',
          inserted_element: { originalId: selectedElementId + '-tree', id: duplicateId(selectedElementId).id },
        };
        await pushAction(actionObject, false, flag);
        removeReceiveButtons();
      }

      // Example function, adjust as needed
      async function append(parentId, selectedElementId, flag) {
        // Perform additional actions if needed
        const actionObject = {
          time: (new Date()).getTime(),
          action: 'Append',
          target_element: parentId + '-tree',
          inserted_element: { originalId: selectedElementId + '-tree', id: duplicateId(selectedElementId).id },
        };
        await pushAction(actionObject, false, flag);
        removeReceiveButtons();
      }


      // Function to remove all elements with the class 'receive-target'
      function removeReceiveButtons() {
        const buttonsToRemove = querySelectorAll1('.receive-target');
        buttonsToRemove.forEach(button => {
          button.parentNode.removeChild(button);
        });
      }
      function moveItem(parentId, selectedElementId, action) {

        // Create a new element (adjust this part based on your requirements)

        // Perform additional actions if needed



        let lastFieldsetTreeId = null;
        let actionObject
        if (action === 'InsertAfter') {
          const children = getElementById1(parentId).children;

          for (let i = children.length - 1; i >= 0; i--) {
            const child = children[i];
            log1(child.id)
            if (child.tagName === 'FIELDSET' && child.id.endsWith('-fieldset')) {
              lastFieldsetTreeId = child.id;
              break; // Found the last matching element, exit the loop
            }
          }

          if (lastFieldsetTreeId !== null) {
            log1('Last fieldset with id ending in -tree:', lastFieldsetTreeId);
          } else {
            log1('No matching fieldset with id ending in -tree found.');
          }


          actionObject = {
            time: (new Date()).getTime(),
            action: action,
            target_element: [{ id: lastFieldsetTreeId.replace('-fieldset', '') + '-tree' }, { id: selectedElementId + '-tree' }],
            move: true,
          }
        }
        else {
          actionObject = {
            time: (new Date()).getTime(),
            action: action,
            target_element: [{ id: parentId.replace('-fieldset', '') + '-tree' }, { id: selectedElementId + '-tree' }],
            move: true,
          }
        }

        pushAction(actionObject);
        // Get a NodeList of all elements with the class 'receive-target'
        const buttonsToRemove = querySelectorAll1('.receive-target');

        // Iterate through the NodeList and remove each button
        buttonsToRemove.forEach(button => {
          button.parentNode.removeChild(button);
        });

      }

      // Utility function to add menu entry
      function findRelatedElements(inputId) {
        // Step 1: Remove the -tree suffix

        // Step 2: If it ends with -copy-x, remove that part
        let modifiedId = removeLastOccurrence(inputId, '-tree');
        const el = getElementById1(modifiedId + '-tree')
        log1('iiie ' + el.id)
        const tag = el.tagName.toLowerCase()
        const splited = modifiedId.split(';')
        const last = splited[splited.length - 1]
        const lastId = last.split(':')[0]
        splited.pop()
        modifiedId = [...splited, lastId].join(';')
        log1('modfi ' + modifiedId)
        // Step 3: Query for elements starting with the modified ID
        const selector = '[id^="' + modifiedId + '"]';
        const matchingElements = el.parentNode.querySelectorAll(selector);

        // Step 4: Filter to get only elements that end with -tree
        const filteredElements = Array.from(matchingElements)

        return Array.from(filteredElements).length
      }
      function addMenuEntry(menu, text, clickHandler, flag) {
        const entry = document.createElement('div');
        entry.className = 'menu-option';
        entry.innerHTML = text;
        entry.onclick = async (e) => {
          e.stopPropagation();
          await clickHandler(e);
          !flag && (menu.parentNode.style.display = 'none')
        };
        menu.appendChild(entry);
      }
      function saveT(event, previousValue) {
        const id = event.target.id + '-tree'
        const action = 'textContent'
        log1('ac' + action)



        const textareaValue = event.target.textContent;
        if (textareaValue === previousValue) {
          event.target.removeAttribute('contenteditable')
          return textareaValue
        }
        if (!textareaValue) {

          if (findRelatedElements(event.target.id) > 1) {
            pushAction({
              time: (new Date()).getTime(),
              action: 'removeTag',
              target_element: id,

            })
            const el = getElementById1(event.target.id + '-fieldset')
            if (el) {
              el.remove()
            }
          }
          else {
            log1('iiid ' + event.target.id)
            const attr = event.target.getAttribute('data-visual-defaultTextNode')
            log1('attr' + attr)
            event.target.textContent = attr
          }
          return
        }

        let el = {
          time: (new Date()).getTime(),
          action,
          target_element: id,
          value: textareaValue,

        }
        /*
        if (event.target.getAttribute('data-builder-time') === 'dd month yyyy') {
          function formatDate(date) {
            const options = { day: '2-digit', month: 'long', year: 'numeric' };
            const formattedDate = date.toLocaleDateString('en-US', options);
            return formattedDate;
          }
          function formatDateYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
          }
          const date = new Date()
          const fDate = formatDate(date)
          const fDate2 = formatDateYYYYMMDD(date)
          const el1 = {
            time: (new Date()).getTime(),
            action: 'setAttribute',
            target_element: id,
            key: 'datetime',
            value: fDate2,
 
          }
          pushAction(el1)
          el = {
            time: date.getTime(),
            action,
            target_element: id,
            value: fDate,
          }
        }
        */
        log1('ac' + JSON.stringify(el))
        pushAction(el)
        event.target.removeAttribute('contenteditable')
        return textareaValue
      }
      function onDoubleClick(e) {
        // Get the element that was double-clicked
        var target = e.target;
        log1('target ' + target.id)
        // Check if the element has the 'data-visual-contenteditable' attribute

        if (target.hasAttribute('data-visual-contenteditable')) {


          log1('has attr')
          // Prevent the default double-click behavior
          e.preventDefault();

          // Set the 'contenteditable' attribute to 'true', making the element editable
          target.setAttribute('contenteditable', 'true');

          // Reset the background color of the element
          target.style.backgroundColor = '';

          // Set focus on the editable element
          target.focus();

          let textContent = target.textContent
          target.addEventListener('blur', function (blurEvent) {
            // Call the saveT function when the element loses focus
            textContent = saveT(blurEvent, textContent)
          });
          target.addEventListener('keypress', function (keyPressEvent) {
            if (keyPressEvent.key === 'Enter') {
              keyPressEvent.preventDefault()
              textContent = saveT(keyPressEvent, textContent);
            }
          });
        }
      }
      iframeDocument.addEventListener('dblclick', onDoubleClick);
      // Add an event listener to the entire document to track double-clicks
      iframeDocument.addEventListener('contextmenu', handleContextMenu)
      iframeDocument.addEventListener('change', async function (event) {

        // Check if the target element has the data-visual-checkbox attribute
        if (event.target.hasAttribute('data-visual-checkbox')) {
          // Log the id of the target element and the new value of the checkbox
          log1('ID:', event.target.id, 'Value:', event.target.checked);
          let el
          if (event.target.checked) {
            el = {
              time: (new Date()).getTime(),
              action: 'setAttribute',
              target_element: event.target.id,
              key: "checked",
              value: 'true',

            }
          }
          else {
            el = {
              time: (new Date()).getTime(),
              action: 'removeAttribute',
              target_element: event.target.id,
              key: "checked"
            }
          }
          await pushAction(el)
        }
      });



      // Function to check if an element has the 'data-visual-draggable' attribute
      function isDraggable(element) {
        return element.hasAttribute('data-visual-draggable');
      }

      function handleDragStart(e) {
        if (isDraggable(e.target)) {

          log1('draggable');
          removeButtons()
          e.dataTransfer.setData('text/plain', e.target.id);
          const original = getElementById1(e.target.id);
          const originalRect = original.getBoundingClientRect();
          let siblingWithInsertBefore
          let parentWithAppendChild

          if (
            e.target.parentElement.id === e.target.id + '-fieldset') {
            // Check sibling for data-visual-insertBefore
            siblingWithInsertBefore = e.target.parentElement.parentElement && Array.from(e.target.parentElement.parentElement.children).filter(
              child => child.hasAttribute('data-visual-insertbefore') || (child.id.endsWith('-fieldset') && child.children[1].hasAttribute('data-visual-insertbefore'))
            );

            // Check if the parent has data-visual-appendchild
            parentWithAppendChild = e.target.parentElement.parentElement.hasAttribute('data-visual-appendchild') && e.target.parentElement.parentElement;

          }
          else {
            // Check sibling for data-visual-insertBefore
            siblingWithInsertBefore = e.target.parentElement && Array.from(e.target.parentElement.children).filter(
              child => child.hasAttribute('data-visual-insertbefore')
            );

            // Check if the parent has data-visual-appendchild
            parentWithAppendChild = e.target.parentElement.hasAttribute('data-visual-appendchild') && e.target.parentElement;
          }
          siblingWithInsertBefore.forEach(sibling => {
            // Create the "+" button element with data attributes
            const previousSibling = sibling.previousElementSibling;
            if (previousSibling && previousSibling.id.replace('-fieldset', '') === original.id) {
              return;
            }
            if (sibling.id.replace('-fieldset', '') === original.id) {
              return
            }
            const plusButton = createButton('InsertBefore', sibling.id);
            sibling.parentNode.insertBefore(plusButton, sibling);
            addHoverListeners(plusButton);
          });

          if (parentWithAppendChild && parentWithAppendChild.lastElementChild.id !== e.target.id + '-fieldset') {
            // Create the "+" button element with data attributes
            const plusButton = createButton('InsertAfter', parentWithAppendChild.id);
            parentWithAppendChild.appendChild(plusButton);
            addHoverListeners(plusButton);
          }
          const newElement = getElementById1(e.target.id);
          const newRect = newElement.getBoundingClientRect();
          log1(window.scrollY)
          log1(newRect.top)
          log1(originalRect.top)
          window.scrollTo({
            top: newRect.top - originalRect.top + window.scrollY,
            behavior: 'auto' // You can use 'auto' or 'smooth' for smooth scrolling
          });
          // Update the dragover and drop event listeners
          var iframe = getElementById1("generated-page-iframe");
          var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
          iframeDocument.addEventListener('dragover', handleDragOver);
          iframeDocument.addEventListener('drop', handleDrop);
        }
      }

      function createButton(action, elementId) {
        const plusButton = document.createElement('button');
        plusButton.className = 'receive-target';
        plusButton.innerHTML = '‚ûï';
        plusButton.setAttribute('data-action', action);
        plusButton.setAttribute('data-element-id', elementId);
        return plusButton;
      }

      function addHoverListeners(plusButton) {
        plusButton.addEventListener('dragenter', handleDragEnter);
        plusButton.addEventListener('dragleave', handleDragLeave);
      }


      function handleDrop(e) {
        e.preventDefault();

        const draggedElementId = e.dataTransfer.getData('text/plain');
        const targetElementId = e.target.getAttribute('data-element-id');
        const action = e.target.getAttribute('data-action');

        // Log the element id and target element id
        log1(`Element ID: ${draggedElementId}, Target Element ID: ${targetElementId} action ${action}`);
        if (targetElementId) {
          moveItem(targetElementId, draggedElementId, action)
        }

        // Remove the drag-over class from the target element
        if (e.target.classList.contains('receive-target')) {
          e.target.classList.remove('drag-over');
        }


        removeButtons()
        // Reset the dragover and drop event listeners
        document.removeEventListener('dragover', handleDragOver);
        document.removeEventListener('drop', handleDrop);
      }

      function removeButtons() {
        // Remove the "+" button after logging the information
        const plusButtons = querySelectorAll1('.receive-target');
        plusButtons.forEach(button => button.parentNode.removeChild(button));
      }

      function handleDragOver(e) {
        e.preventDefault();

        // Add the drag-over class to the target element
        if (e.target.classList.contains('receive-target')) {
          e.target.classList.add('drag-over');
        }
      }

      function handleDragEnter(e) {
        e.preventDefault();

        // Add the drag-over class to the target element
        if (e.target.classList.contains('receive-target')) {
          e.target.classList.add('drag-over');
        }
      }

      function handleDragLeave(e) {
        // Remove the drag-over class from the target element
        if (e.target.classList.contains('receive-target')) {
          e.target.classList.remove('drag-over');
        }
      }

      iframeDocument.addEventListener('dragstart', handleDragStart);
      visualOn = true
    }

    function processElement(element) {
      // Check if the element has the data-visual-draggable attribute
      if (element.hasAttribute("data-visual-draggable")) {
        // Apply draggable logic here
        element.draggable = true;
      }
      // Check if the element has the data-visual-border attribute
      if (element.hasAttribute("data-visual-border")) {
        // Create a new fieldset element
        var fieldset = document.createElement("fieldset");

        // Set the id of the fieldset to be the id of the original element + "-fieldset"
        fieldset.id = element.id + "-fieldset";
        fieldset.className = "tag-fs";

        // Create a legend element with the content of data-visual-title attribute
        var legend = document.createElement("legend");
        legend.className = "comment";
        legend.textContent = element.getAttribute("data-visual-title");

        // Append the legend to the fieldset
        fieldset.appendChild(legend);

        // Replace the current element with the new fieldset
        element.parentNode.replaceChild(fieldset, element);
        fieldset.appendChild(element);

        // Process nested children
        var nestedChildren = element.children;
        for (var i = 0; i < nestedChildren.length; i++) {
          processElement(nestedChildren[i]);
        }
      } else {
        // Process nested children if the element doesn't have the attribute
        var children = element.children;
        for (var i = 0; i < children.length; i++) {
          processElement(children[i]);
        }
      }
    }
    function handlePathSelection() {
      // Get the selected value from the pathSelector
      var selectedValue = getElementById1('pathSelector').value;
      log1(selectedValue)
      // Get the corresponding item based on the selected value
      var selectedItem = selectedValue

      // Handle the selected item as needed
      log1('Selected Item:', selectedItem);
      if (selectedItem === 'select' || selectedItem === undefined) {
        return
      }
      if (selectedItem === 'back') {
        if (path === '') {
          return
        }
        const splited = path.split('/')
        if (splited.length === 1) {
          loadFileList()
          return
        }
        splited.pop()
        path = splited.join('/')
        loadUsingPath()
        return
      }
      if (path === '') {
        path = selectedItem
      }
      else {
        path = path + '/' + selectedItem

      }
      log1(path)
      loadUsingPath()

    }
    function selectFile(event, fileId, name) {
      // Add logic to handle the selected file, if needed
      log1('File selected with ID:', fileId);
      var el = event.target;

      // Get the parent fieldset
      var fieldset = el.closest('fieldset');

      // Get the id and action attributes
      var fieldsetId = fieldset.id;
      var fieldsetAction = fieldset.getAttribute('action');

      // Log the id and action attributes (you can replace this with your desired logic)
      log1("Fieldset ID:", fieldsetId);
      log1("Fieldset Action:", fieldsetAction);
      const actionObject = {
        time: (new Date()).getTime(),
        action: 'Add_Component',
        subAction: fieldsetAction,
        target_element: fieldsetId.split(';')[1],
        inserted_component: { componentId: fileId, id: generateUUID() },
      };
      pushAction(actionObject);
      // Remove the parent fieldset
      fieldset.remove();
    }
    function loadFileList() {
      // Fetch GET request
      fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true')
        .then(response => response.json())
        .then(data => {
          // Replace existing file paths with dynamic content
          var fileListTable = getElementById1('code-tree-tag-attributes-form-attributes-list');
          fileListTable.innerHTML = '';

          let i = 0;
          data.items.forEach(item => {

            if (!lvls.includes(item.lsi1.split('/')[0])) {
              lvls.push(item.lsi1.split('/')[0])
            }
            if (i < 25) {
              i++
              // Clone the fieldset
              var newRow = fileListTable.insertRow();
              newRow.innerHTML = `
  <td><button onclick="selectFile(event,'${item.id}','${item.lsi1.split(';')[0]}')">‚úÖselect</button></td>
  <td>üìÇ ${item.lsi1}</td>
  <td><label>üß©</label></td>
`;
            }

          });

          // Show the cloned fieldsets
          querySelectorAll1('#filePathList fieldset').forEach(fieldset => {
            fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
          });



          // Update select options

        })
        .catch(error => console.error('Error:', error));

    }
    const loadUsingPath = () => {
      return fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true&lsi1=' + path)
        .then(response => response.json())
        .then(data => {
          // Replace existing file paths with dynamic content
          var fileListTable = getElementById1('code-tree-tag-attributes-form-attributes-list');
          fileListTable.innerHTML = '';
          lvls = []
          let i = 0
          data.items.forEach(item => {

            if (!lvls.includes(item.lsi1.replace(path + '/', '').split('/')[0])) {
              lvls.push(item.lsi1.replace(path + '/', '').split('/')[0])
            }
            if (i < 25) {
              i++
              var newRow = fileListTable.insertRow();
              newRow.innerHTML = `
  <td><button onclick="selectFile(event,'${item.id}')">‚úÖselect</button></td>
  <td>üìÇ ${item.lsi1}</td>
  <td><label>üß©</label></td>
`;
            }

          });

          // Show the cloned fieldsets
          querySelectorAll1('#filePathList fieldset').forEach(fieldset => {
            fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
          });



          // Update select options

        })
        .catch(error => console.error('Error:', error));
    }
    var memData = {}
    //third menu 
    const addNew = (e) => {
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('tag-table');

      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('tag-table')) {
        const clonedFieldset = fieldset.cloneNode(true);

        const clonedRows = clonedFieldset.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        for (let i = 0; i < clonedRows.length; i++) {
          const index = i; // Capture the current value of 'i' in a closure
          clonedRows[i].onclick = function (event) {
            chooseTag(index, event);
          };
        }
        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', e.target.parentNode.getAttribute('action'))
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
      }
    }
    const addExisting = (e) => {
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('code-tree-append-or-insert-approv-menu');
      const checked = e.target.parentNode.getAttribute('copiesOfInserting')
      const actionInReplace = e.target.parentNode.getAttribute('actionInReplace')
      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('code-tree-append-or-insert-approv-menu')) {
        const clonedFieldset = fieldset.cloneNode(true);
        actionInReplace && (clonedFieldset.setAttribute('actionInReplace', 'true'))
        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        const action = e.target.parentNode.getAttribute('action')
        clonedFieldset.setAttribute('action', action)
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
        // Get all fieldsets with data-element="code-tree-tag"
        var codeTreeTagFieldsets = querySelectorAll1('fieldset[data-element="code-tree-tag"]');
        var checkbox1 = clonedFieldset.querySelector('#code-tree-menu-copies-too');
        var checkbox2 = clonedFieldset.querySelector('#code-tree-menu-dublicate-with-parent-option');

        checkbox1.addEventListener('change', (e) => {
          checkbox1.checked ? checkbox2.parentNode.removeAttribute('hidden') : checkbox2.parentNode.setAttribute('hidden', '')
        })
        /*
        if (checkbox1 && action === 'InsertBefore') {
clonedFieldset.querySelector('#code-tree-menu-dublicate-with-parent-option-1').setAttribute('hidden', "");
clonedFieldset.querySelector('#code-tree-menu-dublicate-with-parent-option-2').setAttribute('hidden', "");
checkbox1.setAttribute('hidden', "");
        }*/
        // Iterate through each fieldset and make their checkboxes visible
        codeTreeTagFieldsets.forEach(function (fieldset) {
          var checkbox = fieldset.querySelector('input[type="checkbox"]');
          if (checkbox) {
            checkbox.removeAttribute('hidden');
          }
        });
      }

    }
    const choseComponent = async (e) => {
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('code-tree-tag-attributes-form');

      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('code-tree-tag-attributes-form')) {
        const clonedFieldset = fieldset.cloneNode(true);

        clonedFieldset.id = clonedFieldset.id + ';' + parentId;

        clonedFieldset.setAttribute('action', e.target.parentNode.getAttribute('action'))
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        await loadFileList()
        e.target.parentNode.remove()
        // Get all fieldsets with data-element="code-tree-tag"

      }
    }


    const generateReview = async (heading, date, name, stars, ip, message) => {
      const h = querySelectorAll1('[data-builder-review-heading]')[0]
      h.textContent = heading
      const d = querySelectorAll1('[data-builder-review-time]')[0]
      d.textContent = date
      const n = querySelectorAll1('[data-builder-review-author]')[0]
      n.textContent = name
      const s = querySelectorAll1('[data-builder-review-rating]')[0]
      s.textContent = stars
      const i = querySelectorAll1('[data-builder-review-author-ip]')[0]
      i.textContent = ip
      const m = querySelectorAll1('[data-builder-review-message]')[0]
      m.textContent = message
      for (const e of [h, d, n, s, i, m]) {
        if (!e) {
          continue
        }
        const el = {
          time: (new Date()).getTime(),
          action: 'textContent',
          target_element: e.id + '-tree',
          value: e.textContent,

        }

        await pushAction(el)
      }
    }
    const runScripts = () => {
      const scripts = querySelectorAll1("[data-builder-script]")
      for (const script of scripts) {
        try {
          eval(script.innerHTML)
        }
        catch (e) {
          console.log(e.message)
        }

      }
    }
    const organizeScripts = async () => {

      if (!pathItem.hub_items?.scripts) {
        pathItem.hub_items.scripts = {
          onOpen: [],
          onLoad: [],
          onPublish: [],
          onClick: [],
          notActive: [{ "name": "script_head_placeholders_transfer" }, { "name": "script_head_transfer" }, { "name": "scrip_eval" }, { "name": "script_breadcrumb_generation" }, { "name": "script_transfer" }, { "name": "script_product_spec_table" }, { "name": "script_article_table_of_contents" }, { "name": "script_cleaner" }, { "name": "script_generate_product_json" }, { "name": "script_generate_article_anchor" }]
        }
        await updatePathItem()
      }
      if (headContentItem && !headContentItem.scripts) {
        headContentItem.scripts = {}
        updateHeadContentItem()
      }
      if (pathItem.hub_items?.gpt) {
        await showai(pathItem.hub_items?.gpt)
        const res = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${pathItem.id}&sk=ai-logs:&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(e => e.json())
        if (res.items.length) {
          const element = document.getElementById('ai-logs')
          //element.removeAttribute('hidden')
          element.querySelector('textarea').value = res.items.map(el => JSON.stringify(el.gptResponse, null, 2) + '\n\n' + JSON.stringify(el.task) + '\n\n' + JSON.stringify(el.content) + '\n\n').join('\n\n=============================================\n\n')
        }
      }
      for (const key of Object.keys(pathItem.hub_items?.scripts)) {
        if (!pathItem.hub_items?.scripts[key]) {
          continue
        }
        sortQueue(pathItem.hub_items?.scripts[key])
        const body = document.getElementById(getBodyIdFromType(key))
        for (const item of (pathItem.hub_items?.scripts?.[key] || [])) {
          const { name, execute_on_red_checkbox, execute_requires_reload, execute_in_template, queue_number } = item;
          const runned = headContentItem?.scripts[name]?.runned;
          log1('runned :' + runned)
          const appItem = document.getElementById(name);

          if (appItem) {
            const red = appItem.querySelector('#execute_on_red_checkbox')
            if (red) {
              red.checked = !!execute_on_red_checkbox;
              red.onchange = (e) => {
                // Handle onchange event for execute_on_red_checkbox
                const checked = e.target.checked
                item.execute_on_red_checkbox = checked
                updatePathItem()
              };

            }

            const rReload = appItem.querySelector('#execute_requires_reload')
            if (rReload) {
              rReload.checked = !!execute_requires_reload;
              rReload.onchange = (e) => {
                // Handle onchange event for execute_requires_reload
                const checked = e.target.checked
                item.execute_requires_reload = checked
                updatePathItem()
              };
            }

            const inT = appItem.querySelector('#execute_in_template')
            if (inT) {
              inT.checked = !!execute_in_template;
              inT.onchange = async (e) => {
                // Handle onchange event for execute_in_template
                const checked = e.target.checked
                item.execute_in_template = checked
                log1('updating')

                await updatePathItem()
              };
            }
            const queueN = appItem.querySelector('#queue_number')
            if (queueN) {
              queueN.textContent = queue_number || '1';
              queueN.onblur = (e) => {
                // Handle onblur event for execute_in_template
                const t = e.target.textContent;
                item.queue_number = parseInt(t);
                updatePathItem();
              };
            }
            const scriptS = appItem.querySelector('#script_status')
            const lastExec = appItem.querySelector('#last_script_execute_time')
            if (runned) {
              lastExec.textContent = formatDate(new Date(runned))
              scriptS.textContent = 'üü¢'
            }

            let r
            scriptS.onclick = async () => {
              if (r) {
                return
              }
              r = true
              scriptS.textContent = 'üü†'
              await funcDictionary[name]()

              const date = new Date()
              if (headContentItem.scripts[name]) {
                headContentItem.scripts[name].runned = date.getTime()
              }
              else {
                headContentItem.scripts[name] = { runned: date.getTime() }
              }
              lastExec.textContent = formatDate(date)
              await updateHeadContentItem()
              scriptS.textContent = 'üü¢'
              r = false
            }





            body.append(appItem);
          }
        }

      }
    }
    var generateSchema = (head) => {
      const url = pathItem.lsi1.split(';')[0].replace('|', '/')
      const date = new Date()
      if (url.startsWith('Core.SeoSitesHome.com')) {
        return
      }
      const generatedPage = getElementById1('generated-page')
      const schemas = querySelectorAll1('script[data-transfer-receiver]')

      //sku 

      const combinations = pathItem.combinations
      const forms = querySelectorAll1('[data-product-attribute-form]');
      //const priceItems = querySelectorAll1('[data-builder-cart="price"]')

      for (const schema of schemas) {
        const receiverName = schema.getAttribute('data-transfer-receiver')
        let json = JSON.parse(schema.textContent)
        log1('INPUT SCHEMA ' + schema.textContent)
        // Start traversing the JSON object
        /*
        if (combinations === 1 || forms.length === 1) {
          const prices = Array.from(priceItems[0].children).map(e => parseInt(e.textContent)).filter(e => e)
          delete json['offers-aggregate']
          json['offers-single'] && (json.offers = { ...json['offers-single'], price: Math.min(...prices), url: getPageUrl(url) })
          delete json['offers-single']
        }
        else {
          let prices = []
          for (const el of priceItems) {
            prices.push(...Array.from(el.children).map(e => parseInt(e.textContent)))
          }
          prices = prices.filter(e => e)
          log1('prices' + JSON.stringify(prices))
          delete json['offers-single']
          json['offers-aggregate'] && (json.offers = { ...json['offers-aggregate'], lowPrice: Math.min(...prices), highPrice: Math.max(...prices), offerCount: combinations, url: getPageUrl(url) })
          delete json['offers-aggregate']
 
        }*/
        traverseJSONAndUpdate(json, '', receiverName, date, head);

        json = cleanJson(json)
        // After updating, stringify the JSON object and assign it back to the text content of the schema element
        schema.textContent = JSON.stringify(json, null, 2);
        log1('OUTPUT SCHEMA JSON ' + JSON.stringify(json))
      }
      const tags = querySelectorAll1('[data-transfer-receiver]')
      for (const tag of tags) {
        if (tag.tagName.toLowerCase() !== 'script') {
          const receiver = tag.getAttribute('data-transfer-receiver');
          const link = pathItemPath.replace(';publish:published', '').toLowerCase()
          if (receiver === "canonical" && link.endsWith('/hub')) {
            const splited = link.split('/')
            splited.pop()
            if (splited[splited.length - 1] === 'home') {
              splited.pop()
            }
            let nLink = splited[0]
            if (splited.length > 1) {
              nLink = splited.join('/') + '/'
            }

            tag.setAttribute('href', "https://" + nLink)

          }
          const senders = querySelectorAll1(`[data-transfer-sender^="${receiver}."]`, head);
          const senders2 = querySelectorAll1(`[data-transfer-sender-href^="${receiver}."]`, head);
          const senders3 = querySelectorAll1(`[data-transfer-sender-src^="${receiver}."]`, head);
          const senders4 = querySelectorAll1(`[data-transfer-sender-innerhtml^="${receiver}."]`, head);
          if (senders.length) {
            for (const sender of senders) {
              const textContent = sender.textContent;
              const attr = sender.getAttribute('data-transfer-sender').replace(receiver + '.', '');
              if (attr === 'text-content') {
                tag.textContent = textContent
              } else {
                tag.setAttribute(attr, textContent);
              }

            }

          }
          if (senders2.length) {
            for (const sender of senders2) {
              const textContent = sender.getAttribute("href");
              log1('sender2')
              const attr = sender.getAttribute('data-transfer-sender-href').replace(receiver + '.', '');
              if (attr === 'text-content') {
                tag.textContent = textContent
              } else {
                tag.setAttribute(attr, textContent);
              }

            }

          }
          if (senders3.length) {
            for (const sender of senders3) {
              const textContent = sender.getAttribute('src');
              const attr = sender.getAttribute('data-transfer-sender-src').replace(receiver + '.', '');
              if (sender.hasAttribute('data-builder-image-name')) {
                log1('iiin55555')
                const name = sender.getAttribute('data-builder-image-name')
                const e = 'https://' + link.toLowerCase() + '/' + name + '.' + textContent.split('.').pop()
                tag.setAttribute(attr, e);
                continue
              }
              if (attr === 'text-content') {
                tag.textContent = textContent
              } else {
                tag.setAttribute(attr, textContent);
              }

            }

          }
          if (senders4.length) {
            for (const sender of senders4) {
              const html = sender.innerHTML;
              log1('sender4')
              tag.innerHTML = html
              tag.querySelectorAll('[data-b=""]').forEach(e => e.remove())
              tag.querySelectorAll('[data-b-value=""]').forEach(e => e.remove())
              tag.childNodes.forEach(child => removeAttributesStartingWith(child, toRemove.removeAttributesStartWith))
            }

          }
        }

      }
    }
    const add_import_row = async (event, item, name1, name2) => {
      console.log('adding row 1')
      const row = document.querySelector('#import2-row[hidden]')
      const cloned = row.cloneNode(true)
      const spanName = cloned.querySelector('#import-name')
      const spanComponent = cloned.querySelector('#import-component')
      const saveButton = cloned.querySelector('#saveImportButton')
      const textArea = cloned.querySelector('#saveImportText')


      cloned.removeAttribute('hidden')
      if (name1) {
        item = {
          id: generateUUID(),
          name: name1,
          component: name2
        }
        if (pathItem.hub_items?.import_items) {

          pathItem.hub_items.import_items.push(item)


        }
        else {
          pathItem.hub_items.import_items = [item]
        }
        updatePathItem()
      }
      if (item) {
        spanName.textContent = item.name
        spanComponent.textContent = item.component

      }
      else {
        item = {
          id: generateUUID()
        }
      }
      const removeButton = cloned.querySelector('#saveImportButton')
      removeButton.onclick = async (e) => {
        pathItem.hub_items.import_items = pathItem.hub_items.import_items.filter(e => e.id !== item.id)

        await updatePathItem()
        cloned.remove()
      }
      const toggle = cloned.querySelector('#import-menu-2')
      toggle.addEventListener('toggle', async function () {
        if (toggle.open) {
          // Code to execute when details are opened
          const value = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${headContentItem.id}:import:${item.id}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              // Add any additional headers if needed
            },
          });
          const item1 = await value.json()
          console.log(item1)
          if (item1) {
            console.log(item1.value)
            textArea.value = item1.value
          }
          // Add your additional actions here
        } else {
          // Code to execute when details are closed
          console.log('Details closed');
          // Add your actions for when details are closed (if needed)
        }
      });
      saveButton.onclick = async (e) => {

        const v = textArea.value

        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 7);

        // Convert the date to ISO 8601 format (required by DynamoDB)
        const ttl = Math.floor(tomorrow.getTime() / 1000);
        const body = {
          id: headContentItem.id,
          sk: `import:${item.id}`,
          value: v,
          ttl

        }
        if (!v) {
          await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${body.id}:${body.sk}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              // Add any additional headers if needed
            },
          });
          return
        }
        const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          body: JSON.stringify(body),
        });
      }

      cloned.querySelector('#import_toggle').onclick = async (e) => {
        const { target } = e
        if (target.textContent === 'üü†') {
          return
        }
        target.textContent = 'üü†'
        const absolutePath = getAbsolutePath(pathItemPath, item.componentPath)
        url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${absolutePath}&token=${localStorage.getItem('token')}`;

        const res = await fetch(url).then(res => res.json())
          .then(async ({ items }) => {
            return items[0]

          })

        const compid = res.id
        const value = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${headContentItem.id}:import:${item.id}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            // Add any additional headers if needed
          },
        });
        const item1 = await value.json()
        console.log(item1)
        let data
        if (item1) {
          console.log(item1.value)
          data = item1.value
        }
        else {
          data = textArea.value
        }


        //clean
        const eventData1 = { url: `https://webdev983.github.io/templatesv3/component.html?id=${compid}&cleanAttr=${item.name}&ownerid=${localStorage.getItem('ownerid')}` };
        console.log('event ' + eventData1.url)
        // Fetch options
        const options0 = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(eventData1)
        };
        await fetch(pup_url, options0);
        const currentDate = new Date();

        // Add one day to the current date
        const tomorrow = new Date(currentDate);
        tomorrow.setDate(currentDate.getDate() + 1);

        // Convert the date to ISO 8601 format (required by DynamoDB)
        const ttl = Math.floor(tomorrow.getTime() / 1000);
        const db = {
          id: generateUUID(),
          sk: 'import',
          ttl,
          data,
        }
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(db),
        });

        const eventData = { url: `https://webdev983.github.io/templatesv3/component.html?id=${compid}&attr=${item.name}&val=${db.id}&ownerid=${localStorage.getItem('ownerid')}` };
        console.log('event ' + eventData.url)
        // Fetch options
        const options = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(eventData)
        };
        const response = await fetch(pup_url, options);
        target.textContent = 'üü¢'

      }
      row.parentNode.append(cloned)
      return item


    }
    var imports1 = []
    const handleImportMenu2 = async () => {
      const splited = pathItemPath.split('/')
      splited.pop()
      const fpath = splited.join('/') + '/'
      const response2 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${fpath}`);
      const data2 = await response2.json();
      console.log('imp1' + JSON.stringify(imports1))
      let imports2 = []
      if (imports1.length) {
        imports2 = imports1.map(item => {
          console.log(JSON.stringify(item))
          const found = data2.items.find(e => e.lsi1.split(';')[0].split('|')[1] === item.component)
          const compLsi1 = found.lsi1.split(';')[0]
          const currentLsi = pathItemPath.replace(';publish:published', "")
          const relativePath = getRelativePath(currentLsi, convertToOldPath(compLsi1));
          return { ...item, componentPath: relativePath, id: generateUUID() }
        })
      }
      console.log('imp2 ' + JSON.stringify(imports2))
      const row = getElementById1('import2-row')

      if (pathItem.hub_items?.import_items?.length) {
        const filtered = imports2.filter(e => !pathItem.hub_items?.import_items.find(item => item.componentPath === e.componentPath && item.name === e.name))
        pathItem.hub_items?.import_items.push(...filtered)
      }
      else {
        pathItem.hub_items.import_items = imports2
      }
      console.log('imp2 ' + JSON.stringify(pathItem.hub_items?.import_items))
      await updatePathItem()
      for (let i = 0; i < pathItem.hub_items.import_items.length; i++) {
        const item = pathItem.hub_items?.import_items[i]
        await add_import_row(undefined, item)
      }

    }
    const handleMenus = async () => {
      const table = document.getElementById('menu_toggle')
      if (!pathItem.hub_items) {
        pathItem.hub_items = { menus: {} }
      }
      if (!pathItem.hub_items.menus) {
        pathItem.hub_items.menus = {}
      }
      const loadStatus = document.getElementById('menus_load_status')
      loadStatus.textContent = 'üü†'
      if (pathItem.hub_items?.menus?.lists_tasks_toggle) {
        document.getElementById('lists-task-json').removeAttribute('hidden')
      }
      if (pathItem.hub_items?.menus?.chatgpt_task_toggle) {
        document.getElementById('chatgpt-task-json').removeAttribute('hidden')
      }
      if (pathItem.hub_items?.menus?.sku_menu_toggle) {
        document.getElementById('sku-menu').removeAttribute('hidden')
        document.getElementById('sku-menu2').removeAttribute('hidden')
      }


      if (pathItem.hub_items?.menus?.chatgpt_logs_toggle) {
        document.getElementById('ai-logs').removeAttribute('hidden')
      }
      if (pathItem.hub_items?.menus?.scripts_menu_toggle) {
        document.getElementById('scripts-list').removeAttribute('hidden')
        await organizeScripts()
      }
      table.querySelectorAll('tr').forEach(element => {
        const id = element.id
        const status = element.querySelector('#menu_toggle_status')
        if (pathItem.hub_items?.menus?.[id]) {

          status.textContent = 'üü¢'
        }

        status.onclick = async () => {
          pathItem.hub_items.menus[id] = pathItem.hub_items.menus[id] ? false : new Date().getTime()

          const listName = element.getAttribute('data-list-menu')
          /*
          if (listName) {
            const listItem = document.getElementById(listName)
            pathItem.hub_items[id] ? listItem.removeAttribute('hidden') : listItem.setAttribute('hidden')
          }*/
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(
              pathItem
            ),
          });
          if (pathItem.hub_items.menus[id]) {

            status.textContent = 'üü¢'

          }
          else {
            status.textContent = 'üî¥'
          }
        }

      })
      loadStatus.textContent = 'üü¢'
    }
    const funcDictionary = {
      script_head_placeholders_transfer: replacePlaceHolders,
      script_head_transfer: () => generateSchema(true),
      scrip_eval: runScripts,
      script_breadcrumb_generation: generateBreadCrumbApi,
      script_transfer: generateSchema,
      script_product_spec_table: async () => {

        await generateTableSpecApi()
      },
      script_article_table_of_contents: async () => {
        const headingElements = querySelectorAll1('[data-table-of-contents-heading]')
        const textContents = Array.from(headingElements).map(e => e.textContent)
        await generateTableApi(textContents)
      },
      script_cleaner: () => { },
      script_generate_product_json: () => { },
      script_generate_article_anchor: generateAnchorApi,
      script_chatgpt_: () => { },
      script_refresh_catalog: refreshCatalogue,
      script_sku_data_to_html: skuToHtmlApi
    }
    const onLoad = async () => {
      log1('onload')
      const onLoad = pathItem.hub_items?.scripts?.onLoad
      const body = document.getElementById(getBodyIdFromType('onLoad'))
      if (!onLoad) {
        log1('no onload')
        return
      }
      for (const item of onLoad) {
        if (!item.execute_in_template && pathItem.lsi1.toLowerCase().includes('seositeshome.com')) {
          continue
        }
        const item1 = body.querySelector('#' + item.name)
        const status = item1.querySelector('#script_status')
        if (status.textContent === 'üü¢' && item.execute_on_red_checkbox) {
          continue
        }
        log1('name ' + item.name)
        try {
          await funcDictionary[item.name]()
        }
        catch (e) {
          continue
        }

        status.textContent = 'üü¢'
        const date = new Date()
        const { name } = item
        if (headContentItem.scripts[name]) {
          headContentItem.scripts[name].runned = date.getTime()
        }
        else {
          headContentItem.scripts[name] = { runned: date.getTime() }
        }
        item1.querySelector('#last_script_execute_time').textContent = formatDate(date)
        if (item.execute_requires_reload) {
          reload = true
        }
      }
      await updateHeadContentItem()
    }
    async function onOpen1() {
      const onOpen = pathItem.hub_items?.scripts?.onOpen
      onOpen && sortQueue(onOpen)
      const body = document.getElementById(getBodyIdFromType('onOpen'))
      if (!onOpen) {
        return
      }
      for (const item of onOpen) {
        if (!item.execute_in_template && pathItem.lsi1.toLowerCase().includes('seositeshome.com')) {
          continue
        }
        const item1 = body.querySelector('#' + item.name)
        console.log(item1.id)
        const status = item1.querySelector('#script_status')
        if (status.textContent === 'üü¢' && item.execute_on_red_checkbox) {
          continue
        }
        await funcDictionary[item.name]()

        item1.querySelector('#script_status').textContent = 'üü¢'
        const date = new Date()
        const { name } = item
        if (headContentItem.scripts[name]) {
          headContentItem.scripts[name].runned = date.getTime()
        }
        else {
          headContentItem.scripts[name] = { runned: date.getTime() }
        }
        item1.querySelector('#last_script_execute_time').textContent = formatDate(date)
        if (item.execute_requires_reload) {
          reload = true
        }

      }
      await updateHeadContentItem()



    }
    const onPublish = async () => {
      const onPublish = pathItem.hub_items?.scripts?.onPublish
      const body = document.getElementById(getBodyIdFromType('onPublish'))
      let cleanHtml, generateProductJson
      if (!onPublish) {
        return {}
      }
      for (const item of onPublish) {
        if (!item.execute_in_template && pathItem.lsi1.toLowerCase().includes('seositeshome.com')) {
          continue
        }
        const item1 = body.querySelector('#' + item.name)
        const status = item1.querySelector('#script_status')
        if (status.textContent === 'üü¢' && item.execute_on_red_checkbox) {
          continue
        }
        if (item.name === 'script_generate_product_json') {
          generateProductJson = true

        }
        else if (item.name === "script_cleaner") {
          cleanHtml = true

        }
        else { await funcDictionary[item.name]() }


        item1.querySelector('#script_status').textContent = 'üü¢'
        const date = new Date()
        const { name } = item
        if (headContentItem.scripts[name]) {
          headContentItem.scripts[name].runned = date.getTime()
        }
        else {
          headContentItem.scripts[name] = { runned: date.getTime() }
        }
        item1.querySelector('#last_script_execute_time').textContent = formatDate(date)
        if (item.execute_requires_reload) {
          reload = true
        }
      }
      await updateHeadContentItem()
      return { cleanHtml, generateProductJson }
    }
    const onClick = async (name) => {
      const onClick = pathItem.hub_items?.scripts?.onClick
      const body = document.getElementById(getBodyIdFromType('onClick'))
      if (!onClick) {
        return
      }
      const item = onClick.find(e => e.name === name)
      if (!item.execute_in_template && pathItem.lsi1.toLowerCase().includes('seositeshome.com')) {
        return
      }
      await funcDictionary[item.name]()
      const item1 = body.querySelector('#' + item.name)
      item1.querySelector('#script_status').textContent = 'üü¢'
      const date = new Date()
      if (headContentItem.scripts[name]) {
        headContentItem.scripts[name].runned = date.getTime()
      }
      else {
        headContentItem.scripts[name] = { runned: date.getTime() }
      }
      item1.querySelector('#last_script_execute_time').textContent = formatDate(date)

      await updateHeadContentItem()

    }

    async function loadFirst() {
      var iframe = getElementById1("generated-page-iframe");

      // Wait for the iframe to load completely
      await new Promise(resolve => {
        iframe.addEventListener("load", resolve);

      });
      var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
      const lastActionTime = getElementById1('last-action-time');
      lastActionTime.addEventListener('dblclick', function () {
        // Handle double-click event here
        log1('Double-clicked on the button');
        // Add your custom logic for double-click handling
      });
      const loadingScreen = getElementById1('loading');
      loadingScreen.style.display = 'flex';
      const timerElement = getElementById1('timer');
      let tenthsOfSeconds = 0;
      const interval = setInterval(function () {
        tenthsOfSeconds++;
        timerElement.textContent = (tenthsOfSeconds / 10).toFixed(1);
      }, 100);
      const urlParams = new URLSearchParams(window.location.search);
      const idFromQuery = urlParams.get('id');
      const toPublish = urlParams.get('publish')
      const generatetable = urlParams.get('generatetable')
      const generatebreadcrumb = urlParams.get('generatebreadcrumb')
      const generateSpec = urlParams.get('generatespec')
      const generateAnchorHref = urlParams.get('generateanchor')
      const importAttribute = urlParams.get('attr')
      const cleanAttribute = urlParams.get('cleanAttr')
      const clean = urlParams.get('clean')
      const importValue = urlParams.get('val')
      const message = urlParams.get('message')
      const generateHtmlFromSku = urlParams.get('generateHtmlFromSku')
      ownerid = localStorage.getItem('ownerid') || urlParams.get('ownerid')
      if (urlParams.get('ownerid')) {
        localStorage.setItem('executionToggle', 'true')
      }
      if (idFromQuery) {
        // Change the id of the element with id "component-element"
        const compTree = getElementById1('components-tree')
        const component_el = getElementById1('component-element')
        const newEl2 = component_el.cloneNode(true)
        newEl2.id = idFromQuery + '-tree'
        compTree.append(newEl2)

        const builderElement = getElementById1('63ae5927-390f-4391-993d-b25ab09c8ada');
        if (builderElement) {
          builderElement.id = idFromQuery;
        }

        // Change the text content of the button with data-element "code-tree-tag-name-button"
        const componentNameButton = document.querySelector('[data-element="code-tree-tag-name-button"]');
        if (componentNameButton) {
          componentNameButton.innerText = `üß©${idFromQuery}`;
        }
        //get pathItem
        const responseData = await getRes(idFromQuery, true)
        const { items } = responseData
        pathItem = items.find(e => e.sk === 'path')
        //converst lsi1 to old
        pathItemPath = convertToOldPath(pathItem.lsi1)
        site1 = pathItemPath.split('/')[0]
        if (generatebreadcrumb) {
          await Promise.all(items.filter(e => e.action && e.action !== 'Add_Component').map(item => {
            return fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item.id}:${item.sk}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
                // Add any additional headers if needed
              },
            });
          }))
        }
        //get head content
        if (!pathItemPath.split('/').includes('Stock')) {
          const headLsi = pathItem.lsi1.split(';')[0].split('|')[0].split('/').slice(0, 3).join('/') + '/Content/Page|Head-Content'

          log1('head lsi' + headLsi)
          const url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${headLsi}`;
          await fetch(url).then(res => res.json())
            .then(async ({ items }) => {
              if (!items.length) {
                return
              }
              log1(JSON.stringify(items))
              headContentItem = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${items[0].id}:${items[0].sk}`).then(re => re.json())
              headContentItem.id = items[0].id
              log1('head content item' + JSON.stringify(headContentItem))
              pathItemSku = headContentItem.sku
            })
        }
        else {
          pathItemSku = pathItem.sku
        }
      }
      await handleMenus()
      try {
        await onOpen1()
      }
      catch (e) {
        console.log(e.message)
      }
      await loadFromDb()
      if (pathItem.hub_items?.menus?.import_menu_toggle) {
        document.getElementById('import-menu-2').removeAttribute('hidden')
        await handleImportMenu2()
      }
      clearInterval(interval);
      lastActionTime.textContent = timerElement.textContent;
      loadingScreen.style.display = 'none';
      if (updateComponentsMap) {
        const componentsIds = Object.keys(cache)
        const response1 = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ id: idFromQuery, sk: 'componentsMap', items: componentsIds }),
        });

      }
      await handleHead()
      await handleSelectedDependeeChange()
      await handleDependency()
      await handleWebPageMenu()
      //await handleTableGeneration()
      await handleBreadCrumbStatus()
      //await handleSpecStatus()
      await handleItemLink()
      //dispatch event
      await handleImportMenu()

      setHubItems()


      document.querySelectorAll('[data-file-name-show]').forEach(
        element => {
          const p = element.getAttribute('data-file-name-show')
          if (pathItemPath.split(';')[0].includes(p)) {
            element.removeAttribute('hidden')
          }
        }
      )

      //await runScripts()
      try {
        await onLoad()

      }
      catch (e) {
        console.log(e.message)
      }
      if (toPublish || republish) {
        console.log('publishing')
        await publish()
      }
      const imagePs = imagesIds.map(async (imageId) => {
        const element = getElementById1(imageId)
        if (!element) {
          return
        }
        if (pathItemPath.split(';')[0].endsWith('/Main-Content') && !element.hasAttribute('srcset') && element.hasAttribute('data-src')) {
          setSrcSet(element)
        }
        const flag = await fetch('https://api.allorigins.win/raw?url=' + element.getAttribute('src'))
          .then(async response => {
            if (response.ok || response.status === 200) {
              const t = await response.text()
              if (t.includes('404')) {
                log1('image doesnt exist')
                republish = true
                return true
              }
              else {
                log1('Image exists.');
              }

            } else {
              log1('image doesnt exist')
              republish = true
              return true
            }
          })
          .catch(error => {
            console.error('Error checking image existence:', error);

            republish = true
            return true
          });
        if (!flag) {
          return
        }
        const site = pathItemPath.split('/')[0]

        const nsrc = element.getAttribute('src')
        const splited = nsrc.split('/')
        const last = splited[splited.length - 1]
        const [name, ext] = last.split('.')
        const splited2 = name.split('_')
        const randomString = splited2.shift
        const res = splited2.pop()
        const uuid = element.getAttribute('data-builder-image-source')
        const panelSrc = `https://s3.amazonaws.com/checkout-admin-panel/pics${uuid}.${ext}`
        const defaultRes = element.getAttribute('data-builder-image-default')
        splited.splice(0, 3)
        splited.pop()
        const body = {
          site,

          name: randomString + '_' + splited2.join('_'),
          imageSrc: panelSrc,
          defaultRes,
          pagePath: splited.join('/')
        }
        const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/resize', {
          method: 'POST',
          body: JSON.stringify(body),
        });
      }
      )
      await Promise.all(imagePs)

      if (generatetable) {
        await generateTable(generatetable)
      }
      if (generateHtmlFromSku) {
        await skuToHtml(generateHtmlFromSku)
      }
      if (generatebreadcrumb) {
        await generateBreadCrumb()
      }
      if (generateSpec) {
        await generateTableSpec(generateSpec)
      }
      if (cleanAttribute) {
        await cleanImport(cleanAttribute)
      }
      if (clean) {
        await cleanImport()
      }
      if (importAttribute) {
        await handleImportGpt(importValue, importAttribute)
      }
      if (message) {
        const ip = urlParams.get('ip')
        const stars = urlParams.get('stars')
        const name = urlParams.get('name')
        const date = urlParams.get('date')
        const heading = urlParams.get('heading')
        await generateReview(heading, date, name, stars, ip, message)
      }
      if (generateAnchorHref) {
        await generateAnchor(generateAnchorHref)
      }
      //const pagePathContent = pathItemPath;
      if (reload) {
        location.reload()
      }
      // Use the textContent as needed, for example, log it to the console
      log1('Publishing:', pathItemPath);
      //generateSchema(pagePathContent.split(';')[0], new Date())


      const event = new CustomEvent("pageloaded")
      document.dispatchEvent(event)
      console.log('pageloaded')


      //first menu
      let buttons = querySelectorAll1('button[data-element="code-tree-tag-name-button"]');
      /*
      buttons.forEach(function (button) {
        button.addEventListener('click', e => loader(e, handleComponentClick));
      });*/

      log1(timerElement.textContent)
      if (localStorage.getItem('visualOn')) {

        getElementById1('transform').click()
      }
    }

    var actionLog = []
    var selected = []
    var components = []
    function toggleSubFields(event) {
      // Get the clicked button and its content
      const button = event.target;
      const buttonContent = button.innerHTML;

      // Get the parent fieldset
      const parentFieldset = button.closest('fieldset[data-element="code-tree-tag"]');

      if (parentFieldset) {
        // Find all sub fieldsets inside the parent fieldset
        const subFieldsets = parentFieldset.querySelectorAll('fieldset[data-element="code-tree-tag"]');

        // Check if there are sub fieldsets
        if (subFieldsets.length > 0) {
          // Toggle the visibility of sub fieldsets
          subFieldsets.forEach(subFieldset => {
            subFieldset.hidden = !subFieldset.hidden;
          });

          // Toggle the button content
          button.innerHTML = buttonContent === '‚Üí' ? '‚Üì' : '‚Üí';
        }
      }
    }
    function handleCheckboxChange(event) {
      var checkbox = event.target;
      var fieldsetId = checkbox.parentNode.id;

      if (checkbox.checked) {
        // Add the ID to the selected array
        selected.push(fieldsetId);
      } else {
        // Remove the ID from the selected array
        var index = selected.indexOf(fieldsetId);
        if (index !== -1) {
          selected.splice(index, 1);
        }
      }

      // Update the content of the span with the length of the selected array
      var amountSelectedSpan = getElementById1('code-tree-amount-selected-for-append-or-insert');
      if (amountSelectedSpan) {
        amountSelectedSpan.textContent = selected.length;
      }

      // Log the selected array (you can replace this with your desired logic)
      log1("Selected Fieldsets:", selected);
      var arrowButton = checkbox.parentNode.querySelector('[data-element="code-tree-show-hide-button"]');
      if (checkbox.checked) {
        arrowButton.textContent = '‚Üì';
      }
      else {
        arrowButton.textContent = '‚Üí';
      }
      // Hide all subfieldsets and enable their checkboxes
      hideSubFieldsets(checkbox.parentNode, checkbox.checked);
    }
    function hideSubFieldsets(parentFieldSet, hide) {
      // Get all fieldsets with data-element="code-tree-tag" under the specified parent
      var subFieldsets = parentFieldSet.querySelectorAll('fieldset[data-element="code-tree-tag"]');

      // Iterate through each subfieldset and toggle visibility
      subFieldsets.forEach(function (subFieldset) {
        // Toggle visibility using the hidden attribute
        subFieldset.hidden = hide;

        // Enable or disable the checkbox based on the hide parameter
        var subCheckbox = subFieldset.querySelector('input[type="checkbox"]');
        if (subCheckbox) {
          subCheckbox.disabled = false;
        }

        // If hiding, remove the subFieldsetId from the selected array
        if (hide) {
          var subFieldsetId = subFieldset.id;
          var index = selected.indexOf(subFieldsetId);
          if (index !== -1) {
            selected.splice(index, 1);
          }
        }


      });
    }
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0,
          v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    async function deleteAction(e) {

      event.preventDefault();

      // Access the parent element of the clicked button
      const parentRow = event.target.closest('tr');
      const parenttooltip = event.target.closest('div');



      if (parentRow) {
        // Find the span with id "code-log-action-time" within the parent element
        //delete action from db
        deleteActionFromDb(parentRow)
        parentRow.remove();
        parenttooltip.remove();

      }


      //regenerate page
    }
    function deleteActionFromLog(row) {
      row.remove()
      //add remove to next
    }
    async function deleteActionFromDb(parentRow) {
      const actionTimeElement = parentRow.querySelector('#code-log-action-time');

      if (actionTimeElement) {
        // Retrieve the action time value
        const actionTime = actionTimeElement.getAttribute('sk');

        // Construct the URL for the delete request
        const urlSearchParams = new URLSearchParams(window.location.search);
        const id = urlSearchParams.get('id');
        const deleteUrl = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${id}:${actionTime}`;

        try {
          // Send the delete request using the fetch API
          const response = await fetch(deleteUrl, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              // Add any additional headers if needed
            },
            // You can include a request body if necessary
            // body: JSON.stringify({ action: actionName }),
          });

          if (response.ok) {
            // Delete was successful, you can handle the response or perform additional actions
            positionItem.positions = positionItem.positions.filter(e => e !== actionTime)
            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(positionItem),
            });
            log1('Action deleted successfully');
          } else {
            // Delete request failed, handle the error
            console.error('Error deleting action:', response.statusText);
          }
        } catch (error) {
          // An error occurred while processing the request
          console.error('Error:', error.message);
        }
      }
    }
    function insertAfter(newNode, referenceNode) {
      if (referenceNode.nextSibling) {
        referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
      } else {
        referenceNode.parentNode.appendChild(newNode);
      }
    }
    let frozen = false
    let errored = false
    const pushAction = async (element, firstLoad, visual, replaceActions, containerId, noComp1, noSubComp1, lvl, removeActions, replaceId, componentPath, pathForRelative, reusableId, attachId) => {
      log1('pushed' + JSON.stringify(element))
      const time = element.time
      log1('time' + time)
      actionLog.push(element)
      !firstLoad && await pushActionToDb(element)
      try {
        if (element.action !== 'Replace_Component') {
          let ac = element.action
          if (ac === "Add_Component") {
            if (element.inserted_component.componentId.startsWith('*')) {
              ac = "Add_Component_Absolute"
            }
            else if (element.inserted_component.componentId.startsWith('#')) {
              ac = "Add_Component_Relative"
            }
            else {
              ac = "Add_Component_Id"
            }
          }
          await insertDataIntoCodeLog(time, ac, element.options, undefined, element, reusableId)
        }
        if (element.options?.frozen) {
          frozen = true
        }
        if (!frozen && !errored && (localStorage.getItem('executionToggle'))) {
          await executeCommand(element, '', visual, replaceActions, containerId, noComp1, noSubComp1, lvl, removeActions, replaceId, componentPath, pathForRelative, reusableId, attachId)

        }

      }

      catch (e) {
        //throw e
        if (!errored) {
          console.log('\tname: ' + e.name + ' message: ' + e.message + ' at: ' + e.at + ' text: ' + e.text);
          log1(e.stack);
          const codeLog = getElementById1("code-log-body");
          const query = `#code-log-action-time[sk="${element.time}"]`
          log1(query)
          codeLog.querySelector(query).classList.add('action-error');
          openLeftPanel()
        }

        errored = true


      }
    }
    const pushActionToDb = async (action) => {
      const urlSearchParams = new URLSearchParams(window.location.search);
      const id = urlSearchParams.get('id');
      const sk = action.time.toString()
      delete action.time
      const payload = { ...action, sk, id };
      positionItem.positions.push(payload.sk)

      actions.push(payload)
      // Send a POST request using fetch
      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(positionItem),
      });

      // Ensure the request was successful (status code 2xx)
      if (!response.ok) {
        throw new Error(`Failed to push action to the database. Status: ${response.status}`);
      }

      // Parse and log the response or handle it as needed
      //const responseData = await response.json();
    }
    function formatEpochTime(epoch) {
      // Convert epoch time to milliseconds
      const date = new Date(parseInt(epoch));

      // Get the day, month, year, hours, and minutes
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear();
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');

      // Format the date string
      const formattedDate = `${day}.${month}.${year} ${hours}:${minutes}`;

      return formattedDate;
    }
    const searchLogs = (event) => {
      const value = event.target.value.toLowerCase()
      log1(value)
      const codeLog = getElementById1("code-log-body");
      const searchCodeLog = getElementById1("code-log-search-body");
      if (value === "") {
        searchCodeLog.setAttribute('hidden', '')
        codeLog.removeAttribute('hidden')
      }
      else if (value.length > 1) {
        codeLog.setAttribute('hidden', '')
        searchCodeLog.removeAttribute('hidden')
        searchCodeLog.querySelectorAll("#code-log-element:not([hidden])").forEach(e => e.remove())
        const filteredActions = actions.filter(item => item.action.toLowerCase().includes(value) ||
          item.id.toString().includes(value) ||
          item.key?.toLowerCase().includes(value) ||
          item.value?.toLowerCase().includes(value) ||
          item.target_element?.toLowerCase().includes(value) ||
          item.inserted_element?.id.toLowerCase().includes(value))
        for (const action of filteredActions) {
          const originalElement = searchCodeLog.querySelector("#code-log-element");
          const actionTime = action.sk
          let emoji = ""
          const optionsStrings = []
          if (action.options) {

            options.apply_to_copies && optionsStrings.push('‚úÖ‚ßâ Apply to copies')
            options.insert_copies && optionsStrings.push('üöÇ‚ßâ Insert Copies')
            options.dub_target && optionsStrings.push('üéØ‚ßâ Dup Target')
            options.selfuse && optionsStrings.push('üéØ‚ßâ Self use')
            options.reusable && optionsStrings.push('üéØ‚ßâ Reuse id:' + options.reusable)
            options.position && optionsStrings.push('üéØ child ' + options.position)



            if (optionsStrings.length === 2) {
              emoji = '2Ô∏è‚É£'
            }
            else if (optionsStrings.length === 3) {
              emoji = '3Ô∏è‚É£'
            } else if (optionsStrings.length === 1) {
              emoji = '1Ô∏è‚É£'
            }

          }
          const clonedElement = originalElement.cloneNode(true);
          clonedElement.removeAttribute('hidden')
          clonedElement.querySelector("#code-log-action-time").textContent = formatEpochTime(actionTime);
          clonedElement.querySelector("#code-log-action-time").setAttribute('sk', actionTime)
          clonedElement.querySelector("#code-log-action").textContent = action.action + emoji;
          const parent = originalElement.parentNode;
          if (action?.inserted_element?.tagName) {
            optionsStrings.push(` üÜî ${action.inserted_element?.id} `)
            optionsStrings.push(` üè∑Ô∏è ${action?.inserted_element?.tagName} `)
          }
          if (action?.key) {
            optionsStrings.push(` üîë ${action?.key} `)
          }
          if (action?.value || action?.insertedCode) {
            optionsStrings.push(` ü™£ ${action?.value || action?.insertedCode} `)
          }
          if (action?.insertedCode) {
            optionsStrings.push(` ü™£ ${action?.insertedCode}  `)
          }
          if (action?.inserted_component) {
            optionsStrings.push(` üÜî ${action.inserted_component.componentId}`)
          }
          if (action?.tag_change) {
            optionsStrings.push(`ü™£ ${action?.tag_change}  `)
          }
          if (action?.tagName) {
            optionsStrings.push(`ü™£ ${action?.tagName}  `)
          }
          if (action?.target_element) {
            if (typeof action.target_element === 'string') {
              optionsStrings.push(` Target ${action.options?.attachId || action.target_element.replace('-tree', '')}`)
            }
            else {
              const e = action.target_element.map(el => el.id)
              e.shift()
              optionsStrings.push(` Target ${action.target_element[0].id.replace('-tree', '')},Elements: ${e.join(',')}`)
            }

          }

          //clonedElement.querySelector("#code-log-action").setAttribute('data-tooltip', optionsStrings.join('&#013;&#010;'))
          clonedElement.querySelector("[data-action-data]").innerHTML = optionsStrings.join('<br>')

          // Insert the cloned element before the original element
          parent.insertBefore(clonedElement, originalElement);
        }
      }
    }
    const originalOptionsEl = document.querySelector('#action-options[original=""]')
    function moveStringAfter(array, stringToMove, afterString) {
      const currentIndex = array.indexOf(stringToMove);
      const afterIndex = array.indexOf(afterString);

      // If any of the strings are not found, or if the afterString is not found, return the original array
      if (currentIndex === -1 || afterIndex === -1) {
        return array;
      }

      // Remove the string to move from the array
      const removedString = array.splice(currentIndex, 1)[0];

      // Find the new index to insert the string after the specified string
      const insertIndex = afterIndex + 1;

      // Insert the string after the specified string
      array.splice(insertIndex, 0, removedString);

      return array;
    }
    function moveStringBefore(array, stringToMove, beforeString) {
      const currentIndex = array.indexOf(stringToMove);
      const beforeIndex = array.indexOf(beforeString);

      // If any of the strings are not found, or if the beforeString is not found, return the original array
      if (currentIndex === -1 || beforeIndex === -1) {
        return array;
      }

      // Remove the string to move from the array
      const removedString = array.splice(currentIndex, 1)[0];

      // Find the new index to insert the string before the specified string
      const insertIndex = beforeIndex;

      // Insert the string before the specified string
      array.splice(insertIndex, 0, removedString);

      return array;
    }

    // Example usage:
    const positions = ["string1", "string2", "string3", "string4"];
    const updatedPositions = moveStringBefore(positions, "string4", "string2");
    log1(updatedPositions); // Output: ["string1", "string4", "string2", "string3"]
    var scriptClicked
    var removeScriptClicked
    function getTypeFromCheckbox(checkbox) {
      // Get the parent tbody element of the checkbox
      const tbody = checkbox.closest('tbody');

      // Check if the parent tbody exists
      if (tbody) {
        // Get the id of the parent tbody
        const bodyId = tbody.id;

        // Determine the type based on the body id
        let type;
        switch (bodyId) {
          case 'on_open_body':
            type = 'onOpen';
            break;
          case 'on_load_body':
            type = 'onLoad';
            break;
          case 'on_publish_body':
            type = 'onPublish';
            break;
          case 'on_click_body':
            type = 'onClick';
            break;
          case 'not_active_body':
            type = 'notActive';
            break;
          default:
            console.error('Invalid body id:', bodyId);
            return null; // Or you can return a default type or throw an error
        }

        // Return the type
        return type;
      } else {
        // Handle case where parent tbody is not found
        console.error('Parent tbody not found for checkbox');
        return null; // Or you can return a default type or throw an error
      }
    }
    function getBodyIdFromType(type) {
      // Convert the type to lowercase and replace any uppercase characters with underscores
      const bodyId = type.replace(/[A-Z]/g, match => `_${match.toLowerCase()}`);

      // Append "_body" to the converted type
      return `${bodyId}_body`;
    }
    function sortQueue(arrayOfObjects) {
      arrayOfObjects.sort((a, b) => {
        // If both elements have falsy (except 0) queue_number, retain the original order
        if (!a.queue_number && a.queue_number !== 0 && !b.queue_number && b.queue_number !== 0) {
          return 0;
        }
        // If a has falsy (except 0) queue_number, place it after b
        else if (!a.queue_number && a.queue_number !== 0) {
          return 1;
        }
        // If b has falsy (except 0) queue_number, place it after a
        else if (!b.queue_number && b.queue_number !== 0) {
          return -1;
        }
        // Otherwise, compare numbers
        else {
          return a.queue_number - b.queue_number;
        }
      });
    }

    async function addScript(event, type) {
      const element = document.getElementById('head-menus')
      element.querySelectorAll('#script_execute_select').forEach(checkbox => {
        checkbox.removeAttribute('hidden')

      })
      if (scriptClicked) {
        let items = pathItem.hub_items?.scripts
        if (!items) {
          items = {
            onOpen: [],
            onLoad: [],
            onPublish: [],
            onClick: [],
            notActive: [{ "name": "script_head_placeholders_transfer" }, { "name": "script_head_transfer" }, { "name": "scrip_eval" }, { "name": "script_breadcrumb_generation" }, { "name": "script_transfer" }, { "name": "script_product_spec_table" }, { "name": "script_article_table_of_contents" }, { "name": "script_cleaner" }, { "name": "script_generate_product_json" }, { "name": "script_generate_article_anchor" }, { "name": "script_chatgpt_" }]
          }
        }
        element.querySelectorAll('#script_execute_select').forEach(checkbox => {
          if (checkbox.checked) {
            const id = checkbox.closest('tr').id;
            const type1 = getTypeFromCheckbox(checkbox); // Assuming you have a function to determine the type

            const index = items[type1].findIndex(item => item.name === id);
            if (index !== -1) {
              // Remove the item from notActive array and push it to the appropriate type array
              const removedItem = items[type1].splice(index, 1)[0];
              items[scriptClicked].push(removedItem);
              sortQueue(items[scriptClicked])
            }
            else {
              items[scriptClicked].push({ name: id });
            }
            const existing = checkbox.closest('tr')

            existing.querySelector('#script_status').onclick = async () => {
              await funcDictionary[id]()
              existing.querySelector('#script_status').textContent = 'üü¢'
              const date = new Date()
              headContentItem.scripts[id].runned = date.getTime()
              existing.querySelector('#last_script_execute_time').textContent = formatDate(date)
              updateHeadContentItem()
            }

            document.getElementById(getBodyIdFromType(scriptClicked)).append(existing)
          }
          checkbox.setAttribute('hidden', '');
          checkbox.checked = false
        });

        pathItem.hub_items.scripts = items
        await updatePathItem()

      }


      scriptClicked = scriptClicked ? undefined : type
    }

    async function removeScriptStatus(event, type) {
      const element = document.getElementById('head-menus')
      element.querySelectorAll('#script_execute_select').forEach(checkbox => {
        checkbox.removeAttribute('hidden')

      })
      if (removeScriptClicked) {
        let items = pathItem.hub_items?.scripts
        if (!items) {
          return

        }
        element.querySelectorAll('#script_execute_select').forEach(async checkbox => {
          if (checkbox.checked) {
            const id = checkbox.closest('tr').id;

            delete headContentItem.scripts[id]?.runned
            await updateHeadContentItem()
            checkbox.parentNode.querySelector('#script_status').textContent = 'üî¥'

          }
          checkbox.setAttribute('hidden', '');
          checkbox.checked = false
        });

        pathItem.hub_items.scripts = items
        await updatePathItem()

      }


      removeScriptClicked = removeScriptClicked ? undefined : type
    }

    function insertDataIntoCodeLog(actionTime, actionName, options, inserted_component, element, reusableId) {
      const codeLog = getElementById1("code-log-body");
      const originalElement = codeLog.querySelector("#code-log-element[hidden]");
      const clonedElement = originalElement.cloneNode(true);
      clonedElement.removeAttribute('hidden')
      clonedElement.setAttribute('sk', actionTime)
      //clonedElement.id = 'code-log-element;'+ actionTime
      // Remove the unwanted button from the cloned element
      const removeButtonCell = originalElement.querySelector("[data-type-code-log='action-remove']");
      if (removeButtonCell) {
        //removeButtonCell.parentNode.removeChild(removeButtonCell);
      }

      // Set the content and attributes for the cloned element
      clonedElement.removeAttribute("hidden");
      const actionTimeEl = clonedElement.querySelector("#code-log-action-time")
      actionTimeEl.textContent = formatEpochTime(actionTime);
      actionTimeEl.setAttribute('sk', actionTime)
      let emoji = ""
      originalElement.parentNode.insertBefore(clonedElement, originalElement);
      clonedElement.querySelector('#move-button').onclick = (e) => {
        document.querySelectorAll('#code-log-element').forEach(element => {
          const anchor = element.getAttribute('sk')
          if (anchor !== actionTime.toString()) {
            const move = element.querySelector('[data-move-actions]')
            if (!move.hasAttribute('hidden')) {
              move.setAttribute('hidden', '')

              return
            }
            move.removeAttribute('hidden')
            if (!move) {
              log1(element.getAttribute('sk'))
              return
            }
            const afterB = move.querySelector('[data-move-after]')
            afterB && (afterB.onclick = async (e) => {
              positionItem.positions = moveStringBefore(positionItem.positions, actionTime, anchor)
              await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(
                  positionItem
                ),
              });
              //document.querySelectorAll('[data-move-actions]').forEach(e=>e.setAttribute('hidden',''))
              insertAfter(clonedElement, element)
              document.querySelectorAll('#code-log-element').forEach(element1 => {
                const move = element1.querySelector('[data-move-actions]')
                move.setAttribute('hidden', '')
              })

            })
            const beforeB = move.querySelector('[data-move-before]')
            beforeB && (beforeB.onclick = async (e) => {
              positionItem.positions = moveStringBefore(positionItem.positions, actionTime, anchor)
              await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(
                  positionItem
                ),
              });
              //document.querySelectorAll('[data-move-actions]').forEach(e=>e.setAttribute('hidden',''))
              clonedElement.parentNode.insertBefore(clonedElement, element)
              document.querySelectorAll('#code-log-element').forEach(element1 => {
                const move = element1.querySelector('[data-move-actions]')
                move.setAttribute('hidden', '')
              })

            })

          }
        })
      }
      const actionData = clonedElement.querySelector("[data-action-data]")
      actionData.innerHTML = ''
      let optionEl
      if (options) {
        let optionNumber = 0
        const cloned = originalOptionsEl.cloneNode(true)
        cloned.removeAttribute('original')
        const freeze = cloned.querySelector('#action-option-free')
        freeze.remove()
        if (!options.apply_to_copies) {
          cloned.querySelector('#action-apply-target-copies').remove()
        }
        else {
          optionNumber++
        }
        if (options.frozen) {
          actionTimeEl.classList.add('action-frozen')
          optionNumber++
        }
        if (!options.insert_copies) {
          cloned.querySelector('#action-apply-moving-copies').remove()
        } else {
          optionNumber++
        }
        if (!options.dub_target) {
          cloned.querySelector('#action-dub-target').remove()
        } else {
          optionNumber++
        }
        if (!options.fork) {
          cloned.querySelector('#action-fork-id').remove()
        } else {
          cloned.querySelector('#action-fork-id-value').textContent = options.fork
          optionNumber++
        }
        if (!options.selfuse) {
          cloned.querySelector('#action-self-use-component').remove()
        } else {
          optionNumber++
        }
        if (!options.actionInReplace) {
          cloned.querySelector('#action-in-replace').remove()
        } else {
          optionNumber++
        }
        const reuseItem = cloned.querySelector('#action-reuse-id')
        if (options.reusable) {
          optionNumber++
          reuseItem.querySelector('#action-reuse-id-value').textContent = options.reusable

        }
        else {
          reuseItem.remove()
        }
        const positionItem = cloned.querySelector('#action-append-position')
        if (options.position) {
          optionNumber++
          positionItem.querySelector('#action-append-position-value').textContent = options.position

        }
        else {
          positionItem.remove()
        }

        optionNumber && (optionEl = cloned)

        if (optionNumber === 2) {
          emoji = '2Ô∏è‚É£'
        }
        else if (optionNumber === 3) {
          emoji = '3Ô∏è‚É£'
        } else if (optionNumber === 1) {
          emoji = '1Ô∏è‚É£'
        }

      }
      const r = options?.reusable ? options.reusable + '|' : ''
      const originalTargetElement = document.getElementById('action-target')
      const buttonsContainer = clonedElement.querySelector('[data-action-buttons]')
      const menu = buttonsContainer.querySelector('[data-action-button-menu]')
      if (element?.inserted_component) {
        log1('iiiiiiiiiiin0')
        const a = clonedElement.querySelector("#code-log-action")
        a.textContent = 'üß©' + '{name}' + emoji;
        a.setAttribute('log-id', r + element.inserted_component.id)
        //const optionString = ` üÜî ${element.inserted_component.componentId}<br>Target ${options?.attachId || element.target_element.replace('-tree', '')}<br>${optionsStrings.join('<br>')}`;
        const addAction = document.getElementById('component-action-add')
        const cloned = addAction.cloneNode(true)
        const linkType = cloned.querySelector('#action-add-component-link-type')
        const cId = element.inserted_component.componentId
        if (cId.startsWith('#') || cId.startsWith('*') || cId.startsWith('$')) {
          linkType.textContent = element.inserted_component.componentId
        }
        else {
          linkType.textContent = 'id'
        }
        cloned.querySelector('#action-add-component-id').textContent = cId

        actionData.append(cloned)

        actionData.setAttribute('data-log-id', r + element.inserted_component.id)


        const cloned2 = originalTargetElement.cloneNode(true)


        if (options?.attachId) {
          let id1 = removeLastOccurrence(options.attachId, '-tree')
          log1(id1)
          const el11 = getElementById1(id1)
          !el11 && (id1 = 'body')
          cloned2.querySelector('#action-target-tag-id-value').textContent = id1
          cloned2.querySelector('#action-target-tag-name-value').textContent = getElementById1(id1).tagName.toLowerCase()
        } else {
          cloned2.querySelector('#action-target-tag-id').remove()
        }
        //cloned2.querySelector('#action-target-tag-name-value').textContent = 
        actionData.append(cloned2)
        const clonedChangeComponent = document.getElementById('change-component').cloneNode(true)
        clonedChangeComponent.removeAttribute('hidden')

        const clonedChangeSelfUse = document.getElementById('change-self-use').cloneNode(true)
        clonedChangeSelfUse.removeAttribute('hidden')

        const originalChangeMenu = document.getElementById('change-adding-component')
        clonedChangeSelfUse.onclick = async (e) => {
          element.options.selfuse = !element.options.selfuse
          const payload = { ...element }
          delete payload.time
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          });
        }
        clonedChangeComponent.onclick = (e) => {


          if (!menu.children.length) {
            const cloned = originalChangeMenu.cloneNode(true)
            cloned.removeAttribute('hidden')
            menu.append(cloned)


            let initialValue = clonedElement.querySelector('#action-add-component-link-type').textContent
            initialValue === "id" && (initialValue = element.inserted_component.componentId)
            // Set the value of cloned.querySelector('#new-component-input')


            // Set the selected option of cloned.querySelector('#change_link_type')
            let selectedOptionValue = '';
            log1('initial ' + initialValue[0])
            switch (initialValue[0]) {
              case '*': selectedOptionValue = 'absolute'; break;
              case '#': selectedOptionValue = 'relative'; break;
              case '$': selectedOptionValue = 'content'; break;
              default: selectedOptionValue = ''; break;
            }
            log1(selectedOptionValue)
            cloned.querySelector('#new-component-input').value = initialValue

            // Set the selected option in the dropdown
            const selectElement = cloned.querySelector('#change_link_type');
            for (let i = 0; i < selectElement.options.length; i++) {
              if (selectElement.options[i].id === selectedOptionValue) {
                selectElement.selectedIndex = i;
                log1('selected index' + i)
                break;
              }
            }
            cloned.querySelector('#save-new-component').onclick = async (e) => {
              const value = cloned.querySelector('#new-component-input').value
              const selectElement = cloned.querySelector('#change_link_type')

              // Get the selected option
              const selectedOption = selectElement.options[selectElement.selectedIndex].id;
              let prefix = ""
              switch (selectedOption) {
                case "absolute": prefix = '*'; break;
                case "relative": prefix = '#'; break;
                case "content": prefix = '$'; break;
                default: break;
              }
              const compId = prefix + value
              element.inserted_component.componentId = compId
              const payload = { ...element }
              delete payload.time
              await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
              });
              cloned.remove()

            }
          }

        }
        buttonsContainer.insertBefore(clonedChangeComponent, menu)
        buttonsContainer.insertBefore(clonedChangeSelfUse, menu)
        //clonedElement.querySelector('[data-action-data]').innerHTML = optionString;


      }
      else {



        clonedElement.querySelector("#code-log-action").textContent = actionName + emoji;
        const tagAction = document.getElementById('tag-action')
        if (actionName === "Replace_Component") {
          const originalReplace = document.getElementById('replace-action')
          const cloned = originalReplace.cloneNode(true)
          actionData.append(cloned)
          const targetId = element.target_element[0]
          const target = cloned.querySelector('[data-target]')
          target.querySelector('#replaced-component-id-value').textContent = targetId
          target.setAttribute('replace-names', targetId)
          const folder = cloned.querySelector('#replace-action-folder')
          if (element.folders?.length) {
            folder.querySelector('#replace-action-folder-link-value').textContent = element.folders[0]
          }
          else {
            folder.remove()
          }
          const comps = cloned.querySelector('#new-replace-components-list')
          const comp1 = comps.querySelector('#new-replace-component')
          for (let i = 1; i < element.target_element.length; i++) {
            const cloned1 = comp1.cloneNode(true)
            cloned1.querySelector('#new-replace-component-name-value').textContent = element.target_element[i].path.split('|')[1]
            cloned1.querySelector('#new-replace-component-path-value').textContent = element.target_element[i].path
            cloned1.querySelector('#new-replace-component-id-value').textContent = element.target_element[i].componentId
            comps.append(cloned1)
          }
          comp1.remove()

        }
        else {
          if (element?.key) {
            //optionsStrings.push(` üîë ${element?.key} `)
            let cloned
            if (element.key === 'class') {
              const classItem = document.getElementById('class-action')
              cloned = classItem.cloneNode(true)
              cloned.querySelector('#class-action-value').textContent = `${element.key}="${element.value}"`

            }
            else {
              const attItem = document.getElementById('attriute-action')
              cloned = attItem.cloneNode(true)
              const v = cloned.querySelector('#attriute-action-value')
              if (element.value) {
                v.textContent = `${element.key}="${element.value}"`
              }
              else {
                v.textContent = element.key
              }

            }
            actionData.append(cloned)
          }
          if (element?.inserted_element?.tagName) {
            const cloned = tagAction.cloneNode(true)
            cloned.querySelector('#tag-action-tag-name').textContent = element?.inserted_element.tagName.toLowerCase()
            cloned.querySelector('#tag-action-tag-id').textContent = element.inserted_element?.id
            cloned.querySelector('#tag-action-created').removeAttribute('hidden')
            cloned.querySelector('#tag-action-moved').remove()
            actionData.append(cloned)
          }
          if (element?.inserted_element?.originalId) {
            const copyTag = document.getElementById('copy-tag-action')
            const cloned = copyTag.cloneNode(true)
            cloned.querySelector('#copy-id-value').textContent = removeLastOccurrence(element?.inserted_element?.id, '-tree')

            actionData.append(cloned)
          }
          const getTagName = (element) => {
            const id = element.id.replace('-tree', '')
            if (element.replaced) {
              const first = querySelectorAll1(`[id^="${id.split(':')[0]}"]`).find(e => !e.id.endsWith('-tree'))
              return first?.tagName?.toLowerCase()
            }
            return getElementById1(id)?.tagName.toLowerCase()
          }
          if (element?.target_element) {

            const cloned = originalTargetElement.cloneNode(true)
            actionData.append(cloned)
            if (typeof element.target_element === 'string') {
              //optionsStrings.push(` Target ${options?.attachId || element.target_element.replace('-tree', '')}`)
              let id1 = element.target_element.replace('-tree', '')
              let tag
              if (options?.apply_to_copies) {

                tag = querySelectorAll1(`[id^="${id1}"]`).find(e => !e.id.endsWith('-tree')).tagName.toLowerCase()
              } else {
                tag = getElementById1(id1)?.tagName.toLowerCase()
              }
              cloned.querySelector('#action-target-tag-id-value').textContent = id1


              cloned.querySelector('#action-target-tag-name-value').textContent = tag
            }
            else {
              const e = element.target_element.map(el => {

                return removeLastOccurrence(el.id, '-tree').split(':')[0]
              })
              e.shift()
              const id1 = element.target_element[0].id.replace('-tree', '')
              cloned.querySelector('#action-target-tag-id-value').textContent = id1
              cloned.querySelector('#action-target-tag-name-value').textContent = getTagName(element.target_element[0])


              const cloned2 = tagAction.cloneNode(true)
              log1('prob545 ' + element.target_element[0].replaced)
              cloned2.querySelector('#tag-action-tag-id').textContent = e[0]
              cloned2.querySelector('#tag-action-tag-name').textContent = getTagName(element.target_element[1])
              for (let i = 1; i < e.length; i++) {
                const group = cloned2.querySelector('#moved-tag')
                const cloned3 = group.cloneNode(true)
                cloned3.querySelector('#tag-action-tag-id').textContent = e[i]
                cloned3.querySelector('#tag-action-tag-name').textContent = getTagName(element.target_element[i + 1])
                group.parentNode.append(cloned3)
              }
              cloned2.querySelector('#tag-action-created').remove()
              actionData.append(cloned2)
            }

          }





          if (element?.value && !element?.key) {
            //optionsStrings.push(` ü™£ ${element?.value || element?.insertedCode} `)
            const tc = document.getElementById('tc-action')
            const cloned = tc.cloneNode(true)
            actionData.insertBefore(cloned, actionData.firstChild)
            const v = document.getElementById('innerhtml-textcontent-action-content')
            const cloned2 = v.cloneNode(true)
            cloned2.querySelector('#innerhtml-textcontent-action-content-value').textContent = element?.value
            actionData.append(cloned2)

          }
          if (element?.insertedCode) {
            const tc = document.getElementById('innerhtml-action')
            const cloned = tc.cloneNode(true)
            actionData.insertBefore(cloned, actionData.firstChild)
            const v = document.getElementById('innerhtml-textcontent-action-content')
            const cloned2 = v.cloneNode(true)
            cloned2.querySelector('#innerhtml-textcontent-action-content-value').textContent = element?.insertedCode
            actionData.append(cloned2)
          }
          if (element?.tag_change) {
            const ct = document.getElementById('change-tag-action')
            const cloned = ct.cloneNode(true)
            cloned.querySelector('#change-tag-action-value').textContent = element.tag_change
            actionData.append(cloned)

          }
        }
        /*
        if (element?.tagName) {
          optionsStrings.push(`ü™£ ${element?.tagName}  `)
        }*/


        //clonedElement.querySelector("#code-log-action").setAttribute('data-tooltip', optionsStrings.join('&#013;&#010;'))
        //clonedElement.querySelector("[data-action-data]").innerHTML = optionsStrings.join('<br>')

      }
      optionEl && actionData.append(optionEl)
      // Get the parent of the original element

      //change target
      buttonsContainer.querySelector('#change-target').onclick = async (e) => {
        if (!menu.children.length) {
          const original = document.getElementById('change-target-id-menu')
          const cloned = original.cloneNode(true)
          cloned.removeAttribute('hidden')
          let current
          if (typeof element.target_element === "string") {
            current = element.target_element.replace('-tree', '')
          }
          else {
            current = element.target_element[0].replace('-tree', '')
          }
          cloned.querySelector('#save-new-target-input').textContent = current
          var codeTreeTagFieldsets = querySelectorAll1('fieldset[data-element="code-tree-tag"]');


          const save = async (e) => {
            const t = cloned.querySelector('#save-new-target-input').value
            if (element?.inserted_component) {
              element.options.attachId = t + '-tree'
            }
            else if (typeof element.target_element === "string") {
              element.target_element = t + '-tree'
            }
            else {
              element.target_element[0] = t + '-tree'
            }
            const payload = { ...element }
            delete payload.time
            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(payload),
            });
            cloned.remove()
            codeTreeTagFieldsets.forEach(function (fieldset) {
              var checkbox = fieldset.querySelector('input[type="checkbox"]');
              if (checkbox) {
                checkbox.setAttribute('hidden', 'true');
              }
            });

          }
          codeTreeTagFieldsets.forEach(function (fieldset) {
            var checkbox = fieldset.querySelector('input[type="checkbox"]');
            if (checkbox) {
              checkbox.removeAttribute('hidden');
              checkbox.onclick = (e) => {
                cloned.querySelector('#save-new-target-input').value = checkbox.parentNode.id.replace('-tree', '')
                save()
              }
            }
          });
          cloned.querySelector('#save-new-target').onclick = save
          menu.append(cloned)
        }

      }
      buttonsContainer.querySelector('#freeze').onclick = async (e) => {
        const payload = { ...element }
        delete payload.time
        if (payload.options) {
          payload.options.frozen = !payload.options.frozen
        }
        else {
          payload.options = { frozen: true }
        }
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });
      }
      // Insert the cloned element before the original element

    }
    function removeTextNodes(element) {
      for (let i = 0; i < element.childNodes.length; i++) {
        const node = element.childNodes[i];
        if (node.nodeType === Node.TEXT_NODE) {
          element.removeChild(node);
        }
      }
    }
    let pauseExecution = false
    const fixCommand = async (command,) => {
      let newCommand
      let fixed
      log1('wrong append')
      log1(JSON.stringify(command))
      const missing = getElementById1('target_element_missing')
      const cloned = missing.cloneNode(true)
      getElementById1('code-tree').append(cloned)
      const fixIn = cloned.querySelector('#fix-in-component')
      const newTarget = cloned.querySelector('#set-new-target')
      const remove = cloned.querySelector('#remove-command')
      if (command.id === pathItem.id) {
        fixIn.setAttribute('hidden', '')
        const codeTreeTagFieldsets = querySelectorAll1('fieldset[data-element="code-tree-tag"]');
        codeTreeTagFieldsets.forEach(function (fieldset) {
          var checkbox = fieldset.querySelector('input[type="checkbox"]');
          if (checkbox) {
            checkbox.removeAttribute('hidden');

          }

        });
      }
      else {
        remove.setAttribute('hidden', '')
        newTarget.setAttribute('hidden', '')
        fixIn.onclick = (e) => {
          const redirectURL = `component.html?id=${command.id}&rand=${Math.random()}`;
          window.open(redirectURL, '_blank');
        }
      }

      remove.onclick = async (e) => {
        await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${command.id}:${command.sk}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            // Add any additional headers if needed
          },
        });

        fixed = 1
      }

      newTarget.onclick = async (e) => {
        let checked
        codeTreeTagFieldsets.forEach(function (fieldset) {
          var checkbox = fieldset.querySelector('input[type="checkbox"]');
          if (checkbox) {
            checkbox.setAttribute('hidden', 'true');
            if (checkbox.checked) {
              checked = checkbox.parentNode.id
            }
          }
        });
        command.target_element = checked
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(
            command
          ),
        });
        fixed = checked

      }
      const loadingScreen = getElementById1('loading');

      loadingScreen.style.display = 'none';
      function checkFixed() {
        return new Promise(resolve => {
          // Check if fixed is already true
          if (fixed) {
            resolve();
          } else {
            // If not true, listen for changes to the variable
            const interval = setInterval(() => {
              if (fixed) {
                clearInterval(interval);
                resolve();
              }
            }, 100); // Check every 100 milliseconds
          }
        });
      }


      await checkFixed()
      loadingScreen.style.display = 'flex';
      cloned.remove()
      return fixed
    }
    const executeCommand = async (command, path, visual, replaceActions, containerId, noComp1, noSubComp1, lvl, removeActions, replaceId, componentPath, pathForRelative, reusableId, attachId) => {
      if (pauseExecution) {
        return
      }
      let { options, subAction, noSubComp, noComp, time, withParent, move, action, target_element, insertedCode, tag_change, inserted_element, key, value, inserted_component, check_b } = command;
      let treeElement
      let componentElement

      console.log('command is ' + JSON.stringify(command) + ' replace id ' + replaceId + 'pathForRelative ' + pathForRelative?.current + 'reusable ' + reusableId)
      const removeSelected = (arr) => {
        for (const el of arr) {
          log1('1- ' + el)
          const treeEl = getElementById1(el)
          const box = treeEl?.querySelector('#selectedCheckbox')
          if (box) {
            log1('d55')
            box.checked = false
          }
        }
      }
      function sortByPlace(a, b) {
        var elementA = getElementById1(a);
        var elementB = getElementById1(b);
        log1('prob66 ' + a)
        return Array.from(elementA.parentElement.children).indexOf(elementA) -
          Array.from(elementB.parentElement.children).indexOf(elementB);
      }
      function sortByPlace1(a, b) {
        var elementA = a
        var elementB = b

        return Array.from(elementA.parentElement.children).indexOf(elementA) -
          Array.from(elementB.parentElement.children).indexOf(elementB);
      }
      function handleAppendOrInsertReplace(actions, selectedArrayNotSorted, fork, transferInnerHtml) {
        log1('start')
        var firstElementId = selectedArrayNotSorted[0].id;
        var restOfElements = selectedArrayNotSorted.slice(1);
        removeSelected(restOfElements.map(e => e.id))
        restOfElements.sort(sortByPlace);

        //var selectedArray = [firstElementId, ...restOfElements];
        const targetMid = firstElementId.replace('-tree', '').split(':')[0]

        if (!selectedArrayNotSorted[0].replaced) {
          const firstElement = getElementById1(firstElementId.replace('-tree', ''))
          const treeFirstElement = getElementById1(firstElementId)
          let prev = [firstElement, treeFirstElement]
          for (let i = 0; i < replaceIds.length; i++) {
            const mId = targetMid

            if (i === 0) {

              treeFirstElement.id = targetMid + ':' + replaceIds[0] + '-tree'
              firstElement.id = targetMid + ':' + replaceIds[0]
              firstElement.setAttribute('data-replaceID', replaceIds[0])
              continue
            }
            const cloned = cloneWithDescendants(firstElement)
            const cloned2 = cloneWithDescendants(treeFirstElement)
            cloned2.id = targetMid + ':' + replaceIds[i] + '-tree'
            cloned.id = targetMid + ':' + replaceIds[i]
            cloned.setAttribute('data-replaceID', replaceIds[i])
            insertAfter(cloned, prev[0])
            insertAfter(cloned2, prev[1])
            prev = [cloned, cloned2]


          }
        }
        if (fork) {
          for (const element of restOfElements) {


            let compEl1 = getElementById1(element.id.replace('-tree', ''))
            let treeEl1 = getElementById1(element.id)

            let prev
            for (let i = 0; i < replaceIds.length; i++) {
              const mId = element.id.split(':')[0].replace('-tree', '').split('|').pop()
              const mId1 = element.id.split(':')[0].replace('-tree', '')
              let compEl
              let treeEl
              if (!compEl1) {
                console.log('no original')
                compEl = getElementById1(mId1 + ':' + replaceIds[i])
                treeEl = getElementById1(mId1 + ':' + replaceIds[i] + '-tree')
              }
              else {
                compEl = compEl1
                treeEl = treeEl1
              }
              prev = [compEl, treeEl]
              /*
              if (i === 0) {

                treeEl.id = fork + '|' + mId + ':' + replaceIds[0] + '-tree'
                compEl.id = fork + '|' + mId + ':' + replaceIds[0]
                compEl.setAttribute('data-replaceID', replaceIds[0])
                prev = [compEl, treeEl]
                continue
              }*/
              const cloned = cloneWithDescendants(compEl)
              const cloned2 = cloneWithDescendants(treeEl)
              cloned2.id = fork + '|' + mId + ':' + replaceIds[i] + '-tree'
              cloned.id = fork + '|' + mId + ':' + replaceIds[i]
              cloned.setAttribute('data-replaceID', replaceIds[i])
              insertAfter(cloned, prev[0])
              insertAfter(cloned2, prev[1])
              prev = [cloned, cloned2]


            }


          }
        }
        else {
          for (const element of restOfElements) {

            if (!element.replaced) {
              const compEl = getElementById1(element.id.replace('-tree', ''))
              const treeEl = getElementById1(element.id)

              let prev = [compEl, treeEl]
              for (let i = 0; i < replaceIds.length; i++) {
                const mId = element.id.replace('-tree', '').split(':')[0]

                if (i === 0) {

                  treeEl.id = mId + ':' + replaceIds[0] + '-tree'
                  compEl.id = mId + ':' + replaceIds[0]
                  compEl.setAttribute('data-replaceID', replaceIds[0])
                  continue
                }
                const cloned = cloneWithDescendants(compEl)
                const cloned2 = cloneWithDescendants(treeEl)
                cloned2.id = mId + ':' + replaceIds[i] + '-tree'
                cloned.id = mId + ':' + replaceIds[i]
                cloned.setAttribute('data-replaceID', replaceIds[i])
                insertAfter(cloned, prev[0])
                insertAfter(cloned2, prev[1])
                prev = [cloned, cloned2]


              }
            }

          }
        }
        for (let i = 0; i < replaceIds.length; i++) {


          const targetTreeEl = getElementById1(targetMid + ':' + replaceIds[i] + '-tree')
          const targetCompEl = getElementById1(targetMid + ':' + replaceIds[i])
          log1('tree el id' + targetTreeEl.id)
          for (const element of restOfElements) {
            let mId = element.id.replace('-tree', '').split(':')[0]
            if (fork) {
              mId = fork + '|' + element.id.replace('-tree', '').split(':')[0].split('|').pop()
            }


            const treeEl = getElementById1(mId + ':' + replaceIds[i] + '-tree')
            const compEl = getElementById1(mId + ':' + replaceIds[i])
            if (transferInnerHtml) {
              console.log('inner :' + targetCompEl.innerHTML)
              compEl.innerHTML = targetCompEl.innerHTML
              targetCompEl.innerHTML = ""
              const targetIB = targetTreeEl.querySelector('[data-element="code-tree-inner-html-button"]')
              targetIB.setAttribute('hidden', '')
              const targetITB = targetTreeEl.querySelector('[data-element="code-tree-text-content-button"]');
              targetITB.setAttribute('hidden', '')
              const innerHtmlButton = treeEl.querySelector('[data-element="code-tree-inner-html-button"]');
              innerHtmlButton.removeAttribute('hidden')
              innerHtmlButton.textContent = `‚ñ∂Ô∏è${compEl.innerHTML.length}`;
            }
            console.log('targetAppend' + targetTreeEl.id)
            console.log('appending ' + treeEl.id + compEl.id)
            if (action === 'Append') {
              targetTreeEl.append(treeEl)
              targetCompEl.append(compEl)
            }
            else {
              targetTreeEl.parentNode.insertBefore(treeEl, targetTreeEl)
              targetCompEl.parentNode.insertBefore(compEl, targetCompEl)
            }

          }

        }
      }
      function handleAppendOrInsert(action, selectedArrayNotSorted, move, insert_copies, fork, transferInnerHtml) {
        // Sort

        log1('start')
        console.log(JSON.stringify({ action, selectedArrayNotSorted, move, insert_copies, fork }))
        var firstElementId = selectedArrayNotSorted[0];
        var restOfElements = selectedArrayNotSorted.slice(1);

        removeSelected(restOfElements)
        if (components.includes(firstElementId.replace('-tree', ''))) {
          log1('in555')
          const target = getElementById1(firstElementId)
          for (const el of restOfElements) {
            const toM = getElementById1(el)
            if (action === 'Append') {
              target.append(toM)
            }
            else {
              target.parentNode.insertBefore(toM, target)
            }
          }
          return

        }
        // Sort the rest of the elements by their order in the DOM

        log1(JSON.stringify(restOfElements))
        //test
        restOfElements.filter(z => z)
        restOfElements.sort(sortByPlace);
        if (!move && !insert_copies) {
          restOfElements = restOfElements.map(el => removeLastOccurrence(el, '-tree')).map(el =>
            getWithoutCopyId1(el)
          )
          log1('rest ELS' + JSON.stringify(restOfElements))
          restOfElements = removeDuplicates(restOfElements)
        }

        // Combine the sorted array with the first element
        var selectedArray = [firstElementId, ...restOfElements];

        // Find the target fieldset based on the ID
        var targetElementId = selectedArray[0];
        log1('selected' + JSON.stringify(selectedArray))
        // Find the target fieldset based on the ID


        const handle = (targetFieldset, targetFieldset2, flag) => {
          log1('target id' + targetFieldset?.id + targetFieldset2?.id)
          log1('handling')
          log1('handling move' + move)
          // Get the parent fieldset of the target
          var parentFieldset = targetFieldset.parentNode;
          var parentFieldset2 = targetFieldset2?.parentNode

          const data_replaceid = targetFieldset2.getAttribute('data-replaceID')
          // Get the index of the target fieldset within its parent
          var index = Array.from(parentFieldset.children).indexOf(targetFieldset);
          var index2 = Array.from(parentFieldset2.children).indexOf(targetFieldset2);
          const treeEls = []
          const compEls = []
          // Iterate through the selected array (skipping the first element, which is the target)
          for (var i = 1; i < selectedArray.length; i++) {
            var selectedId = selectedArray[i].id;
            var originalId = selectedArray[i].originalId
            log1(JSON.stringify(selectedArray[i]))
            if (!move && !insert_copies) {
              log1('not moving' + JSON.stringify(selectedArrayNotSorted))
              const attr = data_replaceid
              const l = selectedId.split(';').length
              // Find all elements based on the selected ID and its replacement
              var selectedElements = []
              var selectedElements2 = []
              function getContainer() {
                return document
                //return containerId ? getElementById1(containerId) : document
              }
              querySelectorAll1('[id^="' + selectedId.split(':')[0] + '"]').forEach(el => {
                if ((!attr || attr === el.getAttribute('data-replaceID')) && !el.id.endsWith('-tree') && !el.id.endsWith('-fieldset')) {
                  selectedElements.push(getElementById1(el.id + '-tree'));
                  selectedElements2.push(el)
                }

              });
              log1('ppp ' + Array.from(selectedElements).map(e => e?.id))
              log1('ppp ' + Array.from(selectedElements2).map(e => e?.id))

              selectedElements = selectedElements.filter(el => el.id.split(';').length === l)
              selectedElements2 = selectedElements2.filter(el => el.id.split(';').length === l)
              treeEls.push(...selectedElements)
              compEls.push(...selectedElements2)
              // Iterate through each selected element and process it

            }
            else {
              log1('moving')
              selectedId = selectedArray[i]
              const treeEl = getElementById1(selectedId)
              let pageEl = getElementById1(removeLastOccurrence(selectedId, '-tree') + '-fieldset')
              if (!pageEl) {
                log1('true11')
                pageEl = getElementById1(removeLastOccurrence(selectedId, '-tree'))
              }



              var clonedFieldset = cloneWithDescendants(treeEl);
              var arrowButton = clonedFieldset.querySelector('[data-element="code-tree-show-hide-button"]');

              arrowButton.textContent = '‚Üí';
              var clonedFieldset2 = cloneWithDescendants(pageEl);
              if (action === 'Append') {
                targetFieldset.appendChild(clonedFieldset);
                if (targetFieldset2.parentNode.id.startsWith(targetFieldset2.id)) {
                  targetFieldset2.parentNode.appendChild(clonedFieldset2);
                }
                else {
                  targetFieldset2.appendChild(clonedFieldset2);
                }

              } else if (action === 'InsertBefore') {

                parentFieldset.insertBefore(clonedFieldset, parentFieldset.children[index]);
                index++; // Increment the index to maintain the correct order
                if (targetFieldset2.parentNode.id.startsWith(targetFieldset2.id)) {
                  log1('5655')
                  parentFieldset2.parentNode.insertBefore(clonedFieldset2, parentFieldset2);
                }
                else {
                  log1('5777')
                  log1(targetFieldset2.parentNode.id)
                  log1(targetFieldset2.id)
                  parentFieldset2.insertBefore(clonedFieldset2, parentFieldset2.children[index2]);
                }

                index2++; // Increment the index to maintain the correct order
              }


              treeEl.remove();
              pageEl.remove()
            }
          }
          log1('eels12' + JSON.stringify(treeEls.map(e => e.id)))
          if (!move && !insert_copies) {
            if (treeEls.length) {
              treeEls.sort(sortByPlace1)
              compEls.sort(sortByPlace1)

              for (let i = 0; i < compEls.length; i++) {
                const selectedFieldset2 = compEls[i];
                const selectedFieldset = treeEls[i];

                // Clone the selected fieldset and its descendants
                const clonedFieldset = cloneWithDescendants(selectedFieldset2);
                const clonedFieldset2 = cloneWithDescendants(selectedFieldset);
                if (transferInnerHtml) {
                  clonedFieldset.innerHTML = targetFieldset2.innerHTML
                  targetFieldset2.innerHTML = ""
                  const targetIB = targetFieldset.querySelector('[data-element="code-tree-inner-html-button"]')
                  targetIB.setAttribute('hidden', '')
                  const targetITB = targetFieldset.querySelector('[data-element="code-tree-text-content-button"]');
                  targetITB.setAttribute('hidden', '')
                  const innerHtmlButton = clonedFieldset2.querySelector('[data-element="code-tree-inner-html-button"]');
                  innerHtmlButton.removeAttribute('hidden')
                  innerHtmlButton.textContent = `‚ñ∂Ô∏è${clonedFieldset.innerHTML.length}`;
                }
                // Insert the cloned fieldset based on the action
                if (action === 'Append') {
                  targetFieldset2.appendChild(clonedFieldset);
                  targetFieldset.appendChild(clonedFieldset2);
                } else if (action === 'InsertBefore') {
                  parentFieldset2.insertBefore(clonedFieldset, parentFieldset2.children[index2]);
                  index2++; // Increment the index to maintain the correct order

                  parentFieldset.insertBefore(clonedFieldset2, parentFieldset.children[index]);
                  index++; // Increment the index to maintain the correct order
                }


                // Modify clonedFieldset for 'treeEls'
                const arrowButton = clonedFieldset2.querySelector('[data-element="code-tree-show-hide-button"]');
                arrowButton.textContent = '‚Üí';

                // Remove the original fieldset
                if (fork) {
                  // Modification for 'compEls'
                  const newCID = generateUUID();
                  const sId = clonedFieldset.id
                  const spl = sId.split('|');
                  const idWithoutReplace = spl.pop();
                  clonedFieldset.id = fork + '|' + idWithoutReplace;
                  clonedFieldset2.id = clonedFieldset.id + '-tree';
                  clonedFieldset2.querySelectorAll("[id]").forEach(e => {
                    if (e.id.endsWith('-tree')) {
                      const sId = e.id.replace('-tree', '');

                      const spl = sId.split('|');
                      const idWithoutReplace = spl.pop();
                      e.id = fork + '|' + idWithoutReplace + '-tree';
                    }
                  });
                  clonedFieldset.querySelectorAll("[id]").forEach(e => {
                    if (!e.id.endsWith('-fieldset')) {
                      const sId = e.id.replace('-tree', '');

                      const spl = sId.split('|');
                      const idWithoutReplace = spl.pop();
                      e.id = fork + '|' + idWithoutReplace;
                    }
                  });


                } else {
                  selectedFieldset2.remove();
                  selectedFieldset.remove();
                }
              }
            }
            else {
              const s = []
              const s1 = []
              log1('sss' + selectedArrayNotSorted[1])
              querySelectorAll1('[id^="' + selectedArrayNotSorted[1].replace('-tree', '').split(':')[0] + '"]').forEach(el => {
                log1('eel' + el.id)
                if (!el.id.endsWith('-tree') && !el.id.endsWith('-fieldset')) {
                  s.push(getElementById1(el.id + '-tree'));
                  s1.push(el)
                }

              });
              log1('sss' + JSON.stringify(s))
              log1('sss' + JSON.stringify(s1))
              const selectedFieldset = s[0]
              const selectedFieldset2 = s1[0]

              var clonedFieldset = cloneWithDescendants(selectedFieldset);
              var arrowButton = clonedFieldset.querySelector('[data-element="code-tree-show-hide-button"]');

              arrowButton.textContent = '‚Üí';
              // Insert the cloned fieldset based on the action

              var clonedFieldset2 = cloneWithDescendants(selectedFieldset2);
              if (!flag) {
                const splited = clonedFieldset2.id.split(':')
                splited.pop()
                const newId = [...splited, generateUUID()].join(':')
                clonedFieldset2.id = newId
                clonedFieldset.id = newId + '-tree'
              }
              // Insert the cloned fieldset based on the action
              if (action === 'Append') {
                targetFieldset2.appendChild(clonedFieldset2);
                targetFieldset.appendChild(clonedFieldset);
              } else if (action === 'InsertBefore') {


                parentFieldset2.insertBefore(clonedFieldset2, parentFieldset2.children[index2]);
                index2++; // Increment the index to maintain the correct order
                parentFieldset.insertBefore(clonedFieldset, parentFieldset.children[index]);
                index++; // Increment the index to maintain the correct order
              }

              // Remove the original fieldset
              flag && selectedFieldset2.remove();
              // Remove the original fieldset
              flag && selectedFieldset.remove();
            }

          }
        }
        if (getElementById1(targetElementId)) {
          var targetFieldset = getElementById1(targetElementId);

          var targetFieldset2 = getElementById1(removeLastOccurrence(targetElementId, '-tree'));
          handle(targetFieldset, targetFieldset2)
        }
        else {
          log1('target not found')
          let treeEls = []
          let compEls = []
          const mId = targetElementId.replace('-tree', '').split(':')[0]
          log1('miiid' + mId)
          const already = []
          querySelectorAll1('[id^="' + mId + '"]').forEach(
            el => {
              if (!el.id.endsWith('-tree') && !el.id.endsWith('-fieldset') && !already.includes(el.getAttribute('data-replaceid'))) {
                treeEls.push(getElementById1(el.id + '-tree'));
                compEls.push(el)
                already.push(el.getAttribute('data-replaceid'))
              }
            }
          );
          for (let i = treeEls.length - 1; i >= 0; i--) {
            log1('el pushed 1' + treeEls[i].id)
            handle(treeEls[i], compEls[i], i === 0)
          }
        }

      }


      function recursivelyChangeIDs(element, newID, flag, treeType) {
        if (!element) return; // Base case: stop if element is null
        if (treeType) {
          !flag && element.tagName.toLowerCase() === "fieldset" && (element.id = newID + ';' + element.id);
        }
        // Change ID of the current element
        else {
          !flag && (element.id = newID + ';' + element.id);
        }


        // Recursively change IDs of child elements
        Array.from(element.children).forEach(child => {
          recursivelyChangeIDs(child, newID, false, treeType);
        });
      }
      function cloneWithDescendants(element) {
        var clone = element.cloneNode(true);
        var clonedSubFieldsets = clone.querySelectorAll('fieldset[data-element="code-tree-tag"]');
        clonedSubFieldsets.forEach(function (clonedSubFieldset) {
          clonedSubFieldset.hidden = false;
        });
        const buttons = clone.querySelectorAll("[data-element='code-tree-show-hide-button']");

        buttons.forEach(function (button) {
          button.addEventListener('mouseover', mouseOverTree);
          button.addEventListener('mouseout', mouseOutTree);
        });


        return clone;
      }
      log1("action" + action)
      const getWithoutCopyId = (id) => {
        const splited = id.split(';');
        const splited2 = splited[splited.length - 1].replace('-tree', '').split(':')
        splited.pop()
        const processed1 = [...splited, splited2[0]].join(';')
        return processed1
      }
      const getWithoutCopyId1 = (id) => {
        const splited = id.split(';');
        const splited2 = splited[splited.length - 1].replace('-tree', '').split(':')
        const copyId = splited.pop()
        const processed1 = [...splited, splited2[0]].join(';')
        return { id: processed1, originalId: id }
      }

      !path && (path = '')
      switch (action) {

        case 'Add_Component':
          const level = lvl ? lvl + 1 : 1;
          if (level > 1 && options?.selfuse) {
            return
          }
          if (inserted_component.componentId.startsWith('*')) {
            const site = pathItemPath.split('/')[0]
            const modId = inserted_component.componentId.replace('*', '')
            const lsi = site + modId
            const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:' + ownerid + '&gsi1lsi1=true&lsi1=' + lsi)
              .then(response => response.json())
            log1('lsi to search' + lsi)
            log1('lsis' + items.map(i => i.lsi1))
            const item1 = items.find(i => i.lsi1.replace(';publish:published', '') === lsi)
            inserted_component.componentId = item1.id
          }
          else if (inserted_component.componentId.startsWith('#') || inserted_component.componentId.startsWith('$')) {
            let cPath = pathForRelative?.current || pathItemPath
            let relative = inserted_component.componentId.replace('#', '').replace('$', "")
            if (inserted_component.componentId.startsWith('$') && componentPath.split('/')[0] !== site1) {
              log1('cpath diff')
              cPath = pathItemPath
              if (relative.startsWith('../')) {
                relative = './' + relative.replaceAll('../', "")
              }

            }
            cPath = cPath.replace(';publish:published', "")
            log1('cpath ' + cPath + ' relative' + inserted_component.componentId)



            const absolutePath = getAbsolutePath(cPath, relative);
            log1('cpath ' + cPath + ' relative' + inserted_component.componentId + ' absolute ' + absolutePath)

            const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:' + ownerid + '&gsi1lsi1=true&lsi1=' + absolutePath)
              .then(response => response.json())
            log1('lsi' + absolutePath)
            log1(JSON.stringify(items))
            log1(absolutePath)
            let item1 = items.find(i => i.lsi1.replace(';publish:published', '') === absolutePath)
            log1(JSON.stringify(item1))
            let i = 0
            if (pathForRelative?.next.length) {
              while (!item1) {
                cPath = pathForRelative.next[i].replace(';publish:published', "")
                const absolutePath = getAbsolutePath(cPath, relative);
                const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:' + ownerid + '&gsi1lsi1=true&lsi1=' + absolutePath)
                  .then(response => response.json())
                item1 = items.find(i => i.lsi1.replace(';publish:published', '') === absolutePath)
              }
            }

            inserted_component.componentId = item1.id
          }
          let rT
          if (options?.reusable && reusableId) {
            rT = reusableId + '|' + options?.reusable
          }
          else {
            rT = options?.reusable || reusableId
          }
          const processedId = (rT ? rT + '|' : '') + inserted_component.id + '-tree'
          const removeAction = removeActions?.find(e => e.target_element === processedId)
          if (removeAction) {
            log1('found 115')
            return
          }
          const replaceAction = replaceActions?.findLast(e => e.target_element[0] === processedId)

          //replace
          log1('selected Actions' + JSON.stringify(replaceAction))
          treeElement = getElementById1(target_element);
          //component
          componentElement = getElementById1('generated-page');


          //const newEl = document.createElement("component");
          //newEl.id = inserted_component.id;
          //log1('comp idddd' + newEl.id);

          // Check if componentElement and its parent node are valid
          if (componentElement) {
            // Insert newEl as the first child of the parent node
            //componentElement.insertBefore(newEl, componentElement.firstChild);
          } else {
            console.error("Invalid componentElement or parent node.");
          }

          const component_el = getElementById1('component-element')
          const newEl2 = component_el.cloneNode(true)
          const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
          button2.textContent = 'üß©' + inserted_component.id;
          const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
          button.addEventListener('mouseover', mouseOverTree);

          button.addEventListener('mouseout', mouseOutTree);

          newEl2.id = processedId
          newEl2.setAttribute('cid', inserted_component.componentId)
          if (noSubComp1 || noComp || noComp1) {
            newEl2.setAttribute('hidden', '')
          }
          if (removeLastOccurrence(target_element, '-tree') === pathItem.id) {
            newEl2.setAttribute('data-first-child', '')
          }
          if (subAction === 'Append') {
            treeElement.append(newEl2);
          } else if (subAction === 'InsertBefore') {
            treeElement.parentNode.insertBefore(newEl2, treeElement)
          } else {

            treeElement.append(newEl2);
          }


          log1('prob' + inserted_component.componentId)
          components.push(inserted_component.id)

          log1('foundlvl ' + lvl)

          if (options?.attachId && options.attachId !== "body-tree") {
            if (reusableId) {
              attachId = reusableId + '|' + options?.attachId
            }
            else {
              attachId = options?.attachId
            }


          }
          if (replaceAction) {
            if (replaceAction.id === pathItem.id) {
              await insertDataIntoCodeLog(replaceAction.sk, replaceAction.action, replaceAction.options, undefined, replaceAction)
            }

            log1('replace action in')
            const toReplace = replaceAction.target_element[0]
            replaceAction.target_element.shift()
            const dontReplaceIndex = replaceAction.target_element.findIndex(e => e.componentId === toReplace)

            //remove unfound replace
            const newArr = []
            let shouldUpdate
            const p = replaceAction.target_element.map(async el => {
              const d = await fetch(`${backend_url}?id=${el.componentId}&sk=path&startsWith=true`, {
                method: 'GET',
                headers: {
                  'Content-Type': 'application/json',
                },
              }).then(e => e.json())
              if (d.items.length && !d.items[0].lsi1.startsWith('trash')) {
                newArr.push(el)
              }

            })
            await Promise.all(p)
            replaceAction.target_element = newArr.filter(e => !e.path.endsWith('0-Content'))
            console.log('new arr' + JSON.stringify(newArr))

            //replace folders
            if (replaceAction.folders) {
              const promises = replaceAction.folders.map(async folder1 => {
                let folder = folder1
                if (folder1.startsWith('*')) {
                  const site = pathItemPath.split('/')[0]
                  const modId = folder.replace('*', '')
                  folder = site + modId

                }
                else if (folder1.startsWith('#')) {
                  let cPath = pathForRelative?.current || pathItemPath
                  cPath = cPath.replace(';publish:published', "")
                  log1('cpath ' + cPath)


                  const relative = folder.replace('#', '')
                  folder = convertToOldPath(getAbsolutePath(cPath, relative));



                }
                log1('folder is ' + folder)
                const folderEncoded = encodeURIComponent(folder + '|');
                const url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&lsi1=${folderEncoded}&gsi1lsi1=true`;
                log1('furl ' + url)
                const data = await fetch(url).then(e => e.json())
                log1('r items ' + JSON.stringify(data))
                return data.items
              })
              let allItems = await Promise.all(promises)
              allItems.sort((a, b) => a.lsi1.localeCompare(b.lsi1));
              log1('all Items' + JSON.stringify(allItems))
              //let updateAction
              for (const arr of allItems) {
                for (const item of arr) {
                  if (item.lsi1.split(';')[0].endsWith('0-Content') || replaceAction.target_element.find(e => e.componentId === item.id)) {
                    continue
                  }
                  const newReplaceItem = {
                    componentId: item.id, id: generateUUID(), path: item.lsi1.split(';')[0]
                  }
                  replaceAction.target_element.push(newReplaceItem)
                  //updateAction = true
                }
              }
              /*
              if (updateAction && replaceAction.id === pathItem.id) {
                const rToPush = { ...replaceAction }
                rToPush.target_element = [toReplace, ...replaceAction.target_element]
                const response1 = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(rToPush),
                });
              }*/
            }
            let l = replaceAction.target_element.reduce((acc, current) => {
              // Check if there is no object in the accumulator with the same componentId
              if (!acc.some(obj => obj.componentId === current.componentId)) {
                acc.push(current);
              }
              return acc;
            }, []); //.filter(e => e.componentId !== toReplace);
            l.sort((a, b) => b.path.localeCompare(a.path));
            let i = false;
            console.log('solving ' + JSON.stringify(l))
            replaceIds = l.map(e => e.id)
            for (const el of l) {

              await executeCommand({
                time,
                action: 'InsertAfter',
                target_element: toReplace,
                inserted_component: el,
                noComp: true,
                noSubComp: i
              }, path, visual, replaceActions, undefined, noComp1, noSubComp1, level, removeActions, replaceAction.options?.single ? undefined : el.id, undefined, pathForRelative, rT, attachId)
              i = true

            }
            /*
            if (dontReplaceIndex === -1) {
              const elementsToRemove = querySelectorAll1(`[id^="${removeLastOccurrence(toReplace, '-tree') + ';'}"]`);
              elementsToRemove.forEach(element => element.remove());
            }*/
            const el = getElementById1(toReplace)
            el.setAttribute('replaced', JSON.stringify(replaceAction.target_element))
            el.setAttribute('replacedFolders', JSON.stringify(replaceAction.folders || []))
            const el2 = el.querySelector('[data-element="optional-script"]')
            el2.removeAttribute('hidden')
            el2.innerHTML = `üîÑ${replaceAction.target_element.length}`;
          }

          /*
          if (!getElementById1(attachId)) {
            attachId = 'body-tree'
          }*/
          await loadFromDb(inserted_component.componentId, inserted_component.id, path, command.sk, replaceActions, replaceAction, noComp1 || noComp, noSubComp1, level, removeActions, replaceId, pathForRelative, newEl2, rT, attachId)


          break;
        case 'Insert_First':
          treeElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
            getElementById1('code-tree')
            : getElementById1(target_element)
          //component

          componentElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
            getElementById1('generated-page')
            : getElementById1(removeLastOccurrence(target_element, '-tree'));
          const newEle = document.createElement(inserted_element.tagName)
          // Check if the tag is <img>

          log1('no comp val' + noComp1)
          log1('replaceid1 ' + replaceId)
          noComp1 && newEle.setAttribute('data-replaceID', replaceId)
          newEle.id = inserted_element.id
          log1(newEle.id)
          componentElement.insertBefore(newEle, componentElement.firstChild);
          const component_ele = getElementById1('tree-element')
          const newEle2 = component_ele.cloneNode(true)
          const button22 = newEle2.querySelector("[data-element='code-tree-tag-name-button']")
          button22.textContent = 'üè∑Ô∏è' + inserted_element.tagName;
          const button11 = newEle2.querySelector("[data-element='code-tree-show-hide-button']")
          button11.addEventListener('mouseover', mouseOverTree);

          button11.addEventListener('mouseout', mouseOutTree);

          newEle2.id = inserted_element.id + '-tree'
          treeElement.insertBefore(newEle2, treeElement.firstChild);
          break;

        case 'InsertAfter':
          if (inserted_component) {
            //fieldset
            if (inserted_component.componentId.startsWith('*')) {
              const site = pathItemPath.split('/')[0]
              const modId = inserted_component.componentId.replace('*', '')
              const lsi = site + modId
              const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true&lsi1=' + lsi)
                .then(response => response.json())
              const item1 = items.find(i => i.lsi1.replace(';publish:published', '') === lsi)
              inserted_component.componentId = item1.id
            }
            else if (inserted_component.componentId.startsWith('#')) {
              let cPath = pathForRelative.prev || pathItemPath
              cPath = cPath.replace(';publish:published', "")
              log1('cpath ' + cPath)


              const relative = inserted_component.componentId.replace('#', '')
              const absolutePath = getAbsolutePath(cPath, relative);


              const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true&lsi1=' + absolutePath)
                .then(response => response.json())
              log1('lsi' + absolutePath)
              log1(JSON.stringify(items))

              const item1 = items.find(i => i.lsi1.replace(';publish:published', '') === absolutePath)
              log1(JSON.stringify(item1))
              inserted_component.componentId = item1.id
            }
            let rT
            if (options?.reusable && reusableId) {
              rT = reusableId + '|' + options?.reusable
            }
            else {
              rT = options?.reusable || reusableId
            }
            const processedId = (rT ? rT + '|' : '') + inserted_component.id + '-tree'
            log1('in')
            log1(target_element)
            treeElement = getElementById1(target_element);
            //component
            //componentElement = getElementById1(removeLastOccurrence(target_element, '-tree'));
            //const newEl = document.createElement("div")
            //newEl.id = inserted_component.id
            //log1(newEl.id)
            //componentElement.appendChild(newEl)
            const component_el = getElementById1('component-element')
            const newEl2 = component_el.cloneNode(true)
            const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
            button2.textContent = 'üß©' + inserted_component.name;
            const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
            button.addEventListener('mouseover', mouseOverTree);

            button.addEventListener('mouseout', mouseOutTree);

            newEl2.id = processedId
            if (noComp || noComp1) {
              log1('no comp true')
              newEl2.setAttribute('hidden', '')
            }
            treeElement.insertAdjacentElement('afterend', newEl2);
            components.push(inserted_component.id)
            log1(inserted_component.componentId)
            log1('insert after reusableid' + reusableId)
            await loadFromDb(inserted_component.componentId, inserted_component.id, path, inserted_component.name, replaceActions, false, noComp || noComp1, noSubComp, lvl, removeActions, replaceId, { current: pathForRelative.prev, prev: pathForRelative.prev }, undefined, reusableId, attachId)
            break;
          }


          //case duplicate insert after  
          if (inserted_element?.originalId) {
            log1('insert1' + JSON.stringify(command));
            // fieldset
            treeElement = getElementById1(inserted_element?.originalId);
            // component
            componentElement = getElementById1(removeLastOccurrence(inserted_element.originalId, '-tree'));

            // Duplicate the element
            const newEl = componentElement.cloneNode(true);
            //newEl.textContent = newEl.tagName.toLowerCase();
            // Set the id of the duplicated element to inserted_element.id
            newEl.id = removeLastOccurrence(inserted_element.id, '-tree');
            if (newEl.hasAttribute('data-visual-defaultTextNode') && newEl.hasAttribute('data-visual-element')) {
              // Set child's text content to its content
              newEl.innerText = newEl.getAttribute('data-visual-defaultTextNode')
            }
            log1(newEl.id);

            // Append the duplicated element to the componentElement
            const compEl = getElementById1(removeLastOccurrence(target_element, '-tree'))
            if (visual) {
              insertAfter(newEl, compEl.parentNode);
              processElement(newEl);
            } else {
              insertAfter(newEl, compEl);
            }


            const newId1 = newEl.id.split(':')[newEl.id.split(':').length - 1]

            if (treeElement) {
              // Duplicate the treeElement content
              const newEl2 = treeElement.cloneNode(true);

              // Set the id of the duplicated treeElement to inserted_element.id + '-tree'
              newEl2.id = inserted_element.id;

              // Update the button text in the duplicated treeElement
              const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']");

              // Attach event listeners to the buttons in the duplicated treeElement
              const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']");
              button.addEventListener('mouseover', mouseOverTree);
              button.addEventListener('mouseout', mouseOutTree);
              const trEl = getElementById1(target_element)
              // Append the duplicated treeElement to the treeElement's parent
              insertAfter(newEl2, trEl);
              updateChildIdsRecursive(newEl2, newId1, true);
            }


            function updateChildIdsRecursive(element, newId1, tree) {
              const processed = []
              element.querySelectorAll('[id]').forEach(child => {
                const splited = child.id.split(';');
                const splited2 = splited[splited.length - 1].replace('-tree', '').split(':')
                let newSubId = splited2[0] + ':' + newId1
                tree && (newSubId = newSubId + '-tree')
                splited.pop()
                const processed1 = [...splited, splited2[0]].join(';')
                if (processed.find(el => el.startsWith(processed1))) {
                  log1('status' + processed1)
                  log1('status2' + JSON.stringify(processed))
                  child.remove()
                }
                else {
                  processed.push(processed1)
                  log1('proce' + processed1)
                  child.id = [...splited, newSubId].join(';')
                  if (child.hasAttribute('data-visual-defaultTextNode') && child.hasAttribute('data-visual-element')) {
                    // Set child's text content to its content
                    child.innerText = child.getAttribute('data-visual-defaultTextNode')
                  }
                  // Recursively update ids for child's children
                  updateChildIdsRecursive(child, newId1, tree);
                }

              });
            }

            // Update ids of child elements within the duplicated elements recursively
            updateChildIdsRecursive(newEl, newId1);


            break;
          }
          if (inserted_element?.tagName) {
            const handleInsert = (treeElement, componentElement, replaceCopyId) => {
              log1('handling' + treeElement + ' ' + componentElement + ' ' + replaceCopyId)
              const newEl = document.createElement(inserted_element.tagName)

              const attr1 = componentElement.getAttribute('data-replaceID')
              if (attr1) {
                newEl.setAttribute('data-replaceID', attr1)
              }
              if (noComp || noComp1) {
                newEl.setAttribute('data-replaceID', replaceId)
              }

              const splited = componentElement.id.split(';')






              newEl.id = replaceCopyId ? inserted_element.id.split(':')[0] + ':' + componentElement.getAttribute('data-replaceid') : inserted_element.id

              log1(newEl.id)

              const component_el = getElementById1('tree-element')
              const newEl2 = component_el.cloneNode(true)
              const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
              button2.textContent = 'üè∑Ô∏è' + inserted_element.tagName;
              const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
              button.addEventListener('mouseover', mouseOverTree);

              button.addEventListener('mouseout', mouseOutTree);
              newEl2.id = replaceCopyId ? inserted_element.id.split(':')[0] + ':' + componentElement.getAttribute('data-replaceid') + '-tree' : inserted_element.id + '-tree'
              if (splited.length > 1) {
                newEl.id = splited[0] + ';' + newEl.id
                newEl2.id = splited[0] + ';' + newEl2.id
              }
              if (inserted_element.tagName === 'script' || inserted_element.tagName === 'style') {
                const button = newEl2.querySelector('[data-element="redirect-to-component"]')
                button.removeAttribute('hidden')
                button.onclick = () => {
                  const redirectURL = `component.html?id=${command.id}&rand=${Math.random()}`;
                  window.open(redirectURL, '_blank');
                }
              }
              insertAfter(newEl, componentElement)
              insertAfter(newEl2, treeElement)
              //componentElement.parentNode.insertBefore(newEl, componentElement)
              //treeElement.parentNode.insertBefore(newEl2, treeElement)
            }
            treeElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
              getElementById1('code-tree')
              : getElementById1(target_element)
            //component
            componentElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
              getElementById1('generated-page')
              :
              getElementById1(removeLastOccurrence(target_element, '-tree'));

            if (!componentElement) {
              log1('comp not found')
              const mId = target_element.replace('-tree', '').split(':')[0]
              const treeEls = []
              const compEls = []
              const existing = []
              const elementsWithIdAndAttribute = querySelectorAll1('[id^="' + mId + '"][data-replaceid]')
                .forEach(
                  el => {
                    log1('ffooound152 ' + el.id)
                    if (!existing.includes(el.getAttribute('data-replaceid'))) {
                      existing.push(el.getAttribute('data-replaceid'))
                      treeEls.push(getElementById1(el.id + '-tree'));
                      compEls.push(el)
                    }

                  }
                );

              for (let i = 0; i < treeEls.length; i++) {
                handleInsert(treeEls[i], compEls[i], true)
              }
              break;
            }
            log1('handling insert')
            handleInsert(treeElement, componentElement)


            break;

          }

          if (target_element?.length) {
            const afterId = target_element[0].id;
            const id = target_element[1].id;
            log1(id)
            log1(afterId)
            const aftertreeElement = getElementById1(afterId);
            let aftercomponentElement = getElementById1(removeLastOccurrence(afterId, '-tree') + '-fieldset') ||
              getElementById1(removeLastOccurrence(afterId, '-tree'));

            const treeElement = getElementById1(id);
            let componentElement = getElementById1(removeLastOccurrence(id, '-tree') + '-fieldset') ||
              getElementById1(removeLastOccurrence(id, '-tree'));

            if (aftertreeElement && treeElement) {
              // Move treeElement after aftertreeElement
              insertAfter(treeElement, aftertreeElement);
            }

            if (aftercomponentElement && componentElement) {
              // Move componentElement after aftercomponentElement
              insertAfter(componentElement, aftercomponentElement);
            }
          }

          break;

        case 'Add_Parent':
          const handleInsertParent = (treeElement, componentElement, replaceCopyId, apply_to_copies) => {
            log1('handling' + treeElement + ' ' + componentElement + ' ' + replaceCopyId)

            const newEl = document.createElement(inserted_element.tagName)
            componentElement.replaceWith(newEl);
            newEl.appendChild(componentElement)

            const attr1 = componentElement.getAttribute('data-replaceID')
            if (attr1) {
              newEl.setAttribute('data-replaceID', attr1)
            }
            if (noComp || noComp1) {
              newEl.setAttribute('data-replaceID', replaceId)
            }


            const splited = componentElement.id.split(';')


            const copyId = splited[splited.length - 1].split(':')[1]


            log1(newEl.id)

            const component_el = getElementById1('tree-element')
            const newEl2 = component_el.cloneNode(true)
            const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
            button2.textContent = 'üè∑Ô∏è' + inserted_element.tagName;
            if (replaceCopyId) {
              newEl2.id = inserted_element.id.split(':')[0] + ':' + componentElement.getAttribute('data-replaceid') + '-tree'
            } else if (apply_to_copies) {
              if (copyId) {
                newEl2.id = inserted_element.id.split(':')[0] + ':' + copyId + '-tree'
              }
              else {
                newEl2.id = inserted_element.id + '-tree'
              }
            }
            else {
              newEl2.id = inserted_element.id + '-tree'
            }

            newEl.id = removeLastOccurrence(newEl2.id, '-tree')


            if (componentElement.hasAttribute('data-parentid')) {
              log1('in12')


              newEl.id = componentElement.id.split(';')[0] + ';' + newEl.id
              newEl2.id = componentElement.id.split(';')[0] + ';' + newEl2.id
            }

            else if (splited.length > 1) {
              newEl.id = splited[0] + ';' + newEl.id
              newEl2.id = splited[0] + ';' + newEl2.id
            }
            log1(newEl.id)
            treeElement.replaceWith(newEl2);
            newEl2.appendChild(treeElement)
            const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
            button.addEventListener('mouseover', mouseOverTree);

            button.addEventListener('mouseout', mouseOutTree);
            if (componentElement.contains(newEl)) {
              log1(newEl.id + ' was created and appended successfully.');
            } else {
              console.error('Failed to create or append newEl.');
            }


          }
          const apply_to_copies = options?.apply_to_copies
          treeElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
            getElementById1('code-tree')
            : getElementById1(target_element)
          //component
          componentElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
            getElementById1('generated-page')
            :
            getElementById1(removeLastOccurrence(target_element, '-tree'));
          if (apply_to_copies) {
            log1('inSL')
            const mId = target_element.replace('-tree', '').split(':')[0]
            const treeEls = []
            const compEls = []
            const existing = []
            const elementsWithIdAndAttribute = querySelectorAll1('[id^="' + mId + '"]')
              .forEach(
                el => {
                  if (el.id.endsWith('tree')) {
                    return
                  }
                  log1('ffooound152 ' + el.id)

                  treeEls.push(getElementById1(el.id + '-tree'));
                  compEls.push(el)


                }
              );

            for (let i = 0; i < treeEls.length; i++) {
              handleInsertParent(treeEls[i], compEls[i], false, true)
            }
            break;
          }
          if (!componentElement) {
            log1('comp not found')
            const mId = target_element.replace('-tree', '').split(':')[0]
            const treeEls = []
            const compEls = []
            const existing = []
            const elementsWithIdAndAttribute = querySelectorAll1('[id^="' + mId + '"][data-replaceid]')
              .forEach(
                el => {
                  log1('ffooound152 ' + el.id)
                  if (!existing.includes(el.getAttribute('data-replaceid'))) {
                    existing.push(el.getAttribute('data-replaceid'))
                    treeEls.push(getElementById1(el.id + '-tree'));
                    compEls.push(el)
                  }

                }
              );

            for (let i = 0; i < treeEls.length; i++) {
              handleInsertParent(treeEls[i], compEls[i], true)
            }
            break;
          }
          log1('handling insert')

          handleInsertParent(treeElement, componentElement)


          break;

        case 'Append':
          // Handle the 'Append' action
          if (options?.dub_target) {
            // get all copies 
            const handleWithParent = async (id, items) => {
              log1('input 6' + JSON.stringify(items))
              const [firstId, ...restIds] = items
              for (const el of restIds) {


                async function append(parentId, selectedElementId, flag) {
                  log1('parent id' + parentId)
                  log1('el id' + selectedElementId)
                  const { id, copyId } = duplicateId(selectedElementId)
                  // Perform additional actions if needed
                  let actionObject
                  if (getElementById1(selectedElementId + '-tree').nextElementSibling) {
                    actionObject = {
                      time: (new Date()).getTime(),
                      action: 'InsertBefore',
                      target_element: getElementById1(selectedElementId + '-tree').nextElementSibling.id,
                      inserted_element: { originalId: selectedElementId + '-tree', id },
                    };
                  }
                  else {
                    actionObject = {
                      time: (new Date()).getTime(),
                      action: 'Append',
                      target_element: getElementById1(selectedElementId + '-tree').parentNode.id,
                      inserted_element: { originalId: selectedElementId + '-tree', id },
                    };
                  }

                  await executeCommand(actionObject, path, visual);
                  return { t: actionObject.inserted_element.id, copyId }
                }

                const { t, copyId } = await append(removeLastOccurrence(getElementById1(id).parentNode.id, '-tree'), removeLastOccurrence(id, '-tree'))

                await executeCommand({
                  time: (new Date()).getTime(),
                  action: 'Append',
                  target_element: [{ type: 'tag', id: t, }, { type: 'tag', id: el, }],
                  move: true
                }, path, visual);
                log1('main2' + JSON.stringify([{ type: 'tag', t, }, { type: 'tag', id: el, }]))
              }
              log1('main1' + JSON.stringify([{ type: 'tag', id, }, { type: 'tag', id: firstId, }]))
              await executeCommand({
                time: (new Date()).getTime(),
                action: 'Append',
                target_element: [{ type: 'tag', id, }, { type: 'tag', id: firstId, }],
                move: true
              }, path, visual);
            }
            const id = target_element[0].id
            target_element.shift()
            let restOfElements = target_element.map(el => removeLastOccurrence(el.id, '-tree')).map(el =>
              getWithoutCopyId(el))
            restOfElements = removeDuplicates(restOfElements)
            if (getElementById1(id)) {





              const items = []
              for (const element of restOfElements) {
                const l = element.split(';').length
                querySelectorAll1('[id^="' + element + '"]').forEach(el => {
                  el.id.endsWith('-tree') && el.id.split(';').length === l && items.push(el.id)
                });
              }
              log1('iteeems' + JSON.stringify(items))

              handleWithParent(id, items)
            }
            else {
              log1('prob555')
              const mId = getWithoutCopyId(id)
              let copies = querySelectorAll1('[id^="' + mId + '"]')

              const already = []
              for (const element of copies) {
                if (element.id.endsWith('-tree') || element.id.endsWith('-fieldset')) {
                  continue
                }
                const replaceId = element.getAttribute('data-replaceid')
                log1('replace id + ' + replaceId)
                const items = []

                for (const element of restOfElements) {
                  const l = element.split(';').length
                  querySelectorAll1('[id^="' + element + '"]').forEach(el => {
                    !el.id.endsWith('-fieldset') && !el.id.endsWith('-tree') && el.id.split(';').length === l && el.getAttribute('data-replaceid') === replaceId && items.push(el.id + '-tree')
                  });
                }
                log1('prob items 1 ' + JSON.stringify(items))
                const found = items.find(item => !already.find(i => i === item))
                log1(found)
                already.push(found)
                handleWithParent(element.id + '-tree', items)
              }
            }

            break;
          }
          if (inserted_component) {
            //fieldset
            log1('in')
            log1(target_element)
            treeElement = getElementById1(target_element);
            //component

            const component_el = getElementById1('component-element')
            const newEl2 = component_el.cloneNode(true)
            const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
            button2.textContent = 'üß©' + inserted_component.id;
            const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
            button.addEventListener('mouseover', mouseOverTree);

            button.addEventListener('mouseout', mouseOutTree);

            newEl2.id = inserted_component.id + '-tree'

            treeElement.appendChild(newEl2)
            log1('prob' + inserted_component.componentId)
            components.push(inserted_component.id)
            log1('err ' + path)
            await loadFromDb(inserted_component.componentId, inserted_component.id, path, command.sk, false, noComp1 || noComp)
            break;
          }
          //case duplicate append
          if (inserted_element?.originalId) {
            log1('insert2' + JSON.stringify(command));
            // fieldset
            treeElement = getElementById1(inserted_element?.originalId);
            // component
            componentElement = getElementById1(removeLastOccurrence(inserted_element.originalId, '-tree'));

            // Duplicate the element
            let newEl = componentElement.cloneNode(true);
            if (newEl.hasAttribute('data-visual-defaultTextNode') && newEl.hasAttribute('data-visual-element')) {
              // Set child's text content to its content
              newEl.innerText = newEl.getAttribute('data-visual-defaultTextNode')
            }
            // Set the id of the duplicated element to inserted_element.id
            newEl.id = removeLastOccurrence(inserted_element.id, '-tree');
            log1(newEl.id);

            // Append the duplicated element to the componentElement
            if (visual) {
              getElementById1(removeLastOccurrence(target_element, '-tree')).parentNode.appendChild(newEl);
              processElement(newEl)
            }
            else {
              getElementById1(removeLastOccurrence(target_element, '-tree')).appendChild(newEl);
            }
            //processElement(newEl)
            // Duplicate the treeElement content
            const newEl2 = treeElement.cloneNode(true);

            // Set the id of the duplicated treeElement to inserted_element.id + '-tree'
            newEl2.id = inserted_element.id;

            // Update the button text in the duplicated treeElement
            const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']");

            // Attach event listeners to the buttons in the duplicated treeElement
            const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']");
            button.addEventListener('mouseover', mouseOverTree);
            button.addEventListener('mouseout', mouseOutTree);

            // Append the duplicated treeElement to the treeElement's parent

            getElementById1(target_element).appendChild(newEl2);

            const newId1 = newEl.id.split(':')[newEl.id.split(':').length - 1]
            function updateChildIdsRecursive(element, newId1, tree) {
              const processed = []
              element.querySelectorAll('[id]').forEach(child => {
                const splited = child.id.split(';');
                const splited2 = splited[splited.length - 1].replace('-tree', '').split(':')
                let newSubId = splited2[0] + ':' + newId1
                tree && (newSubId = newSubId + '-tree')
                splited.pop()
                const processed1 = [...splited, splited2[0]].join(';')
                if (processed.find(el => el.startsWith(processed1))) {
                  log1('status' + processed1)
                  log1('status2' + JSON.stringify(processed))
                  child.remove()
                }
                else {
                  processed.push(processed1)
                  log1('proce' + processed1)
                  child.id = [...splited, newSubId].join(';')
                  if (child.hasAttribute('data-visual-defaultTextNode') && child.hasAttribute('data-visual-element')) {
                    // Set child's text content to its content
                    child.innerText = child.getAttribute('data-visual-defaultTextNode')
                  }
                  // Recursively update ids for child's children
                  updateChildIdsRecursive(child, newId1, tree);
                }

              });
            }

            // Update ids of child elements within the duplicated elements recursively
            updateChildIdsRecursive(newEl, newId1);
            updateChildIdsRecursive(newEl2, newId1, true);
            break;
          }
          //case insert tag
          if (inserted_element?.tagName) {




            const handleInsert = (treeElement, componentElement, replaceCopyId) => {
              log1('handling' + treeElement + ' ' + componentElement + ' ' + replaceCopyId)
              const newEl = document.createElement(inserted_element.tagName)



              const attr1 = componentElement.getAttribute('data-replaceID')
              if (attr1) {
                newEl.setAttribute('data-replaceID', attr1)
              }
              if (noComp || noComp1 && replaceId) {
                newEl.setAttribute('data-replaceID', replaceId)
              }


              const splited = componentElement.id.split(';')






              newEl.id = replaceCopyId ? inserted_element.id.split(':')[0] + ':' + componentElement.getAttribute('data-replaceid') : inserted_element.id

              log1(newEl.id)

              const component_el = getElementById1('tree-element')
              const newEl2 = component_el.cloneNode(true)
              const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
              button2.textContent = 'üè∑Ô∏è' + inserted_element.tagName;

              newEl2.id = replaceCopyId ? inserted_element.id.split(':')[0] + ':' + componentElement.getAttribute('data-replaceid') + '-tree' : inserted_element.id + '-tree'
              if (inserted_element.tagName === 'script' || inserted_element.tagName === 'style') {
                const button = newEl2.querySelector('[data-element="redirect-to-component"]')
                button.removeAttribute('hidden')
                button.onclick = () => {
                  const redirectURL = `component.html?id=${command.id}&rand=${Math.random()}`;
                  window.open(redirectURL, '_blank');
                }
              }
              if (componentElement.hasAttribute('data-parentid')) {
                log1('in12')


                newEl.id = componentElement.id.split(';')[0] + ';' + newEl.id
                newEl2.id = componentElement.id.split(';')[0] + ';' + newEl2.id
              }

              else if (splited.length > 1) {
                newEl.id = splited[0] + ';' + newEl.id
                newEl2.id = splited[0] + ';' + newEl2.id
              }
              log1(newEl.id)
              if (options?.position) {
                const fieldsets = Array.from(treeElement.children).filter(e => e.tagName.toLowerCase() === 'fieldset')
                if (options.position.startsWith("start-")) {
                  // Extract the number after "start-"
                  const index = parseInt(options.position.slice(6));
                  // Insert newEl at the specified index from the start
                  componentElement.insertBefore(newEl, componentElement.children[index - 1]);
                  // Insert newEl2 at the same position in treeElement
                  treeElement.insertBefore(newEl2, fieldsets[index - 1]);
                } else if (options.position.startsWith("end-")) {
                  // Extract the number after "end-"
                  const index = parseInt(options.position.slice(4));
                  // Calculate the index from the end
                  const endIndex = fieldsets.length - index;
                  // Insert newEl at the calculated index from the end
                  componentElement.insertBefore(newEl, componentElement.children[endIndex]);
                  // Insert newEl2 at the same position in treeElement

                  treeElement.insertBefore(newEl2, fieldsets[endIndex]);
                } else {
                  // Invalid position format
                  console.error("Invalid position format");
                }
              } else {
                // If position is not specified, append both newEl and newEl2
                componentElement.appendChild(newEl);
                treeElement.appendChild(newEl2);
              }

              const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
              button.addEventListener('mouseover', mouseOverTree);

              button.addEventListener('mouseout', mouseOutTree);
              if (componentElement.contains(newEl)) {
                log1(newEl.id + ' was created and appended successfully.');
              } else {
                console.error('Failed to create or append newEl.');
              }


            }

            treeElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
              getElementById1('code-tree')
              : getElementById1(target_element)
            //component
            componentElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
              getElementById1('generated-page')
              :
              getElementById1(removeLastOccurrence(target_element, '-tree'));
            if (options?.actionInReplace) {
              const mId = target_element.replace('-tree', '').split(':')[0]
              log1('replaceIds' + JSON.stringify(replaceIds))
              replaceIds.forEach(replaceId => {
                log1(mId)
                log1(replaceId)
                const treeEl = getElementById1(mId + ':' + replaceId + '-tree')
                const compEl = getElementById1(mId + ':' + replaceId)
                handleInsert(treeEl, compEl, true)
              })
              break;
            }
            /*
            if (!componentElement) {
              log1('comp not found')
              const mId = target_element.replace('-tree', '').split(':')[0]
              const treeEls = []
              const compEls = []
              const existing = []
              const elementsWithIdAndAttribute = querySelectorAll1('[id^="' + mId + '"][data-replaceid]')
              elementsWithIdAndAttribute.forEach(
                el => {
                  log1('ffooound152 ' + el.id)
                  if (!existing.includes(el.getAttribute('data-replaceid'))) {
                    existing.push(el.getAttribute('data-replaceid'))
                    treeEls.push(getElementById1(el.id + '-tree'));
                    compEls.push(el)
                  }

                }
              );
              if (!elementsWithIdAndAttribute.length) {

                target_element = await fixCommand(command)
                if (target_element === 1) {
                  break;
                }
              }
              else {
                for (let i = 0; i < treeEls.length; i++) {
                  handleInsert(treeEls[i], compEls[i], true)
                }
                break;
              }

            }
            log1('handling insert')
            */
            if (!componentElement) {
              treeElement = getElementById1('body-tree')
              componentElement = getElementById1('body')
            }
            handleInsert(treeElement, componentElement)


            break;




          }
          if (target_element.length) {
            log1('movestat ' + move)
            if (options?.actionInReplace) {
              handleAppendOrInsertReplace('Append', target_element, options?.fork, options?.transferInnerHtml)
            }
            else {
              handleAppendOrInsert('Append', target_element.map(i => i.id), move, undefined, options?.fork, options?.transferInnerHtml)
            }

          }
          break;

        case 'InsertBefore':
          // Handle the 'InsertBefore' action
          // Handle the 'Append' action
          //fieldset
          if (options?.dub_target) {
            // get all copies 
            const handleWithParent = async (id, items) => {
              log1('input 6' + JSON.stringify(items))
              const [firstId, ...restIds] = items
              for (const el of restIds) {


                async function append(parentId, selectedElementId, flag) {
                  log1('parent id' + parentId)
                  log1('el id' + selectedElementId)
                  const { id, copyId } = duplicateId(selectedElementId)
                  // Perform additional actions if needed
                  let actionObject
                  if (getElementById1(selectedElementId + '-tree').nextElementSibling) {
                    actionObject = {
                      time: (new Date()).getTime(),
                      action: 'InsertBefore',
                      target_element: getElementById1(selectedElementId + '-tree').nextElementSibling.id,
                      inserted_element: { originalId: selectedElementId + '-tree', id },
                    };
                  }
                  else {
                    actionObject = {
                      time: (new Date()).getTime(),
                      action: 'Append',
                      target_element: getElementById1(selectedElementId + '-tree').parentNode.id,
                      inserted_element: { originalId: selectedElementId + '-tree', id },
                    };
                  }

                  await executeCommand(actionObject, path, visual);
                  return { t: actionObject.inserted_element.id, copyId }
                }

                const { t, copyId } = await append(removeLastOccurrence(getElementById1(id).parentNode.id, '-tree'), removeLastOccurrence(id, '-tree'))

                await executeCommand({
                  time: (new Date()).getTime(),
                  action: 'InsertBefore',
                  target_element: [{ type: 'tag', id: t, }, { type: 'tag', id: el, }],
                  move: true
                }, path, visual);
                log1('main2' + JSON.stringify([{ type: 'tag', t, }, { type: 'tag', id: el, }]))
              }
              log1('main1' + JSON.stringify([{ type: 'tag', id, }, { type: 'tag', id: firstId, }]))
              await executeCommand({
                time: (new Date()).getTime(),
                action: 'InsertBefore',
                target_element: [{ type: 'tag', id, }, { type: 'tag', id: firstId, }],
                move: true
              }, path, visual);
            }
            const id = target_element[0].id
            target_element.shift()
            let restOfElements = target_element.map(el => removeLastOccurrence(el.id, '-tree')).map(el =>
              getWithoutCopyId(el))
            restOfElements = removeDuplicates(restOfElements)
            if (getElementById1(id)) {





              const items = []
              for (const element of restOfElements) {
                const l = element.split(';').length
                querySelectorAll1('[id^="' + element + '"]').forEach(el => {
                  el.id.endsWith('-tree') && el.id.split(';').length === l && items.push(el.id)
                });
              }
              if (!items.length) {
                for (const element of restOfElements) {
                  const mId = getWithoutCopyId(element)
                  log1('miiid ' + mId)
                  querySelectorAll1('[id^="' + mId + '"]').forEach(el => {
                    log1('dddd ' + el.id)
                    el.id.endsWith('-tree') && el.id.split(';').length === l && items.push(el.id)
                  });
                }
              }
              log1('iteeems' + JSON.stringify(items))

              handleWithParent(id, items)
            }
            else {
              log1('prob555')
              const mId = getWithoutCopyId(id)
              let copies = querySelectorAll1('[id^="' + mId + '"]')

              const already = []
              for (const element of copies) {
                if (element.id.endsWith('-tree') || element.id.endsWith('-fieldset')) {
                  continue
                }
                const replaceId = element.getAttribute('data-replaceid')
                log1('replace id + ' + replaceId)
                const items = []

                for (const element of restOfElements) {
                  const l = element.split(';').length
                  querySelectorAll1('[id^="' + element + '"]').forEach(el => {
                    !el.id.endsWith('-fieldset') && !el.id.endsWith('-tree') && el.id.split(';').length === l && el.getAttribute('data-replaceid') === replaceId && items.push(el.id + '-tree')
                  });
                }
                log1('prob items 1 ' + JSON.stringify(items))
                const found = items.find(item => !already.find(i => i === item))
                log1(found)
                already.push(found)
                handleWithParent(element.id + '-tree', items)
              }
            }
            break;
          }
          if (inserted_component) {
            //fieldset
            if (inserted_component.componentId.startsWith('*')) {
              const site = pathItemPath.split('/')[0]
              const modId = inserted_component.componentId.replace('*', '')
              const lsi = site + modId
              const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true&lsi1=' + lsi)
                .then(response => response.json())
              const item1 = items.find(i => i.lsi1.replace(';publish:published', '') === lsi)
              inserted_component.componentId = item1.id
            }
            else if (inserted_component.componentId.startsWith('#')) {
              let cPath = pathForRelative.prev || pathItemPath
              cPath = cPath.replace(';publish:published', "")
              log1('cpath ' + cPath)


              const relative = inserted_component.componentId.replace('#', '')
              const absolutePath = getAbsolutePath(cPath, relative);


              const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true&lsi1=' + absolutePath)
                .then(response => response.json())
              log1('lsi' + absolutePath)
              log1(JSON.stringify(items))

              const item1 = items.find(i => i.lsi1.replace(';publish:published', '') === absolutePath)
              log1(JSON.stringify(item1))
              inserted_component.componentId = item1.id
            }
            log1('in')
            log1(target_element)
            treeElement = getElementById1(target_element);
            //component
            //componentElement = getElementById1(removeLastOccurrence(target_element, '-tree'));
            //const newEl = document.createElement("div")
            //newEl.id = inserted_component.id
            //log1(newEl.id)
            //componentElement.appendChild(newEl)
            const component_el = getElementById1('component-element')
            const newEl2 = component_el.cloneNode(true)
            const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
            button2.textContent = 'üß©' + inserted_component.name;
            const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
            button.addEventListener('mouseover', mouseOverTree);

            button.addEventListener('mouseout', mouseOutTree);

            newEl2.id = inserted_component.id + '-tree'
            if (noComp || noComp1) {
              log1('no comp true')
              newEl2.setAttribute('hidden', '')
            }
            treeElement.parentNode.insertBefore(newEl2, treeElement)
            components.push(inserted_component.id)
            log1(inserted_component.componentId)
            log1('insert before replace id ' + replaceId)
            await loadFromDb(inserted_component.componentId, inserted_component.id, path, inserted_component.name, replaceActions, false, noComp || noComp1, noSubComp, lvl, removeActions, replaceId, { current: pathForRelative.prev, prev: pathForRelative.prev }, reusableId)
            break;
          }
          //case duplicate insert before
          if (inserted_element?.originalId) {
            log1('insert1' + JSON.stringify(command));
            // fieldset
            treeElement = getElementById1(inserted_element?.originalId);
            // component
            componentElement = getElementById1(removeLastOccurrence(inserted_element.originalId, '-tree'));

            // Duplicate the element
            const newEl = componentElement.cloneNode(true);
            //newEl.textContent = newEl.tagName.toLowerCase();
            // Set the id of the duplicated element to inserted_element.id
            newEl.id = removeLastOccurrence(inserted_element.id, '-tree');
            if (newEl.hasAttribute('data-visual-defaultTextNode') && newEl.hasAttribute('data-visual-element')) {
              // Set child's text content to its content
              newEl.innerText = newEl.getAttribute('data-visual-defaultTextNode')
            }
            log1(newEl.id);

            // Append the duplicated element to the componentElement
            const compEl = getElementById1(removeLastOccurrence(target_element, '-tree'))
            if (visual) {
              compEl.parentNode.parentNode.insertBefore(newEl, compEl.parentNode);
              processElement(newEl)
            }
            else {
              compEl.parentNode.insertBefore(newEl, compEl);
            }
            const newId1 = newEl.id.split(':')[newEl.id.split(':').length - 1]
            if (treeElement) {
              // Duplicate the treeElement content
              const newEl2 = treeElement.cloneNode(true);

              // Set the id of the duplicated treeElement to inserted_element.id + '-tree'
              newEl2.id = inserted_element.id;

              // Update the button text in the duplicated treeElement
              const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']");

              // Attach event listeners to the buttons in the duplicated treeElement
              const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']");
              button.addEventListener('mouseover', mouseOverTree);
              button.addEventListener('mouseout', mouseOutTree);
              const trEl = getElementById1(target_element)
              // Append the duplicated treeElement to the treeElement's parent
              treeElement.parentNode.insertBefore(newEl2, trEl)

              updateChildIdsRecursive(newEl2, newId1, true);
            }

            function updateChildIdsRecursive(element, newId1, tree) {
              const processed = []
              element.querySelectorAll('[id]').forEach(child => {
                const splited = child.id.split(';');
                const splited2 = splited[splited.length - 1].replace('-tree', '').split(':')
                let newSubId = splited2[0] + ':' + newId1
                tree && (newSubId = newSubId + '-tree')
                splited.pop()
                const processed1 = [...splited, splited2[0]].join(';')
                if (processed.find(el => el.startsWith(processed1))) {
                  log1('status' + processed1)
                  log1('status2' + JSON.stringify(processed))
                  child.remove()
                }
                else {
                  processed.push(processed1)
                  log1('proce' + processed1)
                  child.id = [...splited, newSubId].join(';')
                  if (child.hasAttribute('data-visual-defaultTextNode') && child.hasAttribute('data-visual-element')) {
                    // Set child's text content to its content
                    child.innerText = child.getAttribute('data-visual-defaultTextNode')
                  }
                  // Recursively update ids for child's children
                  updateChildIdsRecursive(child, newId1, tree);
                }

              });
            }

            // Update ids of child elements within the duplicated elements recursively
            updateChildIdsRecursive(newEl, newId1);


            break;
          }
          //case insert tag
          if (inserted_element?.tagName) {
            const handleInsert = (treeElement, componentElement, replaceCopyId) => {
              log1('handling' + treeElement + ' ' + componentElement + ' ' + replaceCopyId)
              const newEl = document.createElement(inserted_element.tagName)

              const attr1 = componentElement.getAttribute('data-replaceID')
              if (attr1) {
                newEl.setAttribute('data-replaceID', attr1)
              }
              if (noComp || noComp1) {
                newEl.setAttribute('data-replaceID', replaceId)
              }

              const splited = componentElement.id.split(';')






              newEl.id = replaceCopyId ? inserted_element.id.split(':')[0] + ':' + componentElement.getAttribute('data-replaceid') : inserted_element.id

              log1(newEl.id)

              const component_el = getElementById1('tree-element')
              const newEl2 = component_el.cloneNode(true)
              const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
              button2.textContent = 'üè∑Ô∏è' + inserted_element.tagName;
              const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
              button.addEventListener('mouseover', mouseOverTree);

              button.addEventListener('mouseout', mouseOutTree);
              newEl2.id = replaceCopyId ? inserted_element.id.split(':')[0] + ':' + componentElement.getAttribute('data-replaceid') + '-tree' : inserted_element.id + '-tree'
              if (splited.length > 1) {
                newEl.id = splited[0] + ';' + newEl.id
                newEl2.id = splited[0] + ';' + newEl2.id
              }
              if (inserted_element.tagName === 'script' || inserted_element.tagName === 'style') {
                const button = newEl2.querySelector('[data-element="redirect-to-component"]')
                button.removeAttribute('hidden')
                button.onclick = () => {
                  const redirectURL = `component.html?id=${command.id}&rand=${Math.random()}`;
                  window.open(redirectURL, '_blank');
                }
              }
              componentElement.parentNode.insertBefore(newEl, componentElement)
              treeElement.parentNode.insertBefore(newEl2, treeElement)
            }
            treeElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
              getElementById1('code-tree')
              : getElementById1(target_element)
            //component
            componentElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
              getElementById1('generated-page')
              :
              getElementById1(removeLastOccurrence(target_element, '-tree'));
            if (options?.actionInReplace) {
              const mId = target_element.replace('-tree', '').split(':')[0]
              log1('replaceIds' + JSON.stringify(replaceIds))
              replaceIds.forEach(replaceId => {
                log1(mId)
                log1(replaceId)
                const treeEl = getElementById1(mId + ':' + replaceId + '-tree')
                const compEl = getElementById1(mId + ':' + replaceId)
                handleInsert(treeEl, compEl, true)
              })
              break;
            }

            if (!componentElement) {
              log1('comp not found')
              const mId = target_element.replace('-tree', '').split(':')[0]
              const treeEls = []
              const compEls = []
              const existing = []
              const elementsWithIdAndAttribute = querySelectorAll1('[id^="' + mId + '"][data-replaceid]')
                .forEach(
                  el => {
                    log1('ffooound152 ' + el.id)
                    if (!existing.includes(el.getAttribute('data-replaceid'))) {
                      existing.push(el.getAttribute('data-replaceid'))
                      treeEls.push(getElementById1(el.id + '-tree'));
                      compEls.push(el)
                    }

                  }
                );

              for (let i = 0; i < treeEls.length; i++) {
                handleInsert(treeEls[i], compEls[i], true)
              }
              break;
            }
            log1('handling insert')
            handleInsert(treeElement, componentElement)


            break;

          }
          if (target_element.length) {
            log1(JSON.stringify(target_element))
            if (options?.actionInReplace) {
              handleAppendOrInsertReplace('InsertBefore', target_element, options?.fork, options?.transferInnerHtml)
            }
            else {
              handleAppendOrInsert('InsertBefore', target_element.map(i => i.id), move, undefined, options?.fork, options?.transferInnerHtml)
            }
          }
          break;



        case 'innerHtml':
          // Handle the 'innerHtml' action
          const targetElement = getElementById1(removeLastOccurrence(target_element, '-tree'));
          const targetElement1 = getElementById1(target_element, '-tree');
          if (targetElement1) {
            const innerHtmlButton = targetElement1.querySelector('[data-element="code-tree-inner-html-button"]');
            insertedCode ? innerHtmlButton.removeAttribute('hidden') : innerHtmlButton.setAttribute('hidden', '')
            innerHtmlButton.textContent = `‚ñ∂Ô∏è${insertedCode.length}`;

            const textContentButton = targetElement1.querySelector('[data-element="code-tree-text-content-button"]');
            textContentButton.setAttribute('hidden', '')
            textContentButton.textContent = `üìÑ`;

          }
          if (targetElement.hasAttribute('data-b-value')) {
            targetElement.setAttribute('data-b-value', true)
            let parent = targetElement.parentNode
            while (parent && parent.nodeType === 1) {
              if (parent.hasAttribute('data-b')) {
                parent.setAttribute('data-b', true)
                break;
              }
              parent = parent.parentNode;
            }

          }
          if (targetElement.tagName.toLowerCase() !== 'script') {
            targetElement.innerHTML = insertedCode.replaceAll('\n', '');
          }
          else {
            targetElement.innerHTML = insertedCode
          }


          break;
        case 'Replace_Component':
          // Handle the 'innerHtml' action
          //location.reload();
          break;
        /*
        const toReplace = target_element[0]
        target_element.shift()
        const dontReplaceIndex = target_element.findIndex(e => e.componentId === toReplace)
  
        let l = target_element.filter(e => e.componentId !== toReplace);
  
        for (const el of l) {
if (!el.already) {
  await executeCommand({
    time,
    action: 'InsertBefore',
    target_element: toReplace,
    inserted_component: el,
    noComp: true
  }, path, visual)
}
  
        }
        if (dontReplaceIndex === -1) {
const elementsToRemove = querySelectorAll1(`[id^="${removeLastOccurrence(toReplace, '-tree') + ';'}"]`);
elementsToRemove.forEach(element => element.remove());
        }
        const el = getElementById1(toReplace)
        el.setAttribute('replaced', JSON.stringify(target_element))
        const el2 = el.querySelector('[data-element="optional-script"]')
        el2.removeAttribute('hidden')
        el2.innerHTML = `üîÑ${target_element.length}`;
        break;
        */


        case 'ChangeTag':
          // Handle the 'ChangeTag' action
          // tree el
          if (options?.apply_to_copies) {
            const selector1 = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
            querySelectorAll1(selector1).forEach(e => {

              if (e.id.endsWith('-tree')) {
                e.querySelector("[data-element='code-tree-tag-name-button']").textContent = 'üè∑Ô∏è' + tag_change;
              }
              else {
                var newElement = document.createElement(tag_change);

                // Copy attributes from the div to the p element
                for (var i = 0; i < e.attributes.length; i++) {
                  var attribute = e.attributes[i];
                  newElement.setAttribute(attribute.name, attribute.value);
                }
                newElement.id = e.id
                // Copy content from the div to the p element
                newElement.innerHTML = e.innerHTML;

                // Replace the div element with the new p element

                e.parentNode.replaceChild(newElement, e);
              }
            });

            break;
          }
          const elementToChange = getElementById1(target_element);
          elementToChange.querySelector("[data-element='code-tree-tag-name-button']").textContent = 'üè∑Ô∏è' + tag_change;
          // builder el
          const elementToChange2 = getElementById1(removeLastOccurrence(target_element, '-tree'));
          if (elementToChange2) {
            // Create a new p element
            var newElement = document.createElement(tag_change);

            // Copy attributes from the div to the p element
            for (var i = 0; i < elementToChange2.attributes.length; i++) {
              var attribute = elementToChange2.attributes[i];
              newElement.setAttribute(attribute.name, attribute.value);
            }
            newElement.id = elementToChange2.id
            // Copy content from the div to the p element
            newElement.innerHTML = elementToChange2.innerHTML;

            // Replace the div element with the new p element

            elementToChange2.parentNode.replaceChild(newElement, elementToChange2);
            // Add an event listener to the entire document to track double-clicks



          }
          break;
        case 'ChangeTag+':
        case 'ChangeTagForCopies':
          // Handle the 'ChangeTag' action
          // tree el
          const selector1 = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
          querySelectorAll1(selector1).forEach(e => {

            if (e.id.endsWith('-tree')) {
              e.querySelector("[data-element='code-tree-tag-name-button']").textContent = 'üè∑Ô∏è' + tag_change;
            }
            else {
              var newElement = document.createElement(tag_change);

              // Copy attributes from the div to the p element
              for (var i = 0; i < e.attributes.length; i++) {
                var attribute = e.attributes[i];
                newElement.setAttribute(attribute.name, attribute.value);
              }
              newElement.id = e.id
              // Copy content from the div to the p element
              newElement.innerHTML = e.innerHTML;

              // Replace the div element with the new p element

              e.parentNode.replaceChild(newElement, e);
            }
          });

          break;


        case 'dublicateTag':
          // Handle the 'dublicateTag' action
          const originalElement = getElementById1(target_element);
          const originalElement2 = getElementById1(removeLastOccurrence(target_element, '-tree'));
          const duplicatedElement = originalElement.cloneNode(true);
          const duplicatedElement2 = originalElement2.cloneNode(true);
          //to do
          duplicatedElement.id = inserted_element
          duplicatedElement2.id = removeLastOccurrence(inserted_element, '-tree');

          originalElement.parentNode.appendChild(duplicatedElement);
          originalElement2.parentNode.appendChild(duplicatedElement2);
          break;

        case 'removeTag':
          // Handle the 'removeTag' action
          // tree
          if (options?.apply_to_copies) {
            const selector = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
            querySelectorAll1(selector).forEach(e => e.remove());
            break;
          }
          const elementToRemove = getElementById1(target_element);
          elementToRemove && elementToRemove.parentNode.removeChild(elementToRemove);

          // component
          const elementToRemove2 = getElementById1(removeLastOccurrence(target_element, '-tree'));
          elementToRemove2 && elementToRemove2.parentNode.removeChild(elementToRemove2);


          break;
        case 'removeTagAndCopies':
        case 'removeTag+':
          // Handle the 'removeTag' action

          // component
          const selector = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
          querySelectorAll1(selector).forEach(e => e.remove());



          break;
        case 'removeComponent':
          // Handle the 'removeTag' action
          // tree



          break;
        case 'textContent':
          // Handle the 'removeTag' action
          // tree
          log1('pr' + target_element)
          const element1 = getElementById1(target_element);
          if (element1) {
            const textContentButton = element1.querySelector('[data-element="code-tree-text-content-button"]');
            value ? textContentButton.removeAttribute('hidden') : textContentButton.setAttribute('hidden', '')
            textContentButton.textContent = `üìÑ${value.length}`;

            const innerHtmlButton = element1.querySelector('[data-element="code-tree-inner-html-button"]');
            innerHtmlButton.setAttribute('hidden', '')
            innerHtmlButton.textContent = `‚ñ∂Ô∏è`;
          }


          // component
          const element2 = getElementById1(removeLastOccurrence(target_element, '-tree'));
          if (element2.hasAttribute('data-b-value')) {
            element2.setAttribute('data-b-value', true)
            let parent = element2.parentNode
            while (parent && parent.nodeType === 1) {
              if (parent.hasAttribute('data-b')) {
                parent.setAttribute('data-b', true)
                break;
              }
              parent = parent.parentNode;
            }

          }
          element2.textContent = value;


          break;
        case 'Add_Comment':
          // Handle the 'removeTag' action
          // tree
          const comment = insertedCode
          const target = getElementById1(target_element)
          const commentField = target.querySelector('[data-element="comment"]')
          commentField.removeAttribute('hidden')
          commentField.textContent = 'üí¨' + comment


          break;
        case 'Remove_Comment':
          // Handle the 'removeTag' action
          // tree
          const target1 = getElementById1(target_element)
          const commentField1 = target1.querySelector('[data-element="comment"]')
          commentField1.setAttribute('hidden', "")
          commentField1.textContent = 'üí¨'


          break;

        // Add more cases as needed for other actions
        case 'removeAttributeFromCopies':
        case 'removeAttribute+':
          log1('pr' + target_element);

          const selector111 = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
          const els111 = querySelectorAll1(selector111); // Corrected the function name to document.querySelectorAll
          // component
          for (const elementToRemoveAttribute of els111) {
            if (key) { // Check if key exists
              elementToRemoveAttribute.removeAttribute(key);
              if (key === 'data-parentid') {
                querySelectorAll1('[id^="' + elementToRemoveAttribute.id + ';"]').forEach(el => {
                  el.id = el.id.replace(elementToRemoveAttribute.id + ';', '');
                });
              }
            }
          }
          break;
        case 'setAttribute':
          if (key.startsWith('data-import-')) {
            imports1.push({ name: key.replace('data-import-', ''), component: componentPath.split('/').pop() })
          }
          if (key.startsWith('data-import_')) {
            console.log('gg5')
            imports1.push({ name: key.replace('data-import_', ''), component: componentPath.split('/').pop() })
          }
          if (options?.apply_to_copies) {
            target_element = target_element.endsWith('-tree') ? target_element : target_element + '-tree'
            const allSelector = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
            const allTargets = Array.from(querySelectorAll1(allSelector)).filter(element => !element.id.endsWith('-fieldset') && !element.id.endsWith('-tree'))

            // component

            if (key === 'style' || key === 'class') {

              allTargets.forEach(element => element.setAttribute(key, value))
              break;
            }
            //allTargets.forEach(element => getElementById1(element.id + '-tree').querySelector('[data-element="code-tree-attributes-button"]').removeAttribute('hidden'));

            for (const element22 of allTargets) {
              const element33 = getElementById1(element22.id + 'tree');


              if (key) {
                log1('key11 ' + key)
                log1('value ' + value)

                element22.setAttribute(key, value);
                if (!element22.textContent && key.toLowerCase() === 'data-visual-defaultTextNode'.toLowerCase()) {
                  log1('not found 111')
                  element22.textContent = value
                }
              }

              if (key === 'data-parentid') {
                recursivelyChangeIDs(element22, removeLastOccurrence(target_element, '-tree'), true);
                recursivelyChangeIDs(element33, removeLastOccurrence(target_element, '-tree'), true, true);
              }
            }
            break;
          }
          log1('pr' + target_element);
          target_element = target_element.endsWith('-tree') ? target_element : target_element + '-tree'

          // component
          /*
          if (key === 'style' || key === 'class') {
            const selector = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
            querySelectorAll1(selector).forEach(element => !element.id.endsWith('-fieldset') && !element.id.endsWith('-tree') && element.setAttribute(key, value))
            break;
          }
          */

          const element22 = getElementById1(removeLastOccurrence(target_element, '-tree'));
          const element33 = getElementById1(target_element);
          if (element22.tagName.toLowerCase() === 'img' && key === 'src') {
            imagesIds.push(element22.id)

          }
          const attributeButton = element33.querySelector('[data-element="code-tree-attributes-button"]');
          attributeButton.removeAttribute('hidden')
          if (check_b) {
            if (element22.hasAttribute('data-b-value')) {
              element22.setAttribute('data-b-value', true)
              let parent = element22.parentNode;

              while (parent && parent.nodeType === 1) {
                if (parent.hasAttribute('data-b')) {
                  parent.setAttribute('data-b', true)
                  break;
                }
                parent = parent.parentNode;
              }





            }
          }
          if (key) {
            log1('key11 ' + key)
            log1('value ' + value)

            element22.setAttribute(key, value);
            if (!element22.textContent && key.toLowerCase() === 'data-visual-defaultTextNode'.toLowerCase()) {
              log1('not found 111')
              element22.textContent = value
            }
          }

          if (key === 'data-parentid') {
            recursivelyChangeIDs(element22, removeLastOccurrence(target_element, '-tree'), true);
            recursivelyChangeIDs(element33, removeLastOccurrence(target_element, '-tree'), true, true);
          }
          break;
        case 'setAttribute+':
          log1('pr' + target_element);
          target_element = target_element.endsWith('-tree') ? target_element : target_element + '-tree'
          const allSelector = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
          const allTargets = Array.from(querySelectorAll1(allSelector)).filter(element => !element.id.endsWith('-fieldset') && !element.id.endsWith('-tree'))

          // component

          if (key === 'style' || key === 'class') {

            allTargets.forEach(element => element.setAttribute(key, value))
            break;
          }
          const attributeButton1 = getElementById1(target_element).querySelector('[data-element="code-tree-attributes-button"]');
          attributeButton1.removeAttribute('hidden')
          for (const element22 of allTargets) {

            const element33 = getElementById1(element22.id + 'tree');


            if (key) {
              log1('key11 ' + key)
              log1('value ' + value)

              element22.setAttribute(key, value);
              if (!element22.textContent && key.toLowerCase() === 'data-visual-defaultTextNode'.toLowerCase()) {
                log1('not found 111')
                element22.textContent = value
              }
            }

            if (key === 'data-parentid') {
              recursivelyChangeIDs(element22, removeLastOccurrence(target_element, '-tree'), true);
              recursivelyChangeIDs(element33, removeLastOccurrence(target_element, '-tree'), true, true);
            }
          }
          break;
        case 'removeAttribute':
          log1('pr' + target_element);
          if (options?.apply_to_copies) {
            const selector111 = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
            const els111 = querySelectorAll1(selector111); // Corrected the function name to document.querySelectorAll
            // component
            for (const elementToRemoveAttribute of els111) {
              if (key) { // Check if key exists
                elementToRemoveAttribute.removeAttribute(key);
                if (key === 'data-parentid') {
                  querySelectorAll1('[id^="' + elementToRemoveAttribute.id + ';"]').forEach(el => {
                    el.id = el.id.replace(elementToRemoveAttribute.id + ';', '');
                  });
                }
              }
            }
            break;
          }

          // component
          const elementToRemoveAttribute = getElementById1(removeLastOccurrence(target_element, '-tree'));
          key && elementToRemoveAttribute.removeAttribute(key);
          if (key === 'data-parentid') {
            querySelectorAll1('[id^="' + removeLastOccurrence(target_element, '-tree') + ';"]').forEach(el => {
              el.id = el.id.replace(removeLastOccurrence(target_element, '-tree') + ';', '')
            });
          }

          break;


        // Add more cases as needed for other actions

        default:
          // Handle the default case if no matching action is found
          console.error(`Unknown action: ${action}`);
          break;
      }

    }
    async function loader(e, handler) {
      const loadingScreen = getElementById1('loading');
      loadingScreen.style.display = 'flex';
      const prefixesToRemove = [
        'component-element',
        'tree-element',
        'component-replace-menu',
        'code-tree-tag-attributes-form',
        'code-tree-click-tag',
        'code-tree-add-tag-step-1',
        'code-tree-append-or-insert-approv-menu',
        'code-tree-inner-html-receive-menu',
        'tag-table',
        "code-tree-tag-text-content-form"
      ];

      prefixesToRemove.forEach(prefix => {
        const p = getElementById1("code-tree")
        const elementsToRemove = p.querySelectorAll(`fieldset[id^="${prefix}"]`);
        elementsToRemove.forEach(element => element.remove());
      });
      const timerElement = getElementById1('timer');
      let tenthsOfSeconds = 0;
      const interval = setInterval(function () {
        tenthsOfSeconds++;
        timerElement.textContent = (tenthsOfSeconds / 10).toFixed(1);
      }, 100);

      await handler(e);

      loadingScreen.style.display = 'none';
      clearInterval(interval);
      log1(timerElement.textContent)
      const lastActionTime = getElementById1('last-action-time');

      lastActionTime.textContent = timerElement.textContent;
    }
    function openAttributeContent(event) {
      const button = event.target.closest('button[data-element="code-tree-attributes-button"]');
      const checked = event.target.parentNode.querySelector('#applyToCopies')?.checked || false
      if (button) {

        const s = button.parentNode.id.split(';')

        const parentId = button.parentNode.id.replace('code-tree-click-tag;', '');
        const generatedId = removeLastOccurrence(parentId, '-tree')
        const textContentButton = button.parentNode.querySelector('[data-element="code-tree-attributes-button]');

        const existingClonedFieldset = button.parentNode.querySelector('[id^="code-tree-tag-attributes-form-1"]');

        if (!existingClonedFieldset) {
          // Clone the fieldset node
          const fieldset = getElementById1('code-tree-tag-attributes-form-1');
          const clonedFieldset = fieldset.cloneNode(true);
          clonedFieldset.querySelector('#applyToCopies').checked = checked
          // Assign a unique id to the cloned fieldset
          clonedFieldset.id = 'code-tree-tag-attributes-form-1;' + parentId;

          // Find the position to insert the cloned fieldset
          const insertAfterElement = textContentButton || button;

          // Insert the cloned fieldset after the specified element
          const toA = insertAfterElement.closest('[data-open-menu]') || insertAfterElement.parentNode.querySelector('[data-open-menu]')
          // Insert the cloned fieldset after the specified element
          removeMenus()
          toA.append(clonedFieldset)
          const elementWithAttributes = getElementById1(generatedId);
          if (elementWithAttributes) {
            const attributesList = clonedFieldset.querySelector('#code-tree-tag-attributes-list');



            // Clone the original tr element for each attribute
            const originalTr = clonedFieldset.querySelector('#code-tree-tag-attributes-list-item');
            for (const attribute of elementWithAttributes.attributes) {
              const clonedTr = originalTr.cloneNode(true);

              // Modify data based on attributes of the elementWithAttributes
              const keyElement = clonedTr.querySelector('#code-tree-tag-attribute-key');
              const valueElement = clonedTr.querySelector('#code-tree-tag-attribute-value');

              keyElement.textContent = attribute.name;
              valueElement.textContent = attribute.value;

              // Append the modified tr to the list
              attributesList.appendChild(clonedTr);
            }

            // Remove the original tr element
            originalTr.remove();

          }

        }
      }
    }
    function openTextContent(event) {
      const button = event.target.closest('button[data-element="code-tree-text-content-button"]');

      if (button) {
        const parentId = button.parentNode.id.replace('code-tree-click-tag;', '')
        const textContentButton = button.parentNode.querySelector('[data-element="code-tree-text-content-button"]');

        const existingClonedFieldset = button.parentNode.querySelector('[id^="code-tree-tag-text-content-form"]');

        if (!existingClonedFieldset) {
          // Clone the fieldset node
          const fieldset = getElementById1('code-tree-tag-text-content-form');
          const clonedFieldset = fieldset.cloneNode(true);
          clonedFieldset.querySelector('textarea').value = getElementById1(parentId.replace('-tree', '')).innerHTML
          // Assign a unique id to the cloned fieldset
          clonedFieldset.id = 'code-tree-tag-text-content-form;' + parentId;

          // Find the position to insert the cloned fieldset
          const insertAfterElement = textContentButton || button;
          const toA = insertAfterElement.closest('[data-open-menu]') || insertAfterElement.parentNode.querySelector('[data-open-menu]')
          // Insert the cloned fieldset after the specified element
          removeMenus()
          toA.append(clonedFieldset)
        }
      }
    }
    function openInnerHtmlContent(event) {
      const button = event.target.closest('button[data-element="code-tree-inner-html-button"]');

      if (button) {
        const parentId = button.parentNode.id.replace('code-tree-click-tag;', '')
        const textContentButton = button.parentNode.querySelector('[data-element="code-tree-inner-html-button"]');

        const existingClonedFieldset = button.parentNode.querySelector('[id^="code-tree-tag-html-content-form"]');

        if (!existingClonedFieldset) {
          // Clone the fieldset node
          const fieldset = getElementById1('code-tree-tag-html-content-form');
          const clonedFieldset = fieldset.cloneNode(true);
          clonedFieldset.querySelector('textarea').value = getElementById1(parentId.replace('-tree', '')).innerHTML
          // Assign a unique id to the cloned fieldset
          clonedFieldset.id = 'code-tree-tag-html-content-form;' + parentId;

          // Find the position to insert the cloned fieldset
          const insertAfterElement = textContentButton || button;

          // Insert the cloned fieldset after the specified element
          const toA = insertAfterElement.closest('[data-open-menu]') || insertAfterElement.parentNode.querySelector('[data-open-menu]')
          // Insert the cloned fieldset after the specified element
          removeMenus()
          toA.append(clonedFieldset)
        }
      }
    }
    function openComment(event) {

      const button = event.target.closest('button[data-element="code-tree-comment-button"]');

      if (button) {
        const parentId = button.parentNode.id;
        const splited = parentId.split(';')
        splited.shift()
        const textContentButton = button.parentNode.querySelector('[data-element="code-tree-comment-button"]');

        const existingClonedFieldset = button.parentNode.querySelector('[id^="code-tree-comment-form"]');

        if (!existingClonedFieldset) {
          // Clone the fieldset node
          const fieldset = getElementById1('code-tree-comment-form');
          const insertAfterElement = textContentButton || button;
          const toAppend = insertAfterElement.parentNode.closest('[data-open-menu]')
          removeMenus()
          const clonedFieldset = fieldset.cloneNode(true);
          //clonedFieldset.querySelector('textarea').value = getElementById1(parentId.replace('-tree', '')).textContent
          // Assign a unique id to the cloned fieldset
          clonedFieldset.id = 'code-tree-comment-form";' + splited.join(';');
          clonedFieldset.querySelector('#comment-content').value = getElementById1(splited.join(';')).querySelector('[data-element="comment"]').textContent.replace('üí¨', '')

          // Find the position to insert the cloned fieldset


          // Insert the cloned fieldset after the specified element
          toAppend.append(clonedFieldset)
        }
      }
    }
    const saveComment = async (event) => {

      const action = 'Add_Comment'
      log1('ac' + action)

      const saveButton = event.target;
      const fieldset = saveButton.parentNode


      const textareaValue = fieldset.querySelector('#comment-content').value;
      const splited = fieldset.id.split(';')
      const [toRemove, ...rest] = splited
      log1('fid' + fieldset.id)

      const el = {
        time: (new Date()).getTime(),
        action,
        target_element: rest.join(';'),
        insertedCode: textareaValue,

      }
      log1(JSON.stringify(el))
      await pushAction(el)

      removeMenus()
      log1(JSON.stringify(actionLog))

    }
    const removeComment = async (event) => {

      const action = 'Remove_Comment'
      log1('ac' + action)

      const saveButton = event.target;
      const fieldset = saveButton.parentNode



      const splited = fieldset.id.split(';')
      const [toRemove, ...rest] = splited
      log1('fid' + fieldset.id)

      const el = {
        time: (new Date()).getTime(),
        action,
        target_element: rest.join(';'),

      }
      log1(JSON.stringify(el))
      await pushAction(el)

      removeMenus()
      log1(JSON.stringify(actionLog))

    }

    function handleComponentClick(event) {
      const button = event.target.closest('button[data-element="code-tree-tag-name-button"]');
      log1('in111')
      if (button) {
        const parentId = button.parentNode.id;
        const textContentButton = button.parentNode.querySelector('[data-element="code-tree-text-content-button"]');

        // Check if a cloned fieldset already exists after the parent node
        const existingClonedFieldset = button.parentNode.querySelector('[id^="code-tree-click-component"]');

        if (!existingClonedFieldset) {
          // Clone the fieldset node
          const fieldset = getElementById1('code-tree-click-component');
          const clonedFieldset = fieldset.cloneNode(true);

          // Assign a unique id to the cloned fieldset
          clonedFieldset.id = 'code-tree-click-component;' + parentId;
          clonedFieldset.setAttribute('path', button.getAttribute('path'))
          clonedFieldset.setAttribute('replaced', button.parentNode.getAttribute('replaced'))
          clonedFieldset.setAttribute('replacedFolders', button.parentNode.getAttribute('replacedFolders'))
          if (event.target.hasAttribute('anchor')) {
            clonedFieldset.querySelector('#set_anchor_checkbox').checked = true
          }
          // Find the position to insert the cloned fieldset
          const insertAfterElement = textContentButton || button;
          if (button.parentNode.hasAttribute('data-first-child')) {
            const changeTargetButton = clonedFieldset.querySelector('#target-button')
            changeTargetButton.removeAttribute('hidden')
            const codeTreeTagFieldsets = querySelectorAll1('fieldset[data-element="code-tree-tag"]');
            changeTargetButton.onclick = (e) => {
              codeTreeTagFieldsets.forEach((fieldset) => {
                var checkbox = fieldset.querySelector('input[type="checkbox"]');
                if (checkbox) {
                  checkbox.removeAttribute('hidden');
                  checkbox.onchange = async (event) => {
                    event.preventDefault()
                    const id = checkbox.closest('fieldset').id
                    //set action target
                    log1(parentId)
                    log1(JSON.stringify(actions))
                    const foundAction = actions.find(action => action.inserted_component.id === removeLastOccurrence(parentId, "-tree"))
                    if (foundAction.options) {
                      foundAction.options.attachId = id
                    }
                    else {
                      foundAction.options = { attachId: id }

                    }
                    await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify(foundAction),
                    });
                    location.reload()
                  }
                }

              });
            }

          }
          if (pathItemPath.split(';')[0].endsWith('Hub')) {
            const contentEl = clonedFieldset.querySelector('#content-type')
            const catWeight = contentEl.querySelector('#catalog-weight')
            const catFolder = contentEl.querySelector('#catalog-folder')
            catFolder.querySelector('button').addEventListener('click', async (e) => {
              const inputV = catFolder.querySelector('input').value
              pathItem.hub_items.article_folder = inputV
              delete pathItem.hub_items.catalog_page_weight
              await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                body: JSON.stringify(pathItem),
              });
              clonedFieldset.remove()
            })
            catWeight.querySelector('button').addEventListener('click', async (e) => {
              const inputV = catWeight.querySelector('input').value
              pathItem.hub_items.catalog_page_weight = inputV
              delete pathItem.hub_items.article_folder
              await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                body: JSON.stringify(pathItem),
              });
              clonedFieldset.remove()
            })
            function handleRadioChange(event) {
              // Check which radio button is selected
              if (!event.target.checked) {
                return
              }
              const selectedValue = event.target.value;
              if (!pathItem.hub_items) {
                pathItem.hub_items = {}
              }
              const menu = event.target.closest('[data-menu]')
              const path = menu.getAttribute('path')
              const splited = path.split(';')[0].split('|')
              const name = splited[1]
              // Run different functions based on the selected radio button

              catWeight.setAttribute('hidden', '')
              const mainContentSpan = clonedFieldset.closest('[data-element="code-tree-tag"]').querySelector('[data-element="content_type"]')
              catFolder.setAttribute('hidden', '')
              switch (selectedValue) {
                case 'none':
                  delete pathItem.hub_items.main_content
                  delete pathItem.hub_items.catalog_page_weight
                  delete pathItem.hub_items.article_folder
                  mainContentSpan.setAttribute('hidden', '')
                  break;
                case 'article':
                  pathItem.hub_items.main_content = 'article:' + name
                  mainContentSpan.removeAttribute('hidden', '')
                  mainContentSpan.textContent = '‚≠ê Article'
                  catFolder.removeAttribute('hidden')
                  break;
                case 'catalog':
                  pathItem.hub_items.main_content = 'catalog:' + name
                  mainContentSpan.removeAttribute('hidden', '')
                  mainContentSpan.textContent = '‚ú® Catalog'
                  catWeight.removeAttribute('hidden')
                  break;
                default:
                  // Handle default case
                  break;
              }
              fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                body: JSON.stringify(pathItem),
              });
            }
            contentEl.querySelectorAll("[data-content-type]").forEach(element => {
              element.addEventListener('change', handleRadioChange)
            })
            const splited = pathItem.hub_items?.main_content?.split(':')
            if (splited) {
              if (splited[0] === 'article') {
                contentEl.querySelector('[data-content-type="article"]').checked = true
                contentEl.querySelector('#catalog-folder').removeAttribute('hidden')
                contentEl.querySelector('#catalog-folder').querySelector('input').value = pathItem.hub_items.article_folder || ''
              }
              else {

                contentEl.querySelector('[data-content-type="catalog"]').checked = true
                contentEl.querySelector('#catalog-weight').removeAttribute('hidden')
                contentEl.querySelector('#catalog-weight').querySelector('input').value = pathItem.hub_items.catalog_page_weight || ""
              }
            }

            contentEl.removeAttribute('hidden')
          }
          // Insert the cloned fieldset after the specified element
          insertAfterElement.parentNode.querySelector('[data-open-menu]').append(clonedFieldset)
        }
      }
    }
    function handleTreeClick(event) {
      removeMenus()
      const button = event.target
      log1('tree clicked')
      if (button) {
        const parentId = button.parentNode.id;
        const textContentButton = button.parentNode.querySelector('[data-element="code-tree-text-content-button"]');

        // Check if a cloned fieldset already exists after the parent node
        const existingClonedFieldset = button.parentNode.querySelector('[id^="code-tree-click-tag;"]');

        if (!existingClonedFieldset) {
          // Clone the fieldset node
          log1('in1')
          const fieldset = getElementById1('code-tree-click-tag');
          log1(fieldset.innerHTML)
          const clonedFieldset = fieldset.cloneNode(true);

          // Assign a unique id to the cloned fieldset
          clonedFieldset.id = 'code-tree-click-tag;' + parentId;

          // Find the position to insert the cloned fieldset
          const insertAfterElement = textContentButton || button;

          // Insert the cloned fieldset after the specified element
          insertAfterElement.parentNode.querySelector('[data-open-menu]').append(clonedFieldset)
        }
      }
    }

    var updateComponentsMap = false

    function deepCopy(obj) {
      if (typeof obj !== 'object' || obj === null) {
        // Return the input if it's not an object
        return obj;
      }

      // Create an empty object or array to hold the copied values
      const copied = Array.isArray(obj) ? [] : {};

      // Iterate over each key in the original object
      for (let key in obj) {
        // Recursively copy nested objects or arrays
        copied[key] = deepCopy(obj[key]);
      }

      return copied;
    }

    function removeDuplicates(arr) {
      return Array.from(new Set(arr));
    }
    const setOptions = (item) => {
      const { testPage, optionalScript, LinkBP } = item
      testPage && switchTest(false)
      optionalScript && switchOptionalScript(false)
      LinkBP && switchLinkBP(false)
    }
    let foundMainContent
    //let foundAnchors = []
    var getLinks = () => {
      const [s, ...rest] = pathItemPath.split('/')
      if (rest[rest.length - 1].toLowerCase() === 'hub') {
        if (rest[rest.length - 2]?.toLowerCase() === 'home') {
          rest.pop()

        }
        rest[rest.length - 1] = 'index.html'
      }
      else {
        rest[rest.length - 1] = rest[rest.length - 1] + '.html'
      }
      const key = rest.join('/').toLowerCase()
      const s3link = 'https://s3.amazonaws.com/' + s.toLowerCase() + '/' + key
      const pLink = 'https://' + s.toLowerCase() + '/' + key.replace('index.html', '')
      return { s3link, pLink }
    }
    var loadFromDb = async (id, newId, p, timestamp, upperReplaceActions, ignore, noComp11, noSubComp, lvl, upperRemoveActions, replaceId, pathForRelative, treeElement, reusableId, attachId) => {
      log1('load from db' + id + 'reusable' + reusableId + 'attachid' + attachId)
      log1('err2 ' + p)
      log1('path for relative ' + pathForRelative?.current)
      let newPathForRelative = pathForRelative?.current
      let next = pathForRelative?.next || []
      let path = ""
      p && (path = p)
      const urlSearchParams = new URLSearchParams(window.location.search);
      let idFromLink = urlSearchParams.get('id');
      let responseData
      const showSku = async (sku) => {
        log1('showing sku ' + sku)
        getElementById1("input-sku").setAttribute('hidden', '')
        getElementById1("create-sku").setAttribute('hidden', '')
        const item1 = getElementById1("sku-item-1")
        const cloned1 = item1.cloneNode(true)
        cloned1.id = sku
        cloned1.removeAttribute('hidden')
        getElementById1("sku-list").removeAttribute('hidden')
        cloned1.querySelector("#sku-value").textContent = sku
        cloned1.querySelector("#remove-sku").setAttribute('hidden', '')
        const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${sku}&sk=qty;&startsWith=true`)
          .then(response => response.json())
        const el = cloned1.querySelectorAll('#sku-item')
        const parent = cloned1.querySelector('#sku-attribute-list')
        //if (items.length > 1) {

        const p = items.map(async item => {

          const cloned = el[0].cloneNode(true)
          const v = item.sk.replace('qty;', '')
          cloned.querySelector('#sku-attribute-value').textContent = v
          const psk = `price;${pathItemPath.split('/')[0].toLowerCase()};${v}price`
          const pItem = await fetch(`${backend_url}?id=${sku}&sk=${psk}&startsWith=true`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          }).then(e => e.json()).then(({ items }) => items[0])

          cloned.querySelector('#sku-qty').textContent = item.qty || 0
          const oldEl = cloned.querySelector('[data-price_old_value]')
          const pEl = cloned.querySelector('[data-price_value]')
          oldEl.textContent = pItem?.oldprice || 0
          pEl.textContent = pItem?.price || 0
          pEl.addEventListener('blur', async function () {
            let value = -1
            try {
              value = parseFloat(pEl.textContent)
            }
            catch (e) {

            }
            if (value < 0) {
              value = 0
              pEl.textContent = 0
            }


            let nV = pItem
            if (nV) {
              nV.price = value
            }
            else {
              nV = {
                id: sku,
                sk: psk,
                price: value
              }
            }
            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              body: JSON.stringify(nV),
            });
          });
          oldEl.addEventListener('blur', async function () {
            let value = -1
            try {
              value = parseFloat(oldEl.textContent)
            }
            catch (e) {

            }
            if (value < 0) {
              value = 0
              oldEl.textContent = 0
            }


            let nV = pItem
            if (nV) {
              nV.oldprice = value
            }
            else {
              nV = {
                id: sku,
                sk: psk,
                oldprice: value
              }
            }
            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              body: JSON.stringify(nV),
            });
          });
          parent.appendChild(cloned)
          cloned.addEventListener('click', e => handleSkuItemClick(cloned, item))
        })
        await Promise.all(p)

        /*
        }
 
        else {
          const cloned = el[0].cloneNode(true)
          cloned.querySelector('#sku-attribute-value').textContent = 'Solo'
          cloned.querySelector('#sku-qty').textContent = items[0].qty || 0
          parent.appendChild(cloned)
          cloned.addEventListener('click', e => handleSkuItemClick(cloned, items[0], sku))
        }*/
        getElementById1("sku-list").appendChild(cloned1)
        el.forEach(e => e.remove())
      }
      if (id) {

        responseData = await getRes(id)
        const reusableId1 = reusableId ? reusableId + '|' : ''
        const { items } = responseData
        log1('iteeems ' + JSON.stringify(items))
        //change component 
        const lsi1 = items.find(e => e.sk === 'path').lsi1
        const subPath = convertToOldPath(lsi1.split(';')[0])
        const splited = subPath.split('/')
        const name = splited[splited.length - 1]
        const { testPage, optionalScript } = items.find(e => e.sk === 'path')
        const el1 = treeElement || getElementById1(reusableId1 + newId + '-tree')

        if ((testPage && lvl > 2) || (optionalScript && localStorage.getItem('visualOn'))) {
          el1.remove()
          return
        }
        else if (testPage) {
          el1.querySelector('[data-element="code-tree-test-button"]').removeAttribute('hidden')
          el1.querySelector('[data-element="code-tree-text-content-button"]').remove()
          el1.querySelector('[data-element="code-tree-inner-html-button"]').remove()
        }

        const el = el1.querySelector("[data-element='code-tree-tag-name-button']")

        el.textContent = 'üß©' + name
        el.setAttribute('name', name)
        el.setAttribute('path', items.find(e => e.sk === 'path').lsi1)
        const logSearch = reusableId1 + newId
        log1('searching log ' + logSearch)
        const logE = document.querySelectorAll(`[log-id="${logSearch}"]`).forEach(e => e.textContent = e.textContent.replace('{name}', name))
        document.querySelectorAll(`[data-log-id="${logSearch}"]`).forEach(e => {
          e.querySelector("#action-add-component-name").textContent = name
          e.querySelector("#action-add-component-id").textContent = id
          e.querySelector("#action-add-component-path").textContent = subPath
          lastCompPath = subPath
          e.querySelector("#action-component-redirect").onclick = (e) => {
            const redirectURL = `component.html?id=${id}&rand=${Math.random()}`;
            window.open(redirectURL, '_blank');
          }

        })
        log1('sId ' + id)
        document.querySelectorAll(`[replace-names="${newId}-tree"]`).forEach(e => {
          e.querySelector("#replaced-component-name-value").textContent = name
          e.querySelector("#replaced-component-path-value").textContent = subPath

        })

        if (pathItem.hub_items?.main_content) {
          const splited = pathItem.hub_items?.main_content?.split(':')
          if (name === splited[1] && !foundMainContent) {
            foundMainContent = true
            const span = el1.querySelector('[data-element="content_type"]')

            span.removeAttribute('hidden')
            if (splited) {
              if (splited[0] === 'article') {
                span.textContent = '‚≠ê Article'
              }
              else {
                span.textContent = '‚ú® Catalog'

              }
            }

          }
        }
        if (pathItem.hub_items?.anchor) {
          if (typeof pathItem.hub_items.anchor === 'string') {

            pathItem.hub_items.anchor = []
          }
          const absolutes = pathItem.hub_items.anchor.map(e => getAbsolutePath(pathItemPath, e))
          if (absolutes.includes(lsi1)) {
            el.setAttribute('anchor', "")
            el1.querySelector('[data-element="set_anchor"]').removeAttribute('hidden')
          }

        }
        if (pathItem.hub_items?.article_page && pathItem.hub_items?.catalogue_component === newId) {
          el1.querySelector('[data-element="catalog"]').removeAttribute('hidden')


        }
        //insertDataIntoCodeLog(timestamp, idFromLink, { name })
      }
      else {
        if (!pathItem) {
          window.location.href = 'index.html'
        }
        components.push(idFromLink)
        responseData = await getRes(idFromLink, true)
        const { items } = responseData
        //pathItem = items.find(e => e.sk === 'path')
        const map = items.find(e => e.sk === 'componentsMap')
        actions = items.filter(i => i.action)
        let r;

        if (map && localStorage.getItem('executionToggle')) {
          r = Promise.all(map.items.map(id => getRes(id, false, true)))
        }




        if (pathItemPath.toLowerCase().includes('seositeshome.com/seed-home/hub')) {
          if (pathItem.hub_items) {
            pathItem.hub_items.style = pathItemPath.split('/')[0]
          }
          else {
            pathItem.hub_items = { style: pathItemPath.split('/')[0] }
          }
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            body: JSON.stringify(pathItem),
          });
        }
        const splited = pathItemPath.split(';')[0].split('/')

        log1('path item ' + JSON.stringify(pathItem))
        setOptions(pathItem)
        const name = splited[splited.length - 1]
        if (name.toLowerCase() === 'breadcrumb-content') {
          getElementById1('breadCrumb-menu').removeAttribute('hidden')
        }
        const el = getElementById1(idFromLink + '-tree').querySelector("[data-element='code-tree-tag-name-button']")
        el.textContent = 'üß©' + name
        el.setAttribute('path', pathItem.lsi1)
        await r;
        //insertDataIntoCodeLog('root', idFromLink, { name })
      }
      if (!idFromLink) {
        throw new Error('Missing id parameter in the URL');
      }

      // Make a GET request to the API with the 'id' query parameter

      if (!ignore) {
        const upper = upperReplaceActions ? upperReplaceActions : []
        const upper1 = upperRemoveActions ? upperRemoveActions : []
        const replaceActions = [...responseData.items.filter(el => el.action === 'Replace_Component'), ...upper]
        const removeActions = [...responseData.items.filter(el => el.action === 'removeComponent'), ...upper1]
        const componentPath = convertToOldPath(responseData.items.find(e => e.sk === 'path')?.lsi1.replace(';publish:published', ''))
        log1('compP' + componentPath)
        const componentFileName = componentPath.split('/')[componentPath.split('/').length - 1]
        if (id) {
          const relativecomponentFileName = pathForRelative?.current.split('/')[pathForRelative.current.split('/').length - 1]
          if (componentFileName !== relativecomponentFileName) {
            newPathForRelative = componentPath
            next = []
            log1('test relative different ' + componentFileName + 'diff ' + relativecomponentFileName + ' path ' + newPathForRelative)
          }
          else {
            next.push(componentPath)
            log1('test relative same ' + componentFileName + ' path ' + newPathForRelative)
          }
        }
        const sortItems = async (items) => {
          const position = items.find(e => e.sk === 'positions')
          if (!position) {
            const positions = {
              id: id || idFromLink,
              sk: 'positions',
              positions: items.filter(e => e.action).map(e => e.sk)
            }
            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              body: JSON.stringify(positions),
            });
            return [...items, positions]
          }
          const actionItems = items.filter(a => a.action)
          const nonActionItems = items.filter(a => !a.action)
          const newActionItems = []
          for (const timestamp of position.positions) {
            const toP = actionItems.find(item => item.sk === timestamp)
            toP && newActionItems.push(toP)
          }
          return [...nonActionItems, ...newActionItems]
        }
        responseData.items = await sortItems(responseData.items)
        for (const item of responseData.items) {
          if (!id) {
            if (item.sk === 'path') {
              const el = getElementById1('page-path')

              el.textContent = convertToOldPath(item.lsi1).replace(';publish:published', '')
              const hub = pathItemPath.split(';')[0].endsWith('/Hub')
              if ((!hub && pathItem.hosting_time?.published && !pathItemPath.split(';')[0].endsWith('/Head-Content') && !pathItem.hosting_time?.removed) || (hub && headContentItem?.hosting_time?.published && !headContentItem?.hosting_time?.removed)) {
                const el2 = getElementById1("path-icon")
                el2.classList.add('b-green');
                el2.classList.add('b-selected');
                const el3 = getElementById1("published-label")
                const el4 = getElementById1("published-invalidate")
                const el5 = getElementById1("published-remove")
                const pSiteLabel = getElementById1("published-site-label")
                el3.removeAttribute('hidden')
                pSiteLabel.removeAttribute('hidden')
                el4.removeAttribute('hidden')
                el5.removeAttribute('hidden')
                if (!item.href) {
                  const { s3link } = getLinks()
                  item.href = s3link
                }
                el3.setAttribute('href', item.href)
                pSiteLabel.setAttribute('href', item.href?.replace('s3.amazonaws.com/', '').replace('index.html', ''), '')
              }
            }
            else if (item.sk === 'positions') {
              positionItem = item
            }

          }
          else if (item.sk === 'path') {
            let currentSku
            if (!convertToOldPath(item.lsi1.split(';')[0]).split('/').includes('Stock')) {
              const headLsi = item.lsi1.split(';')[0].split('|')[0].split('/').slice(0, 3).join('/') + '/Content/Page|Head-Content'

              const url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${headLsi}`;
              await fetch(url).then(res => res.json())
                .then(async ({ items }) => {
                  if (!items.length) {
                    return
                  }
                  const headContentItem = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${items[0].id}:${items[0].sk}`).then(re => re.json())

                  currentSku = headContentItem.sku
                })
            }
            else {
              currentSku = item.sku
            }
            if (currentSku) {
              if (lvl < 2) {
                showSku(currentSku)
                selectedSku = currentSku
              }
              else {
                getElementById1("input-sku").setAttribute('hidden', '')
                getElementById1("create-sku").setAttribute('hidden', '')
              }
            }


          }
          if (item.action) {
            if (id) {

              const reusableId1 = reusableId ? reusableId + '|' : ''


              const replaceWithNewId = (s) => {
                if (s.startsWith('3bf8d522-9423-4818-ad91-d8dfcda1f425')) {
                  log1('fouuund ' + s + '  replace  ' + replaceId)
                }
                if (!replaceId || s === 'body-tree' || s === 'body' || s === 'head-tree' | s === 'head') return s
                if (s.endsWith('-tree')) {

                  return s.replace('-tree', '') + ':' + replaceId + '-tree'
                }
                return s + ':' + replaceId
              }
              if (item.target_element === id + '-tree') {

                item.target_element = reusableId1 + newId + '-tree'
                if (item.inserted_element?.id) {
                  item.inserted_element.id.split(':').length === 1 && (item.inserted_element.id = reusableId1 + replaceWithNewId(item.inserted_element.id, newId))
                }
                if (item.inserted_element?.originalId) {
                  item.inserted_element.originalId = reusableId1 + item.inserted_element?.originalId
                  item.inserted_element?.originalId.split(':').length === 1 && (item.inserted_element.originalId = replaceWithNewId(item.inserted_element.originalId, newId))
                }


              }

              else if (components.includes(removeLastOccurrence(item.target_element, '-tree'))) {
                item.target_element = reusableId1 + item.target_element
                log1('case2')
                log1('in')
              }
              else if (Array.isArray(item.target_element)) {
                log1('array of targter ' + JSON.stringify(item.target_element))
                item.target_element = item.target_element.filter(e => e).map(i => {
                  log1('prob666' + JSON.stringify(i))
                  if (i.id === id + '-tree') {
                    return { ...i, id: reusableId1 + newId + '-tree' }
                  }
                  if (i.id?.split(':').length === 1) {
                    return { ...i, id: reusableId1 + replaceWithNewId(i.id, newId) }
                  }
                  return { ...i, id: reusableId1 + i.id }
                })

              }
              else {
                const s = item.target_element
                if (!(s === 'body-tree' || s === 'body' || s === 'head-tree' | s === 'head')) {
                  item.target_element = reusableId1 + item.target_element
                }
                else if (s === 'body-tree' && attachId) {
                  item.target_element = attachId
                }

                item.target_element.split(':').length === 1 && (item.target_element = replaceWithNewId(item.target_element, newId))
                if (item.inserted_element?.id) {
                  item.inserted_element.id = reusableId1 + item.inserted_element.id
                  item.inserted_element?.id.split(':').length === 1 && (item.inserted_element.id = replaceWithNewId(item.inserted_element.id, newId))

                }
                if (item.inserted_element?.originalId) {
                  item.inserted_element.originalId = reusableId1 + item.inserted_element?.originalId
                  item.inserted_element?.originalId.split(':').length === 1 && (item.inserted_element.originalId = replaceWithNewId(item.inserted_element.originalId, newId))
                }





              }

              //insertDataIntoCodeLog(item.sk, item.action)
              await executeCommand({ ...item, time: item.sk }, undefined, false, replaceActions, newId, noComp11, noSubComp, lvl, removeActions, replaceId, componentPath, { current: newPathForRelative, prev: pathForRelative?.current, next }, reusableId, attachId)

              continue
            }


            await pushAction({ ...item, time: item.sk }, true, false, replaceActions, newId, noComp11, noSubComp, lvl, removeActions, replaceId, componentPath, { current: componentPath, prev: componentPath, next: [] }, "", '', attachId)
          }

        }
      }
      else {

      }


    }
    function traverseJSONAndUpdate(json, path = '', sender = '', date, head) {
      // Iterate through each key-value pair in the JSON object
      for (const key in json) {
        if (json.hasOwnProperty(key)) {
          // Construct the full path for the current key
          const currentPath = path ? `${path}.${key}` : key;
          // If the current value is an array, handle each element individually
          if (Array.isArray(json[key])) {
            // Find the data-transfer-cloner attribute for the current array
            const clonerAttributes = querySelectorAll1(`[data-transfer-cloner="${sender}.${currentPath}"]:not([data-b-value=""]`, head);
            if (clonerAttributes.length > 0) {
              const arrayOfObjects = [];
              // Iterate through each set of cloned elements
              clonerAttributes.forEach(clonerAttribute => {
                if (typeof json[key][0] === 'string') {
                  if (clonerAttribute.hasAttribute('data-transfer-sender')) {
                    arrayOfObjects.push(clonerAttribute.innerText);
                  }
                  else if (clonerAttribute.hasAttribute('data-transfer-sender-href')) {
                    arrayOfObjects.push(clonerAttribute.getAttribute('href'));
                  }
                  else if (clonerAttribute.hasAttribute('data-transfer-sender-src')) {
                    arrayOfObjects.push(clonerAttribute.getAttribute('src'));
                  }
                  else if (clonerAttribute.hasAttribute('data-transfer-sender-innerhtml')) {
                    arrayOfObjects.push(clonerAttribute.innerHTML);
                  }

                }
                else {
                  const objectFromClonedElements = { ...json[key][0] };
                  // Iterate through each cloned element within the current set
                  if (clonerAttribute.hasAttribute('data-transfer-sender')) {
                    const attributeKey = clonerAttribute.getAttribute('data-transfer-sender').split('.').pop();
                    if (objectFromClonedElements[attributeKey] === null) {
                      objectFromClonedElements[attributeKey] = parseInt(clonerAttribute.innerText);
                    }
                    else {
                      log1('inner ' + clonerAttribute.innerText)
                      objectFromClonedElements[attributeKey] = clonerAttribute.innerText;
                    }

                  }
                  else if (clonerAttribute.hasAttribute('data-transfer-sender-href')) {
                    const attributeKey = clonerAttribute.getAttribute('data-transfer-sender-href').split('.').pop();

                    objectFromClonedElements[attributeKey] = clonerAttribute.getAttribute('href');
                  }
                  else if (clonerAttribute.hasAttribute('data-transfer-sender-href')) {
                    const attributeKey = clonerAttribute.getAttribute('data-transfer-sender-src').split('.').pop();

                    objectFromClonedElements[attributeKey] = clonerAttribute.getAttribute('src');
                  }
                  else if (clonerAttribute.hasAttribute('data-transfer-sender-innerhtml')) {
                    const attributeKey = clonerAttribute.getAttribute('data-transfer-sender-innerhtml').split('.').pop();

                    objectFromClonedElements[attributeKey] = clonerAttribute.innerHTML
                  }
                  else {
                    clonerAttribute.querySelectorAll('[data-transfer-sender]:not([data-b-value=""]').forEach(element => {
                      const attributeKey = element.getAttribute('data-transfer-sender').replace(`${sender}.${currentPath}.`, '');
                      if (objectFromClonedElements[attributeKey] === null) {
                        // If the attribute key contains dots indicating sub-objects
                        if (attributeKey.includes('.')) {
                          const keys = attributeKey.split('.');
                          let nestedObject = objectFromClonedElements;
                          for (let i = 0; i < keys.length - 1; i++) {
                            const key = keys[i];
                            nestedObject[key] = nestedObject[key] || {};
                            nestedObject = nestedObject[key];
                          }
                          // Assign the value to the nested property
                          nestedObject[keys[keys.length - 1]] = parseInt(element.innerText);
                        } else {
                          objectFromClonedElements[attributeKey] = parseInt(element.innerText);
                        }
                      } else {
                        if (attributeKey.includes('.')) {
                          const keys = attributeKey.split('.');
                          let nestedObject = objectFromClonedElements;
                          for (let i = 0; i < keys.length - 1; i++) {
                            const key = keys[i];
                            nestedObject[key] = nestedObject[key] || {};
                            nestedObject = nestedObject[key];
                          }
                          // Assign the value to the nested property
                          nestedObject[keys[keys.length - 1]] = element.innerText;
                        } else {
                          objectFromClonedElements[attributeKey] = element.innerText;
                        }
                      }
                    });
                    clonerAttribute.querySelectorAll('[data-transfer-sender-href]:not([data-b-value=""]').forEach(element => {
                      const attributeKey = element.getAttribute('data-transfer-sender-href').split('.').pop();
                      objectFromClonedElements[attributeKey] = element.getAttribute('href');
                    });
                    clonerAttribute.querySelectorAll('[data-transfer-sender-src]:not([data-b-value=""]').forEach(element => {
                      const attributeKey = element.getAttribute('data-transfer-sender-src').split('.').pop();
                      objectFromClonedElements[attributeKey] = element.getAttribute('src');
                    });
                    clonerAttribute.querySelectorAll('[data-transfer-sender-innerhtml]:not([data-b-value=""]').forEach(element => {
                      const attributeKey = element.getAttribute('data-transfer-sender-html').split('.').pop();
                      objectFromClonedElements[attributeKey] = element.innerHTML
                    });
                  }
                  // Push the created object to the array of objects
                  arrayOfObjects.push(objectFromClonedElements);
                }



              });
              // Update the value of the array in the JSON object
              json[key] = arrayOfObjects.filter(e => e);
            }
          }

          // If the current value is an object or an array, recursively traverse it
          else if (typeof json[key] === 'object' && json[key] !== null) {
            traverseJSONAndUpdate(json[key], currentPath, sender, date, head);
          }
          else if (key === 'datePublished') {
            json[key] = headContentItem.hosting_time?.published ? new Date(headContentItem.hosting_time.published).toISOString() : date.toISOString()
          }
          else {
            // If the current value is a string, check for the data-transfer-sender attribute
            const senderPath = sender ? `${sender}.${currentPath}` : currentPath;
            log1('sender path ' + senderPath)
            let senderAttribute = querySelectorAll1(`[data-transfer-sender="${senderPath}"]:not([data-b-value=""]`, head);


            if (senderAttribute.length) {
              if (json[key] === null) {
                json[key] = parseInt(senderAttribute[0].innerText) || null;
              }
              else {
                json[key] = senderAttribute[0].innerText || "";
              }

            }
            else {
              let senderAttribute = querySelectorAll1(`[data-transfer-sender-href="${senderPath}"]:not([data-b-value=""]`, head);
              log1('iiin2')
              if (senderAttribute.length) {

                json[key] = senderAttribute[0].getAttribute('href') || "";


              } else {
                let senderAttribute = querySelectorAll1(`[data-transfer-sender-src="${senderPath}"]:not([data-b-value=""]`, head);
                log1('iiin3')
                if (senderAttribute.length) {

                  json[key] = senderAttribute[0].getAttribute('src') || "";


                }
              }

            }



          }



        }
      }
    }
    function removeEmptyValues(obj) {
      for (let prop in obj) {
        if (obj[prop] === "" || obj[prop] === null || obj[prop] === [null]) {
          delete obj[prop];
        } else if (typeof obj[prop] === "object") {
          removeEmptyValues(obj[prop]); // Recursively call removeEmptyValues for nested objects
          if (Object.keys(obj[prop]).length === 0) {
            delete obj[prop]; // Delete the key if the nested object becomes empty after removing empty values
          }
        }
      }
      return obj;
    }
    function removeSingleAtKey(obj) {
      for (let prop in obj) {
        if (typeof obj[prop] === "object") {
          removeSingleAtKey(obj[prop]); // Recursively call removeSingleAtKey for nested objects
          if (Object.keys(obj[prop]).length === 1 && Object.keys(obj[prop])[0].startsWith("@")) {
            delete obj[prop]; // Delete the attribute if it has only one key starting with "@"
          }
        }
      }
      return obj;
    }
    const cleanJson = (json) => {
      let newJson = removeEmptyValues(json)
      newJson = removeSingleAtKey(json)
      newJson = removeEmptyValues(json)
      return newJson
    }
    const getPageUrl = (url) => {
      const [s, ...rest] = url.split('/')
      if (rest[rest.length - 1].toLowerCase() === 'hub') {
        if (rest[rest.length - 2].toLowerCase() === 'home') {
          rest.pop()

        }
        rest[rest.length - 1] = 'index.html'
      }
      else {
        rest[rest.length - 1] = rest[rest.length - 1] + '.html'
      }
      rest.pop()
      const key = rest.join('/').toLowerCase()
      return 'https://' + s.toLowerCase() + '/' + key
    }
    function removeAttributesStartingWith(node, prefixes) {
      for (let i = 0; i < node.attributes.length; i++) {
        const attributeName = node.attributes[i].name;
        for (const prefix of prefixes) {
          if (attributeName.startsWith(prefix)) {
            node.removeAttribute(attributeName);
          }
        }
      }

      for (const childNode of node.childNodes) {
        if (childNode.nodeType === Node.ELEMENT_NODE) {
          removeAttributesStartingWith(childNode, prefixes);
        }
      }
    }

    var handleItemLink = async () => {
      const currentPath = pathItemPath.replace(';publish:published', '').toLowerCase()
      if ((currentPath.endsWith("/main-content") || currentPath.endsWith("/product-content")) &&
        (currentPath.includes("/products/") || currentPath.includes("/blog/")) &&
        !currentPath.includes("/seed-") &&
        !currentPath.includes("/home") &&
        !currentPath.includes("/seed-/")) {

        const splited = currentPath.split('/')
        splited.pop()
        const href = ('https://' + splited.join('/') + '/')
          .replace('content/product/', '')
          .replace('content/main/', '')
          .replace('content/article/', '');
        const item = querySelectorAll1('[data-builder-item-link]')[0]
        if (item && item?.getAttribute('href') !== href) {
          const el = {
            time: (new Date()).getTime(),
            action: 'setAttribute',
            target_element: item.id + '-tree',
            key: 'href',
            value: href,

          }
          await pushAction(el)
        }
      }
    }
    const getFromProductSpecs = () => {
      const all = querySelectorAll1('[data-list="product_spec"]')
      const map = []
      const el = all[0]
      const rows = el.querySelectorAll('[data-lists-element]')
      for (const row of rows) {
        const key = row.querySelector('[data-lists-element-key]').textContent
        const value = row.querySelector('[data-list-element-selection]')?.value || row.querySelector('[data-lists-element-value]').textContent || ''
        map.push({ key, value })
      }
      return map

    }

    const getFromSiteData = (k) => {
      const all = document.querySelectorAll('[data-list]:not([hidden])')
      for (const el of all) {
        const rows = el.querySelectorAll('[data-lists-element]')
        for (const row of rows) {
          const key = row.querySelector('[data-lists-element-key]').textContent
          const value = row.querySelector('[data-lists-element-value]').textContent
          if (key === k) {
            return value
          }
        }
      }
    }
    function formatDate(date) {
      const options = { day: '2-digit', month: 'long', year: 'numeric' };
      const formattedDate = date.toLocaleDateString('en-US', options);
      return formattedDate;
    }
    var toRemove = {
      attributesStartWith: ["data-remove"],
      attributesEqual: ["data-remove"],
      removeAttributesStartWith: ["data-visual", "data-builder", "data-replaceid", "data-transfer", "data-b", "data-import", "data-parentid"]
    }
    const publish = async (e, updateContent) => {
      const date = new Date()
      if (visualOn) {
        localStorage.removeItem('visualOn')
        let newUrl = window.location.href + '&publish=1';

        // Reload the page with the new URL
        window.location.href = newUrl;
      }
      const el2 = getElementById1("path-icon")
      el2.classList.remove('b-green');
      el2.classList.remove('b-selected');
      const el3 = getElementById1("published-label")
      const el4 = getElementById1("published-invalidate")
      const el5 = getElementById1("published-remove")
      const pSiteLabel = getElementById1("published-site-label")

      el3.setAttribute('hidden', '')
      el4.setAttribute('hidden', '')
      el5.setAttribute('hidden', '')
      pSiteLabel.setAttribute('hidden', '')

      //to remove list


      const robotsTxt = `
      User-agent: *
      Disallow: /cart/
      `;
      const siteMapPriority = {

        '/products/': 0.9,
        '/blog/': 0.8,
        '/': 1,

      };
      const siteMapNotDefiniedPriorities = 0.5;

      /*
  
      if ((currentPath.endsWith("/article") || currentPath.endsWith("/product")) &&
      (currentPath.includes("/products/") || currentPath.includes("/blog/")) &&
      !currentPath.includes("/seed-article/") &&
      !currentPath.includes("/settings-article/") &&
      !currentPath.includes("/seed-product/") &&
      !currentPath.includes("/settings/") &&
      !currentPath.includes("/setting-product/")) {
      
      log1("Conditions ok, set data-builder-item-link .");
  
      */


      /*
  
      if ((currentPath.endsWith("/breadcrumb") &&
      !currentPath.includes("/seed-") &&
      !currentPath.includes("/settings-") &&
      !currentPath.includes("/settings/") &&
      !currentPath.includes("/setting-product/")) {
    
      log1("Conditions ok, generate breadcrumb .");
  
      
      */


      // set date
      if (pathItemPath.includes('/Blog/') && !pathItemPath.includes('/Home')) {
        const dateEl = querySelectorAll1('[data-builder-time-published]')[0]
        if (dateEl) {
          const d = headContentItem.hosting_time?.published ? new Date(headContentItem.hosting_time.published).toISOString() : date.toISOString()
          dateEl.setAttribute('datetime', d)
          dateEl.textContent = headContentItem.hosting_time?.published ? formatDate(new Date(headContentItem.hosting_time.published)) : formatDate(date)
        }

      }




      const urlSearchParams = new URLSearchParams(window.location.search);
      let idFromLink = urlSearchParams.get('id');
      const pagePathContent = getElementById1('page-path').textContent;

      // Use the textContent as needed, for example, log it to the console
      log1('Publishing:', pagePathContent);
      const { cleanHtml, generateProductJson } = await onPublish()

      //generateSchema(pagePathContent.split(';')[0], date)
      var iframe = document.getElementById("generated-page-iframe");

      // Access the content of the iframe
      var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
      let html = '<!DOCTYPE html>' + iframeDocument.documentElement.outerHTML;

      //html = replacePlaceHolders(html)
      log1(html)

      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/publishv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id: idFromLink, html, path: pagePathContent, toRemove, robotsTxt, siteMapPriority, siteMapNotDefiniedPriorities, date: date.getTime(), sku: pathItemSku, updateContent, cleanHtml, generateProductJson }),
      });
      const r = await response.json()
      if (reload) {
        location.reload()
      }

      log1('link: ' + r.link)
      const el = getElementById1('page-path')


      getElementById1('page-path').textContent = pagePathContent

      el2.classList.add('b-green');
      el2.classList.add('b-selected');
      el3.removeAttribute('hidden')
      el3.setAttribute('href', r.link)
      pSiteLabel.removeAttribute('hidden')
      pSiteLabel.setAttribute('href', r.link?.replace('s3.amazonaws.com/', '').replace('index.html', ''))

      el4.removeAttribute('hidden', '')
      el5.removeAttribute('hidden', '')


    }
    const handleSelectedDependeeChange = async (e) => {
      const resultList = await getProductAttributes()
      const checked1 = getChecked(resultList)
      const dependeeItems = querySelectorAll1(`[data-builder-dependee]`)
      for (const item of dependeeItems) {
        const attr = item.getAttribute('data-product-info')
        if (!attr) {
          continue
        }
        const splited = attr.split(';')
        splited.shift()
        const f = splited.find(el => !checked1.includes(el))
        if (f) {
          item.style.display = 'none'
        }
        else {
          item.style.display = 'block'
        }
      }
    }
    const handleDependency = async () => {
      const items = querySelectorAll1('[data-product-info]')
      if (items) {
        const resultList = await getProductAttributes()
        for (const element of resultList) {
          const form = element.form
          if (form && form.children) {
            // Iterate through the child elements of the form
            for (const child of form.children) {
              // Check if the child element is a label
              if (child.tagName === 'LABEL') {
                // Find the input within the label
                const input = child.querySelector('input[type="radio"]');

                // Add change event listener if input exists
                if (input) {
                  input.addEventListener('change', handleSelectedDependeeChange);
                }
              }
            }
          }

        }
      }
    }
    const setSrcSet = async (imageElement) => {
      const data_src = imageElement.getAttribute('data-src')
      if (data_src) {
        const resolutions = data_src.split(',').map(e => e.split('.')[0])
        const src = imageElement.getAttribute('src')
        const splited = src.split('/')
        const fName = splited.pop()
        const [name, ext] = fName.split('.')
        const splitedName = name.split('_')
        splitedName.pop()
        const pref = splitedName.join('_')
        const srcSet = resolutions.map(
          res => {
            const newFName = `${pref}_${res}w.${ext} ${res}w`
            return [...splited, newFName].join('/')
          }
        ).join(',')
        const payload = {

          time: (new Date()).getTime().toString(),
          action: 'setAttribute',
          target_element: imageElement.id + '-tree',
          key: 'srcset',
          value: srcSet,

        }
        await pushAction(payload)
      }

    }
    async function selectImage1(imgId, imageSrc, imageUUID) {

      const imageElement = getElementById1(removeLastOccurrence(imgId, '-tree'))
      const name = imageElement.getAttribute('data-builder-image-name')
      const defaultRes = imageElement.getAttribute('data-builder-image-default')

      const site = pathItemPath.split('/')[0]
      let randomString = generateRandomString(3)
      let url1 = 'https://' + site + '/pics/' + randomString + '_' + name
      function checkSrcStartsWithUrl1() {
        const elements = document.querySelectorAll('[src^="' + url1 + '"]');
        return elements.length > 0;
      }
      while (checkSrcStartsWithUrl1()) {
        randomString = generateRandomString(3);
        url1 = 'https://' + site.toLowerCase() + '/pics/' + randomString + '_' + name;
      }
      const splited = pathItemPath.split('/')
      splited.pop()
      splited.shift()
      const index = splited.indexOf('Content');
      if (index !== -1) {
        splited.splice(index);
      }
      // resize
      const body = {
        site,

        name: randomString + '_' + name,
        imageSrc,
        defaultRes,
        pagePath: splited.join('/')
      }
      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/resize', {
        method: 'POST',
        body: JSON.stringify(body),
      });
      const { src, data_src } = await response.json()

      const payload = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'data-builder-image-source',
        value: imageUUID,

      }
      await pushAction(payload)

      const payload3 = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'src',
        value: src,
        check_b: true

      }
      await pushAction(payload3)
      const payload4 = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'data-src',
        value: data_src,

      }
      await pushAction(payload4)
      // Add your logic for selecting the image here
      await setSrcSet(imageElement)


      // Add a "selected" label to the selected image



    }
    const handleUls = async (child, ulElement) => {
      const lisToImport = Array.from(child.childNodes).filter(e => e.tagName?.toLowerCase() === "li")
      const olsToImport = Array.from(child.childNodes).filter(e => e.tagName?.toLowerCase() === "ol")
      const liEl = Array.from(ulElement.childNodes).find(e => e.tagName?.toLowerCase() === "li")
      const olEl = Array.from(ulElement.childNodes).find(e => e.tagName?.toLowerCase() === "ol")
      if (!lisToImport.length) {
        for (const el of Array.from(ulElement.childNodes).filter(e => e.tagName?.toLowerCase() === "li")) {
          /*
          await pushAction({
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: el.id + '-tree',
          })
          */
        }
      }
      else {
        // remove all lis exept the one we use 
        for (const el of Array.from(ulElement.childNodes).filter(e => e?.tagName?.toLowerCase() === "li" && e?.id !== liEl.id)) {
          /*
          await pushAction({
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: el.id + '-tree',
          })*/
        }
        // set value of first
        const el = {
          time: (new Date()).getTime(),
          action: 'innerHtml',
          target_element: liEl.id + '-tree',
          insertedCode: lisToImport[0].innerHTML || lisToImport[0].textContent,

        }
        await pushAction(el)
        let lastEl = liEl.id + '-tree'
        for (let i = 1; i < lisToImport.length; i++) {
          const content = lisToImport[i].innerHTML || lisToImport[i].textContent
          //duplicate li
          const newId = duplicateId(liEl.id).id
          const actionObject = {
            time: (new Date()).getTime(),
            action: 'InsertAfter',
            target_element: lastEl,
            inserted_element: { originalId: liEl.id + '-tree', id: newId },
          };
          await pushAction(actionObject)
          const el = {
            time: (new Date()).getTime(),
            action: 'innerHtml',
            target_element: newId,
            insertedCode: content,

          }
          await pushAction(el)
          lastEl = newId
        }

      }

      if (!olsToImport.length) {
        for (const el of Array.from(ulElement.childNodes).filter(e => e.tagName?.toLowerCase() === "ol")) {
          /*
          await pushAction({
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: el.id + '-tree',
          })*/
        }
      }
      else {
        for (const el of Array.from(ulElement.childNodes).filter(e => e?.tagName?.toLowerCase() === "ol" && e?.id !== olEl.id)) {
          /*
          await pushAction({
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: el.id + '-tree',
          })*/
        }
        // set value of first
        const el = {
          time: (new Date()).getTime(),
          action: 'innerHtml',
          target_element: olEl.id + '-tree',
          insertedCode: olsToImport[0].innerHTML || olsToImport[0].textContent,

        }
        await pushAction(el)

        let lastEl = olEl.id + '-tree'
        for (let i = 1; i < olsToImport.length; i++) {
          const content = olsToImport[i].innerHTML || olsToImport[i].textContent
          //duplicate li
          const newId = duplicateId(olEl.id).id
          const actionObject = {
            time: (new Date()).getTime(),
            action: 'InsertAfter',
            target_element: lastEl,
            inserted_element: { originalId: olEl.id + '-tree', id: newId },
          };
          await pushAction(actionObject)
          const el = {
            time: (new Date()).getTime(),
            action: 'innerHtml',
            target_element: newId,
            insertedCode: content,

          }
          await pushAction(el)
          lastEl = newId
        }
      }
    }
    const generateAnchor = async (href) => {
      const iframe = getElementById1("generated-page-iframe");
      const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
      const elementsWithAnchorClass = iframeDocument.querySelectorAll('[class*="anchor"]:not([data-replaceid])');

      const promises = Array.from(elementsWithAnchorClass).map(element => {
        const el = {
          time: (new Date()).getTime(),
          action: 'setAttribute',
          target_element: element.id + '-tree',
          key: 'href',
          value: href,

        }
        return pushAction(el);
      });
      await Promise.all(promises)

    }
    const cleanImport = async (attr) => {
      if (!attr) {
        const filteredActions = actions.filter(e =>
          e.action !== 'Add_Component')
        actions = actions.filter(e =>
          e.action == 'Add_Component')
        const ps = filteredActions.map(
          action =>
            fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${action.id}:${action.sk}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
                // Add any additional headers if needed
              },
            })
        );
        await Promise.all(ps)
        return
      }
      const els = querySelectorAll1(`[data-import-${attr}]`)
      for (const el of els) {
        const id = el.id
        console.log('to remove id ' + id)
        const filteredActions = actions.filter(e =>
          e.target_element &&
          typeof e.target_element === 'string' &&  // Check if target_element is a string
          e.target_element.replace('-tree', '').startsWith(id.split(':')[0])  // Call startsWith only if target_element is a string
        );
        actions = actions.filter(e =>
          !e.target_element ||
          typeof e.target_element !== 'string' ||  // Check if target_element is a string
          !e.target_element.replace('-tree', '').startsWith(id.split(':')[0])  // Call startsWith only if target_element is a string
        );
        console.log('filtered ' + JSON.stringify(filteredActions))
        const ps = filteredActions.map(
          action =>
            fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${action.id}:${action.sk}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
                // Add any additional headers if needed
              },
            })
        );
        await Promise.all(ps)
        if (el.tagName.toLowerCase() === 'ul' || el.tagName.toLowerCase() === 'ol') {
          const id = el.children[0].id
          console.log('li found' + id)
          const filteredActions = actions.filter(e =>
            e.target_element &&
            typeof e.target_element === 'string' &&  // Check if target_element is a string
            e.target_element.replace('-tree', '').startsWith(id.split(':')[0])  // Call startsWith only if target_element is a string
          );
          actions = actions.filter(e =>
            !e.target_element ||
            typeof e.target_element !== 'string' ||  // Check if target_element is a string
            !e.target_element.replace('-tree', '').startsWith(id.split(':')[0])  // Call startsWith only if target_element is a string
          );
          console.log('filtered 2' + JSON.stringify(filteredActions))
          const ps = filteredActions.map(
            action =>
              fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${action.id}:${action.sk}`, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  // Add any additional headers if needed
                },
              })
          );
          await Promise.all(ps)
        }


      }
    }
    const handleImportGpt = async (valueId, attr) => {
      const items1 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${valueId}:import`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(el => el.json())
      inputValue = items1.data
      let sku1 = pathItemSku || selectedSku

      if (attr === 'meta_description') {
        const id1 = querySelectorAll1('meta[name="description"]')[0].id
        const payload2 = {

          time: (new Date()).getTime().toString(),
          action: 'setAttribute',
          target_element: id1 + '-tree',
          key: 'content',
          value: inputValue,

        }
        await pushAction(payload2)
        return
      }
      if (!inputValue.startsWith('<')) {
        const allAttrs = querySelectorAll1(`[data-import-${attr}]`)
        allAttrs[0]

        const el = {
          time: (new Date()).getTime(),
          action: 'innerHtml',
          target_element: allAttrs[0].id + '-tree',
          insertedCode: inputValue,

        }
        await pushAction(el)
        return
      }

      if (attr.startsWith('product')) {
        const stamp = new Date().getTime().toString()


        const site = pathItemPath.split('/')[0]


        let payload = {
          id: sku1,
          sk: attr + ':' + stamp,
          value: inputValue,
          site
        }




        payload && await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });
      }
      const div = document.createElement('div')
      div.innerHTML = inputValue
      const allAttrs = querySelectorAll1(`[data-import-${attr}]`)
      const map = allAttrs.map(element => {
        const value = element.getAttribute(`data-import-${attr}`)
        return { tag: value, element, set: false, index: 1 }
      })
      log1('map is ' + JSON.stringify(map))
      let imgLead = false
      let pLead = false
      let previous
      for (const child of Array.from(div.childNodes)) {
        if (!child?.tagName) {
          continue
        }
        log1('map is ' + JSON.stringify(map))
        const tag = child.tagName.toLowerCase()
        log1(tag)
        let foundE
        if (tag === 'img' && !imgLead) {
          imgLead = true
          foundE = map.findLast(e => e.tag === 'img-lead') || map.findLast(e => e.tag === 'img')
        }
        else if (tag === "p" && !pLead) {
          pLead = true
          foundE = map.findLast(e => e.tag === 'p-lead') || map.findLast(e => e.tag === 'p')
        }
        else {
          foundE = map.findLast(el => el.tag === tag)
        }
        /*
        for (const attribute of foundE.element.attributes) {
          if (attribute.name.startsWith('data-import-product-')) {
            const prefix = 'data-import-product-';
            const suffix = attribute.name.substring(prefix.length);
            const stamp = new Date().getTime().toString();
            const body = {
              id: sku1,
              sk: 'data-' + suffix + ':' + stamp,
              value: child.innerHTML,
              site: pathItemPath.split('/')[0]
            };
            const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              body: JSON.stringify(body),
            });
          }
        }*/
        if (foundE.set === false) {

          if (tag === 'img') {
            const src = child.getAttribute('src')
            const alt = child.getAttribute('alt')

            const response = await fetch('https://api.allorigins.win/raw?url=' + src);
            const blob = await response.blob()

            const splited = src.split('/')
            const name = splited[splited.length - 1].split('?')[0]

            const path = await upload(name, blob)

            log1('path ' + path)
            const id = pathItem.id
            const payload2 = {

              time: (new Date()).getTime().toString(),
              action: 'setAttribute',
              target_element: foundE.element.id + '-tree',
              key: 'alt',
              value: alt,

            }
            pushAction(payload2)
            const payload = {
              id,
              sk: path
            }
            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(payload),
            });
            const imageSrc = `https://s3.amazonaws.com/checkout-admin-panel/${path}`
            await selectImage1(foundE.element.id + '-tree', imageSrc, path.split('.')[0].replace('pics', ''))


          }
          else if (tag === "ul") {
            const ulElement = getElementById1(foundE.element.id)
            await handleUls(child, ulElement)

          }
          else {
            const el = {
              time: (new Date()).getTime(),
              action: 'innerHtml',
              target_element: foundE.element.id + '-tree',
              insertedCode: child.textContent,

            }
            await pushAction(el)
          }
          if (previous && previous.element.nextElementSibling.id !== foundE.element.id) {
            let el2 = {
              time: (new Date()).getTime(),
              action: 'InsertAfter',
              target_element: [{ type: 'tag', id: previous.element.id + '-tree', }, { type: 'tag', id: foundE.element.id + '-tree' }],
            }
            await pushAction(el2)
            const index1 = map.findIndex(e => e.element.id === foundE.element.id)
            const index2 = map.findIndex(e => e.element.id === previous.element.id)
            const element = map.splice(index1, 1)[0];
            map.splice(index2 + 1, 0, element);
          }

          foundE.set = true
          previous = foundE
          //foundE.element.innerHTML = child.innerHTML
        }
        else {

          const foundIndex = foundE.index
          /*
          let last = map.findLastIndex(e => e.index === foundIndex + 1)
          if (last < 0) {
  last = map.findLastIndex(e => e.index === foundIndex)
          }
          */
          const lastElement = previous.element
          const newId = duplicateId(foundE.element.id).id
          const actionObject = {
            time: (new Date()).getTime(),
            action: 'InsertAfter',
            target_element: lastElement.id + '-tree',
            inserted_element: { originalId: foundE.element.id + '-tree', id: newId },
          };
          await pushAction(actionObject);
          if (tag === 'img') {
            const src = child.getAttribute('src')
            const alt = child.getAttribute('alt')
            const payload2 = {

              time: (new Date()).getTime().toString(),
              action: 'setAttribute',
              target_element: newId,
              key: 'alt',
              value: alt,

            }
            pushAction(payload2)
            const response = await fetch('https://api.allorigins.win/raw?url=' + src);
            const blob = await response.blob()

            const splited = src.split('/')
            const name = splited[splited.length - 1].split('?')[0]

            const path = await upload(name, blob)

            log1('path ' + path)
            const id = pathItem.id
            const payload = {
              id,
              sk: path
            }
            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(payload),
            });
            const imageSrc = `https://s3.amazonaws.com/checkout-admin-panel/${path}`
            await selectImage1(newId, imageSrc, path.split('.')[0].replace('pics', ''))


          }
          else if (tag === "ul") {
            const ulElement = getElementById1(removeLastOccurrence(newId, '-tree'))
            await handleUls(child, ulElement)



          }

          else {
            const el = {
              time: (new Date()).getTime(),
              action: 'innerHtml',
              target_element: newId,
              insertedCode: child.textContent,

            }
            await pushAction(el)
          }
          const newE = getElementById1(removeLastOccurrence(newId, '-tree'))
          const newElement = { ...foundE, element: newE, set: true, index: foundIndex + 1 }
          //map.splice(last + 1, 0, newElement);
          map.push(newElement)
          previous = newElement
          //lastElement.insertAdjacentElement('afterend', clonedE);

        }

      }



    }
    const handleImportMenu = () => {
      let sku1 = pathItemSku || selectedSku
      const generatedPage = getElementById1('generated-page')
      const elements1 = generatedPage.querySelectorAll('*');

      // Filter elements with attributes starting with "data-import-"
      const elements = Array.from(elements1).filter(element => {
        const attributes = element.attributes;
        for (let i = 0; i < attributes.length; i++) {
          if (attributes[i].name.startsWith('data-import-')) {
            return true;
          }
        }
        return false;
      });
      if (elements.length > 0 && pathItemPath.split(';')[0].endsWith('-Content')) {
        const importMenuOriginal = getElementById1('import-menu')
        const importMenu = importMenuOriginal.cloneNode(true)
        importMenuOriginal.parentNode.append(importMenu)
        importMenu.removeAttribute('hidden')

        const button = importMenu.querySelector('#import-name')
        attrList = []
        for (const element of elements) {
          const cloned = button.cloneNode(true)
          let attr = ''
          Array.from(element.attributes).forEach(attribute => {
            // Check if the attribute name matches the pattern
            if (attribute.name.startsWith('data-import-')) {
              // If it matches, log the attribute value
              attr = attribute.name.replace('data-import-', '')
            }
          });
          if (attrList.includes(attr)) {
            continue
          }
          attrList.push(attr)
          cloned.querySelector('#import-name-span').textContent = attr
          button.parentNode.append(cloned)

          cloned.addEventListener('click', async (e) => {
            const menuOriginal = importMenu.querySelector('#import-data')
            const menu = menuOriginal.cloneNode(true)
            menuOriginal.parentNode.append(menu)
            menu.removeAttribute('hidden')
            menu.setAttribute('import-name-value', attr)
            const input = menu.querySelector('#import-input')
            const prevButton = menu.querySelector('#previous-html')
            const nextButton = menu.querySelector('#next-html')
            const removeButton = menu.querySelector('#remove-html')
            const updateButton = menu.querySelector('#update-html')
            const variationAmount = menu.querySelector('#variation-amount')
            const variationSite = menu.querySelector('#variant-site')
            let index
            let itemsArr = []

            const handleImport = async (e, update,) => {
              const inputValue = input.value
              // save content
              if (attr.startsWith('product')) {
                const stamp = new Date().getTime().toString()
                let payload
                if (update) {

                  if (!itemsArr.find(item => item.value === inputValue)) {
                    itemsArr[index] = { ...itemsArr[index], value: inputValue }
                    payload = itemsArr[index]
                  }

                } else {
                  const site = pathItemPath.split('/')[0]
                  if (itemsArr[index]?.value === inputValue) {
                    const splitedSite = itemsArr[index].site.split(',')
                    if (!splitedSite.includes(site)) {
                      splitedSite.push(site)
                      payload = { ...itemsArr[index], site: splitedSite.sort((a, b) => a.name.localeCompare(b.name)).join(',') }
                    }
                  }
                  else if (!itemsArr.find(item => item.value === inputValue)) {
                    payload = {
                      id: sku1,
                      sk: attr + ':' + stamp,
                      value: inputValue,
                      site
                    }
                    itemsArr.push(payload)
                    index = itemsArr.length - 1
                    variationAmount.textContent = itemsArr.length

                  }
                  for (let i = 0; i < itemsArr.length; i++) {

                    if (i !== index) {
                      const it = itemsArr[i]
                      const splited1 = it.site.split(',')
                      const siteI = splited1.findIndex(e => e === site)

                      if (siteI > -1) {
                        splited1.splice(siteI, 1)
                        const sorted = splited1.filter(e => e).sort((a, b) => a.name.localeCompare(b.name))
                        itemsArr[i] = { ...itemsArr[i], site: sorted.join(',') }
                        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json',
                          },
                          body: JSON.stringify({ ...itemsArr[i] }),
                        });
                      }
                    }
                  }
                }
                payload && await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(payload),
                });
              }
              const div = document.createElement('div')
              div.innerHTML = inputValue
              const allAttrs = querySelectorAll1(`[data-import-${attr}]`)
              const map = allAttrs.map(element => {
                const value = element.getAttribute(`data-import-${attr}`)
                return { tag: value, element, set: false, index: 1 }
              })
              log1('map is ' + JSON.stringify(map))
              let imgLead = false
              let pLead = false
              let imgLead1 = false
              let pLead1 = false
              let previous
              for (const child of Array.from(div.childNodes)) {
                if (!child?.tagName) {
                  continue
                }
                log1('map is ' + JSON.stringify(map))
                const tag = child.tagName.toLowerCase()
                log1(tag)
                let foundE
                if (tag === 'img' && !imgLead) {

                  imgLead1 = true
                  foundE = map.findLast(e => e.tag === 'img-lead') || map.findLast(e => e.tag === 'img')
                  imgLead = foundE
                }
                else if (tag === "p" && !pLead) {

                  pLead1 = true
                  foundE = map.findLast(e => e.tag === 'p-lead') || map.findLast(e => e.tag === 'p')
                  pLead = foundE
                }
                else {
                  foundE = map.findLast(el => el.tag === tag)
                }
                /*
                for (const attribute of foundE.element.attributes) {
                  if (attribute.name.startsWith('data-import-product-')) {
                    const prefix = 'data-import-product-';
                    const suffix = attribute.name.substring(prefix.length);
                    const stamp = new Date().getTime().toString();
                    const body = {
                      id: sku1,
                      sk: 'data-' + suffix + ':' + stamp,
                      value: child.innerHTML,
                      site: pathItemPath.split('/')[0]
                    };
                    const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                      method: 'POST',
                      body: JSON.stringify(body),
                    });
                    // You may want to handle the response here
                  }
                }*/
                if (foundE.set === false) {
                  if (tag === 'img') {
                    const src = child.getAttribute('src')
                    const alt = child.getAttribute('alt')

                    const response = await fetch('https://api.allorigins.win/raw?url=' + src);
                    const blob = await response.blob()

                    const splited = src.split('/')
                    const name = splited[splited.length - 1].split('?')[0]

                    const path = await upload(name, blob)

                    log1('path ' + path)
                    const id = pathItem.id
                    const payload2 = {

                      time: (new Date()).getTime().toString(),
                      action: 'setAttribute',
                      target_element: foundE.element.id + '-tree',
                      key: 'alt',
                      value: alt,

                    }
                    pushAction(payload2)
                    const payload = {
                      id,
                      sk: path
                    }
                    await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify(payload),
                    });
                    const imageSrc = `https://s3.amazonaws.com/checkout-admin-panel/${path}`
                    await selectImage1(foundE.element.id + '-tree', imageSrc, path.split('.')[0].replace('pics', ''))


                  }
                  else if (tag === "ul") {
                    const ulElement = getElementById1(foundE.element.id)
                    await handleUls(child, ulElement)

                  }
                  else {
                    const el = {
                      time: (new Date()).getTime(),
                      action: 'innerHtml',
                      target_element: foundE.element.id + '-tree',
                      insertedCode: child.textContent,

                    }
                    await pushAction(el)
                  }
                  var siblings = Array.from(foundE.element.parentNode.children);
                  if (previous && siblings.indexOf(foundE.element) < siblings.indexOf(previous.element)) {
                    let el2 = {
                      time: (new Date()).getTime(),
                      action: 'InsertAfter',
                      target_element: [{ type: 'tag', id: previous.element.id + '-tree', }, { type: 'tag', id: foundE.element.id + '-tree' }],
                    }
                    await pushAction(el2)
                    const index1 = map.findIndex(e => e.element.id === foundE.element.id)
                    const index2 = map.findIndex(e => e.element.id === previous.element.id)
                    const element = map.splice(index1, 1)[0];
                    map.splice(index2 + 1, 0, element);
                  }


                  foundE.set = true
                  previous = foundE


                  //foundE.element.innerHTML = child.innerHTML
                }
                else {

                  const foundIndex = foundE.index
                  /*
                  let last = map.findLastIndex(e => e.index === foundIndex + 1)
                  if (last < 0) {
          last = map.findLastIndex(e => e.index === foundIndex)
                  }
                  */
                  const lastElement = previous.element
                  const newId = duplicateId(foundE.element.id).id
                  const actionObject = {
                    time: (new Date()).getTime(),
                    action: 'InsertAfter',
                    target_element: lastElement.id + '-tree',
                    inserted_element: { originalId: foundE.element.id + '-tree', id: newId },
                  };
                  await pushAction(actionObject);
                  if (tag === 'img') {
                    const src = child.getAttribute('src')
                    const alt = child.getAttribute('alt')
                    const payload2 = {

                      time: (new Date()).getTime().toString(),
                      action: 'setAttribute',
                      target_element: newId,
                      key: 'alt',
                      value: alt,

                    }
                    pushAction(payload2)
                    const response = await fetch('https://api.allorigins.win/raw?url=' + src);
                    const blob = await response.blob()

                    const splited = src.split('/')
                    const name = splited[splited.length - 1].split('?')[0]

                    const path = await upload(name, blob)

                    log1('path ' + path)
                    const id = pathItem.id
                    const payload = {
                      id,
                      sk: path
                    }
                    await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify(payload),
                    });
                    const imageSrc = `https://s3.amazonaws.com/checkout-admin-panel/${path}`
                    await selectImage1(newId, imageSrc, path.split('.')[0].replace('pics', ''))


                  }
                  else if (tag === "ul") {
                    const ulElement = getElementById1(removeLastOccurrence(newId, '-tree'))
                    await handleUls(child, ulElement)



                  }

                  else {
                    const el = {
                      time: (new Date()).getTime(),
                      action: 'innerHtml',
                      target_element: newId,
                      insertedCode: child.textContent,

                    }
                    await pushAction(el)
                  }

                  const newElement = { ...foundE, element: getElementById1(removeLastOccurrence(newId, '-tree')), set: true, index: foundIndex + 1 }
                  //map.splice(last + 1, 0, newElement);
                  map.push(newElement)
                  previous = newElement
                  //lastElement.insertAdjacentElement('afterend', clonedE);

                }

              }

              menu.remove()

            }
            const handleNext = () => {
              if (itemsArr.length - 1 === index) {
                return
              }
              index = index + 1
              input.value = itemsArr[index].value
              variationSite.textContent = itemsArr[index].site
            }
            const handlePrevious = () => {
              if (index === 0) {
                return
              }
              index = index - 1
              input.value = itemsArr[index].value
              variationSite.textContent = itemsArr[index].site
            }
            const handleRemove = async () => {
              if (itemsArr.length < 2) {
                return
              }
              await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${itemsArr[index].id}:${itemsArr[index].sk}`, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  // Add any additional headers if needed
                },
              });
              if (itemsArr.length < 2) {
                menu.remove()
              }
              itemsArr.splice(index, 1)
              index = index + 1 !== itemsArr.length ? (index = index) : (index = index - 1)
              input.value = itemsArr[index].value
              variationSite.textContent = itemsArr[index].site
              variationAmount.textContent = itemsArr.length

            }
            if (attr.startsWith('product-')) {

              // get variations
              const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${sku1}&sk=${attr}&startsWith=true`).then(re => re.json())
              itemsArr = [...items]
              menu.querySelector("#variation-amount-field").removeAttribute('hidden')
              variationAmount.textContent = items.length
              index = items.length - 1
              if (items.length) {
                input.value = itemsArr[index].value

                variationSite.textContent = itemsArr[index].site
                menu.querySelector("#variation-site-field").removeAttribute('hidden')
                prevButton.removeAttribute('hidden')
                nextButton.removeAttribute('hidden')
                removeButton.removeAttribute('hidden')
                updateButton.removeAttribute('hidden')
                updateButton.addEventListener('click', (e) => handleImport(e, true))
                removeButton.addEventListener('click', handleRemove)
                nextButton.addEventListener('click', handleNext)
                prevButton.addEventListener('click', handlePrevious)
              }

            }
            menu.querySelectorAll('[data-save]').forEach(element1 => {
              element1.addEventListener('click', handleImport)
            })

          })

        }
        button.remove()
        /*
        
        
        */
      }
    }

    const handleWebPageMenu = () => {
      const splited = pathItemPath.split(';')[0].split('/')
      const menu = document.getElementById('web-page-menu')
      if (splited[0].endsWith('SeoSitesHome.com') || splited[splited.length - 1] === 'Hub' || splited[splited.length - 2] === 'Emails') {

        menu.removeAttribute('hidden')
      }
      else {
        menu.setAttribute('hidden', '')
      }


    }
    const setHubItems = () => {
      const gptValue = pathItem.hub_items?.gpt
      const listValue = pathItem.hub_items?.list
      if (listValue) {
        const input = document.getElementById('list-input')
        input.value = input.value + listValue
      }
      if (gptValue) {
        document.getElementById('gpt-input').value = gptValue
      }
    }
    const generateTable = async (id) => {
      const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${id}:import`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(el => el.json())
      const tableContentElement = querySelectorAll1('[data-table-of-contents-element]')[0]

      const el = {
        time: (new Date()).getTime(),
        action: 'textContent',
        target_element: tableContentElement.id + '-tree',
        value: item.data[0],

      }

      await pushAction(el)
      let last = tableContentElement.id + '-tree'
      for (let i = 1; i < item.data.length; i++) {
        const heading = item.data[i]
        const textContent = heading
        const id = duplicateId(tableContentElement.id + '-tree').id
        actionObject = {
          time: (new Date()).getTime(),
          action: 'InsertAfter',
          target_element: last,
          inserted_element: { originalId: tableContentElement.id + '-tree', id },
        };
        await pushAction(actionObject)
        const el = {
          time: (new Date()).getTime(),
          action: 'textContent',
          target_element: id,
          value: textContent,

        }
        await pushAction(el)
        last = id
      }
    }
    const generateTableApi = async (textContents) => {
      const tableLsi = pathItem.lsi1.split('|')[0] + '/Content/Main|Article-Table-Of-Contents-Content'
      log1(tableLsi)
      url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${tableLsi}`;
      const { items } = await fetch(url).then(e => e.json())
      const currentDate = new Date();

      // Add one day to the current date
      const tomorrow = new Date(currentDate);
      tomorrow.setDate(currentDate.getDate() + 1);

      // Convert the date to ISO 8601 format (required by DynamoDB)
      const ttl = Math.floor(tomorrow.getTime() / 1000)
      const db = {
        id: generateUUID(),
        sk: 'import',
        ttl,
        data: textContents,
      }
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(db),
      });
      const eventData = { url: `https://webdev983.github.io/templatesv3/component.html?id=${items[0].id}&generatetable=${db.id}&ownerid=${localStorage.getItem('ownerid')}` };
      log1(eventData.url)
      // Fetch options
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(eventData)
      };
      const response = await fetch(pup_url, options);
    }
    const handleBreadCrumbStatus = async () => {
      let exisitingValue = headContentItem && await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${headContentItem.id}:generated-breadcrumb`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json())
      if (exisitingValue) {
        const breadcrumb = document.getElementById('breadcrumb-status')
        breadcrumb.textContent = 'ü•ñ BreadCrumb Menu üü¢'
      }
    }

    /*
    const handleSpecStatus = async () => {
      let exisitingValue = headContentItem && await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${headContentItem.id}:generated-tablespec`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json())
      if (exisitingValue) {
        const breadcrumb = document.getElementById('spec-status')
        breadcrumb.textContent = 'üóÇÔ∏è Table spec üü¢'
      }
    }
    const handleTableGeneration = async () => {
      const tableContentElements1 = querySelectorAll1('[data-table-of-contents-element]')
      if (tableContentElements1.length) {
        const tableElement = getElementById1('article-table-of-content-menu')
        tableElement.removeAttribute('hidden')
        let exisitingValue = headContentItem && await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${headContentItem.id}:generated-table`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(e => e.json())
        if (exisitingValue) {
          tableElement.querySelector('span').textContent = 'üìë Table of contents üü¢'
        }
        tableElement.querySelector('#generate-table-button').onclick = async (e) => {
          tableElement.querySelector('span').textContent = 'üìë Table of contents üü†'
          const headingElements = querySelectorAll1('[data-table-of-contents-heading]')
          const textContents = Array.from(headingElements).map(e => e.textContent)
          await generateTableApi(textContents)
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            body: JSON.stringify({ id: headContentItem.id, sk: 'generated-table' }),
          });
          tableElement.querySelector('span').textContent = 'üìë Table of contents üü¢'
        }
      }
    }*/

    function generateCombinations(data) {
      const combinations = [];

      data.forEach(item => {
        item.items.forEach(attribute => {
          const combination = {
            legend: item.legend,
            attribute: attribute
          };
          combinations.push(combination);
        });
      });

      const result = [];
      const combine = (arr, idx, current) => {
        if (idx === arr.length) {
          result.push(current);
          return;
        }
        arr[idx].items.forEach(item => {
          combine(arr, idx + 1, current + `${arr[idx].legend}:${item};`);
        });
      };

      combine(data, 0, '');

      return result;
    }
    const openRemoveSku = (event) => {
      const menu = event.target.parentNode.querySelector('#remove-sku-menu')
      menu.style.display = 'block'
    }


    const removeSku = async (event) => {

      const sku = pathItemSku
      // to do 
      if (headContentItem) {
        headContentItem.sku = undefined
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(headContentItem),
        });
        pathItemSku = undefined
      }
      else {
        pathItem.sku = undefined
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(pathItem),
        });
        pathItemSku = undefined
      }

      /*
      const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${sku}&startsWith=true`)
        .then(response => response.json())
 
      const res = await Promise.all(items.map(async item => {
        const deleteUrl = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item.id}:${item.sk}`;
        const response = await fetch(deleteUrl, {
method: 'DELETE',
headers: {
  'Content-Type': 'application/json',
  // Add any additional headers if needed
},
 
        });
      }))*/
      //to complete
      event.target.parentNode.parentNode.remove()
      getElementById1("input-sku").removeAttribute('hidden')
      getElementById1("create-sku").removeAttribute('hidden')
    }
    const removeSku2 = async (event) => {

      const sku = pathItemSku
      // to do 
      if (headContentItem) {
        headContentItem.sku = undefined
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(headContentItem),
        });
        pathItemSku = undefined
      }
      else {
        pathItem.sku = undefined
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(pathItem),
        });
        pathItemSku = undefined
      }

      /*
      const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${sku}&startsWith=true`)
        .then(response => response.json())
      
      const res = await Promise.all(items.map(async item => {
        const deleteUrl = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item.id}:${item.sk}`;
        const response = await fetch(deleteUrl, {
      method: 'DELETE',
      headers: {
      'Content-Type': 'application/json',
      // Add any additional headers if needed
      },
      
        });
      }))*/
      //to complete
      getElementById1("sku-empty2").removeAttribute('hidden')
      getElementById1("sku_filled").setAttribute('hidden', "")
    }
    const setSku = async (value) => {
      if (pathItemPath.split('/').includes('Stock')) {
        pathItem.sku = value
        const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(pathItem),
        });

      }
      else {


        headContentItem.sku = value
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          body: JSON.stringify(headContentItem),
        });


      }
      pathItemSku = value
    }
    const addSku2 = async (event) => {
      const value = getElementById1('input-sku2').value.trim().toLowerCase()

      const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=sku:${value}&sk=created:&startsWith=true`)
        .then(response => response.json())
      if (items.length) {
        if (items[0].ownerUUID.replace('sku:', '') === ownerid) {
          await setSku(value)
          showSku2(value)

          return
          //alert('adding sku in progress')
        }
        else {
          getElementById1('input-sku2').value = ''

        }
        return


      }


      await setSku(value)

      // add sku 
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id: 'sku:' + value, sk: 'created:' + new Date().getTime().toString(), ownerUUID: 'sku:' + ownerid }),
      });

      showSku2(value, true)
      //setDataProduct(value, resultList)
    }

    const addSku = async (event) => {
      const value = getElementById1('input-sku').value.trim().toLowerCase()
      const resultList = await getProductAttributes(true)
      const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${value}&sk=created:&startsWith=true`)
        .then(response => response.json())
      if (items.length) {
        if (items[0].ownerUUID.replace('sku:', '') === ownerid) {
          await setSku(value)
          showSku(value)
          setDataProduct(value, resultList)
          return
          //alert('adding sku in progress')
        }
        else {
          getElementById1('input-sku').value = ''

        }
        return


      }

      const combinations = generateCombinations(resultList)
      await setSku(value)
      pathItem.combinations = combinations.length
      //update path item
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(pathItem),
      });
      // add sku 
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id: value, sk: 'created:' + new Date().getTime().toString(), ownerUUID: 'sku:' + ownerid }),
      });
      //create sku
      for (const combination of combinations) {
        const item = {
          id: value,
          sk: 'qty;' + combination.toLowerCase(),
          qty: 0
        }

        const existing = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/' + value + ':' + item.sk)
          .then(response => response.json())
        if (!existing) {
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(item),
          });
        }
      }
      if (combinations.length === 1) {
        querySelectorAll1('[data-builder-schema="aggregate-product"]').forEach(element => {
          const el =
          {
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: element.id + '-tree',

          }
          pushAction(el)
        })
      }
      else {
        querySelectorAll1('[data-builder-schema="single-product"]').forEach(element => {
          const el =
          {
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: element.id + '-tree',

          }
          pushAction(el)
        })
      }
      showSku(value, true)
      setDataProduct(value, resultList)
    }
    const setDataProduct = async (sku, items) => {
      const dataProductEls = querySelectorAll1('[data-product=""]')
      const splited = pathItemPath.split(';')[0].split('/')
      const name = splited[splited.length - 1]
      dataProductEls.forEach(async dataProductEl => {
        const el = {
          time: (new Date()).getTime(),
          action: 'setAttribute',
          target_element: dataProductEl.id + '-tree',
          key: 'data-product',
          value: `${sku}`,

        }
        await pushAction(el)
      })
      log1(JSON.stringify(items))
      if (items.length > 1 || items[0]?.items.length > 1) {

        for (const item of items) {
          const form = item.form
          var labels = form.querySelectorAll('label[data-product-attribute]');
          const defaultCheckbox = form.querySelector('input[type="radio"]')
          // Loop through each label
          for (let i = 0; i < labels.length; i++) {
            const label = labels[i]
            // Find the corresponding input element
            const compositeId = item.legend + '-' + label.textContent
            //duplicate checkbox and insert before label
            const actionObject = {
              time: (new Date()).getTime(),
              action: 'InsertBefore',
              target_element: label.id + '-tree',
              inserted_element: { originalId: defaultCheckbox.id + '-tree', id: compositeId + '-tree' },
            };
            //await pushAction(actionObject);



            //set for in label
            const el = {
              time: (new Date()).getTime(),
              action: 'setAttribute',
              target_element: label.id + '-tree',
              key: 'for',
              value: compositeId,

            }
            //await pushAction(el)
            //set for in label
            const input = label.querySelector('input[type="radio"]')
            const el1 = {
              time: (new Date()).getTime(),
              action: 'setAttribute',
              target_element: input.id + '-tree',
              key: 'name',
              value: sku + ';' + item.legend,

            }
            await pushAction(el1)

            if (i === 0) {
              const el = {
                time: (new Date()).getTime(),
                action: 'setAttribute',
                target_element: input.id + '-tree',
                key: 'checked',
                value: 'true',

              }
              await pushAction(el)
            }

          };
          const el =
          {
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: defaultCheckbox.id + '-tree',

          }
          //await pushAction(el)
        }

      }
      else if (items.length === 1) {
        const element = items[0].form
        const el =
        {
          time: (new Date()).getTime(),
          action: 'removeTag',
          target_element: element.id + '-tree',

        }
        //await pushAction(el)
      }
    }
    const getProductAttributes = async (setNumbers) => {
      const resultList = [];
      const forms = querySelectorAll1('[data-product-attribute-form]');

      for (let i = 0; i < forms.length; i++) {
        const form = forms[i]
        if (setNumbers) {
          const el = {
            time: (new Date()).getTime(),
            action: 'setAttribute',
            target_element: forms[i].id + '-tree',
            key: 'data-product-attribute-form',
            value: i + 1,

          }
          await pushAction(el)
        }
        const legendElement = form.querySelector('[data-product-attribute-legend]');
        const legend = legendElement && legendElement.textContent;

        const attributeElements = form.querySelectorAll('[data-product-attribute]');
        const attributes = Array.from(attributeElements).map(element => element.textContent);

        resultList.push({
          form,
          legend: legend,
          items: attributes
        });
      };
      return resultList
    }
    const handleSkuItemClick = (cloned, item, sku) => {
      let newItem = { ...item }
      const variant = item.sk.replace('qty;', '')
      if (!cloned.nextElementSibling?.id.startsWith('stock-menu')) {
        const stockMenuCloned = document.getElementById('stock-menu').cloneNode(true)
        stockMenuCloned.id = stockMenuCloned.id + ';' + item.sk.replace('qty;', '')
        cloned.insertAdjacentElement('afterend', stockMenuCloned)
        let type = 'digital-good'
        const handleTypeChange = (e) => {
          if (e.target.id === 'digital-good') {
            if (e.target.checked) {
              stockMenuCloned.parentNode.querySelector('#digital-menu').removeAttribute('hidden')
              stockMenuCloned.parentNode.querySelector('#real-goods-menu').setAttribute('hidden', '')
              type = 'digital-good'
            }
            else {
              stockMenuCloned.parentNode.querySelector('#digital-menu').setAttribute('hidden', '')
              stockMenuCloned.parentNode.querySelector('#real-goods-menu').removeAttribute('hidden')
              type = 'real-good'
            }
          }
          if (e.target.id === 'real-good') {
            if (e.target.checked) {
              stockMenuCloned.parentNode.querySelector('#real-goods-menu').removeAttribute('hidden')
              stockMenuCloned.parentNode.querySelector('#digital-menu').setAttribute('hidden', '')
              type = 'real-good'
            }
            else {
              stockMenuCloned.parentNode.querySelector('#real-goods-menu').setAttribute('hidden', '')
              stockMenuCloned.parentNode.querySelector('#digital-menu').removeAttribute('hidden')
              type = 'digital-good'
            }
          }

        }
        stockMenuCloned.querySelectorAll('input[type="radio"][name="choose-goods-type"]').forEach(e => e.addEventListener('change', handleTypeChange));
        const qtyMenu = document.getElementById('stock-qty')

        const handleStockQtyClick = (e) => {
          if (!stockMenuCloned.nextElementSibling?.id.startsWith('stock-qty')) {
            const clonedQty = qtyMenu.cloneNode(true)
            clonedQty.id = clonedQty.id + ';' + sku
            item.qty && (clonedQty.querySelector('input').value = item.qty)
            const handleUpdateQty = (e) => {
              newItem.qty = clonedQty.querySelector('input').value
              fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                body: JSON.stringify(newItem),
              });
              cloned.querySelector('#sku-qty').textContent = newItem.qty
              clonedQty.remove()
            }
            clonedQty.querySelector('#update-qty').addEventListener('click', handleUpdateQty)

            stockMenuCloned.insertAdjacentElement('afterend', clonedQty)
            stockMenuCloned.remove()

          }
        }
        const addStockMenu = document.getElementById('add-stock-menu')
        const handleAddStock = (e) => {
          if (!stockMenuCloned.nextElementSibling?.id.startsWith('add-stock-menu')) {
            const clonedAddStock = addStockMenu.cloneNode(true)
            clonedAddStock.id = clonedAddStock.id + ';' + sku

            const handleSaveStock = async (e) => {
              const input = clonedAddStock.querySelector('#add-stock-input').value
              const lines = input.split('\n').map(e => e.trim()).filter(line => line)
              for (const line of lines) {

                const timeStamp = (new Date()).getTime().toString()
                const body = {
                  id: item.id,
                  sk: 'stock-item;' + variant + timeStamp,
                  lsi1: timeStamp + ':' + line,
                  ownerUUID: `free:${item.id};${variant}`,
                  type

                }
                const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                  method: 'POST',
                  body: JSON.stringify(body),
                });
              }
              //update qty
              newItem.qty ? (newItem.qty += lines.length) : (newItem.qty = lines.length)
              fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                body: JSON.stringify(newItem),
              });
              cloned.querySelector('#sku-qty').textContent = newItem.qty
              clonedAddStock.remove()
            }
            clonedAddStock.querySelectorAll('[save-stock]').forEach(e => e.addEventListener("click", handleSaveStock))


            stockMenuCloned.insertAdjacentElement('afterend', clonedAddStock)
            stockMenuCloned.remove()

          }
        }

        const viewStockMenu = document.getElementById('view-stock')
        const stockItem0 = document.querySelector('[stockItem]')
        const handleViewStock = async (e) => {
          if (!stockMenuCloned.nextElementSibling?.id.startsWith('view-stock')) {
            const clonedViewStock = viewStockMenu.cloneNode(true)
            clonedViewStock.id = clonedViewStock.id + ';' + sku
            const url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${item.id}&sk=${'stock-item;' + variant}&startsWith=true&descending=true&pageSize=100`
            const res = await fetch(url, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(el => el.json())
            log1(JSON.stringify(res))

            const table = clonedViewStock.querySelector('#stock-table-body')
            for (const item of res.items) {
              const clonedStockItem = stockItem0.cloneNode(true)
              const key = item.lsi1.split(':')[1]
              clonedStockItem.id = clonedStockItem.id + ';' + key
              clonedStockItem.removeAttribute('hidden')
              clonedStockItem.querySelector('#stock-item-value').textContent = key
              clonedStockItem.querySelector('#stock-item-status').textContent = item.ownerUUID.split(';')[0].split(':')[0]
              table.append(clonedStockItem)
            }

            stockMenuCloned.insertAdjacentElement('afterend', clonedViewStock)
            stockMenuCloned.remove()

          }
        }
        const stockLabelMenu = document.getElementById('stock-label')
        const handleStockLabel = async (e) => {
          if (!stockMenuCloned.nextElementSibling?.id.startsWith('stock-label')) {
            const clonedstockLabel = stockLabelMenu.cloneNode(true)
            clonedstockLabel.id = clonedstockLabel.id + ';' + sku
            clonedstockLabel.querySelector('#stock-label-input').value = newItem.label || ''
            clonedstockLabel.querySelector('#update-label').addEventListener('click', async (e) => {
              const newLabel = clonedstockLabel.querySelector('#stock-label-input').value
              newItem.label = newLabel
              item.label = newLabel
              await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                body: JSON.stringify(newItem),
              });
              clonedstockLabel.remove()

            })
            stockMenuCloned.insertAdjacentElement('afterend', clonedstockLabel)
            stockMenuCloned.remove()

          }
        }
        stockMenuCloned.querySelectorAll('[stock-qty]').forEach(e => {
          e.addEventListener("click", handleStockQtyClick)
        })
        stockMenuCloned.querySelector('[add-stock]').addEventListener("click", handleAddStock)
        stockMenuCloned.querySelector('[view-stock]').addEventListener("click", handleViewStock)
        stockMenuCloned.querySelector('[stock-label]').addEventListener("click", handleStockLabel)


      }

    }

    const showSku = async (sku) => {
      log1('showing sku original ' + sku)
      const item1 = getElementById1("sku-item-1")
      getElementById1("input-sku").setAttribute('hidden', '')
      getElementById1("create-sku").setAttribute('hidden', '')
      const cloned1 = item1.cloneNode(true)
      cloned1.id = sku
      cloned1.removeAttribute('hidden')
      getElementById1("sku-list").removeAttribute('hidden')
      cloned1.querySelector("#sku-value").textContent = sku
      cloned1.querySelector("#remove-sku").removeAttribute('hidden')
      const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${sku}&sk=qty;&startsWith=true`)
        .then(response => response.json())
      const el = cloned1.querySelectorAll('#sku-item')
      const parent = cloned1.querySelector('#sku-attribute-list')
      //if (items.length > 1) {

      const p = items.map(async item => {

        const cloned = el[0].cloneNode(true)
        const v = item.sk.replace('qty;', '')
        log1("sku i is " + JSON.stringify(item))
        cloned.querySelector('#sku-attribute-value').textContent = v
        const psk = `price;${pathItemPath.split('/')[0].toLowerCase()};${v}price`
        const pItem = await fetch(`${backend_url}?id=${sku}&sk=${psk}&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(e => e.json()).then(({ items }) => items[0])

        cloned.querySelector('#sku-qty').textContent = item.qty || 0
        const oldEl = cloned.querySelector('[data-price_old_value]')
        const pEl = cloned.querySelector('[data-price_value]')
        oldEl.textContent = pItem?.oldprice || 0
        pEl.textContent = pItem?.price || 0
        pEl.addEventListener('blur', async function () {
          let value = -1
          try {
            value = parseFloat(pEl.textContent)
          }
          catch (e) {

          }
          if (value < 0) {
            value = 0
            pEl.textContent = 0
          }


          let nV = pItem
          if (nV) {
            nV.price = value
          }
          else {
            nV = {
              id: sku,
              sk: psk,
              price: value
            }
          }
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            body: JSON.stringify(nV),
          });
        });
        oldEl.addEventListener('blur', async function () {
          let value = -1
          try {
            value = parseFloat(oldEl.textContent)
          }
          catch (e) {

          }
          if (value < 0) {
            value = 0
            oldEl.textContent = 0
          }


          let nV = pItem
          if (nV) {
            nV.oldprice = value
          }
          else {
            nV = {
              id: sku,
              sk: psk,
              oldprice: value
            }
          }
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            body: JSON.stringify(nV),
          });
        });
        parent.appendChild(cloned)
        cloned.addEventListener('click', e => handleSkuItemClick(cloned, item))
      })
      await Promise.all(p)
      /*
           }
          
           else if (items.length === 1) {
             log1('showing sku')
             const cloned = el[0].cloneNode(true)
             cloned.querySelector('#sku-attribute-value').textContent = 'Solo'
             cloned.querySelector('#sku-qty').textContent = items[0].qty || 0
             parent.appendChild(cloned)
             cloned.addEventListener('click', e => handleSkuItemClick(cloned, items[0], sku))
           }*/
      getElementById1("sku-list").appendChild(cloned1)
      el.forEach(e => e.remove())
    }
    const removeSkuParam = async (event) => {
      const target = event.target
      const tr = target.closest('tr')
      const sk = tr.getAttribute('sk')
      fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${ownerid}:${sk}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          // Add any additional headers if needed
        },
      });
      tr.remove()
    }
    const setSkuItemValue = async (event) => {
      const target = event.target
      const value = target.textContent
      const sk = target.closest('tr').getAttribute('sk')
      const item = {
        id: ownerid,
        sk,
        value
      }
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(item),
      });

    }
    const duplicateRow = (event, rowId) => {
      const tr = event.target.closest('tr')

      const rows = tr.querySelectorAll('[id^="' + rowId + '"]');
      const row = rows[0]
      const cloned = row.cloneNode(true)
      const latestIndex = rows[rows.length - 1].id.replace(rowId, "")
      const newIndex = parseInt(latestIndex) + 1
      cloned.id = rowId + newIndex
      row.parentNode.append(cloned)
    }
    const addWareHouse = async (event) => {
      const filled = getElementById1('sku_filled')
      const tr = filled.querySelector('#warehouse-row[hidden]')

      const cloned = tr.cloneNode(true)
      cloned.removeAttribute('hidden')
      tr.parentNode.append(cloned)
      const item = {
        id: ownerid,
        sk: 'warehouse:' + (new Date()).getTime().toString(),
        value: 'warehouse'
      }
      cloned.setAttribute('sk', item.sk)
      cloned.querySelector('#enableWareHouse').onclick = (e) => {
        e.target.textContent = 'üü¢'
        const option = getElementById1('warehouse_select_label')
        const cloned1 = option.cloneNode(true)
        cloned1.removeAttribute('hidden')
        cloned1.setAttribute('id', item.sk)
        cloned1.querySelector('#warehouse_value-zd').textContent = e.target.parentNode.parentNode.querySelector('#wareHouseInput').textContent
        console.log(option.parentNode.children.length)
        if (option.parentNode.children.length === 1) {
          cloned1.querySelector('input').setAttribute('checked', "")
        }
        option.parentNode.append(cloned1)

      }
      cloned.querySelector('#defaultWareHouseInput').onchange = async (e) => {
        const checked = e.target.checked
        const element = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?' + `id=${item.id}&sk=${item.sk}&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(e => e.json()).then(res => res.items[0])
        element.default = checked
        fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(
            element
          ),
        });

      }
      cloned.querySelector('#warehouse-country-select').onchange = async (e) => {
        var selectElement = e.target
        var selectedOption = selectElement.options[selectElement.selectedIndex].id;
        const element = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?' + `id=${item.id}&sk=${item.sk}&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(e => e.json()).then(res => res.items[0])
        element.location = selectedOption
        fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(
            element
          ),
        });

      }
      cloned.querySelector('#warehouse-min-processing').onblur = async (e) => {
        const min = e.target.textContent
        const element = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?' + `id=${item.id}&sk=${item.sk}&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(e => e.json()).then(res => res.items[0])
        element.min = parseInt(min)
        fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(
            element
          ),
        });

      }
      cloned.querySelector('#warehouse-max-processing').onblur = async (e) => {
        const max = e.target.textContent
        const element = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?' + `id=${item.id}&sk=${item.sk}&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(e => e.json()).then(res => res.items[0])
        element.max = parseInt(max)
        fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(
            element
          ),
        });

      }
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(item),
      });
    }
    const addDestination = async (event) => {

      const filled = getElementById1('sku_filled')
      const tr = filled.querySelector('#destination-row[hidden]')

      const cloned = tr.cloneNode(true)
      cloned.removeAttribute('hidden')
      tr.parentNode.append(cloned)
      const item = {
        id: ownerid,
        sk: 'destination:' + (new Date()).getTime().toString(),
        value: 'destination'
      }
      cloned.setAttribute('sk', item.sk)
      cloned.querySelector('#enableDestination').onclick = (e) => {
        e.target.textContent = 'üü¢'
        const option = getElementById1('destination_select_option')
        const cloned1 = option.cloneNode(true)
        cloned1.removeAttribute('hidden')
        cloned1.setAttribute('id', item.sk)
        cloned1.querySelector('#destination-value').textContent = "üè¥Û†Å•Û†Å≥Û†Å∞Û†Å∂Û†Åø" + e.target.parentNode.parentNode.querySelector('#destinationInput').textContent

        option.parentNode.append(cloned1)

      }
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(item),
      });
    }
    const generateConditionTable = async (v, sk) => {
      console.log(v)
      const original = document.querySelector('#condition-price-table[hidden]')
      const cloned = original.cloneNode(true)
      cloned.removeAttribute('hidden')
      cloned.setAttribute('id', v)
      cloned.setAttribute('sk', sk)
      cloned.querySelector('#condition-table-caption-value').textContent = v


      const selectElement = document.querySelector('#warehouse-zd[checked]');





      const selectedText = selectElement.parentNode.querySelector('#warehouse_value-zd').textContent.trim();
      const wareHouseEl = cloned.querySelector('#sku-condition-warehouse-name-value')
      const siteEl = cloned.querySelector('#sku-condition-site-name-value')
      wareHouseEl.textContent = selectedText

      siteEl.textContent = pathItemPath.split('/')[0]
      const originalRow = cloned.querySelector('#sku-variable-row[hidden]')

      cloned.querySelector('#sku-variable-price-warehouse-all').setAttribute('warehouse', selectElement.parentNode.id)
      cloned.querySelector('#sku-variable-price-all').setAttribute('site', pathItemPath.split('/')[0])
      //get combinations
      const existing = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=sku:${pathItemSku}&sk=sku-variables;&startsWith=true`)
        .then(response => response.json())


      for (let i = 0; i < existing.items.length; i++) {
        const item = existing.items[i]
        const comb = item.sk.replace('sku-variables;', "")
        const clonedRow = originalRow.cloneNode(true)
        const span = clonedRow.querySelector('#sku-variable-xz[hidden]')
        clonedRow.removeAttribute('hidden')
        clonedRow.setAttribute('sk', item.sk)
        clonedRow.querySelector('#sku-variable-price-warehouse').setAttribute('warehouse', selectElement.parentNode.id)
        clonedRow.querySelector('#sku-variable-price-site').setAttribute('site', pathItemPath.split('/')[0])
        const elements = comb.split(';')
        elements.pop()
        for (const element of elements) {
          const clonedSpan = span.cloneNode(true)

          const [key, value] = element.split(':')
          clonedSpan.removeAttribute('hidden')
          clonedSpan.querySelector('#sku-attribute-key-xz').textContent = key
          clonedSpan.querySelector('#sku-attribute-value-xz').textContent = value
          span.parentNode.append(clonedSpan)
        }
        span.remove()
        originalRow.parentNode.append(clonedRow)
      }
      originalRow.remove()

      original.parentNode.insertBefore(cloned, original)

    }
    const addCondition = async (event) => {

      const filled = getElementById1('sku_filled')
      const tr = filled.querySelector('#condition-row[hidden]')

      const cloned = tr.cloneNode(true)
      cloned.removeAttribute('hidden')
      tr.parentNode.append(cloned)
      const item = {
        id: ownerid,
        sk: 'condition:' + (new Date()).getTime().toString(),
        value: 'condition'
      }
      cloned.setAttribute('sk', item.sk)
      cloned.querySelector('#enableCondition').onclick = (e) => {
        e.target.textContent = 'üü¢'
        const original = getElementById1('sku-table').querySelector('#sku-variable-condition[hidden]')
        const cloned = original.cloneNode(true)
        cloned.removeAttribute('hidden')
        const v = e.target.parentNode.parentNode.querySelector('#conditionInput').textContent
        cloned.querySelector('#sku-variable-condition-value').textContent = v
        original.parentNode.insertBefore(cloned, original)

        const original2 = getElementById1('sku-table').querySelector('#all-td[hidden]')
        const cloned2 = original2.cloneNode(true)
        cloned2.removeAttribute('hidden')
        const condSk = e.target.parentNode.parentNode.getAttribute('sk')
        cloned2.setAttribute('condition', condSk)
        original2.parentNode.insertBefore(cloned2, original2)

        const originals = getElementById1('sku-table').querySelectorAll('#sku-variable-td[hidden]')
        originals.forEach(original => {
          const cloned = original.cloneNode(true)
          cloned.setAttribute('condition', condSk)
          cloned.removeAttribute('hidden')

          original.parentNode.insertBefore(cloned, original)
        })
        //generateConditionTable(v,condSk)
      }
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(item),
      });
    }
    const addShippingMethode = async (event) => {
      const filled = getElementById1('sku_filled')
      const tr = filled.querySelector('#ship-row[hidden]')

      const cloned = tr.cloneNode(true)
      cloned.removeAttribute('hidden')
      tr.parentNode.append(cloned)
      const item = {
        id: ownerid,
        sk: 'shippingMethode:' + (new Date()).getTime().toString(),
        value: 'shipping methode'
      }
      cloned.setAttribute('sk', item.sk)
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(item),
      });
      cloned.querySelector('#enableShip').onclick = async (e) => {
        const checkedWareHouses = querySelectorAll1('#warehouse-zd[checked]')
        if (checkedWareHouses.length) {
          const checkedWareHouse = checkedWareHouses[0]
          const sk = checkedWareHouse.parentNode.id
          const item1 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          }).then(e => e.json()).then(res => res.items[0])
          //item.shippingMethodes = item.shippingMethodes ? [...item.shippingMethodes, element.sk] : [element.sk]
          if (item1.shippingMethodes) {
            if (!item1.shippingMethodes.includes(item.sk)) {
              item1.shippingMethodes = [...item1.shippingMethodes, item.sk]
            }
          }
          else {
            item1.shippingMethodes = [item.sk]
          }
          console.log(JSON.stringify(item))
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(
              item1
            ),
          });
          e.target.textContent = 'üü¢'
        }
      }
    }
    const pushSkuVariables = async (event) => {
      const inputValue = getElementById1('push_new_sku_variables').value
      const lines = inputValue.split('\n')
      const data = []
      for (const line of lines) {
        const [legend, joinedAttributes] = line.trim().split(':')
        const attributes = joinedAttributes.split(',')
        data.push({
          legend,
          items: attributes.map(e => e.trim())
        })
      }
      console.log(data)
      const combinations = generateCombinations(data)
      pathItem.combinations = combinations.length
      updatePathItem()
      console.log(combinations)
      for (const combination of combinations) {
        const item = {
          id: 'sku:' + pathItemSku,
          sk: 'sku-variables;' + combination.toLowerCase(),
        }

        const existing = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/' + item.id + ':' + item.sk)
          .then(response => response.json())
        if (!existing) {
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(item),
          });
          /*
          const originalRow = getElementById1('sku-variable-row')

          const comb = combination.toLowerCase()
          const clonedRow = originalRow.cloneNode(true)
          const span = clonedRow.querySelector('#sku-variable-xz')
          clonedRow.removeAttribute('hidden')
          clonedRow.setAttribute('sk', item.sk)
          const elements = comb.split(';')
          elements.pop()
          for (const element of elements) {
            const clonedSpan = span.cloneNode(true)

            const [key, value] = element.split(':')
            clonedSpan.removeAttribute('hidden')
            clonedSpan.querySelector('#sku-attribute-key-xz').textContent = key
            clonedSpan.querySelector('#sku-attribute-value-xz').textContent = value
            span.parentNode.append(clonedSpan)
          }
          span.remove()
          originalRow.parentNode.append(clonedRow)
          */
        }
      }
      const checkedWareHouses = querySelectorAll1('#warehouse-zd[checked]')
      const sk = checkedWareHouses[0].parentNode.id
      const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json()).then(res => res.items[0])
      generateSkuV(item)
      event.target.closest('details').removeAttribute('open')
    }
    const setQty = async (event) => {
      const { target } = event
      const sk = target.closest('tr').getAttribute('sk')
      const condition = target.closest('tr').getAttribute('condition')
      const value = target.textContent
      const checkedWareHouse = querySelectorAll1('#warehouse-zd[checked]')[0]?.parentNode.id || target.getAttribute('warehouse')
      const getItem = {
        id: 'sku:' + pathItemSku,
        sk: 'warehouse_price_qty:' + condition + ';' + sk.replace('sku-variables;', '') + checkedWareHouse,
        qty: parseInt(value)

      }
      const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${getItem.id}&sk=${getItem.sk}&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json()).then(res => res.items[0])
      const pushItem = { ...getItem, ...item, qty: parseInt(value) }
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(
          pushItem
        ),
      });
    }
    const setAllQty = async (event) => {
      const { target } = event
      const condition = target.closest('td').getAttribute('condition')
      const value = target.textContent.trim()
      querySelectorAll1(`#sku-variable-td`).forEach(element => {
        if (element.id !== "all-td" && !element.parentNode.hasAttribute('hidden')) {
          const e = element.querySelector('#sku-variable-quantity')
          e.textContent = value
          e.onblur({ target: e })
        }
      })
    }
    const setPriceWareHouse = async (event, old) => {
      const { target } = event
      const warehouse = target.getAttribute('warehouse')
      const value = target.textContent
      const checkedWareHouse = querySelectorAll1('#warehouse-zd[checked]')[0]?.parentNode.id || target.getAttribute('warehouse')
      const sk = target.closest('tr').getAttribute('sk')
      const condition = target.closest('tr').getAttribute('condition')
      const getItem = {
        id: 'sku:' + pathItemSku,
        sk: 'warehouse_price_qty:' + condition + ';' + sk.replace('sku-variables;', '') + checkedWareHouse,


      }
      const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${getItem.id}&sk=${getItem.sk}&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json()).then(res => res.items[0])
      const pushItem = { ...getItem, ...item, price: parseInt(value) }
      console.log(JSON.stringify(pushItem))
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(
          pushItem
        ),
      });
    }
    const handleShipCountrySelection = async event => {
      var selectElement = event.target
      var selectedOption = selectElement.options[selectElement.selectedIndex].id;
      const sk = selectElement.closest('#ship-row').getAttribute('sk')
      const getItem = {
        id: ownerid,
        sk,
      }

      const tr = selectElement.closest('tr')
      const index = parseInt(tr.id.replace('ship-from-to-row-', ""))
      console.log('index' + index)
      const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${getItem.id}&sk=${getItem.sk}&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json()).then(res => res.items[0])
      if (!item.items) {
        item.items = []
      }
      item.items[index] ? (item.items[index].country = selectedOption) : (item.items[index] = { country: selectedOption })
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(
          { ...getItem, ...item }
        ),
      });
    }
    const handleWarehouseDestinationSelection = async event => {
      const checkedWareHouses = querySelectorAll1('#warehouse-zd[checked]')
      const checkedWareHouse = checkedWareHouses[0]
      const sk = checkedWareHouse.parentNode.id

      var selectElement = event.target
      const shipSK = selectElement.closest('tr').parentNode.closest('tr').id
      console.log(shipSK)
      var selectedOption = selectElement.options[selectElement.selectedIndex].id;

      const getItem = {
        id: ownerid,
        sk,
      }

      const tr = selectElement.closest('tr')
      const index = parseInt(tr.id.replace('ship-method-destination-row-', ""))
      console.log('index' + index)
      const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${getItem.id}&sk=${getItem.sk}&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json()).then(res => res.items[0])
      console.log(JSON.stringify(item))
      const found = item.shippingMethodes.find(e => e.id === shipSK)
      if (!found.items) {
        found.items = []
      }
      found.items[index] = selectedOption
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(
          { ...item }
        ),
      });
    }
    const handleShipDestinationSelection = async event => {
      var selectElement = event.target
      var selectedOption = selectElement.options[selectElement.selectedIndex].id;
      const sk = selectElement.closest('#ship-row').getAttribute('sk')
      const getItem = {
        id: ownerid,
        sk,
      }
      const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${getItem.id}&sk=${getItem.sk}&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json()).then(res => res.items[0])
      const tr = selectElement.closest('tr')
      const index = parseInt(tr.id.replace('ship-from-to-row-', ""))
      if (!item.items) {
        item.items = []
      }
      item.items[index] ? (item.items[index].destination = selectedOption) : (item.items[index] = { destination: selectedOption })
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(
          { ...getItem, ...item }
        ),
      });
    }
    const handleShipMinSelection = async event => {
      var selectElement = event.target
      var selectedOption = selectElement.options[selectElement.selectedIndex].id;
      const sk = selectElement.closest('#ship-row').getAttribute('sk')
      const getItem = {
        id: ownerid,
        sk,
      }
      const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${getItem.id}&sk=${getItem.sk}&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json()).then(res => res.items[0])
      const tr = selectElement.closest('tr')
      const index = parseInt(tr.id.replace('ship-from-to-row-', ""))
      if (!item.items) {
        item.items = []
      }
      item.items[index] ? (item.items[index].min = selectedOption) : (item.items[index] = { min: selectedOption })
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(
          { ...getItem, ...item }
        ),
      });
    }
    const handleShipMaxSelection = async event => {
      var selectElement = event.target
      var selectedOption = selectElement.options[selectElement.selectedIndex].id;
      const sk = selectElement.closest('#ship-row').getAttribute('sk')
      const getItem = {
        id: ownerid,
        sk,
      }
      const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${getItem.id}&sk=${getItem.sk}&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json()).then(res => res.items[0])
      const tr = selectElement.closest('tr')
      const index = parseInt(tr.id.replace('ship-from-to-row-', ""))
      if (!item.items) {
        item.items = []
      }
      item.items[index] ? (item.items[index].max = selectedOption) : (item.items[index] = { max: selectedOption })
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(
          { ...getItem, ...item }
        ),
      });
    }
    const setPriceSite = async (event, old) => {
      const { target } = event
      const warehouse = target.getAttribute('warehouse')
      const value = target.textContent
      const checkedWareHouse = querySelectorAll1('#warehouse-zd[checked]')[0]?.parentNode.id || target.getAttribute('warehouse')
      const sk = target.closest('tr').getAttribute('sk')
      const condition = target.closest('tr').getAttribute('condition')
      const getItem = {
        id: 'sku:' + pathItemSku,
        sk: 'site_price:' + pathItemPath.split('/')[0].toLowerCase() + ';' + condition + ';' + sk.replace('sku-variables;', ''),


      }
      const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${getItem.id}&sk=${getItem.sk}&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json()).then(res => res.items[0])
      const pushItem = { ...getItem, ...item, }
      old ? (pushItem.oldPrice = parseInt(value)) : (pushItem.price = parseInt(value))
      console.log(JSON.stringify(pushItem))
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(
          pushItem
        ),
      });
    }
    const setPriceWareHouseAll = async (event) => {
      const { target } = event
      const condition = target.closest('td').getAttribute('warehouse')
      const value = target.textContent.trim()
      console.log(condition)
      target.closest('table').querySelectorAll(`[warehouse="${condition}"]`).forEach(element => {
        if (element.id !== "sku-variable-price-warehouse-all" && !element.parentNode.hasAttribute('hidden')) {
          console.log('')
          element.querySelector('#sku-variable-price-warehouse-value').textContent = value
          element.querySelector('#sku-variable-price-warehouse-value').onblur({ target: element.querySelector('#sku-variable-price-warehouse-value') })
        }
      })
    }
    const generateSkuV = async (defaultWareHouse) => {
      const sku = pathItemSku
      const conditions1 = defaultWareHouse.conditions
      let warehouses =  fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=warehouse:&startsWith=true`)
        .then(response => response.json()).then(res => res.items)

      let conditions =  fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=condition:&startsWith=true`)
        .then(response => response.json()).then(res => res.items)

      let skuVariables =  fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=sku:${sku}&sk=sku-variables;&startsWith=true`)
        .then(response => response.json()).then(res => res.items)
      let skuQtyValue =  fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=sku:${sku}&sk=warehouse_price_qty:&startsWith=true`)
        .then(response => response.json()).then(res => res.items)
      let skuSiteValue =  fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=sku:${sku}&sk=site_price:${pathItemPath.split('/')[0].toLowerCase()}&startsWith=true`)
        .then(response => response.json()).then(res => res.items)
      //await Promise.all([warehouses,conditions,skuVariables,skuQtyValue,skuSiteValue])
      warehouses = await warehouses
      conditions = await conditions
      skuVariables = await skuVariables
      skuQtyValue = await skuQtyValue
      skuSiteValue = await skuSiteValue
      if (!conditions1) {
        return
      }

      for (const condition of conditions1) {
        const conditionValue = conditions.find(e => e.sk === condition).value
        console.log(conditionValue)
        const originalRow = getElementById1('sku-table').querySelector('#sku-variable-row[hidden]')
        getElementById1('sku-table').querySelectorAll('#sku-variable-row:not([hidden])').forEach(e=>e.remove())
        for (const element of skuVariables) {


          
          const item = element
          const comb = item.sk.replace('sku-variables;', "")
          const clonedRow = originalRow.cloneNode(true)
          clonedRow.setAttribute('sk', item.sk)
          clonedRow.setAttribute('condition', condition)
          const span = clonedRow.querySelector('#sku-variable-xz')
          clonedRow.removeAttribute('hidden')
          const elements = comb.split(';')
          elements.pop()
          clonedRow.querySelector('#sku-attribute-condition').textContent = conditionValue


          const foundV = skuQtyValue.find(e => e.sk.startsWith('warehouse_price_qty:' + condition + ';' + comb + defaultWareHouse.sk))
          const qI = clonedRow.querySelector('#sku-variable-quantity')
          const pI = clonedRow.querySelector('#sku-variable-price-warehouse-value-all')
          qI.setAttribute('warehouse', defaultWareHouse.sk)
          pI.setAttribute('warehouse', defaultWareHouse.sk)
          if (foundV) {
            qI.textContent = foundV?.qty || 0
            pI.textContent = foundV?.price || 0
          }
          const siteValue = skuSiteValue.find(e => e.sk.startsWith('site_price:' + pathItemPath.split('/')[0].toLowerCase() + ';' + condition + ';' + comb))
          const sI = clonedRow.querySelector('#sku-variable-price-all-current')
          const osI = clonedRow.querySelector('#sku-variable-price-all-old')
          sI.setAttribute('warehouse', defaultWareHouse.sk)
          osI.setAttribute('warehouse', defaultWareHouse.sk)
          if (siteValue) {
            sI.textContent = siteValue.price || 0
            osI.textContent = siteValue.oldPrice || 0
          }

          for (const element of elements) {
            const clonedSpan = span.cloneNode(true)

            const [key, value] = element.split(':')
            clonedSpan.removeAttribute('hidden')
            clonedSpan.querySelector('#sku-attribute-key-xz').textContent = key
            clonedSpan.querySelector('#sku-attribute-value-xz').textContent = value
            span.parentNode.append(clonedSpan)
          }
          span.remove()
          originalRow.parentNode.append(clonedRow)
        }
      }

    }

    const showSku2 = async (sku) => {
      pathItemSku = sku
      log1('showing sku original ' + sku)

      getElementById1("sku-empty2").setAttribute('hidden', '')
      const filled = getElementById1('sku_filled')
      filled.removeAttribute('hidden')
      filled.querySelector('#sku-condition-site-name-value').textContent = pathItemPath.split('/')[0].toLowerCase()
      //get warehouses
      document.querySelector('#sku-value2').textContent = sku
      const warehouses = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=warehouse:&startsWith=true`)
        .then(response => response.json()).then(res => res.items)
      const destinations = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=destination:&startsWith=true`)
        .then(response => response.json()).then(res => res.items)
      const conditions = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=condition:&startsWith=true`)
        .then(response => response.json()).then(res => res.items)
      const shippingMethodes = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=shippingMethode:&startsWith=true`)
        .then(response => response.json()).then(res => res.items)
      const skuVariables = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=sku:${sku}&sk=sku-variables;&startsWith=true`)
        .then(response => response.json()).then(res => res.items)
      const skuQtyValue = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=sku:${sku}&sk=warehouse_price_qty:&startsWith=true`)
        .then(response => response.json()).then(res => res.items)
      const skuSiteValue = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=sku:${sku}&sk=site_price:${pathItemPath.split('/')[0].toLowerCase()}&startsWith=true`)
        .then(response => response.json()).then(res => res.items)
      let addedConditions = skuQtyValue.map(element =>
        element.sk.split(';')[0].split(':')[1] + ':' + element.sk.split(';')[0].split(':')[2]
      )
      addedConditions = removeDuplicates(addedConditions)
      /*
      let setWareHouse
      
      if (skuQtyValue.length) {
        setWareHouse = skuQtyValue[0].sk.split(';').pop()
        const option = getElementById1('warehouse_select_label')
        const cloned1 = option.cloneNode(true)
        cloned1.setAttribute('id', setWareHouse)
        cloned1.removeAttribute('hidden')
        console.log(option.parentNode.children.length)
        if (option.parentNode.children.length === 1) {
          cloned1.querySelector('input').setAttribute('checked', "")
        }
        cloned1.querySelector('#warehouse_value-zd').textContent = warehouses.find(e => e.sk === setWareHouse).value
        option.parentNode.append(cloned1)

      }
      for (const addedCondition of addedConditions) {
        const original = getElementById1('sku-table').querySelector('#sku-variable-condition[hidden]')
        const cloned = original.cloneNode(true)
        cloned.removeAttribute('hidden')
        cloned.querySelector('#sku-variable-condition-value').textContent = conditions.find(e => e.sk === addedCondition).value
        original.parentNode.insertBefore(cloned, original)
        const original2 = getElementById1('sku-table').querySelector('#all-td[hidden]')
        const cloned2 = original2.cloneNode(true)
        cloned2.removeAttribute('hidden')
        console.log(addedCondition)
        console.log(JSON.stringify(conditions))
        const condSk = conditions.find(e => e.sk === addedCondition).sk
        cloned2.setAttribute('condition', condSk)
        original2.parentNode.insertBefore(cloned2, original2)

        const originals = getElementById1('sku-table').querySelectorAll('#sku-variable-td[hidden]')
        originals.forEach(original => {
          const cloned = original.cloneNode(true)
          cloned.setAttribute('condition', condSk)
          cloned.removeAttribute('hidden')

          original.parentNode.insertBefore(cloned, original)
        })
        //generateConditionTable(conditions.find(e => e.sk === addedCondition).value,addedCondition)
      }*/

      const defaultWareHouse = warehouses.find(e => e.default)
      const generateShippingM = async (defaultWareHouse) => {
        const shippingIds = defaultWareHouse.shippingMethodes
        if (!shippingIds) {
          return
        }
        const ids = removeDuplicates(shippingIds.map(e => e.id))
        console.log(ids)
        const filtered = ids.map(id1 => shippingMethodes.find(e => e.sk === id1))
        console.log(JSON.stringify(filtered))
        const originals = querySelectorAll1('#shipping-des-item')
        const original = originals[0]
        for (const el of filtered) {
          const cloned = original.cloneNode(true)
          cloned.removeAttribute('hidden')
          cloned.querySelector('#shipping-type').textContent = el.value
          cloned.id = el.sk
          original.parentNode.append(cloned)
          const originalSubRow = cloned.querySelector('#ship-method-destination-row-0')
          const element = shippingIds.find(e => e.id === el.sk)
          console.log(filtered.sk)
          console.log(shippingIds)
          if (element?.items?.length) {


            for (let i = 0; i < element.items.length; i++) {
              const el = element.items[i]
              const cloned = originalSubRow.cloneNode(true)
              //set values


              const countrySelect = cloned.querySelector('#warehouse-destination-value select');
              // Example value to match against option id
              countrySelect.selectedIndex = Array.from(countrySelect.children).findIndex(option => option.id === el);


              cloned.id = 'ship-method-destination-row-' + i
              originalSubRow.parentNode.append(cloned)

            }
            originalSubRow.remove()
          }
        }
        filtered.length && originals.forEach(e => e.remove())
      }
      if (defaultWareHouse) {
        const option = getElementById1('warehouse_select_label')
        const cloned1 = option.cloneNode(true)
        cloned1.setAttribute('id', defaultWareHouse.sk)
        cloned1.removeAttribute('hidden')
        console.log(option.parentNode.children.length)
        if (option.parentNode.children.length === 1) {
          cloned1.querySelector('input').setAttribute('checked', "")
        }
        cloned1.querySelector('#warehouse_value-zd').textContent = defaultWareHouse.value
        option.parentNode.append(cloned1)
        getElementById1('sku-condition-warehouse-qty-value').textContent = defaultWareHouse.value
        generateShippingM(defaultWareHouse)
        generateSkuV(defaultWareHouse)
      }






      for (const element of warehouses) {
        const tr = filled.querySelector('#warehouse-row[hidden]')
        const cloned = tr.cloneNode(true)
        cloned.setAttribute('sk', element.sk)
        cloned.removeAttribute('hidden')
        tr.parentNode.append(cloned)
        cloned.querySelector('#wareHouseInput').textContent = element.value
        cloned.querySelector('#defaultWareHouseInput').checked = !!element.default
        cloned.querySelector('#warehouse-min-processing').textContent = element.min || 0
        cloned.querySelector('#warehouse-max-processing').textContent = element.max || 0
        const locationSelect = cloned.querySelector('#warehouse-country-select')
        locationSelect.selectedIndex =
          Array.from(locationSelect.children).findIndex(option => option.id === element.location);


        cloned.querySelector('#enableWareHouse').onclick = (e) => {
          e.target.textContent = 'üü¢'
          const option = getElementById1('warehouse_select_label')
          const cloned1 = option.cloneNode(true)
          cloned1.setAttribute('id', element.sk)
          cloned1.removeAttribute('hidden')
          console.log(option.parentNode.children.length)
          if (option.parentNode.children.length === 1) {
            cloned1.querySelector('input').setAttribute('checked', "")
            generateSkuV(element)
            generateShippingM(element)
          }
          cloned1.querySelector('#warehouse_value-zd').textContent = e.target.parentNode.parentNode.querySelector('#wareHouseInput').textContent
          option.parentNode.append(cloned1)

        }
        cloned.querySelector('#warehouse-country-select').onchange = async (e) => {
          var selectElement = e.target
          var selectedOption = selectElement.options[selectElement.selectedIndex].id;
          const element1 = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?' + `id=${element.id}&sk=${element.sk}&startsWith=true`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          }).then(e => e.json()).then(res => res.items[0])
          element1.location = selectedOption
          fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(
              element1
            ),
          });

        }
        cloned.querySelector('#warehouse-min-processing').onblur = async (e) => {
          const min = e.target.textContent
          const element1 = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?' + `id=${element.id}&sk=${element.sk}&startsWith=true`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          }).then(e => e.json()).then(res => res.items[0])
          element1.min = parseInt(min)
          fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(
              element1
            ),
          });

        }
        cloned.querySelector('#warehouse-max-processing').onblur = async (e) => {
          const max = e.target.textContent
          const element1 = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?' + `id=${element.id}&sk=${element.sk}&startsWith=true`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          }).then(e => e.json()).then(res => res.items[0])
          element1.max = parseInt(max)
          fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(
              element1
            ),
          });

        }
        cloned.querySelector('#defaultWareHouseInput').onchange = (e) => {
          const checked = e.target.checked
          element.default = checked
          fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(
              element
            ),
          });

        }
      }
      /*
      for (const element of destinations) {
        const tr = filled.querySelector('#destination-row[hidden]')
        const cloned = tr.cloneNode(true)
        cloned.setAttribute('sk', element.sk)
        cloned.removeAttribute('hidden')
        tr.parentNode.append(cloned)
        cloned.querySelector('#destinationInput').textContent = element.value
        cloned.querySelector('#enableDestination').onclick = (e) => {
          e.target.textContent = 'üü¢'
          const option = getElementById1('destination_select_option')
          const cloned1 = option.cloneNode(true)
          cloned1.removeAttribute('hidden')
          cloned1.setAttribute('id', element.sk)
          cloned1.textContent = "üè¥Û†Å•Û†Å≥Û†Å∞Û†Å∂Û†Åø" + e.target.parentNode.parentNode.querySelector('#destinationInput').textContent
          option.parentNode.append(cloned1)
  
        }
  
      }*/
      for (const element of conditions) {
        const tr = filled.querySelector('#condition-row[hidden]')
        const cloned = tr.cloneNode(true)
        cloned.setAttribute('sk', element.sk)
        cloned.removeAttribute('hidden')
        tr.parentNode.append(cloned)
        cloned.querySelector('#conditionInput').textContent = element.value
        cloned.querySelector('#enableCondition').onclick = async (e) => {
          e.target.textContent = 'üü¢'
          /*
          const original = getElementById1('sku-table').querySelector('#sku-variable-condition[hidden]')

          const cloned = original.cloneNode(true)
          cloned.removeAttribute('hidden')
          const v = e.target.parentNode.parentNode.querySelector('#conditionInput').textContent
          cloned.querySelector('#sku-variable-condition-value').textContent = v
          original.parentNode.insertBefore(cloned, original)

          const original2 = getElementById1('sku-table').querySelector('#all-td[hidden]')
          const cloned2 = original2.cloneNode(true)
          cloned2.removeAttribute('hidden')
          const condSk = e.target.parentNode.parentNode.getAttribute('sk')
          cloned2.setAttribute('condition', condSk)
          original2.parentNode.insertBefore(cloned2, original2)

          const originals = getElementById1('sku-table').querySelectorAll('#sku-variable-td[hidden]')
          originals.forEach(original => {
            const cloned = original.cloneNode(true)
            cloned.setAttribute('condition', condSk)
            cloned.removeAttribute('hidden')

            original.parentNode.insertBefore(cloned, original)
          })
          */
          //set default conditions
          const checkedWareHouses = querySelectorAll1('#warehouse-zd[checked]')
          if (checkedWareHouses.length) {
            const checkedWareHouse = checkedWareHouses[0]
            const sk = checkedWareHouse.parentNode.id
            const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(e => e.json()).then(res => res.items[0])

            if (item.conditions) {
              if (!item.conditions.includes(element.sk)) {
                item.conditions = [...item.conditions, element.sk]
                generateSkuV(item)
              }
            }
            else {
              item.conditions = [element.sk]
              generateSkuV(item)
            }
            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(
                item
              ),
            });
          }
          //generateConditionTable(v)
        }
      }
      for (const element of shippingMethodes) {
        const tr = filled.querySelector('#ship-row[hidden]')
        const cloned = tr.cloneNode(true)
        cloned.setAttribute('sk', element.sk)
        cloned.removeAttribute('hidden')
        tr.parentNode.append(cloned)
        cloned.querySelector('#shipInput').textContent = element.value
        const originalSubRow = cloned.querySelector('#ship-from-to-row-0')
        if (element.items?.length) {


          for (let i = 0; i < element.items.length; i++) {
            const el = element.items[i]
            const cloned = originalSubRow.cloneNode(true)
            const { country, destination, min, max } = el
            //set values


            const countrySelect = cloned.querySelector('#ship-from-td select');
            // Example value to match against option id
            countrySelect.selectedIndex = Array.from(countrySelect.children).findIndex(option => option.id === country);

            // Select and set the selectedIndex for the destination select element
            const destinationSelect = cloned.querySelector('#ship-to-td select');
            destinationSelect.selectedIndex = Array.from(destinationSelect.children).findIndex(option => option.id === destination);

            // Select and set the selectedIndex for the min select element
            const minSelect = cloned.querySelector('#ship-min-td select');
            minSelect.selectedIndex = Array.from(minSelect.children).findIndex(option => option.id === min);

            // Select and set the selectedIndex for the max select element
            const maxSelect = cloned.querySelector('#ship-max-td select');
            maxSelect.selectedIndex = Array.from(maxSelect.children).findIndex(option => option.id === max);
            cloned.id = 'ship-from-to-row-' + i
            originalSubRow.parentNode.append(cloned)

          }
          originalSubRow.remove()
        }
        cloned.querySelector('#enableShip').onclick = async (e) => {
          const checkedWareHouses = querySelectorAll1('#warehouse-zd[checked]')
          if (checkedWareHouses.length) {
            const checkedWareHouse = checkedWareHouses[0]
            const sk = checkedWareHouse.parentNode.id
            const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(e => e.json()).then(res => res.items[0])
            //item.shippingMethodes = item.shippingMethodes ? [...item.shippingMethodes, element.sk] : [element.sk]
            if (item.shippingMethodes) {
              if (!item.shippingMethodes.includes(element.sk)) {
                item.shippingMethodes = [...item.shippingMethodes, { id: element.sk }]
              }
            }
            else {
              item.shippingMethodes = [{ id: element.sk }]
            }
            console.log(JSON.stringify(item))
            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(
                item
              ),
            });
            e.target.textContent = 'üü¢'
            generateShippingM(item)
          }
        }
      }
      /*
    const item1 = getElementById1("sku-item-1")
    const cloned1 = item1.cloneNode(true)
    cloned1.id = sku
    cloned1.removeAttribute('hidden')
    getElementById1("sku-list").removeAttribute('hidden')
    cloned1.querySelector("#sku-value").textContent = sku
    cloned1.querySelector("#remove-sku").removeAttribute('hidden')
    const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${sku}&sk=qty;&startsWith=true`)
      .then(response => response.json())
    const el = cloned1.querySelectorAll('#sku-item')
    const parent = cloned1.querySelector('#sku-attribute-list')
    //if (items.length > 1) {
 
    const p = items.map(async item => {
 
      const cloned = el[0].cloneNode(true)
      const v = item.sk.replace('qty;', '')
      log1("sku i is " + JSON.stringify(item))
      cloned.querySelector('#sku-attribute-value').textContent = v
      const psk = `price;${pathItemPath.split('/')[0].toLowerCase()};${v}price`
      const pItem = await fetch(`${backend_url}?id=${sku}&sk=${psk}&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json()).then(({ items }) => items[0])
 
      cloned.querySelector('#sku-qty').textContent = item.qty || 0
      const oldEl = cloned.querySelector('[data-price_old_value]')
      const pEl = cloned.querySelector('[data-price_value]')
      oldEl.textContent = pItem?.oldprice || 0
      pEl.textContent = pItem?.price || 0
      pEl.addEventListener('blur', async function () {
        let value = -1
        try {
          value = parseFloat(pEl.textContent)
        }
        catch (e) {
 
        }
        if (value < 0) {
          value = 0
          pEl.textContent = 0
        }
 
 
        let nV = pItem
        if (nV) {
          nV.price = value
        }
        else {
          nV = {
            id: sku,
            sk: psk,
            price: value
          }
        }
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          body: JSON.stringify(nV),
        });
      });
      oldEl.addEventListener('blur', async function () {
        let value = -1
        try {
          value = parseFloat(oldEl.textContent)
        }
        catch (e) {
 
        }
        if (value < 0) {
          value = 0
          oldEl.textContent = 0
        }
 
 
        let nV = pItem
        if (nV) {
          nV.oldprice = value
        }
        else {
          nV = {
            id: sku,
            sk: psk,
            oldprice: value
          }
        }
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          body: JSON.stringify(nV),
        });
      });
      parent.appendChild(cloned)
      cloned.addEventListener('click', e => handleSkuItemClick(cloned, item))
    })
    await Promise.all(p)
    
    getElementById1("sku-list").appendChild(cloned1)
    */

    }

    const handleHead = async () => {

      const resultList = await getProductAttributes()

      if (resultList.length || pathItemSku) {
        log1('path item sku' + pathItemSku)
        //getElementById1('sku-menu').removeAttribute('hidden')
        //getElementById1('sku-menu2').removeAttribute('hidden')

        pathItemSku && showSku(pathItemSku, true)
        pathItemSku && showSku2(pathItemSku, true)



      }
      const splited = pathItemPath.split(';')[0].split('/')
      const name = splited[splited.length - 1]

      showListMenus(pathItem.hub_items?.list, undefined, pathItem.hub_items)

      await showList(pathItem.hub_items?.list, undefined, pathItem.hub_items)
      /* showai
      if (pathItem.hub_items?.gpt) {
        await showai(pathItem.hub_items?.gpt)
        const res = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${pathItem.id}&sk=ai-logs:&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(e => e.json())
        if (res.items.length) {
          const element = document.getElementById('ai-logs')
          element.removeAttribute('hidden')
          element.querySelector('textarea').value = res.items.map(el => JSON.stringify(el.gptResponse, null, 2) + '\n\n' + JSON.stringify(el.content) + '\n\n').join('\n\n=============================================\n\n')
        }
      }
      */
      let mainHubLsi = splited[0] + '/Home|Hub'
      let headHubLsi = splited[0] + '/Home/Content/Page|Head-Content'
      /*
      if(pathItem.lsi1.startsWith('Style-Green.SeoSitesHome.com')){
        mainHubLsi = splited[0] + '/Seed-Home|Hub'
        headHubLsi = splited[0] + '/Seed-Home/Content/Page|Head-Content'
      }*/
      if (pathItem.lsi1.split(';')[0] !== mainHubLsi) {
        url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${mainHubLsi}`;
        let mainHub
        try {
          const mainHubResponse = await fetch(url);
          const mainHubData = await mainHubResponse.json();
          if (mainHubData.items.length) {
            const mainHubItem = mainHubData.items[0];
            const templateResponse = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${mainHubItem.id}:${mainHubItem.sk}`);
            const templateData = await templateResponse.json();
            mainHub = templateData; // Assuming `templateData` is the desired result
          }
          else if (splited[0] + '/Seed-Home|Hub' !== pathItem.lsi1.split(';')[0]) {
            mainHubLsi = splited[0] + '/Seed-Home|Hub'
            headHubLsi = splited[0] + '/Seed-Home/Content/Page|Head-Content'
            url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${mainHubLsi}`;
            const mainHubResponse = await fetch(url);
            const mainHubData = await mainHubResponse.json();
            if (mainHubData.items.length) {
              const mainHubItem = mainHubData.items[0];
              const templateResponse = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${mainHubItem.id}:${mainHubItem.sk}`);
              const templateData = await templateResponse.json();
              mainHub = templateData; // Assuming `templateData` is the desired result
            }

          }

          // Use `mainHub` here
        } catch (error) {
          // Handle errors
        }
        if (mainHub?.hub_items?.list) {

          url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${headHubLsi}`;
          const { items } = await fetch(url).then(e => e.json())
          showListMenus(mainHub.hub_items?.list, items[0].id, pathItem.hub_items)
          await showList(mainHub.hub_items?.list, items[0].id, pathItem.hub_items)
        }
      }


      /*
querySelectorAll1('[data-product]').forEach(
element => {
const prev = element.getAttribute('data-product')
if (prev) {
const [first, last] = prev.split(';')
element.setAttribute('data-product', [first, name].join(';'))
}
}
)
*/


    }
    const save = async (event) => {
      const parent = event.target.parentNode
      const { id } = parent
      const action = parent.getAttribute('action')
      log1('ac' + action)
      if (action === 'innerHtml') {
        const saveButton = event.target;
        const fieldset = saveButton.closest('fieldset');

        log1(id)
        const textareaValue = fieldset.querySelector('#code-tree-inner-html-receive-textarea').value;

        const splited = id.split(';')
        const [toRemove, ...rest] = splited
        const el = {
          time: (new Date()).getTime(),
          action,
          target_element: rest.join(';'),
          insertedCode: textareaValue,

        }
        log1(JSON.stringify(el))
        await pushAction(el)
      }
      parent.remove()
      log1(JSON.stringify(actionLog))

    }
    const saveText = async (event) => {
      const parent = event.target.parentNode
      const { id } = parent
      const action = 'textContent'
      log1('ac' + action)

      const saveButton = event.target;
      const fieldset = saveButton.closest('fieldset');


      const textareaValue = fieldset.querySelector('#code-tree-tag-text-content').value;
      const splited = id.split(';')
      const [toRemove, ...rest] = splited

      const el = {
        time: (new Date()).getTime(),
        action,
        target_element: rest.join(';'),
        value: textareaValue,

      }
      log1(JSON.stringify(el))
      await pushAction(el)

      parent.remove()
      log1(JSON.stringify(actionLog))

    }
    const saveInnerHtml = async (event) => {
      const parent = event.target.parentNode
      const { id } = parent
      const action = 'innerHtml'
      log1('ac' + action)

      const saveButton = event.target;
      const fieldset = saveButton.closest('fieldset');


      const textareaValue = fieldset.querySelector('#code-tree-tag-html-content').value;
      const splited = id.split(';')
      const [toRemove, ...rest] = splited

      const el = {
        time: (new Date()).getTime(),
        action,
        target_element: rest.join(';'),
        insertedCode: textareaValue,

      }
      log1(JSON.stringify(el))
      await pushAction(el)

      parent.remove()
      log1(JSON.stringify(actionLog))

    }
    const saveAttribute = async (event) => {
      const parentMenu = event.target.closest('.menu-1');
      const checked = parentMenu.querySelector('#applyToCopies').checked
      if (!parentMenu) {
        console.error('Could not find parent menu element');
        return;
      }

      const { id } = parentMenu
      const action = 'setAttribute'
      log1('ac' + action)

      const saveButton = event.target;
      const fieldset = saveButton.closest('fieldset');


      //const textareaValue = fieldset.querySelector('#code-tree-tag-attribute-input-key').value;
      //const textareaValue2 = fieldset.querySelector('#code-tree-tag-attribute-input-key-value').value;
      const text = fieldset.querySelector('#code-tree-tag-attribute-input-text').value;
      const splited = id.split(';')
      const [toRemove, ...rest] = splited
      function parseText(text) {
        const lines = text.split('\n');
        const result = [];

        lines.forEach(line => {
          if (line === "") {
            return
          }
          const keyValue = line.replaceAll('"', '').split('=');
          if (keyValue.length >= 2) {
            const key = keyValue[0].trim();
            keyValue.shift()
            const value = keyValue.join('=').trim();
            result.push({ key, value })
          }
          else {
            result.push({ key: line.trim(), value: "" })
          }
        });

        return result;
      }
      const list = parseText(text)
      for (const element of list) {

        const el = {
          time: (new Date()).getTime(),
          action,
          target_element: rest.join(';'),
          key: element.key,
          value: element.value,

        }
        if (checked) {
          el.options = { apply_to_copies: true }
          el.target_element = el.target_element.split(':')[0].replace('-tree', '') + '-tree'
        }
        await pushAction(el)

      }
      fieldset.querySelector('#code-tree-tag-attribute-input-text').value = ""
      //fieldset.querySelector('#code-tree-tag-attribute-input-key').value = ''
      //fieldset.querySelector('#code-tree-tag-attribute-input-key-value').value = ''
      //log1(JSON.stringify(el))

      parentMenu.remove()
      log1(JSON.stringify(actionLog))

    }

  </script>
  <script>

    //second menu 
    const cancelReplace = (event) => {

      event.target.parentNode.nextElementSibling.remove()
      event.target.parentNode.remove()
    }
    const cancelAddComponent = (event) => {
      const pid = event.target.parentNode.id.replace('file-list-attach-component-options;', '')
      document.getElementById('file-list-attach-component-options;' + pid).remove()
      document.getElementById('selectedFilePathList;' + pid).remove()
      document.getElementById('filePathList;' + pid).remove()
    }
    const cancel = (e) => {

      e.target.parentNode.remove()
    }
    const cancel3 = (e) => {

      e.target.parentNode.parentNode.remove()
    }
    const cancel2 = (e) => {

      e.target.parentNode.parentNode.remove()
      var codeTreeTagFieldsets = querySelectorAll1('fieldset[data-element="code-tree-tag"]');
      codeTreeTagFieldsets.forEach(function (fieldset) {
        var checkbox = fieldset.querySelector('input[type="checkbox"]');
        if (checkbox) {
          checkbox.setAttribute('hidden', 'true');
        }
      });
    }
    const cancel1 = (e) => {

      // Assuming e is an event object
      const elementToRemove = e.target.closest('[id^="code-tree-tag-attributes-form-1;"]');

      if (elementToRemove) {
        elementToRemove.remove();
      }
    }
    var append = (e) => {
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('code-tree-add-tag-step-1');
      const checked = e.target.parentNode.querySelector('#applyToCopies').checked
      const actionInReplace = e.target.parentNode.querySelector('#actionInReplace').checked
      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('code-tree-add-tag-step-1')) {
        const clonedFieldset = fieldset.cloneNode(true);

        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', 'Append')
        checked && clonedFieldset.setAttribute('copiesOfInserting', "true")
        actionInReplace && clonedFieldset.setAttribute('actionInReplace', "true")
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
      }
    }
    var addParent = (e) => {
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('tag-table');
      const applyToCopies = e.target.parentNode.querySelector('#applyToCopies').checked

      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('tag-table')) {
        const clonedFieldset = fieldset.cloneNode(true);

        const clonedRows = clonedFieldset.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        for (let i = 0; i < clonedRows.length; i++) {
          const index = i; // Capture the current value of 'i' in a closure
          clonedRows[i].onclick = function (event) {
            chooseTag(index, event);
          };
        }
        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', "Add_Parent")
        if (applyToCopies) {
          clonedFieldset.querySelector('#applyForCopies2').checked = true
        }

        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
      }
    }

    const insertB = (e) => {


      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('code-tree-add-tag-step-1');
      const checked = e.target.parentNode.querySelector('#applyToCopies').checked
      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('code-tree-add-tag-step-1')) {
        const clonedFieldset = fieldset.cloneNode(true);

        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', 'InsertBefore')
        checked && clonedFieldset.setAttribute('copiesOfInserting', "true")
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
      }

    }
    const insertA = (e) => {


      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('code-tree-add-tag-step-1');
      const checked = e.target.parentNode.querySelector('#applyToCopies').checked
      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('code-tree-add-tag-step-1')) {
        const clonedFieldset = fieldset.cloneNode(true);

        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', 'InsertAfter')
        checked && clonedFieldset.setAttribute('copiesOfInserting', "true")
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
      }

    }
    const insertHtml = (e) => {

      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('code-tree-inner-html-receive-menu');

      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('code-tree-inner-html-receive-menu')) {
        const clonedFieldset = fieldset.cloneNode(true);
        clonedFieldset.querySelector('textarea').value = getElementById1(parentId.replace('-tree', '')).innerHTML
        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', 'innerHtml')
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
      }
    }
    const changeTag = (e) => {
      const splited = e.target.parentNode.id.split(';')
      const checked = e.target.parentNode.querySelector('#applyToCopies').checked
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('tag-table');

      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('tag-table')) {
        const clonedFieldset = fieldset.cloneNode(true);


        const clonedRows = clonedFieldset.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        for (let i = 0; i < clonedRows.length; i++) {
          const index = i; // Capture the current value of 'i' in a closure
          clonedRows[i].onclick = function (event) {
            chooseTag(index, event);
          };
        }
        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', 'ChangeTag')
        if (checked) {

          log1('setting checked')
          clonedFieldset.querySelector('#applyForCopies2').checked = true

        }
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
      }
    }

    const duplicateTag = (e) => {
      const splited = e.target.parentNode.id.split(';');
      const [toRemove, ...rest] = splited;
      const parentId = rest.join(';');
      function duplicateId(originalId,) {
        const splited = originalId.split(';');
        const lastId = splited[splited.length - 1]
        let newLastUUID
        const splited2 = lastId.split(':')
        newLastUUID = splited2[0] + ':' + generateUUID()
        splited.pop()
        return [...splited, newLastUUID].join(';') + '-tree'

      }

      const el = {
        time: (new Date()).getTime(),
        action: 'InsertBefore',
        target_element: parentId,
        inserted_element: { originalId: parentId, id: duplicateId(removeLastOccurrence(parentId, '-tree')) },
      };

      pushAction(el);
    };
    const removeTag = (e) => {
      const checked = e.target.parentNode.querySelector('#applyToCopies').checked
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const el =
      {
        time: (new Date()).getTime(),
        action: 'removeTag',

        target_element: parentId,

      }
      if (checked) {
        el.options = { apply_to_copies: true }
        el.target_element = el.target_element.split(':')[0].replace('-tree', '') + '-tree'
      }
      pushAction(el)
      e.target.parentNode.remove()
    }

    const removeComponent = async (e) => {
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const el =
      {
        time: (new Date()).getTime(),
        action: 'removeComponent',
        target_element: parentId,

      }
      await pushAction(el)
      location.reload()


    }
    const approve = async (event) => {
      var checkbox = event.target;
      const actionInReplace = event.target.parentNode.querySelector('#actionInReplaceExisting').checked
      let fork = event.target.parentNode.querySelector('#fork').checked
      let transferInnerHtml = event.target.parentNode.querySelector('#transfer-inner-html').checked

      if (fork) {
        let newC = await getLastReusableId()
        fork = getNextCounter(newC)
        await updateCounter(fork)
      }
      // Get the parent fieldset
      var fieldset = checkbox.closest('fieldset');

      // Get the "Duplicate with Parent" checkbox
      var duplicateCheckbox = fieldset.querySelector('#code-tree-menu-dublicate-with-parent-option');

      // Check if the "Duplicate with Parent" checkbox is checked
      var isDuplicateWithParent = duplicateCheckbox.checked;
      var copyInsertingCheckbox = fieldset.querySelector('#code-tree-menu-copies-too');
      var isCopiesOfInserting = copyInsertingCheckbox.checked;
      // Get the id and action attributes
      var fieldsetId = fieldset.id;
      var fieldsetAction = fieldset.getAttribute('action');

      // Get all fieldsets with data-element="code-tree-tag"
      var codeTreeTagFieldsets = querySelectorAll1('fieldset[data-element="code-tree-tag"]');

      // Iterate through each fieldset and hide them
      codeTreeTagFieldsets.forEach(function (fieldset) {
        var checkbox = fieldset.querySelector('input[type="checkbox"]');
        if (checkbox) {
          checkbox.setAttribute('hidden', 'true');
        }
      });

      // Remove the parent fieldset
      fieldset.remove();

      // Log the id and action attributes (you can replace this with your desired logic)
      log1("Fieldset ID:", fieldsetId);
      log1("Fieldset Action:", fieldsetAction);
      const splited = fieldsetId.split(';')
      splited.shift()
      const id = splited.join(';')
      const positionChecked = fieldset.querySelector('#position-checkbox').checked
      let position
      if (positionChecked) {
        const positionV = fieldset.querySelector('#position-number').value
        const start = fieldset.querySelector('#position-start-checkbox').checked
        position = start ? 'start-' + positionV : 'end-' + positionV

      }
      let target_element = [{ type: 'tag', id, }, ...selected.map(id => {
        return { type: 'tag', id }
      })]
      if (actionInReplace) {
        target_element = target_element.map(el => {
          const rId = getElementById1(el.id.replace('-tree', '')).getAttribute('data-replaceID')
          if (el.id.split(':')[1] && (el.id.split(':')[1].replace('-tree', '') === rId)) {
            el.replaced = true
            el.id = el.id.split(':')[0] + '-tree'

          }
          return el
        })
      }
      if (isDuplicateWithParent) {
        pushAction({
          time: (new Date()).getTime(),
          action: fieldsetAction,
          options: { dub_target: true, insert_copies: true, position, actionInReplace, fork, transferInnerHtml },
          target_element
        })


      }
      else if (isCopiesOfInserting) {
        pushAction({
          time: (new Date()).getTime(),
          action: fieldsetAction,
          options: { insert_copies: true, position, actionInReplace, fork, transferInnerHtml },
          target_element
        })
      }
      else {
        let el2 = {
          time: (new Date()).getTime(),
          action: fieldsetAction,
          options: { position, actionInReplace, fork, transferInnerHtml },
          target_element
        }
        pushAction(el2)
      }
      selected = []
      event.target.parentNode.remove()
    }

  </script>

  <script>const tags =
      [
        {
          "tagName": "head",
          "tagValue": "<head></head>",
          "TagComment": "Contains metadata/information for the document",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "title",
          "tagValue": "<title></title>",
          "TagComment": "Defines a title for the document",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "body",
          "tagValue": "<body></body>",
          "TagComment": "Defines the document's body",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "h1",
          "tagValue": "<h1></h1>",
          "TagComment": "Defines HTML headings",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "h2",
          "tagValue": "<h2></h2>",
          "TagComment": "Defines HTML headings",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "h3",
          "tagValue": "<h3></h3>",
          "TagComment": "Defines HTML headings",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "h4",
          "tagValue": "<h4></h4>",
          "TagComment": "Defines HTML headings",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "h5",
          "tagValue": "<h5></h5>",
          "TagComment": "Defines HTML headings",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "h6",
          "tagValue": "<h6></h6>",
          "TagComment": "Defines HTML headings",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "p",
          "tagValue": "<p></p>",
          "TagComment": "Defines a paragraph",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "br",
          "tagValue": "<br>",
          "TagComment": "Inserts a single line break",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "hr",
          "tagValue": "<hr>",
          "TagComment": "Defines a thematic change in the content",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "!--...--",
          "tagValue": "<!--...-->",
          "TagComment": "Defines a comment",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "abbr",
          "tagValue": "<abbr></abbr>",
          "TagComment": "Defines an abbreviation or an acronym",
          "TagType": "Formatting"
        },
        {
          "tagName": "address",
          "tagValue": "<address></address>",
          "TagComment": "Defines contact information for the author/owner of a document/article",
          "TagType": "Formatting"
        },
        {
          "tagName": "b",
          "tagValue": "<b></b>",
          "TagComment": "Defines bold text",
          "TagType": "Formatting"
        },
        {
          "tagName": "bdi",
          "tagValue": "<bdi></bdi>",
          "TagComment": "Isolates a part of text that might be formatted in a different direction from other text outside it",
          "TagType": "Formatting"
        },
        {
          "tagName": "bdo",
          "tagValue": "<bdo></bdo>",
          "TagComment": "Overrides the current text direction",
          "TagType": "Formatting"
        },
        {
          "tagName": "blockquote",
          "tagValue": "<blockquote></blockquote>",
          "TagComment": "Defines a section that is quoted from another source",
          "TagType": "Formatting"
        },
        {
          "tagName": "cite",
          "tagValue": "<cite></cite>",
          "TagComment": "Defines the title of a work",
          "TagType": "Formatting"
        },
        {
          "tagName": "code",
          "tagValue": "<code></code>",
          "TagComment": "Defines a piece of computer code",
          "TagType": "Formatting"
        },
        {
          "tagName": "del",
          "tagValue": "<del></del>",
          "TagComment": "Defines text that has been deleted from a document",
          "TagType": "Formatting"
        },
        {
          "tagName": "dfn",
          "tagValue": "<dfn></dfn>",
          "TagComment": "Specifies a term that is going to be defined within the content",
          "TagType": "Formatting"
        },
        {
          "tagName": "em",
          "tagValue": "<em></em>",
          "TagComment": "Defines emphasized text",
          "TagType": "Formatting"
        },
        {
          "tagName": "i",
          "tagValue": "<i></i>",
          "TagComment": "Defines a part of text in an alternate voice or mood",
          "TagType": "Formatting"
        },
        {
          "tagName": "ins",
          "tagValue": "<ins></ins>",
          "TagComment": "Defines a text that has been inserted into a document",
          "TagType": "Formatting"
        },
        {
          "tagName": "kbd",
          "tagValue": "<kbd></kbd>",
          "TagComment": "Defines keyboard input",
          "TagType": "Formatting"
        },
        {
          "tagName": "mark",
          "tagValue": "<mark></mark>",
          "TagComment": "Defines marked/highlighted text",
          "TagType": "Formatting"
        },
        {
          "tagName": "meter",
          "tagValue": "<meter></meter>",
          "TagComment": "Defines a scalar measurement within a known range (a gauge)",
          "TagType": "Formatting"
        },
        {
          "tagName": "pre",
          "tagValue": "<pre></pre>",
          "TagComment": "Defines preformatted text",
          "TagType": "Formatting"
        },
        {
          "tagName": "progress",
          "tagValue": "<progress></progress>",
          "TagComment": "Represents the progress of a task",
          "TagType": "Formatting"
        },
        {
          "tagName": "q",
          "tagValue": "<q></q>",
          "TagComment": "Defines a short quotation",
          "TagType": "Formatting"
        },
        {
          "tagName": "rp",
          "tagValue": "<rp></rp>",
          "TagComment": "Defines what to show in browsers that do not support ruby annotations",
          "TagType": "Formatting"
        },
        {
          "tagName": "rt",
          "tagValue": "<rt></rt>",
          "TagComment": "Defines an explanation/pronunciation of characters (for East Asian typography)",
          "TagType": "Formatting"
        },
        {
          "tagName": "ruby",
          "tagValue": "<ruby></ruby>",
          "TagComment": "Defines a ruby annotation (for East Asian typography)",
          "TagType": "Formatting"
        },
        {
          "tagName": "s",
          "tagValue": "<s></s>",
          "TagComment": "Defines text that is no longer correct",
          "TagType": "Formatting"
        },
        {
          "tagName": "samp",
          "tagValue": "<samp></samp>",
          "TagComment": "Defines sample output from a computer program",
          "TagType": "Formatting"
        },
        {
          "tagName": "small",
          "tagValue": "<small></small>",
          "TagComment": "Defines smaller text",
          "TagType": "Formatting"
        },
        {
          "tagName": "strong",
          "tagValue": "<strong></strong>",
          "TagComment": "Defines important text",
          "TagType": "Formatting"
        },
        {
          "tagName": "sub",
          "tagValue": "<sub></sub>",
          "TagComment": "Defines subscripted text",
          "TagType": "Formatting"
        },
        {
          "tagName": "sup",
          "tagValue": "<sup></sup>",
          "TagComment": "Defines superscripted text",
          "TagType": "Formatting"
        },
        {
          "tagName": "template",
          "tagValue": "<template></template>",
          "TagComment": "Defines a container for content that should be hidden when the page loads",
          "TagType": "Formatting"
        },
        {
          "tagName": "time",
          "tagValue": "<time></time>",
          "TagComment": "Defines a specific time (or datetime)",
          "TagType": "Formatting"
        },
        {
          "tagName": "u",
          "tagValue": "<u></u>",
          "TagComment": "Defines some text that is unarticulated and styled differently from normal text",
          "TagType": "Formatting"
        },
        {
          "tagName": "var",
          "tagValue": "<var></var>",
          "TagComment": "Defines a variable",
          "TagType": "Formatting"
        },
        {
          "tagName": "wbr",
          "tagValue": "<wbr>",
          "TagComment": "Defines a possible line-break",
          "TagType": "Formatting"
        },
        {
          "tagName": "form",
          "tagValue": "<form></form>",
          "TagComment": "Defines an HTML form for user input",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "input",
          "tagValue": "<input>",
          "TagComment": "Defines an input control",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "textarea",
          "tagValue": "<textarea></textarea>",
          "TagComment": "Defines a multiline input control (text area)",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "button",
          "tagValue": "<button></button>",
          "TagComment": "Defines a clickable button",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "select",
          "tagValue": "<select></select>",
          "TagComment": "Defines a drop-down list",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "optgroup",
          "tagValue": "<optgroup></optgroup>",
          "TagComment": "Defines a group of related options in a drop-down list",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "option",
          "tagValue": "<option></option>",
          "TagComment": "Defines an option in a drop-down list",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "label",
          "tagValue": "<label></label>",
          "TagComment": "Defines a label for an <input> element",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "fieldset",
          "tagValue": "<fieldset></fieldset>",
          "TagComment": "Groups related elements in a form",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "legend",
          "tagValue": "<legend></legend>",
          "TagComment": "Defines a caption for a <fieldset> element",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "datalist",
          "tagValue": "<datalist></datalist>",
          "TagComment": "Specifies a list of pre-defined options for input controls",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "output",
          "tagValue": "<output></output>",
          "TagComment": "Defines the result of a calculation",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "iframe",
          "tagValue": "<iframe></iframe>",
          "TagComment": "Defines an inline frame",
          "TagType": "Frames"
        },
        {
          "tagName": "img",
          "tagValue": "<img>",
          "TagComment": "Defines an image",
          "TagType": "Images"
        },
        {
          "tagName": "map",
          "tagValue": "<map></map>",
          "TagComment": "Defines a client-side image map",
          "TagType": "Images"
        },
        {
          "tagName": "area",
          "tagValue": "<area>",
          "TagComment": "Defines an area inside an image map",
          "TagType": "Images"
        },
        {
          "tagName": "canvas",
          "tagValue": "<canvas></canvas>",
          "TagComment": "Used to draw graphics, on the fly, via scripting (usually JavaScript)",
          "TagType": "Images"
        },
        {
          "tagName": "figcaption",
          "tagValue": "<figcaption></figcaption>",
          "TagComment": "Defines a caption for a <figure> element",
          "TagType": "Images"
        },
        {
          "tagName": "figure",
          "tagValue": "<figure></figure>",
          "TagComment": "Specifies self-contained content",
          "TagType": "Images"
        },
        {
          "tagName": "picture",
          "tagValue": "<picture></picture>",
          "TagComment": "Defines a container for multiple image resources",
          "TagType": "Images"
        },
        {
          "tagName": "audio",
          "tagValue": "<audio></audio>",
          "TagComment": "Defines sound content",
          "TagType": "Audio / Video"
        },
        {
          "tagName": "source",
          "tagValue": "<source>",
          "TagComment": "Defines multiple media resources for media elements (<video>, <audio> and <picture>)",
          "TagType": "Audio / Video"
        },
        {
          "tagName": "track",
          "tagValue": "<track>",
          "TagComment": "Defines text tracks for media elements (<video> and <audio>)",
          "TagType": "Audio / Video"
        },
        {
          "tagName": "video",
          "tagValue": "<video></video>",
          "TagComment": "Defines a video or movie",
          "TagType": "Audio / Video"
        },
        {
          "tagName": "a",
          "tagValue": "<a></a>",
          "TagComment": "Defines a hyperlink",
          "TagType": "Links"
        },
        {
          "tagName": "link",
          "tagValue": "<link>",
          "TagComment": "Defines the relationship between a document and an external resource (most used to link to style sheets)",
          "TagType": "Links"
        },
        {
          "tagName": "nav",
          "tagValue": "<nav></nav>",
          "TagComment": "Defines navigation links",
          "TagType": "Links"
        },
        {
          "tagName": "menu",
          "tagValue": "<menu></menu>",
          "TagComment": "Defines an alternative unordered list",
          "TagType": "Lists"
        },
        {
          "tagName": "ul",
          "tagValue": "<ul></ul>",
          "TagComment": "Defines an unordered list",
          "TagType": "Lists"
        },
        {
          "tagName": "ol",
          "tagValue": "<ol></ol>",
          "TagComment": "Defines an ordered list",
          "TagType": "Lists"
        },
        {
          "tagName": "li",
          "tagValue": "<li></li>",
          "TagComment": "Defines a list item",
          "TagType": "Lists"
        },
        {
          "tagName": "dl",
          "tagValue": "<dl></dl>",
          "TagComment": "Defines a description list",
          "TagType": "Lists"
        },
        {
          "tagName": "dt",
          "tagValue": "<dt></dt>",
          "TagComment": "Defines a term/name in a description list",
          "TagType": "Lists"
        },
        {
          "tagName": "dd",
          "tagValue": "<dd></dd>",
          "TagComment": "Defines a description of a term/name in a description list",
          "TagType": "Lists"
        },
        {
          "tagName": "table",
          "tagValue": "<table></table>",
          "TagComment": "Defines a table",
          "TagType": "Tables"
        },
        {
          "tagName": "caption",
          "tagValue": "<caption></caption>",
          "TagComment": "Defines a table caption",
          "TagType": "Tables"
        },
        {
          "tagName": "th",
          "tagValue": "<th></th>",
          "TagComment": "Defines a header cell in a table",
          "TagType": "Tables"
        },
        {
          "tagName": "tr",
          "tagValue": "<tr></tr>",
          "TagComment": "Defines a row in a table",
          "TagType": "Tables"
        },
        {
          "tagName": "td",
          "tagValue": "<td></td>",
          "TagComment": "Defines a cell in a table",
          "TagType": "Tables"
        },
        {
          "tagName": "thead",
          "tagValue": "<thead></thead>",
          "TagComment": "Groups the header content in a table",
          "TagType": "Tables"
        },
        {
          "tagName": "tbody",
          "tagValue": "<tbody></tbody>",
          "TagComment": "Groups the body content in a table",
          "TagType": "Tables"
        },
        {
          "tagName": "tfoot",
          "tagValue": "<tfoot></tfoot>",
          "TagComment": "Groups the footer content in a table",
          "TagType": "Tables"
        },
        {
          "tagName": "col",
          "tagValue": "<col>",
          "TagComment": "Specifies column properties for each column within a <colgroup> element",
          "TagType": "Tables"
        },
        {
          "tagName": "colgroup",
          "tagValue": "<colgroup></colgroup>",
          "TagComment": "Specifies a group of one or more columns in a table for formatting",
          "TagType": "Tables"
        },
        {
          "tagName": "style",
          "tagValue": "<style></style>",
          "TagComment": "üé®Defines style information for a documentüé®",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "div",
          "tagValue": "<div></div>",
          "TagComment": "Defines a section in a document",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "span",
          "tagValue": "<span></span>",
          "TagComment": "Defines a section in a document",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "header",
          "tagValue": "<header></header>",
          "TagComment": "Defines a header for a document or section",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "hgroup",
          "tagValue": "<hgroup></hgroup>",
          "TagComment": "Defines a header and related content",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "footer",
          "tagValue": "<footer></footer>",
          "TagComment": "Defines a footer for a document or section",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "main",
          "tagValue": "<main></main>",
          "TagComment": "Specifies the main content of a document",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "section",
          "tagValue": "<section></section>",
          "TagComment": "Defines a section in a document",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "search",
          "tagValue": "<search></search>",
          "TagComment": "Defines a search section",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "article",
          "tagValue": "<article></article>",
          "TagComment": "Defines an article",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "aside",
          "tagValue": "<aside></aside>",
          "TagComment": "Defines content aside from the page content",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "details",
          "tagValue": "<details></details>",
          "TagComment": "Defines additional details that the user can view or hide",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "dialog",
          "tagValue": "<dialog></dialog>",
          "TagComment": "Defines a dialog box or window",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "summary",
          "tagValue": "<summary></summary>",
          "TagComment": "Defines a visible heading for a <details> element",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "data",
          "tagValue": "<data></data>",
          "TagComment": "Adds a machine-readable translation of a given content",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "meta",
          "tagValue": "<meta>",
          "TagComment": "Defines metadata about an HTML document",
          "TagType": "Meta Info"
        },
        {
          "tagName": "base",
          "tagValue": "<base>",
          "TagComment": "Specifies the base URL/target for all relative URLs in a document",
          "TagType": "Meta Info"
        },
        {
          "tagName": "script",
          "tagValue": "<scrip></scrip>",
          "TagComment": "üíªDefines a client-side scriptüíª",
          "TagType": "Programming"
        },
        {
          "tagName": "noscript",
          "tagValue": "<noscript></noscript>",
          "TagComment": "Defines an alternate content for users that do not support client-side scripts",
          "TagType": "Programming"
        },
        {
          "tagName": "embed",
          "tagValue": "<embed></embed>",
          "TagComment": "Defines a container for an external (non-HTML) application",
          "TagType": "Programming"
        },
        {
          "tagName": "object",
          "tagValue": "<object></object>",
          "TagComment": "Defines an embedded object",
          "TagType": "Programming"
        },
        {
          "tagName": "param",
          "tagValue": "<param>",
          "TagComment": "Defines a parameter for an object",
          "TagType": "Programming"
        },
        {
          "tagName": "svg",
          "tagValue": "<svg></svg>",
          "TagComment": "Defines a container for SVG graphics",
          "TagType": "Images"
        },
        {
          "tagName": "path",
          "tagValue": "<path>",
          "TagComment": "svg",
          "TagType": "svg"
        },
        {
          "tagName": "text",
          "tagValue": "<text></text>",
          "TagComment": "svg",
          "TagType": "svg"
        }
      ];


    function buildTable() {
      const tableBody = getElementById1('tagsTable').getElementsByTagName('tbody')[0];

      tags.forEach((tag, index) => {
        let row = tableBody.insertRow();
        row.onclick = function (event) { chooseTag(index, event); };

        let tagNameCell = row.insertCell(0);
        let tagValueCell = row.insertCell(1);
        let tagTypeCell = row.insertCell(2);
        let tagCommentCell = row.insertCell(3);

        tagNameCell.textContent = tag.tagName;
        tagValueCell.textContent = tag.tagValue;
        tagTypeCell.textContent = tag.TagType;
        tagCommentCell.textContent = tag.TagComment;
      });
    }
    function filterTable(column) {
      let input, filter, table, tr, td, i, txtValue;
      input = getElementById1("tagsTable").getElementsByTagName("thead")[0].getElementsByTagName("input")[column];
      filter = input.value.toUpperCase();
      table = getElementById1("tagsTable");
      tr = table.getElementsByTagName("tr");

      for (i = 2; i < tr.length; i++) {
        td = tr[i].getElementsByTagName("td")[column];
        if (td) {
          txtValue = td.textContent || td.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
          } else {
            tr[i].style.display = "none";
          }
        }
      }
    }
    function chooseTag(index, event) {
      log1('in')
      log1(event)
      let chosenTag = tags[index];
      //alert("Chosen Tag Name: " + chosenTag.tagName + "\nChosen Tag Value: " + chosenTag.tagValue);

      // Get the fieldset attributes
      const fieldset = event.currentTarget.closest('fieldset');
      if (fieldset) {
        const fieldsetId = fieldset.id;
        const fieldsetAction = fieldset.getAttribute('action');
        const apply_to_copies = fieldset.getAttribute('copiesOfInserting');
        log1("Fieldset ID:", fieldsetId);
        log1("Fieldset Action:", fieldsetAction);
        const splited = fieldsetId.split(';')
        splited.shift()
        splited.join(';')
        const el =
        {
          time: (new Date()).getTime(),
          action: fieldsetAction,
          target_element: splited.join(';'),

        }
        const applyToCopies2 = fieldset.querySelector('#applyForCopies2').checked
        if (applyToCopies2) {
          el.options = { apply_to_copies: true }
          el.target_element = el.target_element.split(':')[0].replace('-tree', '') + '-tree'
        }
        const actionInReplace2 = fieldset.querySelector('#actionInReplace2').checked
        if (actionInReplace2) {
          el.options ? (el.options.actionInReplace = true) : (el.options = { actionInReplace: true })
          if (el.target_element.split(':')[1] && (el.target_element.split(':')[1] === getElementById1(el.target_element.replace('-tree', '')).getAttribute('data-replaceID'))) {
            el.target_element = el.target_element.split(':')[0] + "-tree"
          }

        }
        const positionChecked = fieldset.querySelector('#position-checkbox').checked
        if (positionChecked) {
          const positionV = fieldset.querySelector('#position-number').value
          const start = fieldset.querySelector('#position-start-checkbox').checked
          const position = start ? 'start-' + positionV : 'end-' + positionV
          el.options ? (el.options.position = position) : (el.options = { position })
        }
        if (fieldsetAction === 'ChangeTag') {
          el.tag_change = chosenTag.tagName
        }

        else {
          el.inserted_element = { type: 'tag', tagValue: chosenTag.tagValue, tagName: chosenTag.tagName, id: generateUUID() }
        }
        pushAction(el)
        fieldset.remove()
      }
    }

    window.onload = buildTable;    
  </script>

  <style>
    .highlight-left-border-red {
      border-left-color: blue;
      transition: 0.1s ease;

    }

    .highlight-red {
      border-color: blue;
      transition: 0.1s ease;
      background-color: rgb(88, 105, 255)
    }


    .highlight-left-border-blue {
      border-left-color: red;


    }

    .highlight-blue {
      border-color: red;
      transition: 0.1s ease;
      background-color: rgb(255, 88, 88)
    }
  </style>
  <script>
    function mouseOverTree(e) {
      // Highlight this button in red
      e.target.classList.add('highlight-red');

      let parentFieldset = e.target.closest('[data-element="code-tree-tag"]');

      // Highlight the left border of the parent fieldset in red
      if (parentFieldset) {
        parentFieldset.classList.add('highlight-left-border-red');
      }

      // Highlight the left border of sibling fieldsets and their direct child buttons in red
      Array.from(parentFieldset.parentElement.children).forEach(sibling => {
        if (sibling !== parentFieldset && sibling.getAttribute('data-element') === 'code-tree-tag') {
          sibling.classList.add('highlight-left-border-red');
          Array.from(sibling.children).forEach(child => {
            if (child.tagName === 'BUTTON' && child.getAttribute('data-element') === 'code-tree-show-hide-button') {
              child.classList.add('highlight-red');
            }
          });
        }
      });

      // Highlight the left border and buttons of direct child fieldsets of parentFieldset in blue
      Array.from(parentFieldset.children).forEach(child => {
        if (child.tagName === 'FIELDSET' && child.getAttribute('data-element') === 'code-tree-tag') {
          child.classList.add('highlight-left-border-blue');
          Array.from(child.children).forEach(grandchild => {
            if (grandchild.tagName === 'BUTTON' && grandchild.getAttribute('data-element') === 'code-tree-show-hide-button') {
              grandchild.classList.add('highlight-blue');
            }
          });
        }
      });
    }
    function mouseOutTree(e) {
      let parentFieldset = e.target.closest('[data-element="code-tree-tag"]');

      // Remove the red and blue highlights
      e.target.classList.remove('highlight-red');
      if (parentFieldset) {
        parentFieldset.classList.remove('highlight-left-border-red');
      }
      Array.from(parentFieldset.parentElement.children).forEach(sibling => {
        if (sibling !== parentFieldset && sibling.getAttribute('data-element') === 'code-tree-tag') {
          sibling.classList.remove('highlight-left-border-red');
          Array.from(sibling.children).forEach(child => {
            if (child.tagName === 'BUTTON' && child.getAttribute('data-element') === 'code-tree-show-hide-button') {
              child.classList.remove('highlight-red');
            }
          });
        }
      });
      Array.from(parentFieldset.children).forEach(child => {
        if (child.tagName === 'FIELDSET' && child.getAttribute('data-element') === 'code-tree-tag') {
          child.classList.remove('highlight-left-border-blue');
          Array.from(child.children).forEach(grandchild => {
            if (grandchild.tagName === 'BUTTON' && grandchild.getAttribute('data-element') === 'code-tree-show-hide-button') {
              grandchild.classList.remove('highlight-blue');
            }
          });
        }
      });
    }
    querySelectorAll1('button[data-element="code-tree-show-hide-button"]').forEach(button => {
      button.addEventListener('mouseover', mouseOverTree);

      button.addEventListener('mouseout', mouseOutTree);
    });
  </script>
  <!-- dublicate for components-->
  <script>
    function mouseOver(e) {
      // Highlight this button in red
      e.target.classList.add('highlight-red');

      let parentFieldset = e.target.closest('[data-element="component-tree-tag"]');

      // Highlight the left border of the parent fieldset in red
      if (parentFieldset) {
        parentFieldset.classList.add('highlight-left-border-red');
      }

      // Highlight the left border of sibling fieldsets and their direct child buttons in red
      Array.from(parentFieldset.parentElement.children).forEach(sibling => {
        if (sibling !== parentFieldset && sibling.getAttribute('data-element') === 'component-tree-tag') {
          sibling.classList.add('highlight-left-border-red');
          Array.from(sibling.children).forEach(child => {
            if (child.tagName === 'BUTTON' && child.getAttribute('data-element') === 'component-tree-show-hide-button') {
              child.classList.add('highlight-red');
            }
          });
        }
      });

      // Highlight the left border and buttons of direct child fieldsets of parentFieldset in blue
      Array.from(parentFieldset.children).forEach(child => {
        if (child.tagName === 'FIELDSET' && child.getAttribute('data-element') === 'component-tree-tag') {
          child.classList.add('highlight-left-border-blue');
          Array.from(child.children).forEach(grandchild => {
            if (grandchild.tagName === 'BUTTON' && grandchild.getAttribute('data-element') === 'component-tree-show-hide-button') {
              grandchild.classList.add('highlight-blue');
            }
          });
        }
      });
    }
    function mouseOut(e) {
      let parentFieldset = e.target.closest('[data-element="component-tree-tag"]');

      // Remove the red and blue highlights
      e.target.classList.remove('highlight-red');
      if (parentFieldset) {
        parentFieldset.classList.remove('highlight-left-border-red');
      }
      Array.from(parentFieldset.parentElement.children).forEach(sibling => {
        if (sibling !== parentFieldset && sibling.getAttribute('data-element') === 'component-tree-tag') {
          sibling.classList.remove('highlight-left-border-red');
          Array.from(sibling.children).forEach(child => {
            if (child.tagName === 'BUTTON' && child.getAttribute('data-element') === 'component-tree-show-hide-button') {
              child.classList.remove('highlight-red');
            }
          });
        }
      });
      Array.from(parentFieldset.children).forEach(child => {
        if (child.tagName === 'FIELDSET' && child.getAttribute('data-element') === 'component-tree-tag') {
          child.classList.remove('highlight-left-border-blue');
          Array.from(child.children).forEach(grandchild => {
            if (grandchild.tagName === 'BUTTON' && grandchild.getAttribute('data-element') === 'component-tree-show-hide-button') {
              grandchild.classList.remove('highlight-blue');
            }
          });
        }
      });

    }
    querySelectorAll1('button[data-element="component-tree-show-hide-button"]').forEach(button => {
      button.addEventListener('mouseover', mouseOver);

      button.addEventListener('mouseout', mouseOut);

    });

  </script>

  <script src="js/left-panel.js" async=""></script>


</body>

</html>