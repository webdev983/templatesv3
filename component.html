<!DOCTYPE html>
<html lang="en-US">

<head>
  <link rel="stylesheet" href="css/right-click-menu.css" media="all">
  <link rel="stylesheet" href="css/buttons-and-menus.css" media="all">
  <link rel="stylesheet" href="css/panels.css" media="all">

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var userType = localStorage.getItem('usertype');
      var visualOn = localStorage.getItem('visualOn');

      if (userType === null) {
        getElementById1('generated-page').removeAttribute('hidden')
      };


      if (userType === null && visualOn === null) {
        localStorage.setItem('visualOn', 'true');
        location.reload();
      };


      if (userType !== null) {
        if (userType.trim() === 'su777') {
          // Select all elements with the 'data-user' attribute
          var dataUserElements = document.querySelectorAll('[data-user]');
          dataUserElements.forEach(function (el) {
            // Remove the 'hidden' attribute
            el.removeAttribute('hidden');
          });
        } else if (userType.trim() === 'style') {
          // Select all elements with the 'data-style' attribute
          var dataStyleElements = document.querySelectorAll('[data-style]');
          dataStyleElements.forEach(function (el) {
            // Remove the 'hidden' attribute
            el.removeAttribute('hidden');
          });
        }
      }
    });
  </script>

</head>

<body class="body">
  <aside class="aside" data-user data-style hidden>
    <div class="panel top">
      <button disabled class="b-1" id="last-action-time"
        style="color: black;z-index:1; position: absolute;top: 50%;left: 50%; transform: translate(-50%, -50%);">⏳</button>
    </div>

    <div class="panel left">
      <div hidden id="nav-buttons" data-user hidden>
        <a href="https://webdev983.github.io/templatesv3/"><button class="b-1">📂</button></a>
      </div>
      <div style="margin-top: 30px;">
        <button class="b-1 " id="toggle-component-tree" onclick="toggleComponentTree()" data-user hidden>🧩</button>
        <button class="b-1 " id="toggle-code-tree" onclick="toggleCodeTree()">🏷️</button>
        <button class="b-1 " id="toggle-head" onclick="toggleHead()" data-user hidden>🗿</button>
        <button class="b-1 " id="toggle-generated-page" onclick="toggleGeneratedPage()">👁️</button>
      </div>
      <div id="logs-menu">
        <button class="b-1 b-select" id="log-open">🪵</button>
      </div>
      <table id="code-log" class="table-1" hidden style="margin-bottom: 100px;">
        <button hidden id="refresh-page" class="b-1" onclick="reloadPage(event)">🔄</button>
        <thead>
          <tr>
            <th style="text-align: left;">🕓time</th>
            <th style="text-align: left;">✔️action</th>
          </tr>
        </thead>
        <tbody id="code-log-body">
          <!--NUMBERS!! 1️⃣ 2️⃣ 3️⃣ 4️⃣-->
          <tr hidden id="code-log-element">
            <td data-type-code-log="action-time"><span id="code-log-action-time">1703707728031</span></td>
            <td data-type-code-log="action-name"><span id="code-log-action" class="tooltip"
                data-tooltip="✅⧉ Apply to copies  &#10; 🚂⧉ Insert Copies  &#10;  🎯⧉ Dup Target">append child</span>
            </td>
            <td><button data-type-code-log="action-remove" onclick="deleteAction(event)" class="b-5">&#128465;</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="panel bottom" style="position: fixed; bottom: 0; left: 0;">
      <button class="b-1" onclick="removeTokenAndReload()">📴</button>
      <script>function removeTokenAndReload() {
          // Удаляем 'token' из localStorage
          localStorage.removeItem('token');
          localStorage.removeItem('ownerid');
          localStorage.removeItem('helperid');

          // Перезагружаем страницу
          window.location.href = '/templatesv3/';
        }
      </script>
    </div>

  </aside>
  <main class="main" style="position: relative;">

    <div class="panel horizontal-menu" data-user data-style hidden>
      <button id="path_select" onclick="loadRoot()" class='b-1'
        style="user-select: none; margin-right: 7px;">👣</button>

      <label id="page-path" onclick="labelClick(event)" class="l-2 b-dark-blue"
        style="cursor: pointer;  font:700;">~</label>

      <a href="" target="_blank" style="text-decoration: none; color: #000000;" hidden id="published-label"
        class="l-3">🌐</a>
      <a href="" target="_blank" style="text-decoration: none; color: #000000;" hidden id="published-site-label"
        class="l-3">🌎</a>

    </div>






    <div id="web-page-menu" hidden class="panel-2 horizontal-menu" data-user data-style>
      <button id="path-icon" class='b-1' onclick="publish(event)"
        style="user-select: none; margin-right: 7px;">📰</button>
      <button hidden class="b-1" id="published-invalidate" onclick="invalidate(event)"
        style="margin-right: 5px;">🔄</button>
      <button onclick="removeAndInvalidate(event)" hidden id="published-remove" class="b-1"
        style="margin-right: 5px;">🗑️️</button>
    </div>

    </div>

    <div id="components-tree-menu" class="panel horizontal-menu" data-user hidden>
      <label class="l-1" style="margin-right: 10px; user-select: none;">🧩</label>
      <button class="b-1" style="margin-right: 5px;" onclick="addComponent(event)">➕</button>
    </div>

    <div id="components-tree" data-user hidden class="horizontal-area" style="position: relative;">
    </div>

    <div id="code-tree-menu" class="panel horizontal-menu" data-user data-style hidden>
      <label class="l-1" style="margin-right: 10px; user-select: none;">🏷️</label>
      <button data-user hidden class="b-1" onclick="addTreeElement(event)">➕</button>
    </div>
    <div id="code-tree" class="horizontal-area" style="position: relative;" data-user data-style hidden>
      <fieldset id="head-tree" data-element="code-tree-tag" class="tree-element">
        <legend class="l-p b-dark-blue"></legend>
        <input id="selectedCheckbox" hidden="" type="checkbox" onchange="handleCheckboxChange(event)">
        <button class="b-3 arrow" data-element="code-tree-show-hide-button" onclick="toggleSubFields(event)">→</button>
        <button class="b-3 t" data-element="code-tree-tag-name-button"
          onclick="loader(event, handleTreeClick)">🏷️head</button>
        <button hidden class="b-3 t" data-element="code-tree-inner-html-button" onclick="openInnerHtmlContent(event)">
          ▶️</button>
        <button class="b-3 t" hidden data-element="code-tree-attributes-button"
          onclick="openAttributeContent(event)">🔑</button>
        <button class="b-3 t" hidden data-element="code-tree-text-content-button"
          onclick="openTextContent(event)">📄</button>
        <span data-element="comment" hidden class="l-3 t b-dark-blue">💬</span>
        <div data-open-menu></div>
      </fieldset>

      <fieldset id="body-tree" data-element="code-tree-tag" class="tree-element">
        <legend class="l-p b-dark-blue"></legend>
        <input id="selectedCheckbox" hidden="" type="checkbox" onchange="handleCheckboxChange(event)">
        <button class="b-3 arrow" data-element="code-tree-show-hide-button" onclick="toggleSubFields(event)">→</button>
        <button class="b-3 t" data-element="code-tree-tag-name-button"
          onclick="loader(event, handleTreeClick)">🏷️body</button>
        <button class="b-3 t " hidden data-element="code-tree-inner-html-button" onclick="openInnerHtmlContent(event)">
          ▶️</button>
        <button class="b-3 t" hidden data-element="code-tree-attributes-button"
          onclick="openAttributeContent(event)">🔑</button>
        <button class="b-3 t b-dark-blue" data-element="code-tree-text-content-button" hidden
          onclick="openTextContent(event)">📄</button>
        <span data-element="comment" hidden class="l-3 t b-dark-blue">💬</span>

        <div data-open-menu></div>
      </fieldset>


    </div>


    <div id="head-menu" class="panel horizontal-menu" data-user hidden>
      <label class="l-1" style="margin-right: 10px; user-select: none;">🗿</label>
      <button hidden class="b-1 b-selected" style="margin-right: 5px;">⭐</button>

    </div>
    <div id="head-1" class="horizontal-area" data-user hidden>


      <!--
  data-head="product-specification"
  data-head-element="product_name"
  data-head-element-status
  data-head-element-key
  data-head-element-value
  data-head-element-select-value
  data-head-element-benefit
  data-file-name-show="Product-Content"
  -->



      <details style="margin-bottom: 7px;" data-file-name-show="-Content">
        <summary class="summary-L-3"><span class="l-3 b-dark-blue">🤖 AI</span></summary>
        <table class="table-1" data-head="meta">
          <tr data-file-name-show="Product-Content">
            <td class="l-3"><label class="l-3" data-head-element-status>🔴</label><label class="l-3"
                style="margin: 10px;">Product Title&Description+Lead Paragraph</label></td>
            <td class="l-3"> <button class="b-3">🤖</button></td>
          </tr>
          <tr data-file-name-show="Product-Content">
            <td class="l-3"><label class="l-3" data-head-element-status>🔴</label><label class="l-3"
                style="margin: 10px;">Product Description</label></td>
            <td class="l-3"> <button class="b-3" data-ai-generate="product_description">🤖</button></td>
          </tr>
          <tr data-file-name-show="Article-Content">
            <td class="l-3"><label class="l-3" data-head-element-status>🔴</label><label class="l-3"
                style="margin: 10px;">Article Title&Description</label></td>
            <td class="l-3"> <button class="b-3">🤖</button></td>
          </tr>
          <tr data-file-name-show="Article-Content">
            <td class="l-3"><label class="l-3" data-head-element-status>🔴</label><label class="l-3"
                style="margin: 10px;">Article FAQ</label></td>
            <td class="l-3"> <button class="b-3">🤖</button></td>
          </tr>
        </table>
      </details>

      <pre hidden data-ai-task="product_description" data-ai-model="gpt-3.5">
      my webstore name is {site}.
      Generate me product description for {product_name}
      Make it Atleast 1000 words
      Put paragraphs to html tag  p and include html tag  h3 headings between paragraphs html tag.
      <!-- and after import to 
      data-import-product_description="h3"
       its the same  as--
       data-ai-generate="product_description
      -->
    </pre>



      <details style="margin-bottom: 7px;" data-file-name-show="-Content">
        <summary class="summary-L-3"><span class="l-3 b-dark-blue">📣 Meta</span></summary>

        <table class="table-1" data-head="meta">
          <tr data-head-element="title">
            <td class="l-3"><label class="l-3" style="margin-right: 5px;" data-head-element-status>🟢</label>
              <label class="l-3" data-head-element-key>title</label>
            </td>
            <td class="l-3" data-transfer-sender="title.text-content" data-head-element-value contenteditable>{title}
            </td>
          </tr>

          <tr data-head-element="description">
            <td class="l-3"><label class="l-3" style="margin-right: 5px;" data-head-element-status>🟢</label>
              <label class="l-3" data-head-element-key>description</label>
            </td>
            <td class="l-3" data-transfer-sender="meta-description.content" data-head-element-value contenteditable>
              {title}</td>
          </tr>
        </table>
      </details>



      <details style="margin-bottom: 7px;" data-file-name-show="Product-Content">
        <summary class="summary-L-3"><span class="l-2 b-dark-blue">📦 Product Spec</span></summary>
        <table class="table-1" data-head="product-specification">
          <tr data-head-element="product_name">
            <td class="l-3">
              <label class="l-3" style="margin-right: 5px;" data-head-element-status>🟢</label>
              <label class="l-3" data-head-element-key>Product name</label>
            </td>
            <td class="l-3" data-head-element-value contenteditable>{product name}</td>
            <td class="l-3">-</td>
            <td><label class="l-3"><input data-head-element-benefit type="checkbox">Benefit</label></td>
          </tr>
          <tr data-head-element="shipping">
            <td class="l-3">
              <label class="l-3" style="margin-right: 5px;" data-head-element-status>🔴</label>
              <label class="l-3" data-head-element-key>shipping</label>
            </td>
            <td class="l-3" data-head-element-value contenteditable>{shipping}</td>
            <td class="l-3" data-head-element-select-value>
              <select class="select-1">
                <option>⬇️ Select</option>
                <option>➡️ Instant online delivery</option>
                <option>➡️ Free shipping</option>
              </select>
            </td>
            <td><label class="l-3"><input data-head-element-benefit type="checkbox">Benefit</label></td>
          </tr>
        </table>
      </details>


      <details hidden id="breadCrumb-menu" style="margin-bottom: 7px;">
        <summary class="summary-L-3"><span class="l-3 b-dark-blue">🥖 BreadCrumb Menu</span></summary>
        <button class="b-3" onclick="generateBreadCrumb(event)"> Generate</button>
      </details>



      <details id="import-menu" hidden style="margin-bottom: 7px;">
        <summary class="summary-L-3"><span class="l-3 b-dark-blue">🚀 Import Menu</span></summary>
        <button style="margin-left: 10px;" class="b-4" id="import-name"><span>🔡 </span><span
            id="import-name-span">Article</span></button>

        <div id="import-data" hidden data-menu style="margin-bottom: 30px; ">
          <button onclick="cancel(event)" class="b-4" style="margin-bottom: 5px; margin-top: 10px;">❌</button>
          <br>
          <div hidden id="variation-amount-field"><span class="l-3">🧮 Variations: </span><span id="variation-amount"
              class="l-3">10</span></div>
          <div hidden id="variation-site-field"><span class="l-3">🌐 Site: </span><span id="variant-site"
              class="l-3">accbuddy.com</span></div>

          <span class="l-3"></span>
          <button data-save class="b-4">💾 Save</button>
          <button hidden id='previous-html' class="b-4"> Prev. ◀️</button>
          <button hidden id="next-html" class="b-4">▶️ Next</button>
          <button hidden id="remove-html" class="b-4">🗑️Remove</button>
          <button hidden id="update-html" class="b-4">🔄 Update</button>
          <div hidden id="approve-menu">
            <button class="b-4"> ✅ Approve</button>
            <button class="b-4"> ❌ Cancel</button>
          </div>
          <br>
          <textarea id="import-input" class="text1" style="width: 50vw" placeholder=" 🚀 Enter Import Text"></textarea>
          <br>
          <button data-save class="b-4">💾 Save</button>
        </div>
      </details>




      <details id="sku-menu" hidden style="margin-bottom: 7px;">
        <summary class="summary-L-3"><span class="l-3 b-dark-blue">📦 SKU Menu</span></summary>
        <input type="text" class="b-3" id="input-sku" placeholder="enter sku">
        <button class="b-3" id="create-sku" onclick="addSku(event)">▶️</button>
        <div id="sku-list" hidden>
        </div>

        <label id="checkbox-label" hidden data-type="dependant" class="l-3"><input type="checkbox">Color</label>
        <fieldset hidden id="dependee-menu-item" data-type="dependee">
          <legend>
            <label class="l-2">🎚️</label>
            <label data-type="dependee-value" class="l-2 b-dark-blue">Price</label>
          </legend>

          <div>
            <button class="b-3" id="generate-dependees" onclick="generateDependees(event)">Generate</button>
          </div>
        </fieldset>



        <div hidden id=sku-item-1>
          <label class="l-3 b-dark-blue">SKU:</label><label class="l-2" id="sku-value"></label>
          <button class="b-3" id="toggleSkuAttributeList" onclick='toggleSkuAttributeList(event)'>👀</button>
          <button class="b-3" id="toggleDependencyMenu1" onclick='toggleDependencyMenu1(event)'>🛠️</button>


          <button class="b-3" id="remove-sku" onclick="openRemoveSku(event)">🗑️️</button>

          <fieldset style="display: none;" id="remove-sku-menu" class="menu">
            <legend><button class="b-6" onclick="cancel(event)" style="font-size: 0.9em;">❌</button></legend>
            <label class="l-3">Are you sure want to remove this SKU?</label>
            <br>
            <button onclick="removeSku(event)" class="b-3">🗑️️ Remove</button>
          </fieldset>


          <ul class="list-1" hidden id="sku-attribute-list">
            <div id='sku-item'>
              <li id="sku-attribute">
                <span class="l-4">🔖</span><span class="l-4" id="sku-attribute-value">Solo</span>
                <span style="margin-left: 10px;" class="l-4">📦</span>
                <span class="l-4" id="sku-qty">10</span>
              </li>
            </div>
          </ul>

          <div id="dependee-menu" hidden>
            <fieldset data-type="dependee">
              <legend>
                <label class="l-2">🎚️</label>
                <label data-type="dependee-value" class="l-2 b-dark-blue">Price</label>
              </legend>
              <label data-type="dependant" class="l-3"><input type="checkbox">Color</label>
              <div>
                <button class="b-3" id="generate-dependees">Generate</button>
              </div>
            </fieldset>
          </div>
        </div>

      </details>
    </div>


    <div id="generated-page-menu" class="panel horizontal-menu" hidden data-user data-style>
      <label class="l-1" style="margin-right: 10px; user-select: none;">👁️</label>
      <button id='transform' class="b-1" onclick="transformToVisual(event)">✍️</button>
    </div>



    <!--
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
  IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME

  -->

    <iframe id="generated-page-iframe" src="./iframe.html"
      style="width:100%; height:20000px; border:none; margin-bottom: 200px;" allowfullscreen="true" allow="
      
      display-capture;
      geolocation; 
      microphone; 
      web-share" class="horizontal-area">
    </iframe>
    <!--
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
  IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
        IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
      IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME
    IFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAMEIFRAME

  -->

  </main>

  <!-- MENUS-->


  <div hidden>





    <div id="stock-menu" data-menu style="margin-bottom: 30px;">
      <button style="margin-right:5px; margin-top: 5px; margin-bottom: 5px;" class="b-3"
        onclick="cancel(event)">❌</button>
      <br>
      <label class="l-3"><input type="radio" id="digital-good" name="choose-goods-type" checked value="digital" />📟
        Digital</label>
      <label class="l-3"><input type="radio" name="choose-goods-type" id="real-good" value="real" />📦 Real</label>
      <div id="digital-menu" style="margin-top: 10px;">
        <button add-stock class="b-3">➕ Add</button>
        <button stock-qty class="b-3">🔢 Qty</button>
        <button view-stock class="b-3">🔎 View</button>
        <button stock-label class="b-3">🏷️ Label</button>
      </div>
      <div hidden id="real-goods-menu">
        <button stock-qty class="b-3"> 🔢 Qty</button>
      </div>
    </div>

    <div id="view-stock" data-menu style="margin-bottom: 30px; ">
      <button class="b-3" onclick="cancel(event)" style="margin-top: 10px; margin-bottom: 5px;">❌</button>

      <table class="table-2 table-row-number-2">
        <tbody id="stock-table-body">
          <tr id="stock-item" hidden stockItem>
            <td><span class="l-4" style="user-select: none;">🔑</span><span class="l-4" id="stock-item-value"></span>
            </td>
            <td><span class="l-4" style="user-select: none;">👨</span><span class="l-4" id="stock-item-status"><span>
            </td>
            </td>
          </tr>
        </tbody>
      </table>
    </div>


    <div id="stock-label" data-menu style="margin-bottom: 30px; ">
      <button onclick="cancel(event)" class="b-4" style="margin-bottom: 5px;">❌</button>
      <br>
      <button class="b-4" id="update-label">💾 Update</button>
      <input type="text" placeholder="🏷️ Stock label" class="input-1" style=" width: 50px;" id="stock-label-input">
    </div>


    <div id="stock-qty" data-menu style="margin-bottom: 30px; ">
      <button onclick="cancel(event)" class="b-4" style="margin-top:5px; margin-bottom: 5px;">❌</button>
      <br>
      <button id="update-qty" class="b-4">💾 Update</button>
      <input type="number" placeholder="⚖️ Qty" class="input-2" value="0" style=" width: 50px;">
    </div>


    <div id="add-stock-menu" data-menu style="margin-bottom: 30px; ">
      <br>
      <button class="b-3" onclick="cancel(event)" style="margin-bottom:7px; margin-right: 5px;">❌</button>
      <br>
      <button save-stock class="b-3" style="margin-bottom:7px; margin-right: 5px;">💾 Save</button>
      <br>
      <textarea id="add-stock-input" class="text1" placeholder=" 📦 insert digital goods 1 per line"></textarea>
      <br>
      <button save-stock class="b-3" style="margin-top:5px;">💾 save</button>
    </div>

    <fieldset class="menu" id="gallery-menu-wrapper" data-menu>
      <legend><button class="b-3" id="remove-galeryMenu">❌</button></legend>
      <div style="font-size: 30px; height: 100px;">
        <input type="file" id="image-input" accept="image/*" hidden />
        <label style="font-size: 50px;" for="image-input" id="select-file-button" class="file-upload-button b-1">➕ Add new</label>
        <button style="font-size: 50px; border-radius: 10px;" id="upload-button" class="upload-button"
          hidden>📤</button>
        <span id="file-name" hidden>No file chosen</span>
      </div>
      <table style=" border-collapse: collapse;">
        <tr hidden id="gallery-item" style="border-bottom: 2px dashed #3d3d3d;">
          <td style="padding-top: 5px;">
            <div class="gallery-image">

              <img style="width: 800px; height: auto;" src="https://via.placeholder.com/500/0000FF/FFFFFF?text=image">
              
            </div>
          </td>
          <td style="padding-top: 5px;">

            <div data-picture-meta>
              <br>
              <label class="l-3">Created: </label>
              <time data-picture-time class="l-3 b-dark-blue">24.02.23 15:39</time>
              <br>
              <div data-picture-attached>
              <label  class="l-3">Attached: </label><label class="l-3 b-dark-blue"> 📎Yes</label>
              <label class="attached">📎</label>
            </div>
              <div data-file-name-show="Product-Content">
              <label class="l-3">
                <input data-picture-main-checkbox type="checkbox">⭐ Main
              </label>
              <br>
              <label class="l-3">
                <input data-picture-secondary-checkbox type="checkbox">✨ Secondary
              </label>
            </div>
            <div>
              <button class="b-3" data-select-image>✅ Attach</button>
              <button hidden class="b-3" data-show-menu>🔍</button>
              <button class="b-3" data-remove-image>🗑️ Delete️</button>
            </div>

            </div>


          </td>
        </tr>
        <tbody id="gallery-body">




        </tbody>
      </table>
      <fieldset style="display: none;" id="menu-1" class="menu">
        <legend><button class="b-3" onclick="cancelGalleryMenu(event)">❌</button>
          <button class="b-3">⬅️</button>
        </legend>

        <img src="https://via.placeholder.com/1000/0000FF/FFFFFF?text=image">

      </fieldset>
    </fieldset>




    <div id="code-tree-comment-form" data-menu style="margin-bottom: 30px; ">
      <button onclick="cancel(event)" class="b-4" style="margin-top:5px; margin-bottom: 5px;">❌</button>
      <br>
      <label><input type="checkbox" id="applyToCopies"><span class="l-3" style="margin-bottom: 5px;">⧉ Apply to
          Copies</span></label>
      <br>

      <button class="b-4" onclick="removeComment(event)">🗑️️ Remove</button>
      <button class="b-4" onclick="saveComment(event)">💾 Save</button>
      <br>
      <input id="comment-content" type="text" placeholder="💬 Comment" class="input-1" style="margin-top: 7px;">
    </div>



    <fieldset id="update-href-menu" class="menu" data-menu>
      <button class="b-3" onclick="cancel(event)">❌Cancel</button>
      <input id="editHrefInput" style="width: 500px" placeholder="🔗 edit href" type="text">
      <button id="editHrefButton">💾</button>
    </fieldset>


    <fieldset id="component-element" data-element="code-tree-tag" class="tree-element tree-element-1">
      <legend></legend>
      <input hidden type="checkbox" onchange="handleCheckboxChange(event)">
      <button hidden class="b-3 arrow" data-element="code-tree-show-hide-button"
        onclick="toggleSubFields(event)"></button>
      <button class="b-3 t" data-element="code-tree-tag-name-button"
        onclick="loader(event, handleComponentClick)">🏷️component</button>
      <button hidden class="b-3 t" data-element="code-tree-attributes-button"
        onclick="openAttributeContent(event)">🔑</button>
      <button hidden class="b-3 t" data-element="optional-script" onclick="replaceComponent(event,true)">🔄10</button>
      <span hidden class="b-3 t" data-element="main-content">⭐ Article</span>
      <span data-open-menu></span>
    </fieldset>

    <fieldset id="tree-element" data-element="code-tree-tag" class="tree-element" style="margin-left: 50px;">
      <legend></legend>
      <input id="selectedCheckbox" hidden type="checkbox" onchange="handleCheckboxChange(event)">
      <button class="b-3 arrow" data-element="code-tree-show-hide-button"
        onclick="toggleSubFields(event)">&#8594;</button>
      <button class="b-3 t" data-element="code-tree-tag-name-button"
        onclick="loader(event, handleTreeClick)">🏷️component</button>
      <button class="b-3 t" data-element="code-tree-inner-html-button" hidden onclick="openInnerHtmlContent(event)">
        ▶️</button>
      <button class="b-3 t" data-element="code-tree-attributes-button" hidden
        onclick="openAttributeContent(event)">🔑</button>
      <button class="b-3 t" data-element="code-tree-text-content-button" hidden
        onclick="openTextContent(event)">📄</button>
      <span data-element="comment" hidden class="l-3 t b-dark-blue">💬</span>
      <span data-open-menu></button>
    </fieldset>






    <!--menu click component-->
    <div id="code-tree-click-component" data-menu style="margin-bottom: 30px;">
      <button class="b-3" onclick="cancel(event)" style="margin-right:5px; margin-top: 5px;">❌</button>
      <br>
      <button style="margin-right: 5px; margin-top: 5px;" class="b-3" onclick="replaceComponent(event)">🔄
        Replace</button>
      <br>
      <div hidden id="content-type">
        <label class="l-3"><input type="radio" name="main-content-type" data-content-type="none" checked
            value="none" />🗅
          None</label>
        <label class="b-3"><input type="radio" name="main-content-type" data-content-type="article" value="article" />⭐
          Article</label>
        <label class="b-3"><input type="radio" name="main-content-type" data-content-type="catalog" value="catalog" />✨
          Catalog</label>

        <div hidden id="catalog-folder">
          <button class="b-4">💾 Update</button>
          <input type="text" placeholder="📂 Catalog folder" class="input-1" style=" width: 50px;">
        </div>

        <div hidden id="catalog-weight">
          <button class="b-4">💾 Update</button>
          <input type="number" placeholder="🏋️‍♂️ Catalog Weight" class="input-1" style=" width: 50px;">
        </div>
      </div>
      <!-- <button style="margin-right: 5px; margin-top: 5px;" class="b-2" id="code-tree-click-tag-append-child" onclick="append(event)">👶 Append</button>
      <button style="margin-right: 5px; margin-top: 5px;" class="b-2" id="code-tree-click-tag-insert-before" onclick="insertB(event)">⬅️ InsertBefore</button>
        <button hidden class="b-2" id="code-tree-click-tag-remove-tag" onclick="removeComponent(event)">🗑️️ remove
component</button> -->
    </div>


    <!--menu click tag-->
    <div id="code-tree-click-tag" data-menu style="margin-bottom: 30px; ">
      <button style="margin-right:5px; margin-top: 5px;" class="b-3" onclick="cancel(event)">❌</button>
      <br>


      <label><input type="checkbox" id="applyToCopies"><span class="l-3">⧉ Apply to Copies</span></label>
      <button style="margin-right: 5px;" class="b-3" id="code-tree-click-tag-remove-tag" onclick="removeTag(event)">🗑️️
        Remove
        element</button>

      <br>


      <button class="b-3 t" data-element="code-tree-attributes-button" onclick="openAttributeContent(event)">🔑
        Attributes</button>

      <button style="margin-right:5px; margin-top: 5px;" data-element="code-tree-comment-button" class="b-3"
        onclick="openComment(event)">💬 Comment</button>
      <button class="b-3 t" data-element="code-tree-inner-html-button" onclick="openInnerHtmlContent(event)"> ▶️
        InnerHtml</button>
      <button class="b-3 t" data-element="code-tree-text-content-button" onclick="openTextContent(event)">📄
        TextContent</button>
      <br>
      <button style="margin:5px; margin-left: 0px; background-color: #f0f0f0;" class="b-3"
        id="code-tree-click-tag-append-child" onclick="append(event)">👶 Append</button>
      <button style="margin:5px; margin-left: 0px; background-color: #f0f0f0;" onclick="addParent(event)"
        class="b-3">👨‍👦️ Add Parent</button>

      <button style="margin:5px; margin-left: 0px; background-color: #f0f0f0;" class="b-3"
        id="code-tree-click-tag-insert-before" onclick="insertB(event)">⬅️ insertBefore</button>


      <br>

      <button style="margin-right: 5px;" class="b-3" id="code-tree-click-tag-change-tag" onclick="changeTag(event)">✏️
        Change tag</button>






      <!--
      <button style="margin-right:5px; margin-top: 5px;" class="b-3" id="code-tree-click-tag-change-tag"
        onclick="changeTagForCopies(event)">✏️ ChangeCopies</button>



<button  class="b-2" id="code-tree-click-tag-inner-html" onclick="insertHtml(event)">📄 inner HTML</button>
        <button class="b-2" id="code-tree-click-tag-dublicate-tag" onclick="duplicateTag(event)"> ⧉ Duplicate Element</button>
        -->
    </div>

    <!--menu add element-->
    <div id="code-tree-add-tag-step-1" style="padding: 7px; margin-bottom: 30px; " data-menu>
      <button style="margin-bottom: 5px;" class="b-4" onclick="cancel(event)">❌</button>
      <br>
      <button class="b-4" id="code-tree-add-tag-choose-new" onclick="addNew(event)"> ➕ New</button>
      <button class="b-4" id="code-tree-add-tag-choose-existed" onclick="addExisting(event)"> ✔️ Existed</button>
    </div>


    <!-- menu confirm selected append/insert tags-->
    <fieldset id="code-tree-append-or-insert-approv-menu" data-menu class="menu"
      style="border: 0; padding: 0; margin-bottom: 30px; user-select: none; display: block; width: 100%;">
      <button onclick="cancel(event)" class="b-4" style="margin-top: 5px; margin-bottom: 5px;">❌</button>
      <br>
      <span id="code-tree-amount-selected-for-append-or-insert" style="font-size: 24px;">0</span>
      <button class="b-4" id="code-tree-click-tag-approve" onclick="approve(event)"> ✅ Approve</button>

      <br>
      <label><input type="checkbox" id="code-tree-menu-copies-too"><span class="l-3">🚂⧉ Insert Copies
          too</span></label>
      <br>
      <label hidden class="l-3"><input name="duplicate-or-not-target-for-copies"
          id="code-tree-menu-dublicate-with-parent-option" id="code-tree-menu-dublicate-with-parent-option-1"
          id="code-tree-menu-dublicate-with-parent-option-2" type="checkbox">🎯⧉ Duplicate Target for Copies</label>
    </fieldset>



    <!-- menu to receive text area html -->
    <div id="code-tree-tag-text-content-form" data-menu style="margin-bottom: 30px; ">
      <button id="code-tree-tag-attributes-form-action-back" class="b-3" onclick="cancel(event)"
        style="margin-bottom:7px; margin-right: 5px;">❌</button>
      <br>
      <label><input type="checkbox"><span class="l-3">⧉ Apply to Copies</span></label>
      <br>

      <button id="code-tree-tag-text-content-action-save" onclick="saveText(event)" class="b-3"
        style="margin-bottom:7px; margin-top: 7px; margin-right: 5px;">💾 Save</button>
      <br>
      <textarea class="text1" placeholder=" 📄 Text content" id="code-tree-tag-text-content"></textarea>
      <br>
      <button id="code-tree-tag-text-content-action-save" onclick="saveText(event)" class="b-3"
        style="margin-top: 5px;">💾 save</button>
    </div>
    <!-- menu to receive inner html -->
    <div id="code-tree-tag-html-content-form" data-menu style="margin-bottom: 30px; ">
      <br>
      <button id="code-tree-tag-attributes-form-action-back" class="b-3" onclick="cancel(event)"
        style="margin-bottom:7px; margin-right: 5px;">❌</button>
      <br>
      <label><input type="checkbox" id="applyToCopies"><span class="l-3">⧉ Apply to Copies</span></label>
      <br>

      <button id="code-tree-tag-text-content-action-save" onclick="saveInnerHtml(event)" class="b-3"
        style="margin-bottom:7px; margin-right: 5px;">💾
        Save</button>
      <br>
      <textarea class="text1" placeholder=" ▶️ HTML content" id="code-tree-tag-html-content"></textarea>
      <br>
      <button id="code-tree-tag-text-content-action-save" onclick="saveInnerHtml(event)" class="b-3"
        style="margin-top:5px;">💾
        save</button>
    </div>



    <!--menu to view and edit attributes-->
    <div class="menu-1" id="code-tree-tag-attributes-form-1" data-menu style="margin-bottom: 30px; ">
      <button id="code-tree-tag-attributes-form-action-back" class="b-3" onclick="cancel(event)"
        style="margin-top: 10px; margin-bottom: 5px;">❌</button>


      <table class="table-2 table-row-number-2" id="code-tree-tag-attributes-list">
        <tbody>
          <tr id="code-tree-tag-attributes-list-item">
            <td><span class="l-4" style="user-select: none;">🔑</span><span class="l-4"
                id="code-tree-tag-attribute-key"></span></td>
            <td><span class="l-4" style="user-select: none;">📄</span><span class="l-4"
                id="code-tree-tag-attribute-value"><span></td>
            <td>
              <button id="code-tree-tag-attribute-remove-button" class="b-4"
                onclick="removeAttribute1(event)">🗑️️</button>
            </td>
          </tr>
        </tbody>
      </table>
      <div style="margin-bottom: 10px;">
        <br>
        <label><input type="checkbox" id="applyToCopies"><span class="l-3">⧉ Apply to Copies</span></label>
        <br>

        <button class="b-3" onclick="saveAttribute(event)" style="margin-bottom: 5px; margin-top: 5px;">💾 Save</button>
        <br>
        <textarea id="code-tree-tag-attribute-input-text" class="text1" placeholder=" 🔑 Add Attributes"></textarea>
        <br>
        <button class="b-3" onclick="saveAttribute(event)" style="margin-bottom: 5px; margin-top: 5px;">💾 Save</button>
      </div>
    </div>

    <fieldset id="tag-table" style="border-width: 0px; margin-bottom: 30px; " data-menu>
      <button onclick="cancel(event)" class="b-3" style="margin-top: 5px; margin-bottom: 5px;">❌</button></legend>
      <br>

      <label class="l-3">
        <input type="checkbox" id="applyForCopies2">
        ⧉ InsertToCopies+
      </label>

      <table id="tagsTable" class="tagsTable-style">
        <thead>
          <tr>
            <th><input type="text" id="searchTagName" placeholder="Search by Tag Name" onkeyup="filterTable(0)">
            </th>
            <th><input type="text" id="searchTagValue" placeholder="Search by Tag Value" onkeyup="filterTable(1)">
            </th>
            <th><input type="text" id="searchTagType" placeholder="Search by Tag Type" onkeyup="filterTable(2)">
            </th>
            <th><input type="text" id="searchTagComment" placeholder="Search by Tag Comment" onkeyup="filterTable(3)">
            </th>
          </tr>
          <tr>
            <th>Tag Name</th>
            <th>Tag Value</th>
            <th>Tag Type</th>
            <th>Tag Comment</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </fieldset>


    <!--files menus-->
    <!-- file path-->
    <li data-element="file-path" id="item">
      <label hidden class="l-3" style="margin-right: 3px;" id="Pushpin">📌</label>
      <label data-value="file-path" class="l-3">universal/blablabla/blablabla/coolcss</label>
      <label data-value="file-emoji" style="user-select: none; margin-left: 5px;" class="l-3">🧩</label>
      <div hidden data-value="file-id">for javascript</div>
      <button hidden data-action="remove-file-confirmation">for javascript</button>
    </li>


    <ol data-element="file-path-list" id="selectedFilePathList" class="list-1"
      style="margin-left: -10px; margin-bottom: 30px; " data-menu>
      <button style="margin-bottom: 8px; margin-left: -10px;" class="b-4"
        onclick="cancelReplace(event)">❌Cancel</button>
      <button style="margin-bottom: 8px; margin-left: 4px;" class="b-4" onclick="approveReplace(event)">✅
        Approve</button>
      <button style="margin-bottom: 8px; margin-left: 4px;" class="b-4" data-action="moveBack">⤴️ Up</button>
    </ol>


    <ol id="filePathList" class="list-1" style="margin-left: -10px;">
    </ol>


    <div hidden id="file-list-attach-component-options" style="padding: 5px; margin-left: 10px; margin-bottom: 30px; "
      data-menu>

      <button class="b-3" id="file-list-link-by-path" style="margin-top: 5px;"
        onclick="switchSelected(event)">📂Absolute</button>
      <button class="b-3" id="file-list-link-by-name" style="margin-top: 5px;"
        onclick="switchSelected(event)">🗂️Relative</button>
      <br>
      <button style="margin-top: 5px;" class="b-4" onclick="cancelReplace(event)">❌Cancel</button>
      <button style="margin-top: 5px;" class="b-4" onclick="approveAddComponent(event)">✅ Approve</button>
      <button style="margin-top: 5px;" class="b-4" data-action="moveBack">⤴️ Up</button>
    </div>
  </div>



  <div id="loading"
    style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 2;">

    <span style="font-size: 10.2em; color: white;">⏳</span>
    <div id="timer" style="font-size: 2em; color: white;">1.12</div>
    <button style="font-size: 30px;" id="remove-loading">❌</button>
  </div>
  <script>
    var convertToOldPath = (path) => {
      const splited = path.split('|')
      const fileName = splited.pop()
      return splited[0] + '/' + fileName
    }
    var convertToNewPath = (path) => {
      const splited = path.split('/')
      const fileName = splited.pop()
      return splited.join('/') + '/' + fileName
    }
    //label click scripts
    function loadRoot() {

      path = ''
      localStorage.setItem('storedPath', path)

      // Update the text content of the label

      window.location.href = 'index.html';
    }
    function labelClick(event) {
      // Extract the clicked part of the text based on the click position
      const clickedText = getClickedText(event, event.target.textContent);
      if (clickedText === pathItemPath.split(';')[0]) {
        return
      }
      const p = clickedText
      path = p + '/'
      localStorage.setItem('storedPath', path)
      console.log(path)
      window.location.href = 'index.html';
      // Update the text content of the label

    }

    function getClickedText(event, labelText) {
      const clickX = event.clientX;
      const labelRect = event.target.getBoundingClientRect();
      const relativeClickX = clickX - labelRect.left;

      // Split the label text into parts based on the '/' separator
      const parts = labelText.split('/');

      // Find the part that corresponds to the clicked position
      let accumulatedWidth = 0;
      for (const part of parts) {
        const partWidth = getTextWidth(part, event.target);
        accumulatedWidth += partWidth;
        if (accumulatedWidth >= relativeClickX) {
          const parts1 = parts.slice(0, parts.indexOf(part) + 1)
          return parts1.join('/')
        }
      }

      // Default: return the entire label text
      return labelText;
    }

    function getTextWidth(text, element) {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      const computedStyle = window.getComputedStyle(element);
      context.font = computedStyle.font;

      // Measure the width of the text
      const width = context.measureText(text).width;

      // Cleanup
      canvas.remove();

      return width;
    }

  </script>
  <script>
    //gallery scripts 
    var cancelGalleryMenu = (event) => {
      event.target.closest('#menu-1').style.display = 'none';
    }
    var loadImages = async (clonedFieldset, src) => {
      clonedFieldset.querySelector('#remove-galeryMenu').onclick = (e) => {
        e.target.parentNode.remove()
      }
      clonedFieldset.querySelector('#upload-button').onclick = handleUpload1
      const id = pathItem.sku || pathItem.id
      let mergedItems = []
      const res = await Promise.all([...Object.keys(cache), id].map(e => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${e}&sk=pics&startsWith=true`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(e => e.json().then(({ items }) => {
        mergedItems.push(...items)
      }))
      ))

      let items = mergedItems

      console.log('items' + JSON.stringify(items))
      const table = clonedFieldset.querySelector('#gallery-body');
      const templateRow = clonedFieldset.querySelector('#gallery-item');
      table.innerHTML = ""
      // Loop through each image item
      items.forEach((item) => {
        // Clone the template row
        const clonedRow = templateRow.cloneNode(true);
        clonedRow.removeAttribute('hidden'); // Show the cloned row
        clonedRow.querySelector('[data-select-image]').onclick = selectImage
        clonedRow.querySelector('[data-show-menu]').onclick = showMenu
        clonedRow.querySelector('[data-remove-image]').onclick = removeImage
        // Update the image source based on the item's sk
        const imageSrc = `https://s3.amazonaws.com/checkout-admin-panel/${item.sk}`;
        const imgEl = clonedRow.querySelector('.gallery-image img')
        imgEl.src = imageSrc;
        const uuid = item.sk.split('.')[0].replace('pics', '')
        imgEl.setAttribute('uuid', uuid)

        if (src !== imageSrc) {
          const attachedLabel = clonedRow.querySelector('.gallery-image .attached');
          if (attachedLabel) {
            attachedLabel.parentNode.removeChild(attachedLabel);
          }
        }

        // Set a unique id for the cloned row (assuming you have a property named id in the item)
        clonedRow.id = `image-body-${item.sk}`;

        // Append the cloned row to the table
        table.appendChild(clonedRow);
      });
      // Select all gallery images
      const images = clonedFieldset.querySelectorAll('.gallery-image');

      images.forEach(image => {
        const actions = image.querySelector('.picture-actions');

        // When you hover over an image
        image.addEventListener('mouseenter', () => {
          // Set the z-index of the picture actions to 10
          actions.style.zIndex = '10';
        });

        // When the mouse leaves the image
        image.addEventListener('mouseleave', () => {
          // Reset the z-index of the picture actions to -10
          actions.style.zIndex = '-10';
        });
      });
    }
    function showMenu(event) {
      const galleryImage = event.target.closest('.gallery-image');
      const imageSrc = galleryImage.querySelector('img').src;

      // Set the image source in the menu
      const menuImage = getElementById1('menu-1').querySelector('img');
      menuImage.src = imageSrc;

      // Display the menu
      const menu = getElementById1('menu-1');
      menu.style.display = 'block';
    }
    async function removeImage(event) {
      const id = pathItem.id
      const imageSrc = event.target.closest('.gallery-image').querySelector('img').src;
      console.log('Removing Image Src:', imageSrc);
      const sk = imageSrc.replace('https://s3.amazonaws.com/checkout-admin-panel/', "")
      const imgId = event.target.closest('[data-menu]').id.replace('gallery-menu-wrapper;', '')

      await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${id}:${sk}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          // Add any additional headers if needed
        },
      });
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/upload?id=' + sk, {
        method: 'DELETE',
      });
      //to cont
      //setImg('https://via.placeholder.com/300/0000FF/FFFFFF?text=Article-Image', imgId)
      loadImages(event.target.closest('[data-menu]', 'https://via.placeholder.com/300/0000FF/FFFFFF?text=Article-Image'))

    }
    const setImg = async (path, imgId) => {

      const payload2 = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'src',
        value: path,
        check_b: true

      }
      pushAction(payload2)
    }
    const upload = async (fileName, fileContent) => {
      const body = {
        fileName
      }
      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/upload', {
        method: 'POST',
        body: JSON.stringify(body),
      });

      if (!response.ok) {
        return
      }
      const { url, fields, path } = await response.json()
      const formData = new FormData();
      Object.entries(fields).forEach(([field, value]) => {
        formData.append(field, value);
      });
      formData.append('file', fileContent);

      // Use Fetch API to send a POST request with the FormData to the presigned URL
      const uploadResponse = await fetch(url, {
        method: 'POST',
        body: formData,
      })
      if (!uploadResponse.ok) {
        const er = await uploadResponse.text()
        console.log('error ' + er)
        return
      }
      return path
    }
    async function handleUpload1(event) {

      const id = pathItem.sku || pathItem.id
      const fileContent = await file
      const fileName = fileContent.name

      try {

        const path = await upload(fileName, fileContent)
        console.log(path)
        //push to db image
        // Send a POST request using fetch
        const payload = {
          id,
          sk: path
        }
        const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });
        loadImages(event.target.closest('[data-menu]', 'https://s3.amazonaws.com/checkout-admin-panel/' + path))


      } catch (error) {
      }
    }

    function generateRandomString(length) {
      const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; // Letters and numbers
      let randomString = '';

      for (let i = 0; i < length; i++) {
        const randomIndex = Math.floor(Math.random() * charset.length); // Generate a random index
        randomString += charset.charAt(randomIndex); // Append the random character to the string
      }

      return randomString;
    }

    async function selectImage(event) {
      const imgId = event.target.closest('[data-menu]').id.replace('gallery-menu-wrapper;', '')
      const image = event.target.closest('.gallery-image').querySelector('img')

      const imageSrc = image.src;
      const imageUUID = image.getAttribute('uuid')
      const imageElement = getElementById1(removeLastOccurrence(imgId, '-tree'))
      const name = imageElement.getAttribute('data-builder-image-name')
      const defaultRes = imageElement.getAttribute('data-builder-image-default')

      const site = pathItemPath.split('/')[0]
      let randomString = generateRandomString(3)
      let url1 = 'https://' + site + '/pics/' + randomString + '_' + name
      function checkSrcStartsWithUrl1() {
        const elements = document.querySelectorAll('[src^="' + url1 + '"]');
        return elements.length > 0;
      }
      while (checkSrcStartsWithUrl1()) {
        randomString = generateRandomString(3);
        url1 = 'https://' + site.toLowerCase() + '/pics/' + randomString + '_' + name;
      }
      const splited = pathItemPath.split('/')
      splited.pop()
      splited.shift()
      const index = splited.indexOf('Content');
      if (index !== -1) {
        splited.splice(index);
      }
      // resize
      const body = {
        site,

        name: randomString + '_' + name,
        imageSrc,
        defaultRes,
        pagePath: splited.join('/')
      }
      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/resize', {
        method: 'POST',
        body: JSON.stringify(body),
      });
      const { src, data_src } = await response.json()
      const galleryImage = event.target.closest('.gallery-image');
      const selectedLabels = event.target.closest('[data-menu]').querySelectorAll('.selected');
      selectedLabels.forEach(label => label.remove());
      const attachedLabel = galleryImage.querySelector('img')
      if (attachedLabel) {
        attachedLabel.insertAdjacentHTML('afterend', '<label class="attached">📎</label>');
      }

      const payload = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'data-builder-image-source',
        value: imageUUID,

      }
      await pushAction(payload)

      const payload3 = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'src',
        value: src,
        check_b: true

      }
      await pushAction(payload3)
      const payload4 = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'data-src',
        value: data_src,

      }
      await pushAction(payload4)
      // Add your logic for selecting the image here



      // Add a "selected" label to the selected image



    }




  </script>

  <script>
    const urlSearchParams = new URLSearchParams(window.location.search);
    var page_id = urlSearchParams.get('id');

    var removeMenus = () => document.querySelector("#code-tree").querySelectorAll('[data-menu]').forEach(menu => menu.remove())
    var getElementById1 = (id) => {
      const el = document.getElementById(id)
      if (el) {
        return el
      }
      var iframe = document.getElementById("generated-page-iframe");

      // Access the content of the iframe
      var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;

      // Modify the content of the generated-page div within the iframe
      var el2 = iframeDocument.getElementById(id);
      if (el2) {
        return el2
      }
      console.log('not found id1' + id)
      return undefined
    }
    var querySelectorAll1 = (selector) => {

      const els1 = document.querySelectorAll(selector)

      var iframe = getElementById1("generated-page-iframe");

      // Access the content of the iframe
      var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;


      var els2 = iframeDocument.querySelectorAll(selector);

      console.log('not found all' + selector)
      const res = [...els1, ...els2]
      console.log("r11" + JSON.stringify(Array.from(els1).map(e => e.id)) + selector)
      console.log("r12" + JSON.stringify(Array.from(els2).map(e => e.id)) + selector)
      console.log("r13" + JSON.stringify(Array.from(res).map(e => e.id)) + selector)
      return res
    }
    getElementById1('remove-loading').addEventListener('click', function () {
      getElementById1('loading').remove();
    });

  </script>
  <script>
    const removeAndInvalidate = async (e) => {
      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/removeandinvalidate/' + pathItem.id + ':' + pathItem.sk, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      });
    }
    const invalidate = async (e) => {
      const site = pathItemPath.split('/')[0]
      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/invalidate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ site }),
      });
    }
    function capitalizeAndReplaceHyphens(str) {
      // Replace hyphens with spaces and split the string into words
      const words = str.replace(/-/g, ' ').split(' ');

      // Capitalize the first letter of each word
      const capitalizedWords = words.map(word => {
        // Capitalize the first letter of the word
        const firstLetter = word.charAt(0).toUpperCase();
        // Concatenate the first letter with the rest of the word
        return firstLetter + word.slice(1);
      });

      // Join the words back together to form the modified string
      const capitalizedString = capitalizedWords.join(' ');

      return capitalizedString;
    }
    const generateBreadCrumb = async (event) => {
      let arr = pathItemPath.split(';')[0].split('/')
      const site = arr[0]
      arr.shift()

      const index = arr.indexOf('Content');
      if (index !== -1) {
        arr.splice(index);
      }
      const index2 = arr.indexOf('Home');
      if (index2 !== -1) {
        arr.splice(index2, 1);
      }
      const active = arr.pop()
      console.log('active is ' + active)
      const breadCA = querySelectorAll1('[data-builder-breadcrumb-active]')
      const breadC = querySelectorAll1('[data-builder-breadCrumb]')
      const a = breadC[0].querySelector('[data-builder-breadCrumb-value]')



      const el2 = {
        time: (new Date()).getTime(),
        action: 'setAttribute',
        target_element: a.id + '-tree',
        key: 'href',
        value: 'https://' + site.toLowerCase(),

      }
      await pushAction(el2)

      if (active) {
        const a = breadCA[0].querySelector('[data-builder-breadCrumb-value]')
        const el = {
          time: (new Date()).getTime(),
          action: 'textContent',
          target_element: a.id + '-tree',
          value: capitalizeAndReplaceHyphens(active),

        }

        await pushAction(el)
      }
      else {
        const el =
        {
          time: (new Date()).getTime(),
          action: 'removeTag',
          target_element: breadCA[0].id + '-tree',

        }
        pushAction(el)
      }

      let last = breadC[0].id + '-tree'

      for (let i = 0; i < arr.length; i++) {
        const id = duplicateId(breadC[0].id).id
        actionObject = {
          time: (new Date()).getTime(),
          action: 'InsertAfter',
          target_element: last,
          inserted_element: { originalId: breadC[0].id + '-tree', id },
        };
        await pushAction(actionObject)
        last = id
        const a = getElementById1(removeLastOccurrence(id, '-tree')).querySelector('[data-builder-breadCrumb-value]')

        let link = 'https://' + site.toLowerCase() + '/'
        const el = {
          time: (new Date()).getTime(),
          action: 'textContent',
          target_element: a.id + '-tree',
          value: capitalizeAndReplaceHyphens(arr[i]),

        }
        await pushAction(el)
        for (let j = 0; j <= i; j++) {
          link = link + arr[j].toLowerCase() + '/'
        }

        const el2 = {
          time: (new Date()).getTime(),
          action: 'setAttribute',
          target_element: a.id + '-tree',
          key: 'href',
          value: link,

        }
        await pushAction(el2)

      }
      const schema = querySelectorAll1('script[data-transfer-receiver="schema-breadcrumb"]')[0]
      console.log(schema.textContent)
      let json = JSON.parse(schema.textContent)


      json.itemListElement[0].item["@id"] = 'https://' + site.toLowerCase()
      let link1 = 'https://' + site.toLowerCase() + '/'
      active && arr.push(active)
      for (let i = 0; i < arr.length; i++) {
        const newEl = deepCopy(json.itemListElement[0])
        link1 = link1 + arr[i] + '/'
        newEl.item["@id"] = link1.toLowerCase()
        newEl.item.name = capitalizeAndReplaceHyphens(arr[i].toLowerCase())
        newEl.position = i + 2
        json.itemListElement.push(newEl)
      }
      console.log('newJSON' + json)
      const el = {
        time: (new Date()).getTime(),
        action: 'innerHtml',
        target_element: schema.id + '-tree',
        insertedCode: JSON.stringify(json, null, 2),

      }
      await pushAction(el)
    }
    const switchSelected = (event) => {
      const activated = event.target.classList.contains('b-selected')
      if (activated) {
        event.target.classList.remove('b-selected')
      }
      else {
        event.target.classList.add('b-selected')
      }
    }
    //toggle menu button scripts
    const toggleGeneratedPage = () => {
      const s = localStorage.getItem('generatedPageToggle')
      if (!s) {

        getElementById1("sku-list").removeAttribute('hidden')
        getElementById1('generated-page').removeAttribute('hidden')
        getElementById1('generated-page-menu').removeAttribute('hidden')
        getElementById1('toggle-generated-page').classList.add('b-selected')
        localStorage.setItem('generatedPageToggle', 'true')
      }
      else {
        getElementById1("sku-list").setAttribute('hidden', '')
        getElementById1('generated-page').setAttribute('hidden', '')
        getElementById1('generated-page-menu').setAttribute('hidden', '')
        getElementById1('toggle-generated-page').classList.remove('b-selected')
        localStorage.removeItem('generatedPageToggle')
      }
    }
    const generateDependeeMenu = (node) => {
      const sku = node.querySelector('#sku-value').textContent
      console.log(sku)
      const item = getElementById1('dependee-menu-item')
      const dependeeMenu = node.querySelector('#dependee-menu')
      const forms = querySelectorAll1('[data-product-attribute-form]');
      const dependees = querySelectorAll1('[data-builder-dependee]');
      const selects = []
      for (let i = 0; i < forms.length; i++) {
        const form = forms[i]
        selects.push(form.querySelector('[data-product-attribute-legend]'))
      }
      const dependees1 = removeDuplicates(Array.from(dependees).map(el => el.getAttribute('data-builder-dependee')))
      dependeeMenu.innerHTML = ''
      const checkbox = getElementById1('checkbox-label')
      for (const dependee of dependees1) {
        console.log('in')
        const cloned = item.cloneNode(true)
        cloned.removeAttribute('hidden')
        cloned.querySelector('[data-type="dependee-value"]').textContent = dependee

        for (const select of selects) {
          const clonedCheckbox = checkbox.cloneNode(true)
          clonedCheckbox.removeAttribute('hidden')
          clonedCheckbox.setAttribute('formId', select.parentNode.id)
          clonedCheckbox.innerHTML = clonedCheckbox.innerHTML.replace('Color', select.textContent)
          cloned.insertBefore(clonedCheckbox, cloned.children[cloned.children.length - 1])
        }
        dependeeMenu.appendChild(cloned)

      }
    }
    var getChecked = (resultList) => {
      const checked1 = []
      for (const el1 of resultList) {
        const selected = el1.form.querySelectorAll('[type="radio"]').forEach(el => {
          if (el.checked) {
            const selectedValue = el.parentNode.querySelector('[data-product-attribute-value]').textContent
            checked1.push(el1.legend + ':' + selectedValue)
          }
        })


      }
      return checked1
    }
    const generateDependees = async (event) => {
      const parentFieldSet = event.target.closest('fieldset')
      const checkboxes = parentFieldSet.querySelectorAll('[data-type="dependant"')
      const skuValue = parentFieldSet.parentNode.parentNode.querySelector('#sku-value').textContent
      const resultList = []
      for (const item of checkboxes) {
        const checkbox = item.firstChild
        if (checkbox.checked) {
          console.log('checkbox ' + checkbox.id)
          const formId = item.getAttribute('formId')
          const form = getElementById1(formId)
          const legendElement = form.querySelector('[data-product-attribute-legend]');
          const legend = legendElement && legendElement.textContent;

          const attributeElements = form.querySelectorAll('[data-product-attribute]');
          const attributes = Array.from(attributeElements).map(element => element.textContent);

          resultList.push({
            form,
            legend: legend,
            items: attributes
          });
        }

      }
      const combinations = generateCombinations(resultList)
      console.log(JSON.stringify(combinations))
      const dependencyName = parentFieldSet.querySelector('[data-type="dependee-value"]').textContent
      let dependeeItems = querySelectorAll1(`[data-builder-dependee="${dependencyName}"]`)
      const allIds = Array.from(dependeeItems).map(e => e.id)
      const ids = []
      const toRemove = []
      for (const id of allIds) {
        if (id.endsWith('-tree')) {
          continue
        }
        const splited = id.split(':')
        if (!ids.find(el => el.startsWith(splited[0] + ':'))) {
          ids.push(id)

        }
        else {
          toRemove.push(id)
        }
      }
      console.log('tr555 ' + JSON.stringify(toRemove))
      console.log('tr555 ' + JSON.stringify(ids))
      for (const id of toRemove) {
        await pushAction({
          time: (new Date()).getTime(),
          action: 'removeTag',
          target_element: id + '-tree',
        })
      }
      for (const id of ids) {
        for (let i = 0; i < combinations.length; i++) {
          let currentId = id + '-tree'

          if (i !== 0) {
            const res = duplicateId(id)
            let actionObject = {
              time: (new Date()).getTime(),
              action: 'InsertBefore',
              target_element: id + '-tree',
              inserted_element: { originalId: id + '-tree', id: res.id },
            };
            await pushAction(actionObject)
            currentId = res.id
          }
          const el = {
            time: (new Date()).getTime(),
            action: 'setAttribute',
            target_element: currentId,
            key: 'data-product-info',
            value: `${skuValue};${combinations[i]}`,

          }
          await pushAction(el)

        }
      }
      //get selected combination
      const checked1 = getChecked(resultList)
      console.log(JSON.stringify(checked1))
      dependeeItems = querySelectorAll1(`[data-builder-dependee="${dependencyName}"]`)
      for (const item of dependeeItems) {
        const attr = item.getAttribute('data-product-info')
        const splited = attr.split(';')
        splited.shift()
        const f = splited.find(el => !checked1.includes(el))
        if (f) {
          item.style.display = 'none'
        }
        else {
          item.style.display = 'block'
        }
      }
      handleDependency()

    }
    const toggleDependencyMenu1 = (event) => {
      const menus = event.target.parentNode.querySelectorAll('#dependee-menu')

      const button = event.target
      if (!button.classList.contains('b-selected')) {
        console.log('setting');

        // Set the item in local storage


        // Remove the 'hidden' attribute to show the menu
        menus.forEach(menu => menu.removeAttribute('hidden'))

        // Add the class 'b-selected' to the toggle button
        button.classList.add('b-selected');
        generateDependeeMenu(event.target.parentNode)
      } else {
        // If the item is set in local storage

        // Remove the item from local storage


        // Remove the class 'b-selected' from the toggle button
        button.classList.remove('b-selected');

        // Set the 'hidden' attribute to hide the menu
        menus.forEach(menu => menu.setAttribute('hidden', ''))
      }
    }
    const toggleSkuAttributeList = (event) => {
      const el = event.target
      const list = el.parentNode.querySelector('#sku-attribute-list')
      if (el.classList.contains('b-selected')) {
        el.classList.remove('b-selected')
        list.setAttribute('hidden', 'true')
      }
      else {
        el.classList.add('b-selected')

        list.removeAttribute('hidden')
      }
    }
    const toggleHead = () => {
      const s = localStorage.getItem('headToggle')
      if (!s) {

        getElementById1('head-1').removeAttribute('hidden')
        getElementById1('head-menu').removeAttribute('hidden', '')
        getElementById1('toggle-head').classList.add('b-selected')
        localStorage.setItem('headToggle', 'true')
      }
      else {
        getElementById1('head-1').setAttribute('hidden', '')
        getElementById1('head-menu').setAttribute('hidden', '')
        getElementById1('toggle-head').classList.remove('b-selected')
        localStorage.removeItem('headToggle')
      }
    }
    const toggleCodeTree = () => {
      const s = localStorage.getItem('codeTreeToggle')
      if (!s) {

        getElementById1('code-tree').removeAttribute('hidden')
        getElementById1('code-tree-menu').removeAttribute('hidden', '')
        getElementById1('toggle-code-tree').classList.add('b-selected')
        localStorage.setItem('codeTreeToggle', 'true')
      }
      else {
        getElementById1('code-tree').setAttribute('hidden', '')
        getElementById1('code-tree-menu').setAttribute('hidden', '')
        getElementById1('toggle-code-tree').classList.remove('b-selected')
        localStorage.removeItem('codeTreeToggle')
      }
    }
    const toggleComponentTree = () => {
      const s = localStorage.getItem('componentTreeToggle')
      if (!s) {

        getElementById1('components-tree').removeAttribute('hidden')
        getElementById1('components-tree-menu').removeAttribute('hidden', '')
        getElementById1('toggle-component-tree').classList.add('b-selected')

        localStorage.setItem('componentTreeToggle', 'true')
      }
      else {
        getElementById1('components-tree').setAttribute('hidden', '')
        getElementById1('components-tree-menu').setAttribute('hidden', '')
        getElementById1('toggle-component-tree').classList.remove('b-selected')
        localStorage.removeItem('componentTreeToggle')
      }
    }
    document.addEventListener('DOMContentLoaded', function () {
      const s1 = localStorage.getItem('codeTreeToggle')
      if (s1) {
        getElementById1('toggle-code-tree').classList.add('b-selected')
      }
      else {
        getElementById1('code-tree-menu').setAttribute('hidden', '')
        getElementById1('code-tree').setAttribute('hidden', '')
      }
      const s2 = localStorage.getItem('componentTreeToggle')
      if (s2) {
        getElementById1('toggle-component-tree').classList.add('b-selected')
      }
      else {
        getElementById1('components-tree').setAttribute('hidden', '')
        getElementById1('components-tree-menu').setAttribute('hidden', '')
      }
      const s3 = localStorage.getItem('headToggle')
      if (s3) {
        getElementById1('toggle-head').classList.add('b-selected')
      }
      else {
        getElementById1('head-menu').setAttribute('hidden', '')
        getElementById1('head-1').setAttribute('hidden', '')
      }
      const s4 = localStorage.getItem('generatedPageToggle')
      if (s4) {
        getElementById1('toggle-generated-page').classList.add('b-selected')
      }
      else {
        getElementById1('generated-page-menu').setAttribute('hidden', '')
        getElementById1('generated-page').setAttribute('hidden', '')
      }


    })

  </script>
  <script>
    var pathItem
    var pathItemPath
    var selectedSku
    var dependencyItem
    var skuCreated
    var updatePathItem = () =>
      fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(pathItem),
      });

    const switchOptionalScript = (updateDb) => {
      const el = getElementById1('optional-script')
      if (!updateDb) {
        el.classList.add('b-selected');
        return
      }
      if (pathItem.optionalScript) {
        pathItem.optionalScript = false
        el.classList.remove('b-selected');
      }
      else {
        pathItem.optionalScript = true
        el.classList.add('b-selected');
      }
      updatePathItem()


    }
    const switchLinkBP = (updateDb) => {
      const el = getElementById1('link-by-path')
      if (!updateDb) {
        el.classList.add('b-selected');
        return
      }
      if (pathItem.LinkBP) {
        pathItem.LinkBP = false
        el.classList.remove('b-selected');
      }
      else {
        pathItem.LinkBP = true
        el.classList.add('b-selected');
      }
      updatePathItem()
    }
    const switchTest = (updateDb) => {
      const el = getElementById1('test-component')
      if (!updateDb) {
        el.classList.add('b-selected');
        return
      }
      if (pathItem.testPage) {
        pathItem.testPage = false
        el.classList.remove('b-selected');

      }
      else {
        pathItem.testPage = true
        el.classList.add('b-selected');
      }
      updatePathItem()
    }
    //not used
    const addComponent1 = async(id) => {
      //getElementById1('file-list-attach-component-options;').remove()
      const actionObject = {
        time: (new Date()).getTime(),
        action: 'Add_Component',
        target_element: page_id + '-tree',
        inserted_component: { componentId: id, id: generateUUID() },
      };
      await pushAction(actionObject);
    }
    var loadUsingPath2 = (path1, filePathList, optionList) => {
      return fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true&lsi1=' + path1)
        .then(response => response.json())
        .then(data => {
          // Replace existing file paths with dynamic content

          filePathList.innerHTML = '';
          let i = 0
          let folders = []
          const elements = []
          console.log(JSON.stringify(data))
          const items = data.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(path1, '').split(';')[0] } })
          console.log(JSON.stringify(items))
          for (const item of items) {
            const splited = item.name.split(';')[0].split('/')
            if (splited.length > 1) {
              folders.push(splited[0])
            }
            else {
              elements.push({ name: splited[0], ...item })
            }
          }
          folders = removeDuplicates(folders)
          console.log(JSON.stringify(folders))
          console.log(JSON.stringify(elements))

          folders.forEach(item => {


            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item;

              // Set file path and emoji
              const file_path = clonedItem.querySelector('[data-value="file-path"]')
              file_path.textContent = item;
              clonedItem.onclick = setPath
              let icon = '📂';

              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item;

              // Set up onclick for file-open button
              function setPath() {
                path1 = path1 + item + '/'
                loadUsingPath2(path1, filePathList, optionList)
              };

              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }

          });
          elements && elements.forEach(item => {


            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item.id;

              // Set file path and emoji
              const item_path = clonedItem.querySelector('[data-value="file-path"]')
              item_path.textContent = item.name;
              clonedItem.onclick = function (event) {
                event.stopPropagation()
                fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/' + item.id + ':' + item.sk)
                  .then(response => response.json())
                  .then(data => {
                    if (data.LinkBP || optionList.querySelector('#file-list-link-by-path').classList.contains('b-selected')) {
                      const p = data.lsi1.split('/')
                      p.shift()
                      addComponent1("*/" + p.join('/'))
                    }
                    else if (optionList.querySelector('#file-list-link-by-name').classList.contains('b-selected')) {
                      const p = data.lsi1.split('/')

                      addComponent1("#" + p.pop())
                    }
                    else {
                      addComponent1(item.id)
                    }

                    filePathList.remove()
                  })

              };
              let icon = '🧩';
              if (item.lsi1.startsWith('css')) {
                icon = '🎨';
              } else if (item.lsi1.startsWith('javascript')) {
                icon = '💻';
              }
              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

              clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                event.stopPropagation()
                remove(event, item.id);
              };
              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }

          });



        })
        .catch(error => console.error('Error:', error));
    }
    var loadFileList2 = (filePathList, optionList) => {
      // Fetch GET request

      fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true')
        .then(response => response.json())
        .then(data => {
          // Replace existing file paths with dynamic content
          filePathList.innerHTML = '';
          let i = 0;
          let folders = []
          const elements = []
          console.log(JSON.stringify(data))
          const items = data.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.split(';')[0] } })
          console.log('ites' + JSON.stringify(items))
          for (const item of items) {
            const splited = item.name.split(';')[0].split('/')
            if (splited.length > 1) {
              folders.push(splited[0])
            }
            else {
              elements.push({ name: splited[0], ...item })
            }
          }
          folders = removeDuplicates(folders)
          console.log(JSON.stringify(elements))
          folders.forEach(item => {


            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item;

              // Set file path and emoji
              const file_path = clonedItem.querySelector('[data-value="file-path"]')
              file_path.textContent = item;
              clonedItem.onclick = setPath
              let icon = '📂';

              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item;

              // Set up onclick for file-open button
              function setPath() {
                const path1 = item + '/'


                loadUsingPath2(path1, filePathList, optionList)
              };

              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }

          });
          elements && elements.forEach(item => {


            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item.id;

              // Set file path and emoji
              const item_path = clonedItem.querySelector('[data-value="file-path"]')
              item_path.textContent = item.name;
              clonedItem.onclick = function (event) {
                event.stopPropagation()
                fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/' + item.id + ':' + item.sk)
                  .then(response => response.json())
                  .then(data => {

                    if (data.LinkBP || optionList.querySelector('#file-list-link-by-path').classList.contains('b-selected')) {
                      const p = data.lsi1.split('/')
                      p.shift()
                      addComponent1("*/" + p.join('/'))
                    }
                    else if (optionList.querySelector('#file-list-link-by-name').classList.contains('b-selected')) {
                      const p = data.lsi1.split('/')

                      addComponent1("#" + p.pop())
                    }
                    else {
                      addComponent1(item.id)
                    }

                    filePathList.remove()
                  })

              };
              let icon = '🧩';
              if (item.lsi1.startsWith('css')) {
                icon = '🎨';
              } else if (item.lsi1.startsWith('javascript')) {
                icon = '💻';
              }
              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

              // Set up onclick for file-open button

              clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                event.stopPropagation()
                remove(event, item.id);
              };
              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }

          });



          // Show the cloned fieldsets
          querySelectorAll1('#filePathList fieldset').forEach(fieldset => {
            fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
          });




        })
        .catch(error => console.error('Error:', error));

    }
    //end not used
    var addComponent = (e) => {

      let selected = []
      let path1 = ''
      var addSelected = (itemId, path) => {
        const clonedFieldset2 = getElementById1('selectedFilePathList;')
        if (Array.from(clonedFieldset2.children).find(el => el.id === itemId )) {
          return
        }
        var clonedItem = getElementById1('item').cloneNode(true);
        selected.push(itemId)
        clonedItem.id = itemId;
        const file_path = clonedItem.querySelector('[data-value="file-path"]')
        file_path.textContent = path;
        clonedItem.querySelector('#Pushpin').removeAttribute('hidden')
        clonedItem.onclick = (e) => { e.target.closest('li').remove(); selected.filter(el => el !== itemId) }
        var firstChild = clonedFieldset2.firstChild;

        // Insert clonedItem before the first child
        clonedFieldset2.insertBefore(clonedItem, firstChild);
        console.log(JSON.stringify(selected))

      }




      var loadUsingPath1 = async (path) => {
        try {
          //get files
          let url
          const helperid = localStorage.getItem('helperid')
          const ownerid = localStorage.getItem('ownerid')

          var filePathList = getElementById1('filePathList;');
          filePathList.innerHTML = '';
          let lvls = [];
          let i = 0;
          let folders = [];

          //get files
          const spath = path.slice(0, -1) + '|';

          if (helperid) {
            url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${spath}&token=${localStorage.getItem('token')}`;
          }
          else {
            url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${spath}&token=${localStorage.getItem('token')}`;
          }
          let data1 = fetch(url).then(e => e.json())
          //get folders
          if (path.split('/').length > 3) {
            //normal
            if (localStorage.getItem('helperid')) {
              url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`;
            }
            else {
              url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`;
            }
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            let data = await response.json();
            console.log(JSON.stringify(data));
            const items = data.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(path, '').split(';')[0] } });
            console.log(JSON.stringify(items));
            for (const item of items) {
              const splited = item.name.split(';')[0].split('/');
              if (splited.length > 1) {
                folders.push(splited[0]);
              }
              else {
                folders.push(splited[0].split('|')[0])
              }
            }
          }
          else {
            //use folders
            const sk = `folder:${helperid ? helperid : ownerid}:lvl${path.split('/').length}:${path}`
            console.log(sk)
            let url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            let data = await response.json();
            folders = data.items.map(item => item.sk.replace(sk, ''))
          }


          // Replace existing file paths with dynamic content

          console.log('folders' + JSON.stringify(folders))
          folders = removeDuplicates(folders);
          folders.sort();
          folders.forEach(item => {


            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item;

              // Set file path and emoji
              const file_path = clonedItem.querySelector('[data-value="file-path"]')
              file_path.textContent = item;
              clonedItem.onclick = setPath
              let icon = '📂';

              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item;

              // Set up onclick for file-open button
              function setPath() {
                path1 = path1 + item + '/'
                loadUsingPath1(path1)
              };

              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }

          });


          //elements



          data1 = await data1
          let elements = data1.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(spath, '').split(';')[0] } });
          elements.sort((a, b) => a.name.localeCompare(b.name));
          for (const el1 of elements) {
            const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${el1.id}:${el1.sk}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(el => el.json()).then(el2 => { return { ...el2, ...el1 } });
            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = getElementById1('item').cloneNode(true);

              // Set unique ID for the cloned item
              clonedItem.id = item.id;

              // Set file path and emoji
              const item_path = clonedItem.querySelector('[data-value="file-path"]')
              item_path.textContent = item.name;
              clonedItem.onclick = function (event) {

                addSelected(item.id, item.lsi1);
              };
              let icon = '🧩';
              if (item.lsi1.startsWith('css')) {
                icon = '🎨';
              } else if (item.lsi1.startsWith('javascript')) {
                icon = '💻';
              }
              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

              clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                event.stopPropagation()
                remove(event, item.id);
              };
              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }
          }

        } catch (error) {
          console.error('Error:', error);
        }

      }
      var loadFileList1 = async () => {
        // Fetch GET request

        console.log('loading filelist')
        // Fetch GET request
        const helperid = localStorage.getItem('helperid')
        const ownerid = localStorage.getItem('ownerid')
        const sk = `folder:${helperid ? helperid : ownerid}:lvl1:`
        let url
        console.log(url)


        var filePathList = document.getElementById('filePathList;');
        filePathList.innerHTML = '';

        if (helperid) {
          url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=|&token=${localStorage.getItem('token')}`;
        }
        else {
          url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=|&token=${localStorage.getItem('token')}`;
        }
        let data1 = fetch(url).then(e => e.json())
        url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`
        return fetch(url)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            // Parse response as JSON
            return response.json();
          })
          .then(async data => {
            console.log(JSON.stringify(data))
            // Replace existing file paths with dynamic content

            let i = 0;
            let folders = data.items.map(item => item.sk.replace(sk, ''))

            console.log(JSON.stringify(data))


            folders = removeDuplicates(folders)
            console.log(JSON.stringify(folders))
            folders.sort()
            folders.forEach(item => {


              if (i < 1000) {
                i++
                // Clone the fieldset
                var clonedItem = getElementById1('item').cloneNode(true);

                // Set unique ID for the cloned item
                clonedItem.id = item;

                // Set file path and emoji
                const file_path = clonedItem.querySelector('[data-value="file-path"]')
                file_path.textContent = item;
                clonedItem.onclick = setPath
                let icon = '📂';

                clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

                // Set file ID
                clonedItem.querySelector('[data-value="file-id"]').textContent = item;

                // Set up onclick for file-open button
                function setPath() {
                  path1 = item + '/'


                  loadUsingPath1(path1)
                };

                // Append the cloned item to the filePathList
                filePathList.appendChild(clonedItem);
              }

            });

            // Show the cloned fieldsets
            document.querySelectorAll('#filePathList fieldset').forEach(fieldset => {
              fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
            });


            folders.map(async folder => {
              if (helperid) {
                url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${path + folder}&token=${localStorage.getItem('token')}&pageSize=1`;
              }
              else {
                url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${path + folder}&token=${localStorage.getItem('token')}&pageSize=1`;
              }
              let { items } = await fetch(url).then(e => e.json())
              if (!items.length) {
                const sk = `folder:${helperid ? helperid : ownerid}:lvl${path.split('/').length}:${path}${folder}`
                const encoded = `${ownerid}:${sk}`.replaceAll('/', '~')
                await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${encoded}`, {
                  method: 'DELETE',
                  headers: {
                    'Content-Type': 'application/json',
                    // Add any additional headers if needed
                  },
                });
                document.getElementById(folder).remove()
              }

            })

            data1 = await data1
            let elements = data1.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace('|', '').split(';')[0] } });
            elements.sort((a, b) => a.name.localeCompare(b.name));
            for (const el1 of elements) {
              if (i < 1000) {
                i++
                // Clone the fieldset
                var clonedItem = getElementById1('item').cloneNode(true);

                // Set unique ID for the cloned item
                clonedItem.id = item.id;

                // Set file path and emoji
                const item_path = clonedItem.querySelector('[data-value="file-path"]')
                item_path.textContent = item.name;
                clonedItem.onclick = function (event) {
                  event.stopPropagation()
                  addSelected(item.id, item.lsi1);
                };
                let icon = '🧩';
                if (item.lsi1.startsWith('css')) {
                  icon = '🎨';
                } else if (item.lsi1.startsWith('javascript')) {
                  icon = '💻';
                }
                clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

                // Set file ID
                clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

                // Set up onclick for file-open button

                clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                  event.stopPropagation()
                  remove(event, item.id);
                };
                // Append the cloned item to the filePathList
                filePathList.appendChild(clonedItem);
              }
            }
            // Update select options
            /*
            var pathSelector = document.getElementById('pathSelector');
            pathSelector.innerHTML = '<option value="select">⬇️ select</option><option value="back">⬅️ back</option>';
            lvls.forEach((lvl, index) => {
              pathSelector.innerHTML += `<option value="${lvl}">➡️ ${lvl}</option>`;
            });*/
          }).catch(e => console.log(e))











        querySelectorAll1('#filePathList fieldset').forEach(fieldset => {
          fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
        });





      }

      const fieldset = getElementById1('filePathList');
      const fieldset2 = getElementById1('selectedFilePathList');
      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('filePathList')) {
        const clonedFieldset = fieldset.cloneNode(true);
        const clonedFieldset2 = fieldset.cloneNode(true);
        const clonedFieldset3 = getElementById1('file-list-attach-component-options').cloneNode(true);
        clonedFieldset3.removeAttribute('hidden')
        clonedFieldset3.id = 'file-list-attach-component-options;'

        clonedFieldset.id = clonedFieldset.id + ';';
        clonedFieldset2.id = 'selectedFilePathList;';
        clonedFieldset.setAttribute('action', 'Add_Component')
        clonedFieldset3.querySelector('[data-action="moveBack"]').onclick = (e) => {
          const splited = path1.split('/')
          if (path1 === '') {
            return
          }
          else if (splited.length === 2) {
            path1 === ""
            loadFileList1()

          }
          else {
            splited.pop()
            splited.pop()
            path1 = splited.join('/') + '/'
            loadUsingPath1(path1)

          }
        }
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset2);
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset3);

        loadFileList1()

      }

    }
    var addTreeElement = (e) => {
      const fieldset = getElementById1('tag-table');
      console.log('clicked')
      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('tag-table')) {
        const clonedFieldset = fieldset.cloneNode(true);

        const clonedRows = clonedFieldset.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        for (let i = 0; i < clonedRows.length; i++) {
          const index = i; // Capture the current value of 'i' in a closure
          clonedRows[i].onclick = function (event) {
            chooseTag(index, event);
          };
        }
        clonedFieldset.id = clonedFieldset.id + ';' + page_id + '-tree';
        clonedFieldset.setAttribute('action', 'Insert_First')
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
      }

    }
  </script>
  <script>
    function getRelativePath(currentLsi, lsi3) {
      // Split paths into arrays of directories and filenames
      const currentLsiParts = currentLsi.split('/');
      const lsi3Parts = lsi3.split('/');

      // Extract filenames from paths
      const currentFilename = currentLsiParts.pop();
      const lsi3Filename = lsi3Parts.pop();

      // Find the index at which paths diverge
      let divergeIndex = 0;
      while (divergeIndex < Math.min(currentLsiParts.length, lsi3Parts.length) && currentLsiParts[divergeIndex] === lsi3Parts[divergeIndex]) {
        console.log('adding')
        divergeIndex++;
      }
      console.log(currentLsiParts[divergeIndex])
      console.log(lsi3Parts[divergeIndex])
      // Calculate the number of levels to go up from currentLsi to the common directory
      const levelsUp = currentLsiParts.length - divergeIndex;

      // Build the relative path to lsi3
      let relativePath = (levelsUp === 0 ? './' : Array(levelsUp).fill('..').join('/') + '/');
      if (lsi3Parts.length > 0) {
        relativePath += lsi3Parts.slice(divergeIndex).join('/');
      }
      // Append the filename to the relative path
      if (relativePath.endsWith('/')) {
        relativePath += lsi3Filename;
      }


      else {
        relativePath += '/' + lsi3Filename;
      }


      return relativePath;
    }
    var approveAddComponent = async (e) => {
      const m1 = document.getElementById('selectedFilePathList;')


      const ids = Array.from(m1.children).map(e => e.id)
      const optionList = getElementById1('file-list-attach-component-options;')
      let flag
      for (const id of ids) {
        const data = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/' + id + ':path')
          .then(response => response.json())

        if (data.LinkBP || optionList.querySelector('#file-list-link-by-path').classList.contains('b-selected')) {

          const p = convertToOldPath(data.lsi1.split(';')[0]).split('/')
          p.shift()
          const fileName = p.pop()
          let r =''
          if(p.length){
            r = '/'+p.join('/')
          }
          addComponent1("*" +r + '|'+fileName)
        }
        else if (optionList.querySelector('#file-list-link-by-name').classList.contains('b-selected')) {
          const currentLsi = pathItemPath.replace(';publish:published', "")
          const relativePath = getRelativePath(currentLsi,convertToOldPath(data.lsi1.replace(';publish:published', "")));

          await addComponent1("#" + relativePath).catch(e=>console.log(e))
          flag= true
        }
        else {
          addComponent1(id)
        }
        
      }
      flag && location.reload()
      getElementById1('file-list-attach-component-options;').remove()
      getElementById1('filePathList;').remove()
      getElementById1('selectedFilePathList;').remove()
    }
    var approveReplace = async (e) => {
      const m1 = Array.from(e.target.parentNode.children).filter(i => i.id)
      const parentId = e.target.parentNode.id.replace('file-path-list;', '')
      if (!parentId) {
        alert('no target id')
        return
      }
      const parentEl = getElementById1(parentId)
      const replacedString = parentEl.getAttribute('replaced')
      const replaced = replacedString ? JSON.parse(replacedString) : []
      const el = {
        time: (new Date()).getTime(),
        action: 'Replace_Component',
        target_element: [parentId.replace('selectedFilePathList;', ''), ...m1.map(el => {
          const element = getElementById1(el.id);
          return {

            componentId: el.id, id: el.newId || generateUUID(), path: element.querySelector('[data-value="file-path"]').textContent, already: element.getAttribute('alreadyReplaced')
          }
        })],
      };

      await pushAction(el)
      location.reload()
    }
    //file list scripts
    var replaceComponent = (e, flag) => {
      let selected = []
      let path1 = ''
      var addSelected = (id, itemId, path) => {
        const clonedFieldset2 = getElementById1('selectedFilePathList;' + id)
        if (Array.from(clonedFieldset2.children).find(el => el.id === itemId)) {
          return
        }
        var clonedItem = getElementById1('item').cloneNode(true);
        selected.push(itemId)
        clonedItem.id = itemId;
        const file_path = clonedItem.querySelector('[data-value="file-path"]')
        file_path.textContent = path;
        clonedItem.querySelector('#Pushpin').removeAttribute('hidden')
        clonedItem.onclick = (e) => { e.target.closest('li').remove(); selected.filter(el => el !== itemId) }
        clonedFieldset2.appendChild(clonedItem)
        console.log(JSON.stringify(selected))

      }




      var loadUsingPath1 = (id, path) => {
        return fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true&lsi1=' + path1)
          .then(response => response.json())
          .then(data => {
            // Replace existing file paths with dynamic content
            var filePathList = getElementById1('filePathList;' + id);
            filePathList.innerHTML = '';
            lvls = []
            let i = 0
            let folders = []
            const elements = []
            console.log(JSON.stringify(data))
            const items = data.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(path1, '').split(';')[0] } })
            console.log(JSON.stringify(items))
            for (const item of items) {
              const splited = item.name.split(';')[0].split('/')
              if (splited.length > 1) {
                folders.push(splited[0])
              }
              else {
                elements.push({ name: splited[0], ...item })
              }
            }
            folders = removeDuplicates(folders)
            console.log(JSON.stringify(folders))
            console.log(JSON.stringify(elements))

            folders.forEach(item => {


              if (i < 1000) {
                i++
                // Clone the fieldset
                var clonedItem = getElementById1('item').cloneNode(true);

                // Set unique ID for the cloned item
                clonedItem.id = item;

                // Set file path and emoji
                const file_path = clonedItem.querySelector('[data-value="file-path"]')
                file_path.textContent = item;
                clonedItem.onclick = setPath
                let icon = '📂';

                clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

                // Set file ID
                clonedItem.querySelector('[data-value="file-id"]').textContent = item;

                // Set up onclick for file-open button
                function setPath() {
                  path1 = path1 + item + '/'
                  loadUsingPath1(id, path1)
                };

                // Append the cloned item to the filePathList
                filePathList.appendChild(clonedItem);
              }

            });
            elements && elements.forEach(item => {


              if (i < 1000) {
                i++
                // Clone the fieldset
                var clonedItem = getElementById1('item').cloneNode(true);

                // Set unique ID for the cloned item
                clonedItem.id = item.id;

                // Set file path and emoji
                const item_path = clonedItem.querySelector('[data-value="file-path"]')
                item_path.textContent = item.name;
                clonedItem.onclick = function (event) {

                  addSelected(id, item.id, item.lsi1);
                };
                let icon = '🧩';
                if (item.lsi1.startsWith('css')) {
                  icon = '🎨';
                } else if (item.lsi1.startsWith('javascript')) {
                  icon = '💻';
                }
                clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

                // Set file ID
                clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

                clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                  event.stopPropagation()
                  remove(event, item.id);
                };
                // Append the cloned item to the filePathList
                filePathList.appendChild(clonedItem);
              }

            });



          })
          .catch(error => console.error('Error:', error));
      }
      var loadFileList1 = (id) => {
        // Fetch GET request

        fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true')
          .then(response => response.json())
          .then(data => {
            // Replace existing file paths with dynamic content
            var filePathList = getElementById1('filePathList;' + id);
            filePathList.innerHTML = '';
            let i = 0;
            let folders = []
            const elements = []
            console.log(JSON.stringify(data))
            const items = data.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(path1, '').split(';')[0] } })
            console.log('ites' + JSON.stringify(items))
            for (const item of items) {
              const splited = item.name.split(';')[0].split('/')
              if (splited.length > 1) {
                folders.push(splited[0])
              }
              else {
                elements.push({ name: splited[0], ...item })
              }
            }
            folders = removeDuplicates(folders)
            console.log(JSON.stringify(elements))
            folders.forEach(item => {


              if (i < 1000) {
                i++
                // Clone the fieldset
                var clonedItem = getElementById1('item').cloneNode(true);

                // Set unique ID for the cloned item
                clonedItem.id = item;

                // Set file path and emoji
                const file_path = clonedItem.querySelector('[data-value="file-path"]')
                file_path.textContent = item;
                clonedItem.onclick = setPath
                let icon = '📂';

                clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

                // Set file ID
                clonedItem.querySelector('[data-value="file-id"]').textContent = item;

                // Set up onclick for file-open button
                function setPath() {
                  path1 = item + '/'


                  loadUsingPath1(id, path1)
                };

                // Append the cloned item to the filePathList
                filePathList.appendChild(clonedItem);
              }

            });
            elements && elements.forEach(item => {


              if (i < 1000) {
                i++
                // Clone the fieldset
                var clonedItem = getElementById1('item').cloneNode(true);

                // Set unique ID for the cloned item
                clonedItem.id = item.id;

                // Set file path and emoji
                const item_path = clonedItem.querySelector('[data-value="file-path"]')
                item_path.textContent = item.name;
                clonedItem.onclick = function (event) {
                  event.stopPropagation()
                  addSelected(id, item.id, item.lsi1);
                };
                let icon = '🧩';
                if (item.lsi1.startsWith('css')) {
                  icon = '🎨';
                } else if (item.lsi1.startsWith('javascript')) {
                  icon = '💻';
                }
                clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

                // Set file ID
                clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

                // Set up onclick for file-open button

                clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                  event.stopPropagation()
                  remove(event, item.id);
                };
                // Append the cloned item to the filePathList
                filePathList.appendChild(clonedItem);
              }

            });



            // Show the cloned fieldsets
            querySelectorAll1('#filePathList fieldset').forEach(fieldset => {
              fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
            });



            // Update select options

          })
          .catch(error => console.error('Error:', error));

      }
      const splited = e.target.parentNode.id.split(';')
      const path = e.target.parentNode.getAttribute('path')
      const replacedString = e.target.parentNode.getAttribute('replaced')
      const replaced = replacedString ? JSON.parse(replacedString) : undefined
      const [toRemove, ...rest] = splited
      const parentId = splited.length === 1 ? e.target.parentNode.id : rest.join(';')
      const fieldset = getElementById1('filePathList');
      const fieldset2 = getElementById1('selectedFilePathList');
      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('filePathList')) {
        const clonedFieldset = fieldset.cloneNode(true);
        const clonedFieldset2 = fieldset2.cloneNode(true);
        clonedFieldset2.id = clonedFieldset2.id + ';' + parentId;
        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', 'Replace')
        clonedFieldset2.setAttribute('action', 'Replace')
        clonedFieldset2.querySelector('[data-action="moveBack"]').onclick = (e) => {
          const splited = path1.split('/')
          if (path1 === '') {
            return
          }
          else if (splited.length === 2) {
            path1 === ""
            loadFileList1(parentId)

          }
          else {
            splited.pop()
            splited.pop()
            path1 = splited.join('/') + '/'
            loadUsingPath1(parentId, path1)

          }
        }
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset2);
        !flag && e.target.parentNode.remove()
        if (!replaced) {
          var clonedItem = getElementById1('item').cloneNode(true);
          clonedItem.setAttribute('alreadyReplaced', true)
          clonedItem.id = parentId;
          selected.push(parentId)
          const file_path = clonedItem.querySelector('[data-value="file-path"]')
          file_path.textContent = path;
          clonedItem.querySelector('#Pushpin').removeAttribute('hidden')
          clonedFieldset2.appendChild(clonedItem)
          clonedItem.onclick = (e) => { e.target.closest('li').remove(); selected.filter(el => el !== parentId) }
        }
        else {
          for (const el of replaced) {
            var clonedItem = getElementById1('item').cloneNode(true);
            clonedItem.setAttribute('alreadyReplaced', true)
            clonedItem.id = el.componentId;
            clonedItem.setAttribute('newId', el.id)
            selected.push(el.id)
            const file_path = clonedItem.querySelector('[data-value="file-path"]')
            file_path.textContent = el.path;
            clonedItem.querySelector('#Pushpin').removeAttribute('hidden')
            clonedFieldset2.appendChild(clonedItem)
            clonedItem.onclick = (e) => { e.target.closest('li').remove(); selected.filter(el => el !== el.id) }
          }
        }

        loadFileList1(parentId)
      }
    }

  </script>
  <script>
    let path = ''
    let lvls = []
    var removeLastOccurrence = (inputString, substringToRemove) => {
      const lastIndexOfSubstring = inputString.lastIndexOf(substringToRemove);

      if (lastIndexOfSubstring !== -1) {
        // If the substring is found, remove it and return the modified string
        const res = inputString.slice(0, lastIndexOfSubstring) + inputString.slice(lastIndexOfSubstring + substringToRemove.length);
        console.log('OUTPUT ' + res)
        return res
      } else {
        // If the substring is not found, return the original string
        return inputString;
      }
    }

    async function removeAttribute1(event) {
      const saveButton = event.target;
      const checked = saveButton.closest('[data-open-menu]').querySelector('#applyToCopies').checked
      const tr = saveButton.closest('#code-tree-tag-attributes-list-item');

      if (!tr) {
        console.error('Could not find parent tr element');
        return;
      }

      const keyElement = tr.querySelector('#code-tree-tag-attribute-key');
      const key = keyElement.textContent.replace('🔑', '');

      const parentMenu = event.target.closest('.menu-1');

      if (!parentMenu) {
        console.error('Could not find parent menu element');
        return;
      }

      const { id } = parentMenu;
      const action = 'removeAttribute';
      console.log('Action: ' + action);

      const splited = id.split(';');
      const [toRemove, ...rest] = splited;

      const el = {
        time: (new Date()).getTime(),
        action,
        target_element: rest.join(';'),
        key,
      };
      if (checked) {
        el.options = { apply_to_copies: true }
      }
      tr.remove();
      console.log(JSON.stringify(el));
      await pushAction(el);

      console.log(JSON.stringify(actionLog));
    }
    let visualOn = false
    function duplicateId(originalId,) {
      const splited = originalId.split(';');
      const lastId = splited[splited.length - 1]
      let newLastUUID
      const splited2 = lastId.split(':')
      const copyId = generateUUID()
      newLastUUID = splited2[0] + ':' + copyId
      splited.pop()
      return { id: [...splited, newLastUUID].join(';') + '-tree', copyId }

    }

    function transformToVisual(event) {

      localStorage.setItem('visualOn', 'true')
      if (visualOn) {
        localStorage.removeItem('visualOn')
        location.reload()
        return;
      }

      event.target.classList.add('b-selected');
      visualOn = true
      console.log('transforming');
      var generatedPage = getElementById1("generated-page");

      // Process each child element
      var children = generatedPage.children;
      for (var i = 0; i < children.length; i++) {
        processElement(children[i]);
      }

      // Define the function to be removed
      function handleMouseOver(event) {
        if (event.target.hasAttribute('data-visual-element')) {
          event.target.style.backgroundColor = 'pink';
        }
      }

      // Add the event listener
      var iframe = getElementById1("generated-page-iframe");
      var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
      iframeDocument.addEventListener('mouseover', handleMouseOver);


      iframeDocument.addEventListener('mouseout', function (event) {
        if (event.target.hasAttribute('data-visual-element')) {
          event.target.style.backgroundColor = '';

          if (!event.target.getAttribute('style')) {
            event.target.removeAttribute('style');
          }
        }
      });



      function clickRemoveButton(clickEvent) {
        // Check if the clicked element or its ancestor is a button
        const isButton = clickEvent.target.closest('.receive-target');

        // Check if the clicked element or its ancestor has the class 'menu-option'
        const isMenuOption = clickEvent.target.closest('.menu-option');

        if (!isButton && !isMenuOption) {
          // If the clicked element is not a button and not inside an element with class 'menu-option', remove the buttons
          removeButtons();
        }
      }
      const showEditHrefMenu = (target) => {
        const editHref = getElementById1('update-href-menu')
        const cloned = editHref.cloneNode(true)
        cloned.id = cloned.id + ';' + target.id
        cloned.querySelector('#editHrefButton').onclick = async (e) => {
          const inputValue = e.target.parentNode.querySelector('#editHrefInput').value
          const el = {
            time: (new Date()).getTime(),
            action: 'setAttribute',
            target_element: target.id + '-tree',
            key: 'href',
            value: inputValue,

          }
          await pushAction(el)
          e.target.parentNode.remove()

        }
        target.appendChild(cloned)

      }
      function handleContextMenu(e) {
        if (e.target.hasAttribute('data-visual-element')) {
          e.preventDefault(); // Prevent the default context menu from opening
          console.log('in11');
          const menu = getElementById1('right-click-menu'); // Use # for ID selector
          menu.innerHTML = '';
          let siblingsWithDuplicate
          let fieldsetSiblings
          let parentWithAppendChild
          let siblingWithInsertBefore
          console.log('tag ' + e.target.tagName)
          const redirectToImgPage = (imgId, src) => {
            const treeElement = getElementById1(imgId);
            console.log(imgId)
            if (treeElement) {


              const existingClonedFieldset = treeElement.parentNode.querySelector('[id^="gallery-menu-wrapper"]');

              if (!existingClonedFieldset) {
                console.log('cloning fieldset')
                // Clone the fieldset node
                const fieldset = getElementById1('gallery-menu-wrapper');
                const clonedFieldset = fieldset.cloneNode(true);

                // Assign a unique id to the cloned fieldset
                clonedFieldset.id = 'gallery-menu-wrapper;' + imgId + '-tree';

                // image input change 
                clonedFieldset.querySelector('#image-input').addEventListener('change', async function (event) {
                  console.log('changing')
                  var fileNameSpan = clonedFieldset.querySelector('#file-name');

                  var uploadButton = clonedFieldset.querySelector('#upload-button');

                  // Check if a file is selected
                  if (this.files && this.files.length > 0) {
                    // If a file is chosen, show the file name and make the upload button visible
                    var fileName = this.files[0].name; // Get the name of the file
                    fileNameSpan.textContent = fileName; // Set the text content to the file name
                    fileNameSpan.removeAttribute('hidden'); // Make the file name span visible

                    uploadButton.removeAttribute('hidden'); // Make the upload button visible

                    file = event.target.files[0]
                  } else {
                    // If no file is chosen, hide the file name span and the upload button
                    fileNameSpan.hidden = true;
                    uploadButton.hidden = true;
                  }
                })




                loadImages(clonedFieldset, src)
                // Insert the cloned fieldset after the specified element
                treeElement.insertAdjacentElement('afterend', clonedFieldset);


              }

            }
          }
          if (e.target.tagName.toLowerCase() === 'img') {
            addMenuEntry(menu, `🖼️ Edit image`, () => {
              redirectToImgPage(e.target.id, e.target.getAttribute('src'))
            });
          }
          if (e.target.hasAttribute('data-visual-href')) {
            addMenuEntry(menu, `🔗 Edit href`, () => {
              showEditHrefMenu(e.target)
            });
          }
          if (
            e.target.parentElement.id === e.target.id + '-fieldset') {
            // Check for data-visual-duplicate siblings
            console.log('case1')
            siblingsWithDuplicate = Array.from(e.target.parentElement.parentElement.children).filter(
              sibling => sibling.hasAttribute('data-visual-dublicate')
            );

            // Check for fieldset siblings containing data-visual-duplicate elements
            fieldsetSiblings = Array.from(e.target.parentElement.parentElement.children).filter(
              sibling => sibling.tagName === 'FIELDSET' &&
                Array.from(sibling.querySelectorAll('[data-visual-dublicate]')).length > 0
            );
            // Check if parent has data-visual-appendChild
            parentWithAppendChild = e.target.parentElement.parentElement.hasAttribute('data-visual-appendchild') && e.target.parentElement.parentElement;

            // Check sibling for data-visual-insertBefore
            siblingWithInsertBefore = e.target.parentElement.parentElement && Array.from(e.target.parentElement.parentElement.children).filter(
              child => child.hasAttribute('data-visual-insertbefore') || (child.id.endsWith('-fieldset') && child.children[1].hasAttribute('data-visual-insertbefore'))
            );
          }
          else {
            console.log('case2')
            // Check for data-visual-duplicate siblings
            let ids = []
            siblingsWithDuplicate = Array.from(e.target.parentElement.children).filter(

              sibling => {

                if (sibling.hasAttribute('data-visual-dublicate')) {

                  const id = sibling.id
                  const splited = id.split(';')
                  const last = splited[splited.length - 1]
                  const splited2 = last.replace('-tree', '').split(':')
                  const lastId = splited2[0]
                  splited.pop()
                  const toCheck = [...splited, lastId].join(';')
                  if (ids.includes(toCheck)) {
                    return false
                  }
                  ids.push(toCheck)
                  return true
                }
                return false
              }
            );

            // Check for fieldset siblings containing data-visual-duplicate elements
            ids = []
            fieldsetSiblings = Array.from(e.target.parentElement.children).filter(
              sibling => {
                if (sibling.tagName === 'FIELDSET' &&
                  Array.from(sibling.querySelectorAll('[data-visual-dublicate]')).length > 0) {
                  const id = sibling.id
                  const splited = id.split(';')
                  const last = splited[splited.length - 1]
                  const splited2 = last.replace('-tree', '').split(':')
                  const lastId = splited2[0]
                  splited.pop()
                  const toCheck = [...splited, lastId].join(';')
                  if (ids.includes(toCheck)) {
                    return false
                  }
                  ids.push(toCheck)
                  return true
                }
                return false
              }
            );
            // Check if parent has data-visual-appendChild
            parentWithAppendChild = e.target.parentElement.hasAttribute('data-visual-appendchild') && e.target.parentElement;

            // Check sibling for data-visual-insertBefore
            siblingWithInsertBefore = e.target.parentElement && Array.from(e.target.parentElement.children).filter(
              child => child.hasAttribute('data-visual-insertbefore')
            );

          }



          console.log(JSON.stringify([...fieldsetSiblings, ...siblingsWithDuplicate]));



          // Add entries for data-visual-duplicate siblings
          const existingIds = []
          for (const sibling of siblingsWithDuplicate) {
            console.log('taag' + sibling.tagName)
            let name = `➕ ${sibling.tagName.toLowerCase()}`
            if (sibling.hasAttribute('data-visual-title')) {
              name = `➕ ${sibling.getAttribute('data-visual-title')}`
            }
            const splited = sibling.id.split(':')
            splited.length > 1 && splited.pop()

            if (!existingIds.includes(splited.join(':'))) {
              existingIds.push(splited.join(':'))
              addMenuEntry(menu, name, () => {

                handleMenuEntryClick(e.target.id, sibling.id, siblingWithInsertBefore, parentWithAppendChild);


              });
            }
          }

          // Add entries for fieldset siblings
          for (const fieldsetSibling of fieldsetSiblings) {
            let name = `➕ ${fieldsetSibling.children[0].textContent.toLowerCase()}`
            if (fieldsetSibling.hasAttribute('data-visual-title')) {
              name = `➕ ${fieldsetSibling.getAttribute('data-visual-title')}`
            }
            const splited = fieldsetSibling.id.split(':')
            splited.length > 1 && splited.pop()

            if (!existingIds.includes(splited.join(':').replace('-fieldset', ''))) {
              existingIds.push(splited.join(':').replace('-fieldset', ''))
              addMenuEntry(menu, name, () => {

                handleMenuEntryClick(e.target.id, fieldsetSibling.children[1].id, siblingWithInsertBefore, parentWithAppendChild, true);
              });
            }

          }
          console.log('existing ' + JSON.stringify(existingIds))

          // Adjust the position relative to the viewport
          const offsetX = e.pageX;
          const offsetY = e.pageY;

          menu.style.display = 'block';
          menu.style.left = `${offsetX}px`;
          menu.style.top = `${offsetY}px`;

          // Hide the menu when clicking the left mouse button
          window.addEventListener('click', function () {
            menu.style.display = 'none';
          });
          addMenuEntry(menu, `🗑️️ Remove element`, async () => {
            if (findRelatedElements(e.target.id) > 1) {
              await pushAction({
                time: (new Date()).getTime(),
                action: 'removeTag',
                target_element: e.target.id + '-tree',

              })
              const el = getElementById1(e.target.id + '-fieldset')
              if (el) {
                el.remove()
              }
            }
            else {
              console.log('iiid ' + e.target.id)
              const attr = e.target.getAttribute('data-visual-defaultTextNode')
              console.log('attr' + attr)
              e.target.textContent = attr
            }

          }
          );
        }
      }

      function handleMenuEntryClick(sourceId, targetId, siblingWithInsertBefore, parentWithAppendChild, flag) {
        console.log('t');
        console.log(parentWithAppendChild);
        console.log(siblingWithInsertBefore);
        removeButtons()
        const original = getElementById1(sourceId);
        const originalRect = original.getBoundingClientRect();
        var iframe = getElementById1("generated-page-iframe");
        var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
        // Check if siblingWithInsertBefore is present
        if (siblingWithInsertBefore.length > 0) {
          // Insert <button class="receive-target">➕</button> before each siblingWithInsertBefore
          siblingWithInsertBefore.forEach(sibling => {
            const addButton = document.createElement('button');
            addButton.className = 'receive-target';
            addButton.innerHTML = '➕';
            addButton.onclick = function () {
              insertBefore(sibling.id, targetId, flag);
              iframeDocument.removeEventListener('click', clickRemoveButton);
              iframeDocument.addEventListener('mouseover', handleMouseOver);
            };
            iframeDocument.addEventListener('mouseover', handleMouseOver1);
            iframeDocument.addEventListener('mouseout', handleMouseOut1);
            sibling.parentNode.insertBefore(addButton, sibling);
          });
        }

        // Check if parentWithAppendChild is present
        if (parentWithAppendChild) {
          // Append <button class="receive-target">➕</button> to parentWithAppendChild
          const addButton = document.createElement('button');
          addButton.className = 'receive-target';
          addButton.innerHTML = '➕';
          addButton.onclick = function () {
            const children = getElementById1(parentWithAppendChild.id).children;

            let lastFieldsetTreeId = null;

            for (let i = children.length - 1; i >= 0; i--) {
              const child = children[i];
              console.log(child.id)

              if (!child.classList.contains('receive-target')) {
                lastFieldsetTreeId = child.id;
                break; // Found the last matching element, exit the loop
              }
            }

            if (lastFieldsetTreeId !== null) {
              console.log('Last fieldset with id ending in -tree:', lastFieldsetTreeId);
            } else {
              console.log('No matching fieldset with id ending in -tree found.');
            }
            console.log(lastFieldsetTreeId)

            insertAfter(lastFieldsetTreeId, targetId, flag);
            iframeDocument.removeEventListener('click', clickRemoveButton);
            iframeDocument.addEventListener('mouseover', handleMouseOver);
          };
          addButton.addEventListener('mouseover', handleMouseOver1);
          addButton.addEventListener('mouseout', handleMouseOut1);
          parentWithAppendChild.appendChild(addButton);
        }
        iframeDocument.removeEventListener('mouseover', handleMouseOver);
        iframeDocument.addEventListener('click', clickRemoveButton);
        const newElement = getElementById1(sourceId);
        const newRect = newElement.getBoundingClientRect();
        window.scrollTo({
          top: newRect.top - originalRect.top + window.scrollY,
          behavior: 'auto' // You can use 'auto' or 'smooth' for smooth scrolling
        });
        // You can perform additional actions here if needed
      }

      function handleMouseOver1(e) {
        e.target.classList.add('drag-over'); // Add a class to apply hover effect
      }

      function handleMouseOut1(e) {
        e.target.classList.remove('drag-over'); // Remove the class to stop hover effect
      }



      // Example function, adjust as needed
      async function insertBefore(nextElementId, selectedElementId, flag) {
        const actionObject = {
          time: (new Date()).getTime(),
          action: 'InsertBefore',
          target_element: nextElementId.replace('-fieldset', '') + '-tree',
          inserted_element: { originalId: selectedElementId + '-tree', id: duplicateId(selectedElementId).id },
        };
        await pushAction(actionObject, false, flag);
        removeReceiveButtons();
      }

      // Example function, adjust as needed
      async function insertAfter(nextElementId, selectedElementId, flag) {
        const actionObject = {
          time: (new Date()).getTime(),
          action: 'InsertAfter',
          target_element: nextElementId.replace('-fieldset', '') + '-tree',
          inserted_element: { originalId: selectedElementId + '-tree', id: duplicateId(selectedElementId).id },
        };
        await pushAction(actionObject, false, flag);
        removeReceiveButtons();
      }

      // Example function, adjust as needed
      async function append(parentId, selectedElementId, flag) {
        // Perform additional actions if needed
        const actionObject = {
          time: (new Date()).getTime(),
          action: 'Append',
          target_element: parentId + '-tree',
          inserted_element: { originalId: selectedElementId + '-tree', id: duplicateId(selectedElementId).id },
        };
        await pushAction(actionObject, false, flag);
        removeReceiveButtons();
      }


      // Function to remove all elements with the class 'receive-target'
      function removeReceiveButtons() {
        const buttonsToRemove = querySelectorAll1('.receive-target');
        buttonsToRemove.forEach(button => {
          button.parentNode.removeChild(button);
        });
      }
      function moveItem(parentId, selectedElementId, action) {

        // Create a new element (adjust this part based on your requirements)

        // Perform additional actions if needed



        let lastFieldsetTreeId = null;
        let actionObject
        if (action === 'InsertAfter') {
          const children = getElementById1(parentId).children;

          for (let i = children.length - 1; i >= 0; i--) {
            const child = children[i];
            console.log(child.id)
            if (child.tagName === 'FIELDSET' && child.id.endsWith('-fieldset')) {
              lastFieldsetTreeId = child.id;
              break; // Found the last matching element, exit the loop
            }
          }

          if (lastFieldsetTreeId !== null) {
            console.log('Last fieldset with id ending in -tree:', lastFieldsetTreeId);
          } else {
            console.log('No matching fieldset with id ending in -tree found.');
          }


          actionObject = {
            time: (new Date()).getTime(),
            action: action,
            target_element: [{ id: lastFieldsetTreeId.replace('-fieldset', '') + '-tree' }, { id: selectedElementId + '-tree' }],
            move: true,
          }
        }
        else {
          actionObject = {
            time: (new Date()).getTime(),
            action: action,
            target_element: [{ id: parentId.replace('-fieldset', '') + '-tree' }, { id: selectedElementId + '-tree' }],
            move: true,
          }
        }

        pushAction(actionObject);
        // Get a NodeList of all elements with the class 'receive-target'
        const buttonsToRemove = querySelectorAll1('.receive-target');

        // Iterate through the NodeList and remove each button
        buttonsToRemove.forEach(button => {
          button.parentNode.removeChild(button);
        });

      }

      // Utility function to add menu entry
      function findRelatedElements(inputId) {
        // Step 1: Remove the -tree suffix

        // Step 2: If it ends with -copy-x, remove that part
        let modifiedId = removeLastOccurrence(inputId, '-tree');
        const el = getElementById1(modifiedId + '-tree')
        console.log('iiie ' + el.id)
        const tag = el.tagName.toLowerCase()
        const splited = modifiedId.split(';')
        const last = splited[splited.length - 1]
        const lastId = last.split(':')[0]
        splited.pop()
        modifiedId = [...splited, lastId].join(';')
        console.log('modfi ' + modifiedId)
        // Step 3: Query for elements starting with the modified ID
        const selector = '[id^="' + modifiedId + '"]';
        const matchingElements = el.parentNode.querySelectorAll(selector);

        // Step 4: Filter to get only elements that end with -tree
        const filteredElements = Array.from(matchingElements)

        return Array.from(filteredElements).length
      }
      function addMenuEntry(menu, text, clickHandler) {
        const entry = document.createElement('div');
        entry.className = 'menu-option';
        entry.innerHTML = text;
        entry.onclick = async (e) => { await clickHandler(e); menu.style.display = 'none' };
        menu.appendChild(entry);
      }
      function saveT(event, previousValue) {
        const id = event.target.id + '-tree'
        const action = 'textContent'
        console.log('ac' + action)



        const textareaValue = event.target.textContent;
        if (textareaValue === previousValue) {
          event.target.removeAttribute('contenteditable')
          return textareaValue
        }
        if (!textareaValue) {

          if (findRelatedElements(event.target.id) > 1) {
            pushAction({
              time: (new Date()).getTime(),
              action: 'removeTag',
              target_element: id,

            })
            const el = getElementById1(event.target.id + '-fieldset')
            if (el) {
              el.remove()
            }
          }
          else {
            console.log('iiid ' + event.target.id)
            const attr = event.target.getAttribute('data-visual-defaultTextNode')
            console.log('attr' + attr)
            event.target.textContent = attr
          }
          return
        }

        let el = {
          time: (new Date()).getTime(),
          action,
          target_element: id,
          value: textareaValue,

        }

        if (event.target.getAttribute('data-builder-time') === 'dd month yyyy') {
          function formatDate(date) {
            const options = { day: '2-digit', month: 'long', year: 'numeric' };
            const formattedDate = date.toLocaleDateString('en-US', options);
            return formattedDate;
          }
          function formatDateYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
          }
          const date = new Date()
          const fDate = formatDate(date)
          const fDate2 = formatDateYYYYMMDD(date)
          const el1 = {
            time: (new Date()).getTime(),
            action: 'setAttribute',
            target_element: id,
            key: 'datetime',
            value: fDate2,

          }
          pushAction(el1)
          el = {
            time: date.getTime(),
            action,
            target_element: id,
            value: fDate,
          }
        }
        console.log('ac' + JSON.stringify(el))
        pushAction(el)
        event.target.removeAttribute('contenteditable')
        return textareaValue
      }
      function onDoubleClick(e) {
        // Get the element that was double-clicked
        var target = e.target;
        console.log('target ' + target.id)
        // Check if the element has the 'data-visual-contenteditable' attribute

        if (target.hasAttribute('data-visual-contenteditable')) {


          console.log('has attr')
          // Prevent the default double-click behavior
          e.preventDefault();

          // Set the 'contenteditable' attribute to 'true', making the element editable
          target.setAttribute('contenteditable', 'true');

          // Reset the background color of the element
          target.style.backgroundColor = '';

          // Set focus on the editable element
          target.focus();

          let textContent = target.textContent
          target.addEventListener('blur', function (blurEvent) {
            // Call the saveT function when the element loses focus
            textContent = saveT(blurEvent, textContent)
          });
          target.addEventListener('keypress', function (keyPressEvent) {
            if (keyPressEvent.key === 'Enter') {
              keyPressEvent.preventDefault()
              textContent = saveT(keyPressEvent, textContent);
            }
          });
        }
      }
      iframeDocument.addEventListener('dblclick', onDoubleClick);
      // Add an event listener to the entire document to track double-clicks
      iframeDocument.addEventListener('contextmenu', handleContextMenu)
      iframeDocument.addEventListener('change', async function (event) {

        // Check if the target element has the data-visual-checkbox attribute
        if (event.target.hasAttribute('data-visual-checkbox')) {
          // Log the id of the target element and the new value of the checkbox
          console.log('ID:', event.target.id, 'Value:', event.target.checked);
          let el
          if (event.target.checked) {
            el = {
              time: (new Date()).getTime(),
              action: 'setAttribute',
              target_element: event.target.id,
              key: "checked",
              value: 'true',

            }
          }
          else {
            el = {
              time: (new Date()).getTime(),
              action: 'removeAttribute',
              target_element: event.target.id,
              key: "checked"
            }
          }
          await pushAction(el)
        }
      });



      // Function to check if an element has the 'data-visual-draggable' attribute
      function isDraggable(element) {
        return element.hasAttribute('data-visual-draggable');
      }

      function handleDragStart(e) {
        if (isDraggable(e.target)) {

          console.log('draggable');
          removeButtons()
          e.dataTransfer.setData('text/plain', e.target.id);
          const original = getElementById1(e.target.id);
          const originalRect = original.getBoundingClientRect();
          let siblingWithInsertBefore
          let parentWithAppendChild

          if (
            e.target.parentElement.id === e.target.id + '-fieldset') {
            // Check sibling for data-visual-insertBefore
            siblingWithInsertBefore = e.target.parentElement.parentElement && Array.from(e.target.parentElement.parentElement.children).filter(
              child => child.hasAttribute('data-visual-insertbefore') || (child.id.endsWith('-fieldset') && child.children[1].hasAttribute('data-visual-insertbefore'))
            );

            // Check if the parent has data-visual-appendchild
            parentWithAppendChild = e.target.parentElement.parentElement.hasAttribute('data-visual-appendchild') && e.target.parentElement.parentElement;

          }
          else {
            // Check sibling for data-visual-insertBefore
            siblingWithInsertBefore = e.target.parentElement && Array.from(e.target.parentElement.children).filter(
              child => child.hasAttribute('data-visual-insertbefore')
            );

            // Check if the parent has data-visual-appendchild
            parentWithAppendChild = e.target.parentElement.hasAttribute('data-visual-appendchild') && e.target.parentElement;
          }
          siblingWithInsertBefore.forEach(sibling => {
            // Create the "+" button element with data attributes
            const previousSibling = sibling.previousElementSibling;
            if (previousSibling && previousSibling.id.replace('-fieldset', '') === original.id) {
              return;
            }
            if (sibling.id.replace('-fieldset', '') === original.id) {
              return
            }
            const plusButton = createButton('InsertBefore', sibling.id);
            sibling.parentNode.insertBefore(plusButton, sibling);
            addHoverListeners(plusButton);
          });

          if (parentWithAppendChild && parentWithAppendChild.lastElementChild.id !== e.target.id + '-fieldset') {
            // Create the "+" button element with data attributes
            const plusButton = createButton('InsertAfter', parentWithAppendChild.id);
            parentWithAppendChild.appendChild(plusButton);
            addHoverListeners(plusButton);
          }
          const newElement = getElementById1(e.target.id);
          const newRect = newElement.getBoundingClientRect();
          console.log(window.scrollY)
          console.log(newRect.top)
          console.log(originalRect.top)
          window.scrollTo({
            top: newRect.top - originalRect.top + window.scrollY,
            behavior: 'auto' // You can use 'auto' or 'smooth' for smooth scrolling
          });
          // Update the dragover and drop event listeners
          var iframe = getElementById1("generated-page-iframe");
          var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
          iframeDocument.addEventListener('dragover', handleDragOver);
          iframeDocument.addEventListener('drop', handleDrop);
        }
      }

      function createButton(action, elementId) {
        const plusButton = document.createElement('button');
        plusButton.className = 'receive-target';
        plusButton.innerHTML = '➕';
        plusButton.setAttribute('data-action', action);
        plusButton.setAttribute('data-element-id', elementId);
        return plusButton;
      }

      function addHoverListeners(plusButton) {
        plusButton.addEventListener('dragenter', handleDragEnter);
        plusButton.addEventListener('dragleave', handleDragLeave);
      }


      function handleDrop(e) {
        e.preventDefault();

        const draggedElementId = e.dataTransfer.getData('text/plain');
        const targetElementId = e.target.getAttribute('data-element-id');
        const action = e.target.getAttribute('data-action');

        // Log the element id and target element id
        console.log(`Element ID: ${draggedElementId}, Target Element ID: ${targetElementId} action ${action}`);
        if (targetElementId) {
          moveItem(targetElementId, draggedElementId, action)
        }

        // Remove the drag-over class from the target element
        if (e.target.classList.contains('receive-target')) {
          e.target.classList.remove('drag-over');
        }


        removeButtons()
        // Reset the dragover and drop event listeners
        document.removeEventListener('dragover', handleDragOver);
        document.removeEventListener('drop', handleDrop);
      }

      function removeButtons() {
        // Remove the "+" button after logging the information
        const plusButtons = querySelectorAll1('.receive-target');
        plusButtons.forEach(button => button.parentNode.removeChild(button));
      }

      function handleDragOver(e) {
        e.preventDefault();

        // Add the drag-over class to the target element
        if (e.target.classList.contains('receive-target')) {
          e.target.classList.add('drag-over');
        }
      }

      function handleDragEnter(e) {
        e.preventDefault();

        // Add the drag-over class to the target element
        if (e.target.classList.contains('receive-target')) {
          e.target.classList.add('drag-over');
        }
      }

      function handleDragLeave(e) {
        // Remove the drag-over class from the target element
        if (e.target.classList.contains('receive-target')) {
          e.target.classList.remove('drag-over');
        }
      }

      iframeDocument.addEventListener('dragstart', handleDragStart);
      visualOn = true
    }

    function processElement(element) {
      // Check if the element has the data-visual-draggable attribute
      if (element.hasAttribute("data-visual-draggable")) {
        // Apply draggable logic here
        element.draggable = true;
      }
      // Check if the element has the data-visual-border attribute
      if (element.hasAttribute("data-visual-border")) {
        // Create a new fieldset element
        var fieldset = document.createElement("fieldset");

        // Set the id of the fieldset to be the id of the original element + "-fieldset"
        fieldset.id = element.id + "-fieldset";
        fieldset.className = "tag-fs";

        // Create a legend element with the content of data-visual-title attribute
        var legend = document.createElement("legend");
        legend.className = "comment";
        legend.textContent = element.getAttribute("data-visual-title");

        // Append the legend to the fieldset
        fieldset.appendChild(legend);

        // Replace the current element with the new fieldset
        element.parentNode.replaceChild(fieldset, element);
        fieldset.appendChild(element);

        // Process nested children
        var nestedChildren = element.children;
        for (var i = 0; i < nestedChildren.length; i++) {
          processElement(nestedChildren[i]);
        }
      } else {
        // Process nested children if the element doesn't have the attribute
        var children = element.children;
        for (var i = 0; i < children.length; i++) {
          processElement(children[i]);
        }
      }
    }
    function handlePathSelection() {
      // Get the selected value from the pathSelector
      var selectedValue = getElementById1('pathSelector').value;
      console.log(selectedValue)
      // Get the corresponding item based on the selected value
      var selectedItem = selectedValue

      // Handle the selected item as needed
      console.log('Selected Item:', selectedItem);
      if (selectedItem === 'select' || selectedItem === undefined) {
        return
      }
      if (selectedItem === 'back') {
        if (path === '') {
          return
        }
        const splited = path.split('/')
        if (splited.length === 1) {
          loadFileList()
          return
        }
        splited.pop()
        path = splited.join('/')
        loadUsingPath()
        return
      }
      if (path === '') {
        path = selectedItem
      }
      else {
        path = path + '/' + selectedItem

      }
      console.log(path)
      loadUsingPath()

    }
    function selectFile(event, fileId, name) {
      // Add logic to handle the selected file, if needed
      console.log('File selected with ID:', fileId);
      var el = event.target;

      // Get the parent fieldset
      var fieldset = el.closest('fieldset');

      // Get the id and action attributes
      var fieldsetId = fieldset.id;
      var fieldsetAction = fieldset.getAttribute('action');

      // Log the id and action attributes (you can replace this with your desired logic)
      console.log("Fieldset ID:", fieldsetId);
      console.log("Fieldset Action:", fieldsetAction);
      const actionObject = {
        time: (new Date()).getTime(),
        action: 'Add_Component',
        subAction: fieldsetAction,
        target_element: fieldsetId.split(';')[1],
        inserted_component: { componentId: fileId, id: generateUUID() },
      };
      pushAction(actionObject);
      // Remove the parent fieldset
      fieldset.remove();
    }
    function loadFileList() {
      // Fetch GET request
      fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true')
        .then(response => response.json())
        .then(data => {
          // Replace existing file paths with dynamic content
          var fileListTable = getElementById1('code-tree-tag-attributes-form-attributes-list');
          fileListTable.innerHTML = '';

          let i = 0;
          data.items.forEach(item => {

            if (!lvls.includes(item.lsi1.split('/')[0])) {
              lvls.push(item.lsi1.split('/')[0])
            }
            if (i < 25) {
              i++
              // Clone the fieldset
              var newRow = fileListTable.insertRow();
              newRow.innerHTML = `
  <td><button onclick="selectFile(event,'${item.id}','${item.lsi1.split(';')[0]}')">✅select</button></td>
  <td>📂 ${item.lsi1}</td>
  <td><label>🧩</label></td>
`;
            }

          });

          // Show the cloned fieldsets
          querySelectorAll1('#filePathList fieldset').forEach(fieldset => {
            fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
          });



          // Update select options

        })
        .catch(error => console.error('Error:', error));

    }
    const loadUsingPath = () => {
      return fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true&lsi1=' + path)
        .then(response => response.json())
        .then(data => {
          // Replace existing file paths with dynamic content
          var fileListTable = getElementById1('code-tree-tag-attributes-form-attributes-list');
          fileListTable.innerHTML = '';
          lvls = []
          let i = 0
          data.items.forEach(item => {

            if (!lvls.includes(item.lsi1.replace(path + '/', '').split('/')[0])) {
              lvls.push(item.lsi1.replace(path + '/', '').split('/')[0])
            }
            if (i < 25) {
              i++
              var newRow = fileListTable.insertRow();
              newRow.innerHTML = `
  <td><button onclick="selectFile(event,'${item.id}')">✅select</button></td>
  <td>📂 ${item.lsi1}</td>
  <td><label>🧩</label></td>
`;
            }

          });

          // Show the cloned fieldsets
          querySelectorAll1('#filePathList fieldset').forEach(fieldset => {
            fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
          });



          // Update select options

        })
        .catch(error => console.error('Error:', error));
    }
  </script>
  <script>
    var memData = {}
    //third menu 
    const addNew = (e) => {
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('tag-table');

      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('tag-table')) {
        const clonedFieldset = fieldset.cloneNode(true);

        const clonedRows = clonedFieldset.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        for (let i = 0; i < clonedRows.length; i++) {
          const index = i; // Capture the current value of 'i' in a closure
          clonedRows[i].onclick = function (event) {
            chooseTag(index, event);
          };
        }
        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', e.target.parentNode.getAttribute('action'))
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
      }
    }
    const addExisting = (e) => {
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('code-tree-append-or-insert-approv-menu');
      const checked = e.target.parentNode.getAttribute('copiesOfInserting')
      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('code-tree-append-or-insert-approv-menu')) {
        const clonedFieldset = fieldset.cloneNode(true);

        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        const action = e.target.parentNode.getAttribute('action')
        clonedFieldset.setAttribute('action', action)
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
        // Get all fieldsets with data-element="code-tree-tag"
        var codeTreeTagFieldsets = querySelectorAll1('fieldset[data-element="code-tree-tag"]');
        var checkbox1 = clonedFieldset.querySelector('#code-tree-menu-copies-too');
        var checkbox2 = clonedFieldset.querySelector('#code-tree-menu-dublicate-with-parent-option');

        checkbox1.addEventListener('change', (e) => {
          checkbox1.checked ? checkbox2.parentNode.removeAttribute('hidden') : checkbox2.parentNode.setAttribute('hidden', '')
        })
        /*
        if (checkbox1 && action === 'InsertBefore') {
clonedFieldset.querySelector('#code-tree-menu-dublicate-with-parent-option-1').setAttribute('hidden', "");
clonedFieldset.querySelector('#code-tree-menu-dublicate-with-parent-option-2').setAttribute('hidden', "");
checkbox1.setAttribute('hidden', "");
        }*/
        // Iterate through each fieldset and make their checkboxes visible
        codeTreeTagFieldsets.forEach(function (fieldset) {
          var checkbox = fieldset.querySelector('input[type="checkbox"]');
          if (checkbox) {
            checkbox.removeAttribute('hidden');
          }
        });
      }

    }
    const choseComponent = async (e) => {
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('code-tree-tag-attributes-form');

      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('code-tree-tag-attributes-form')) {
        const clonedFieldset = fieldset.cloneNode(true);

        clonedFieldset.id = clonedFieldset.id + ';' + parentId;

        clonedFieldset.setAttribute('action', e.target.parentNode.getAttribute('action'))
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        await loadFileList()
        e.target.parentNode.remove()
        // Get all fieldsets with data-element="code-tree-tag"

      }
    }


  </script>


  <script>
    var actionLog = []
    var selected = []
    var components = []
    function toggleSubFields(event) {
      // Get the clicked button and its content
      const button = event.target;
      const buttonContent = button.innerHTML;

      // Get the parent fieldset
      const parentFieldset = button.closest('fieldset[data-element="code-tree-tag"]');

      if (parentFieldset) {
        // Find all sub fieldsets inside the parent fieldset
        const subFieldsets = parentFieldset.querySelectorAll('fieldset[data-element="code-tree-tag"]');

        // Check if there are sub fieldsets
        if (subFieldsets.length > 0) {
          // Toggle the visibility of sub fieldsets
          subFieldsets.forEach(subFieldset => {
            subFieldset.hidden = !subFieldset.hidden;
          });

          // Toggle the button content
          button.innerHTML = buttonContent === '→' ? '↓' : '→';
        }
      }
    }
    function handleCheckboxChange(event) {
      var checkbox = event.target;
      var fieldsetId = checkbox.parentNode.id;

      if (checkbox.checked) {
        // Add the ID to the selected array
        selected.push(fieldsetId);
      } else {
        // Remove the ID from the selected array
        var index = selected.indexOf(fieldsetId);
        if (index !== -1) {
          selected.splice(index, 1);
        }
      }

      // Update the content of the span with the length of the selected array
      var amountSelectedSpan = getElementById1('code-tree-amount-selected-for-append-or-insert');
      if (amountSelectedSpan) {
        amountSelectedSpan.textContent = selected.length;
      }

      // Log the selected array (you can replace this with your desired logic)
      console.log("Selected Fieldsets:", selected);
      var arrowButton = checkbox.parentNode.querySelector('[data-element="code-tree-show-hide-button"]');
      if (checkbox.checked) {
        arrowButton.textContent = '↓';
      }
      else {
        arrowButton.textContent = '→';
      }
      // Hide all subfieldsets and enable their checkboxes
      hideSubFieldsets(checkbox.parentNode, checkbox.checked);
    }
    function hideSubFieldsets(parentFieldSet, hide) {
      // Get all fieldsets with data-element="code-tree-tag" under the specified parent
      var subFieldsets = parentFieldSet.querySelectorAll('fieldset[data-element="code-tree-tag"]');

      // Iterate through each subfieldset and toggle visibility
      subFieldsets.forEach(function (subFieldset) {
        // Toggle visibility using the hidden attribute
        subFieldset.hidden = hide;

        // Enable or disable the checkbox based on the hide parameter
        var subCheckbox = subFieldset.querySelector('input[type="checkbox"]');
        if (subCheckbox) {
          subCheckbox.disabled = false;
        }

        // If hiding, remove the subFieldsetId from the selected array
        if (hide) {
          var subFieldsetId = subFieldset.id;
          var index = selected.indexOf(subFieldsetId);
          if (index !== -1) {
            selected.splice(index, 1);
          }
        }


      });
    }
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0,
          v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    async function deleteAction(e) {

      event.preventDefault();

      // Access the parent element of the clicked button
      const parentRow = event.target.closest('tr');

      if (parentRow) {
        // Find the span with id "code-log-action-time" within the parent element
        //delete action from db
        deleteActionFromDb(parentRow)
        parentRow.remove();
      }


      //regenerate page
    }
    function deleteActionFromLog(row) {
      row.remove()
      //add remove to next
    }
    async function deleteActionFromDb(parentRow) {
      const actionTimeElement = parentRow.querySelector('#code-log-action-time');

      if (actionTimeElement) {
        // Retrieve the action time value
        const actionTime = actionTimeElement.getAttribute('sk');

        // Construct the URL for the delete request
        const urlSearchParams = new URLSearchParams(window.location.search);
        const id = urlSearchParams.get('id');
        const deleteUrl = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${id}:${actionTime}`;

        try {
          // Send the delete request using the fetch API
          const response = await fetch(deleteUrl, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              // Add any additional headers if needed
            },
            // You can include a request body if necessary
            // body: JSON.stringify({ action: actionName }),
          });

          if (response.ok) {
            // Delete was successful, you can handle the response or perform additional actions
            console.log('Action deleted successfully');
          } else {
            // Delete request failed, handle the error
            console.error('Error deleting action:', response.statusText);
          }
        } catch (error) {
          // An error occurred while processing the request
          console.error('Error:', error.message);
        }
      }
    }
    const pushAction = async (element, firstLoad, visual, replaceActions, containerId, noComp1, noSubComp1, lvl, removeActions, replaceId, componentPath, pathForRelative) => {
      console.log('pushed' + JSON.stringify(element))
      const time = element.time
      console.log('time' + time)
      actionLog.push(element)
      !firstLoad && await pushActionToDb(element)
      if (element.action !== 'Replace_Component') {
        let ac = element.action
        if (ac === "Add_Component") {
          if (element.inserted_component.componentId.startsWith('*')) {
            ac = "Add_Component_Absolute"
          }
          else if (element.inserted_component.componentId.startsWith('#')) {
            ac = "Add_Component_Relative"
          }
          else {
            ac = "Add_Component_Id"
          }
        }
        await insertDataIntoCodeLog(time, ac, element.options)
      }


      await executeCommand(element, '', visual, replaceActions, containerId, noComp1, noSubComp1, lvl, removeActions, replaceId, componentPath, pathForRelative)
    }
    const pushActionToDb = async (action) => {
      const urlSearchParams = new URLSearchParams(window.location.search);
      const id = urlSearchParams.get('id');
      const sk = action.time.toString()
      delete action.time
      const payload = { ...action, sk, id };



      // Send a POST request using fetch
      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });

      // Ensure the request was successful (status code 2xx)
      if (!response.ok) {
        throw new Error(`Failed to push action to the database. Status: ${response.status}`);
      }

      // Parse and log the response or handle it as needed
      const responseData = await response.json();
    }
    function formatEpochTime(epoch) {
      // Convert epoch time to milliseconds
      const date = new Date(parseInt(epoch));

      // Get the day, month, year, hours, and minutes
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear();
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');

      // Format the date string
      const formattedDate = `${day}.${month}.${year} ${hours}:${minutes}`;

      return formattedDate;
    }

    function insertDataIntoCodeLog(actionTime, actionName, options, inserted_component) {
      const originalElement = getElementById1("code-log-element");
      const clonedElement = originalElement.cloneNode(true);
      clonedElement.removeAttribute('hidden')
      // Remove the unwanted button from the cloned element
      const removeButtonCell = originalElement.querySelector("[data-type-code-log='action-remove']");
      if (removeButtonCell) {
        //removeButtonCell.parentNode.removeChild(removeButtonCell);
      }

      // Set the content and attributes for the cloned element
      clonedElement.removeAttribute("hidden");
      clonedElement.querySelector("#code-log-action-time").textContent = formatEpochTime(actionTime);
      clonedElement.querySelector("#code-log-action-time").setAttribute('sk', actionTime)
      if (inserted_component) {
        console.log('iiiiiiiiiiin0')
        clonedElement.querySelector("#code-log-action").textContent = '🧩' + inserted_component.name;
      }
      else {

        if (options) {
          const optionsStrings = []
          options.apply_to_copies && optionsStrings.push('✅⧉ Apply to copies')
          options.insert_copies && optionsStrings.push('🚂⧉ Insert Copies')
          options.dub_target && optionsStrings.push('🎯⧉ Dup Target')
          const optionString = optionsStrings.join('&#013;&#010;')
          clonedElement.querySelector("#code-log-action").setAttribute('data-tooltip', optionString)
          let emoji = "1️⃣"
          if (optionsStrings.length === 2) {
            emoji = '2️⃣'
          }
          else if (optionsStrings.length === 3) {
            emoji = '3️⃣'
          }
          clonedElement.querySelector("#code-log-action").textContent = actionName + emoji;
        }
        else {
          clonedElement.querySelector("#code-log-action").removeAttribute('data-tooltip')
          clonedElement.querySelector("#code-log-action").textContent = actionName;
        }
      }

      // Get the parent of the original element
      const parent = originalElement.parentNode;

      // Insert the cloned element before the original element
      parent.insertBefore(clonedElement, originalElement);
    }
    function removeTextNodes(element) {
      for (let i = 0; i < element.childNodes.length; i++) {
        const node = element.childNodes[i];
        if (node.nodeType === Node.TEXT_NODE) {
          element.removeChild(node);
        }
      }
    }
    let pauseExecution = false
    const executeCommand = async (command, path, visual, replaceActions, containerId, noComp1, noSubComp1, lvl, removeActions, replaceId, componentPath, pathForRelative) => {

      if (pauseExecution) {
        return
      }
      let { options, subAction, noSubComp, noComp, time, withParent, move, action, target_element, insertedCode, tag_change, inserted_element, key, value, inserted_component, check_b } = command;
      let treeElement
      let componentElement

      console.log('command is ' + JSON.stringify(command) + ' replace id ' + replaceId + 'pathForRelative ' + pathForRelative?.current)
      function handleAppendOrInsert(action, selectedArrayNotSorted, move, insert_copies) {
        // Sort

        console.log('start')
        var firstElementId = selectedArrayNotSorted[0];
        var restOfElements = selectedArrayNotSorted.slice(1);
        const removeSelected = (arr) => {
          for (const el of arr) {
            console.log('1- ' + el)
            const treeEl = getElementById1(el)
            const box = treeEl?.querySelector('#selectedCheckbox')
            if (box) {
              console.log('d55')
              box.checked = false
            }
          }
        }
        removeSelected(restOfElements)
        if (components.includes(firstElementId.replace('-tree', ''))) {
          console.log('in555')
          const target = getElementById1(firstElementId)
          for (const el of restOfElements) {
            const toM = getElementById1(el)
            if (action === 'Append') {
              target.append(toM)
            }
            else {
              target.parentNode.insertBefore(toM, target)
            }
          }
          return

        }
        // Sort the rest of the elements by their order in the DOM
        function sortByPlace(a, b) {
          var elementA = getElementById1(a);
          var elementB = getElementById1(b);
          console.log('prob66 ' + a)
          return Array.from(elementA.parentElement.children).indexOf(elementA) -
            Array.from(elementB.parentElement.children).indexOf(elementB);
        }
        function sortByPlace1(a, b) {
          var elementA = a
          var elementB = b

          return Array.from(elementA.parentElement.children).indexOf(elementA) -
            Array.from(elementB.parentElement.children).indexOf(elementB);
        }
        console.log(JSON.stringify(restOfElements))
        restOfElements.sort(sortByPlace);
        if (!move && !insert_copies) {
          restOfElements = restOfElements.map(el => removeLastOccurrence(el, '-tree')).map(el =>
            getWithoutCopyId1(el)
          )
          console.log('rest ELS' + JSON.stringify(restOfElements))
          restOfElements = removeDuplicates(restOfElements)
        }

        // Combine the sorted array with the first element
        var selectedArray = [firstElementId, ...restOfElements];

        // Find the target fieldset based on the ID
        var targetElementId = selectedArray[0];
        console.log('selected' + JSON.stringify(selectedArray))
        // Find the target fieldset based on the ID


        const handle = (targetFieldset, targetFieldset2, flag) => {
          console.log('target id' + targetFieldset?.id + targetFieldset2?.id)
          console.log('handling')
          console.log('handling move' + move)
          // Get the parent fieldset of the target
          var parentFieldset = targetFieldset.parentNode;
          var parentFieldset2 = targetFieldset2?.parentNode

          const data_replaceid = targetFieldset2.getAttribute('data-replaceID')
          // Get the index of the target fieldset within its parent
          var index = Array.from(parentFieldset.children).indexOf(targetFieldset);
          var index2 = Array.from(parentFieldset2.children).indexOf(targetFieldset2);
          const treeEls = []
          const compEls = []
          // Iterate through the selected array (skipping the first element, which is the target)
          for (var i = 1; i < selectedArray.length; i++) {
            var selectedId = selectedArray[i].id;
            var originalId = selectedArray[i].originalId
            console.log(JSON.stringify(selectedArray[i]))
            if (!move && !insert_copies) {
              console.log('not moving' + JSON.stringify(selectedArrayNotSorted))
              const attr = data_replaceid
              const l = selectedId.split(';').length
              // Find all elements based on the selected ID and its replacement
              var selectedElements = []
              var selectedElements2 = []
              function getContainer() {
                return document
                return containerId ? getElementById1(containerId) : document
              }
              querySelectorAll1('[id^="' + selectedId.split(':')[0] + '"]').forEach(el => {
                if ((!attr || attr === el.getAttribute('data-replaceID')) && !el.id.endsWith('-tree') && !el.id.endsWith('-fieldset')) {
                  selectedElements.push(getElementById1(el.id + '-tree'));
                  selectedElements2.push(el)
                }

              });
              console.log('ppp ' + Array.from(selectedElements).map(e => e?.id))
              console.log('ppp ' + Array.from(selectedElements2).map(e => e?.id))

              selectedElements = selectedElements.filter(el => el.id.split(';').length === l)
              selectedElements2 = selectedElements2.filter(el => el.id.split(';').length === l)
              treeEls.push(...selectedElements)
              compEls.push(...selectedElements2)
              // Iterate through each selected element and process it

            }
            else {
              console.log('moving')
              selectedId = selectedArray[i]
              const treeEl = getElementById1(selectedId)
              let pageEl = getElementById1(removeLastOccurrence(selectedId, '-tree') + '-fieldset')
              if (!pageEl) {
                console.log('true11')
                pageEl = getElementById1(removeLastOccurrence(selectedId, '-tree'))
              }



              var clonedFieldset = cloneWithDescendants(treeEl);
              var arrowButton = clonedFieldset.querySelector('[data-element="code-tree-show-hide-button"]');

              arrowButton.textContent = '→';
              var clonedFieldset2 = cloneWithDescendants(pageEl);
              if (action === 'Append') {
                targetFieldset.appendChild(clonedFieldset);
                if (targetFieldset2.parentNode.id.startsWith(targetFieldset2.id)) {
                  targetFieldset2.parentNode.appendChild(clonedFieldset2);
                }
                else {
                  targetFieldset2.appendChild(clonedFieldset2);
                }

              } else if (action === 'InsertBefore') {

                parentFieldset.insertBefore(clonedFieldset, parentFieldset.children[index]);
                index++; // Increment the index to maintain the correct order
                if (targetFieldset2.parentNode.id.startsWith(targetFieldset2.id)) {
                  console.log('5655')
                  parentFieldset2.parentNode.insertBefore(clonedFieldset2, parentFieldset2);
                }
                else {
                  console.log('5777')
                  console.log(targetFieldset2.parentNode.id)
                  console.log(targetFieldset2.id)
                  parentFieldset2.insertBefore(clonedFieldset2, parentFieldset2.children[index2]);
                }

                index2++; // Increment the index to maintain the correct order
              }


              treeEl.remove();
              pageEl.remove()
            }
          }
          console.log('eels12' + JSON.stringify(treeEls.map(e => e.id)))
          if (!move && !insert_copies) {
            if (treeEls.length) {
              treeEls.sort(sortByPlace1)
              compEls.sort(sortByPlace1)
              for (const selectedFieldset of treeEls) {
                console.log('found 11' + selectedFieldset.id)
                var clonedFieldset = cloneWithDescendants(selectedFieldset);
                var arrowButton = clonedFieldset.querySelector('[data-element="code-tree-show-hide-button"]');

                arrowButton.textContent = '→';
                // Insert the cloned fieldset based on the action
                if (action === 'Append') {
                  targetFieldset.appendChild(clonedFieldset);
                } else if (action === 'InsertBefore') {

                  parentFieldset.insertBefore(clonedFieldset, parentFieldset.children[index]);
                  index++; // Increment the index to maintain the correct order
                }

                // Remove the original fieldset
                selectedFieldset.remove();
              }
              for (const selectedFieldset2 of compEls) {
                // Clone the selected fieldset and its descendants
                var clonedFieldset2 = cloneWithDescendants(selectedFieldset2);

                // Insert the cloned fieldset based on the action
                if (action === 'Append') {
                  targetFieldset2.appendChild(clonedFieldset2);
                } else if (action === 'InsertBefore') {


                  parentFieldset2.insertBefore(clonedFieldset2, parentFieldset2.children[index2]);
                  index2++; // Increment the index to maintain the correct order
                }

                // Remove the original fieldset
                selectedFieldset2.remove();
              }
            }
            else {
              const s = []
              const s1 = []
              console.log('sss' + selectedArrayNotSorted[1])
              querySelectorAll1('[id^="' + selectedArrayNotSorted[1].replace('-tree', '').split(':')[0] + '"]').forEach(el => {
                console.log('eel' + el.id)
                if (!el.id.endsWith('-tree') && !el.id.endsWith('-fieldset')) {
                  s.push(getElementById1(el.id + '-tree'));
                  s1.push(el)
                }

              });
              console.log('sss' + JSON.stringify(s))
              console.log('sss' + JSON.stringify(s1))
              const selectedFieldset = s[0]
              const selectedFieldset2 = s1[0]

              var clonedFieldset = cloneWithDescendants(selectedFieldset);
              var arrowButton = clonedFieldset.querySelector('[data-element="code-tree-show-hide-button"]');

              arrowButton.textContent = '→';
              // Insert the cloned fieldset based on the action

              var clonedFieldset2 = cloneWithDescendants(selectedFieldset2);
              if (!flag) {
                const splited = clonedFieldset2.id.split(':')
                splited.pop()
                const newId = [...splited, generateUUID()].join(':')
                clonedFieldset2.id = newId
                clonedFieldset.id = newId + '-tree'
              }
              // Insert the cloned fieldset based on the action
              if (action === 'Append') {
                targetFieldset2.appendChild(clonedFieldset2);
                targetFieldset.appendChild(clonedFieldset);
              } else if (action === 'InsertBefore') {


                parentFieldset2.insertBefore(clonedFieldset2, parentFieldset2.children[index2]);
                index2++; // Increment the index to maintain the correct order
                parentFieldset.insertBefore(clonedFieldset, parentFieldset.children[index]);
                index++; // Increment the index to maintain the correct order
              }

              // Remove the original fieldset
              flag && selectedFieldset2.remove();
              // Remove the original fieldset
              flag && selectedFieldset.remove();
            }

          }
        }
        if (getElementById1(targetElementId)) {
          var targetFieldset = getElementById1(targetElementId);

          var targetFieldset2 = getElementById1(removeLastOccurrence(targetElementId, '-tree'));
          handle(targetFieldset, targetFieldset2)
        }
        else {
          console.log('target not found')
          let treeEls = []
          let compEls = []
          const mId = targetElementId.replace('-tree', '').split(':')[0]
          console.log('miiid' + mId)
          const already = []
          querySelectorAll1('[id^="' + mId + '"]').forEach(
            el => {
              if (!el.id.endsWith('-tree') && !el.id.endsWith('-fieldset') && !already.includes(el.getAttribute('data-replaceid'))) {
                treeEls.push(getElementById1(el.id + '-tree'));
                compEls.push(el)
                already.push(el.getAttribute('data-replaceid'))
              }
            }
          );
          for (let i = treeEls.length - 1; i >= 0; i--) {
            console.log('el pushed 1' + treeEls[i].id)
            handle(treeEls[i], compEls[i], i === 0)
          }
        }

      }


      function recursivelyChangeIDs(element, newID, flag, treeType) {
        if (!element) return; // Base case: stop if element is null
        if (treeType) {
          !flag && element.tagName.toLowerCase() === "fieldset" && (element.id = newID + ';' + element.id);
        }
        // Change ID of the current element
        else {
          !flag && (element.id = newID + ';' + element.id);
        }


        // Recursively change IDs of child elements
        Array.from(element.children).forEach(child => {
          recursivelyChangeIDs(child, newID, false, treeType);
        });
      }
      function cloneWithDescendants(element) {
        var clone = element.cloneNode(true);
        var clonedSubFieldsets = clone.querySelectorAll('fieldset[data-element="code-tree-tag"]');
        clonedSubFieldsets.forEach(function (clonedSubFieldset) {
          clonedSubFieldset.hidden = false;
        });
        const buttons = clone.querySelectorAll("[data-element='code-tree-show-hide-button']");

        buttons.forEach(function (button) {
          button.addEventListener('mouseover', mouseOverTree);
          button.addEventListener('mouseout', mouseOutTree);
        });


        return clone;
      }
      console.log("action" + action)
      const getWithoutCopyId = (id) => {
        const splited = id.split(';');
        const splited2 = splited[splited.length - 1].replace('-tree', '').split(':')
        splited.pop()
        const processed1 = [...splited, splited2[0]].join(';')
        return processed1
      }
      const getWithoutCopyId1 = (id) => {
        const splited = id.split(';');
        const splited2 = splited[splited.length - 1].replace('-tree', '').split(':')
        const copyId = splited.pop()
        const processed1 = [...splited, splited2[0]].join(';')
        return { id: processed1, originalId: id }
      }
      function getAbsolutePath(currentPath, relativePath) {
        // Split current path and relative path into arrays of directories and filename
        const currentPathParts = currentPath.split('/');
        const relativePathParts = relativePath.split('/');

        // Extract filename from the relative path
        const relativeFilename = relativePathParts.pop();
        currentPathParts.pop()
        // Handle "./" in relative path
        if (relativePathParts[0] === '.') {
          relativePathParts.shift(); // Remove the first element (".")
        }

        // Handle "../" in relative path
        while (relativePathParts[0] === '..') {
          currentPathParts.pop(); // Remove the last element from the current path
          relativePathParts.shift(); // Remove the first element ("..")
        }

        // Combine current path and relative path parts
        const combinedPath = currentPathParts.concat(relativePathParts).join('/');

        // Append the relative filename
        const absolutePath = combinedPath + '|' + relativeFilename;

        return absolutePath;
      }
      !path && (path = '')
      switch (action) {

        case 'Add_Component':

          if (inserted_component.componentId.startsWith('*')) {
            const site = pathItemPath.split('/')[0]
            const modId = inserted_component.componentId.replace('*', '')
            const lsi = site + modId
            const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:'+localStorage.getItem('ownerid')+'&gsi1lsi1=true&lsi1=' + lsi)
              .then(response => response.json())
            console.log('lsi to search'+lsi)
            console.log('lsis'+items.map(i => i.lsi1))
            const item1 = items.find(i => i.lsi1.replace(';publish:published', '') === lsi)
            inserted_component.componentId = item1.id
          }
          else if (inserted_component.componentId.startsWith('#')) {
            let cPath = pathForRelative.current || pathItemPath
            cPath = cPath.replace(';publish:published', "")
            console.log('cpath ' + cPath)


            const relative = inserted_component.componentId.replace('#', '')
            const absolutePath = getAbsolutePath(cPath, relative);


            const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:'+localStorage.getItem('ownerid')+'&gsi1lsi1=true&lsi1=' + absolutePath)
              .then(response => response.json())
            console.log('lsi' + absolutePath)
            console.log(JSON.stringify(items))
            console.log(absolutePath)
            const item1 = items.find(i => i.lsi1.replace(';publish:published', '') === absolutePath)
            console.log(JSON.stringify(item1))
            inserted_component.componentId = item1.id
          }

          const removeAction = removeActions?.find(e => e.target_element === inserted_component.id + '-tree')
          if (removeAction) {
            console.log('found 115')
            return
          }
          const replaceAction = replaceActions?.findLast(e => e.target_element[0] === inserted_component.id + '-tree')

          //replace
          console.log('selected Actions' + JSON.stringify(replaceAction))
          treeElement = getElementById1(target_element);
          //component
          componentElement = getElementById1('generated-page');


          //const newEl = document.createElement("component");
          //newEl.id = inserted_component.id;
          //console.log('comp idddd' + newEl.id);

          // Check if componentElement and its parent node are valid
          if (componentElement) {
            // Insert newEl as the first child of the parent node
            //componentElement.insertBefore(newEl, componentElement.firstChild);
          } else {
            console.error("Invalid componentElement or parent node.");
          }

          const component_el = getElementById1('component-element')
          const newEl2 = component_el.cloneNode(true)
          const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
          button2.textContent = '🧩' + inserted_component.id;
          const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
          button.addEventListener('mouseover', mouseOverTree);

          button.addEventListener('mouseout', mouseOutTree);

          newEl2.id = inserted_component.id + '-tree'
          if (noSubComp1 || noComp || noComp1) {
            newEl2.setAttribute('hidden', '')
          }
          if (subAction === 'Append') {
            treeElement.append(newEl2);
          } else if (subAction === 'InsertBefore') {
            treeElement.parentNode.insertBefore(newEl2, treeElement)
          } else {
            treeElement.parentNode.append(newEl2);
          }


          console.log('prob' + inserted_component.componentId)
          components.push(inserted_component.id)
          const level = lvl ? lvl + 1 : 1;
          console.log('foundlvl ' + lvl)
          if (replaceAction) {
            await insertDataIntoCodeLog(replaceAction.sk, replaceAction.action, replaceAction.options)
            console.log('replace action in')
            const toReplace = replaceAction.target_element[0]
            replaceAction.target_element.shift()
            const dontReplaceIndex = replaceAction.target_element.findIndex(e => e.componentId === toReplace)

            let l = replaceAction.target_element.filter(e => e.componentId !== toReplace);
            let i = false;

            console.log('solving ' + JSON.stringify(l))
            for (const el of l) {

              await executeCommand({
                time,
                action: 'InsertAfter',
                target_element: toReplace,
                inserted_component: el,
                noComp: true,
                noSubComp: i
              }, path, visual, replaceActions, undefined, noComp1, noSubComp1, level, removeActions, el.id, undefined, pathForRelative)
              i = true

            }
            /*
            if (dontReplaceIndex === -1) {
              const elementsToRemove = querySelectorAll1(`[id^="${removeLastOccurrence(toReplace, '-tree') + ';'}"]`);
              elementsToRemove.forEach(element => element.remove());
            }*/
            const el = getElementById1(toReplace)
            el.setAttribute('replaced', JSON.stringify(replaceAction.target_element))
            const el2 = el.querySelector('[data-element="optional-script"]')
            el2.removeAttribute('hidden')
            el2.innerHTML = `🔄${replaceAction.target_element.length}`;
          }
          console.log('calling path for relative ' + pathForRelative)
          await loadFromDb(inserted_component.componentId, inserted_component.id, path, command.sk, replaceActions, replaceAction, noComp1 || noComp, noSubComp1, level, removeActions, replaceId, pathForRelative)


          break;
        case 'Insert_First':
          treeElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
            getElementById1('code-tree')
            : getElementById1(target_element)
          //component

          componentElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
            getElementById1('generated-page')
            : getElementById1(removeLastOccurrence(target_element, '-tree'));
          const newEle = document.createElement(inserted_element.tagName)
          console.log('no comp val' + noComp1)
          console.log('replaceid1 ' + replaceId)
          noComp1 && newEle.setAttribute('data-replaceID', replaceId)
          newEle.id = inserted_element.id
          console.log(newEle.id)
          componentElement.insertBefore(newEle, componentElement.firstChild);
          const component_ele = getElementById1('tree-element')
          const newEle2 = component_ele.cloneNode(true)
          const button22 = newEle2.querySelector("[data-element='code-tree-tag-name-button']")
          button22.textContent = '🏷️' + inserted_element.tagName;
          const button11 = newEle2.querySelector("[data-element='code-tree-show-hide-button']")
          button11.addEventListener('mouseover', mouseOverTree);

          button11.addEventListener('mouseout', mouseOutTree);

          newEle2.id = inserted_element.id + '-tree'
          treeElement.insertBefore(newEle2, treeElement.firstChild);
          break;

        case 'InsertAfter':
          if (inserted_component) {
            //fieldset
            if (inserted_component.componentId.startsWith('*')) {
              const site = pathItemPath.split('/')[0]
              const modId = inserted_component.componentId.replace('*', '')
              const lsi = site + modId
              const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true&lsi1=' + lsi)
                .then(response => response.json())
              const item1 = items.find(i => i.lsi1.replace(';publish:published', '') === lsi)
              inserted_component.componentId = item1.id
            }
            else if (inserted_component.componentId.startsWith('#')) {
              let cPath = pathForRelative.prev || pathItemPath
              cPath = cPath.replace(';publish:published', "")
              console.log('cpath ' + cPath)


              const relative = inserted_component.componentId.replace('#', '')
              const absolutePath = getAbsolutePath(cPath, relative);


              const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true&lsi1=' + absolutePath)
                .then(response => response.json())
              console.log('lsi' + absolutePath)
              console.log(JSON.stringify(items))

              const item1 = items.find(i => i.lsi1.replace(';publish:published', '') === absolutePath)
              console.log(JSON.stringify(item1))
              inserted_component.componentId = item1.id
            }
            console.log('in')
            console.log(target_element)
            treeElement = getElementById1(target_element);
            //component
            //componentElement = getElementById1(removeLastOccurrence(target_element, '-tree'));
            //const newEl = document.createElement("div")
            //newEl.id = inserted_component.id
            //console.log(newEl.id)
            //componentElement.appendChild(newEl)
            const component_el = getElementById1('component-element')
            const newEl2 = component_el.cloneNode(true)
            const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
            button2.textContent = '🧩' + inserted_component.name;
            const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
            button.addEventListener('mouseover', mouseOverTree);

            button.addEventListener('mouseout', mouseOutTree);

            newEl2.id = inserted_component.id + '-tree'
            if (noComp || noComp1) {
              console.log('no comp true')
              newEl2.setAttribute('hidden', '')
            }
            treeElement.insertAdjacentElement('afterend', newEl2);
            components.push(inserted_component.id)
            console.log(inserted_component.componentId)
            console.log('insert before replace id ' + replaceId)
            await loadFromDb(inserted_component.componentId, inserted_component.id, path, inserted_component.name, replaceActions, false, noComp || noComp1, noSubComp, lvl, removeActions, replaceId, { current: pathForRelative.prev, prev: pathForRelative.prev })
            break;
          }
          function insertAfter(newNode, referenceNode) {
            if (referenceNode.nextSibling) {
              referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
            } else {
              referenceNode.parentNode.appendChild(newNode);
            }
          }

          //case duplicate insert after  
          if (inserted_element?.originalId) {
            console.log('insert1' + JSON.stringify(command));
            // fieldset
            treeElement = getElementById1(inserted_element?.originalId);
            // component
            componentElement = getElementById1(removeLastOccurrence(inserted_element.originalId, '-tree'));

            // Duplicate the element
            const newEl = componentElement.cloneNode(true);
            //newEl.textContent = newEl.tagName.toLowerCase();
            // Set the id of the duplicated element to inserted_element.id
            newEl.id = removeLastOccurrence(inserted_element.id, '-tree');
            if (newEl.hasAttribute('data-visual-defaultTextNode') && newEl.hasAttribute('data-visual-element')) {
              // Set child's text content to its content
              newEl.innerText = newEl.getAttribute('data-visual-defaultTextNode')
            }
            console.log(newEl.id);

            // Append the duplicated element to the componentElement
            const compEl = getElementById1(removeLastOccurrence(target_element, '-tree'))
            if (visual) {
              insertAfter(newEl, compEl.parentNode);
              processElement(newEl);
            } else {
              insertAfter(newEl, compEl);
            }


            const newId1 = newEl.id.split(':')[newEl.id.split(':').length - 1]

            if (treeElement) {
              // Duplicate the treeElement content
              const newEl2 = treeElement.cloneNode(true);

              // Set the id of the duplicated treeElement to inserted_element.id + '-tree'
              newEl2.id = inserted_element.id;

              // Update the button text in the duplicated treeElement
              const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']");

              // Attach event listeners to the buttons in the duplicated treeElement
              const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']");
              button.addEventListener('mouseover', mouseOverTree);
              button.addEventListener('mouseout', mouseOutTree);
              const trEl = getElementById1(target_element)
              // Append the duplicated treeElement to the treeElement's parent
              insertAfter(newEl2, trEl);
              updateChildIdsRecursive(newEl2, newId1, true);
            }


            function updateChildIdsRecursive(element, newId1, tree) {
              const processed = []
              element.querySelectorAll('[id]').forEach(child => {
                const splited = child.id.split(';');
                const splited2 = splited[splited.length - 1].replace('-tree', '').split(':')
                let newSubId = splited2[0] + ':' + newId1
                tree && (newSubId = newSubId + '-tree')
                splited.pop()
                const processed1 = [...splited, splited2[0]].join(';')
                if (processed.find(el => el.startsWith(processed1))) {
                  console.log('status' + processed1)
                  console.log('status2' + JSON.stringify(processed))
                  child.remove()
                }
                else {
                  processed.push(processed1)
                  console.log('proce' + processed1)
                  child.id = [...splited, newSubId].join(';')
                  if (child.hasAttribute('data-visual-defaultTextNode') && child.hasAttribute('data-visual-element')) {
                    // Set child's text content to its content
                    child.innerText = child.getAttribute('data-visual-defaultTextNode')
                  }
                  // Recursively update ids for child's children
                  updateChildIdsRecursive(child, newId1, tree);
                }

              });
            }

            // Update ids of child elements within the duplicated elements recursively
            updateChildIdsRecursive(newEl, newId1);


            break;
          }
          if (target_element?.length) {
            const afterId = target_element[0].id;
            const id = target_element[1].id;
            console.log(id)
            console.log(afterId)
            const aftertreeElement = getElementById1(afterId);
            let aftercomponentElement = getElementById1(removeLastOccurrence(afterId, '-tree') + '-fieldset') ||
              getElementById1(removeLastOccurrence(afterId, '-tree'));

            const treeElement = getElementById1(id);
            let componentElement = getElementById1(removeLastOccurrence(id, '-tree') + '-fieldset') ||
              getElementById1(removeLastOccurrence(id, '-tree'));

            if (aftertreeElement && treeElement) {
              // Move treeElement after aftertreeElement
              insertAfter(treeElement, aftertreeElement);
            }

            if (aftercomponentElement && componentElement) {
              // Move componentElement after aftercomponentElement
              insertAfter(componentElement, aftercomponentElement);
            }
          }

          break;

        case 'Add_Parent':
          const handleInsertParent = (treeElement, componentElement, replaceCopyId, apply_to_copies) => {
            console.log('handling' + treeElement + ' ' + componentElement + ' ' + replaceCopyId)

            const newEl = document.createElement(inserted_element.tagName)
            componentElement.replaceWith(newEl);
            newEl.appendChild(componentElement)

            const attr1 = componentElement.getAttribute('data-replaceID')
            if (attr1) {
              newEl.setAttribute('data-replaceID', attr1)
            }
            if (noComp || noComp1) {
              newEl.setAttribute('data-replaceID', replaceId)
            }


            const splited = componentElement.id.split(';')


            const copyId = splited[splited.length - 1].split(':')[1]


            console.log(newEl.id)

            const component_el = getElementById1('tree-element')
            const newEl2 = component_el.cloneNode(true)
            const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
            button2.textContent = '🏷️' + inserted_element.tagName;
            if (replaceCopyId) {
              newEl2.id = inserted_element.id.split(':')[0] + ':' + componentElement.getAttribute('data-replaceid') + '-tree'
            } else if (apply_to_copies) {
              if (copyId) {
                newEl2.id = inserted_element.id.split(':')[0] + ':' + copyId + '-tree'
              }
              else {
                newEl2.id = inserted_element.id + '-tree'
              }
            }
            else {
              newEl2.id = inserted_element.id + '-tree'
            }

            newEl.id = removeLastOccurrence(newEl2.id, '-tree')


            if (componentElement.hasAttribute('data-parentid')) {
              console.log('in12')


              newEl.id = componentElement.id.split(';')[0] + ';' + newEl.id
              newEl2.id = componentElement.id.split(';')[0] + ';' + newEl2.id
            }

            else if (splited.length > 1) {
              newEl.id = splited[0] + ';' + newEl.id
              newEl2.id = splited[0] + ';' + newEl2.id
            }
            console.log(newEl.id)
            treeElement.replaceWith(newEl2);
            newEl2.appendChild(treeElement)
            const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
            button.addEventListener('mouseover', mouseOverTree);

            button.addEventListener('mouseout', mouseOutTree);
            if (componentElement.contains(newEl)) {
              console.log(newEl.id + ' was created and appended successfully.');
            } else {
              console.error('Failed to create or append newEl.');
            }


          }
          const apply_to_copies = options?.apply_to_copies
          treeElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
            getElementById1('code-tree')
            : getElementById1(target_element)
          //component
          componentElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
            getElementById1('generated-page')
            :
            getElementById1(removeLastOccurrence(target_element, '-tree'));
          if (apply_to_copies) {
            console.log('inSL')
            const mId = target_element.replace('-tree', '').split(':')[0]
            const treeEls = []
            const compEls = []
            const existing = []
            const elementsWithIdAndAttribute = querySelectorAll1('[id^="' + mId + '"]')
              .forEach(
                el => {
                  if (el.id.endsWith('tree')) {
                    return
                  }
                  console.log('ffooound152 ' + el.id)

                  treeEls.push(getElementById1(el.id + '-tree'));
                  compEls.push(el)


                }
              );

            for (let i = 0; i < treeEls.length; i++) {
              handleInsertParent(treeEls[i], compEls[i], false, true)
            }
            break;
          }
          if (!componentElement) {
            console.log('comp not found')
            const mId = target_element.replace('-tree', '').split(':')[0]
            const treeEls = []
            const compEls = []
            const existing = []
            const elementsWithIdAndAttribute = querySelectorAll1('[id^="' + mId + '"][data-replaceid]')
              .forEach(
                el => {
                  console.log('ffooound152 ' + el.id)
                  if (!existing.includes(el.getAttribute('data-replaceid'))) {
                    existing.push(el.getAttribute('data-replaceid'))
                    treeEls.push(getElementById1(el.id + '-tree'));
                    compEls.push(el)
                  }

                }
              );

            for (let i = 0; i < treeEls.length; i++) {
              handleInsertParent(treeEls[i], compEls[i], true)
            }
            break;
          }
          console.log('handling insert')

          handleInsertParent(treeElement, componentElement)


          break;

        case 'Append':
          // Handle the 'Append' action
          if (options?.dub_target) {
            // get all copies 
            const handleWithParent = async (id, items) => {
              console.log('input 6' + JSON.stringify(items))
              const [firstId, ...restIds] = items
              for (const el of restIds) {


                async function append(parentId, selectedElementId, flag) {
                  console.log('parent id' + parentId)
                  console.log('el id' + selectedElementId)
                  const { id, copyId } = duplicateId(selectedElementId)
                  // Perform additional actions if needed
                  let actionObject
                  if (getElementById1(selectedElementId + '-tree').nextElementSibling) {
                    actionObject = {
                      time: (new Date()).getTime(),
                      action: 'InsertBefore',
                      target_element: getElementById1(selectedElementId + '-tree').nextElementSibling.id,
                      inserted_element: { originalId: selectedElementId + '-tree', id },
                    };
                  }
                  else {
                    actionObject = {
                      time: (new Date()).getTime(),
                      action: 'Append',
                      target_element: getElementById1(selectedElementId + '-tree').parentNode.id,
                      inserted_element: { originalId: selectedElementId + '-tree', id },
                    };
                  }

                  await executeCommand(actionObject, path, visual);
                  return { t: actionObject.inserted_element.id, copyId }
                }

                const { t, copyId } = await append(removeLastOccurrence(getElementById1(id).parentNode.id, '-tree'), removeLastOccurrence(id, '-tree'))

                await executeCommand({
                  time: (new Date()).getTime(),
                  action: 'Append',
                  target_element: [{ type: 'tag', id: t, }, { type: 'tag', id: el, }],
                  move: true
                }, path, visual);
                console.log('main2' + JSON.stringify([{ type: 'tag', t, }, { type: 'tag', id: el, }]))
              }
              console.log('main1' + JSON.stringify([{ type: 'tag', id, }, { type: 'tag', id: firstId, }]))
              await executeCommand({
                time: (new Date()).getTime(),
                action: 'Append',
                target_element: [{ type: 'tag', id, }, { type: 'tag', id: firstId, }],
                move: true
              }, path, visual);
            }
            const id = target_element[0].id
            target_element.shift()
            let restOfElements = target_element.map(el => removeLastOccurrence(el.id, '-tree')).map(el =>
              getWithoutCopyId(el))
            restOfElements = removeDuplicates(restOfElements)
            if (getElementById1(id)) {





              const items = []
              for (const element of restOfElements) {
                const l = element.split(';').length
                querySelectorAll1('[id^="' + element + '"]').forEach(el => {
                  el.id.endsWith('-tree') && el.id.split(';').length === l && items.push(el.id)
                });
              }
              console.log('iteeems' + JSON.stringify(items))

              handleWithParent(id, items)
            }
            else {
              console.log('prob555')
              const mId = getWithoutCopyId(id)
              let copies = querySelectorAll1('[id^="' + mId + '"]')

              const already = []
              for (const element of copies) {
                if (element.id.endsWith('-tree') || element.id.endsWith('-fieldset')) {
                  continue
                }
                const replaceId = element.getAttribute('data-replaceid')
                console.log('replace id + ' + replaceId)
                const items = []

                for (const element of restOfElements) {
                  const l = element.split(';').length
                  querySelectorAll1('[id^="' + element + '"]').forEach(el => {
                    !el.id.endsWith('-fieldset') && !el.id.endsWith('-tree') && el.id.split(';').length === l && el.getAttribute('data-replaceid') === replaceId && items.push(el.id + '-tree')
                  });
                }
                console.log('prob items 1 ' + JSON.stringify(items))
                const found = items.find(item => !already.find(i => i === item))
                console.log(found)
                already.push(found)
                handleWithParent(element.id + '-tree', items)
              }
            }

            break;
          }
          if (inserted_component) {
            //fieldset
            console.log('in')
            console.log(target_element)
            treeElement = getElementById1(target_element);
            //component

            const component_el = getElementById1('component-element')
            const newEl2 = component_el.cloneNode(true)
            const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
            button2.textContent = '🧩' + inserted_component.id;
            const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
            button.addEventListener('mouseover', mouseOverTree);

            button.addEventListener('mouseout', mouseOutTree);

            newEl2.id = inserted_component.id + '-tree'

            treeElement.appendChild(newEl2)
            console.log('prob' + inserted_component.componentId)
            components.push(inserted_component.id)
            console.log('err ' + path)
            await loadFromDb(inserted_component.componentId, inserted_component.id, path, command.sk, false, noComp1 || noComp)
            break;
          }
          //case duplicate append
          if (inserted_element?.originalId) {
            console.log('insert2' + JSON.stringify(command));
            // fieldset
            treeElement = getElementById1(inserted_element?.originalId);
            // component
            componentElement = getElementById1(removeLastOccurrence(inserted_element.originalId, '-tree'));

            // Duplicate the element
            let newEl = componentElement.cloneNode(true);
            if (newEl.hasAttribute('data-visual-defaultTextNode') && newEl.hasAttribute('data-visual-element')) {
              // Set child's text content to its content
              newEl.innerText = newEl.getAttribute('data-visual-defaultTextNode')
            }
            // Set the id of the duplicated element to inserted_element.id
            newEl.id = removeLastOccurrence(inserted_element.id, '-tree');
            console.log(newEl.id);

            // Append the duplicated element to the componentElement
            if (visual) {
              getElementById1(removeLastOccurrence(target_element, '-tree')).parentNode.appendChild(newEl);
              processElement(newEl)
            }
            else {
              getElementById1(removeLastOccurrence(target_element, '-tree')).appendChild(newEl);
            }
            //processElement(newEl)
            // Duplicate the treeElement content
            const newEl2 = treeElement.cloneNode(true);

            // Set the id of the duplicated treeElement to inserted_element.id + '-tree'
            newEl2.id = inserted_element.id;

            // Update the button text in the duplicated treeElement
            const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']");

            // Attach event listeners to the buttons in the duplicated treeElement
            const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']");
            button.addEventListener('mouseover', mouseOverTree);
            button.addEventListener('mouseout', mouseOutTree);

            // Append the duplicated treeElement to the treeElement's parent

            getElementById1(target_element).appendChild(newEl2);

            const newId1 = newEl.id.split(':')[newEl.id.split(':').length - 1]
            function updateChildIdsRecursive(element, newId1, tree) {
              const processed = []
              element.querySelectorAll('[id]').forEach(child => {
                const splited = child.id.split(';');
                const splited2 = splited[splited.length - 1].replace('-tree', '').split(':')
                let newSubId = splited2[0] + ':' + newId1
                tree && (newSubId = newSubId + '-tree')
                splited.pop()
                const processed1 = [...splited, splited2[0]].join(';')
                if (processed.find(el => el.startsWith(processed1))) {
                  console.log('status' + processed1)
                  console.log('status2' + JSON.stringify(processed))
                  child.remove()
                }
                else {
                  processed.push(processed1)
                  console.log('proce' + processed1)
                  child.id = [...splited, newSubId].join(';')
                  if (child.hasAttribute('data-visual-defaultTextNode') && child.hasAttribute('data-visual-element')) {
                    // Set child's text content to its content
                    child.innerText = child.getAttribute('data-visual-defaultTextNode')
                  }
                  // Recursively update ids for child's children
                  updateChildIdsRecursive(child, newId1, tree);
                }

              });
            }

            // Update ids of child elements within the duplicated elements recursively
            updateChildIdsRecursive(newEl, newId1);
            updateChildIdsRecursive(newEl2, newId1, true);
            break;
          }
          //case insert tag
          if (inserted_element?.tagName) {




            const handleInsert = (treeElement, componentElement, replaceCopyId) => {
              console.log('handling' + treeElement + ' ' + componentElement + ' ' + replaceCopyId)
              const newEl = document.createElement(inserted_element.tagName)
              componentElement.appendChild(newEl)

              const attr1 = componentElement.getAttribute('data-replaceID')
              if (attr1) {
                newEl.setAttribute('data-replaceID', attr1)
              }
              if (noComp || noComp1) {
                newEl.setAttribute('data-replaceID', replaceId)
              }


              const splited = componentElement.id.split(';')






              newEl.id = replaceCopyId ? inserted_element.id.split(':')[0] + ':' + componentElement.getAttribute('data-replaceid') : inserted_element.id

              console.log(newEl.id)

              const component_el = getElementById1('tree-element')
              const newEl2 = component_el.cloneNode(true)
              const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
              button2.textContent = '🏷️' + inserted_element.tagName;

              newEl2.id = replaceCopyId ? inserted_element.id.split(':')[0] + ':' + componentElement.getAttribute('data-replaceid') + '-tree' : inserted_element.id + '-tree'
              if (componentElement.hasAttribute('data-parentid')) {
                console.log('in12')


                newEl.id = componentElement.id.split(';')[0] + ';' + newEl.id
                newEl2.id = componentElement.id.split(';')[0] + ';' + newEl2.id
              }

              else if (splited.length > 1) {
                newEl.id = splited[0] + ';' + newEl.id
                newEl2.id = splited[0] + ';' + newEl2.id
              }
              console.log(newEl.id)
              treeElement.appendChild(newEl2)
              const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
              button.addEventListener('mouseover', mouseOverTree);

              button.addEventListener('mouseout', mouseOutTree);
              if (componentElement.contains(newEl)) {
                console.log(newEl.id + ' was created and appended successfully.');
              } else {
                console.error('Failed to create or append newEl.');
              }


            }

            treeElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
              getElementById1('code-tree')
              : getElementById1(target_element)
            //component
            componentElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
              getElementById1('generated-page')
              :
              getElementById1(removeLastOccurrence(target_element, '-tree'));
            if (!componentElement) {
              console.log('comp not found')
              const mId = target_element.replace('-tree', '').split(':')[0]
              const treeEls = []
              const compEls = []
              const existing = []
              const elementsWithIdAndAttribute = querySelectorAll1('[id^="' + mId + '"][data-replaceid]')
                .forEach(
                  el => {
                    console.log('ffooound152 ' + el.id)
                    if (!existing.includes(el.getAttribute('data-replaceid'))) {
                      existing.push(el.getAttribute('data-replaceid'))
                      treeEls.push(getElementById1(el.id + '-tree'));
                      compEls.push(el)
                    }

                  }
                );

              for (let i = 0; i < treeEls.length; i++) {
                handleInsert(treeEls[i], compEls[i], true)
              }
              break;
            }
            console.log('handling insert')

            handleInsert(treeElement, componentElement)


            break;




          }
          if (target_element.length) {
            console.log('movestat ' + move)
            handleAppendOrInsert('Append', target_element.map(i => i.id), move)
          }
          break;

        case 'InsertBefore':
          // Handle the 'InsertBefore' action
          // Handle the 'Append' action
          //fieldset
          if (options?.dub_target) {
            // get all copies 
            const handleWithParent = async (id, items) => {
              console.log('input 6' + JSON.stringify(items))
              const [firstId, ...restIds] = items
              for (const el of restIds) {


                async function append(parentId, selectedElementId, flag) {
                  console.log('parent id' + parentId)
                  console.log('el id' + selectedElementId)
                  const { id, copyId } = duplicateId(selectedElementId)
                  // Perform additional actions if needed
                  let actionObject
                  if (getElementById1(selectedElementId + '-tree').nextElementSibling) {
                    actionObject = {
                      time: (new Date()).getTime(),
                      action: 'InsertBefore',
                      target_element: getElementById1(selectedElementId + '-tree').nextElementSibling.id,
                      inserted_element: { originalId: selectedElementId + '-tree', id },
                    };
                  }
                  else {
                    actionObject = {
                      time: (new Date()).getTime(),
                      action: 'Append',
                      target_element: getElementById1(selectedElementId + '-tree').parentNode.id,
                      inserted_element: { originalId: selectedElementId + '-tree', id },
                    };
                  }

                  await executeCommand(actionObject, path, visual);
                  return { t: actionObject.inserted_element.id, copyId }
                }

                const { t, copyId } = await append(removeLastOccurrence(getElementById1(id).parentNode.id, '-tree'), removeLastOccurrence(id, '-tree'))

                await executeCommand({
                  time: (new Date()).getTime(),
                  action: 'InsertBefore',
                  target_element: [{ type: 'tag', id: t, }, { type: 'tag', id: el, }],
                  move: true
                }, path, visual);
                console.log('main2' + JSON.stringify([{ type: 'tag', t, }, { type: 'tag', id: el, }]))
              }
              console.log('main1' + JSON.stringify([{ type: 'tag', id, }, { type: 'tag', id: firstId, }]))
              await executeCommand({
                time: (new Date()).getTime(),
                action: 'InsertBefore',
                target_element: [{ type: 'tag', id, }, { type: 'tag', id: firstId, }],
                move: true
              }, path, visual);
            }
            const id = target_element[0].id
            target_element.shift()
            let restOfElements = target_element.map(el => removeLastOccurrence(el.id, '-tree')).map(el =>
              getWithoutCopyId(el))
            restOfElements = removeDuplicates(restOfElements)
            if (getElementById1(id)) {





              const items = []
              for (const element of restOfElements) {
                const l = element.split(';').length
                querySelectorAll1('[id^="' + element + '"]').forEach(el => {
                  el.id.endsWith('-tree') && el.id.split(';').length === l && items.push(el.id)
                });
              }
              if (!items.length) {
                for (const element of restOfElements) {
                  const mId = getWithoutCopyId(element)
                  console.log('miiid ' + mId)
                  querySelectorAll1('[id^="' + mId + '"]').forEach(el => {
                    console.log('dddd ' + el.id)
                    el.id.endsWith('-tree') && el.id.split(';').length === l && items.push(el.id)
                  });
                }
              }
              console.log('iteeems' + JSON.stringify(items))

              handleWithParent(id, items)
            }
            else {
              console.log('prob555')
              const mId = getWithoutCopyId(id)
              let copies = querySelectorAll1('[id^="' + mId + '"]')

              const already = []
              for (const element of copies) {
                if (element.id.endsWith('-tree') || element.id.endsWith('-fieldset')) {
                  continue
                }
                const replaceId = element.getAttribute('data-replaceid')
                console.log('replace id + ' + replaceId)
                const items = []

                for (const element of restOfElements) {
                  const l = element.split(';').length
                  querySelectorAll1('[id^="' + element + '"]').forEach(el => {
                    !el.id.endsWith('-fieldset') && !el.id.endsWith('-tree') && el.id.split(';').length === l && el.getAttribute('data-replaceid') === replaceId && items.push(el.id + '-tree')
                  });
                }
                console.log('prob items 1 ' + JSON.stringify(items))
                const found = items.find(item => !already.find(i => i === item))
                console.log(found)
                already.push(found)
                handleWithParent(element.id + '-tree', items)
              }
            }
            break;
          }
          if (inserted_component) {
            //fieldset
            if (inserted_component.componentId.startsWith('*')) {
              const site = pathItemPath.split('/')[0]
              const modId = inserted_component.componentId.replace('*', '')
              const lsi = site + modId
              const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true&lsi1=' + lsi)
                .then(response => response.json())
              const item1 = items.find(i => i.lsi1.replace(';publish:published', '') === lsi)
              inserted_component.componentId = item1.id
            }
            else if (inserted_component.componentId.startsWith('#')) {
              let cPath = pathForRelative.prev || pathItemPath
              cPath = cPath.replace(';publish:published', "")
              console.log('cpath ' + cPath)


              const relative = inserted_component.componentId.replace('#', '')
              const absolutePath = getAbsolutePath(cPath, relative);


              const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path&gsi1lsi1=true&lsi1=' + absolutePath)
                .then(response => response.json())
              console.log('lsi' + absolutePath)
              console.log(JSON.stringify(items))

              const item1 = items.find(i => i.lsi1.replace(';publish:published', '') === absolutePath)
              console.log(JSON.stringify(item1))
              inserted_component.componentId = item1.id
            }
            console.log('in')
            console.log(target_element)
            treeElement = getElementById1(target_element);
            //component
            //componentElement = getElementById1(removeLastOccurrence(target_element, '-tree'));
            //const newEl = document.createElement("div")
            //newEl.id = inserted_component.id
            //console.log(newEl.id)
            //componentElement.appendChild(newEl)
            const component_el = getElementById1('component-element')
            const newEl2 = component_el.cloneNode(true)
            const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
            button2.textContent = '🧩' + inserted_component.name;
            const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
            button.addEventListener('mouseover', mouseOverTree);

            button.addEventListener('mouseout', mouseOutTree);

            newEl2.id = inserted_component.id + '-tree'
            if (noComp || noComp1) {
              console.log('no comp true')
              newEl2.setAttribute('hidden', '')
            }
            treeElement.parentNode.insertBefore(newEl2, treeElement)
            components.push(inserted_component.id)
            console.log(inserted_component.componentId)
            console.log('insert before replace id ' + replaceId)
            await loadFromDb(inserted_component.componentId, inserted_component.id, path, inserted_component.name, replaceActions, false, noComp || noComp1, noSubComp, lvl, removeActions, replaceId, { current: pathForRelative.prev, prev: pathForRelative.prev })
            break;
          }
          //case duplicate insert before
          if (inserted_element?.originalId) {
            console.log('insert1' + JSON.stringify(command));
            // fieldset
            treeElement = getElementById1(inserted_element?.originalId);
            // component
            componentElement = getElementById1(removeLastOccurrence(inserted_element.originalId, '-tree'));

            // Duplicate the element
            const newEl = componentElement.cloneNode(true);
            //newEl.textContent = newEl.tagName.toLowerCase();
            // Set the id of the duplicated element to inserted_element.id
            newEl.id = removeLastOccurrence(inserted_element.id, '-tree');
            if (newEl.hasAttribute('data-visual-defaultTextNode') && newEl.hasAttribute('data-visual-element')) {
              // Set child's text content to its content
              newEl.innerText = newEl.getAttribute('data-visual-defaultTextNode')
            }
            console.log(newEl.id);

            // Append the duplicated element to the componentElement
            const compEl = getElementById1(removeLastOccurrence(target_element, '-tree'))
            if (visual) {
              compEl.parentNode.parentNode.insertBefore(newEl, compEl.parentNode);
              processElement(newEl)
            }
            else {
              compEl.parentNode.insertBefore(newEl, compEl);
            }
            const newId1 = newEl.id.split(':')[newEl.id.split(':').length - 1]
            if (treeElement) {
              // Duplicate the treeElement content
              const newEl2 = treeElement.cloneNode(true);

              // Set the id of the duplicated treeElement to inserted_element.id + '-tree'
              newEl2.id = inserted_element.id;

              // Update the button text in the duplicated treeElement
              const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']");

              // Attach event listeners to the buttons in the duplicated treeElement
              const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']");
              button.addEventListener('mouseover', mouseOverTree);
              button.addEventListener('mouseout', mouseOutTree);
              const trEl = getElementById1(target_element)
              // Append the duplicated treeElement to the treeElement's parent
              treeElement.parentNode.insertBefore(newEl2, trEl)

              updateChildIdsRecursive(newEl2, newId1, true);
            }

            function updateChildIdsRecursive(element, newId1, tree) {
              const processed = []
              element.querySelectorAll('[id]').forEach(child => {
                const splited = child.id.split(';');
                const splited2 = splited[splited.length - 1].replace('-tree', '').split(':')
                let newSubId = splited2[0] + ':' + newId1
                tree && (newSubId = newSubId + '-tree')
                splited.pop()
                const processed1 = [...splited, splited2[0]].join(';')
                if (processed.find(el => el.startsWith(processed1))) {
                  console.log('status' + processed1)
                  console.log('status2' + JSON.stringify(processed))
                  child.remove()
                }
                else {
                  processed.push(processed1)
                  console.log('proce' + processed1)
                  child.id = [...splited, newSubId].join(';')
                  if (child.hasAttribute('data-visual-defaultTextNode') && child.hasAttribute('data-visual-element')) {
                    // Set child's text content to its content
                    child.innerText = child.getAttribute('data-visual-defaultTextNode')
                  }
                  // Recursively update ids for child's children
                  updateChildIdsRecursive(child, newId1, tree);
                }

              });
            }

            // Update ids of child elements within the duplicated elements recursively
            updateChildIdsRecursive(newEl, newId1);


            break;
          }
          //case insert tag
          if (inserted_element?.tagName) {
            const handleInsert = (treeElement, componentElement, replaceCopyId) => {
              console.log('handling' + treeElement + ' ' + componentElement + ' ' + replaceCopyId)
              const newEl = document.createElement(inserted_element.tagName)
              const attr1 = componentElement.getAttribute('data-replaceID')
              if (attr1) {
                newEl.setAttribute('data-replaceID', attr1)
              }
              if (noComp || noComp1) {
                newEl.setAttribute('data-replaceID', replaceId)
              }

              const splited = componentElement.id.split(';')






              newEl.id = replaceCopyId ? inserted_element.id.split(':')[0] + ':' + componentElement.getAttribute('data-replaceid') : inserted_element.id

              console.log(newEl.id)

              const component_el = getElementById1('tree-element')
              const newEl2 = component_el.cloneNode(true)
              const button2 = newEl2.querySelector("[data-element='code-tree-tag-name-button']")
              button2.textContent = '🏷️' + inserted_element.tagName;
              const button = newEl2.querySelector("[data-element='code-tree-show-hide-button']")
              button.addEventListener('mouseover', mouseOverTree);

              button.addEventListener('mouseout', mouseOutTree);
              newEl2.id = replaceCopyId ? inserted_element.id.split(':')[0] + ':' + componentElement.getAttribute('data-replaceid') + '-tree' : inserted_element.id + '-tree'
              if (splited.length > 1) {
                newEl.id = splited[0] + ';' + newEl.id
                newEl2.id = splited[0] + ';' + newEl2.id
              }
              componentElement.parentNode.insertBefore(newEl, componentElement)
              treeElement.parentNode.insertBefore(newEl2, treeElement)
            }
            treeElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
              getElementById1('code-tree')
              : getElementById1(target_element)
            //component
            componentElement = components.find(i => i === removeLastOccurrence(target_element, '-tree')) ?
              getElementById1('generated-page')
              :
              getElementById1(removeLastOccurrence(target_element, '-tree'));
            if (!componentElement) {
              console.log('comp not found')
              const mId = target_element.replace('-tree', '').split(':')[0]
              const treeEls = []
              const compEls = []
              const existing = []
              const elementsWithIdAndAttribute = querySelectorAll1('[id^="' + mId + '"][data-replaceid]')
                .forEach(
                  el => {
                    console.log('ffooound152 ' + el.id)
                    if (!existing.includes(el.getAttribute('data-replaceid'))) {
                      existing.push(el.getAttribute('data-replaceid'))
                      treeEls.push(getElementById1(el.id + '-tree'));
                      compEls.push(el)
                    }

                  }
                );

              for (let i = 0; i < treeEls.length; i++) {
                handleInsert(treeEls[i], compEls[i], true)
              }
              break;
            }
            console.log('handling insert')
            handleInsert(treeElement, componentElement)


            break;

          }
          if (target_element.length) {
            console.log(JSON.stringify(target_element))
            handleAppendOrInsert('InsertBefore', target_element.map(i => i.id), move, options?.insert_copies)

          }
          break;



        case 'innerHtml':
          // Handle the 'innerHtml' action
          const targetElement = getElementById1(removeLastOccurrence(target_element, '-tree'));
          const targetElement1 = getElementById1(target_element, '-tree');
          if (targetElement1) {
            const innerHtmlButton = targetElement1.querySelector('[data-element="code-tree-inner-html-button"]');
            insertedCode ? innerHtmlButton.removeAttribute('hidden') : innerHtmlButton.setAttribute('hidden', '')
            innerHtmlButton.textContent = `▶️${insertedCode.length}`;

            const textContentButton = targetElement1.querySelector('[data-element="code-tree-text-content-button"]');
            textContentButton.setAttribute('hidden', '')
            textContentButton.textContent = `📄`;

          }
          if (targetElement.hasAttribute('data-b-value')) {
            targetElement.setAttribute('data-b-value', true)
            let parent = targetElement.parentNode
            while (parent && parent.nodeType === 1) {
              if (parent.hasAttribute('data-b')) {
                parent.setAttribute('data-b', true)
                break;
              }
              parent = parent.parentNode;
            }

          }
          targetElement.innerHTML = insertedCode;

          break;
        case 'Replace_Component':
          // Handle the 'innerHtml' action
          //location.reload();
          break;
        /*
        const toReplace = target_element[0]
        target_element.shift()
        const dontReplaceIndex = target_element.findIndex(e => e.componentId === toReplace)
  
        let l = target_element.filter(e => e.componentId !== toReplace);
  
        for (const el of l) {
if (!el.already) {
  await executeCommand({
    time,
    action: 'InsertBefore',
    target_element: toReplace,
    inserted_component: el,
    noComp: true
  }, path, visual)
}
  
        }
        if (dontReplaceIndex === -1) {
const elementsToRemove = querySelectorAll1(`[id^="${removeLastOccurrence(toReplace, '-tree') + ';'}"]`);
elementsToRemove.forEach(element => element.remove());
        }
        const el = getElementById1(toReplace)
        el.setAttribute('replaced', JSON.stringify(target_element))
        const el2 = el.querySelector('[data-element="optional-script"]')
        el2.removeAttribute('hidden')
        el2.innerHTML = `🔄${target_element.length}`;
        break;
        */


        case 'ChangeTag':
          // Handle the 'ChangeTag' action
          // tree el
          if (options?.apply_to_copies) {
            const selector1 = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
            querySelectorAll1(selector1).forEach(e => {

              if (e.id.endsWith('-tree')) {
                e.querySelector("[data-element='code-tree-tag-name-button']").textContent = '🏷️' + tag_change;
              }
              else {
                var newElement = document.createElement(tag_change);

                // Copy attributes from the div to the p element
                for (var i = 0; i < e.attributes.length; i++) {
                  var attribute = e.attributes[i];
                  newElement.setAttribute(attribute.name, attribute.value);
                }
                newElement.id = e.id
                // Copy content from the div to the p element
                newElement.innerHTML = e.innerHTML;

                // Replace the div element with the new p element

                e.parentNode.replaceChild(newElement, e);
              }
            });

            break;
          }
          const elementToChange = getElementById1(target_element);
          elementToChange.querySelector("[data-element='code-tree-tag-name-button']").textContent = '🏷️' + tag_change;
          // builder el
          const elementToChange2 = getElementById1(removeLastOccurrence(target_element, '-tree'));
          if (elementToChange2) {
            // Create a new p element
            var newElement = document.createElement(tag_change);

            // Copy attributes from the div to the p element
            for (var i = 0; i < elementToChange2.attributes.length; i++) {
              var attribute = elementToChange2.attributes[i];
              newElement.setAttribute(attribute.name, attribute.value);
            }
            newElement.id = elementToChange2.id
            // Copy content from the div to the p element
            newElement.innerHTML = elementToChange2.innerHTML;

            // Replace the div element with the new p element

            elementToChange2.parentNode.replaceChild(newElement, elementToChange2);
            // Add an event listener to the entire document to track double-clicks



          }
          break;
        case 'ChangeTag+':
        case 'ChangeTagForCopies':
          // Handle the 'ChangeTag' action
          // tree el
          const selector1 = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
          querySelectorAll1(selector1).forEach(e => {

            if (e.id.endsWith('-tree')) {
              e.querySelector("[data-element='code-tree-tag-name-button']").textContent = '🏷️' + tag_change;
            }
            else {
              var newElement = document.createElement(tag_change);

              // Copy attributes from the div to the p element
              for (var i = 0; i < e.attributes.length; i++) {
                var attribute = e.attributes[i];
                newElement.setAttribute(attribute.name, attribute.value);
              }
              newElement.id = e.id
              // Copy content from the div to the p element
              newElement.innerHTML = e.innerHTML;

              // Replace the div element with the new p element

              e.parentNode.replaceChild(newElement, e);
            }
          });

          break;


        case 'dublicateTag':
          // Handle the 'dublicateTag' action
          const originalElement = getElementById1(target_element);
          const originalElement2 = getElementById1(removeLastOccurrence(target_element, '-tree'));
          const duplicatedElement = originalElement.cloneNode(true);
          const duplicatedElement2 = originalElement2.cloneNode(true);
          //to do
          duplicatedElement.id = inserted_element
          duplicatedElement2.id = removeLastOccurrence(inserted_element, '-tree');

          originalElement.parentNode.appendChild(duplicatedElement);
          originalElement2.parentNode.appendChild(duplicatedElement2);
          break;

        case 'removeTag':
          // Handle the 'removeTag' action
          // tree
          if (options?.apply_to_copies) {
            const selector = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
            querySelectorAll1(selector).forEach(e => e.remove());
            break;
          }
          const elementToRemove = getElementById1(target_element);
          elementToRemove && elementToRemove.parentNode.removeChild(elementToRemove);

          // component
          const elementToRemove2 = getElementById1(removeLastOccurrence(target_element, '-tree'));
          elementToRemove2 && elementToRemove2.parentNode.removeChild(elementToRemove2);


          break;
        case 'removeTagAndCopies':
        case 'removeTag+':
          // Handle the 'removeTag' action

          // component
          const selector = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
          querySelectorAll1(selector).forEach(e => e.remove());



          break;
        case 'removeComponent':
          // Handle the 'removeTag' action
          // tree



          break;
        case 'textContent':
          // Handle the 'removeTag' action
          // tree
          console.log('pr' + target_element)
          const element1 = getElementById1(target_element);
          if (element1) {
            const textContentButton = element1.querySelector('[data-element="code-tree-text-content-button"]');
            value ? textContentButton.removeAttribute('hidden') : textContentButton.setAttribute('hidden', '')
            textContentButton.textContent = `📄${value.length}`;

            const innerHtmlButton = element1.querySelector('[data-element="code-tree-inner-html-button"]');
            innerHtmlButton.setAttribute('hidden', '')
            innerHtmlButton.textContent = `▶️`;
          }


          // component
          const element2 = getElementById1(removeLastOccurrence(target_element, '-tree'));
          if (element2.hasAttribute('data-b-value')) {
            element2.setAttribute('data-b-value', true)
            let parent = element2.parentNode
            while (parent && parent.nodeType === 1) {
              if (parent.hasAttribute('data-b')) {
                parent.setAttribute('data-b', true)
                break;
              }
              parent = parent.parentNode;
            }

          }
          element2.textContent = value;


          break;
        case 'Add_Comment':
          // Handle the 'removeTag' action
          // tree
          const comment = insertedCode
          const target = getElementById1(target_element)
          const commentField = target.querySelector('[data-element="comment"]')
          commentField.removeAttribute('hidden')
          commentField.textContent = '💬' + comment


          break;
        case 'Remove_Comment':
          // Handle the 'removeTag' action
          // tree
          const target1 = getElementById1(target_element)
          const commentField1 = target1.querySelector('[data-element="comment"]')
          commentField1.setAttribute('hidden', "")
          commentField1.textContent = '💬'


          break;

        // Add more cases as needed for other actions
        case 'removeAttributeFromCopies':
        case 'removeAttribute+':
          console.log('pr' + target_element);

          const selector111 = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
          const els111 = querySelectorAll1(selector111); // Corrected the function name to document.querySelectorAll
          // component
          for (const elementToRemoveAttribute of els111) {
            if (key) { // Check if key exists
              elementToRemoveAttribute.removeAttribute(key);
              if (key === 'data-parentid') {
                querySelectorAll1('[id^="' + elementToRemoveAttribute.id + ';"]').forEach(el => {
                  el.id = el.id.replace(elementToRemoveAttribute.id + ';', '');
                });
              }
            }
          }
          break;
        case 'setAttribute':
          if (options?.apply_to_copies) {
            target_element = target_element.endsWith('-tree') ? target_element : target_element + '-tree'
            const allSelector = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
            const allTargets = Array.from(querySelectorAll1(allSelector)).filter(element => !element.id.endsWith('-fieldset') && !element.id.endsWith('-tree'))

            // component

            if (key === 'style' || key === 'class') {

              allTargets.forEach(element => element.setAttribute(key, value))
              break;
            }
            const attributeButton1 = getElementById1(target_element).querySelector('[data-element="code-tree-attributes-button"]');
            attributeButton1.removeAttribute('hidden')
            for (const element22 of allTargets) {

              const element33 = getElementById1(element22.id + 'tree');


              if (key) {
                console.log('key11 ' + key)
                console.log('value ' + value)

                element22.setAttribute(key, value);
                if (!element22.textContent && key.toLowerCase() === 'data-visual-defaultTextNode'.toLowerCase()) {
                  console.log('not found 111')
                  element22.textContent = value
                }
              }

              if (key === 'data-parentid') {
                recursivelyChangeIDs(element22, removeLastOccurrence(target_element, '-tree'), true);
                recursivelyChangeIDs(element33, removeLastOccurrence(target_element, '-tree'), true, true);
              }
            }
            break;
          }
          console.log('pr' + target_element);
          target_element = target_element.endsWith('-tree') ? target_element : target_element + '-tree'

          // component

          if (key === 'style' || key === 'class') {
            const selector = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
            querySelectorAll1(selector).forEach(element => !element.id.endsWith('-fieldset') && !element.id.endsWith('-tree') && element.setAttribute(key, value))
            break;
          }

          const element22 = getElementById1(removeLastOccurrence(target_element, '-tree'));
          const element33 = getElementById1(target_element);
          const attributeButton = element33.querySelector('[data-element="code-tree-attributes-button"]');
          attributeButton.removeAttribute('hidden')
          if (check_b) {
            if (element22.hasAttribute('data-b-value')) {
              element22.setAttribute('data-b-value', true)
              let parent = element22.parentNode;

              while (parent && parent.nodeType === 1) {
                if (parent.hasAttribute('data-b')) {
                  parent.setAttribute('data-b', true)
                  break;
                }
                parent = parent.parentNode;
              }





            }
          }
          if (key) {
            console.log('key11 ' + key)
            console.log('value ' + value)

            element22.setAttribute(key, value);
            if (!element22.textContent && key.toLowerCase() === 'data-visual-defaultTextNode'.toLowerCase()) {
              console.log('not found 111')
              element22.textContent = value
            }
          }

          if (key === 'data-parentid') {
            recursivelyChangeIDs(element22, removeLastOccurrence(target_element, '-tree'), true);
            recursivelyChangeIDs(element33, removeLastOccurrence(target_element, '-tree'), true, true);
          }
          break;
        case 'setAttribute+':
          console.log('pr' + target_element);
          target_element = target_element.endsWith('-tree') ? target_element : target_element + '-tree'
          const allSelector = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
          const allTargets = Array.from(querySelectorAll1(allSelector)).filter(element => !element.id.endsWith('-fieldset') && !element.id.endsWith('-tree'))

          // component

          if (key === 'style' || key === 'class') {

            allTargets.forEach(element => element.setAttribute(key, value))
            break;
          }
          const attributeButton1 = getElementById1(target_element).querySelector('[data-element="code-tree-attributes-button"]');
          attributeButton1.removeAttribute('hidden')
          for (const element22 of allTargets) {

            const element33 = getElementById1(element22.id + 'tree');


            if (key) {
              console.log('key11 ' + key)
              console.log('value ' + value)

              element22.setAttribute(key, value);
              if (!element22.textContent && key.toLowerCase() === 'data-visual-defaultTextNode'.toLowerCase()) {
                console.log('not found 111')
                element22.textContent = value
              }
            }

            if (key === 'data-parentid') {
              recursivelyChangeIDs(element22, removeLastOccurrence(target_element, '-tree'), true);
              recursivelyChangeIDs(element33, removeLastOccurrence(target_element, '-tree'), true, true);
            }
          }
          break;
        case 'removeAttribute':
          console.log('pr' + target_element);
          if (options?.apply_to_copies) {
            const selector111 = '[id^="' + removeLastOccurrence(target_element, '-tree').split(':')[0] + '"]';
            const els111 = querySelectorAll1(selector111); // Corrected the function name to document.querySelectorAll
            // component
            for (const elementToRemoveAttribute of els111) {
              if (key) { // Check if key exists
                elementToRemoveAttribute.removeAttribute(key);
                if (key === 'data-parentid') {
                  querySelectorAll1('[id^="' + elementToRemoveAttribute.id + ';"]').forEach(el => {
                    el.id = el.id.replace(elementToRemoveAttribute.id + ';', '');
                  });
                }
              }
            }
            break;
          }

          // component
          const elementToRemoveAttribute = getElementById1(removeLastOccurrence(target_element, '-tree'));
          key && elementToRemoveAttribute.removeAttribute(key);
          if (key === 'data-parentid') {
            querySelectorAll1('[id^="' + removeLastOccurrence(target_element, '-tree') + ';"]').forEach(el => {
              el.id = el.id.replace(removeLastOccurrence(target_element, '-tree') + ';', '')
            });
          }

          break;


        // Add more cases as needed for other actions

        default:
          // Handle the default case if no matching action is found
          console.error(`Unknown action: ${action}`);
          break;
      }

    }
    async function loader(e, handler) {
      const loadingScreen = getElementById1('loading');
      loadingScreen.style.display = 'flex';
      const prefixesToRemove = [
        'component-element',
        'tree-element',
        'component-replace-menu',
        'code-tree-tag-attributes-form',
        'code-tree-click-tag',
        'code-tree-add-tag-step-1',
        'code-tree-append-or-insert-approv-menu',
        'code-tree-inner-html-receive-menu',
        'tag-table',
        "code-tree-tag-text-content-form"
      ];

      prefixesToRemove.forEach(prefix => {
        const p = getElementById1("code-tree")
        const elementsToRemove = p.querySelectorAll(`fieldset[id^="${prefix}"]`);
        elementsToRemove.forEach(element => element.remove());
      });
      const timerElement = getElementById1('timer');
      let tenthsOfSeconds = 0;
      const interval = setInterval(function () {
        tenthsOfSeconds++;
        timerElement.textContent = (tenthsOfSeconds / 10).toFixed(1);
      }, 100);

      await handler(e);

      loadingScreen.style.display = 'none';
      clearInterval(interval);
      console.log(timerElement.textContent)
      const lastActionTime = getElementById1('last-action-time');

      lastActionTime.textContent = timerElement.textContent;
    }
    function openAttributeContent(event) {
      const button = event.target.closest('button[data-element="code-tree-attributes-button"]');
      const checked = event.target.parentNode.querySelector('#applyToCopies')?.checked || false
      if (button) {
        const parentId = button.parentNode.id.split(';')[1] || button.parentNode.id;
        const generatedId = removeLastOccurrence(parentId, '-tree')
        const textContentButton = button.parentNode.querySelector('[data-element="code-tree-attributes-button]');

        const existingClonedFieldset = button.parentNode.querySelector('[id^="code-tree-tag-attributes-form-1"]');

        if (!existingClonedFieldset) {
          // Clone the fieldset node
          const fieldset = getElementById1('code-tree-tag-attributes-form-1');
          const clonedFieldset = fieldset.cloneNode(true);
          clonedFieldset.querySelector('#applyToCopies').checked = checked
          // Assign a unique id to the cloned fieldset
          clonedFieldset.id = 'code-tree-tag-attributes-form-1;' + parentId;

          // Find the position to insert the cloned fieldset
          const insertAfterElement = textContentButton || button;

          // Insert the cloned fieldset after the specified element
          const toA = insertAfterElement.closest('[data-open-menu]') || insertAfterElement.parentNode.querySelector('[data-open-menu]')
          // Insert the cloned fieldset after the specified element
          removeMenus()
          toA.append(clonedFieldset)
          const elementWithAttributes = getElementById1(generatedId);
          if (elementWithAttributes) {
            const attributesList = clonedFieldset.querySelector('#code-tree-tag-attributes-list');



            // Clone the original tr element for each attribute
            const originalTr = clonedFieldset.querySelector('#code-tree-tag-attributes-list-item');
            for (const attribute of elementWithAttributes.attributes) {
              const clonedTr = originalTr.cloneNode(true);

              // Modify data based on attributes of the elementWithAttributes
              const keyElement = clonedTr.querySelector('#code-tree-tag-attribute-key');
              const valueElement = clonedTr.querySelector('#code-tree-tag-attribute-value');

              keyElement.textContent = attribute.name;
              valueElement.textContent = attribute.value;

              // Append the modified tr to the list
              attributesList.appendChild(clonedTr);
            }

            // Remove the original tr element
            originalTr.remove();

          }

        }
      }
    }
    function openTextContent(event) {
      const button = event.target.closest('button[data-element="code-tree-text-content-button"]');

      if (button) {
        const parentId = button.parentNode.id.split(';')[1] || button.parentNode.id
        const textContentButton = button.parentNode.querySelector('[data-element="code-tree-text-content-button"]');

        const existingClonedFieldset = button.parentNode.querySelector('[id^="code-tree-tag-text-content-form"]');

        if (!existingClonedFieldset) {
          // Clone the fieldset node
          const fieldset = getElementById1('code-tree-tag-text-content-form');
          const clonedFieldset = fieldset.cloneNode(true);
          clonedFieldset.querySelector('textarea').value = getElementById1(parentId.replace('-tree', '')).innerHTML
          // Assign a unique id to the cloned fieldset
          clonedFieldset.id = 'code-tree-tag-text-content-form;' + parentId;

          // Find the position to insert the cloned fieldset
          const insertAfterElement = textContentButton || button;
          const toA = insertAfterElement.closest('[data-open-menu]') || insertAfterElement.parentNode.querySelector('[data-open-menu]')
          // Insert the cloned fieldset after the specified element
          removeMenus()
          toA.append(clonedFieldset)
        }
      }
    }
    function openInnerHtmlContent(event) {
      const button = event.target.closest('button[data-element="code-tree-inner-html-button"]');

      if (button) {
        const parentId = button.parentNode.id.split(';')[1] || button.parentNode.id
        const textContentButton = button.parentNode.querySelector('[data-element="code-tree-inner-html-button"]');

        const existingClonedFieldset = button.parentNode.querySelector('[id^="code-tree-tag-html-content-form"]');

        if (!existingClonedFieldset) {
          // Clone the fieldset node
          const fieldset = getElementById1('code-tree-tag-html-content-form');
          const clonedFieldset = fieldset.cloneNode(true);
          clonedFieldset.querySelector('textarea').value = getElementById1(parentId.replace('-tree', '')).innerHTML
          // Assign a unique id to the cloned fieldset
          clonedFieldset.id = 'code-tree-tag-html-content-form;' + parentId;

          // Find the position to insert the cloned fieldset
          const insertAfterElement = textContentButton || button;

          // Insert the cloned fieldset after the specified element
          const toA = insertAfterElement.closest('[data-open-menu]') || insertAfterElement.parentNode.querySelector('[data-open-menu]')
          // Insert the cloned fieldset after the specified element
          removeMenus()
          toA.append(clonedFieldset)
        }
      }
    }
    function openComment(event) {

      const button = event.target.closest('button[data-element="code-tree-comment-button"]');

      if (button) {
        const parentId = button.parentNode.id;
        const splited = parentId.split(';')
        splited.shift()
        const textContentButton = button.parentNode.querySelector('[data-element="code-tree-comment-button"]');

        const existingClonedFieldset = button.parentNode.querySelector('[id^="code-tree-comment-form"]');

        if (!existingClonedFieldset) {
          // Clone the fieldset node
          const fieldset = getElementById1('code-tree-comment-form');
          const insertAfterElement = textContentButton || button;
          const toAppend = insertAfterElement.parentNode.closest('[data-open-menu]')
          removeMenus()
          const clonedFieldset = fieldset.cloneNode(true);
          //clonedFieldset.querySelector('textarea').value = getElementById1(parentId.replace('-tree', '')).textContent
          // Assign a unique id to the cloned fieldset
          clonedFieldset.id = 'code-tree-comment-form";' + splited.join(';');
          clonedFieldset.querySelector('#comment-content').value = getElementById1(splited.join(';')).querySelector('[data-element="comment"]').textContent.replace('💬', '')

          // Find the position to insert the cloned fieldset


          // Insert the cloned fieldset after the specified element
          toAppend.append(clonedFieldset)
        }
      }
    }
    const saveComment = async (event) => {

      const action = 'Add_Comment'
      console.log('ac' + action)

      const saveButton = event.target;
      const fieldset = saveButton.parentNode


      const textareaValue = fieldset.querySelector('#comment-content').value;
      const splited = fieldset.id.split(';')
      const [toRemove, ...rest] = splited
      console.log('fid' + fieldset.id)

      const el = {
        time: (new Date()).getTime(),
        action,
        target_element: rest.join(';'),
        insertedCode: textareaValue,

      }
      console.log(JSON.stringify(el))
      await pushAction(el)

      removeMenus()
      console.log(JSON.stringify(actionLog))

    }
    const removeComment = async (event) => {

      const action = 'Remove_Comment'
      console.log('ac' + action)

      const saveButton = event.target;
      const fieldset = saveButton.parentNode



      const splited = fieldset.id.split(';')
      const [toRemove, ...rest] = splited
      console.log('fid' + fieldset.id)

      const el = {
        time: (new Date()).getTime(),
        action,
        target_element: rest.join(';'),

      }
      console.log(JSON.stringify(el))
      await pushAction(el)

      removeMenus()
      console.log(JSON.stringify(actionLog))

    }

    function handleComponentClick(event) {
      const button = event.target.closest('button[data-element="code-tree-tag-name-button"]');
      console.log('in111')
      if (button) {
        const parentId = button.parentNode.id;
        const textContentButton = button.parentNode.querySelector('[data-element="code-tree-text-content-button"]');

        // Check if a cloned fieldset already exists after the parent node
        const existingClonedFieldset = button.parentNode.querySelector('[id^="code-tree-click-component"]');

        if (!existingClonedFieldset) {
          // Clone the fieldset node
          const fieldset = getElementById1('code-tree-click-component');
          const clonedFieldset = fieldset.cloneNode(true);

          // Assign a unique id to the cloned fieldset
          clonedFieldset.id = 'code-tree-click-component;' + parentId;
          clonedFieldset.setAttribute('path', button.getAttribute('path'))
          clonedFieldset.setAttribute('replaced', button.parentNode.getAttribute('replaced'))
          // Find the position to insert the cloned fieldset
          const insertAfterElement = textContentButton || button;
          if (pathItemPath.split(';')[0].endsWith('Hub')) {
            const contentEl = clonedFieldset.querySelector('#content-type')
            const catWeight = contentEl.querySelector('#catalog-weight')
            const catFolder = contentEl.querySelector('#catalog-folder')
            catFolder.querySelector('button').addEventListener('click', (e) => {
              const inputV = catFolder.querySelector('input').value
              pathItem.hub_items.article_folder = inputV
              delete pathItem.hub_items.catalog_page_weight
              fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                body: JSON.stringify(pathItem),
              });
            })
            catWeight.querySelector('button').addEventListener('click', (e) => {
              const inputV = catWeight.querySelector('input').value
              pathItem.hub_items.catalog_page_weight = inputV
              delete pathItem.hub_items.article_folder
              fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                body: JSON.stringify(pathItem),
              });
            })
            function handleRadioChange(event) {
              // Check which radio button is selected
              if (!event.target.checked) {
                return
              }
              const selectedValue = event.target.value;
              if (!pathItem.hub_items) {
                pathItem.hub_items = {}
              }
              const menu = event.target.closest('[data-menu]')
              const path = menu.getAttribute('path')
              const splited = path.split(';')[0].split('/')
              const name = splited[splited.length - 1]
              // Run different functions based on the selected radio button

              catWeight.setAttribute('hidden', '')
              const mainContentSpan = clonedFieldset.closest('fieldset').querySelector('[data-element="main-content"]')
              catFolder.setAttribute('hidden', '')
              switch (selectedValue) {
                case 'none':
                  pathItem.hub_items = {}
                  mainContentSpan.setAttribute('hidden', '')
                  break;
                case 'article':
                  pathItem.hub_items.main_content = 'article:' + name
                  mainContentSpan.removeAttribute('hidden', '')
                  mainContentSpan.textContent = '⭐ Article'
                  catFolder.removeAttribute('hidden')
                  break;
                case 'catalog':
                  pathItem.hub_items.main_content = 'catalog:' + name
                  mainContentSpan.removeAttribute('hidden', '')
                  mainContentSpan.textContent = '✨ Catalog'
                  catWeight.removeAttribute('hidden')
                  break;
                default:
                  // Handle default case
                  break;
              }
              fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                body: JSON.stringify(pathItem),
              });
            }
            contentEl.querySelectorAll("[data-content-type]").forEach(element => {
              element.addEventListener('change', handleRadioChange)
            })
            const splited = pathItem.hub_items?.main_content?.split(':')
            if (splited) {
              if (splited[0] === 'article') {
                contentEl.querySelector('[data-content-type="article"]').checked = true
                contentEl.querySelector('#catalog-folder').removeAttribute('hidden')
                contentEl.querySelector('#catalog-folder').querySelector('input').value = pathItem.hub_items.article_folder || ''
              }
              else {

                contentEl.querySelector('[data-content-type="catalog"]').checked = true
                contentEl.querySelector('#catalog-weight').removeAttribute('hidden')
                contentEl.querySelector('#catalog-weight').querySelector('input').value = pathItem.hub_items.catalog_page_weight || ""
              }
            }

            contentEl.removeAttribute('hidden')
          }
          // Insert the cloned fieldset after the specified element
          insertAfterElement.parentNode.querySelector('[data-open-menu]').append(clonedFieldset)
        }
      }
    }
    function handleTreeClick(event) {
      removeMenus()
      const button = event.target
      console.log('tree clicked')
      if (button) {
        const parentId = button.parentNode.id;
        const textContentButton = button.parentNode.querySelector('[data-element="code-tree-text-content-button"]');

        // Check if a cloned fieldset already exists after the parent node
        const existingClonedFieldset = button.parentNode.querySelector('[id^="code-tree-click-tag;"]');

        if (!existingClonedFieldset) {
          // Clone the fieldset node
          console.log('in1')
          const fieldset = getElementById1('code-tree-click-tag');
          console.log(fieldset.innerHTML)
          const clonedFieldset = fieldset.cloneNode(true);

          // Assign a unique id to the cloned fieldset
          clonedFieldset.id = 'code-tree-click-tag;' + parentId;

          // Find the position to insert the cloned fieldset
          const insertAfterElement = textContentButton || button;

          // Insert the cloned fieldset after the specified element
          insertAfterElement.parentNode.querySelector('[data-open-menu]').append(clonedFieldset)
        }
      }
    }
    var cache = {};
    var updateComponentsMap = false

    function deepCopy(obj) {
      if (typeof obj !== 'object' || obj === null) {
        // Return the input if it's not an object
        return obj;
      }

      // Create an empty object or array to hold the copied values
      const copied = Array.isArray(obj) ? [] : {};

      // Iterate over each key in the original object
      for (let key in obj) {
        // Recursively copy nested objects or arrays
        copied[key] = deepCopy(obj[key]);
      }

      return copied;
    }
    const getRes = async (id, main, firstLoad) => {
      // Check if the response is already in the cache

      if (cache[id]) {
        return deepCopy(cache[id])
      }
      !firstLoad && (updateComponentsMap = true)

      try {
        // Make a GET request to the API with the 'id' query parameter
        const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${id}&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        // Ensure the request was successful (status code 2xx)
        if (!response.ok) {
          throw new Error(`Failed to load data from the database. Status: ${response.status}`);
        }

        // Parse and log the response or handle it as needed
        const responseData = await response.json();

        // Store the response in the cache for future use
        !main && (cache[id] = deepCopy(responseData));

        return responseData;
      } catch (error) {
        console.error(`Error fetching data for id: ${id}`, error);
        throw error; // Re-throw the error to let the caller handle it
      }
    };
    function removeDuplicates(arr) {
      return Array.from(new Set(arr));
    }
    const setOptions = (item) => {
      const { testPage, optionalScript, LinkBP } = item
      testPage && switchTest(false)
      optionalScript && switchOptionalScript(false)
      LinkBP && switchLinkBP(false)
    }
    let foundMainContent
    const loadFromDb = async (id, newId, p, timestamp, upperReplaceActions, ignore, noComp11, noSubComp, lvl, upperRemoveActions, replaceId, pathForRelative) => {
      console.log('load from db' + id)
      console.log('err2 ' + p)
      console.log('path for relative ' + pathForRelative?.current)
      let newPathForRelative = pathForRelative?.current
      let path = ""
      p && (path = p)
      const urlSearchParams = new URLSearchParams(window.location.search);
      let idFromLink = urlSearchParams.get('id');
      let responseData
      const showSku = async (sku) => {
        getElementById1("input-sku").setAttribute('hidden', '')
        getElementById1("create-sku").setAttribute('hidden', '')
        const item1 = getElementById1("sku-item-1")
        const cloned1 = item1.cloneNode(true)
        cloned1.id = sku
        cloned1.removeAttribute('hidden')
        getElementById1("sku-list").removeAttribute('hidden')
        cloned1.querySelector("#sku-value").textContent = sku
        cloned1.querySelector("#remove-sku").setAttribute('hidden', '')
        const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${sku}&sk=qty;&startsWith=true`)
          .then(response => response.json())
        const el = cloned1.querySelectorAll('#sku-item')
        const parent = cloned1.querySelector('#sku-attribute-list')
        if (items.length > 1) {

          for (const item of items) {
            const cloned = el[0].cloneNode(true)
            cloned.querySelector('#sku-attribute-value').textContent = item.sk.replace('qty;', '')
            parent.appendChild(cloned)
            cloned.addEventListener('click', e => handleSkuItemClick(cloned, item))
          }


        }
        else {
          const cloned = el[0].cloneNode(true)
          cloned.querySelector('#sku-attribute-value').textContent = 'Solo'
          cloned.querySelector('#sku-qty').textContent = items[0].qty || 0
          parent.appendChild(cloned)
          cloned.addEventListener('click', e => handleSkuItemClick(cloned, items[0], sku))
        }
        getElementById1("sku-list").appendChild(cloned1)
        el.forEach(e => e.remove())
      }
      if (id) {

        responseData = await getRes(id)

        const { items } = responseData
        console.log('iteeems ' + JSON.stringify(items))
        //change component 
        const splited = convertToOldPath(items.find(e => e.sk === 'path').lsi1.split(';')[0]).split('/')
        const name = splited[splited.length - 1]
        const { testPage, optionalScript } = items.find(e => e.sk === 'path')
        const el1 = getElementById1(newId + '-tree')

        if ((testPage && lvl > 2) || (optionalScript && localStorage.getItem('visualOn'))) {
          el1.remove()
          return
        }
        else if (testPage) {
          el1.querySelector('[data-element="code-tree-test-button"]').removeAttribute('hidden')
          el1.querySelector('[data-element="code-tree-text-content-button"]').remove()
          el1.querySelector('[data-element="code-tree-inner-html-button"]').remove()
        }

        const el = el1.querySelector("[data-element='code-tree-tag-name-button']")
        el.textContent = '🧩' + name
        el.setAttribute('path', items.find(e => e.sk === 'path').lsi1)

        if (pathItem.hub_items?.main_content) {
          const splited = pathItem.hub_items?.main_content?.split(':')
          if (name === splited[1] && !foundMainContent) {
            foundMainContent = true
            const span = el1.querySelector('[data-element="main-content"]')

            span.removeAttribute('hidden')
            if (splited) {
              if (splited[0] === 'article') {
                span.textContent = '⭐ Article'
              }
              else {
                span.textContent = '✨ Catalog'
               
              }
            }

          }
        }
        //insertDataIntoCodeLog(timestamp, idFromLink, { name })
      }
      else {
        components.push(idFromLink)
        responseData = await getRes(idFromLink, true)
        const { items } = responseData
        const map = items.find(e => e.sk === 'componentsMap')
        let r;
        if (map) {
          r = Promise.all(map.items.map(id => getRes(id, false, true)))
        }
        pathItem = items.find(e => e.sk === 'path')
        if (!pathItem) {
          window.location.href = 'index.html'
        }
        //converst lsi1 to old
        pathItemPath = convertToOldPath(pathItem.lsi1)

        if (pathItemPath.toLowerCase().includes('seositeshome.com/home/hub')) {
          if (pathItem.hub_items) {
            pathItem.hub_items.style = pathItemPath.split('/')[0].toLowerCase()
          }
          else {
            pathItem.hub_items = { style: pathItemPath.split('/')[0].toLowerCase() }
          }
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            body: JSON.stringify(pathItem),
          });
        }
        const splited = pathItemPath.split(';')[0].split('/')

        console.log('path item ' + JSON.stringify(pathItem))
        setOptions(pathItem)
        const name = splited[splited.length - 1]
        if (name.toLowerCase() === 'breadcrumb-schema-content') {
          getElementById1('breadCrumb-menu').removeAttribute('hidden')
        }
        const el = getElementById1(idFromLink + '-tree').querySelector("[data-element='code-tree-tag-name-button']")
        el.textContent = '🧩' + name
        el.setAttribute('path', pathItemPath)
        await r;
        //insertDataIntoCodeLog('root', idFromLink, { name })
      }
      if (!idFromLink) {
        throw new Error('Missing id parameter in the URL');
      }

      // Make a GET request to the API with the 'id' query parameter

      if (!ignore) {
        const upper = upperReplaceActions ? upperReplaceActions : []
        const upper1 = upperRemoveActions ? upperRemoveActions : []
        const replaceActions = [...responseData.items.filter(el => el.action === 'Replace_Component'), ...upper]
        const removeActions = [...responseData.items.filter(el => el.action === 'removeComponent'), ...upper1]
        const componentPath = convertToOldPath(responseData.items.find(e => e.sk === 'path')?.lsi1.replace(';publish:published', ''))
        console.log('compP'+componentPath)
        const componentFileName = componentPath.split('/')[componentPath.split('/').length - 1]
        if (id) {
          const relativecomponentFileName = pathForRelative.current.split('/')[pathForRelative.current.split('/').length - 1]
          if (componentFileName !== relativecomponentFileName) {
            newPathForRelative = componentPath
            console.log('test relative different ' + componentFileName + 'diff ' + relativecomponentFileName + ' path ' + newPathForRelative)
          }
          else {
            console.log('test relative same ' + componentFileName + ' path ' + newPathForRelative)
          }
        }


        for (const item of responseData.items) {
          if (!id) {
            if (item.sk === 'path') {
              const el = getElementById1('page-path')

              el.textContent = convertToOldPath(item.lsi1).replace(';publish:published', '')

              if (item.lsi1.includes('publish:published')) {
                const el2 = getElementById1("path-icon")
                el2.classList.add('b-green');
                el2.classList.add('b-selected');
                const el3 = getElementById1("published-label")
                const el4 = getElementById1("published-invalidate")
                const el5 = getElementById1("published-remove")

                el3.removeAttribute('hidden')
                el4.removeAttribute('hidden')
                el5.removeAttribute('hidden')

                el3.setAttribute('href', item.href)
              }
            }

          }
          else if (item.sku) {
            if (lvl < 2) {
              showSku(item.sku)
              selectedSku = item.sku
            }
            else {
              getElementById1("input-sku").setAttribute('hidden', '')
              getElementById1("create-sku").setAttribute('hidden', '')
            }

          }
          if (item.action) {
            if (id) {


              const replaceWithNewId = (s) => {
                if (s.startsWith('3bf8d522-9423-4818-ad91-d8dfcda1f425')) {
                  console.log('fouuund ' + s + '  replace  ' + replaceId)
                }
                if (!replaceId || s === 'body-tree' || s === 'body' || s === 'head-tree' | s === 'head') return s
                if (s.endsWith('-tree')) {

                  return s.replace('-tree', '') + ':' + replaceId + '-tree'
                }
                return s + ':' + replaceId
              }
              if (item.target_element === id + '-tree') {

                item.target_element = newId + '-tree'
                if (item.inserted_element?.id) {
                  item.inserted_element.id.split(':').length === 1 && (item.inserted_element.id = replaceWithNewId(item.inserted_element.id, newId))
                }
                item.inserted_element?.originalId && item.inserted_element?.originalId.split(':').length === 1 && (item.inserted_element.originalId = replaceWithNewId(item.inserted_element.originalId, newId))
              }
              else if (components.includes(removeLastOccurrence(item.target_element, '-tree'))) {

              }
              else if (Array.isArray(item.target_element)) {
                console.log('array of targter ' + JSON.stringify(item.target_element))
                item.target_element = item.target_element.filter(e => e).map(i => {
                  console.log('prob666' + JSON.stringify(i))
                  if (i.id === id + '-tree') {
                    return { ...i, id: newId + '-tree' }
                  }
                  if (i.id?.split(':').length === 1) {
                    return { ...i, id: replaceWithNewId(i.id, newId) }
                  }
                  return { ...i, id: i.id }
                })

              }
              else {

                item.target_element.split(':').length === 1 && (item.target_element = replaceWithNewId(item.target_element, newId))
                item.inserted_element?.id && item.inserted_element?.id.split(':').length === 1 && (item.inserted_element.id = replaceWithNewId(item.inserted_element.id, newId))
                item.inserted_element?.originalId && item.inserted_element?.originalId.split(':').length === 1 && (item.inserted_element.originalId = replaceWithNewId(item.inserted_element.originalId, newId))



              }

              //insertDataIntoCodeLog(item.sk, item.action)
              await executeCommand({ ...item, time: item.sk }, undefined, false, replaceActions, newId, noComp11, noSubComp, lvl, removeActions, replaceId, componentPath, { current: newPathForRelative, prev: pathForRelative.current })

              continue
            }


            await pushAction({ ...item, time: item.sk }, true, false, replaceActions, newId, noComp11, noSubComp, lvl, removeActions, replaceId, componentPath, { current: componentPath, prev: componentPath })
          }

        }
      }
      else {

      }


    }
    function traverseJSONAndUpdate(json, path = '', sender = '') {
      // Iterate through each key-value pair in the JSON object
      for (const key in json) {
        if (json.hasOwnProperty(key)) {
          // Construct the full path for the current key
          const currentPath = path ? `${path}.${key}` : key;
          // If the current value is an array, handle each element individually
          if (Array.isArray(json[key])) {
            // Find the data-transfer-cloner attribute for the current array
            const clonerAttributes = querySelectorAll1(`[data-transfer-cloner="${sender}.${currentPath}"]:not([data-b-value=""]`);
            if (clonerAttributes.length > 0) {
              const arrayOfObjects = [];
              // Iterate through each set of cloned elements
              clonerAttributes.forEach(clonerAttribute => {
                if (typeof json[key][0] === 'string') {
                  if (clonerAttribute.hasAttribute('data-transfer-sender')) {
                    arrayOfObjects.push(clonerAttribute.textContent);
                  }
                  else if (clonerAttribute.hasAttribute('data-transfer-sender-href')) {
                    arrayOfObjects.push(clonerAttribute.getAttribute('href'));
                  }
                  else if (clonerAttribute.hasAttribute('data-transfer-sender-src')) {
                    arrayOfObjects.push(clonerAttribute.getAttribute('src'));
                  }

                }
                else {
                  const objectFromClonedElements = { ...json[key][0] };
                  // Iterate through each cloned element within the current set
                  if (clonerAttribute.hasAttribute('data-transfer-sender')) {
                    const attributeKey = clonerAttribute.getAttribute('data-transfer-sender').split('.').pop();
                    if (objectFromClonedElements[attributeKey] === null) {
                      objectFromClonedElements[attributeKey] = parseInt(clonerAttribute.textContent);
                    }
                    else {
                      objectFromClonedElements[attributeKey] = clonerAttribute.textContent;
                    }

                  }
                  else if (clonerAttribute.hasAttribute('data-transfer-sender-href')) {
                    const attributeKey = clonerAttribute.getAttribute('data-transfer-sender-href').split('.').pop();

                    objectFromClonedElements[attributeKey] = clonerAttribute.getAttribute('href');
                  }
                  else if (clonerAttribute.hasAttribute('data-transfer-sender-href')) {
                    const attributeKey = clonerAttribute.getAttribute('data-transfer-sender-src').split('.').pop();

                    objectFromClonedElements[attributeKey] = clonerAttribute.getAttribute('src');
                  }
                  else {
                    clonerAttribute.querySelectorAll('[data-transfer-sender]:not([data-b-value=""]').forEach(element => {
                      const attributeKey = element.getAttribute('data-transfer-sender').split('.').pop();
                      if (objectFromClonedElements[attributeKey] === null) {
                        objectFromClonedElements[attributeKey] = parseInt(clonerAttribute.textContent);
                      }
                      else {
                        objectFromClonedElements[attributeKey] = clonerAttribute.textContent;
                      }
                    });
                    clonerAttribute.querySelectorAll('[data-transfer-sender-href]:not([data-b-value=""]').forEach(element => {
                      const attributeKey = element.getAttribute('data-transfer-sender-href').split('.').pop();
                      objectFromClonedElements[attributeKey] = clonerAttribute.getAttribute('href');
                    });
                    clonerAttribute.querySelectorAll('[data-transfer-sender-src]:not([data-b-value=""]').forEach(element => {
                      const attributeKey = element.getAttribute('data-transfer-sender-src').split('.').pop();
                      objectFromClonedElements[attributeKey] = clonerAttribute.getAttribute('src');
                    });
                  }
                  // Push the created object to the array of objects
                  arrayOfObjects.push(objectFromClonedElements);
                }



              });
              // Update the value of the array in the JSON object
              json[key] = arrayOfObjects.filter(e => e);
            }
          }

          // If the current value is an object or an array, recursively traverse it
          else if (typeof json[key] === 'object' && json[key] !== null) {
            traverseJSONAndUpdate(json[key], currentPath, sender);
          } else {
            // If the current value is a string, check for the data-transfer-sender attribute
            const senderPath = sender ? `${sender}.${currentPath}` : currentPath;
            let senderAttribute = querySelectorAll1(`[data-transfer-sender="${senderPath}"]:not([data-b-value=""]`);


            if (senderAttribute.length) {
              if (json[key] === null) {
                json[key] = parseInt(senderAttribute[0].textContent) || null;
              }
              else {
                json[key] = senderAttribute[0].textContent || "";
              }

            }
            else {
              let senderAttribute = querySelectorAll1(`[data-transfer-sender-href="${senderPath}"]:not([data-b-value=""]`);
              console.log('iiin2')
              if (senderAttribute.length) {

                json[key] = senderAttribute[0].getAttribute('href') || "";


              } else {
                let senderAttribute = querySelectorAll1(`[data-transfer-sender-src="${senderPath}"]:not([data-b-value=""]`);
                console.log('iiin3')
                if (senderAttribute.length) {

                  json[key] = senderAttribute[0].getAttribute('src') || "";


                }
              }

            }



          }



        }
      }
    }
    function removeEmptyValues(obj) {
      for (let prop in obj) {
        if (obj[prop] === "" || obj[prop] === null || obj[prop] === [null]) {
          delete obj[prop];
        } else if (typeof obj[prop] === "object") {
          removeEmptyValues(obj[prop]); // Recursively call removeEmptyValues for nested objects
          if (Object.keys(obj[prop]).length === 0) {
            delete obj[prop]; // Delete the key if the nested object becomes empty after removing empty values
          }
        }
      }
      return obj;
    }
    function removeSingleAtKey(obj) {
      for (let prop in obj) {
        if (typeof obj[prop] === "object") {
          removeSingleAtKey(obj[prop]); // Recursively call removeSingleAtKey for nested objects
          if (Object.keys(obj[prop]).length === 1 && Object.keys(obj[prop])[0].startsWith("@")) {
            delete obj[prop]; // Delete the attribute if it has only one key starting with "@"
          }
        }
      }
      return obj;
    }
    const cleanJson = (json) => {
      let newJson = removeEmptyValues(json)
      newJson = removeSingleAtKey(json)
      newJson = removeEmptyValues(json)
      return newJson
    }
    const getPageUrl = (url) => {
      const [s, ...rest] = url.split('/')
      if (rest[rest.length - 1].toLowerCase() === 'hub') {
        if (rest[rest.length - 2].toLowerCase() === 'home') {
          rest.pop()

        }
        rest[rest.length - 1] = 'index.html'
      }
      else {
        rest[rest.length - 1] = rest[rest.length - 1] + '.html'
      }
      rest.pop()
      const key = rest.join('/').toLowerCase()
      return 'https://' + s.toLowerCase() + '/' + key
    }
    const generateSchema = (url) => {
      const generatedPage = getElementById1('generated-page')
      const schemas = querySelectorAll1('script[data-transfer-receiver]')

      //sku 

      const combinations = pathItem.combinations
      const forms = querySelectorAll1('[data-product-attribute-form]');
      const priceItems = querySelectorAll1('[data-builder-cart="price"]')

      for (const schema of schemas) {
        const receiverName = schema.getAttribute('data-transfer-receiver')
        let json = JSON.parse(schema.textContent)
        // Start traversing the JSON object

        if (combinations === 1 || forms.length === 1) {
          const prices = Array.from(priceItems[0].children).map(e => parseInt(e.textContent)).filter(e => e)
          delete json['offers-aggregate']
          json['offers-single'] && (json.offers = { ...json['offers-single'], price: Math.min(...prices), url: getPageUrl(url) })
          delete json['offers-single']
        }
        else {
          let prices = []
          for (const el of priceItems) {
            prices.push(...Array.from(el.children).map(e => parseInt(e.textContent)))
          }
          prices = prices.filter(e => e)
          console.log('prices' + JSON.stringify(prices))
          delete json['offers-single']
          json['offers-aggregate'] && (json.offers = { ...json['offers-aggregate'], lowPrice: Math.min(...prices), highPrice: Math.max(...prices), offerCount: combinations, url: getPageUrl(url) })
          delete json['offers-aggregate']

        }
        traverseJSONAndUpdate(json, '', receiverName);

        json = cleanJson(json)
        // After updating, stringify the JSON object and assign it back to the text content of the schema element
        schema.textContent = JSON.stringify(json, null, 2);
        console.log('OUTPUT SCHEMA JSON ' + JSON.stringify(json))
      }
      const tags = querySelectorAll1('[data-transfer-receiver]')
      for (const tag of tags) {
        if (tag.tagName.toLowerCase() !== 'script') {
          const receiver = tag.getAttribute('data-transfer-receiver');
          const link = pathItemPath.replace(';publish:published', '').toLowerCase()
          if (receiver === "canonical" && link.endsWith('/hub')) {
            const splited = link.split('/')
            splited.pop()
            if (splited[splited.length - 1] === 'home') {
              splited.pop()
            }
            let nLink = splited[0]
            if (splited.length > 1) {
              nLink = splited.join('/') + '/'
            }

            tag.setAttribute('href', "https://" + nLink)

          }
          const senders = querySelectorAll1(`[data-transfer-sender^="${receiver}."]`);
          const senders2 = querySelectorAll1(`[data-transfer-sender-href^="${receiver}."]`);
          const senders3 = querySelectorAll1(`[data-transfer-sender-src^="${receiver}."]`);
          if (senders.length) {
            for (const sender of senders) {
              const textContent = sender.textContent;
              const attr = sender.getAttribute('data-transfer-sender').replace(receiver + '.', '');
              if (attr === 'text-content') {
                tag.textContent = textContent
              } else {
                tag.setAttribute(attr, textContent);
              }

            }

          }
          if (senders2.length) {
            for (const sender of senders2) {
              const textContent = sender.getAttribute("href");
              console.log('sender2')
              const attr = sender.getAttribute('data-transfer-sender-href').replace(receiver + '.', '');
              if (attr === 'text-content') {
                tag.textContent = textContent
              } else {
                tag.setAttribute(attr, textContent);
              }

            }

          }
          if (senders3.length) {
            for (const sender of senders3) {
              const textContent = sender.getAttribute('src');
              const attr = sender.getAttribute('data-transfer-sender-src').replace(receiver + '.', '');
              if (sender.hasAttribute('data-builder-image-name')) {
                console.log('iiin55555')
                const name = sender.getAttribute('data-builder-image-name')
                const e = 'https://' + link.toLowerCase() + '/' + name + '.' + textContent.split('.').pop()
                tag.setAttribute(attr, e);
                continue
              }
              if (attr === 'text-content') {
                tag.textContent = textContent
              } else {
                tag.setAttribute(attr, textContent);
              }

            }

          }
        }

      }
    }
    var handleItemLink = async () => {
      const currentPath = pathItemPath.replace(';publish:published', '').toLowerCase()
      if ((currentPath.endsWith("/article-content") || currentPath.endsWith("/product-content")) &&
        (currentPath.includes("/products/") || currentPath.includes("/blog/")) &&
        !currentPath.includes("/seed-") &&
        !currentPath.includes("/seed-/")) {

        const splited = currentPath.split('/')
        splited.pop()
        const href = ('https://' + splited.join('/') + '/')
          .replace('content/product/', '')
          .replace('content/article/', '');
        const item = querySelectorAll1('[data-builder-item-link]')[0]
        if (item && item?.getAttribute('href') !== href) {
          const el = {
            time: (new Date()).getTime(),
            action: 'setAttribute',
            target_element: item.id + '-tree',
            key: 'href',
            value: href,

          }
          await pushAction(el)
        }
      }
    }
    const publish = async (e) => {
      const el2 = getElementById1("path-icon")
      el2.classList.remove('b-green');
      el2.classList.remove('b-selected');
      const el3 = getElementById1("published-label")
      const el4 = getElementById1("published-invalidate")
      const el5 = getElementById1("published-remove")

      el3.setAttribute('hidden', '')
      el4.setAttribute('hidden', '')
      el5.setAttribute('hidden', '')

      //to remove list
      const toRemove = {
        attributesStartWith: ["data-remove"],
        attributesEqual: ["data-remove"],
        removeAttributesStartWith: ["data-visual", "data-builder", "data-replaceid", "data-transfer"]
      }

      const robotsTxt = `
      User-agent: *
      Disallow: /cart/
      `;
      const siteMapPriority = {

        '/products/': 0.9,
        '/blog/': 0.8,
        '/': 1,

      };
      const siteMapNotDefiniedPriorities = 0.5;

      /*
  
      if ((currentPath.endsWith("/article") || currentPath.endsWith("/product")) &&
      (currentPath.includes("/products/") || currentPath.includes("/blog/")) &&
      !currentPath.includes("/seed-article/") &&
      !currentPath.includes("/settings-article/") &&
      !currentPath.includes("/seed-product/") &&
      !currentPath.includes("/settings/") &&
      !currentPath.includes("/setting-product/")) {
      
      console.log("Conditions ok, set data-builder-item-link .");
  
      */


      /*
  
      if ((currentPath.endsWith("/breadcrumb") &&
      !currentPath.includes("/seed-") &&
      !currentPath.includes("/settings-") &&
      !currentPath.includes("/settings/") &&
      !currentPath.includes("/setting-product/")) {
    
      console.log("Conditions ok, generate breadcrumb .");
  
      
      */




      const pagePathContent = getElementById1('page-path').textContent;

      // Use the textContent as needed, for example, log it to the console
      console.log('Publishing:', pagePathContent);
      const urlSearchParams = new URLSearchParams(window.location.search);
      let idFromLink = urlSearchParams.get('id');
      generateSchema(pagePathContent.split(';')[0])
      var iframe = document.getElementById("generated-page-iframe");

      // Access the content of the iframe
      var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
      const html = '<!DOCTYPE html>' + iframeDocument.documentElement.outerHTML;
      console.log(html)
      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/publishv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id: idFromLink, html, path: pagePathContent, toRemove, robotsTxt, siteMapPriority, siteMapNotDefiniedPriorities }),
      });
      const r = await response.json()
      console.log('link: ' + r.link)
      const el = getElementById1('page-path')



      getElementById1('page-path').textContent = pagePathContent

      el2.classList.add('b-green');
      el2.classList.add('b-selected');
      el3.removeAttribute('hidden')
      el3.setAttribute('href', r.link)

      el4.removeAttribute('hidden', '')
      el5.removeAttribute('hidden', '')


    }
    const handleSelectedDependeeChange = async (e) => {
      const resultList = await getProductAttributes()
      const checked1 = getChecked(resultList)
      const dependeeItems = querySelectorAll1(`[data-builder-dependee]`)
      for (const item of dependeeItems) {
        const attr = item.getAttribute('data-product-info')
        if (!attr) {
          continue
        }
        const splited = attr.split(';')
        splited.shift()
        const f = splited.find(el => !checked1.includes(el))
        if (f) {
          item.style.display = 'none'
        }
        else {
          item.style.display = 'block'
        }
      }
    }
    const handleDependency = async () => {
      const items = querySelectorAll1('[data-product-info]')
      if (items) {
        const resultList = await getProductAttributes()
        for (const element of resultList) {
          const form = element.form
          if (form && form.children) {
            // Iterate through the child elements of the form
            for (const child of form.children) {
              // Check if the child element is a label
              if (child.tagName === 'LABEL') {
                // Find the input within the label
                const input = child.querySelector('input[type="radio"]');

                // Add change event listener if input exists
                if (input) {
                  input.addEventListener('change', handleSelectedDependeeChange);
                }
              }
            }
          }

        }
      }
    }
    async function selectImage1(imgId, imageSrc, imageUUID) {

      const imageElement = getElementById1(removeLastOccurrence(imgId, '-tree'))
      const name = imageElement.getAttribute('data-builder-image-name')
      const defaultRes = imageElement.getAttribute('data-builder-image-default')

      const site = pathItemPath.split('/')[0]
      let randomString = generateRandomString(3)
      let url1 = 'https://' + site + '/pics/' + randomString + '_' + name
      function checkSrcStartsWithUrl1() {
        const elements = document.querySelectorAll('[src^="' + url1 + '"]');
        return elements.length > 0;
      }
      while (checkSrcStartsWithUrl1()) {
        randomString = generateRandomString(3);
        url1 = 'https://' + site.toLowerCase() + '/pics/' + randomString + '_' + name;
      }
      const splited = pathItemPath.split('/')
      splited.pop()
      splited.shift()
      const index = splited.indexOf('Content');
      if (index !== -1) {
        splited.splice(index);
      }
      // resize
      const body = {
        site,

        name: randomString + '_' + name,
        imageSrc,
        defaultRes,
        pagePath: splited.join('/')
      }
      const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/resize', {
        method: 'POST',
        body: JSON.stringify(body),
      });
      const { src, data_src } = await response.json()

      const payload = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'data-builder-image-source',
        value: imageUUID,

      }
      await pushAction(payload)

      const payload3 = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'src',
        value: src,
        check_b: true

      }
      await pushAction(payload3)
      const payload4 = {

        time: (new Date()).getTime().toString(),
        action: 'setAttribute',
        target_element: imgId,
        key: 'data-src',
        value: data_src,

      }
      await pushAction(payload4)
      // Add your logic for selecting the image here



      // Add a "selected" label to the selected image



    }
    const handleUls = async (child, ulElement) => {
      const lisToImport = Array.from(child.childNodes).filter(e => e.tagName?.toLowerCase() === "li")
      const olsToImport = Array.from(child.childNodes).filter(e => e.tagName?.toLowerCase() === "ol")
      const liEl = Array.from(ulElement.childNodes).find(e => e.tagName?.toLowerCase() === "li")
      const olEl = Array.from(ulElement.childNodes).find(e => e.tagName?.toLowerCase() === "ol")
      if (!lisToImport.length) {
        for (const el of Array.from(ulElement.childNodes).filter(e => e.tagName?.toLowerCase() === "li")) {
          await pushAction({
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: el.id + '-tree',
          })
        }
      }
      else {
        // remove all lis exept the one we use 
        for (const el of Array.from(ulElement.childNodes).filter(e => e?.tagName?.toLowerCase() === "li" && e?.id !== liEl.id)) {
          await pushAction({
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: el.id + '-tree',
          })
        }
        // set value of first
        const el = {
          time: (new Date()).getTime(),
          action: 'innerHtml',
          target_element: liEl.id + '-tree',
          insertedCode: lisToImport[0].innerHTML || lisToImport[0].textContent,

        }
        await pushAction(el)
        let lastEl = liEl.id + '-tree'
        for (let i = 1; i < lisToImport.length; i++) {
          const content = lisToImport[i].innerHTML || lisToImport[i].textContent
          //duplicate li
          const newId = duplicateId(liEl.id).id
          const actionObject = {
            time: (new Date()).getTime(),
            action: 'InsertAfter',
            target_element: lastEl,
            inserted_element: { originalId: liEl.id + '-tree', id: newId },
          };
          await pushAction(actionObject)
          const el = {
            time: (new Date()).getTime(),
            action: 'innerHtml',
            target_element: newId,
            insertedCode: content,

          }
          await pushAction(el)
          lastEl = newId
        }

      }

      if (!olsToImport.length) {
        for (const el of Array.from(ulElement.childNodes).filter(e => e.tagName?.toLowerCase() === "ol")) {
          await pushAction({
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: el.id + '-tree',
          })
        }
      }
      else {
        for (const el of Array.from(ulElement.childNodes).filter(e => e?.tagName?.toLowerCase() === "ol" && e?.id !== olEl.id)) {
          await pushAction({
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: el.id + '-tree',
          })
        }
        // set value of first
        const el = {
          time: (new Date()).getTime(),
          action: 'innerHtml',
          target_element: olEl.id + '-tree',
          insertedCode: olsToImport[0].innerHTML || olsToImport[0].textContent,

        }
        await pushAction(el)

        let lastEl = olEl.id + '-tree'
        for (let i = 1; i < olsToImport.length; i++) {
          const content = olsToImport[i].innerHTML || olsToImport[i].textContent
          //duplicate li
          const newId = duplicateId(olEl.id).id
          const actionObject = {
            time: (new Date()).getTime(),
            action: 'InsertAfter',
            target_element: lastEl,
            inserted_element: { originalId: olEl.id + '-tree', id: newId },
          };
          await pushAction(actionObject)
          const el = {
            time: (new Date()).getTime(),
            action: 'innerHtml',
            target_element: newId,
            insertedCode: content,

          }
          await pushAction(el)
          lastEl = newId
        }
      }
    }
    const handleImportMenu = () => {
      let sku1 = pathItem.sku || selectedSku
      const generatedPage = getElementById1('generated-page')
      const elements1 = generatedPage.querySelectorAll('*');

      // Filter elements with attributes starting with "data-import-"
      const elements = Array.from(elements1).filter(element => {
        const attributes = element.attributes;
        for (let i = 0; i < attributes.length; i++) {
          if (attributes[i].name.startsWith('data-import-')) {
            return true;
          }
        }
        return false;
      });
      if (elements.length > 0 && pathItemPath.split(';')[0].endsWith('-Content')) {
        const importMenuOriginal = getElementById1('import-menu')
        const importMenu = importMenuOriginal.cloneNode(true)
        importMenuOriginal.parentNode.append(importMenu)
        importMenu.removeAttribute('hidden')

        const button = importMenu.querySelector('#import-name')
        attrList = []
        for (const element of elements) {
          const cloned = button.cloneNode(true)
          let attr = ''
          Array.from(element.attributes).forEach(attribute => {
            // Check if the attribute name matches the pattern
            if (attribute.name.startsWith('data-import-')) {
              // If it matches, log the attribute value
              attr = attribute.name.replace('data-import-', '')
            }
          });
          if (attrList.includes(attr)) {
            continue
          }
          attrList.push(attr)
          cloned.querySelector('#import-name-span').textContent = attr
          button.parentNode.append(cloned)

          cloned.addEventListener('click', async (e) => {
            const menuOriginal = importMenu.querySelector('#import-data')
            const menu = menuOriginal.cloneNode(true)
            menuOriginal.parentNode.append(menu)
            menu.removeAttribute('hidden')
            menu.setAttribute('import-name-value', attr)
            const input = menu.querySelector('#import-input')
            const prevButton = menu.querySelector('#previous-html')
            const nextButton = menu.querySelector('#next-html')
            const removeButton = menu.querySelector('#remove-html')
            const updateButton = menu.querySelector('#update-html')
            const variationAmount = menu.querySelector('#variation-amount')
            const variationSite = menu.querySelector('#variant-site')
            let index
            let itemsArr = []

            const handleImport = async (e, update) => {
              const inputValue = input.value
              // save content
              if (attr.startsWith('product')) {
                const stamp = new Date().getTime().toString()
                let payload
                if (update) {

                  if (!itemsArr.find(item => item.value === inputValue)) {
                    itemsArr[index] = { ...itemsArr[index], value: inputValue }
                    payload = itemsArr[index]
                  }

                } else {
                  const site = pathItemPath.split('/')[0]
                  if (itemsArr[index]?.value === inputValue) {
                    const splitedSite = itemsArr[index].site.split(',')
                    if (!splitedSite.includes(site)) {
                      splitedSite.push(site)
                      payload = { ...itemsArr[index], site: splitedSite.sort((a, b) => a.name.localeCompare(b.name)).join(',') }
                    }
                  }
                  else if (!itemsArr.find(item => item.value === inputValue)) {
                    payload = {
                      id: sku1,
                      sk: attr + ':' + stamp,
                      value: inputValue,
                      site
                    }
                    itemsArr.push(payload)
                    index = itemsArr.length - 1
                    variationAmount.textContent = itemsArr.length

                  }
                  for (let i = 0; i < itemsArr.length; i++) {

                    if (i !== index) {
                      const it = itemsArr[i]
                      const splited1 = it.site.split(',')
                      const siteI = splited1.findIndex(e => e === site)

                      if (siteI > -1) {
                        splited1.splice(siteI, 1)
                        const sorted = splited1.filter(e => e).sort((a, b) => a.name.localeCompare(b.name))
                        itemsArr[i] = { ...itemsArr[i], site: sorted.join(',') }
                        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json',
                          },
                          body: JSON.stringify({ ...itemsArr[i] }),
                        });
                      }
                    }
                  }
                }
                payload && await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(payload),
                });
              }
              const div = document.createElement('div')
              div.innerHTML = inputValue
              const allAttrs = querySelectorAll1(`[data-import-${attr}]`)
              const map = allAttrs.map(element => {
                const value = element.getAttribute(`data-import-${attr}`)
                return { tag: value, element, set: false, index: 1 }
              })
              console.log('map is ' + JSON.stringify(map))
              let imgLead = false
              let pLead = false
              for (const child of Array.from(div.childNodes)) {
                if (!child?.tagName) {
                  continue
                }
                console.log('map is ' + JSON.stringify(map))
                const tag = child.tagName.toLowerCase()
                console.log(tag)
                let foundE
                if (tag === 'img' && !imgLead) {
                  imgLead = true
                  foundE = map.findLast(e => e.tag === 'img-lead') || map.findLast(e => e.tag === 'img')
                }
                else if (tag === "p" && !pLead) {
                  pLead = true
                  foundE = map.findLast(e => e.tag === 'p-lead') || map.findLast(e => e.tag === 'p')
                }
                else {
                  foundE = map.findLast(el => el.tag === tag)
                }
                for (const attribute of foundE.element.attributes) {
                  if (attribute.name.startsWith('data-import-product-')) {
                    const prefix = 'data-import-product-';
                    const suffix = attribute.name.substring(prefix.length);
                    const stamp = new Date().getTime().toString();
                    const body = {
                      id: sku1,
                      sk: 'data-' + suffix + ':' + stamp,
                      value: child.innerHTML,
                      site: pathItemPath.split('/')[0]
                    };
                    const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                      method: 'POST',
                      body: JSON.stringify(body),
                    });
                    // You may want to handle the response here
                  }
                }
                if (foundE.set === false) {
                  if (tag === 'img') {
                    const src = child.getAttribute('src')
                    const alt = child.getAttribute('alt')

                    const response = await fetch('https://corsproxy.io/?' + src);
                    const blob = await response.blob()

                    const splited = src.split('/')
                    const name = splited[splited.length - 1].split('?')[0]

                    const path = await upload(name, blob)

                    console.log('path ' + path)
                    const id = pathItem.id
                    const payload2 = {

                      time: (new Date()).getTime().toString(),
                      action: 'setAttribute',
                      target_element: foundE.element.id + '-tree',
                      key: 'alt',
                      value: alt,

                    }
                    pushAction(payload2)
                    const payload = {
                      id,
                      sk: path
                    }
                    await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify(payload),
                    });
                    const imageSrc = `https://s3.amazonaws.com/checkout-admin-panel/${path}`
                    await selectImage1(foundE.element.id + '-tree', imageSrc, path.split('.')[0].replace('pics', ''))


                  }
                  else if (tag === "ul") {
                    const ulElement = getElementById1(foundE.element.id)
                    await handleUls(child, ulElement)

                  }
                  else {
                    const el = {
                      time: (new Date()).getTime(),
                      action: 'innerHtml',
                      target_element: foundE.element.id + '-tree',
                      insertedCode: child.textContent,

                    }
                    await pushAction(el)
                  }

                  foundE.set = true
                  //foundE.element.innerHTML = child.innerHTML
                }
                else {

                  const foundIndex = foundE.index
                  /*
                  let last = map.findLastIndex(e => e.index === foundIndex + 1)
                  if (last < 0) {
          last = map.findLastIndex(e => e.index === foundIndex)
                  }
                  */
                  const lastElement = map[map.length - 1].element
                  const newId = duplicateId(foundE.element.id).id
                  const actionObject = {
                    time: (new Date()).getTime(),
                    action: 'InsertAfter',
                    target_element: lastElement.id + '-tree',
                    inserted_element: { originalId: foundE.element.id + '-tree', id: newId },
                  };
                  await pushAction(actionObject);
                  if (tag === 'img') {
                    const src = child.getAttribute('src')
                    const alt = child.getAttribute('alt')
                    const payload2 = {

                      time: (new Date()).getTime().toString(),
                      action: 'setAttribute',
                      target_element: newId,
                      key: 'alt',
                      value: alt,

                    }
                    pushAction(payload2)
                    const response = await fetch('https://corsproxy.io/?' + src);
                    const blob = await response.blob()

                    const splited = src.split('/')
                    const name = splited[splited.length - 1].split('?')[0]

                    const path = await upload(name, blob)

                    console.log('path ' + path)
                    const id = pathItem.id
                    const payload = {
                      id,
                      sk: path
                    }
                    await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify(payload),
                    });
                    const imageSrc = `https://s3.amazonaws.com/checkout-admin-panel/${path}`
                    await selectImage1(newId, imageSrc, path.split('.')[0].replace('pics', ''))


                  }
                  else if (tag === "ul") {
                    const ulElement = getElementById1(removeLastOccurrence(newId, '-tree'))
                    await handleUls(child, ulElement)



                  }

                  else {
                    const el = {
                      time: (new Date()).getTime(),
                      action: 'innerHtml',
                      target_element: newId,
                      insertedCode: child.textContent,

                    }
                    await pushAction(el)
                  }

                  const newElement = { ...foundE, element: getElementById1(removeLastOccurrence(newId, '-tree')), set: true, index: foundIndex + 1 }
                  //map.splice(last + 1, 0, newElement);
                  map.push(newElement)
                  //lastElement.insertAdjacentElement('afterend', clonedE);

                }

              }

              menu.remove()

            }
            const handleNext = () => {
              if (itemsArr.length - 1 === index) {
                return
              }
              index = index + 1
              input.value = itemsArr[index].value
              variationSite.textContent = itemsArr[index].site
            }
            const handlePrevious = () => {
              if (index === 0) {
                return
              }
              index = index - 1
              input.value = itemsArr[index].value
              variationSite.textContent = itemsArr[index].site
            }
            const handleRemove = async () => {
              if (itemsArr.length < 2) {
                return
              }
              await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${itemsArr[index].id}:${itemsArr[index].sk}`, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  // Add any additional headers if needed
                },
              });
              if (itemsArr.length < 2) {
                menu.remove()
              }
              itemsArr.splice(index, 1)
              index = index + 1 !== itemsArr.length ? (index = index) : (index = index - 1)
              input.value = itemsArr[index].value
              variationSite.textContent = itemsArr[index].site
              variationAmount.textContent = itemsArr.length

            }
            if (attr.startsWith('product-')) {

              // get variations
              const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${sku1}&sk=${attr}&startsWith=true`).then(re => re.json())
              itemsArr = [...items]
              menu.querySelector("#variation-amount-field").removeAttribute('hidden')
              variationAmount.textContent = items.length
              index = items.length - 1
              if (items.length) {
                input.value = itemsArr[index].value

                variationSite.textContent = itemsArr[index].site
                menu.querySelector("#variation-site-field").removeAttribute('hidden')
                prevButton.removeAttribute('hidden')
                nextButton.removeAttribute('hidden')
                removeButton.removeAttribute('hidden')
                updateButton.removeAttribute('hidden')
                updateButton.addEventListener('click', (e) => handleImport(e, true))
                removeButton.addEventListener('click', handleRemove)
                nextButton.addEventListener('click', handleNext)
                prevButton.addEventListener('click', handlePrevious)
              }

            }
            menu.querySelectorAll('[data-save]').forEach(element1 => {
              element1.addEventListener('click', handleImport)
            })

          })

        }
        button.remove()
        /*
        
        
        */
      }
    }
    document.addEventListener('DOMContentLoaded', loadFirst);
    const handleWebPageMenu = () => {
      const splited = pathItemPath.split(';')[0].split('/')
      const menu = document.getElementById('web-page-menu')
      if (splited[0].endsWith('SeoSitesHome.com') || splited[splited.length - 1] === 'Hub') {

        menu.removeAttribute('hidden')
      }
      else {
        menu.setAttribute('hidden', '')
      }


    }
    async function loadFirst() {
      var iframe = getElementById1("generated-page-iframe");

      // Wait for the iframe to load completely
      await new Promise(resolve => {
        iframe.addEventListener("load", resolve);

      });
      var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
      const lastActionTime = getElementById1('last-action-time');
      lastActionTime.addEventListener('dblclick', function () {
        // Handle double-click event here
        console.log('Double-clicked on the button');
        // Add your custom logic for double-click handling
      });
      const loadingScreen = getElementById1('loading');
      loadingScreen.style.display = 'flex';
      const timerElement = getElementById1('timer');
      let tenthsOfSeconds = 0;
      const interval = setInterval(function () {
        tenthsOfSeconds++;
        timerElement.textContent = (tenthsOfSeconds / 10).toFixed(1);
      }, 100);
      const urlParams = new URLSearchParams(window.location.search);
      const idFromQuery = urlParams.get('id');
      const toPublish = urlParams.get('publish')
      if (idFromQuery) {
        // Change the id of the element with id "component-element"
        const compTree = getElementById1('components-tree')
        const component_el = getElementById1('component-element')
        const newEl2 = component_el.cloneNode(true)
        newEl2.id = idFromQuery + '-tree'
        compTree.append(newEl2)

        const builderElement = getElementById1('63ae5927-390f-4391-993d-b25ab09c8ada');
        if (builderElement) {
          builderElement.id = idFromQuery;
        }

        // Change the text content of the button with data-element "code-tree-tag-name-button"
        const componentNameButton = document.querySelector('[data-element="code-tree-tag-name-button"]');
        if (componentNameButton) {
          componentNameButton.innerText = `🧩${idFromQuery}`;
        }
      }
      await loadFromDb()
      if (updateComponentsMap) {
        const componentsIds = Object.keys(cache)
        const response1 = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ id: idFromQuery, sk: 'componentsMap', items: componentsIds }),
        });

      }
      await handleHead()
      await handleSelectedDependeeChange()
      await handleDependency()
      await handleWebPageMenu()

      await handleItemLink()
      //dispatch event
      await handleImportMenu()

      if (toPublish == "1") {
        await publish()
      }
      const event = new CustomEvent("pageloaded")
      document.dispatchEvent(event)


      //first menu
      let buttons = querySelectorAll1('button[data-element="code-tree-tag-name-button"]');
      /*
      buttons.forEach(function (button) {
        button.addEventListener('click', e => loader(e, handleComponentClick));
      });*/
      clearInterval(interval);
      console.log(timerElement.textContent)
      if (localStorage.getItem('visualOn')) {

        getElementById1('transform').click()
      }
      lastActionTime.textContent = timerElement.textContent;
      loadingScreen.style.display = 'none';

    }
    function generateCombinations(data) {
      const combinations = [];

      data.forEach(item => {
        item.items.forEach(attribute => {
          const combination = {
            legend: item.legend,
            attribute: attribute
          };
          combinations.push(combination);
        });
      });

      const result = [];
      const combine = (arr, idx, current) => {
        if (idx === arr.length) {
          result.push(current);
          return;
        }
        arr[idx].items.forEach(item => {
          combine(arr, idx + 1, current + `${arr[idx].legend}:${item};`);
        });
      };

      combine(data, 0, '');

      return result;
    }
    const openRemoveSku = (event) => {
      const menu = event.target.parentNode.querySelector('#remove-sku-menu')
      menu.style.display = 'block'
    }
    const removeSku = async (event) => {

      const sku = event.target.parentNode.parentNode.querySelector('#sku-value').textContent
      pathItem.sku = undefined
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(pathItem),
      });
      /*
      const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${sku}&startsWith=true`)
        .then(response => response.json())

      const res = await Promise.all(items.map(async item => {
        const deleteUrl = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item.id}:${item.sk}`;
        const response = await fetch(deleteUrl, {
method: 'DELETE',
headers: {
  'Content-Type': 'application/json',
  // Add any additional headers if needed
},

        });
      }))*/
      //to complete
      event.target.parentNode.parentNode.remove()
      getElementById1("input-sku").removeAttribute('hidden')
      getElementById1("create-sku").removeAttribute('hidden')
    }
    const addSku = async (event) => {
      const value = getElementById1('input-sku').value

      const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${value}&sk=created:&startsWith=true`)
        .then(response => response.json())
      if (items.length) {
        const ownerid = localStorage.getItem('ownerid')
        if (items[0].ownerUUID.replace('sku:', '') === ownerid) {
          pathItem.sku = value
          const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(pathItem),
          });
          showSku(value)
          return
          //alert('adding sku in progress')
        }
        else {
          getElementById1('input-sku').value = ''

        }
        return


      }
      const resultList = await getProductAttributes(true)
      const combinations = generateCombinations(resultList)
      pathItem.sku = value
      pathItem.combinations = combinations.length
      //update path item
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(pathItem),
      });
      // add sku 
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id: value, sk: 'created:' + new Date().getTime().toString(), ownerUUID: 'sku:' + localStorage.getItem('ownerid') }),
      });
      //create sku
      for (const combination of combinations) {
        const item = {
          id: value,
          sk: 'qty;' + combination,
          qty: 0
        }
        if (combinations.length === 1) {
          item.sk = "qty;solo"
        }
        const existing = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/' + value + ':' + item.sk)
          .then(response => response.json())
        if (!existing) {
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(item),
          });
        }
      }
      if (combinations.length === 1) {
        querySelectorAll1('[data-builder-schema="aggregate-product"]').forEach(element => {
          const el =
          {
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: element.id + '-tree',

          }
          pushAction(el)
        })
      }
      else {
        querySelectorAll1('[data-builder-schema="single-product"]').forEach(element => {
          const el =
          {
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: element.id + '-tree',

          }
          pushAction(el)
        })
      }
      showSku(value, true)
      setDataProduct(value, resultList)
    }
    const setDataProduct = async (sku, items) => {
      const dataProductEls = querySelectorAll1('[data-product=""]')
      const splited = pathItemPath.split(';')[0].split('/')
      const name = splited[splited.length - 1]
      dataProductEls.forEach(async dataProductEl => {
        const el = {
          time: (new Date()).getTime(),
          action: 'setAttribute',
          target_element: dataProductEl.id + '-tree',
          key: 'data-product',
          value: `${sku}`,

        }
        await pushAction(el)
      })
      console.log(JSON.stringify(items))
      if (items.length > 1 || items[0]?.items.length > 1) {

        for (const item of items) {
          const form = item.form
          var labels = form.querySelectorAll('label[data-product-attribute]');
          const defaultCheckbox = form.querySelector('input[type="radio"]')
          // Loop through each label
          for (let i = 0; i < labels.length; i++) {
            const label = labels[i]
            // Find the corresponding input element
            const compositeId = item.legend + '-' + label.textContent
            //duplicate checkbox and insert before label
            const actionObject = {
              time: (new Date()).getTime(),
              action: 'InsertBefore',
              target_element: label.id + '-tree',
              inserted_element: { originalId: defaultCheckbox.id + '-tree', id: compositeId + '-tree' },
            };
            //await pushAction(actionObject);



            //set for in label
            const el = {
              time: (new Date()).getTime(),
              action: 'setAttribute',
              target_element: label.id + '-tree',
              key: 'for',
              value: compositeId,

            }
            //await pushAction(el)
            //set for in label
            const input = label.querySelector('input[type="radio"]')
            const el1 = {
              time: (new Date()).getTime(),
              action: 'setAttribute',
              target_element: input.id + '-tree',
              key: 'name',
              value: sku + ';' + item.legend,

            }
            await pushAction(el1)

            if (i === 0) {
              const el = {
                time: (new Date()).getTime(),
                action: 'setAttribute',
                target_element: input.id + '-tree',
                key: 'checked',
                value: 'true',

              }
              await pushAction(el)
            }

          };
          const el =
          {
            time: (new Date()).getTime(),
            action: 'removeTag',
            target_element: defaultCheckbox.id + '-tree',

          }
          //await pushAction(el)
        }

      }
      else {
        const element = items[0].form
        const el =
        {
          time: (new Date()).getTime(),
          action: 'removeTag',
          target_element: element.id + '-tree',

        }
        //await pushAction(el)
      }
    }
    const getProductAttributes = async (setNumbers) => {
      const resultList = [];
      const forms = querySelectorAll1('[data-product-attribute-form]');

      for (let i = 0; i < forms.length; i++) {
        const form = forms[i]
        if (setNumbers) {
          const el = {
            time: (new Date()).getTime(),
            action: 'setAttribute',
            target_element: forms[i].id + '-tree',
            key: 'data-product-attribute-form',
            value: i + 1,

          }
          await pushAction(el)
        }
        const legendElement = form.querySelector('[data-product-attribute-legend]');
        const legend = legendElement && legendElement.textContent;

        const attributeElements = form.querySelectorAll('[data-product-attribute]');
        const attributes = Array.from(attributeElements).map(element => element.textContent);

        resultList.push({
          form,
          legend: legend,
          items: attributes
        });
      };
      return resultList
    }
    const handleSkuItemClick = (cloned, item, sku) => {
      let newItem = { ...item }
      const variant = item.sk.replace('qty;', '')
      if (!cloned.nextElementSibling?.id.startsWith('stock-menu')) {
        const stockMenuCloned = document.getElementById('stock-menu').cloneNode(true)
        stockMenuCloned.id = stockMenuCloned.id + ';' + item.sk.replace('qty;', '')
        cloned.insertAdjacentElement('afterend', stockMenuCloned)
        let type = 'digital-good'
        const handleTypeChange = (e) => {
          if (e.target.id === 'digital-good') {
            if (e.target.checked) {
              stockMenuCloned.parentNode.querySelector('#digital-menu').removeAttribute('hidden')
              stockMenuCloned.parentNode.querySelector('#real-goods-menu').setAttribute('hidden', '')
              type = 'digital-good'
            }
            else {
              stockMenuCloned.parentNode.querySelector('#digital-menu').setAttribute('hidden', '')
              stockMenuCloned.parentNode.querySelector('#real-goods-menu').removeAttribute('hidden')
              type = 'real-good'
            }
          }
          if (e.target.id === 'real-good') {
            if (e.target.checked) {
              stockMenuCloned.parentNode.querySelector('#real-goods-menu').removeAttribute('hidden')
              stockMenuCloned.parentNode.querySelector('#digital-menu').setAttribute('hidden', '')
              type = 'real-good'
            }
            else {
              stockMenuCloned.parentNode.querySelector('#real-goods-menu').setAttribute('hidden', '')
              stockMenuCloned.parentNode.querySelector('#digital-menu').removeAttribute('hidden')
              type = 'digital-good'
            }
          }

        }
        stockMenuCloned.querySelectorAll('input[type="radio"][name="choose-goods-type"]').forEach(e => e.addEventListener('change', handleTypeChange));
        const qtyMenu = document.getElementById('stock-qty')

        const handleStockQtyClick = (e) => {
          if (!stockMenuCloned.nextElementSibling?.id.startsWith('stock-qty')) {
            const clonedQty = qtyMenu.cloneNode(true)
            clonedQty.id = clonedQty.id + ';' + sku
            item.qty && (clonedQty.querySelector('input').value = item.qty)
            const handleUpdateQty = (e) => {
              newItem.qty = clonedQty.querySelector('input').value
              fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                body: JSON.stringify(newItem),
              });
              cloned.querySelector('#sku-qty').textContent = newItem.qty
              clonedQty.remove()
            }
            clonedQty.querySelector('#update-qty').addEventListener('click', handleUpdateQty)

            stockMenuCloned.insertAdjacentElement('afterend', clonedQty)
            stockMenuCloned.remove()

          }
        }
        const addStockMenu = document.getElementById('add-stock-menu')
        const handleAddStock = (e) => {
          if (!stockMenuCloned.nextElementSibling?.id.startsWith('add-stock-menu')) {
            const clonedAddStock = addStockMenu.cloneNode(true)
            clonedAddStock.id = clonedAddStock.id + ';' + sku

            const handleSaveStock = async (e) => {
              const input = clonedAddStock.querySelector('#add-stock-input').value
              const lines = input.split('\n').map(e => e.trim()).filter(line => line)
              for (const line of lines) {

                const timeStamp = (new Date()).getTime().toString()
                const ownerid = localStorage.getItem('ownerid')
                const body = {
                  id: item.id,
                  sk: 'stock-item;' + variant + timeStamp,
                  lsi1: timeStamp + ':' + line,
                  ownerUUID: `free:${item.id};${variant}`,
                  type

                }
                const response = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                  method: 'POST',
                  body: JSON.stringify(body),
                });
              }
              //update qty
              newItem.qty ? (newItem.qty += lines.length) : (newItem.qty = lines.length)
              fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                body: JSON.stringify(newItem),
              });
              cloned.querySelector('#sku-qty').textContent = newItem.qty
              clonedAddStock.remove()
            }
            clonedAddStock.querySelectorAll('[save-stock]').forEach(e => e.addEventListener("click", handleSaveStock))


            stockMenuCloned.insertAdjacentElement('afterend', clonedAddStock)
            stockMenuCloned.remove()

          }
        }

        const viewStockMenu = document.getElementById('view-stock')
        const stockItem0 = document.querySelector('[stockItem]')
        const handleViewStock = async (e) => {
          if (!stockMenuCloned.nextElementSibling?.id.startsWith('view-stock')) {
            const clonedViewStock = viewStockMenu.cloneNode(true)
            clonedViewStock.id = clonedViewStock.id + ';' + sku
            const url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${item.id}&sk=${'stock-item;' + variant}&startsWith=true&descending=true&pageSize=100`
            const res = await fetch(url, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(el => el.json())
            console.log(JSON.stringify(res))

            const table = clonedViewStock.querySelector('#stock-table-body')
            for (const item of res.items) {
              const clonedStockItem = stockItem0.cloneNode(true)
              const key = item.lsi1.split(':')[1]
              clonedStockItem.id = clonedStockItem.id + ';' + key
              clonedStockItem.removeAttribute('hidden')
              clonedStockItem.querySelector('#stock-item-value').textContent = key
              clonedStockItem.querySelector('#stock-item-status').textContent = item.ownerUUID.split(';')[0].split(':')[0]
              table.append(clonedStockItem)
            }

            stockMenuCloned.insertAdjacentElement('afterend', clonedViewStock)
            stockMenuCloned.remove()

          }
        }
        const stockLabelMenu = document.getElementById('stock-label')
        const handleStockLabel = async (e) => {
          if (!stockMenuCloned.nextElementSibling?.id.startsWith('stock-label')) {
            const clonedstockLabel = stockLabelMenu.cloneNode(true)
            clonedstockLabel.id = clonedstockLabel.id + ';' + sku
            clonedstockLabel.querySelector('#stock-label-input').value = newItem.label || ''
            clonedstockLabel.querySelector('#update-label').addEventListener('click', async (e) => {
              const newLabel = clonedstockLabel.querySelector('#stock-label-input').value
              newItem.label = newLabel
              item.label = newLabel
              await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                body: JSON.stringify(newItem),
              });
              clonedstockLabel.remove()

            })
            stockMenuCloned.insertAdjacentElement('afterend', clonedstockLabel)
            stockMenuCloned.remove()

          }
        }
        stockMenuCloned.querySelectorAll('[stock-qty]').forEach(e => {
          e.addEventListener("click", handleStockQtyClick)
        })
        stockMenuCloned.querySelector('[add-stock]').addEventListener("click", handleAddStock)
        stockMenuCloned.querySelector('[view-stock]').addEventListener("click", handleViewStock)
        stockMenuCloned.querySelector('[stock-label]').addEventListener("click", handleStockLabel)


      }

    }

    const showSku = async (sku) => {

      const item1 = getElementById1("sku-item-1")
      getElementById1("input-sku").setAttribute('hidden', '')
      getElementById1("create-sku").setAttribute('hidden', '')
      const cloned1 = item1.cloneNode(true)
      cloned1.id = sku
      cloned1.removeAttribute('hidden')
      getElementById1("sku-list").removeAttribute('hidden')
      cloned1.querySelector("#sku-value").textContent = sku
      cloned1.querySelector("#remove-sku").removeAttribute('hidden')
      const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${sku}&sk=qty;&startsWith=true`)
        .then(response => response.json())
      const el = cloned1.querySelectorAll('#sku-item')
      const parent = cloned1.querySelector('#sku-attribute-list')
      if (items.length > 1) {

        for (const item of items) {

          const cloned = el[0].cloneNode(true)
          cloned.querySelector('#sku-attribute-value').textContent = item.sk.replace('qty;', '')
          cloned.querySelector('#sku-qty').textContent = item.qty || 0
          parent.appendChild(cloned)
          cloned.addEventListener('click', e => handleSkuItemClick(cloned, item))
        }


      }
      else {
        console.log('showing sku')
        const cloned = el[0].cloneNode(true)
        cloned.querySelector('#sku-attribute-value').textContent = 'Solo'
        cloned.querySelector('#sku-qty').textContent = items[0].qty || 0
        parent.appendChild(cloned)
        cloned.addEventListener('click', e => handleSkuItemClick(cloned, items[0], sku))
      }
      getElementById1("sku-list").appendChild(cloned1)
      el.forEach(e => e.remove())
    }
    const handleHead = async () => {

      const resultList = await getProductAttributes()

      if (resultList.length || pathItem.sku) {
        getElementById1('sku-menu').removeAttribute('hidden')

        pathItem.sku && showSku(pathItem.sku, true)



      }
      const splited = pathItemPath.split(';')[0].split('/')
      const name = splited[splited.length - 1]
      /*
      querySelectorAll1('[data-product]').forEach(
        element => {
const prev = element.getAttribute('data-product')
if (prev) {
  const [first, last] = prev.split(';')
  element.setAttribute('data-product', [first, name].join(';'))
}
        }
      )
      */


    }
    const save = async (event) => {
      const parent = event.target.parentNode
      const { id } = parent
      const action = parent.getAttribute('action')
      console.log('ac' + action)
      if (action === 'innerHtml') {
        const saveButton = event.target;
        const fieldset = saveButton.closest('fieldset');

        console.log(id)
        const textareaValue = fieldset.querySelector('#code-tree-inner-html-receive-textarea').value;

        const splited = id.split(';')
        const [toRemove, ...rest] = splited
        const el = {
          time: (new Date()).getTime(),
          action,
          target_element: rest.join(';'),
          insertedCode: textareaValue,

        }
        console.log(JSON.stringify(el))
        await pushAction(el)
      }
      parent.remove()
      console.log(JSON.stringify(actionLog))

    }
    const saveText = async (event) => {
      const parent = event.target.parentNode
      const { id } = parent
      const action = 'textContent'
      console.log('ac' + action)

      const saveButton = event.target;
      const fieldset = saveButton.closest('fieldset');


      const textareaValue = fieldset.querySelector('#code-tree-tag-text-content').value;
      const splited = id.split(';')
      const [toRemove, ...rest] = splited

      const el = {
        time: (new Date()).getTime(),
        action,
        target_element: rest.join(';'),
        value: textareaValue,

      }
      console.log(JSON.stringify(el))
      await pushAction(el)

      parent.remove()
      console.log(JSON.stringify(actionLog))

    }
    const saveInnerHtml = async (event) => {
      const parent = event.target.parentNode
      const { id } = parent
      const action = 'innerHtml'
      console.log('ac' + action)

      const saveButton = event.target;
      const fieldset = saveButton.closest('fieldset');


      const textareaValue = fieldset.querySelector('#code-tree-tag-html-content').value;
      const splited = id.split(';')
      const [toRemove, ...rest] = splited

      const el = {
        time: (new Date()).getTime(),
        action,
        target_element: rest.join(';'),
        insertedCode: textareaValue,

      }
      console.log(JSON.stringify(el))
      await pushAction(el)

      parent.remove()
      console.log(JSON.stringify(actionLog))

    }
    const saveAttribute = async (event) => {
      const parentMenu = event.target.closest('.menu-1');
      const checked = parentMenu.querySelector('#applyToCopies').checked
      if (!parentMenu) {
        console.error('Could not find parent menu element');
        return;
      }

      const { id } = parentMenu
      const action = 'setAttribute'
      console.log('ac' + action)

      const saveButton = event.target;
      const fieldset = saveButton.closest('fieldset');


      //const textareaValue = fieldset.querySelector('#code-tree-tag-attribute-input-key').value;
      //const textareaValue2 = fieldset.querySelector('#code-tree-tag-attribute-input-key-value').value;
      const text = fieldset.querySelector('#code-tree-tag-attribute-input-text').value;
      const splited = id.split(';')
      const [toRemove, ...rest] = splited
      function parseText(text) {
        const lines = text.split('\n');
        const result = [];

        lines.forEach(line => {
          if (line === "") {
            return
          }
          const keyValue = line.replaceAll('"', '').split('=');
          if (keyValue.length >= 2) {
            const key = keyValue[0].trim();
            keyValue.shift()
            const value = keyValue.join('=').trim();
            result.push({ key, value })
          }
          else {
            result.push({ key: line.trim(), value: "" })
          }
        });

        return result;
      }
      const list = parseText(text)
      for (const element of list) {

        const el = {
          time: (new Date()).getTime(),
          action,
          target_element: rest.join(';'),
          key: element.key,
          value: element.value,

        }
        if (checked) {
          el.options = { apply_to_copies: true }
        }
        await pushAction(el)

      }
      fieldset.querySelector('#code-tree-tag-attribute-input-text').value = ""
      //fieldset.querySelector('#code-tree-tag-attribute-input-key').value = ''
      //fieldset.querySelector('#code-tree-tag-attribute-input-key-value').value = ''
      //console.log(JSON.stringify(el))

      parentMenu.remove()
      console.log(JSON.stringify(actionLog))

    }

  </script>
  <script>

    //second menu 
    const cancelReplace = (event) => {

      event.target.parentNode.nextElementSibling.remove()
      event.target.parentNode.remove()
    }
    const cancel = (e) => {

      e.target.parentNode.remove()
    }
    const cancel1 = (e) => {

      // Assuming e is an event object
      const elementToRemove = e.target.closest('[id^="code-tree-tag-attributes-form-1;"]');

      if (elementToRemove) {
        elementToRemove.remove();
      }
    }
    var append = (e) => {
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('code-tree-add-tag-step-1');
      const checked = e.target.parentNode.querySelector('#applyToCopies').checked
      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('code-tree-add-tag-step-1')) {
        const clonedFieldset = fieldset.cloneNode(true);

        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', 'Append')
        checked && clonedFieldset.setAttribute('copiesOfInserting', "true")
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
      }
    }
    var addParent = (e) => {
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('tag-table');
      const applyToCopies = e.target.parentNode.querySelector('#applyToCopies').checked

      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('tag-table')) {
        const clonedFieldset = fieldset.cloneNode(true);

        const clonedRows = clonedFieldset.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        for (let i = 0; i < clonedRows.length; i++) {
          const index = i; // Capture the current value of 'i' in a closure
          clonedRows[i].onclick = function (event) {
            chooseTag(index, event);
          };
        }
        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', "Add_Parent")
        if (applyToCopies) {
          clonedFieldset.querySelector('#applyForCopies2').checked = true
        }

        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
      }
    }

    const insertB = (e) => {


      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('code-tree-add-tag-step-1');
      const checked = e.target.parentNode.querySelector('#applyToCopies').checked
      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('code-tree-add-tag-step-1')) {
        const clonedFieldset = fieldset.cloneNode(true);

        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', 'InsertBefore')
        checked && clonedFieldset.setAttribute('copiesOfInserting', "true")
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
      }

    }
    const insertHtml = (e) => {

      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('code-tree-inner-html-receive-menu');

      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('code-tree-inner-html-receive-menu')) {
        const clonedFieldset = fieldset.cloneNode(true);
        clonedFieldset.querySelector('textarea').value = getElementById1(parentId.replace('-tree', '')).innerHTML
        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', 'innerHtml')
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
      }
    }
    const changeTag = (e) => {
      const splited = e.target.parentNode.id.split(';')
      const checked = e.target.parentNode.querySelector('#applyToCopies').checked
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const fieldset = getElementById1('tag-table');

      if (!e.target.parentNode.nextElementSibling || !e.target.parentNode.nextElementSibling.id.startsWith('tag-table')) {
        const clonedFieldset = fieldset.cloneNode(true);


        const clonedRows = clonedFieldset.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        for (let i = 0; i < clonedRows.length; i++) {
          const index = i; // Capture the current value of 'i' in a closure
          clonedRows[i].onclick = function (event) {
            chooseTag(index, event);
          };
        }
        clonedFieldset.id = clonedFieldset.id + ';' + parentId;
        clonedFieldset.setAttribute('action', 'ChangeTag')
        if (checked) {

          console.log('setting checked')
          clonedFieldset.querySelector('#applyForCopies2').checked = true

        }
        e.target.parentNode.insertAdjacentElement('afterend', clonedFieldset);
        e.target.parentNode.remove()
      }
    }

    const duplicateTag = (e) => {
      const splited = e.target.parentNode.id.split(';');
      const [toRemove, ...rest] = splited;
      const parentId = rest.join(';');
      function duplicateId(originalId,) {
        const splited = originalId.split(';');
        const lastId = splited[splited.length - 1]
        let newLastUUID
        const splited2 = lastId.split(':')
        newLastUUID = splited2[0] + ':' + generateUUID()
        splited.pop()
        return [...splited, newLastUUID].join(';') + '-tree'

      }

      const el = {
        time: (new Date()).getTime(),
        action: 'InsertBefore',
        target_element: parentId,
        inserted_element: { originalId: parentId, id: duplicateId(removeLastOccurrence(parentId, '-tree')) },
      };

      pushAction(el);
    };
    const removeTag = (e) => {
      const checked = e.target.parentNode.querySelector('#applyToCopies').checked
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const el =
      {
        time: (new Date()).getTime(),
        action: 'removeTag',

        target_element: parentId,

      }
      if (checked) {
        el.options = { apply_to_copies: true }
      }
      pushAction(el)
      e.target.parentNode.remove()
    }

    const removeComponent = async (e) => {
      const splited = e.target.parentNode.id.split(';')
      const [toRemove, ...rest] = splited
      const parentId = rest.join(';');
      const el =
      {
        time: (new Date()).getTime(),
        action: 'removeComponent',
        target_element: parentId,

      }
      await pushAction(el)
      location.reload()


    }
    const approve = async (event) => {
      var checkbox = event.target;

      // Get the parent fieldset
      var fieldset = checkbox.closest('fieldset');

      // Get the "Duplicate with Parent" checkbox
      var duplicateCheckbox = fieldset.querySelector('#code-tree-menu-dublicate-with-parent-option');

      // Check if the "Duplicate with Parent" checkbox is checked
      var isDuplicateWithParent = duplicateCheckbox.checked;
      var copyInsertingCheckbox = fieldset.querySelector('#code-tree-menu-copies-too');
      var isCopiesOfInserting = copyInsertingCheckbox.checked;
      // Get the id and action attributes
      var fieldsetId = fieldset.id;
      var fieldsetAction = fieldset.getAttribute('action');

      // Get all fieldsets with data-element="code-tree-tag"
      var codeTreeTagFieldsets = querySelectorAll1('fieldset[data-element="code-tree-tag"]');

      // Iterate through each fieldset and hide them
      codeTreeTagFieldsets.forEach(function (fieldset) {
        var checkbox = fieldset.querySelector('input[type="checkbox"]');
        if (checkbox) {
          checkbox.setAttribute('hidden', 'true');
        }
      });

      // Remove the parent fieldset
      fieldset.remove();

      // Log the id and action attributes (you can replace this with your desired logic)
      console.log("Fieldset ID:", fieldsetId);
      console.log("Fieldset Action:", fieldsetAction);
      const splited = fieldsetId.split(';')
      splited.shift()
      const id = splited.join(';')

      if (isDuplicateWithParent) {
        pushAction({
          time: (new Date()).getTime(),
          action: fieldsetAction,
          options: { dub_target: true, insert_copies: true },
          target_element: [{ type: 'tag', id, }, ...selected.map(id => {
            return { type: 'tag', id }
          })],
        })


      }
      else if (isCopiesOfInserting) {
        pushAction({
          time: (new Date()).getTime(),
          action: fieldsetAction,
          options: { insert_copies: true },
          target_element: [{ type: 'tag', id, }, ...selected.map(id => {
            return { type: 'tag', id }
          })],
        })
      }
      else {
        let el2 = {
          time: (new Date()).getTime(),
          action: fieldsetAction,
          target_element: [{ type: 'tag', id, }, ...selected.map(id => {
            return { type: 'tag', id }
          })],
        }
        pushAction(el2)
      }
      selected = []
      event.target.parentNode.remove()
    }

  </script>

  <script>const tags =
      [
        {
          "tagName": "head",
          "tagValue": "<head></head>",
          "TagComment": "Contains metadata/information for the document",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "title",
          "tagValue": "<title></title>",
          "TagComment": "Defines a title for the document",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "body",
          "tagValue": "<body></body>",
          "TagComment": "Defines the document's body",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "h1",
          "tagValue": "<h1></h1>",
          "TagComment": "Defines HTML headings",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "h2",
          "tagValue": "<h2></h2>",
          "TagComment": "Defines HTML headings",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "h3",
          "tagValue": "<h3></h3>",
          "TagComment": "Defines HTML headings",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "h4",
          "tagValue": "<h4></h4>",
          "TagComment": "Defines HTML headings",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "h5",
          "tagValue": "<h5></h5>",
          "TagComment": "Defines HTML headings",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "h6",
          "tagValue": "<h6></h6>",
          "TagComment": "Defines HTML headings",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "p",
          "tagValue": "<p></p>",
          "TagComment": "Defines a paragraph",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "br",
          "tagValue": "<br>",
          "TagComment": "Inserts a single line break",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "hr",
          "tagValue": "<hr>",
          "TagComment": "Defines a thematic change in the content",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "!--...--",
          "tagValue": "<!--...-->",
          "TagComment": "Defines a comment",
          "TagType": "Basic HTML"
        },
        {
          "tagName": "abbr",
          "tagValue": "<abbr></abbr>",
          "TagComment": "Defines an abbreviation or an acronym",
          "TagType": "Formatting"
        },
        {
          "tagName": "address",
          "tagValue": "<address></address>",
          "TagComment": "Defines contact information for the author/owner of a document/article",
          "TagType": "Formatting"
        },
        {
          "tagName": "b",
          "tagValue": "<b></b>",
          "TagComment": "Defines bold text",
          "TagType": "Formatting"
        },
        {
          "tagName": "bdi",
          "tagValue": "<bdi></bdi>",
          "TagComment": "Isolates a part of text that might be formatted in a different direction from other text outside it",
          "TagType": "Formatting"
        },
        {
          "tagName": "bdo",
          "tagValue": "<bdo></bdo>",
          "TagComment": "Overrides the current text direction",
          "TagType": "Formatting"
        },
        {
          "tagName": "blockquote",
          "tagValue": "<blockquote></blockquote>",
          "TagComment": "Defines a section that is quoted from another source",
          "TagType": "Formatting"
        },
        {
          "tagName": "cite",
          "tagValue": "<cite></cite>",
          "TagComment": "Defines the title of a work",
          "TagType": "Formatting"
        },
        {
          "tagName": "code",
          "tagValue": "<code></code>",
          "TagComment": "Defines a piece of computer code",
          "TagType": "Formatting"
        },
        {
          "tagName": "del",
          "tagValue": "<del></del>",
          "TagComment": "Defines text that has been deleted from a document",
          "TagType": "Formatting"
        },
        {
          "tagName": "dfn",
          "tagValue": "<dfn></dfn>",
          "TagComment": "Specifies a term that is going to be defined within the content",
          "TagType": "Formatting"
        },
        {
          "tagName": "em",
          "tagValue": "<em></em>",
          "TagComment": "Defines emphasized text",
          "TagType": "Formatting"
        },
        {
          "tagName": "i",
          "tagValue": "<i></i>",
          "TagComment": "Defines a part of text in an alternate voice or mood",
          "TagType": "Formatting"
        },
        {
          "tagName": "ins",
          "tagValue": "<ins></ins>",
          "TagComment": "Defines a text that has been inserted into a document",
          "TagType": "Formatting"
        },
        {
          "tagName": "kbd",
          "tagValue": "<kbd></kbd>",
          "TagComment": "Defines keyboard input",
          "TagType": "Formatting"
        },
        {
          "tagName": "mark",
          "tagValue": "<mark></mark>",
          "TagComment": "Defines marked/highlighted text",
          "TagType": "Formatting"
        },
        {
          "tagName": "meter",
          "tagValue": "<meter></meter>",
          "TagComment": "Defines a scalar measurement within a known range (a gauge)",
          "TagType": "Formatting"
        },
        {
          "tagName": "pre",
          "tagValue": "<pre></pre>",
          "TagComment": "Defines preformatted text",
          "TagType": "Formatting"
        },
        {
          "tagName": "progress",
          "tagValue": "<progress></progress>",
          "TagComment": "Represents the progress of a task",
          "TagType": "Formatting"
        },
        {
          "tagName": "q",
          "tagValue": "<q></q>",
          "TagComment": "Defines a short quotation",
          "TagType": "Formatting"
        },
        {
          "tagName": "rp",
          "tagValue": "<rp></rp>",
          "TagComment": "Defines what to show in browsers that do not support ruby annotations",
          "TagType": "Formatting"
        },
        {
          "tagName": "rt",
          "tagValue": "<rt></rt>",
          "TagComment": "Defines an explanation/pronunciation of characters (for East Asian typography)",
          "TagType": "Formatting"
        },
        {
          "tagName": "ruby",
          "tagValue": "<ruby></ruby>",
          "TagComment": "Defines a ruby annotation (for East Asian typography)",
          "TagType": "Formatting"
        },
        {
          "tagName": "s",
          "tagValue": "<s></s>",
          "TagComment": "Defines text that is no longer correct",
          "TagType": "Formatting"
        },
        {
          "tagName": "samp",
          "tagValue": "<samp></samp>",
          "TagComment": "Defines sample output from a computer program",
          "TagType": "Formatting"
        },
        {
          "tagName": "small",
          "tagValue": "<small></small>",
          "TagComment": "Defines smaller text",
          "TagType": "Formatting"
        },
        {
          "tagName": "strong",
          "tagValue": "<strong></strong>",
          "TagComment": "Defines important text",
          "TagType": "Formatting"
        },
        {
          "tagName": "sub",
          "tagValue": "<sub></sub>",
          "TagComment": "Defines subscripted text",
          "TagType": "Formatting"
        },
        {
          "tagName": "sup",
          "tagValue": "<sup></sup>",
          "TagComment": "Defines superscripted text",
          "TagType": "Formatting"
        },
        {
          "tagName": "template",
          "tagValue": "<template></template>",
          "TagComment": "Defines a container for content that should be hidden when the page loads",
          "TagType": "Formatting"
        },
        {
          "tagName": "time",
          "tagValue": "<time></time>",
          "TagComment": "Defines a specific time (or datetime)",
          "TagType": "Formatting"
        },
        {
          "tagName": "u",
          "tagValue": "<u></u>",
          "TagComment": "Defines some text that is unarticulated and styled differently from normal text",
          "TagType": "Formatting"
        },
        {
          "tagName": "var",
          "tagValue": "<var></var>",
          "TagComment": "Defines a variable",
          "TagType": "Formatting"
        },
        {
          "tagName": "wbr",
          "tagValue": "<wbr>",
          "TagComment": "Defines a possible line-break",
          "TagType": "Formatting"
        },
        {
          "tagName": "form",
          "tagValue": "<form></form>",
          "TagComment": "Defines an HTML form for user input",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "input",
          "tagValue": "<input>",
          "TagComment": "Defines an input control",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "textarea",
          "tagValue": "<textarea></textarea>",
          "TagComment": "Defines a multiline input control (text area)",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "button",
          "tagValue": "<button></button>",
          "TagComment": "Defines a clickable button",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "select",
          "tagValue": "<select></select>",
          "TagComment": "Defines a drop-down list",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "optgroup",
          "tagValue": "<optgroup></optgroup>",
          "TagComment": "Defines a group of related options in a drop-down list",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "option",
          "tagValue": "<option></option>",
          "TagComment": "Defines an option in a drop-down list",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "label",
          "tagValue": "<label></label>",
          "TagComment": "Defines a label for an <input> element",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "fieldset",
          "tagValue": "<fieldset></fieldset>",
          "TagComment": "Groups related elements in a form",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "legend",
          "tagValue": "<legend></legend>",
          "TagComment": "Defines a caption for a <fieldset> element",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "datalist",
          "tagValue": "<datalist></datalist>",
          "TagComment": "Specifies a list of pre-defined options for input controls",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "output",
          "tagValue": "<output></output>",
          "TagComment": "Defines the result of a calculation",
          "TagType": "Forms and Input"
        },
        {
          "tagName": "iframe",
          "tagValue": "<iframe></iframe>",
          "TagComment": "Defines an inline frame",
          "TagType": "Frames"
        },
        {
          "tagName": "img",
          "tagValue": "<img>",
          "TagComment": "Defines an image",
          "TagType": "Images"
        },
        {
          "tagName": "map",
          "tagValue": "<map></map>",
          "TagComment": "Defines a client-side image map",
          "TagType": "Images"
        },
        {
          "tagName": "area",
          "tagValue": "<area>",
          "TagComment": "Defines an area inside an image map",
          "TagType": "Images"
        },
        {
          "tagName": "canvas",
          "tagValue": "<canvas></canvas>",
          "TagComment": "Used to draw graphics, on the fly, via scripting (usually JavaScript)",
          "TagType": "Images"
        },
        {
          "tagName": "figcaption",
          "tagValue": "<figcaption></figcaption>",
          "TagComment": "Defines a caption for a <figure> element",
          "TagType": "Images"
        },
        {
          "tagName": "figure",
          "tagValue": "<figure></figure>",
          "TagComment": "Specifies self-contained content",
          "TagType": "Images"
        },
        {
          "tagName": "picture",
          "tagValue": "<picture></picture>",
          "TagComment": "Defines a container for multiple image resources",
          "TagType": "Images"
        },
        {
          "tagName": "audio",
          "tagValue": "<audio></audio>",
          "TagComment": "Defines sound content",
          "TagType": "Audio / Video"
        },
        {
          "tagName": "source",
          "tagValue": "<source>",
          "TagComment": "Defines multiple media resources for media elements (<video>, <audio> and <picture>)",
          "TagType": "Audio / Video"
        },
        {
          "tagName": "track",
          "tagValue": "<track>",
          "TagComment": "Defines text tracks for media elements (<video> and <audio>)",
          "TagType": "Audio / Video"
        },
        {
          "tagName": "video",
          "tagValue": "<video></video>",
          "TagComment": "Defines a video or movie",
          "TagType": "Audio / Video"
        },
        {
          "tagName": "a",
          "tagValue": "<a></a>",
          "TagComment": "Defines a hyperlink",
          "TagType": "Links"
        },
        {
          "tagName": "link",
          "tagValue": "<link>",
          "TagComment": "Defines the relationship between a document and an external resource (most used to link to style sheets)",
          "TagType": "Links"
        },
        {
          "tagName": "nav",
          "tagValue": "<nav></nav>",
          "TagComment": "Defines navigation links",
          "TagType": "Links"
        },
        {
          "tagName": "menu",
          "tagValue": "<menu></menu>",
          "TagComment": "Defines an alternative unordered list",
          "TagType": "Lists"
        },
        {
          "tagName": "ul",
          "tagValue": "<ul></ul>",
          "TagComment": "Defines an unordered list",
          "TagType": "Lists"
        },
        {
          "tagName": "ol",
          "tagValue": "<ol></ol>",
          "TagComment": "Defines an ordered list",
          "TagType": "Lists"
        },
        {
          "tagName": "li",
          "tagValue": "<li></li>",
          "TagComment": "Defines a list item",
          "TagType": "Lists"
        },
        {
          "tagName": "dl",
          "tagValue": "<dl></dl>",
          "TagComment": "Defines a description list",
          "TagType": "Lists"
        },
        {
          "tagName": "dt",
          "tagValue": "<dt></dt>",
          "TagComment": "Defines a term/name in a description list",
          "TagType": "Lists"
        },
        {
          "tagName": "dd",
          "tagValue": "<dd></dd>",
          "TagComment": "Defines a description of a term/name in a description list",
          "TagType": "Lists"
        },
        {
          "tagName": "table",
          "tagValue": "<table></table>",
          "TagComment": "Defines a table",
          "TagType": "Tables"
        },
        {
          "tagName": "caption",
          "tagValue": "<caption></caption>",
          "TagComment": "Defines a table caption",
          "TagType": "Tables"
        },
        {
          "tagName": "th",
          "tagValue": "<th></th>",
          "TagComment": "Defines a header cell in a table",
          "TagType": "Tables"
        },
        {
          "tagName": "tr",
          "tagValue": "<tr></tr>",
          "TagComment": "Defines a row in a table",
          "TagType": "Tables"
        },
        {
          "tagName": "td",
          "tagValue": "<td></td>",
          "TagComment": "Defines a cell in a table",
          "TagType": "Tables"
        },
        {
          "tagName": "thead",
          "tagValue": "<thead></thead>",
          "TagComment": "Groups the header content in a table",
          "TagType": "Tables"
        },
        {
          "tagName": "tbody",
          "tagValue": "<tbody></tbody>",
          "TagComment": "Groups the body content in a table",
          "TagType": "Tables"
        },
        {
          "tagName": "tfoot",
          "tagValue": "<tfoot></tfoot>",
          "TagComment": "Groups the footer content in a table",
          "TagType": "Tables"
        },
        {
          "tagName": "col",
          "tagValue": "<col>",
          "TagComment": "Specifies column properties for each column within a <colgroup> element",
          "TagType": "Tables"
        },
        {
          "tagName": "colgroup",
          "tagValue": "<colgroup></colgroup>",
          "TagComment": "Specifies a group of one or more columns in a table for formatting",
          "TagType": "Tables"
        },
        {
          "tagName": "style",
          "tagValue": "<style></style>",
          "TagComment": "🎨Defines style information for a document🎨",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "div",
          "tagValue": "<div></div>",
          "TagComment": "Defines a section in a document",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "span",
          "tagValue": "<span></span>",
          "TagComment": "Defines a section in a document",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "header",
          "tagValue": "<header></header>",
          "TagComment": "Defines a header for a document or section",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "hgroup",
          "tagValue": "<hgroup></hgroup>",
          "TagComment": "Defines a header and related content",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "footer",
          "tagValue": "<footer></footer>",
          "TagComment": "Defines a footer for a document or section",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "main",
          "tagValue": "<main></main>",
          "TagComment": "Specifies the main content of a document",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "section",
          "tagValue": "<section></section>",
          "TagComment": "Defines a section in a document",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "search",
          "tagValue": "<search></search>",
          "TagComment": "Defines a search section",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "article",
          "tagValue": "<article></article>",
          "TagComment": "Defines an article",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "aside",
          "tagValue": "<aside></aside>",
          "TagComment": "Defines content aside from the page content",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "details",
          "tagValue": "<details></details>",
          "TagComment": "Defines additional details that the user can view or hide",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "dialog",
          "tagValue": "<dialog></dialog>",
          "TagComment": "Defines a dialog box or window",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "summary",
          "tagValue": "<summary></summary>",
          "TagComment": "Defines a visible heading for a <details> element",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "data",
          "tagValue": "<data></data>",
          "TagComment": "Adds a machine-readable translation of a given content",
          "TagType": "Styles and Semantics"
        },
        {
          "tagName": "meta",
          "tagValue": "<meta>",
          "TagComment": "Defines metadata about an HTML document",
          "TagType": "Meta Info"
        },
        {
          "tagName": "base",
          "tagValue": "<base>",
          "TagComment": "Specifies the base URL/target for all relative URLs in a document",
          "TagType": "Meta Info"
        },
        {
          "tagName": "script",
          "tagValue": "<scrip></scrip>",
          "TagComment": "💻Defines a client-side script💻",
          "TagType": "Programming"
        },
        {
          "tagName": "noscript",
          "tagValue": "<noscript></noscript>",
          "TagComment": "Defines an alternate content for users that do not support client-side scripts",
          "TagType": "Programming"
        },
        {
          "tagName": "embed",
          "tagValue": "<embed></embed>",
          "TagComment": "Defines a container for an external (non-HTML) application",
          "TagType": "Programming"
        },
        {
          "tagName": "object",
          "tagValue": "<object></object>",
          "TagComment": "Defines an embedded object",
          "TagType": "Programming"
        },
        {
          "tagName": "param",
          "tagValue": "<param>",
          "TagComment": "Defines a parameter for an object",
          "TagType": "Programming"
        },
        {
          "tagName": "svg",
          "tagValue": "<svg></svg>",
          "TagComment": "Defines a container for SVG graphics",
          "TagType": "Images"
        },
        {
          "tagName": "path",
          "tagValue": "<path>",
          "TagComment": "svg",
          "TagType": "svg"
        },
        {
          "tagName": "text",
          "tagValue": "<text></text>",
          "TagComment": "svg",
          "TagType": "svg"
        }
      ];


    function buildTable() {
      const tableBody = getElementById1('tagsTable').getElementsByTagName('tbody')[0];

      tags.forEach((tag, index) => {
        let row = tableBody.insertRow();
        row.onclick = function (event) { chooseTag(index, event); };

        let tagNameCell = row.insertCell(0);
        let tagValueCell = row.insertCell(1);
        let tagTypeCell = row.insertCell(2);
        let tagCommentCell = row.insertCell(3);

        tagNameCell.textContent = tag.tagName;
        tagValueCell.textContent = tag.tagValue;
        tagTypeCell.textContent = tag.TagType;
        tagCommentCell.textContent = tag.TagComment;
      });
    }
    function filterTable(column) {
      let input, filter, table, tr, td, i, txtValue;
      input = getElementById1("tagsTable").getElementsByTagName("thead")[0].getElementsByTagName("input")[column];
      filter = input.value.toUpperCase();
      table = getElementById1("tagsTable");
      tr = table.getElementsByTagName("tr");

      for (i = 2; i < tr.length; i++) {
        td = tr[i].getElementsByTagName("td")[column];
        if (td) {
          txtValue = td.textContent || td.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
          } else {
            tr[i].style.display = "none";
          }
        }
      }
    }
    function chooseTag(index, event) {
      console.log('in')
      console.log(event)
      let chosenTag = tags[index];
      //alert("Chosen Tag Name: " + chosenTag.tagName + "\nChosen Tag Value: " + chosenTag.tagValue);

      // Get the fieldset attributes
      const fieldset = event.currentTarget.closest('fieldset');
      if (fieldset) {
        const fieldsetId = fieldset.id;
        const fieldsetAction = fieldset.getAttribute('action');
        const apply_to_copies = fieldset.getAttribute('copiesOfInserting');
        console.log("Fieldset ID:", fieldsetId);
        console.log("Fieldset Action:", fieldsetAction);
        const splited = fieldsetId.split(';')
        splited.shift()
        splited.join(';')
        const el =
        {
          time: (new Date()).getTime(),
          action: fieldsetAction,
          target_element: splited.join(';'),

        }
        const applyToCopies2 = fieldset.querySelector('#applyForCopies2').checked
        if (applyToCopies2) {
          el.options = { apply_to_copies: true }
        }
        if (fieldsetAction === 'ChangeTag') {
          el.tag_change = chosenTag.tagName
        }

        else {
          el.inserted_element = { type: 'tag', tagValue: chosenTag.tagValue, tagName: chosenTag.tagName, id: generateUUID() }
        }
        pushAction(el)
        fieldset.remove()
      }
    }

    window.onload = buildTable;    </script>

  <style>
    .highlight-left-border-red {
      border-left-color: blue;
      transition: 0.1s ease;

    }

    .highlight-red {
      border-color: blue;
      transition: 0.1s ease;
      background-color: rgb(88, 105, 255)
    }


    .highlight-left-border-blue {
      border-left-color: red;


    }

    .highlight-blue {
      border-color: red;
      transition: 0.1s ease;
      background-color: rgb(255, 88, 88)
    }
  </style>
  <script>
    function mouseOverTree(e) {
      // Highlight this button in red
      e.target.classList.add('highlight-red');

      let parentFieldset = e.target.closest('[data-element="code-tree-tag"]');

      // Highlight the left border of the parent fieldset in red
      if (parentFieldset) {
        parentFieldset.classList.add('highlight-left-border-red');
      }

      // Highlight the left border of sibling fieldsets and their direct child buttons in red
      Array.from(parentFieldset.parentElement.children).forEach(sibling => {
        if (sibling !== parentFieldset && sibling.getAttribute('data-element') === 'code-tree-tag') {
          sibling.classList.add('highlight-left-border-red');
          Array.from(sibling.children).forEach(child => {
            if (child.tagName === 'BUTTON' && child.getAttribute('data-element') === 'code-tree-show-hide-button') {
              child.classList.add('highlight-red');
            }
          });
        }
      });

      // Highlight the left border and buttons of direct child fieldsets of parentFieldset in blue
      Array.from(parentFieldset.children).forEach(child => {
        if (child.tagName === 'FIELDSET' && child.getAttribute('data-element') === 'code-tree-tag') {
          child.classList.add('highlight-left-border-blue');
          Array.from(child.children).forEach(grandchild => {
            if (grandchild.tagName === 'BUTTON' && grandchild.getAttribute('data-element') === 'code-tree-show-hide-button') {
              grandchild.classList.add('highlight-blue');
            }
          });
        }
      });
    }
    function mouseOutTree(e) {
      let parentFieldset = e.target.closest('[data-element="code-tree-tag"]');

      // Remove the red and blue highlights
      e.target.classList.remove('highlight-red');
      if (parentFieldset) {
        parentFieldset.classList.remove('highlight-left-border-red');
      }
      Array.from(parentFieldset.parentElement.children).forEach(sibling => {
        if (sibling !== parentFieldset && sibling.getAttribute('data-element') === 'code-tree-tag') {
          sibling.classList.remove('highlight-left-border-red');
          Array.from(sibling.children).forEach(child => {
            if (child.tagName === 'BUTTON' && child.getAttribute('data-element') === 'code-tree-show-hide-button') {
              child.classList.remove('highlight-red');
            }
          });
        }
      });
      Array.from(parentFieldset.children).forEach(child => {
        if (child.tagName === 'FIELDSET' && child.getAttribute('data-element') === 'code-tree-tag') {
          child.classList.remove('highlight-left-border-blue');
          Array.from(child.children).forEach(grandchild => {
            if (grandchild.tagName === 'BUTTON' && grandchild.getAttribute('data-element') === 'code-tree-show-hide-button') {
              grandchild.classList.remove('highlight-blue');
            }
          });
        }
      });
    }
    querySelectorAll1('button[data-element="code-tree-show-hide-button"]').forEach(button => {
      button.addEventListener('mouseover', mouseOverTree);

      button.addEventListener('mouseout', mouseOutTree);
    });
  </script>
  <!-- dublicate for components-->
  <script>
    function mouseOver(e) {
      // Highlight this button in red
      e.target.classList.add('highlight-red');

      let parentFieldset = e.target.closest('[data-element="component-tree-tag"]');

      // Highlight the left border of the parent fieldset in red
      if (parentFieldset) {
        parentFieldset.classList.add('highlight-left-border-red');
      }

      // Highlight the left border of sibling fieldsets and their direct child buttons in red
      Array.from(parentFieldset.parentElement.children).forEach(sibling => {
        if (sibling !== parentFieldset && sibling.getAttribute('data-element') === 'component-tree-tag') {
          sibling.classList.add('highlight-left-border-red');
          Array.from(sibling.children).forEach(child => {
            if (child.tagName === 'BUTTON' && child.getAttribute('data-element') === 'component-tree-show-hide-button') {
              child.classList.add('highlight-red');
            }
          });
        }
      });

      // Highlight the left border and buttons of direct child fieldsets of parentFieldset in blue
      Array.from(parentFieldset.children).forEach(child => {
        if (child.tagName === 'FIELDSET' && child.getAttribute('data-element') === 'component-tree-tag') {
          child.classList.add('highlight-left-border-blue');
          Array.from(child.children).forEach(grandchild => {
            if (grandchild.tagName === 'BUTTON' && grandchild.getAttribute('data-element') === 'component-tree-show-hide-button') {
              grandchild.classList.add('highlight-blue');
            }
          });
        }
      });
    }
    function mouseOut(e) {
      let parentFieldset = e.target.closest('[data-element="component-tree-tag"]');

      // Remove the red and blue highlights
      e.target.classList.remove('highlight-red');
      if (parentFieldset) {
        parentFieldset.classList.remove('highlight-left-border-red');
      }
      Array.from(parentFieldset.parentElement.children).forEach(sibling => {
        if (sibling !== parentFieldset && sibling.getAttribute('data-element') === 'component-tree-tag') {
          sibling.classList.remove('highlight-left-border-red');
          Array.from(sibling.children).forEach(child => {
            if (child.tagName === 'BUTTON' && child.getAttribute('data-element') === 'component-tree-show-hide-button') {
              child.classList.remove('highlight-red');
            }
          });
        }
      });
      Array.from(parentFieldset.children).forEach(child => {
        if (child.tagName === 'FIELDSET' && child.getAttribute('data-element') === 'component-tree-tag') {
          child.classList.remove('highlight-left-border-blue');
          Array.from(child.children).forEach(grandchild => {
            if (grandchild.tagName === 'BUTTON' && grandchild.getAttribute('data-element') === 'component-tree-show-hide-button') {
              grandchild.classList.remove('highlight-blue');
            }
          });
        }
      });

    }
    querySelectorAll1('button[data-element="component-tree-show-hide-button"]').forEach(button => {
      button.addEventListener('mouseover', mouseOver);

      button.addEventListener('mouseout', mouseOut);

    });

  </script>


  <script>
    /*
    document.addEventListener('DOMContentLoaded', function () {
      var textarea = getElementById1('code-tree-inner-html-receive-textarea');
 
      textarea.addEventListener('input', function (e) {
        // Expand height
        e.target.style.height = 'auto';
        e.target.style.height = (e.target.scrollHeight) + 'px';
 
        // Expand width
        var mirrorDiv = getElementById1('mirror-div');
        if (!mirrorDiv) {
mirrorDiv = document.createElement('div');
mirrorDiv.id = 'mirror-div';
document.body.appendChild(mirrorDiv);
        }
 
        mirrorDiv.style.display = 'inline-block';
        mirrorDiv.textContent = e.target.value.replace(/\n/g, '<br/>');
        e.target.style.width = Math.min(e.target.parentElement.offsetWidth, mirrorDiv.offsetWidth + 10) + 'px'; // 10px for some padding
        mirrorDiv.style.display = 'none';
      });
    });
    */
  </script>


  <script src="js/left-panel.js" async=""></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var userType = localStorage.getItem('usertype');
      var visualOn = localStorage.getItem('visualOn');

      if (userType === null) {
        getElementById1('generated-page').removeAttribute('hidden')
      };


      if (userType === null && visualOn === null) {
        localStorage.setItem('visualOn', 'true');
        location.reload();
      };

    });
  </script>

  <script>
    function reloadPage(e) {
      location.reload();

    }
  </script>
</body>

</html>