<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="css/right-click-menu.css" media="all">
  <link rel="stylesheet" href="css/buttons-and-menus.css" media="all">
  <link rel="stylesheet" href="css/panels.css" media="all">
  <link rel="icon" type="image/png" href="favicon.png">


</head>

<body class="body">

  <div class="login" id="login">
    <div style="position: relative;">
      <div id="error" hidden>
        <label id="error-label" class="l-p"
          style=" user-select: none; width: 400px; display: inline-block;padding: 5px; margin-left: 35px; background: rgb(255, 121, 121);">incorrect
          data</label>
      </div>
      <div>
        <label class="l-1" for="username" style="user-select: none;">👤</label>
        <input placeholder="Username" class="l-2" style="width: 400px; font-size: 18px; padding: 5px;" type="text"
          id="username" name="username">
      </div>
      <div>
        <label class="l-1" for="password" style="user-select: none;">🔑</label>
        <input placeholder="Password" class="l-3" class="l-2" style="width: 400px; font-size: 18px; padding: 5px;"
          type="password" id="password" name="password">
      </div>
      <div>
        <button id="login" onclick="login(event)" class="b-3"
          style="width: 400px; margin-left: 35px;  margin-top: 10px; background: rgb(235, 234, 234); border-color: rgb(184, 182, 182);">➡️
          Login</button>
        <br>
        <button hidden onclick="register(event)" id="login" class="b-3"
          style="width: 400px; margin-left: 35px;  margin-top: 10px; background: rgb(235, 234, 234); border-color: rgb(184, 182, 182);">
          🆕 Register</button>
      </div>
    </div>
  </div>

  <aside hidden class="aside" id="aside_element">
    <div class="panel top">
      <button disabled class="b-1" id="last-action-time"
        style="color: black;z-index:1; position: absolute;top: 50%;left: 50%; transform: translate(-50%, -50%);">0.0</button>
    </div>

    <div class="panel left">
      <div id="nav-buttons">
        <button data-section-button="brains" style="display: none" class="b-1">🧠</button>
        <script>
          document.addEventListener('DOMContentLoaded', function () {
            const element = document.querySelector('[data-section-button="brains"]');
            if (!element) return;

            const helperIdExists = localStorage.getItem('helperid');
            const ownerIdExists = localStorage.getItem('ownerid');

            if (helperIdExists) {
              element.style.display = 'none'; // Скрываем элемент, если есть helperid
            } else if (ownerIdExists) {
              element.style.display = ''; // Показываем элемент, если нет helperid, но есть ownerid
            } else {
              element.style.display = 'none'; // Скрываем элемент, если нет ни ownerid, ни helperid
            }
          });
        </script>
        <button data-section-button="files" class="b-1 b-selected">📂</button>
      </div>

      <div data-section-aside="files" class="local-buttons" style="margin-top: 30px;">
        <button class="b-1" onclick="createNew()">➕</button>
        <button class="b-1" onclick="switchFileList()">🚀</button>

        <button class="b-1" onclick="openColumnsSelector()" id="columns_selector_open">📊</button>
        <div id="columns_selector" style="margin-left: 10px; margin-top: 5px" hidden>
          <div>
            <label class="l-3">
              <input type="checkbox" id="columns_selector_created"
                onchange="setChecked(event, 'created-column','data-column-created')"> 🆕
              created
            </label>
          </div>
          <div>
            <label class="l-3">
              <input type="checkbox" id="columns_selector_published"
                onchange="setChecked(event, 'published-column','data-column-published')"> 📰 published
            </label>
          </div>
          <div>
            <label class="l-3">
              <input type="checkbox" id="columns_selector_updated"
                onchange="setChecked(event, 'updated-column','data-column-updated')"> 🔄 updated
            </label>
          </div>
          <div>
            <label class="l-3">
              <input type="checkbox" id="columns_selector_content_updated"
                onchange="setChecked(event, 'content-column','data-column-content-updated')"> 🗞
              content updated
            </label>
          </div>
          <div>
            <label class="l-3">
              <input type="checkbox" id="columns_selector_removed"
                onchange="setChecked(event, 'removed-column','data-column-removed')"> 🚮
              removed
            </label>
          </div>
        </div>



        <div hidden data-section-aside="brains" class="local-buttons" style="margin-top: 30px;">

          <div data-section-aside="helpers" class="local-buttons" style="margin-top: 30px;">
            <button class="b-1" onclick="createNewHelper()">➕</button>
          </div>

        </div>

      </div>

      <div class="panel bottom">
        <button class="b-1" onclick="removeTokenAndReload()">📴</button>
        <script>function removeTokenAndReload() {
            localStorage.removeItem('token');
            localStorage.removeItem('ownerid');
            localStorage.removeItem('helperid');

            window.location.href = '/templatesv3/';
          }
        </script>
      </div>
  </aside>


  <main hidden class="main" id="main_element">
    <section hidden data-section="brains">
      <div style="margin: 10px;">
        <button onclick="showBrain(event,'sites')" data-brains-button="sites" class="b-4 " style="margin-right: 5px;"
          id="sites-button"><label class="l-1">🌐</label><label class="l-2">Sites</label></button>
        <button onclick="showBrain(event,'orders')" data-brains-button="orders" class="b-4"
          style="margin-right: 5px;"><label class="l-1">🛍️</label><label class="l-2">Orders</label></button>
        <button onclick="showBrain(event,'invoices')" data-brains-button="invoices" class="b-4 "
          style="margin-right: 5px;"><label class="l-1">🧾</label><label class="l-2">Invoices</label></button>
        <button onclick="showBrain(event,'helpers')" data-brains-button="helpers" class="b-4 "
          style="margin-right: 5px;"><label class="l-1">👶</label><label class="l-2">Helpers</label></button>
        <button onclick="showBrain(event,'sku')" data-brains-button="sku" class="b-4 b-selected"
          style="margin-right: 5px;"><label class="l-1">📦</label><label class="l-2">Stock</label></button>
        <button onclick="showBrain(event,'settings')" data-brains-button="settings" class="b-4"
          style="margin-right: 5px;"><label class="l-1">⚙️</label><label class="l-2">Settings</label></button>
      </div>

      <section data-brains="sku">
        <ol class="list-1" id="sku-list">
          <li id="sku-name" style="cursor: pointer;"><label class="l-3"
              style="user-select: none; margin-right: 5px;">📦</label><label onclick="openSite(event)" class="l-2"
              id="sku-name-value">blablabla</label></li>
        </ol>

      </section>

      <section hidden data-brains="sites">
        <ol class="list-1" id="sites-list">
          <li hidden id="site-name" style="cursor: pointer;"><label class="l-3"
              style="user-select: none; margin-right: 5px;">🌐</label><label onclick="openSite(event)" class="l-2"
              id="site-name-value">accbuddy.com</label></li>
        </ol>



        <script>
          const getFoldersAndComponents = () => {
            const selectedElement = document.getElementById('file-path-list-selected')
            const m = Array.from(selectedElement.children).filter(i => i.id)
            const m1 = m.filter(e => e.hasAttribute('component'))
            const m2 = m.filter(e => e.hasAttribute('folder'))

            return { folders: m2.map(e => e.id), components: m1.map(e => e.id) }
          }
          const switchFileList = (event) => {
            const mainContainer = document.getElementById('main-files-list')
            mainContainer.setAttribute('hidden', '')
            const additional = document.getElementById('additional-options')
            additional.removeAttribute('hidden')

            const lvl1 = additional.querySelector('#additional-options-lvl-1')
            const lvl2 = additional.querySelector('#additional-options-lvl-2')
            const show = (replace) => {
              lvl1.setAttribute('hidden', '')
              lvl2.removeAttribute('hidden')
              const filePath = lvl2.querySelector('#additonal-options-file-pathes')
              filePath.removeAttribute('hidden')
              replaceComponent('', filePath, replace)
            }

            lvl1.querySelector('#bulk-replace').onclick = (e) => {
              show(true)
              const bulkUpdate = lvl2.querySelector('#bulk-update')
              bulkUpdate.removeAttribute('hidden')
              const approveReplace = async (e) => {
                const id = document.getElementById('bulk-update-source-file-id').textContent
                const path = document.getElementById('bulk-update-source-file-path').textContent
                if (!id) {
                  alert('component not selected')
                  return
                }
                const { folders, components } = getFoldersAndComponents()
                const selectedItems = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${id}&startsWith=true`).then(e => e.json())
                console.log('selected' + JSON.stringify(selectedItems))
                const allFoldersPromises = folders.map(
                  async folder => {
                    const response1 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${folder}`).then(e => e.json());
                    const items = response1.items.filter(e => e.lsi1.split(';')[0].endsWith(path.split('|')[1]))
                    const promises = items.map(async item => {
                      const existingLsi1 = item.lsi1
                      //delete old
                      const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${item.id}&startsWith=true`).then(e => e.json())
                      const dPromises = response.items.map(toD => {
                        fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${toD.id}:${toD.sk}`, {
                          method: 'DELETE',
                          headers: {
                            'Content-Type': 'application/json',
                            // Add any additional headers if needed
                          },
                        });
                      })
                      await Promise.all(dPromises)
                      const newId = generateUUID()
                      const createPromises = selectedItems.items.map(element => {
                        if (element.sk === 'path') {
                          element.lsi1 = existingLsi1
                          element.protected = false
                          delete element.href
                        }

                        if (element.target_element === element.id + '-tree') {
                          console.log('err1')
                          element.target_element = newId + '-tree'
                        }
                        element.id = newId
                        return fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json',
                          },
                          body: JSON.stringify(element),
                        });
                      })
                      await Promise.all(createPromises)

                    })
                    await Promise.all(promises)
                  }
                )
                await Promise.all(allFoldersPromises)
                cancelReplace()
              }
              lvl2.querySelector('#approve').onclick = approveReplace
            }

            lvl1.querySelector('#bulk-rename').onclick = (e) => {
              show()
              const bulkRename = lvl2.querySelector('#bulk-rename')
              bulkRename.removeAttribute('hidden')
              const approveRename = async (e) => {
                let oldName = bulkRename.querySelector('#rename-in-selected-folders-old-name').value.trim()
                let newName = bulkRename.querySelector('#rename-in-selected-folders-new-name').value.trim()
                const path = bulkRename.querySelector('#rename-in-selected-folders-component').checked
                const { folders, components } = getFoldersAndComponents()
                if (path) {
                  if (!oldName.startsWith('/')) {
                    oldName = '/' + oldName
                  }
                  if (!oldName.endsWith('/')) {
                    oldName = oldName + '/'
                  }
                  if (!newName.startsWith('/')) {
                    newName = '/' + newName
                  }
                  if (!newName.endsWith('/')) {
                    newName = newName + '/'
                  }
                  const allFoldersPromises = folders.map(
                    async folder => {
                      const response1 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${folder}`).then(e => e.json());
                      const items = response1.items.filter(e => e.lsi1.replace(folder, '').split(';')[0].includes(oldName))
                      const promises = items.map(async item => {
                        const fullItem = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item.id}:${item.sk}`)
                          .then(e => e.json())
                        fullItem.id = item.id
                        fullItem.lsi1 = fullItem.lsi1.replace(oldName, newName)
                        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json',
                          },
                          body: JSON.stringify(
                            fullItem
                          ),
                        })
                      })
                      await Promise.all(promises)
                    }
                  )
                  await Promise.all(allFoldersPromises)

                }
                else {
                  const allFoldersPromises = folders.map(
                    async folder => {
                      const response1 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${folder}`).then(e => e.json());
                      const items = response1.items.filter(e => e.lsi1.split(';')[0].endsWith('|' + oldName))
                      const promises = items.map(async item => {
                        const fullItem = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item.id}:${item.sk}`)
                          .then(e => e.json())
                        fullItem.id = item.id
                        fullItem.lsi1 = fullItem.lsi1.replace('|' + oldName, '|' + newName)
                        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json',
                          },
                          body: JSON.stringify(
                            fullItem
                          ),
                        })
                      })
                      await Promise.all(promises)
                    }
                  )
                  await Promise.all(allFoldersPromises)


                }
                cancelReplace()
              }
              lvl2.querySelector('#approve').onclick = approveRename
            }

            lvl1.querySelector('#bulk-change').onclick = (e) => {
              show()
              const bulkChangeEl = lvl2.querySelector('#bulk-actions-update')
              bulkChangeEl.removeAttribute('hidden')
              const approveChange = async (e) => {
                const oldValue = bulkChangeEl.querySelector('#old-update-value').textContent.trim()
                const newValue = bulkChangeEl.querySelector('#new-update-value').textContent.trim()
                if (!oldValue || !newValue) {
                  alert('values not selected')
                  return
                }
                const checkboxStatus = {};

                // Get references to all the checkboxes
                const checkboxes = bulkChangeEl.querySelectorAll('input[type="checkbox"]');

                // Iterate through each checkbox
                checkboxes.forEach((checkbox) => {
                  // Get the ID of the checkbox
                  const id = checkbox.id;
                  // Get the checked status of the checkbox
                  const checked = checkbox.checked;
                  // Assign the checked status to the corresponding property in the checkboxStatus object
                  checked && checkboxStatus[id];
                });

                // Log the checkboxStatus object
                console.log(checkboxStatus);
                const { folders, components } = getFoldersAndComponents()
                console.log('selected' + JSON.stringify(selectedItems))

                const justId = bulkChangeEl.querySelector('#just-id').checked

                const allFoldersPromises = folders.map(
                  async folder => {
                    const response1 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${folder}`).then(e => e.json());
                    const promises = items.map(async item => {
                      const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${item.id}&startsWith=true`).then(e => e.json())
                      const p = response.items.map(entry => {
                        //filter depending on action
                        for (const key of Object.keys(checkboxStatus)) {
                          if (entry.action === key) {

                          }
                        }
                      })

                    })
                    await Promise.all(promises)
                  }
                )
                await Promise.all(allFoldersPromises)

                cancelReplace()
              }
              lvl2.querySelector('#approve').onclick = approveChange

            }

          }
          const removeMenus2 = () => {
            document.querySelectorAll('[data-menu]:not([hidden])').forEach(e => e.remove())
          }
          const loadHelpers = async () => {
            const { items } = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2' + `?id=${localStorage.getItem('ownerid')}&sk=helper:&startsWith=true`)
              .then(e => e.json())
            const helperEl2 = document.querySelector('[data-brains="helpers"]')
            document.querySelectorAll('[helper]').forEach(e => e.remove())
            const original = helperEl2.querySelector('#helper_name')
            for (const item of items) {
              const cloned = original.cloneNode(true)
              cloned.id = item.sk
              cloned.setAttribute('helper', '')
              cloned.removeAttribute('hidden')
              const name = item.lsi1.split(';')[0]
              cloned.querySelector('#helper-name-value').textContent = name
              const showHelperMenu = (e) => {
                removeMenus2()
                const helperMenu = document.getElementById('helper-menu')
                const cloned1 = helperMenu.cloneNode(true)
                cloned1.querySelector('#helper-username').value = item.lsi1.split(';')[0]
                cloned1.querySelector('#helper-password').value = item.lsi1.split(';')[1]
                cloned1.querySelector('#filesCheckbox').checked = item.permission.files
                cloned1.querySelector('#ecomCheckbox').checked = item.permission.ecommerce
                cloned1.removeAttribute('hidden')
                cloned1.setAttribute('sk', item.sk)
                cloned.insertAdjacentElement('afterend', cloned1)
              }
              cloned.onclick = showHelperMenu
              original.parentNode.append(cloned)
            }
            original.setAttribute('hidden', '')
          }
          const showBrain = async (event, type) => {
            document.querySelectorAll('[data-brains-button]').forEach(e => { e.classList.remove('b-selected') })
            document.querySelectorAll('[data-brains-aside]').forEach(e => { e.setAttribute('hidden', '') })
            document.querySelectorAll('[data-brains]').forEach(e => { e.setAttribute('hidden', '') })
            const helpersEl = document.querySelector(`[data-brains-button="${type}"]`)
            document.querySelectorAll(`[data-brains-aside="${type}"]`).forEach(e => e.removeAttribute('hidden'))
            document.querySelectorAll(`[data-brains="${type}"]`).forEach(e => e.removeAttribute('hidden'))
            helpersEl.removeAttribute('hidden')
            helpersEl.classList.add('b-selected')

            type === "helpers" && loadHelpers()
            type === "sites" && loadSites()
            type === "orders" && load()
            type === "invoices" && loadInvoices()
            type === 'settings' && loadGpt()
            //type ==="invoices" && load()
            //type ==="sku" && load()
          }
          const openSite = (event) => {
            const site = event.target.textContent
            window.location.href = './site-settings.html?site=' + site;
            console.log(site)
          }
          const loadGpt = async () => {
            const tokenLabel = document.getElementById('token-label');
            const ownerid = localStorage.getItem('ownerid')
            const sk = 'chatgpt_token'
            const item = await fetch(`${backend_url}/${ownerid}:${sk}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(e => e.json())
            item?.token && (tokenLabel.textContent = item.token)
            // Add an onblur event handler to the label element
            tokenLabel.addEventListener('blur', function (event) {
              // Do something when the label loses focus
              console.log('Label content changed:', event.target.textContent);
              fetch(backend_url, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(
                  {
                    id: ownerid,
                    sk,
                    token: event.target.textContent

                  }
                ),
              })
            });
          }
          const loadSites = async () => {
            const ownerid = localStorage.getItem('ownerid')
            const helperid = localStorage.getItem('helperid')
            const sk = `folder:${helperid ? helperid : ownerid}:lvl1:`
            url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`
            console.log(url)
            const res = await fetch(url)
            const response = await res.json()
            console.log('res' + JSON.stringify(response))
            const sites = response.items.map(item => item.sk.replace(sk, ''))

            console.log(sites)
            // Get the parent element (sites-list)
            const sitesList = document.getElementById('sites-list');

            // Clone the template node
            const templateNode = document.getElementById('site-name');

            // Clear the existing content inside sites-list
            sitesList.innerHTML = '';

            // Iterate through the array and create list items
            sites.forEach(site => {
              // Clone the template node
              const clonedNode = templateNode.cloneNode(true);

              // Update the content of the cloned node with the current site
              clonedNode.querySelector('#site-name-value').textContent = site;

              // Append the cloned node to sites-list
              sitesList.appendChild(clonedNode);

              // Show the cloned node (remove the 'hidden' attribute)
              clonedNode.removeAttribute('hidden');
            });

          }
          //document.addEventListener('DOMContentLoaded', loadSites);
        </script>

      </section>


      <section hidden data-brains="settings">
        <label class="l-1 b-dark-blue" style=" margin-left: 30px; font-weight: 800;">🤖 Chatgpt</label>
        <br>
        <label class="l-3" style="user-select: none; margin-right: 5px;">🔑</label><label id="token-label"
          contenteditable class="l-3">{token}</label>


      </section>



      <section hidden data-brains="orders">

        <div id="order-types">
          <label class="l-3"><input type="radio" checked name="choose-type">💧 All</label>
          <label hidden class="l-3"><input type="radio" name="choose-type">🆕 New</label>
          <label hidden class="l-3"><input type="radio" name="choose-type">✅ Completed</label>
          <label hidden class="l-3"><input type="radio" name="choose-type">⚠️ Attention</label>
        </div>
        <table id="orders-table" class="table-1 table-row-number" style="margin-left:25px; margin-top: 10px; ">
          <tbody>








            <tr hidden id="order-item">
              <td data-order-date><span data-order-date-value class="l-3">🕒 24.09.20 23:59</span></td>
              <td data-order-site><span data-order-site-value class="l-3">🌐 accbuddy.com</span></td>
              <td data-order-total><span data-order-total-value class="l-3">💰100$</span></td>
              <td data-order-status><span data-order-status-value class="l-3">🆕 new</span></td>
              <td data-order-status><span data-order-email-value class="l-3">🆕 new</span></td>
              <td>
                <button id="remove-row" class="l-3">🗑</button>
                <button hidden id="restore-row" class="l-3">♻️</button>
                
              </td>

            </tr>

            <!--✅- ❌  ⚠️- 🛒 📦-->
          </tbody>
        </table>

        <div id="order-details">


        </div>
        <script>

          const load = async () => {
            const orderItem = document.getElementById("order-item")
            const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=order:${localStorage.getItem('ownerid')}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(e => e.json())
            const items2Promise = items.map(item1 => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item1.id}:${item1.sk}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(e => e.json()).then(item=>{item.id =item1.id;return item}))
            const items2 = await Promise.all(items2Promise)
            console.log(JSON.stringify(items2))
            for (const item of items2) {
              const timestamp = new Date(parseInt(item.lsi1?.split(':')[0]));

              const year = timestamp.getFullYear().toString().slice(-2); // Get last two digits of the year
              const month = ('0' + (timestamp.getMonth() + 1)).slice(-2); // Add leading zero if needed
              const day = ('0' + timestamp.getDate()).slice(-2); // Add leading zero if needed
              const hours = ('0' + timestamp.getHours()).slice(-2); // Add leading zero if needed
              const minutes = ('0' + timestamp.getMinutes()).slice(-2); // Add leading zero if needed

              // Construct the formatted string
              const formattedDate = `${year}-${month}-${day}. ${hours}:${minutes}`;

              const cloned = orderItem.cloneNode(true)
              cloned.querySelector('[data-order-date-value]').textContent = formattedDate
              cloned.querySelector('[data-order-site-value]').textContent = item.id.split(':')[0]
              cloned.querySelector('[data-order-total-value]').textContent = item.total + '$'
              cloned.querySelector('[data-order-status-value]').textContent = item.lsi1?.split(':')[1]
              cloned.querySelector('[data-order-status-value]').textContent = item.email
              const removeRow = cloned.querySelector('#remove-row')
              const restoreRow = cloned.querySelector('#restore-row')
              if (item.ttl) {
                restoreRow.removeAttribute('hidden')
                removeRow.setAttribute('hidden','')
              }
              restoreRow.onclick = async(e) => {
                
                delete item.ttl
                await fetch(backend_url , {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(
                    item
                  ),
                })
                restoreRow.setAttribute('hidden','')
                removeRow.removeAttribute('hidden')
              }
              removeRow.onclick = async(e) => {
                const now = new Date();
                item.ttl =Math.floor((now.getTime() + 5 * 60 * 1000)/1000)
                await fetch(backend_url , {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(
                    item
                  ),
                })
                removeRow.setAttribute('hidden','')
                restoreRow.removeAttribute('hidden')
              }
              cloned.removeAttribute('hidden')
              orderItem.parentNode.append(cloned)
            }
          }
          const loadInvoices = async () => {
            const orderItem = document.getElementById("invoice-item")
            console.log('loading invoices')
            const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=cart:${localStorage.getItem('ownerid')}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(e => e.json())
            const items2Promise = items.map(item1 => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item1.id}:${item1.sk}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(e => e.json()).then(item=>{item.id =item1.id;return item}))
            const items2 = await Promise.all(items2Promise)
            for (const item of items2) {
              const timestamp = new Date(parseInt(item.lsi1?.split(':')[0]));

              const year = timestamp.getFullYear().toString().slice(-2); // Get last two digits of the year
              const month = ('0' + (timestamp.getMonth() + 1)).slice(-2); // Add leading zero if needed
              const day = ('0' + timestamp.getDate()).slice(-2); // Add leading zero if needed
              const hours = ('0' + timestamp.getHours()).slice(-2); // Add leading zero if needed
              const minutes = ('0' + timestamp.getMinutes()).slice(-2); // Add leading zero if needed

              // Construct the formatted string
              const formattedDate = `${year}-${month}-${day}. ${hours}:${minutes}`;
              
              const cloned = orderItem.cloneNode(true)
              cloned.querySelector('[data-invoice-date-value]').textContent = formattedDate
              cloned.querySelector('[data-invoice-site-value]').textContent = item.id.split(':')[0]
              cloned.querySelector('[data-invoice-total-value]').textContent = item.total + '$'
              cloned.querySelector('[data-invoice-status-value]').textContent = item.lsi1?.split(':')[1]
              cloned.removeAttribute('hidden')
              const removeRow = cloned.querySelector('#remove-row')
              const restoreRow = cloned.querySelector('#restore-row')
              if (item.ttl) {
                restoreRow.removeAttribute('hidden')
                removeRow.setAttribute('hidden','')
              }
              
              restoreRow.onclick = async(e) => {
                
                delete item.ttl
                await fetch(backend_url , {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(
                    item
                  ),
                })
                restoreRow.setAttribute('hidden','')
                removeRow.removeAttribute('hidden')
              }
              removeRow.onclick = async(e) => {
                const now = new Date();
                item.ttl = Math.floor((now.getTime() + 5 * 60 * 1000)/1000)
                await fetch(backend_url , {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(
                    item
                  ),
                })
                restoreRow.removeAttribute('hidden')
                removeRow.setAttribute('hidden','')
              }
              orderItem.parentNode.append(cloned)
            }
          }
          //document.addEventListener('DOMContentLoaded', load)
        </script>

      </section>


      <section hidden data-brains="invoices">

        </div>
        <label class="l-3"><input type="radio" checked name="choose-type">💧 All</label>
        <label hidden class="l-3"><input type="radio" name="choose-type">🆕 New</label>
        <label hidden class="l-3"><input type="radio" name="choose-type">✅ Completed</label>
        <label hidden class="l-3"><input type="radio" name="choose-type">⚠️ Attention</label>

        <table class="table-1 table-row-number" style="margin-left:25px; margin-top: 10px; ">
          <tbody>
            <tr id="invoice-item" hidden>
              <td data-invoice-date><span data-invoice-date-value class="l-3">🕒 24.09.20 23:59</span></td>
              <td data-invoice-site><span data-invoice-site-value class="l-3">🌐 accbuddy.com</span></td>
              <td data-invoice-total><span data-invoice-total-value class="l-3">💰100$</span></td>
              <td data-invoice-status><span data-invoice-status-value class="l-3">🆕 new</span></td>
              <td data-invoice-status>
                <button id="remove-row" class="l-3">🗑</button>
                <button hidden id="restore-row" class="l-3">♻️</button>

              </td>

            </tr>


            <!--✅- ❌  ⚠️- 🛒 📦-->
          </tbody>
        </table>

        <script>

          /*
          const load = async () => {
          const orderItem = document.getElementById("invoice-item")
          const { items } = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=cart:${localStorage.getItem('ownerid')}`, {
          method: 'GET',
          headers: {
          'Content-Type': 'application/json',
          },
          }).then(e => e.json())
          const items2Promise = items.map(item1 => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item1.id}:${item1.sk}`, {
          method: 'GET',
          headers: {
          'Content-Type': 'application/json',
          },
          }).then(e => e.json()))
          const items2 = await Promise.all(items2Promise)
          for (const item of items2) {
          const timestamp = new Date(parseInt(item.sk));
          
          const year = timestamp.getFullYear().toString().slice(-2); // Get last two digits of the year
          const month = ('0' + (timestamp.getMonth() + 1)).slice(-2); // Add leading zero if needed
          const day = ('0' + timestamp.getDate()).slice(-2); // Add leading zero if needed
          const hours = ('0' + timestamp.getHours()).slice(-2); // Add leading zero if needed
          const minutes = ('0' + timestamp.getMinutes()).slice(-2); // Add leading zero if needed
          
          // Construct the formatted string
          const formattedDate = `${year}-${month}-${day}. ${hours}:${minutes}`;
          
          const cloned = orderItem.cloneNode(true)
          cloned.querySelector('[data-invoice-date-value]').textContent =formattedDate
          cloned.querySelector('[data-invoice-site-value]').textContent = item.site
          cloned.querySelector('[data-invoice-total-value]').textContent = item.total + '$'
          cloned.querySelector('[data-invoice-status-value]').textContent = item.lsi1?.split(':')[1]
          cloned.removeAttribute('hidden')
          orderItem.parentNode.append(cloned)
          }
          }
          document.addEventListener('DOMContentLoaded', load)*/
        </script>




      </section>
      <section hidden data-brains="helpers">

        <ol class="list-1" id="helpers_list">
          <li id="helper_name" style="cursor: pointer;"><label class="l-3"
              style="user-select: none; margin-right: 5px;">👤</label><label class="l-2" id="helper-name-value"></label>
          </li>
        </ol>

        <div data-menu hidden id="helper-menu">

          <button style="margin-top:5px; margin-bottom: 5px;" onclick="cancel(event)" class="b-4">❌</button>
          <div style="margin-left: 30px;">
            <label class="l-3"><input id="filesCheckbox" type="checkbox">📂 Files</label>
            <label class="l-3"><input id="ecomCheckbox" type="checkbox">🛍️ eCommerce</label>
          </div>

          <span class="l-1" style="user-select: none;">👤</span>
          <input id="helper-username" placeholder=" 👤 Username" class="input-1" type="text">
          <br>
          <span class="l-1" style="user-select: none;">🔑</span>
          <input id="helper-password" placeholder="🔑 Password" class="input-1" type="text">

          <div style="margin-left: 30px;">
            <button class="b-4" onclick="removeHelper(event)">🗑️ Remove</button>
            <button class="b-4" onclick="updateHelper(event)">🔄 Update</button>
            <br>
          </div>
        </div>



      </section>


    </section>


    <section data-section="files">
      <div class="panel horizontal-menu">
        <button id="path_select" onclick="loadRoot()" class='b-1' title="change mode"
          style="user-select: none; margin-right: 7px;">👣</button><label class="l-2 b-dark-blue"
          style="cursor: pointer; font:700;" id="path-label" onclick="labelClick(event)"></label>
      </div>
      <div hidden id="pathSelector" onchange="handlePathSelection()">

      </div>

      <div id="main-files-list">
        <div data-not-functional="filters-sorting" style="position: relative; padding-bottom:4px;">

          <div style="position: absolute; right: 10px; ">
            <select id="sortSelect" style="display: inline">
              <option value="az" selected>⬇️ A to Z</option>
              <option value="za"><label class="l-1">⬆️ Z to A</label>
                </label>hr>
              </option>
              <option value="published_asc">⬇️ published</option>
              <option value="published_desc">⬆️ published
                <hr>
              </option>
              <option value="created_asc">⬇️ created</option>
              <option value="created_desc">⬆️ created
                <hr>
              </option>
              <option value="content_updated_asc">⬇️ content updated</option>
              <option value="content_updated_desc">⬆️ content updated
                <hr>
              </option>
              <hr>
              </option>
              <option value="removed_asc">⬇️ removed</option>
              <option value="removed_desc">⬆️ removed</option>
              <hr>
              </option>
            </select>
          </div>
        </div>

      </div>





      <div hidden data-element="create-new-file-path" data-menu style="margin-bottom: 30px;">
        <button style="margin-bottom: 5px; margin-top: 5px; display:block;" onclick="cancel2(event)" class="b-4"
          data-action="create-new-file-path-cancel">❌</button>
        <div id="file-type">
          <label class="l-3"><input type="radio" checked name="choose-file-type">🧩 Empty</label>
          <label class="l-3"><input type="radio" id="product-checkbox" name="choose-file-type"
              onchange="handleProductPostChange(event)">📦 Product</label>
          <label class="l-3"><input type="radio" id="blog-checkbox" onchange="handleBlogPostChange(event)"
              name="choose-file-type">📝 BlogPost</label>
          <label class="l-3"><input type="radio" name="choose-file-type">💡 NewsPost</label>
        </div>

        <span class="l-3" style="margin-right: 3px;">🆕</span>
        <input type="text" placeholder="📂path" data-input="create-new-file-path-input" class="input-1"
          style="margin-top: 7px;" oninput="adjustWidthToContent(this)">

        <ol hidden data-element="file-path-list-attached" id="file-path-list-attached" class="list-1"
          style="margin-left: -10px;">
          <li data-element="file-pathpattached" hidden id="file-pathpattached">
            <label class="l-3" style="margin-right: 3px;" id="Pushpin">📌</label>
            <label data-value="file-path" class="l-3">universal/blablabla/blablabla/coolcss</label>
            <label data-value="file-emoji" style="user-select: none; margin-left: 5px;" class="l-3">🧩</label>
          </li>

        </ol>
        <div style="margin-left:30px;">
          <button data-action="create-new-file-path-save" onclick="loader(event,savePath)" class="b-4">💾 Save</button>
        </div>
      </div>


      <!-- current file-->
      <table data-element="file-path-list" id="filePathList" class="table-files"
        style="margin-left: 30px; margin-top: 20px;">
      </table>
      <table>
        <tr hidden data-element="file-path" id="item">
          <td>
            <label data-value="file-path" class="l-3">universal/blablabla/blablabla/coolcss</label><label
              data-value="file-emoji" style="user-select: none; margin-left: 5px;" class="l-3"> 🧩</label>
          </td>
          <td hidden data-column-created>
            <span hidden data-date-created-label class="l-3">🆕 </span>
            <span hidden data-column-created_value class="l-3"></span>
          </td>
          <td hidden data-column-published>
            <span hidden data-date-published-label class="l-3">📰 </span>
            <span hidden data-column-published-value class="l-3"></span>
          </td>
          <td hidden data-column-updated>
            <span hidden data-date-updated-label class="l-3">🔄 </span>
            <span hidden data-column-updated-value class="l-3"></span>
          </td>
          <td hidden data-column-content-updated>
            <span hidden data-date-content-updated-label class="l-3">🗞 </span>
            <span hidden data-column-content-updated-value class="l-3"></span>
          </td>
          <td hidden data-column-removed>
            <span hidden data-date-removed-label class="l-3">🚮 </span>
            <span hidden data-column-removed-value class="l-3"></span>
          </td>
        </tr>
      </table>



      <div hidden id="additional-options" data-menu style="margin-bottom: 30px;">
        <div id="additional-options-lvl-1">
          <button id="bulk-replace" class="b-4">🔄🔄 Bulk replace</button>
          <button id="bulk-rename" class="b-4" data-replace-in-folders>🧩🧩 Bulk rename</button>
          <button id="bulk-change" class="b-4">🆔🆔 Bulk change</button>
        </div>

        <div id="additional-options-lvl-2" hidden>
          <button style="margin-bottom: 8px; margin-left: 4px;" class="b-4" onclick="cancelReplace(event)">❌</button>
          <button style="margin-bottom: 8px; margin-left: 4px;" class="b-4" id="approve">✅ Approve</button>

          <div id="bulk-rename" hidden>
            <label class="l-3"><input checked id="rename-in-selected-folders-folder" name="rename-in-selected-folders"
                type="radio">🧩 Component</label>
            <label class="l-3"><input id="rename-in-selected-folders-component" name="rename-in-selected-folders"
                type="radio">📂 Path</label>
            <br>
            <label class="l-3">👴<input type="text" id="rename-in-selected-folders-old-name" placeholder="old name"
                class="input-1"></label>
            <br>
            <label class="l-3">🆕<input type="text" id="rename-in-selected-folders-new-name" placeholder="new name"
                class="input-1"></label>
          </div>

          <div id="bulk-update" hidden>
            <br>
            <span class="l-3">👣</span><span class="l-3" id="bulk-update-source-file-path"></span>
            <br>
            <span class="l-3">🆔</span><span class="l-3" id="bulk-update-source-file-id"></span>

            <br>
            <button class="b-4" id="select-new">🔄 select new</button>
          </div>

          <div id="bulk-actions-update" hidden>
            <label class="l-3"><input checked type="radio" name="choose-id-type-to-change-in-bulk" id="target-id">🎯
              target (just
              id)</label>
            <label class="l-3"><input type="radio" name="choose-id-type-to-change-in-bulk" id="just-id">🆔 (just
              id)</label>
            <br>

            <label class="l-3"><input type="checkbox" id="ChangeTag">✏️ Change tag</label>
            <label class="l-3"><input type="checkbox" id="removeTag">🗑️️ Remove element</label>
            <label class="l-3"><input type="checkbox" id="setAttribute">🔑 Attributes</label>
            <br>
            <label class="l-3"><input type="checkbox" id="Add_Comment'">💬 Comment</label>
            <label class="l-3"><input type="checkbox" id="innerHtml"> ▶️ InnerHtml</label>
            <label class="l-3"><input type="checkbox" id="textContent">📄 TextContent</label>
            <br>

            <label class="l-3"><input type="checkbox" id="Append">👶 Append</label>
            <label class="l-3"><input type="checkbox" id="Add_Parent">👨&zwj;👦️ Add Parent</label>
            <label class="l-3"><input type="checkbox" id="InsertBefore">⬅️ insertBefore</label>
            <label class="l-3"><input type="checkbox" id="InsertAfter"> insertAfter ➡️</label>

            <br>
            <label class="l-3">👴<input type="text" id="old-update-value" placeholder="old value"
                class="input-1"></label>
            <br>
            <label class="l-3">🆕<input type="text" id="new-update-value" placeholder="new value"
                class="input-1"></label>

          </div>


          <div id="additonal-options-file-pathes" hidden>
            <ol id="file-path-list-selected" class="list-1" style="margin-left: -10px; margin-bottom: 30px; " data-menu>
              <br>
              <button style="margin-bottom: 8px; margin-left: 4px;" class="b-4" data-action="moveBack">⤴️ Up</button>
              <label class="l-3"><input id="attach-folder" type="checkbox">📂Folder</label>
            </ol>

            <ol id="filePathList1" class="list-1" style="margin-left: -10px;">
            </ol>
            <li data-element="file-path" id="item1" hidden>
              <label hidden class="l-3" style="margin-right: 3px;" id="Pushpin">📌</label>
              <label data-value="file-path" class="l-3">universal/blablabla/blablabla/coolcss</label>
              <label data-value="file-emoji" style="user-select: none; margin-left: 5px;" class="l-3">🧩</label>
              <div hidden data-value="file-id">for javascript</div><button hidden
                data-action="remove-file-confirmation">for javascript</button>
            </li>

          </div>
        </div>

      </div>



      <select hidden id="amount-of-rows"
        style="margin-top: 10px; min-width: 50px; position: absolute; right: 10px; font-size:20px;">
        <option value="path0">25</option>
        <option value="path1">50</option>
        <option value="path2">100</option>
        <option value="path3">150</option>
        <option value="path3">200</option>
      </select>



      <div style="display: none;" id="right-click-menu" class="right-click-menu">
        <div class="menu-option" onclick="alert('Option 0 selected')">🖼️ edit pic</div>
      </div>



      <div hidden data-element="file-id" data-menu style="margin-bottom: 30px;">
        <button class="b-4" onclick="cancel(event)" style="user-select: none;">❌Close</button>
        <span class="l-4" style="user-select: none;">🆔</span><span data-value="file-id"
          class="l-4">1414124-414221412-4124214124-412412</span>
      </div>

      <div hidden id="cancelation" data-menu style="margin-bottom: 30px;">
        <span class="l-4 b-dark-blue">Are you sure want to remove this file?</span>
        <br>
        <button onclick="cancel(event)" class="b-4">❌ Cancel</button>
        <button class="b-4" data-action="remove-file-confirmation">✅ Delete</button>
      </div>


      <div id="change-owner-menu" hidden data-menu style="margin-bottom: 30px;">
        <button style="margin-top:5px; margin-bottom: 5px;" onclick="cancel(event)" class="b-4">❌</button>
        <br>
        <details style="margin-bottom: 7px;">
          <summary class="summary-L-3"><span class="l-3 b-dark-blue"> </span></summary>
          <select class="select-1" style="display: inline-block; margin-bottom: 7px; margin-left: 18px;"
            id="choose_link_type">
            <option> ⬇️ Select</option>
            <option> 👤 777999</option>
            <option> 👤 blablabla</option>
            <option> 👤 dredredre</option>
          </select>
          <button class="b-4">💾 Save</button>
        </details>

        <span class="l-3 b-dark-blue">👨🏾‍💻 Owner:</span>
        <select id="owners-select" class="select-1" style="display: inline-block; margin-bottom: 7px;">
          <option> ⬇️ Change</option>
          <option> 👤 777999</option>
          <option> 👤 blablabla</option>
          <option> 👤 dredredre</option>
        </select>
        <button id="save-owner" class="b-4">💾 Save</button>
        <br>

        <span class="l-3 b-dark-blue">👶 Helper:</span>
        <select id="helpers-select" class="select-1" style="display: inline-block; margin-bottom: 7px;">
          <option> ⬇️ Select</option>
          <option> 👤 777999</option>
          <option> 👤 blablabla</option>
          <option> 👤 dredredre</option>
        </select>
        <button id="save-helper" class="b-4">💾 Save</button>

        <div hidden id="approve-menu">
          <button class="b-4"> ✅ Approve</button>
          <button class="b-4"> ❌ Cancel</button>
        </div>

      </div>


      <!-- file path-->


      <div hidden data-element="copy-folder" data-menu style="margin-bottom: 30px;">
        <span class="l-3" style="margin-right: 3px;">🆕</span>
        <input data-input="copy-file-path-input" type="text" placeholder="📂name" class="input-1"
          style="margin-top: 7px;">
        <details style="margin-bottom: 7px;">
          <summary class="summary-L-3"><span class="l-3 b-dark-blue"> 🔗 Link Type (Optional)</span></summary>
          <select class="select-1" style="display: inline-block; margin-bottom: 7px; margin-left: 18px;"
            id="choose_link_type">
            <option> ⬇️ Select</option>
            <option id="update"> 🌐 Update</option>
            <option id="byId"> 🆔 Id</option>
            <option id="absolute"> 📂 Absolute</option>
            <option id="relative"> 🗂️ Relative</option>
          </select>
          <span id="update-components">
            <label id="html-structure-label" style="display: none" class="l-3"><input type="checkbox">html
              structure</label>
            <label id="all-structure-label" style="display: none" class="l-3"><input type="checkbox">all
              structure</label>

          </span>
        </details>


        <details style="margin-bottom: 7px;">
          <summary class="summary-L-3"><span class="l-3 b-dark-blue"> 🌐 File Type (Optional)</span></summary>
          <select class="select-1" id="site-checkboxes" style="display: block; margin-bottom: 7px; margin-left: 18px;"
            multiple>
            <option id="All"> ✔️ All</option>
            <option id="Hub"> 🗺️ Hub</option>
            <option id="Style"> 🎨 Style</option>
            <option id="Content"> 📄 Content</option>
          </select>
        </details>
        <button data-action="copy-file-path-cancel" class="b-4">❌ Cancel</button>
        <button class="b-4" data-action="copy-file-path-save">✅ Copy</button>
      </div>

      <div hidden data-element="copy-file" data-menu style="margin-bottom: 30px;">
        <span class="l-3" style="margin-right: 3px;">🆕</span>

        <input data-input="copy-file-path-input" type="text" placeholder="📂name" class="input-1"
          style="margin-top: 7px;">
        <details style="margin-bottom: 7px;">
          <summary class="summary-L-3"><span class="l-3 b-dark-blue"> 🔗 Link Type (Optional)</span></summary>
          <select class="select-1" style="display: block; margin-bottom: 7px; margin-left: 18px;" id="choose_link_type">
            <option value=""> ⬇️ Select</option>
            <option value="" id="byId"> 🆔 Id</option>
            <option value="" id="absolute"> 📂 Absolute</option>
            <option value="" id="relative"> 🗂️ Relative</option>
          </select>
        </details>


        <button data-action="copy-file-path-cancel" class="b-4">❌ Cancel</button>
        <button class="b-4" data-action="copy-file-path-save">✅ Copy</button>
      </div>

    </section>
  </main>









  <script>
    const switchFolder = (event) => {
      const relative = document.getElementById('relative-label')
      const absolute = document.getElementById('absolute-label')
      if (event.target.checked) {
        relative.removeAttribute('hidden')
        absolute.removeAttribute('hidden')
      }
      else {
        relative.setAttribute('hidden', '')
        relative.querySelector('input').checked = false
        absolute.setAttribute('hidden', '')
        absolute.querySelector('input').checked = false
      }
    }
    let backend_url = 'https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2'
    var convertToOldPath = (path) => {
      const splited = path.split('|')
      const fileName = splited.pop()
      return splited[0] + '/' + fileName
    }
    var convertToNewPath = (path) => {
      const splited = path.split('/')
      const fileName = splited.pop()
      return splited.join('/') + '|' + fileName
    }
    const login = async (e) => {
      let username = document.getElementById('username').value
      let password = document.getElementById('password').value
      try {
        r = await fetch(backend_url + '/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(
            {
              username,
              password

            }
          ),
        })
        if (!r.ok) {
          throw new Error('wrong creds')
        }
        const { id, sk, temp_token } = await r.json()
        localStorage.setItem('ownerid', id)
        if (sk.startsWith('helper')) {
          localStorage.setItem('helperid', sk.split(':')[1])
        }
        localStorage.setItem('token', temp_token)
        document.getElementById('login').classList.add('hidden')
        document.getElementById('aside_element').removeAttribute('hidden')
        document.getElementById('main_element').removeAttribute('hidden')
      } catch (e) {
        console.log(JSON.stringify(e))
        alert('wrong credentials')
      }
    }
    const register = async (e) => {
      let username = document.getElementById('username').value
      let password = document.getElementById('password').value
      console.log(username)
      console.log(password)
      const { id, temp_token } = await fetch(backend_url + '/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(
          {
            username,
            password

          }
        ),
      }).then(r => r.json())

    }
    function toggleLinkType(event) {
      const chooseLinkTypeDiv = event.target.closest('[data-element="copy-file"]').querySelector('#choose_link_type');
      const linkedCloneCheckbox = event.target

      if (linkedCloneCheckbox.checked) {
        chooseLinkTypeDiv.removeAttribute('hidden');
      } else {
        chooseLinkTypeDiv.setAttribute('hidden', '');
        event.target.closest('[data-element="copy-file"]').querySelector('#choose_path_link_type').setAttribute('hidden', '');

        // Uncheck all radio buttons when linked clone is unchecked
        event.target.closest('[data-element="copy-file"]').querySelector('#link-type-id').checked = true;
        event.target.closest('[data-element="copy-file"]').querySelector('#link-type-path').checked = false;
        event.target.closest('[data-element="copy-file"]').querySelector('#path-type-relative').checked = true;
        event.target.closest('[data-element="copy-file"]').querySelector('#path-type-absolute').checked = false;
      }
    }

    function togglePathLinkType(event, flag) {
      const choosePathLinkTypeDiv = event.target.closest('[data-element="copy-file"]').querySelector('#choose_path_link_type');
      const linkTypePathRadio = event.target
      let cond = linkTypePathRadio.checked
      flag && (cond = !cond)
      if (cond) {
        choosePathLinkTypeDiv.removeAttribute('hidden');
      } else {
        choosePathLinkTypeDiv.setAttribute('hidden', '');
      }
    }
    const showSiteCheckboxes = (event, flag) => {
      const siteCheckboxes = document.getElementById('site-checkboxes')
      const siteRadio = document.getElementById('site-files');
      if (siteRadio.checked) {
        siteCheckboxes.removeAttribute('hidden');
      } else {
        siteCheckboxes.setAttribute('hidden', 'true');
      }

    }
    function getRelativePath(currentLsi, lsi3) {
      // Split paths into arrays of directories and filenames
      const currentLsiParts = currentLsi.split('/');
      const lsi3Parts = lsi3.split('/');

      // Extract filenames from paths
      const currentFilename = currentLsiParts.pop();
      const lsi3Filename = lsi3Parts.pop();

      // Find the index at which paths diverge
      let divergeIndex = 0;
      while (divergeIndex < Math.min(currentLsiParts.length, lsi3Parts.length) && currentLsiParts[divergeIndex] === lsi3Parts[divergeIndex]) {
        console.log('adding')
        divergeIndex++;
      }
      console.log(currentLsiParts[divergeIndex])
      console.log(lsi3Parts[divergeIndex])
      // Calculate the number of levels to go up from currentLsi to the common directory
      const levelsUp = currentLsiParts.length - divergeIndex;

      // Build the relative path to lsi3
      let relativePath = (levelsUp === 0 ? './' : Array(levelsUp).fill('..').join('/') + '/');
      if (lsi3Parts.length > 0) {
        relativePath += lsi3Parts.slice(divergeIndex).join('/');
      }
      // Append the filename to the relative path
      if (relativePath.endsWith('/')) {
        relativePath += lsi3Filename;
      }


      else {
        relativePath += '/' + lsi3Filename;
      }


      return relativePath;
    }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0,
          v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    function addMenu(e, id, protected, itemLsi1, menuItem) {
      console.log('menu item' + JSON.stringify(menuItem))
      e.preventDefault(); // Prevent the default context menu from opening
      console.log('in11');
      const menu = document.querySelector('#right-click-menu'); // Use # for ID selector
      menu.innerHTML = '';

      function addMenuEntry(menu, text, clickHandler) {
        const entry = document.createElement('div');
        entry.className = 'menu-option';
        entry.innerHTML = text;
        entry.onclick = (e) => { removeMenus(); clickHandler(e) };
        menu.appendChild(entry);
      }/*
      const copy = async (id) => {
        console.log(id)
        const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${id}&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        // Ensure the request was successful (status code 2xx)
        if (!response.ok) {
          throw new Error(`Failed to load data from the database. Status: ${response.status}`);
        }

        // Parse and log the response or handle it as needed
        const responseData = await response.json();
        const newId = generateUUID()
        console.log(JSON.stringify(responseData))
        for (const entry of responseData.items) {
          entry.id = newId
          console.log('entry ' + JSON.stringify(entry))
          if (entry.sk === 'path') {
            entry.lsi1 = entry.lsi1.replace(';publish:published', '') + '-copy-' + newId
            entry.protected = false
          }
          if (entry.target_element === id + '-tree') {
            console.log('err1')
            entry.target_element = newId + '-tree'
          }
          const response1 = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(entry),
          });
          if (!response1.ok) {
            throw new Error(`Failed to load data from the database. Status: ${response.status}`);
          }
        }
        console.log(newId)
        location.reload()
      }
      */
      const copy = async (id) => {
        const editArea = document.querySelector('[data-element="copy-file"]');
        const fieldset = document.getElementById(id);

        if (editArea && fieldset) {
          console.log('editing')
          const cloned = editArea.cloneNode(true);
          const saveButton = cloned.querySelector('[data-action="copy-file-path-save"]');
          const cancelButton = cloned.querySelector('[data-action="copy-file-path-cancel"]');
          cancelButton.onclick = (e) => {
            e.stopPropagation()
            removeMenus()
          }
          const input = cloned.querySelector('[data-input="copy-file-path-input"]');
          const name = fieldset.querySelector('[data-value="file-path"]').textContent;

          input.value = itemLsi1.replace(';publish:published', '').replace('|', '/');
          input.onclick = (event) => {
            event.stopPropagation()
          }
          saveButton.onclick = async function (e) {
            e.stopPropagation()

            const new_value = convertToNewPath(cloned.querySelector('[data-input="copy-file-path-input"]').value)
            const linked = cloned.querySelector('#linked-clone')
            const byId = cloned.querySelector('#byId').selected
            const relative = cloned.querySelector('#relative').selected
            const absolute = cloned.querySelector('#absolute').selected
            if (byId || relative || absolute) {

              const uuid = generateUUID()
              const pLoad = {
                ...menuItem,
                id: uuid,
                lsi1: new_value,
                protected: false
              }
              if (new_value.endsWith('Head-Content')) {
                pLoad.hosting_time = { created: new Date().getTime() }
              }
              console.log('menu item ' + JSON.stringify(menuItem))
              delete pLoad.href
              const data = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(pLoad),
              })
              if (byId) {
                await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    id: uuid,
                    sk: (new Date()).getTime().toString(),
                    action: 'Add_Component',
                    target_element: uuid + '-tree',
                    inserted_component: { componentId: id, id: generateUUID() },
                  }),
                })
              }
              else if (absolute) {
                const p = convertToOldPath(itemLsi1).split('/')
                p.shift()
                const fileName = p.pop()
                let r = ''
                if (p.length) {
                  r = '/' + p.join('/')
                }
                const compId = "*" + r + '|' + fileName
                await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    id: uuid,
                    sk: (new Date()).getTime().toString(),
                    action: 'Add_Component',
                    target_element: uuid + '-tree',
                    inserted_component: { componentId: compId, id: generateUUID() },
                  }),
                })
              }
              else if (relative) {
                console.log(new_value)
                console.log(convertToOldPath(itemLsi1))
                const relativePath = getRelativePath(convertToOldPath(new_value), convertToOldPath(itemLsi1))
                await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    id: uuid,
                    sk: (new Date()).getTime().toString(),
                    action: 'Add_Component',
                    target_element: uuid + '-tree',
                    inserted_component: { componentId: "#" + relativePath, id: generateUUID() },
                  }),
                })
              }
              await createFolders(new_value)
              loadUsingPath()
              return
            }


            const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${id}&startsWith=true`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            });


            // Ensure the request was successful (status code 2xx)
            if (!response.ok) {
              throw new Error(`Failed to load data from the database. Status: ${response.status}`);
            }

            // Parse and log the response or handle it as needed
            const responseData = await response.json();
            const newId = generateUUID()
            console.log(JSON.stringify(responseData))
            for (const entry of responseData.items) {
              entry.id = newId
              console.log('entry ' + JSON.stringify(entry))
              if (entry.sk === 'path') {
                entry.lsi1 = new_value
                entry.protected = false
                delete entry.href
              }
              if (entry.target_element === id + '-tree') {
                console.log('err1')
                entry.target_element = newId + '-tree'
              }
              const response1 = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(entry),
              });
              if (!response1.ok) {
                throw new Error(`Failed to load data from the database. Status: ${response.status}`);
              }
            }
            await createFolders(new_value)




            loadUsingPath()
            cloned.remove();
          };

          cloned.style.display = 'block';
          fieldset.insertAdjacentElement('afterend', cloned);
        }
      }

      const edit = (id) => {
        const editArea = document.querySelector('[data-element="create-new-file-path"]');
        const fieldset = document.getElementById(id);

        if (editArea && fieldset) {
          console.log('editing')
          const cloned = editArea.cloneNode(true);
          const saveButton = cloned.querySelector('[data-action="create-new-file-path-save"]');
          const cancelButton = cloned.querySelector('[data-action="create-new-file-path-cancel"]');
          cancelButton.onclick = (e) => {
            e.stopPropagation()
            removeMenus()
          }
          const input = cloned.querySelector('[data-input="create-new-file-path-input"]');
          const name = fieldset.querySelector('[data-value="file-path"]').textContent;

          input.value = path + name;
          input.onclick = (event) => {
            event.stopPropagation()
          }
          saveButton.onclick = async function (e) {
            e.stopPropagation()
            const new_value = cloned.querySelector('[data-input="create-new-file-path-input"]').value
            const res1 = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/' + id + ':path', {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              }
            }).then(re => re.json())
            const splited = new_value.split('/')
            const fileName = splited.pop()
            // create folders 


            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(
                {
                  ...res1,
                  lsi1: splited.join('/') + '|' + fileName, id
                }
              ),
            })
            await createFolders(new_value)
            loadUsingPath()
            cloned.remove();
          };

          cloned.style.display = 'block';
          fieldset.insertAdjacentElement('afterend', cloned);
        }
      };
      const openRemove1 = (id) => {

        var fieldset = document.getElementById(id);

        // Get the file ID element within the fieldset


        // Toggle the visibility of the "cancelation" fieldset
        var cancelationFieldset = document.querySelector('#cancelation');
        const cloned = cancelationFieldset.cloneNode(true)
        cloned.removeAttribute('hidden');
        // Toggle the visibility of the "cancelation" fieldset

        cloned.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
          event.stopPropagation()
          remove(event, id);
        };
        fieldset.insertAdjacentElement('afterend', cloned);












      }
      function showId1(id) {
        console.log('event' + JSON.stringify(event.target.target))
        // Get the parent fieldset of the clicked button
        var fieldset = document.getElementById(id);

        // Get the file ID element within the fieldset
        var fileIdElement = document.querySelector('[data-element="file-id"]');
        const cloned = fileIdElement.cloneNode(true)
        cloned.querySelector('[data-value="file-id"]').textContent = id
        cloned.removeAttribute('hidden')


        // Toggle the visibility of the file ID element
        fieldset.insertAdjacentElement('afterend', cloned);
      }
      async function changeOwner(id) {
        console.log('event' + JSON.stringify(event.target.target))
        // Get the parent fieldset of the clicked button
        var fieldset = document.getElementById(id);

        // Get the file ID element within the fieldset
        var fileIdElement = document.querySelector('#change-owner-menu');
        const cloned = fileIdElement.cloneNode(true)
        cloned.id = id
        cloned.removeAttribute('hidden')
        const ownersSelect = cloned.querySelector("#owners-select");
        const helpersSelect = cloned.querySelector("#helpers-select");
        ownersSelect.innerHTML = "";
        helpersSelect.innerHTML = "";
        //get helpers
        const res1 = await fetch(backend_url + `?id=${localStorage.getItem('ownerid')}&sk=helper:&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        }).then(re => re.json())
        for (const item of res1.items) {
          let optionElement = document.createElement("option");
          const name = item.lsi1.split(';')[0]
          optionElement.value = item.sk.split(':')[1];
          optionElement.textContent = name;
          helpersSelect.appendChild(optionElement);
        }
        //get owners
        const res2 = await fetch(backend_url + `?ownerUUID=credentials&startsWith=owner`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        }).then(re => re.json())
        for (const item1 of res2.items) {
          const item = await fetch(backend_url + `/${item1.id}:${item1.sk}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            }
          }).then(re => re.json())
          let optionElement = document.createElement("option");
          const name = item.lsi1.split(';')[0]
          optionElement.value = item.id.split(':')[0]
          optionElement.textContent = name;
          ownersSelect.appendChild(optionElement);
        }
        cloned.querySelector('#save-owner').onclick = async (e) => {
          var ownersSelect = cloned.querySelector("#owners-select");

          // Get the selected option
          var selectedOption = ownersSelect.options[ownersSelect.selectedIndex];

          // Get the value of the selected option
          var selectedValue = selectedOption.value;

          // get path item
          const item = await fetch(backend_url + `/${id}:path`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            }
          }).then(re => re.json())
          item.id = item.id.split(':')[0]
          item.ownerUUID = 'path:' + selectedValue
          //update it 
          await fetch(backend_url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(
              item
            ),
          })
          await createFolders(item.lsi1.split(';')[0].replace('|', '/'), selectedValue)
          cloned.remove()

        }
        cloned.querySelector('#save-helper').onclick = async (e) => {
          var ownersSelect = cloned.querySelector("#helpers-select");

          // Get the selected option
          var selectedOption = ownersSelect.options[ownersSelect.selectedIndex];

          // Get the value of the selected option
          var selectedValue = selectedOption.value;

          // get path item
          const item = await fetch(backend_url + `/${id}:path`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            }
          }).then(re => re.json())
          item.helperUUID = 'path:' + selectedValue
          item.id = item.id.split(':')[0]
          console.log(JSON.stringify(item))
          //update it 
          await fetch(backend_url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(
              item
            ),
          })
          await createFolders(item.lsi1.split(';')[0].replace('|', '/'), item.ownerUUID.split(':')[1], selectedValue)
          cloned.remove()

        }


        // Toggle the visibility of the file ID element
        fieldset.insertAdjacentElement('afterend', cloned);
      }
      const addProduct = (id) => {
        const name = itemLsi1
        const original = document.getElementById('file-pathpattached')
        const cloned = original.cloneNode(true)
        cloned.setAttribute('component', itemLsi1)
        cloned.id = id
        cloned.removeAttribute('hidden')
        cloned.querySelector('[data-value="file-path"]').textContent = name
        original.parentElement.append(cloned)
      }
      const storedPath = localStorage.getItem('storedPath')
      const openNewTab = (id) => {
        const redirectURL = `component.html?id=${id}&rand=${Math.random()}`;
        window.open(redirectURL, '_blank');
      }
      addMenuEntry(menu, '➡️ Open', (e) => openNewTab(id))
      addMenuEntry(menu, 'ℹ️ Info', (e) => showId1(id))
      addMenuEntry(menu, '✏️ Edit', (e) => edit(id))
      addMenuEntry(menu, '🗑️ Delete', (e) => openRemove1(id))
      addMenuEntry(menu, '⧉ Copy', (e) => copy(id))
      addMenuEntry(menu, '👤 User', (e) => changeOwner(id))
      storedPath.startsWith('Stock') && product && addMenuEntry(menu, '📦 Product +', (e) => addProduct(id))

      if (protected) {
        addMenuEntry(menu, '❌ Protection -', (e) => setProtected(id, false))
      }
      else {
        addMenuEntry(menu, '✅ Protection +', (e) => setProtected(id, true))
      }


      const setProtected = async (id, protected) => {
        const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${id}&sk=path&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(response => response.json());
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ ...response.items[0], protected }),
        });
        loadUsingPath()
        alert('protection set ' + protected)
      }
      // Adjust the position relative to the viewport
      const offsetX = e.pageX;
      const offsetY = e.pageY;

      menu.style.display = 'block';
      menu.style.left = `${offsetX}px`;
      menu.style.top = `${offsetY}px`;

      // Hide the menu when clicking the left mouse button
      window.addEventListener('click', function () {
        menu.style.display = 'none';
      });

    }
    const updateFolder = async (path, new_value, last, d, htmlStructChecked, allStructurs) => {

      const response1 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${path}`);
      //list of sub paths
      const data1 = await response1.json();
      const splited = path.split('/')
      splited.pop()
      const fpath = splited.join('/') + '|'
      const response2 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${fpath}`);
      //list of sub paths
      const data2 = await response2.json();
      const items1 = [...data1.items.filter(e=>!e.lsi1.includes('A-Modules'))
                      , ...data2.items]

      let replaceByIditems = []
      let doNotReplaceItems = []
      let restItems = []
      console.log('path ' + path)
      for (const item of items1) {
        item.lsi1 = item.lsi1.replace(';publish:published', '')
        if (item.lsi1.endsWith('Script') || item.lsi1.endsWith('Style') || (item.lsi1.endsWith('Structure') && allStructurs) || (item.lsi1.endsWith('Html-Structure') && htmlStructChecked) || item.lsi1.endsWith('|Hub') || item.lsi1.endsWith('-Seed')) {
          replaceByIditems.push(item)
        }
        else if (item.lsi1.endsWith('-Content')) {
          doNotReplaceItems.push(item)
        }
        else {
          restItems.push(item)
        }
      }
      console.log('replaceByIditems ' + JSON.stringify(replaceByIditems))
      console.log('doNotReplaceItems ' + JSON.stringify(doNotReplaceItems))
      await Promise.all(replaceByIditems.map(async item55 => {
        const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item55.id}:${item55.sk}`)
          .then(e => e.json())
        item.id = item55.id
        const splited = convertToOldPath(item.lsi1).split('/')
        const el = splited.find(e => e === 'Seed-Home')

        const el1 = splited.find(e => e.startsWith('Seed-'))
        let flag = 0
        let targetPaths = [new_value]

        if (el && !last.startsWith('Seed-')) {
          const index = splited.indexOf(el)
          const splited2 = convertToOldPath(item.lsi1).replace(path, new_value).split('/')
          splited2.splice(index)
          const startsWith = splited2.join('/') + '/'
          const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${startsWith}`);
          //list of sub paths
          const data = await response.json();
          const targetDirectories = []
          for (const item of data.items) {
            const splited = convertToOldPath(item.lsi1).split('/')
            if (splited[index].startsWith('Home')) {
              targetDirectories.push(splited[index])
            }
          }
          if (targetDirectories.length === 0) {
            targetDirectories.push('Home')
          }
          targetPaths = targetDirectories.map(t => startsWith + t)
          flag = 1
        }
        else if (el1 && !last.startsWith('Seed-')) {
          const index = splited.indexOf(el1)
          const splited2 = convertToOldPath(item.lsi1).replace(path, new_value).split('/')
          splited2.splice(index)
          const startsWith = splited2.join('/') + '/'
          const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${startsWith}`);
          //list of sub paths
          const data = await response.json();
          const targetDirectories = []
          for (const item of data.items) {
            const splited = convertToOldPath(item.lsi1).split('/')
            if (!splited[index].startsWith('Home')) {
              targetDirectories.push(splited[index])
            }
          }
          targetPaths = targetDirectories.map(t => startsWith + t)
          flag = 1
        }
        targetPaths = removeDuplicates(targetPaths)
        console.log('targets ' + JSON.stringify(targetPaths))
        await Promise.all(targetPaths.map(async new_value1 => {

          const newId = generateUUID()

          const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${item.id}&startsWith=true`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          });
          const res2 = await response.json()
          const pathI = res2.items.find(e => e.sk === 'path')
          //create new file
          let newLSI = pathI.lsi1.replace(path.slice(0, -1), new_value1.slice(0, -1)).replaceAll('-Seed', "").replace(';publish:published', '')
          if (new_value !== new_value1) {
            console.log('newval' + new_value1)
            const s1 = convertToOldPath(pathI.lsi1).split('/')
            const s2 = new_value1.split('/')
            const remainingS1 = s1.slice(s2.length);

            // Concatenate s2 with the remaining elements of s1
            const result = [...s2, ...remainingS1];
            newLSI = convertToNewPath(result.join('/')).replace(';publish:published', '')
            console.log('res11' + JSON.stringify(result))
            console.log('res11' + JSON.stringify(s2))
            console.log('res11' + JSON.stringify(remainingS1))
            console.log('neeew ' + newLSI)
          }

          //backup
          {
            const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${newLSI}`);
            //list of sub paths
            const data = await response.json();
            if (data.items.length) {
              //move to trash
              await Promise.all(data.items.map(async el => {
                const id = el.id
                const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${id}&startsWith=true`, {
                  method: 'GET',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                });
                const res2 = await response.json()
                await Promise.all(res2.items.map(async item1 => {

                  if (item1.sk === 'path') {
                    const trashLsi = 'trash/' + d.toISOString().slice(0, -5) + '-replace/' + item1.lsi1
                    await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify(
                        {
                          ...item1,
                          lsi1: trashLsi,

                        }
                      ),
                    })
                    await createFolders(convertToOldPath(trashLsi))
                  }

                }))
              }
              ))
            }
          }
          const payload = {
            ...pathI,
            id: newId,
            sk: 'path',
            lsi1: newLSI,
            protected: false,
            href: undefined,
            hosting_time: undefined

          }
          pathI.hub_items && (payload.hub_items = pathI.hub_items)
          const data = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          })
          console.log('putting ' + newId)
          console.log('res ' + JSON.stringify(data))
          await createFolders(convertToOldPath(newLSI))


          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: newId,
              sk: (new Date()).getTime().toString(),
              action: 'Add_Component',
              target_element: newId + '-tree',
              inserted_component: { componentId: pathI.id, id: generateUUID() },
            }),
          })
        }))








      }))

      await Promise.all(doNotReplaceItems.map(async item => {
        console.log('donotreplaceitem ' + item.lsi1)
        const splited = convertToOldPath(item.lsi1).split('/')
        const el = splited.find(e => e === 'Seed-Home')

        const el1 = splited.find(e => e.startsWith('Seed-'))
        console.log('newVal' + new_value)
        let targetPaths = [new_value]
        let flag = 0
        if (el && !last.startsWith('Seed-')) {
          const index = splited.indexOf(el)
          const splited2 = convertToOldPath(item.lsi1).replace(path, new_value).split('/')
          splited2.splice(index)
          const startsWith = splited2.join('/') + '/'
          const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${startsWith}`);
          //list of sub paths
          const data = await response.json();
          const targetDirectories = []
          for (const item of data.items) {
            const splited = convertToOldPath(item.lsi1).split('/')
            if (splited[index].startsWith('Home')) {
              targetDirectories.push(splited[index])
            }
          }
          targetPaths = targetDirectories.map(t => startsWith + t)
          flag = 1
        }
        else if (el1 && !last.startsWith('Seed-')) {
          const index = splited.indexOf(el1)
          const splited2 = convertToOldPath(item.lsi1).replace(path, new_value).split('/')
          splited2.splice(index)
          const startsWith = splited2.join('/') + '/'
          const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${startsWith}`);
          //list of sub paths
          const data = await response.json();
          const targetDirectories = []
          for (const item of data.items) {
            const splited = convertToOldPath(item.lsi1).split('/')
            if (!splited[index].startsWith('Home')) {
              targetDirectories.push(splited[index])
            }
          }
          targetPaths = targetDirectories.map(t => startsWith + t)
          flag = 1
        }

        targetPaths = removeDuplicates(targetPaths)
        console.log('target0' + JSON.stringify(targetPaths))


        const r = targetPaths.map(async new_value1 => {
          const newId = generateUUID()

          const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${item.id}&startsWith=true`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          const res2 = await response.json()
          const pathI = res2.items.find(e => e.sk === 'path')
          //create new file
          let newLSI = pathI.lsi1.replace(path, new_value1).replace(';publish:published', '')
          if (new_value !== new_value1) {
            const s1 = convertToOldPath(pathI.lsi1).split('/')
            const s2 = new_value1.split('/')
            const remainingS1 = s1.slice(s2.length);

            // Concatenate s2 with the remaining elements of s1
            const result = [...s2, ...remainingS1];
            newLSI = convertToNewPath(result.join('/')).replace(';publish:published', '')
            console.log('got new lsi ' + newLSI)
          }
          {
            console.log('geeeting ' + newLSI)
            const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${newLSI}`);
            //list of sub paths
            const data = await response.json();
            if (data.items.length) {
              //move to trash
              console.log('foud new ' + newLSI)
              return

            }
          }
          const pLoad = {
            ...pathI,
            id: newId,
            sk: 'path',
            lsi1: newLSI,
            protected: false,
            href: undefined,
            hosting_time: undefined
          }
          if (newLSI.endsWith('Head-Content')) {
            pLoad.hosting_time = { created: new Date().getTime() }
          }
          const data = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(pLoad),
          })
          console.log('created ' + newLSI)
          await createFolders(convertToOldPath(newLSI))
          await Promise.all(res2.items.map(async item1 => {



            //create new file actions
            if (item1.sk !== 'path') {
              //copy data

              if (item1.target_element === item1.id + '-tree') {
                console.log('err1')
                item1.target_element = newId + '-tree'
              }
              return fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(
                  {
                    ...item1,
                    id: newId
                  }
                ),
              })



            }

          }))
        })
        await Promise.all(r)




      }))





    }
    const cancelReplace = () => {

      document.getElementById('additional-options-lvl-2').setAttribute('hidden', "")
      document.getElementById('bulk-update').setAttribute('hidden', "")
      document.getElementById('bulk-actions-update').setAttribute('hidden', "")
      document.getElementById('additonal-options-file-pathes').setAttribute('hidden', "")
      document.getElementById('bulk-rename').setAttribute('hidden', "")
      document.getElementById('additional-options').setAttribute('hidden', "")
      document.getElementById('main-files-list').removeAttribute('hidden')
      document.getElementById('additional-options-lvl-1').removeAttribute('hidden')
    }
    var approveReplace = async (e) => {
      const m = Array.from(e.target.parentNode.children).filter(i => i.id)
      const m1 = m.filter(e => e.hasAttribute('component'))
      const m2 = m.filter(e => e.hasAttribute('folder'))

      //const folderChecked = e.target.parentNode.querySelector('#attach-folder').checked
      const parentId = e.target.parentNode.id.replace('file-path-list;', '')
      if (!parentId) {
        alert('no target id')
        return
      }
      const parentEl = document.getElementById(parentId)
      const replacedString = parentEl.getAttribute('replaced')
      const replaced = replacedString ? JSON.parse(replacedString) : []

      const arr = m1.map(el => {
        const element = document.getElementById(el.id);
        return {

          componentId: el.id, id: el.newId || generateUUID(), path: element.querySelector('[data-value="file-path"]').textContent, already: element.getAttribute('alreadyReplaced')
        }
      })
      const el = {
        time: (new Date()).getTime(),
        action: 'Replace_Component',
        target_element: [parentId.replace('file-path-list-selected;', ''), ...arr],
      };
      if (m2.length) {
        el.folders = m2.map(e => e.id)
      }
      await pushAction(el)
      location.reload()
    }
    var replaceComponent = (path, cloned2, replace) => {
      const helperid = localStorage.getItem('helperid')
      const ownerid = localStorage.getItem('ownerid')
      let selected = []
      let path1 = ''
      let selectedReplace
      var addSelected = (id, itemId, path) => {
        if (replace && !selectedReplace) {
          document.getElementById('bulk-update-source-file-id').textContent = itemId
          document.getElementById('bulk-update-source-file-path').textContent = path
          selectedReplace = itemId
          document.getElementById('select-new').onclick = () => {
            selectedReplace = undefined
            document.getElementById('bulk-update-source-file-id').textContent = ''
            document.getElementById('bulk-update-source-file-path').textContent = ''
          }
          return
        }
        const clonedFieldset2 = document.getElementById('file-path-list-selected')
        if (Array.from(clonedFieldset2.children).find(el => el.id === itemId)) {
          return
        }
        var clonedItem = document.getElementById('item1').cloneNode(true);
        clonedItem.removeAttribute('hidden')
        selected.push(itemId)
        clonedItem.id = itemId;
        clonedItem.setAttribute('component', true)
        const file_path = clonedItem.querySelector('[data-value="file-path"]')
        file_path.textContent = path;
        clonedItem.querySelector('#Pushpin').removeAttribute('hidden')
        clonedItem.onclick = (e) => { e.target.closest('li').remove(); selected.filter(el => el !== itemId) }
        clonedFieldset2.appendChild(clonedItem)
        console.log(JSON.stringify(selected))

      }
      var setFolder = (path, id) => {


        const clonedFieldset2 = document.getElementById('file-path-list-selected')
        if (Array.from(clonedFieldset2.children).find(el => el.id === path)) {
          return
        }
        var clonedItem = document.getElementById('item1').cloneNode(true);
        clonedItem.removeAttribute('hidden')
        selected.push(path)
        clonedItem.id = path;
        clonedItem.setAttribute('folder', true)
        const file_path = clonedItem.querySelector('[data-value="file-path"]')
        clonedItem.querySelector('[data-value="file-emoji"]').textContent = '📂'
        file_path.textContent = path;
        clonedItem.querySelector('#Pushpin').removeAttribute('hidden')
        clonedItem.onclick = (e) => { e.target.closest('li').remove(); selected.filter(el => el !== path) }
        clonedFieldset2.appendChild(clonedItem)
        console.log(JSON.stringify(selected))

      }




      var loadUsingPath1 = async (id, path) => {
        try {
          //get files
          let url
          const helperid = localStorage.getItem('helperid')

          var filePathList = document.getElementById('filePathList1');
          filePathList.innerHTML = '';
          let lvls = [];
          let i = 0;
          let folders = [];

          //get files
          const spath = path.slice(0, -1) + '|';

          if (helperid) {
            url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${spath}&token=${localStorage.getItem('token')}`;
          }
          else {
            url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${spath}&token=${localStorage.getItem('token')}`;
          }
          let data1 = fetch(url).then(e => e.json())
          //get folders
          if (path.split('/').length > 3) {
            //normal
            if (localStorage.getItem('helperid')) {
              url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`;
            }
            else {
              url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`;
            }
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            let data = await response.json();
            console.log(JSON.stringify(data));
            const items = data.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(path, '').split(';')[0] } });
            console.log(JSON.stringify(items));
            for (const item of items) {
              const splited = item.name.split(';')[0].split('/');
              if (splited.length > 1) {
                folders.push(splited[0]);
              }
              else {
                folders.push(splited[0].split('|')[0])
              }
            }
          }
          else {
            //use folders
            const sk = `folder:${helperid ? helperid : ownerid}:lvl${path.split('/').length}:${path}`
            console.log(sk)
            let url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            let data = await response.json();
            folders = data.items.map(item => item.sk.replace(sk, ''))
          }


          // Replace existing file paths with dynamic content

          console.log('folders' + JSON.stringify(folders))
          folders = removeDuplicates(folders);
          folders.sort();
          folders.forEach(item => {


            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = document.getElementById('item1').cloneNode(true);
              clonedItem.removeAttribute('hidden')
              // Set unique ID for the cloned item
              clonedItem.id = item;

              // Set file path and emoji
              const file_path = clonedItem.querySelector('[data-value="file-path"]')
              file_path.textContent = item;
              clonedItem.onclick = (e) => {
                const folderChecked = document.getElementById('file-path-list-selected').querySelector('#attach-folder').checked
                folderChecked ? setFolder(path1 + item, id) : setPath()
              }
              let icon = '📂';

              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item;

              // Set up onclick for file-open button
              function setPath() {
                path1 = path1 + item + '/'
                loadUsingPath1(id, path1)
              };

              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }

          });


          //elements



          data1 = await data1
          let elements = data1.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(spath, '').split(';')[0] } });
          elements.sort((a, b) => a.name.localeCompare(b.name));
          const promise = elements.map(el1 => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${el1.id}:${el1.sk}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          }).then(el => el.json()).then(el2 => { return { ...el2, ...el1 } }))
          const elements1 = await Promise.all(elements)
          for (const item of elements1) {

            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = document.getElementById('item1').cloneNode(true);
              clonedItem.removeAttribute('hidden')
              // Set unique ID for the cloned item
              clonedItem.id = item.id;

              // Set file path and emoji
              const item_path = clonedItem.querySelector('[data-value="file-path"]')
              item_path.textContent = item.name;
              clonedItem.onclick = function (event) {

                addSelected(id, item.id, item.lsi1);
              };
              let icon = '🧩';
              if (item.lsi1.startsWith('css')) {
                icon = '🎨';
              } else if (item.lsi1.startsWith('javascript')) {
                icon = '💻';
              }
              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID
              clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

              clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                event.stopPropagation()
                remove(event, item.id);
              };
              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }
          }

        } catch (error) {
          console.error('Error:', error);
        }


      }
      var loadFileList1 = async (id) => {
        // Fetch GET request

        console.log('loading filelist')
        // Fetch GET request
        const helperid = localStorage.getItem('helperid')
        const sk = `folder:${helperid ? helperid : ownerid}:lvl1:`
        let url
        console.log(url)


        var filePathList = document.getElementById('filePathList1');
        filePathList.innerHTML = '';

        if (helperid) {
          url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=|&token=${localStorage.getItem('token')}`;
        }
        else {
          url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=|&token=${localStorage.getItem('token')}`;
        }
        let data1 = fetch(url).then(e => e.json())
        url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`
        return fetch(url)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            // Parse response as JSON
            return response.json();
          })
          .then(async data => {
            console.log(JSON.stringify(data))
            // Replace existing file paths with dynamic content

            let i = 0;
            let folders = data.items.map(item => item.sk.replace(sk, ''))

            console.log(JSON.stringify(data))


            folders = removeDuplicates(folders)
            console.log(JSON.stringify(folders))
            folders.sort()
            folders.forEach(item => {


              if (i < 1000) {
                i++
                // Clone the fieldset
                var clonedItem = document.getElementById('item1').cloneNode(true);
                clonedItem.removeAttribute('hidden')
                // Set unique ID for the cloned item
                clonedItem.id = item;

                // Set file path and emoji
                const file_path = clonedItem.querySelector('[data-value="file-path"]')
                file_path.textContent = item;
                clonedItem.onclick = (e) => {
                  const folderChecked = document.getElementById('file-path-list-selected').querySelector('#attach-folder').checked
                  folderChecked ? setFolder(item, id) : setPath()
                }
                let icon = '📂';

                clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

                // Set file ID
                clonedItem.querySelector('[data-value="file-id"]').textContent = item;

                // Set up onclick for file-open button
                function setPath() {
                  path1 = item + '/'


                  loadUsingPath1(id, path1)
                };

                // Append the cloned item to the filePathList
                filePathList.appendChild(clonedItem);
              }

            });

            // Show the cloned fieldsets
            document.querySelectorAll('#filePathList1 fieldset').forEach(fieldset => {
              fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
            });




            data1 = await data1
            let elements = data1.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace('|', '').split(';')[0] } });
            elements.sort((a, b) => a.name.localeCompare(b.name));
            const promise = elements.map(el1 => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${el1.id}:${el1.sk}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(el => el.json()).then(el2 => { return { ...el2, ...el1 } }))
            const elements1 = await Promise.all(elements)
            for (const item of elements1) {
              if (i < 1000) {
                i++
                // Clone the fieldset
                var clonedItem = document.getElementById('item1').cloneNode(true);
                clonedItem.removeAttribute('hidden')
                // Set unique ID for the cloned item
                clonedItem.id = item.id;

                // Set file path and emoji
                const item_path = clonedItem.querySelector('[data-value="file-path"]')
                item_path.textContent = item.name;
                clonedItem.onclick = function (event) {
                  event.stopPropagation()
                  addSelected(id, item.id, item.lsi1);
                };
                let icon = '🧩';
                if (item.lsi1.startsWith('css')) {
                  icon = '🎨';
                } else if (item.lsi1.startsWith('javascript')) {
                  icon = '💻';
                }
                clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

                // Set file ID
                clonedItem.querySelector('[data-value="file-id"]').textContent = item.id;

                // Set up onclick for file-open button

                clonedItem.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
                  event.stopPropagation()
                  remove(event, item.id);
                };
                // Append the cloned item to the filePathList
                filePathList.appendChild(clonedItem);
              }
            }
            // Update select options
            /*
            var pathSelector = document.getElementById('pathSelector');
            pathSelector.innerHTML = '<option value="select">⬇️ select</option><option value="back">⬅️ back</option>';
            lvls.forEach((lvl, index) => {
              pathSelector.innerHTML += `<option value="${lvl}">➡️ ${lvl}</option>`;
            });*/
            document.querySelectorAll('#filePathList1 fieldset').forEach(fieldset => {
              fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
            });
          }).catch(e => console.log(e))






      }

      const fieldset = document.getElementById('filePathList1');
      const fieldset2 = document.getElementById('file-path-list-selected');

      fieldset2.querySelector('[data-action="moveBack"]').onclick = (e) => {
        const splited = path1.split('/')
        if (path1 === '') {
          return
        }
        else if (splited.length === 2) {
          path1 === ""
          loadFileList1(path)

        }
        else {
          splited.pop()
          splited.pop()
          path1 = splited.join('/') + '/'
          loadUsingPath1(path, path1)

        }
      }



      loadFileList1(path)

    }

    function addDirectoryMenu(e, path, id) {
      e.preventDefault(); // Prevent the default context menu from opening
      console.log('in11');
      const menu = document.querySelector('#right-click-menu'); // Use # for ID selector
      menu.innerHTML = '';

      function addMenuEntry(menu, text, clickHandler) {
        const entry = document.createElement('div');
        entry.className = 'menu-option';
        entry.innerHTML = text;
        entry.onclick = (e) => { removeMenus(); clickHandler(e) };
        menu.appendChild(entry);
      }
      const openRemove1 = (id, path) => {
        var fieldset = document.getElementById(id);

        // Get the file ID element within the fieldset


        // Toggle the visibility of the "cancelation" fieldset
        var cancelationFieldset = document.querySelector('#cancelation');
        const cloned = cancelationFieldset.cloneNode(true)
        cloned.removeAttribute('hidden');
        cloned.querySelector('[data-action="remove-file-confirmation"]').onclick = function (event) {
          event.stopPropagation()
          removeDirectory(event, id, path);
        };
        fieldset.insertAdjacentElement('afterend', cloned);


      }
      const copy = async (id) => {
        const editArea = document.querySelector('[data-element="copy-folder"]');
        const fieldset = document.getElementById(id);

        if (editArea && fieldset) {
          console.log('editing')
          const cloned = editArea.cloneNode(true);
          cloned.querySelector('#choose_link_type').addEventListener('change', function () {
            var select = cloned.querySelector('#choose_link_type');
            var selectedOption = select.options[select.selectedIndex].id;

            if (selectedOption === 'update') {
              document.getElementById('html-structure-label').style.display = 'inline';
              document.getElementById('all-structure-label').style.display = 'inline';

            } else {
              document.getElementById('html-structure-label').style.display = 'none';
              document.getElementById('all-structure-label').style.display = 'none';
            }
          });
          const saveButton = cloned.querySelector('[data-action="copy-file-path-save"]');
          const cancelButton = cloned.querySelector('[data-action="copy-file-path-cancel"]');
          cancelButton.onclick = (e) => {
            e.stopPropagation()
            removeMenus()
          }
          const input = cloned.querySelector('[data-input="copy-file-path-input"]');
          const name = fieldset.querySelector('[data-value="file-path"]').textContent;

          input.value = path.endsWith('/') ? path : path + '/';
          input.onclick = (event) => {
            event.stopPropagation()
          }
          saveButton.onclick = async function (e) {
            e.stopPropagation()
            const new_value = cloned.querySelector('[data-input="copy-file-path-input"]').value
            if (path === new_value) {
              alert('same path')
            }
            const d = new Date()
            const backupCheck = true
            //backup target
            const inputs = cloned.querySelectorAll('input[name="choose_components"]');
            const update = cloned.querySelector('#update').selected
            const hub = cloned.querySelector('#Hub').selected
            const style = cloned.querySelector('#Style').selected
            const content = cloned.querySelector('#Content').selected
            const byId = cloned.querySelector('#byId').selected
            const absolute = cloned.querySelector('#absolute').selected
            const relative = cloned.querySelector('#relative').selected
            const splitedPath = path.replace('|', "/").split('/')
            const last = splitedPath[splitedPath.length - 2]
            console.log('last ' + last)
            const copyToTarget = async (path, new_value, backupCheck) => {
              const response1 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${path}`);
              //list of sub paths
              const data1 = await response1.json();
              const splited = path.split('/')
              splited.pop()
              const fpath = splited.join('/') + '|'
              const response2 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${fpath}`);
              //list of sub paths
              const data2 = await response2.json();
              const items1 = [...data1.items, ...data2.items]
              let items = []
              if (hub || style || content) {
                if (hub) {
                  items.push(...items1.filter(element => element.lsi1.endsWith('|Hub')))
                }
                if (style) {
                  items.push(...items1.filter(element => element.lsi1.endsWith('-Style') || element.lsi1.endsWith('-Structure')))
                }

                if (content) {
                  items.push(...items1.filter(element => element.lsi1.endsWith('-Content')))
                }

                //if (ids.includes("content-files")) {
                //  items.push(...data.items.filter(element => !element.lsi1.endsWith('/Style') && !element.lsi1.endsWith('/Hub') && element.lsi1.split('/')[element.lsi1.split('/').length - 2] !== 'Components'))
                //}
              }
              else {
                console.log('all 11')
                items = items1
              }

              await Promise.all(items.map(async item => {
                const newId = generateUUID()

                const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${item.id}&startsWith=true`, {
                  method: 'GET',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                });
                const res2 = await response.json()
                const pathI = res2.items.find(e => e.sk === 'path')
                //create new file
                let newLSI
                if (pathI.lsi1.includes(path)) {
                  newLSI = pathI.lsi1.replace(path, new_value)
                }
                else if (pathI.lsi1.includes(fpath)) {
                  const sp = new_value.split('/')
                  sp.pop()

                  newLSI = pathI.lsi1.replace(fpath, sp.join('/') + '|')
                }

                if (backupCheck) {
                  const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${newLSI}`);
                  //list of sub paths
                  const data = await response.json();
                  console.log('backuping ' + JSON.stringify(data.items))
                  if (data.items.length) {
                    //move to trash
                    const id = data.items[0].id
                    const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${id}&startsWith=true`, {
                      method: 'GET',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                    });
                    const res2 = await response.json()
                    await Promise.all(res2.items.map(async item1 => {

                      if (item1.sk === 'path') {
                        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json',
                          },
                          body: JSON.stringify(
                            {
                              ...item1,
                              lsi1: 'trash/' + d.toISOString().slice(0, -5) + '-replace/' + item1.lsi1,

                            }
                          ),
                        })
                        await createFolders(convertToOldPath('trash/' + d.toISOString().slice(0, -5) + '-replace/' + item1.lsi1))

                      }

                    }))
                  }
                }
                const pLoad = {
                  ...pathI,
                  id: newId,
                  sk: 'path',
                  lsi1: newLSI,
                  protected: false,
                  hosting_time: undefined
                }
                if (newLSI.endsWith('Head-Content')) {
                  pLoad.hosting_time = { created: new Date().getTime() }
                }
                const data = await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(pLoad),
                })

                console.log('putting ' + newId)
                console.log('res ' + JSON.stringify(data))
                if (byId || absolute || relative) {

                  if (byId) {
                    await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        id: newId,
                        sk: (new Date()).getTime().toString(),
                        action: 'Add_Component',
                        target_element: newId + '-tree',
                        inserted_component: { componentId: pathI.id, id: generateUUID() },
                      }),
                    })
                  }
                  else if (absolute) {


                    const p = convertToOldPath(pathI.lsi1.split(';')[0]).split('/')
                    p.shift()
                    const fileName = p.pop()
                    let r = ''
                    if (p.length) {
                      r = '/' + p.join('/')
                    }
                    const compId = "*" + r + '|' + fileName
                    p.shift()
                    await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        id: newId,
                        sk: (new Date()).getTime().toString(),
                        action: 'Add_Component',
                        target_element: newId + '-tree',
                        inserted_component: { componentId: "*/" + p.join('/'), id: generateUUID() },
                      }),
                    })
                  }
                  else {
                    const relativePath = getRelativePath(convertToOldPath(newLSI), pathI.lsi1.replace('|', '/'))
                    await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        id: newId,
                        sk: (new Date()).getTime().toString(),
                        action: 'Add_Component',
                        target_element: newId + '-tree',
                        inserted_component: { componentId: "#" + relativePath, id: generateUUID() },
                      }),
                    })
                  }
                }
                else {
                  await Promise.all(res2.items.map(async item1 => {



                    //create new file actions
                    if (item1.sk !== 'path') {
                      //copy data

                      if (item1.target_element === item1.id + '-tree') {
                        console.log('err1')
                        item1.target_element = newId + '-tree'
                      }
                      return fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(
                          {
                            ...item1,
                            id: newId
                          }
                        ),
                      })



                    }

                  }))
                }
                console.log('newLSI' + newLSI)
                await createFolders(convertToOldPath(newLSI))
              }))

            }



            if (update) {
              const htmlStructChecked = cloned.querySelector('#html-structure-label').querySelector('input').checked
              const allStructurs = cloned.querySelector('#all-structure-label').querySelector('input').checked
              await updateFolder(path, new_value, last, d, htmlStructChecked, allStructurs)
            }
            else {
              await copyToTarget(path, new_value, backupCheck)
            }






            loadUsingPath()
            cloned.remove();
          };

          cloned.style.display = 'block';
          fieldset.insertAdjacentElement('afterend', cloned);
        }
      }
      const edit = (id, path) => {
        console.log(id)
        const editArea = document.querySelector('[data-element="create-new-file-path"]');
        const fieldset = document.getElementById(id);

        if (editArea && fieldset) {
          console.log('editing')
          const cloned = editArea.cloneNode(true);
          const saveButton = cloned.querySelector('[data-action="create-new-file-path-save"]');
          const cancelButton = cloned.querySelector('[data-action="create-new-file-path-cancel"]');
          cancelButton.onclick = (e) => {
            e.stopPropagation()
            removeMenus()
          }
          const input = cloned.querySelector('[data-input="create-new-file-path-input"]');
          const name = fieldset.querySelector('[data-value="file-path"]').textContent;

          input.value = path;
          input.onclick = (event) => {
            event.stopPropagation()
          }
          saveButton.onclick = async function (e) {
            e.stopPropagation()
            let new_value = cloned.querySelector('[data-input="create-new-file-path-input"]').value
            !new_value.endsWith('/') && (new_value = new_value + '/')
            const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${path}`);
            //list of sub paths
            const data = await response.json();

            const promises = data.items.map(async item1 => {
              const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item1.id}:${item1.sk}`, {
                method: 'GET',
                headers: {
                  'Content-Type': 'application/json',
                  // Add any additional headers if needed
                },
              }).then(e => e.json());;
              item.id = item1.id
              await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(
                  {
                    ...item,
                    lsi1: item.lsi1.replace(path, new_value)
                  }
                ),
              })
              return createFolders(convertToOldPath(item.lsi1.replace(path, new_value)))
            })
            const splited = path.split('/')
            splited.pop()
            const filePath = splited.join('/') + '|'
            const response2 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${filePath}`);
            //list of sub paths
            const data2 = await response2.json();

            const promises2 = data2.items.map(async item1 => {
              const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item1.id}:${item1.sk}`, {
                method: 'GET',
                headers: {
                  'Content-Type': 'application/json',
                  // Add any additional headers if needed
                },
              }).then(e => e.json());
              item.id = item1.id
              await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(
                  {
                    ...item,
                    lsi1: item.lsi1.replace(filePath, convertToNewPath(new_value))
                  }
                ),
              })

            })
            await createFolders(new_value)
            await Promise.all(promises2)
            await Promise.all(promises)
            console.log('done')
            path ? loadUsingPath() : loadFileList()
            cloned.remove();
          };

          cloned.style.display = 'block';
          fieldset.insertAdjacentElement('afterend', cloned);
        }
      };
      async function changeOwner(id, path) {
        console.log('event' + JSON.stringify(event.target.target))
        // Get the parent fieldset of the clicked button
        var fieldset = document.getElementById(id);

        // Get the file ID element within the fieldset
        var fileIdElement = document.querySelector('#change-owner-menu');
        const cloned = fileIdElement.cloneNode(true)
        cloned.id = id
        cloned.removeAttribute('hidden')
        const ownersSelect = cloned.querySelector("#owners-select");
        const helpersSelect = cloned.querySelector("#helpers-select");
        ownersSelect.innerHTML = "";
        helpersSelect.innerHTML = "";
        //get helpers
        const res1 = await fetch(backend_url + `?id=${localStorage.getItem('ownerid')}&sk=helper:&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        }).then(re => re.json())
        for (const item of res1.items) {
          let optionElement = document.createElement("option");
          const name = item.lsi1.split(';')[0]
          optionElement.value = item.sk.split(':')[1];
          optionElement.textContent = name;
          helpersSelect.appendChild(optionElement);
        }
        //get owners
        const res2 = await fetch(backend_url + `?ownerUUID=credentials&startsWith=owner`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        }).then(re => re.json())
        for (const item1 of res2.items) {
          const item = await fetch(backend_url + `/${item1.id}:${item1.sk}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            }
          }).then(re => re.json())
          let optionElement = document.createElement("option");
          const name = item.lsi1.split(';')[0]
          optionElement.value = item.id.split(':')[0]
          optionElement.textContent = name;
          ownersSelect.appendChild(optionElement);
        }
        cloned.querySelector('#save-owner').onclick = async (e) => {
          var ownersSelect = cloned.querySelector("#owners-select");

          // Get the selected option
          var selectedOption = ownersSelect.options[ownersSelect.selectedIndex];

          // Get the value of the selected option
          var selectedValue = selectedOption.value;
          let url = `${backend_url}?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`
          if (localStorage.getItem('helperid')) {
            url = `${backend_url}?helperUUID=path:${localStorage.getItem('helperid')}&ownerUUID=${localStorage.getItem('ownerid')}&helperlsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`
          }
          const { items } = await fetch(url).then(e => e.json())
          const promises = items.map(async item1 => {
            const item = await fetch(backend_url + `/${item1.id}:path`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              }
            }).then(re => re.json())
            item.ownerUUID = 'path:' + selectedValue
            item.id = item.id.split(':')[0]
            //update it 
            await fetch(backend_url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(
                item
              ),
            })
          })
          // get path item
          await Promise.all(promises)
          cloned.remove()

        }
        cloned.querySelector('#save-helper').onclick = async (e) => {
          var ownersSelect = cloned.querySelector("#helpers-select");

          // Get the selected option
          var selectedOption = ownersSelect.options[ownersSelect.selectedIndex];

          // Get the value of the selected option
          var selectedValue = selectedOption.value;


          let url = `${backend_url}?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`
          if (localStorage.getItem('helperid')) {
            url = `${backend_url}?helperUUID=path:${localStorage.getItem('helperid')}&ownerUUID=${localStorage.getItem('ownerid')}&helperlsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`
          }
          const { items } = await fetch(url).then(e => e.json())
          const promises = items.map(async item1 => {
            const item = await fetch(backend_url + `/${item1.id}:path`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              }
            }).then(re => re.json())
            item.helperUUID = 'path:' + selectedValue
            item.id = item.id.split(':')[0]
            //update it 
            await fetch(backend_url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(
                item
              ),
            })
          })
          await Promise.all(promises)
          cloned.remove()

        }


        // Toggle the visibility of the file ID element
        fieldset.insertAdjacentElement('afterend', cloned);
      }
      const addProduct = (id, path) => {
        const name = path
        const original = document.getElementById('file-pathpattached')

        const cloned = original.cloneNode(true)
        cloned.setAttribute('folder', path)
        cloned.removeAttribute('hidden')
        cloned.querySelector('[data-value="file-path"]').textContent = name
        cloned.querySelector('[data-value="file-emoji"]').textContent = '📂'
        original.parentElement.append(cloned)

      }
      const storedPath = localStorage.getItem('storedPath')
      const ownerid = localStorage.getItem('ownerid')
      const helperid = localStorage.getItem('helperid')


      addMenuEntry(menu, '✏️ Edit', (e) => edit(id, path))
      addMenuEntry(menu, '🗑️ Delete', (e) => openRemove1(id, path))
      addMenuEntry(menu, '⧉ Copy', (e) => copy(id, path))
      addMenuEntry(menu, '👤 User', (e) => changeOwner(id, path))
      storedPath.startsWith('Stock') && product && addMenuEntry(menu, '📦 Product +', (e) => addProduct(id, path))
      addMenuEntry(menu, '✅ Protection +', (e) => setProtected(id, path, true))
      addMenuEntry(menu, '❌ Protection -', (e) => setProtected(id, path, false))
      addMenuEntry(menu, '🗑️ Remove Except content', (e) => removeButContent(e, id, path))


      const publishFolder = async (id, path) => {
        try {
          fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/bulkpublish', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id, path, ownerid }),
          })
        } catch (e) {

        }
        alert('publishing')
      }
      addMenuEntry(menu, '📰 Publish', (e) => publishFolder(id, path))


      const setProtected = async (id, path, protected) => {
        const ownerid = localStorage.getItem('ownerid')
        const response1 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${path}`);
        //list of sub paths
        const data = await response1.json();
        let url2 = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${path.slice(0, -1) + '|'}`;
        let data2 = await fetch(url2).then(e => e.json())
        await Promise.all([...data.items, ...data2.items].map(async item1 => {
          const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${item1.id}:${item1.sk}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          }).then(el => el.json())
          item.id = item1.id
          fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ...item, protected }),
          })
        }
        ))
        alert('protection set')

      }
      // Adjust the position relative to the viewport
      const offsetX = e.pageX;
      const offsetY = e.pageY;

      menu.style.display = 'block';
      menu.style.left = `${offsetX}px`;
      menu.style.top = `${offsetY}px`;

      // Hide the menu when clicking the left mouse button
      window.addEventListener('click', function () {
        menu.style.display = 'none';
      });

    }
    async function loader(e, handler) {
      //const loadingScreen = document.getElementById('loading');
      //loadingScreen.style.display = 'flex';

      const timerElement = document.getElementById('last-action-time');
      let tenthsOfSeconds = 0;
      const interval = setInterval(function () {
        tenthsOfSeconds++;
        timerElement.textContent = (tenthsOfSeconds / 10).toFixed(1);
      }, 100);

      await handler(e);

      //loadingScreen.style.display = 'none';
      clearInterval(interval);
      console.log(timerElement.textContent)
      console.log(tenthsOfSeconds)
      //const lastActionTime = document.getElementById('timer');
      //lastActionTime.textContent = timerElement.textContent;
    }
    const cancel = (event) => {
      event.stopPropagation()
      console.log("cancelling")
      event.target.parentNode.setAttribute('hidden', "")
    }
    const cancel2 = (event) => {
      event.stopPropagation()
      console.log("cancelling")
      event.target.parentNode.setAttribute('hidden', "")
      document.getElementById('file-path-list-attached').setAttribute('hidden', "")
    }
    const openRemove = (event) => {
      var fieldset = event.currentTarget.closest('li');

      // Get the file ID element within the fieldset
      var fileIdElement = fieldset.querySelector('[data-element="file-id"]');

      // Log the file ID
      console.log('File ID:', fileIdElement.lastElementChild.textContent);

      // Toggle the visibility of the file ID element
      fileIdElement.hidden = false;

      // Toggle the visibility of the "cancelation" fieldset
      var cancelationFieldset = fieldset.querySelector('#cancelation');
      cancelationFieldset.hidden = !cancelationFieldset.hidden;

    }
    function showId(event) {
      // Get the parent fieldset of the clicked button
      var fieldset = event.currentTarget.closest('li');

      // Get the file ID element within the fieldset
      var fileIdElement = fieldset.querySelector('[data-element="file-id"]');

      // Toggle the visibility of the file ID element
      fileIdElement.hidden = !fileIdElement.hidden;
    }
    const openTypeSelect = () => {
      var fieldset = document.querySelector('[data-element="choose-new-file-type"]');
      fieldset.removeAttribute('hidden');
    }
    const handleBlogPostChange = (e) => {
      const storedPath = localStorage.getItem('storedPath')
      document.querySelector('[data-input="create-new-file-path-input"]').value = storedPath.split('/')[0] + '/Blog/'
    }
    var product = false
    const handleProductPostChange = (e) => {
      const pathE = document.getElementById('file-path-list-attached')
      console.log('checked')
      if (e.target.checked) {
        pathE.removeAttribute('hidden')
        product = true
      }
      else {
        pathE.setAttribute('hidden', '')
      }


    }
    function createNew() {

      var fieldset2 = document.querySelector('[data-element="create-new-file-path"]');
      const storedPath = localStorage.getItem('storedPath')
      document.querySelector('[data-input="create-new-file-path-input"]').value = storedPath
      fieldset2.removeAttribute('hidden');

    }
    const updateHelper = async (event) => {
      const target = event.target
      const menu = target.closest('#helper-menu')
      const sk = menu.getAttribute('sk')
      const username = menu.querySelector('#helper-username').value
      const password = menu.querySelector('#helper-password').value
      const files = menu.querySelector('#filesCheckbox').checked
      const ecom = menu.querySelector('#ecomCheckbox').checked
      const payload = {
        id: localStorage.getItem('ownerid'),
        sk,
        lsi1: username + ';' + password,
        ownerUUID: 'credentials',
        permission: {
          ecommerce: ecom,
          files
        }
      }
      await fetch(backend_url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(
          payload
        ),
      })
      loadHelpers()
      menu.remove()

    }
    const removeHelper = async (event) => {
      const target = event.target
      const menu = target.closest('#helper-menu')
      const sk = menu.getAttribute('sk')
      await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${localStorage.getItem('ownerid')}:${sk}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          // Add any additional headers if needed
        },
      });
      loadHelpers()
      menu.remove()

    }
    function createNewHelper() {
      removeMenus2()
      const helperSection = document.querySelector('[data-brains="helpers"]')
      const helperMenu = document.getElementById('helper-menu')
      const cloned = helperMenu.cloneNode(true)
      cloned.removeAttribute('hidden')
      cloned.setAttribute('sk', 'helper:' + generateUUID())
      helperSection.append(cloned)
    }
    const createFolders = async (path, ownerid1, helperid1) => {
      const splited = path.split('/')
      const fileName = splited.pop()
      let path1
      const helper = helperid1 || localStorage.getItem('helperid')
      const ownerid = ownerid1 || localStorage.getItem('ownerid')

      for (let i = 0; i < splited.length && i < 3; i++) {
        if (i !== 0) {
          path1 = path1 + '/' + splited[i]
        }
        else {
          path1 = splited[i]
        }
        let payload = {
          id: ownerid,
          sk: `folder:${ownerid}:lvl${i + 1}:${path1}`
        }
        await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        })

        if (helper) {
          payload.sk = `folder:${helper}:lvl${i + 1}:${path1}`
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          })
        }

      }
    }
    async function savePath() {
      var fieldset2 = document.querySelector('[data-element="create-new-file-path"]');
      fieldset2.setAttribute('hidden', '');
      const blogCheckbox = document.getElementById('blog-checkbox')

      const productCheckbox = document.getElementById('product-checkbox')

      // Access the type from the choose-new-file-type fieldset
      // var type = document.querySelector('[data-element="choose-new-file-type"]').getAttribute('type');

      // Get the path from the input element
      var pathInput = document.querySelector('[data-input="create-new-file-path-input"]');
      var path = pathInput.value;
      pathInput.value = ''

      // Create a new path based on the type
      var newPath = path;
      if (productCheckbox.checked) {
        //get style from hub
        const hub = newPath.split('/')[0] + '/Home|Hub'
        const response1 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${hub}`);
        //list of sub paths
        console.log(hub)
        const data1 = await response1.json();
        console.log(JSON.stringify(data1))

        const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${data1.items[0].id}&sk=${data1.items[0].sk}&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        // get style
        const hubItems = await response.json()
        console.log(JSON.stringify(hubItems))
        const style = hubItems.items[0].hub_items.style


        const elements = document.querySelectorAll('[data-element="file-pathpattached"]')
        const folders = Array.from(elements).filter(e => e.hasAttribute('folder')).map(e => e.getAttribute('folder'))
        const components = Array.from(elements).filter(e => e.hasAttribute('component')).map(e => { return { lsi1: e.getAttribute('component'), id: e.id } })
        const components1 = await Promise.all(
          components.map(({ id }) => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${id}:path`).then(e => e.json()).then(r => {
            r.id = id
            return r
          }))
        )
        const components2 = [...components1]
        for (const folder of folders) {
          const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${folder.slice(0, -1) + '|'}`);
          //list of sub paths
          const { items } = await response.json();
          const items2 = await Promise.all(
            items.map(({ id }) => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${id}:path`).then(e => e.json()).then(r => {
              r.id = id
              return r
            }))
          )
          components2 = [...components2, ...items2]
        }
        for (const component of components2) {
          console.log('component' + JSON.stringify(component))
          const copyFrom = style + '/Products/Seed-Product/'
          const splitedPath = copyFrom.replace('|', "/").split('/')
          const last = splitedPath[splitedPath.length - 2]
          const compName = component.lsi1.split(';')[0].split('|')[1]
          const copyTo = newPath.split('/')[0] + '/Products/' + compName + '/'
          await updateFolder(copyFrom, copyTo, last, new Date())
          //Set sku
          const headLSI = copyTo + 'Content/Page|Head-Content'
          const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${headLSI}`);
          //list of sub paths
          const { items } = await response.json();
          const toUp = items[0]
          const url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${toUp.id}:${toUp.sk}`
          console.log(url)
          const item = await fetch(url).then(r => r.json())
          item.id = toUp.id
          item.sku = component.sku
          console.log(JSON.stringify(item))
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            body: JSON.stringify(item),
          });

        }


        path ? loadUsingPath() : loadFileList()
        return
      }
      if (blogCheckbox.checked) {
        const hub = newPath.split('/')[0] + '/Home|Hub'
        const response1 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${hub}`);
        //list of sub paths
        console.log(hub)
        const data1 = await response1.json();
        console.log(JSON.stringify(data1))

        const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${data1.items[0].id}&sk=${data1.items[0].sk}&startsWith=true`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        // get style
        const hubItems = await response.json()
        console.log(JSON.stringify(hubItems))
        const style = hubItems.items[0].hub_items.style
        const copyFrom = style + '/Blog/Seed-Article/'
        const splitedPath = copyFrom.replace('|', "/").split('/')
        const last = splitedPath[splitedPath.length - 2]
        const p = path.endsWith('/') ? path : path + '/'
        await updateFolder(copyFrom, p, last, new Date())
        path ? loadUsingPath() : loadFileList()
        return
      }
      // Perform additional actions based on the selected type and path
      console.log('at path:', newPath);
      const splited = newPath.split('/')
      const fileName = splited.pop()
      // Fetch POST request
      const payload = {
        sk: 'path',
        lsi1: splited.join('/') + '|' + fileName,
        ownerUUID: 'path:' + localStorage.getItem('ownerid'),
        created: new Date().getTime()
      }
      const helperId = localStorage.getItem('helperid')
      if (helperId) {
        payload.helperUUID = 'path:' + helperId
      }
      await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      })
        .then(response => response.json())

        .catch(error => console.error('Error:', error));
      //create folders
      await createFolders(newPath)

      path ? loadUsingPath() : loadFileList()
    }
    let path = ''
    let lvls = []
    const removeDirectory = async (event, id, path) => {
      const d = new Date()
      event.preventDefault();

      // Get the closest list item (li) element
      var listItem = document.getElementById(id);

      try {
        const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${path}`);
        //list of sub paths
        const data = await response.json();

        const response2 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${path.slice(0, -1) + '|'}`);
        //list of sub paths
        const data2 = await response2.json();
        const items = [...data.items, ...data2.items]
        const all = await Promise.all(items.map(async item => {

          const { id, } = item;
          const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${id}&sk=path&startsWith=true`).then(e => e.json())
          let item1 = response.items.find(e => e.sk === 'path')
          if (item1.protected) {
            console.log('protected el ' + id)
            return true
          }
          if (item1.lsi1.startsWith('trash')) {
            for (const item of response.items) {
              const { id, sk } = item
              const deleteResponse = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${id}:${sk}`, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  // Add any additional headers if needed
                },
              });

            }
          }
          else {
            const trashLsi = 'trash/' + d.toISOString().slice(0, -5) + '-replace/' + item1.lsi1
            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(
                {
                  ...item1,
                  lsi1: trashLsi,

                }
              ),
            })
            await createFolders(convertToOldPath(trashLsi))
          }





          return false

        }))

        removeMenus()
        if (all.every(el => el)) {
          alert('all protected')
          return
        } else if (all.some(e => e)) {
          alert('partial delete')
          return
        }

        listItem.remove();
      } catch (error) {
        console.error('Error:', error);
      }
    };
    const removeButContent = async (event, id, path) => {
      const d = new Date()
      event.preventDefault();

      // Get the closest list item (li) element
      var listItem = document.getElementById(id);

      try {
        const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${path}`);
        //list of sub paths
        const data = await response.json();

        const response2 = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${localStorage.getItem('ownerid')}&gsi1lsi1=true&lsi1=${path.slice(0, -1) + '|'}`);
        //list of sub paths
        const data2 = await response2.json();
        const items = [...data.items, ...data2.items].filter(item => !item.lsi1.split(';')[0].endsWith('-Content'))
        const all = await Promise.all(items.map(async item => {

          const { id, } = item;
          const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${id}&sk=path&startsWith=true`).then(e => e.json())
          let item1 = response.items.find(e => e.sk === 'path')
          if (item1.protected) {
            console.log('protected el ' + id)
            return true
          }
          if (item1.lsi1.startsWith('trash')) {
            for (const item of response.items) {
              const { id, sk } = item
              const deleteResponse = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${id}:${sk}`, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  // Add any additional headers if needed
                },
              });

            }
          }
          else {
            const trashLsi = 'trash/' + d.toISOString().slice(0, -5) + '-replace/' + item1.lsi1
            await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(
                {
                  ...item1,
                  lsi1: trashLsi,

                }
              ),
            })
            await createFolders(convertToOldPath(trashLsi))
          }





          return false

        }))

        removeMenus()
        if (all.length) {
          if (all.every(el => el)) {
            alert('all protected')
            return
          } else if (all.some(e => e)) {
            alert('partial delete')
            return
          }
        }


      } catch (error) {
        console.error('Error:', error);
      }
    };

    const remove = async (event, id) => {
      event.preventDefault();

      // Get the closest list item (li) element
      var listItem = document.getElementById(id);

      const d = new Date()
      try {
        const response = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${id}&startsWith=true`);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();

        if (data.items.find(e => e.protected)) {
          alert('protected component');
          return;
        }

        // Step 2: Iterate through the items and send a DELETE request for each
        const pathI = data.items.find(i => i.sk === 'path')
        if (pathI.lsi1.startsWith('trash')) {
          for (const item of data.items) {
            const { id, sk } = item
            const deleteResponse = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${id}:${sk}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
                // Add any additional headers if needed
              },
            });

          }
        }
        else {
          const trashLsi = 'trash/' + d.toISOString().slice(0, -5) + '-replace/' + pathI.lsi1
          await fetch('https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(
              {
                ...pathI,
                lsi1: trashLsi,

              }
            ),
          })
          await createFolders(convertToOldPath(trashLsi))
        }

      } catch (error) {
        console.error('Error:', error);
      }

      removeMenus()

      listItem.remove();
    }
    const removeMenus = () => document.querySelector("#filePathList").querySelectorAll('[data-menu]').forEach(menu => menu.remove())
    function removeDuplicates(arr) {
      return Array.from(new Set(arr));
    }
    async function loadFileList() {
      // Fetch GET request
      const helperid = localStorage.getItem('helperid')
      const ownerid = localStorage.getItem('ownerid')
      const sk = `folder:${helperid ? helperid : ownerid}:lvl1:`
      let url
      console.log(url)


      var filePathList = document.getElementById('filePathList');
      filePathList.innerHTML = '';
      document.getElementById('main-files-list').append(filePathList)
      if (helperid) {
        url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=|&token=${localStorage.getItem('token')}`;
      }
      else {
        url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=|&token=${localStorage.getItem('token')}`;
      }
      let data1 = fetch(url).then(e => e.json())
      url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`
      return fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          // Parse response as JSON
          return response.json();
        })
        .then(async data => {
          console.log(JSON.stringify(data))
          // Replace existing file paths with dynamic content

          let i = 0;
          let folders = data.items.map(item => item.sk.replace(sk, ''))

          console.log(JSON.stringify(data))


          folders = removeDuplicates(folders)
          console.log(JSON.stringify(folders))
          folders.sort()
          folders.forEach(item => {


            if (i < 1000) {
              i++
              // Clone the fieldset
              var clonedItem = document.querySelector('[data-element="file-path"]').cloneNode(true);
              clonedItem.removeAttribute('hidden')
              // Set unique ID for the cloned item
              clonedItem.id = item || 'empty';

              // Set file path and emoji
              const file_path = clonedItem.querySelector('[data-value="file-path"]')
              file_path.textContent = item;
              clonedItem.onclick = setPath
              let icon = '📂';

              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Set file ID

              // Set up onclick for file-open button
              function setPath() {
                path = item + '/'
                localStorage.setItem('storedPath', path)
                console.log(path)
                const labelElement = document.querySelector('#path-label');

                // Update the text content of the label
                labelElement.textContent = `${path}`;
                openPath();
              };
              clonedItem.addEventListener('contextmenu', (e) => addDirectoryMenu(e, item + '/', item))

              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }

          });

          // Show the cloned fieldsets
          document.querySelectorAll('#filePathList fieldset').forEach(fieldset => {
            fieldset.id !== 'cancelation' && fieldset.removeAttribute('hidden');
          });


          folders.map(async folder => {
            let url2
            if (helperid) {
              url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${path + folder + '/'}&token=${localStorage.getItem('token')}&pageSize=1`;
              url2 = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${path + folder + '|'}&token=${localStorage.getItem('token')}&pageSize=1`;
            }
            else {
              url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${path + folder + '/'}&token=${localStorage.getItem('token')}&pageSize=1`;
              url2 = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${path + folder + '|'}&token=${localStorage.getItem('token')}&pageSize=1`;
            }
            console.log(url)
            let data1 = fetch(url).then(e => e.json())
            let data2 = fetch(url2).then(e => e.json())
            data1 = await data1
            data2 = await data2
            if ((!data1.items.length && !data2.items.length) || !folder) {
              const sk = `folder:${helperid ? helperid : ownerid}:lvl${path.split('/').length}:${path}${folder}`
              const encoded = `${ownerid}:${sk}`.replaceAll('/', '~')
              await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${encoded}`, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  // Add any additional headers if needed
                },
              });
              document.getElementById(folder || 'empty').remove()
            }

          })

          data1 = await data1
          let elements = data1.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace('|', '').split(';')[0] } });
          elements.sort((a, b) => a.name.localeCompare(b.name));
          for (const el1 of elements) {
            const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${el1.id}:${el1.sk}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(el => el.json()).then(el2 => { return { ...el2, ...el1 } });
            if (i < 1000) {
              i++;
              // Clone the fieldset
              var clonedItem = document.querySelector('[data-element="file-path"]').cloneNode(true);
              clonedItem.removeAttribute('hidden');
              // Set unique ID for the cloned item
              clonedItem.id = item.id;

              // Set file path and emoji
              const item_path = clonedItem.querySelector('[data-value="file-path"]');
              item_path.textContent = item.name;
              clonedItem.addEventListener('contextmenu', (e) => addMenu(e, item.id, item.protected, item.lsi1, item));
              clonedItem.onclick = function (event) {
                redirect(item.id);
              };
              let icon = '🧩';
              if (item.lsi1.startsWith('css')) {
                icon = '🎨';
              } else if (item.lsi1.startsWith('javascript')) {
                icon = '💻';
              }
              clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

              // Append the cloned item to the filePathList
              filePathList.appendChild(clonedItem);
            }
          }
          // Update select options
          /*
          var pathSelector = document.getElementById('pathSelector');
          pathSelector.innerHTML = '<option value="select">⬇️ select</option><option value="back">⬅️ back</option>';
          lvls.forEach((lvl, index) => {
            pathSelector.innerHTML += `<option value="${lvl}">➡️ ${lvl}</option>`;
          });*/
        }).catch(e => console.log(e))


    }
    const openPath = () => {
      loadUsingPath()
    }
    const redirect = (id) => {
      console.log(id)
      const redirectURL = `component.html?id=${id}&rand=${Math.random()}`;

      // Redirect to the new URL
      window.location.href = redirectURL;
    }
    function handlePathSelection() {
      // Get the selected value from the pathSelector
      var selectedValue = document.getElementById('pathSelector').value;

      // Get the corresponding item based on the selected value
      var selectedItem = selectedValue

      // Handle the selected item as needed
      console.log('Selected Item:', selectedItem);
      if (selectedItem === 'select' || selectedItem === undefined) {
        return
      }
      if (selectedItem === 'back') {
        if (path === '') {
          return
        }
        const splited = path.split('/')
        if (splited.length === 1) {
          loadFileList()
          return
        }
        splited.pop()
        path = splited.join('/')
        loadUsingPath()
        return
      }
      if (path === '') {
        path = selectedItem
      }
      else {
        path = path + '/' + selectedItem

      }
      console.log(path)
      loadUsingPath()

    }
    function loadRoot() {

      path = ''
      localStorage.setItem('storedPath', path)
      const labelElement = document.querySelector('#path-label');

      // Update the text content of the label
      labelElement.textContent = `${path}`;
      loadFileList();
    }
    function labelClick(event) {
      // Extract the clicked part of the text based on the click position
      const clickedText = getClickedText(event, event.target.textContent);

      const p = clickedText
      path = p + '/'
      localStorage.setItem('storedPath', path)
      console.log(path)
      const labelElement = document.querySelector('#path-label');

      // Update the text content of the label
      labelElement.textContent = `${path}`;
      openPath();

      // Do something with the extracted text (for example, log it)
      console.log(clickedText);
    }

    function getClickedText(event, labelText) {
      const clickX = event.clientX;
      const labelRect = event.target.getBoundingClientRect();
      const relativeClickX = clickX - labelRect.left;

      // Split the label text into parts based on the '/' separator
      const parts = labelText.split('/');

      // Find the part that corresponds to the clicked position
      let accumulatedWidth = 0;
      for (const part of parts) {
        const partWidth = getTextWidth(part + '/', event.target);
        accumulatedWidth += partWidth;
        if (accumulatedWidth >= relativeClickX) {
          const parts1 = parts.slice(0, parts.indexOf(part) + 1)
          return parts1.join('/')
        }
      }

      // Default: return the entire label text
      return labelText;
    }

    function getTextWidth(text, element) {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      const computedStyle = window.getComputedStyle(element);
      context.font = computedStyle.font;

      // Measure the width of the text
      const width = context.measureText(text).width;

      // Cleanup
      canvas.remove();

      return width;
    }
    const loadUsingPath = async () => {




      try {
        //get files
        let url

        const helperid = localStorage.getItem('helperid')
        const ownerid = localStorage.getItem('ownerid')

        var filePathList = document.getElementById('filePathList');
        filePathList.innerHTML = '';
        let lvls = [];
        let i = 0;
        let folders = [];

        //get files
        const spath = path.slice(0, -1) + '|';
        document.getElementById('main-files-list').append(filePathList)

        if (helperid) {
          url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${spath}&token=${localStorage.getItem('token')}`;
        }
        else {
          url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${spath}&token=${localStorage.getItem('token')}`;
        }
        let data1 = fetch(url).then(e => e.json())
        const setHeadDates = async (element, path) => {
          const headPath = path + 'Content/Page|Head-Content'
          let headUrl = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${headPath}&token=${localStorage.getItem('token')}`;

          const { items } = await fetch(headUrl).then(e => e.json())
          console.log(headUrl)
          console.log(JSON.stringify(items))
          if (items.length) {
            const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${items[0].id}:${items[0].sk}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }).then(el => el.json())
            console.log(JSON.stringify(item))
            const { hosting_time } = item
            const { created, published, updated, content_updated, removed } = hosting_time || {}
            function formatDate(timestamp) {
              if (!timestamp) {
                return ""
              }
              const date = new Date(timestamp)
              const options = { day: '2-digit', month: 'long', year: 'numeric' };
              const formattedDate = date.toLocaleDateString('en-US', options);
              return formattedDate;
            }

            if (created) {
              element.querySelector('[data-column-created_value]').textContent = formatDate(created);
              element.querySelector('[data-date-created-label]').removeAttribute('hidden');
              element.querySelector('[data-column-created_value').removeAttribute('hidden');
            }

            // Update published date
            if (published) {
              element.querySelector('[data-column-published-value]').textContent = formatDate(published);
              element.querySelector('[data-date-published-label]').removeAttribute('hidden');
              element.querySelector('[data-column-published-value]').removeAttribute('hidden');
            }

            // Update updated date
            if (updated) {
              element.querySelector('[data-column-updated-value]').textContent = formatDate(updated);
              element.querySelector('[data-date-updated-label]').removeAttribute('hidden');
              element.querySelector('[data-column-updated-value]').removeAttribute('hidden');
            }

            // Update content_updated date
            if (content_updated) {
              element.querySelector('[data-column-content-updated-value]').textContent = formatDate(content_updated);
              element.querySelector('[data-date-content-updated-label]').removeAttribute('hidden');
              element.querySelector('[data-column-content-updated-value]').removeAttribute('hidden');
            }

            // Update removed date
            if (removed) {
              element.querySelector('[data-column-removed-value]').textContent = formatDate(removed);
              element.querySelector('[data-date-removed-label]').removeAttribute('hidden');
              element.querySelector('[data-column-removed-value ]').removeAttribute('hidden');
            }
          }
        }

        //get folders
        if (path.split('/').length > 3) {
          //normal
          if (localStorage.getItem('helperid')) {
            url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`;
          }
          else {
            url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${path}&token=${localStorage.getItem('token')}`;
          }
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          let data = await response.json();
          console.log(JSON.stringify(data));
          const items = data.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(path, '').split(';')[0] } });
          console.log(JSON.stringify(items));
          for (const item of items) {
            const splited = item.name.split(';')[0].split('/');
            if (splited.length > 1) {
              folders.push(splited[0]);
            }
            else {
              folders.push(splited[0].split('|')[0])
            }
          }
        }
        else {
          //use folders
          const sk = `folder:${helperid ? helperid : ownerid}:lvl${path.split('/').length}:${path}`
          console.log(sk)
          let url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?id=${ownerid}&sk=${sk}&startsWith=true`
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          let data = await response.json();
          folders = data.items.map(item => item.sk.replace(sk, ''))
        }


        // Replace existing file paths with dynamic content

        console.log('folders' + JSON.stringify(folders))
        folders = removeDuplicates(folders);
        folders.sort();
        folders.sort((a, b) => {
          // Check if either element is "Home" or starts with "Home-Page"
          const aIsHome = a === "Home" || a.startsWith("Home-Page");
          const bIsHome = b === "Home" || b.startsWith("Home-Page");

          // If both are "Home" or start with "Home-Page", maintain their order
          if (aIsHome && bIsHome) {
            return 0;
          }
          // If only 'a' is "Home" or starts with "Home-Page", move it before 'b'
          else if (aIsHome) {
            return -1;
          }
          // If only 'b' is "Home" or starts with "Home-Page", move it before 'a'
          else if (bIsHome) {
            return 1;
          }
          // Otherwise, maintain the original order
          else {
            return 0;
          }
        });
        folders.forEach(item => {
          if (i < 1000) {
            i++;
            // Clone the fieldset
            var clonedItem = document.querySelector('[data-element="file-path"]').cloneNode(true);

            // Set unique ID for the cloned item
            clonedItem.id = item ? item : 'empty';
            clonedItem.removeAttribute('hidden');
            // Set file path and emoji
            const file_path = clonedItem.querySelector('[data-value="file-path"]');
            file_path.textContent = item;
            clonedItem.onclick = setPath;
            let icon = '📂';

            clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

            // Set up onclick for file-open button
            function setPath() {
              path = path + item + '/';
              localStorage.setItem('storedPath', path);
              console.log(path);
              const labelElement = document.querySelector('#path-label');

              // Update the text content of the label
              labelElement.textContent = `${path}`;
              openPath();
            };
            clonedItem.addEventListener('contextmenu', (e) => addDirectoryMenu(e, path + item + '/', item ? item : 'empty'));
            setHeadDates(clonedItem, path + item + '/')

            // Append the cloned item to the filePathList
            filePathList.appendChild(clonedItem);
          }
        });


        //elements


        data1 = await data1
        let elements = data1.items.filter(i => i.lsi1).map(item1 => { return { ...item1, name: item1.lsi1.replace(spath, '').split(';')[0] } });
        elements.sort((a, b) => a.name.localeCompare(b.name));
        const promise = elements.map(el1 => fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${el1.id}:${el1.sk}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(el => el.json()).then(el2 => { return { ...el2, ...el1 } }))
        const elements1 = await Promise.all(elements)
        for (const item of elements1) {
          /*
          const item = await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${el1.id}:${el1.sk}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          }).then(el => el.json()).then(el2 => { return { ...el2, ...el1 } });*/
          if (i < 1000) {
            i++;
            // Clone the fieldset
            var clonedItem = document.querySelector('[data-element="file-path"]').cloneNode(true);
            clonedItem.removeAttribute('hidden');
            // Set unique ID for the cloned item
            clonedItem.id = item.id;

            // Set file path and emoji
            const item_path = clonedItem.querySelector('[data-value="file-path"]');
            item_path.textContent = item.name;
            clonedItem.addEventListener('contextmenu', (e) => addMenu(e, item.id, item.protected, item.lsi1, item));
            clonedItem.onclick = function (event) {
              redirect(item.id);
            };
            let icon = '🧩';
            if (item.lsi1.startsWith('css')) {
              icon = '🎨';
            } else if (item.lsi1.startsWith('javascript')) {
              icon = '💻';
            }
            clonedItem.querySelector('[data-value="file-emoji"]').textContent = icon;

            // Append the cloned item to the filePathList
            filePathList.appendChild(clonedItem);
          }
        }
        if (path.split('/').length < 4) {
          folders.map(async folder => {
            let url2
            if (helperid) {
              url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${path + folder + '/'}&token=${localStorage.getItem('token')}&pageSize=1`;
              url2 = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?helperUUID=path:${helperid}&ownerUUID=${ownerid}&helperlsi1=true&lsi1=${path + folder + '|'}&token=${localStorage.getItem('token')}&pageSize=1`;
            }
            else {
              url = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${path + folder + '/'}&token=${localStorage.getItem('token')}&pageSize=1`;
              url2 = `https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2?ownerUUID=path:${ownerid}&gsi1lsi1=true&lsi1=${path + folder + '|'}&token=${localStorage.getItem('token')}&pageSize=1`;
            }
            let data1 = fetch(url).then(e => e.json())
            let data2 = fetch(url2).then(e => e.json())
            data1 = await data1
            data2 = await data2
            if (!data1.items.length && !data2.items.length) {
              console.log(url)
              const sk = `folder:${helperid ? helperid : ownerid}:lvl${path.split('/').length}:${path}${folder}`
              const encoded = `${ownerid}:${sk}`.replaceAll('/', '~')
              await fetch(`https://5jfh1fonoh.execute-api.us-east-1.amazonaws.com/prod/templatesv2/${encoded}`, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  // Add any additional headers if needed
                },
              });
              console.log(encoded)
              document.getElementById(folder).remove()
            }

          })
        }
      } catch (error) {
        console.error('Error:', error);
      }
    };
    const setColumnSelectors = () => {
      const created = localStorage.getItem('created-column')
      const published = localStorage.getItem('published-column')
      const updated = localStorage.getItem('updated-column')
      const content_updated = localStorage.getItem('content-column')
      const removed = localStorage.getItem('removed-column')
      if (created) {
        document.getElementById('columns_selector_created').checked = true;
        document.querySelectorAll('[data-column-created]').forEach(e => e.removeAttribute('hidden'))
      }
      if (published) {
        document.getElementById('columns_selector_published').checked = true;
        document.querySelectorAll('[data-column-published]').forEach(e => e.removeAttribute('hidden'))
      }
      if (updated) {
        document.getElementById('columns_selector_updated').checked = true;
        document.querySelectorAll('[data-column-updated]').forEach(e => e.removeAttribute('hidden'))
      }
      if (content_updated) {
        document.getElementById('columns_selector_content_updated').checked = true;
        document.querySelectorAll('[data-column-content-updated]').forEach(e => e.removeAttribute('hidden'))
      }
      if (removed) {
        document.getElementById('columns_selector_removed').checked = true;
        document.querySelectorAll('[data-column-removed]').forEach(e => e.removeAttribute('hidden'))
      }
    }
    const setChecked = (event, lsItem, selector) => {
      const checked = event.target.checked
      if (checked) {
        localStorage.setItem(lsItem, true)
        document.querySelectorAll(`[${selector}]`).forEach(e => e.removeAttribute('hidden'))
      }
      else {
        localStorage.removeItem(lsItem)
        document.querySelectorAll(`[${selector}]`).forEach(e => e.setAttribute('hidden', ''))
      }
    }
    const setSorting = () => {
      const sortSelect = document.getElementById('sortSelect');
      const dataTable = document.getElementById('filePathList');

      function parseCustomDate(dateString) {

        const months = {
          "January": 0, "February": 1, "March": 2, "April": 3, "May": 4, "June": 5,
          "July": 6, "August": 7, "September": 8, "October": 9, "November": 10, "December": 11
        };
        const parts = dateString.split(' ');
        const month = months[parts[0]];
        const day = parseInt(parts[1].replace(',', ''));
        const year = parseInt(parts[2]);
        return new Date(year, month, day);
      }
      function getDateValue(row, attribute) {
        const element = row.querySelector(`[${attribute}]`);
        if (element) {
          const value = element.textContent.trim();
          return value ? parseCustomDate(value) : null;
        }
        return null;
      }

      function compareDates(dateA, dateB) {
        // Handle null or undefined cases
        if (!dateA && !dateB) return 0;
        if (!dateA) return 1; // dateB is considered smaller (should be sorted earlier)
        if (!dateB) return -1; // dateA is considered smaller

        return dateA - dateB;
      }
      sortSelect.addEventListener('change', function () {
        let rows = Array.from(dataTable.getElementsByTagName('tr'));
        const selectedOption = sortSelect.value;

        switch (selectedOption) {
          case 'az':
            rows.sort((a, b) => {
              const pathA = a.querySelector('[data-value="file-path"]').textContent.trim().toLowerCase();
              const pathB = b.querySelector('[data-value="file-path"]').textContent.trim().toLowerCase();
              return pathA.localeCompare(pathB);
            });
            break;
          case 'za':
            rows.sort((a, b) => {
              const pathA = a.querySelector('[data-value="file-path"]').textContent.trim().toLowerCase();
              const pathB = b.querySelector('[data-value="file-path"]').textContent.trim().toLowerCase();
              return pathB.localeCompare(pathA);
            });
            break;
          case 'published_asc':
            rows.sort((a, b) => {
              const dateA = getDateValue(a, 'data-column-published-value');
              const dateB = getDateValue(b, 'data-column-published-value');
              return compareDates(dateA, dateB);
            });
            break;
          case 'published_desc':
            rows.sort((a, b) => {
              const dateA = getDateValue(a, 'data-column-published-value');
              const dateB = getDateValue(b, 'data-column-published-value');
              return compareDates(dateB, dateA);
            });
            break;
          case 'created_asc':
            rows.sort((a, b) => {
              const dateA = getDateValue(a, 'data-column-created_value');
              const dateB = getDateValue(b, 'data-column-created_value');
              return compareDates(dateA, dateB);
            });
            break;
          case 'created_desc':
            rows.sort((a, b) => {
              const dateA = getDateValue(a, 'data-column-created_value');
              const dateB = getDateValue(b, 'data-column-created_value');
              return compareDates(dateB, dateA);
            });
            break;
          case 'content_updated_asc':
            rows.sort((a, b) => {
              const dateA = getDateValue(a, 'data-column-content-updated-value');
              const dateB = getDateValue(b, 'data-column-content-updated-value');
              return compareDates(dateA, dateB);
            });
            break;
          case 'content_updated_desc':
            rows.sort((a, b) => {
              const dateA = getDateValue(a, 'data-column-content-updated-value');
              const dateB = getDateValue(b, 'data-column-content-updated-value');
              return compareDates(dateB, dateA);
            });
            break;
          case 'removed_asc':
            rows.sort((a, b) => {
              const dateA = getDateValue(a, 'data-column-removed-value');
              const dateB = getDateValue(b, 'data-column-removed-value');
              return compareDates(dateA, dateB);
            });
            break;
          case 'removed_desc':
            rows.sort((a, b) => {
              const dateA = getDateValue(a, 'data-column-removed-value');
              const dateB = getDateValue(b, 'data-column-removed-value');
              return compareDates(dateB, dateA);
            });
            break;
          default:
            // Default sorting (could be A to Z by file path as per your example)
            rows.sort((a, b) => {
              const pathA = a.querySelector('[data-value="file-path"]').textContent.trim().toLowerCase();
              const pathB = b.querySelector('[data-value="file-path"]').textContent.trim().toLowerCase();
              return pathA.localeCompare(pathB);
            });
            break;
        }// Reorder rows in the table
        rows.forEach(row => dataTable.appendChild(row));
      })
    }
    document.addEventListener('DOMContentLoaded', async function () {
      /*
      const loadingScreen = document.getElementById('loading');
      loadingScreen.style.display = 'flex';
      const timerElement = document.getElementById('timer');
      let tenthsOfSeconds = 0;
      const interval = setInterval(function () {
        tenthsOfSeconds++;
        timerElement.textContent = (tenthsOfSeconds / 10).toFixed(1);
      }, 100);
      */
      const storedPath = localStorage.getItem('storedPath')
      if (localStorage.getItem('token')) {
        document.getElementById('login').classList.add('hidden')
        document.getElementById('aside_element').removeAttribute('hidden')
        document.getElementById('main_element').removeAttribute('hidden')
      }
      try {
        if (storedPath) {
          path = storedPath
          const labelElement = document.querySelector('#path-label');

          // Update the text content of the label
          labelElement.textContent = `${path}`;
          await loadUsingPath()
        }
        else {
          await loadFileList()
        }
      }
      catch (e) {
        localStorage.removeItem('token')
        document.getElementById('login').classList.remove('hidden')
        document.getElementById('aside_element').setAttribute('hidden', '')
        document.getElementById('main_element').setAttribute('hidden', '')
      }
      setSorting()
      setColumnSelectors()
      //clearInterval(interval);
      //console.log(timerElement.textContent)
      //const lastActionTime = document.getElementById('last-action-time');
      //lastActionTime.textContent = timerElement.textContent;
      //loadingScreen.style.display = 'none';
    })
  </script>
  </script>

  <script>
    function adjustWidthToContent(input) {
      const minWidth = 150; // Minimum width of the input in pixels
      const charWidth = 10; // Average width per character in pixels, adjust as needed for your font

      // Calculate the new width based on the length of the input's value or the minimum width, whichever is greater
      const newWidth = Math.max(input.value.length * charWidth, minWidth);

      // Apply the new width to the input
      input.style.width = `${newWidth}px`;
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Функция для переключения состояния кнопки
      function toggleButton(button) {
        // Переключаем текст кнопки
        button.textContent = button.textContent.includes('☑️') ? '☐' : '☑️';
      }

      // Обработчик события mouseenter для file-entry
      document.querySelectorAll('tr[data-element="file-path"]').forEach(entry => {
        entry.addEventListener('mouseenter', () => {
          const button = entry.querySelector('.file-entry-selector');
          if (button) {
            toggleButton(button);
          }
        });
      });
    });
  </script>


  <script>

    document.addEventListener('DOMContentLoaded', function () {
      // Определяем кнопки, которые будут переключать секции
      const buttons = document.querySelectorAll('button[data-section-button="brains"], button[data-section-button="files"]');
      buttons.forEach(button => {
        button.addEventListener('click', function () {
          const sectionToShow = this.getAttribute('data-section-button');

          // Переключение класса 'b-selected' для кнопок
          buttons.forEach(btn => {
            if (btn.getAttribute('data-section-button') === sectionToShow) {
              btn.classList.add('b-selected');
            } else {
              btn.classList.remove('b-selected');
            }
          });

          // Переключение видимости секций
          const sections = document.querySelectorAll('section[data-section="brains"], section[data-section="files"]');
          sections.forEach(section => {
            if (section.getAttribute('data-section') === sectionToShow) {
              section.hidden = false;
            } else {
              section.hidden = true;
            }
          });

          // Переключение видимости связанных элементов aside
          const asides = document.querySelectorAll('div[data-section-aside="brains"], div[data-section-aside="files"]');
          asides.forEach(aside => {
            if (aside.getAttribute('data-section-aside') === sectionToShow) {
              aside.hidden = false;
            } else {
              aside.hidden = true;
            }
          });
        });
      });
    });




  </script>
  <script>
    function openColumnsSelector() {
      console.log("1");
      var columnsSelector = document.getElementById('columns_selector');
      var columnsSelectorOpen = document.getElementById('columns_selector_open');

      if (columnsSelectorOpen.classList.contains('b-selected')) {
        console.log("2");

        columnsSelector.hidden = true;
        columnsSelectorOpen.classList.remove('b-selected');
        document.querySelector('.aside').style.width = '70px';
        document.querySelector('.left').style.width = '60px';

      } else {
        console.log("3");

        columnsSelector.removeAttribute('hidden');
        columnsSelectorOpen.classList.add('b-selected');
        document.querySelector('.aside').style.width = '215px';
        document.querySelector('.left').style.width = '205px';
      }
    }
  </script>

</body>